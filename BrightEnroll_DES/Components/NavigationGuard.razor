@using BrightEnroll_DES.Services.Authentication
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.RoleBase
@inject IAuthService AuthService
@inject IAuthorizationService AuthorizationService
@inject ILoadingService LoadingService
@inject NavigationManager Navigation
@implements IDisposable

@code {
    protected override void OnInitialized()
    {
        // Subscribe to navigation events
        Navigation.LocationChanged += OnLocationChanged;
        
        // Check initial location
        CheckAndRedirect();
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        CheckAndRedirect();
    }

    private void CheckAndRedirect()
    {
        // If user is logged in and tries to navigate to login page, redirect based on role
        if (AuthService.IsAuthenticated && Navigation.Uri.Contains("/login"))
        {
            var userRole = AuthorizationService.GetUserRole();
            var redirectPath = GetRedirectPathForRole(userRole);
            
            // Teachers always go to teacher-dashboard
            if (!string.IsNullOrWhiteSpace(userRole) && 
                string.Equals(userRole, "Teacher", StringComparison.OrdinalIgnoreCase))
            {
                redirectPath = "/teacher-dashboard";
            }
            
            Navigation.NavigateTo(redirectPath, forceLoad: true);
        }
    }

    private string GetRedirectPathForRole(string? role)
    {
        if (string.IsNullOrWhiteSpace(role))
        {
            return "/dashboard";
        }

        // Redirect based on role - matches Login.razor logic
        // Normalize role: remove spaces and convert to lowercase for comparison
        var roleLower = role.Replace(" ", "").ToLower().Trim();
        return roleLower switch
        {
            "cashier" => "/finance",
            "registrar" => "/enrollment",
            "hr" => "/human-resource",
            "teacher" => "/teacher-dashboard", // Teacher goes to Teacher Dashboard first
            "admin" => "/dashboard",
            "superadmin" => "/system-admin/dashboard", // SuperAdmin goes to SuperAdmin dashboard (handles both "Super Admin" and "SuperAdmin")
            _ => "/dashboard" // Default for other roles
        };
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}

