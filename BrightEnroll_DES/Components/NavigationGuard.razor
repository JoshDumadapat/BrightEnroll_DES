@using BrightEnroll_DES.Services.Authentication
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.RoleBase
@inject IAuthService AuthService
@inject IAuthorizationService AuthorizationService
@inject ILoadingService LoadingService
@inject NavigationManager Navigation
@implements IDisposable

@code {
    protected override void OnInitialized()
    {
        // Subscribe to navigation events
        Navigation.LocationChanged += OnLocationChanged;
        
        // Check initial location
        CheckAndRedirect();
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        CheckAndRedirect();
    }

    private void CheckAndRedirect()
    {
        // If user is logged in and tries to navigate to login page, redirect based on role
        if (AuthService.IsAuthenticated && Navigation.Uri.Contains("/login"))
        {
            var userRole = AuthorizationService.GetUserRole();
            var redirectPath = GetRedirectPathForRole(userRole);
            Navigation.NavigateTo(redirectPath, forceLoad: true);
        }
    }

    private string GetRedirectPathForRole(string? role)
    {
        if (string.IsNullOrWhiteSpace(role))
        {
            return "/dashboard";
        }

        // Redirect based on role - matches Login.razor logic
        return role.ToLower() switch
        {
            "cashier" => "/finance",
            "registrar" => "/enrollment",
            "hr" => "/human-resource",
            "teacher" => "/student-record",
            "admin" => "/dashboard",
            "system admin" => "/dashboard",
            _ => "/dashboard"
        };
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}

