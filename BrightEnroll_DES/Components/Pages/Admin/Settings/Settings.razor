@page "/settings"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.Authentication
@using BrightEnroll_DES.Services.DataAccess.Repositories
@using BrightEnroll_DES.Components
@using System.Text.RegularExpressions
@inject NavigationManager NavigationManager
@inject IAuthService AuthService
@inject IUserRepository UserRepository
@inject ILoginService LoginService
@inject ILoadingService LoadingService

<PageTitle>Settings</PageTitle>

<!-- Toast Notification -->
<ToastNotification Show="@showToast" Message="@toastMessage" Type="@toastType" OnClose="CloseToast" Duration="4000" />

<div class="text-gray-800">
    <h1 class="mb-6 text-2xl font-bold text-gray-800">Settings</h1>
    <div class="mx-auto max-w-3xl">
        <div class="mb-6 flex justify-start">
            <button @onclick="GoToDashboard" class="flex items-center gap-2 rounded-lg bg-gray-600 px-4 py-2 text-sm font-medium text-white shadow-md transition-all duration-300 hover:bg-gray-700 hover:shadow-lg">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back
            </button>
        </div>

        <!-- Account Settings -->
        <div class="mb-6 overflow-hidden rounded-xl bg-white shadow">
        <div class="px-6 py-6">
            <div class="mb-4 flex items-center justify-between border-b border-gray-200 pb-4">
                <h5 class="text-lg font-bold text-gray-800">Account Settings</h5>
            </div>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between border-b border-gray-200 pb-4 last:border-b-0 last:pb-0">
                    <span class="font-medium text-gray-700">Notifications</span>
                    <label class="relative inline-flex cursor-pointer items-center">
                        <input type="checkbox" @bind="notificationEnabled" class="peer sr-only" />
                        <div class="peer h-6 w-11 rounded-full bg-gray-200 after:absolute after:left-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all after:content-[''] peer-checked:bg-blue-600 peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between border-b border-gray-200 pb-4 last:border-b-0 last:pb-0">
                    <span class="font-medium text-gray-700">Dark Mode</span>
                    <label class="relative inline-flex cursor-pointer items-center">
                        <input type="checkbox" @bind="darkModeEnabled" class="peer sr-only" />
                        <div class="peer h-6 w-11 rounded-full bg-gray-200 after:absolute after:left-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all after:content-[''] peer-checked:bg-blue-600 peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300"></div>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy & Security -->
    <div class="mb-6 overflow-hidden rounded-xl bg-white shadow">
        <div class="px-6 py-6">
            <div class="mb-4 flex items-center justify-between border-b border-gray-200 pb-4">
                <h5 class="text-lg font-bold text-gray-800">Password & Security Settings</h5>
            </div>
            
            <div class="space-y-4">
                <!-- OTP & Email Verification Toggle -->
                <div class="flex items-center justify-between border-b border-gray-200 pb-4 last:border-b-0 last:pb-0">
                    <div class="flex flex-col">
                        <span class="font-medium text-gray-700">OTP & Email Verification</span>
                        <span class="text-xs text-gray-500">Enable two-factor authentication via OTP and email</span>
                    </div>
                    <label class="relative inline-flex cursor-pointer items-center">
                        <input type="checkbox" @bind="otpEmailVerificationEnabled" @bind:after="OnOtpEmailVerificationChanged" class="peer sr-only" />
                        <div class="peer h-6 w-11 rounded-full bg-gray-200 after:absolute after:left-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all after:content-[''] peer-checked:bg-blue-600 peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300"></div>
                    </label>
                </div>

                <!-- Phone Number and Email Display (shown when OTP/Email is enabled) -->
                @if (otpEmailVerificationEnabled)
                {
                    <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 space-y-3">
                        <h6 class="text-sm font-semibold text-gray-700">Security Contact Information</h6>
                        
                        <div class="space-y-2">
                            <div>
                                <label class="text-xs font-medium text-gray-600">Phone Number</label>
                                <div class="mt-1 flex items-center gap-2">
                                    <input type="text" @bind="currentPhoneNumber" 
                                           class="flex-1 rounded border border-gray-300 px-3 py-2 text-sm text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" 
                                           placeholder="Enter phone number" />
                                    <button @onclick="UpdatePhoneNumber" 
                                            class="rounded bg-blue-600 px-3 py-2 text-xs font-medium text-white transition-all hover:bg-blue-700">
                                        Update
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs font-medium text-gray-600">Email Address</label>
                                <div class="mt-1 flex items-center gap-2">
                                    <input type="email" @bind="currentEmail" 
                                           class="flex-1 rounded border border-gray-300 px-3 py-2 text-sm text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" 
                                           placeholder="Enter email address" />
                                    <button @onclick="UpdateEmail" 
                                            class="rounded bg-blue-600 px-3 py-2 text-xs font-medium text-white transition-all hover:bg-blue-700">
                                        Update
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                
                <!-- Change Password Section -->
                <div class="border-t border-gray-200 pt-4">
                    <button @onclick="ToggleChangePasswordForm" 
                            class="w-full rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-all hover:bg-blue-700">
                        Change Password
                    </button>

                    @if (showChangePasswordForm)
                    {
                        <div class="mt-4 rounded-lg border border-gray-200 bg-gray-50 p-4 space-y-4">
                            <h6 class="text-sm font-semibold text-gray-700">Update Your Password</h6>
                            
                            @if (!string.IsNullOrEmpty(passwordErrorMessage))
                            {
                                <div class="rounded-lg bg-red-50 border border-red-200 p-3">
                                    <p class="text-sm text-red-600">@passwordErrorMessage</p>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(passwordSuccessMessage))
                            {
                                <div class="rounded-lg bg-green-50 border border-green-200 p-3">
                                    <p class="text-sm text-green-600">@passwordSuccessMessage</p>
                                </div>
                            }

                            <!-- Current Password -->
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700">Current Password</label>
                                <div class="relative">
                                    <input type="@(showCurrentPassword ? "text" : "password")" 
                                           @bind="currentPassword" 
                                           class="w-full rounded border border-gray-300 px-3 py-2 text-sm text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 @(currentPasswordError ? "border-red-500" : "")" 
                                           placeholder="Enter your current password" />
                                    <button type="button" @onclick="ToggleCurrentPasswordVisibility" 
                                            class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                        @if (showCurrentPassword)
                                        {
                                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.736m0 0L21 21" />
                                            </svg>
                                        }
                                        else
                                        {
                                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                        }
                                    </button>
                                </div>
                            </div>

                            <!-- New Password -->
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700">New Password</label>
                                <div class="relative">
                                    <input type="@(showNewPassword ? "text" : "password")" 
                                           @bind="newPassword" 
                                           @oninput="OnNewPasswordChanged"
                                           class="w-full rounded border border-gray-300 px-3 py-2 text-sm text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 @(newPasswordError ? "border-red-500" : "")" 
                                           placeholder="Enter your new password" />
                                    <button type="button" @onclick="ToggleNewPasswordVisibility" 
                                            class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                        @if (showNewPassword)
                                        {
                                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.736m0 0L21 21" />
                                            </svg>
                                        }
                                        else
                                        {
                                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                        }
                                    </button>
                                </div>
                                
                                <!-- Password Requirements -->
                                <div class="mt-2 text-xs text-gray-600">
                                    <p class="mb-1 font-medium">Password Requirements:</p>
                                    <ul class="ml-4 list-disc space-y-0.5">
                                        <li class="@(newPassword.Length >= 12 ? "text-green-600" : "text-gray-500")">Minimum 12 characters</li>
                                        <li class="@(HasUppercase(newPassword) ? "text-green-600" : "text-gray-500")">At least one uppercase letter</li>
                                        <li class="@(HasLowercase(newPassword) ? "text-green-600" : "text-gray-500")">At least one lowercase letter</li>
                                        <li class="@(HasNumber(newPassword) ? "text-green-600" : "text-gray-500")">At least one number</li>
                                        <li class="@(HasSpecialChar(newPassword) ? "text-green-600" : "text-gray-500")">At least one special character</li>
                                    </ul>
                                </div>

                                <!-- Password Strength Indicator -->
                                @if (!string.IsNullOrEmpty(newPassword))
                                {
                                    <div class="mt-2">
                                        <div class="mb-1 flex items-center justify-between">
                                            <span class="text-xs font-medium text-gray-600">Password Strength:</span>
                                            <span class="text-xs font-semibold @GetStrengthColorClass()">@GetPasswordStrength()</span>
                                        </div>
                                        <div class="h-2 w-full rounded-full bg-gray-200">
                                            <div class="h-2 rounded-full transition-all @GetStrengthBarColorClass()" style="width: @GetStrengthPercentage()%"></div>
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Confirm New Password -->
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700">Confirm New Password</label>
                                <div class="relative">
                                    <input type="@(showConfirmPassword ? "text" : "password")" 
                                           @bind="confirmPassword" 
                                           @oninput="OnConfirmPasswordChanged"
                                           class="w-full rounded border border-gray-300 px-3 py-2 text-sm text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 @(confirmPasswordError ? "border-red-500" : "")" 
                                           placeholder="Confirm your new password" />
                                    <button type="button" @onclick="ToggleConfirmPasswordVisibility" 
                                            class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                        @if (showConfirmPassword)
                                        {
                                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.736m0 0L21 21" />
                                            </svg>
                                        }
                                        else
                                        {
                                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                        }
                                    </button>
                                </div>
                                @if (confirmPasswordError)
                                {
                                    <p class="mt-1 text-xs text-red-600">Passwords do not match</p>
                                }
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex gap-2 pt-2">
                                <button @onclick="SubmitPasswordChange" 
                                        class="flex-1 rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-all hover:bg-blue-700">
                                    Update Password
                                </button>
                                <button @onclick="CancelPasswordChange" 
                                        class="flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition-all hover:bg-gray-50">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Help & Support -->
    <div class="overflow-hidden rounded-xl bg-white shadow">
        <div class="px-6 py-6">
            <div class="mb-4 flex items-center justify-between border-b border-gray-200 pb-4">
                <h5 class="text-lg font-bold text-gray-800">Help & Support</h5>
            </div>
            
            <div class="space-y-2">
                <button @onclick="GoToContactSupport" class="w-full rounded-lg border border-blue-600 bg-white px-4 py-2 text-sm font-medium text-blue-600 transition-all hover:bg-blue-50">
                    Contact Support
                </button>
                
                <button @onclick="GoToDocumentation" class="w-full rounded-lg border border-blue-600 bg-white px-4 py-2 text-sm font-medium text-blue-600 transition-all hover:bg-blue-50">
                    View Documentation
                </button>
            </div>
        </div>
    </div>
    </div>
</div>

@code {
    private bool notificationEnabled { get; set; } = true;
    private bool darkModeEnabled { get; set; } = false;
    private bool otpEmailVerificationEnabled { get; set; } = false;

    // OTP & Email Verification fields
    private string currentPhoneNumber { get; set; } = string.Empty;
    private string currentEmail { get; set; } = string.Empty;

    // Change Password fields
    private bool showChangePasswordForm { get; set; } = false;
    private string currentPassword { get; set; } = string.Empty;
    private string newPassword { get; set; } = string.Empty;
    private string confirmPassword { get; set; } = string.Empty;
    private bool showCurrentPassword { get; set; } = false;
    private bool showNewPassword { get; set; } = false;
    private bool showConfirmPassword { get; set; } = false;
    private bool currentPasswordError { get; set; } = false;
    private bool newPasswordError { get; set; } = false;
    private bool confirmPasswordError { get; set; } = false;
    private string passwordErrorMessage { get; set; } = string.Empty;
    private string passwordSuccessMessage { get; set; } = string.Empty;
    
    // Toast notification
    private bool showToast = false;
    private string toastMessage = "";
    private ToastType toastType = ToastType.Success;

    protected override void OnInitialized()
    {
        // Load current user's email and phone number
        var currentUser = AuthService.CurrentUser;
        if (currentUser != null)
        {
            currentEmail = currentUser.email ?? string.Empty;
            currentPhoneNumber = currentUser.contact_num ?? string.Empty;
        }
    }

    private void OnOtpEmailVerificationChanged()
    {
        StateHasChanged();
    }

    private void UpdatePhoneNumber()
    {
        // TODO: Implement phone number update functionality
        // This will be implemented later
    }

    private void UpdateEmail()
    {
        // TODO: Implement email update functionality
        // This will be implemented later
    }

    private void ToggleChangePasswordForm()
    {
        showChangePasswordForm = !showChangePasswordForm;
        if (!showChangePasswordForm)
        {
            ResetPasswordForm();
        }
        StateHasChanged();
    }

    private void ResetPasswordForm()
    {
        currentPassword = string.Empty;
        newPassword = string.Empty;
        confirmPassword = string.Empty;
        currentPasswordError = false;
        newPasswordError = false;
        confirmPasswordError = false;
        passwordErrorMessage = string.Empty;
        passwordSuccessMessage = string.Empty;
        showCurrentPassword = false;
        showNewPassword = false;
        showConfirmPassword = false;
    }

    private void ToggleCurrentPasswordVisibility()
    {
        showCurrentPassword = !showCurrentPassword;
    }

    private void ToggleNewPasswordVisibility()
    {
        showNewPassword = !showNewPassword;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        showConfirmPassword = !showConfirmPassword;
    }

    private void OnNewPasswordChanged(ChangeEventArgs e)
    {
        newPassword = e.Value?.ToString() ?? string.Empty;
        ValidateNewPassword();
        StateHasChanged();
    }

    private void OnConfirmPasswordChanged(ChangeEventArgs e)
    {
        confirmPassword = e.Value?.ToString() ?? string.Empty;
        ValidateNewPassword();
        StateHasChanged();
    }

    private void ValidateNewPassword()
    {
        newPasswordError = false;
        confirmPasswordError = false;

        if (string.IsNullOrEmpty(newPassword))
        {
            return;
        }

        // Check all requirements
        if (newPassword.Length < 12 || 
            !HasUppercase(newPassword) || 
            !HasLowercase(newPassword) || 
            !HasNumber(newPassword) || 
            !HasSpecialChar(newPassword))
        {
            newPasswordError = true;
        }

        // Check if confirm password matches
        if (!string.IsNullOrEmpty(confirmPassword) && newPassword != confirmPassword)
        {
            confirmPasswordError = true;
        }
        else if (!string.IsNullOrEmpty(confirmPassword) && newPassword == confirmPassword)
        {
            confirmPasswordError = false;
        }
    }

    private bool HasUppercase(string password)
    {
        return Regex.IsMatch(password, @"[A-Z]");
    }

    private bool HasLowercase(string password)
    {
        return Regex.IsMatch(password, @"[a-z]");
    }

    private bool HasNumber(string password)
    {
        return Regex.IsMatch(password, @"[0-9]");
    }

    private bool HasSpecialChar(string password)
    {
        return Regex.IsMatch(password, @"[!@#$%^&*()_+\-=\[\]{};':""\\|,.<>\/?]");
    }

    private string GetPasswordStrength()
    {
        if (string.IsNullOrEmpty(newPassword))
            return "";

        int score = 0;
        if (newPassword.Length >= 12) score++;
        if (HasUppercase(newPassword)) score++;
        if (HasLowercase(newPassword)) score++;
        if (HasNumber(newPassword)) score++;
        if (HasSpecialChar(newPassword)) score++;

        if (score < 3)
            return "Weak";
        else if (score < 5)
            return "Moderate";
        else
            return "Strong";
    }

    private string GetStrengthColorClass()
    {
        var strength = GetPasswordStrength();
        return strength switch
        {
            "Weak" => "text-red-600",
            "Moderate" => "text-yellow-600",
            "Strong" => "text-green-600",
            _ => "text-gray-600"
        };
    }

    private string GetStrengthBarColorClass()
    {
        var strength = GetPasswordStrength();
        return strength switch
        {
            "Weak" => "bg-red-500",
            "Moderate" => "bg-yellow-500",
            "Strong" => "bg-green-500",
            _ => "bg-gray-300"
        };
    }

    private int GetStrengthPercentage()
    {
        if (string.IsNullOrEmpty(newPassword))
            return 0;

        int score = 0;
        if (newPassword.Length >= 12) score++;
        if (HasUppercase(newPassword)) score++;
        if (HasLowercase(newPassword)) score++;
        if (HasNumber(newPassword)) score++;
        if (HasSpecialChar(newPassword)) score++;

        return score * 20; // 0%, 20%, 40%, 60%, 80%, 100%
    }

    private async Task SubmitPasswordChange()
    {
        // Reset error states
        currentPasswordError = false;
        newPasswordError = false;
        confirmPasswordError = false;
        passwordErrorMessage = string.Empty;
        passwordSuccessMessage = string.Empty;

        // Validate current password is provided
        if (string.IsNullOrWhiteSpace(currentPassword))
        {
            currentPasswordError = true;
            passwordErrorMessage = "Please enter your current password.";
            StateHasChanged();
            return;
        }

        // Validate new password
        if (string.IsNullOrWhiteSpace(newPassword))
        {
            newPasswordError = true;
            passwordErrorMessage = "Please enter a new password.";
            StateHasChanged();
            return;
        }

        // Validate password requirements
        if (newPassword.Length < 12 || 
            !HasUppercase(newPassword) || 
            !HasLowercase(newPassword) || 
            !HasNumber(newPassword) || 
            !HasSpecialChar(newPassword))
        {
            newPasswordError = true;
            passwordErrorMessage = "New password does not meet the requirements. Please check all requirements above.";
            StateHasChanged();
            return;
        }

        // Validate passwords match
        if (newPassword != confirmPassword)
        {
            confirmPasswordError = true;
            passwordErrorMessage = "New password and confirm password do not match.";
            StateHasChanged();
            return;
        }

        // Get current user
        var currentUser = AuthService.CurrentUser;
        if (currentUser == null)
        {
            passwordErrorMessage = "You must be logged in to change your password.";
            StateHasChanged();
            return;
        }

        LoadingService.ShowLoading("Updating password...");

        try
        {
            // Verify current password
            var isValidCurrentPassword = await LoginService.ValidateUserCredentialsAsync(
                currentUser.email ?? currentUser.system_ID ?? "", 
                currentPassword);

            if (isValidCurrentPassword == null)
            {
                currentPasswordError = true;
                passwordErrorMessage = "Current password is incorrect.";
                LoadingService.HideLoading();
                StateHasChanged();
                return;
            }

            // Hash new password
            string hashedNewPassword = BCrypt.Net.BCrypt.HashPassword(newPassword);

            // Verify user ID is set
            if (currentUser.user_ID <= 0)
            {
                passwordErrorMessage = "Invalid user ID. Please log out and log back in.";
                LoadingService.HideLoading();
                StateHasChanged();
                return;
            }

            // Update user password
            currentUser.password = hashedNewPassword;
            var rowsAffected = await UserRepository.UpdateAsync(currentUser);
            
            if (rowsAffected <= 0)
            {
                throw new Exception("Password update failed. No rows were affected in the database.");
            }

            // Success - Show toast notification
            toastMessage = "Password updated successfully!";
            toastType = ToastType.Success;
            showToast = true;
            
            // Also keep inline success message for form feedback
            passwordSuccessMessage = "Password updated successfully!";
            ResetPasswordForm();
            showChangePasswordForm = false;

            // Clear success message after 3 seconds
            await Task.Delay(3000);
            passwordSuccessMessage = string.Empty;
        }
        catch (Exception ex)
        {
            passwordErrorMessage = $"An error occurred while updating your password: {ex.Message}";
            
            // Show error toast
            toastMessage = $"Failed to update password: {ex.Message}";
            toastType = ToastType.Error;
            showToast = true;
        }
        finally
        {
            LoadingService.HideLoading();
            StateHasChanged();
        }
    }

    private void CloseToast()
    {
        showToast = false;
        toastMessage = "";
        StateHasChanged();
    }

    private void CancelPasswordChange()
    {
        ResetPasswordForm();
        showChangePasswordForm = false;
        StateHasChanged();
    }

    private void GoToDashboard()
    {
        NavigationManager.NavigateTo("/dashboard");
    }

    private void GoToContactSupport()
    {
        NavigationManager.NavigateTo("/contact-support");
    }

    private void GoToDocumentation()
    {
        NavigationManager.NavigateTo("/documentation");
    }
}
