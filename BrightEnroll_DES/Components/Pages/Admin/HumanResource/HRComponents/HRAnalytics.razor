@using BrightEnroll_DES.Components
@using BrightEnroll_DES.Data
@using BrightEnroll_DES.Data.Models
@using Microsoft.EntityFrameworkCore
@using System.Linq
@inject AppDbContext Context

@if (isLoading)
{
    <div class="flex items-center justify-center py-12">
        <div class="text-center">
            <svg class="mx-auto h-12 w-12 animate-spin text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-sm text-gray-600">Loading analytics data...</p>
        </div>
    </div>
}
else
{
<div class="space-y-6">
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <!-- Total Employees Card -->
        <div class="overflow-hidden rounded-xl bg-white shadow-lg">
            <div class="p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Employees</p>
                        <p class="mt-2 text-3xl font-bold text-gray-900">@totalEmployees</p>
                        <p class="mt-1 text-xs text-gray-500">Active: @activeEmployees | Inactive: @inactiveEmployees</p>
                    </div>
                    <div class="rounded-full bg-blue-100 p-3">
                        <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Employees by Role Card -->
        <div class="overflow-hidden rounded-xl bg-white shadow-lg">
            <div class="p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Employees by Role</p>
                        <p class="mt-2 text-3xl font-bold text-gray-900">@roleCount</p>
                        <p class="mt-1 text-xs text-gray-500">Different roles</p>
                    </div>
                    <div class="rounded-full bg-green-100 p-3">
                        <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Average Salary Card -->
        <div class="overflow-hidden rounded-xl bg-white shadow-lg">
            <div class="p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Average Salary</p>
                        <p class="mt-2 text-3xl font-bold text-gray-900">₱@averageSalary.ToString("N2")</p>
                        <p class="mt-1 text-xs text-gray-500">Per employee</p>
                    </div>
                    <div class="rounded-full bg-yellow-100 p-3">
                        <svg class="h-8 w-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Payroll Cost Card -->
        <div class="overflow-hidden rounded-xl bg-white shadow-lg">
            <div class="p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Payroll Cost</p>
                        <p class="mt-2 text-3xl font-bold text-gray-900">₱@totalPayrollCost.ToString("N2")</p>
                        <p class="mt-1 text-xs text-gray-500">Monthly</p>
                    </div>
                    <div class="rounded-full bg-purple-100 p-3">
                        <svg class="h-8 w-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Detailed Analytics -->
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
        <!-- Employees by Role Chart -->
        <div class="overflow-hidden rounded-xl bg-white shadow-lg">
            <div class="border-b border-gray-200 bg-gray-50 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">Employees by Role</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    @foreach (var role in roleDistribution)
                    {
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">@role.RoleName</span>
                                <span class="text-sm text-gray-600">@role.Count employees</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: @(role.Percentage)%"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Salary Distribution -->
        <div class="overflow-hidden rounded-xl bg-white shadow-lg">
            <div class="border-b border-gray-200 bg-gray-50 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">Salary Distribution</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">₱0 - ₱20,000</span>
                            <span class="text-sm text-gray-600">@salaryRanges[0] employees</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width: @(GetPercentage(salaryRanges[0], totalEmployees))%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">₱20,001 - ₱40,000</span>
                            <span class="text-sm text-gray-600">@salaryRanges[1] employees</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: @(GetPercentage(salaryRanges[1], totalEmployees))%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">₱40,001 - ₱60,000</span>
                            <span class="text-sm text-gray-600">@salaryRanges[2] employees</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-yellow-600 h-2 rounded-full" style="width: @(GetPercentage(salaryRanges[2], totalEmployees))%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">Above ₱60,000</span>
                            <span class="text-sm text-gray-600">@salaryRanges[3] employees</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-orange-600 h-2 rounded-full" style="width: @(GetPercentage(salaryRanges[3], totalEmployees))%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Time & Attendance Analytics (if data available) -->
    <div class="overflow-hidden rounded-xl bg-white shadow-lg">
        <div class="border-b border-gray-200 bg-gray-50 px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-800">Time & Attendance Analytics</h3>
            @if (hasTimeRecords)
            {
                <p class="mt-1 text-sm text-gray-600">Based on uploaded time records</p>
            }
            else
            {
                <p class="mt-1 text-sm text-gray-600">Data will be available after uploading time records</p>
            }
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">Average Attendance Rate</p>
                    @if (hasTimeRecords)
                    {
                        <p class="mt-2 text-2xl font-bold text-gray-900">@averageAttendanceRate.ToString("F1")%</p>
                    }
                    else
                    {
                        <p class="mt-2 text-2xl font-bold text-gray-900">--%</p>
                    }
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">Total Overtime Hours</p>
                    @if (hasTimeRecords)
                    {
                        <p class="mt-2 text-2xl font-bold text-orange-600">@totalOvertimeHours.ToString("F1") hrs</p>
                    }
                    else
                    {
                        <p class="mt-2 text-2xl font-bold text-orange-600">-- hrs</p>
                    }
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">Total Leave Days</p>
                    @if (hasTimeRecords)
                    {
                        <p class="mt-2 text-2xl font-bold text-blue-600">@totalLeaveDays.ToString("F1") days</p>
                    }
                    else
                    {
                        <p class="mt-2 text-2xl font-bold text-blue-600">-- days</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Cost Analytics -->
    <div class="overflow-hidden rounded-xl bg-white shadow-lg">
        <div class="border-b border-gray-200 bg-gray-50 px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-800">Cost Analytics</h3>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
                <div class="p-4 border border-gray-200 rounded-lg">
                    <p class="text-sm text-gray-600">Cost per Employee</p>
                    <p class="mt-2 text-xl font-bold text-gray-900">₱@costPerEmployee.ToString("N2")</p>
                </div>
                <div class="p-4 border border-gray-200 rounded-lg">
                    <p class="text-sm text-gray-600">Highest Paid</p>
                    <p class="mt-2 text-xl font-bold text-green-600">₱@highestSalary.ToString("N2")</p>
                </div>
                <div class="p-4 border border-gray-200 rounded-lg">
                    <p class="text-sm text-gray-600">Lowest Paid</p>
                    <p class="mt-2 text-xl font-bold text-red-600">₱@lowestSalary.ToString("N2")</p>
                </div>
                <div class="p-4 border border-gray-200 rounded-lg">
                    <p class="text-sm text-gray-600">Salary Range</p>
                    <p class="mt-2 text-xl font-bold text-gray-900">₱@lowestSalary.ToString("N2") - ₱@highestSalary.ToString("N2")</p>
                </div>
            </div>
        </div>
    </div>
</div>
}

@code {
    private int totalEmployees = 0;
    private int activeEmployees = 0;
    private int inactiveEmployees = 0;
    private int roleCount = 0;
    private decimal averageSalary = 0;
    private decimal totalPayrollCost = 0;
    private decimal costPerEmployee = 0;
    private decimal highestSalary = 0;
    private decimal lowestSalary = 0;
    private bool isLoading = true;
    
    // Time & Attendance Analytics
    private bool hasTimeRecords = false;
    private double averageAttendanceRate = 0;
    private decimal totalOvertimeHours = 0;
    private decimal totalLeaveDays = 0;

    private List<RoleDistribution> roleDistribution = new();
    private List<int> salaryRanges = new() { 0, 0, 0, 0 }; // 0-20k, 20k-40k, 40k-60k, 60k+

    protected override async Task OnInitializedAsync()
    {
        await LoadRealData();
    }

    private async Task LoadRealData()
    {
        try
        {
            isLoading = true;
            
            // Load employee data from EmployeeDataView
            var allEmployees = await Context.EmployeeDataViews.ToListAsync();
            
            // Calculate total, active, and inactive employees
            totalEmployees = allEmployees.Count;
            activeEmployees = allEmployees.Count(e => e.Status == null || e.Status.ToLower() != "inactive");
            inactiveEmployees = allEmployees.Count(e => e.Status != null && e.Status.ToLower() == "inactive");
            
            // Calculate role distribution
            var roleGroups = allEmployees
                .Where(e => !string.IsNullOrWhiteSpace(e.Role))
                .GroupBy(e => e.Role)
                .Select(g => new RoleDistribution
                {
                    RoleName = g.Key ?? "Unknown",
                    Count = g.Count(),
                    Percentage = totalEmployees > 0 ? (g.Count() * 100.0 / totalEmployees) : 0
                })
                .OrderByDescending(r => r.Count)
                .ToList();
            
            roleDistribution = roleGroups;
            roleCount = roleGroups.Count;
            
            // Load salary data from SalaryInfo (only active salaries)
            var activeSalaries = await Context.SalaryInfos
                .Where(s => s.IsActive)
                .ToListAsync();
            
            if (activeSalaries.Any())
            {
                // Calculate total salary (BaseSalary + Allowance) for each employee
                var totalSalaries = activeSalaries
                    .Select(s => s.BaseSalary + s.Allowance)
                    .ToList();
                
                // Calculate salary statistics
                averageSalary = totalSalaries.Any() ? totalSalaries.Average() : 0;
                highestSalary = totalSalaries.Any() ? totalSalaries.Max() : 0;
                lowestSalary = totalSalaries.Any() ? totalSalaries.Min() : 0;
                totalPayrollCost = totalSalaries.Sum();
                costPerEmployee = activeEmployees > 0 ? totalPayrollCost / activeEmployees : 0;
                
                // Calculate salary ranges distribution
                salaryRanges[0] = totalSalaries.Count(s => s <= 20000); // 0-20k
                salaryRanges[1] = totalSalaries.Count(s => s > 20000 && s <= 40000); // 20k-40k
                salaryRanges[2] = totalSalaries.Count(s => s > 40000 && s <= 60000); // 40k-60k
                salaryRanges[3] = totalSalaries.Count(s => s > 60000); // Above 60k
            }
            else
            {
                // No salary data available
                averageSalary = 0;
                highestSalary = 0;
                lowestSalary = 0;
                totalPayrollCost = 0;
                costPerEmployee = 0;
                salaryRanges = new List<int> { 0, 0, 0, 0 };
            }
            
            // Load time & attendance data from TimeRecords
            var allTimeRecords = await Context.TimeRecords.ToListAsync();
            
            if (allTimeRecords.Any())
            {
                hasTimeRecords = true;
                
                // Calculate total overtime hours (sum of all overtime hours)
                totalOvertimeHours = allTimeRecords.Sum(tr => tr.OvertimeHours);
                
                // Calculate total leave days (sum of all leave days)
                totalLeaveDays = allTimeRecords.Sum(tr => tr.LeaveDays);
                
                // Calculate average attendance rate
                // Attendance rate = (Total Regular Hours / Expected Hours) * 100
                // Expected hours per employee per month = 160 hours (8 hours/day * 20 working days)
                // For simplicity, we'll calculate based on regular hours worked vs expected
                var totalRegularHours = allTimeRecords.Sum(tr => tr.RegularHours);
                var totalExpectedHours = activeEmployees * 160; // 160 hours per month per employee (standard)
                
                if (totalExpectedHours > 0)
                {
                    averageAttendanceRate = (double)((totalRegularHours / (decimal)totalExpectedHours) * 100);
                    // Cap at 100%
                    if (averageAttendanceRate > 100) averageAttendanceRate = 100;
                }
                else
                {
                    averageAttendanceRate = 0;
                }
            }
            else
            {
                hasTimeRecords = false;
                averageAttendanceRate = 0;
                totalOvertimeHours = 0;
                totalLeaveDays = 0;
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading HR Analytics data: {ex.Message}");
            // Set defaults on error
            totalEmployees = 0;
            activeEmployees = 0;
            inactiveEmployees = 0;
            roleCount = 0;
            averageSalary = 0;
            totalPayrollCost = 0;
            costPerEmployee = 0;
            highestSalary = 0;
            lowestSalary = 0;
            roleDistribution = new List<RoleDistribution>();
            salaryRanges = new List<int> { 0, 0, 0, 0 };
            hasTimeRecords = false;
            averageAttendanceRate = 0;
            totalOvertimeHours = 0;
            totalLeaveDays = 0;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private double GetPercentage(int value, int total)
    {
        if (total == 0) return 0;
        return (value * 100.0) / total;
    }

    private class RoleDistribution
    {
        public string RoleName { get; set; } = string.Empty;
        public int Count { get; set; }
        public double Percentage { get; set; }
    }
}
