@page "/human-resource/add-employee"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Components
@using BrightEnroll_DES.Components.Pages.Admin.HumanResource.HRComponents
@using BrightEnroll_DES.Components.Pages.Admin.HumanResource.HRCS
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.Business.HR
@using BrightEnroll_DES.Services.DataAccess.Repositories
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.JSInterop
@using System.Linq
@using System.Collections.Generic
@using System.Threading
@using Microsoft.EntityFrameworkCore
@inject NavigationManager NavigationManager
@inject AddressService AddressService
@inject EmployeeService EmployeeService
@inject IUserRepository UserRepository
@inject IJSRuntime JSRuntime
@inject BrightEnroll_DES.Data.AppDbContext DbContext
@implements IDisposable

<PageTitle>Add Employee</PageTitle>

<NavigationLock OnBeforeInternalNavigation="OnBeforeInternalNavigation" />

<div class="text-gray-800">
    <h1 class="mb-6 text-2xl font-bold text-gray-800">Add Employee</h1>
    <div class="mx-auto max-w-5xl">
        <div class="mb-6 flex justify-start">
            <button @onclick="GoBack" class="flex items-center gap-2 rounded-lg bg-gray-600 px-4 py-2 text-sm font-medium text-white shadow-md transition-all duration-300 hover:bg-gray-700 hover:shadow-lg">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back
            </button>
        </div>
        <EditForm EditContext="@editContext" @onsubmit:preventDefault="true">
            <DataAnnotationsValidator />
            
            <!-- Personal Information -->
            <div class="mb-6 overflow-hidden rounded-xl bg-white shadow sm:mb-8">
                <div class="px-6 py-6">
                    <h2 class="mb-4 border-b-2 border-blue-600 pb-2 text-lg font-bold text-blue-600 sm:mb-6 sm:text-xl">Personal Information</h2>
                    
                    <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-2 sm:gap-4 lg:grid-cols-4">
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                First Name <span class="text-red-500">*</span>
                            </label>
                            <InputText @bind-Value="EmployeeData.FirstName" 
                                       @bind-Value:after="() => { FormatFirstName(); editContext?.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.FirstName))); StateHasChanged(); }"
                                       class="@GetInputClass(nameof(EmployeeData.FirstName))"
                                       placeholder="e.g. Juan" />
                            <ValidationMessage For="@(() => EmployeeData.FirstName)" class="text-red-500 text-xs mt-1" />
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Middle Name</label>
                            <InputText @bind-Value="EmployeeData.MiddleName" 
                                       @bind-Value:after="FormatMiddleName"
                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base"
                                       placeholder="e.g. Dela Cruz" />
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Last Name <span class="text-red-500">*</span>
                            </label>
                            <InputText @bind-Value="EmployeeData.LastName" 
                                       @bind-Value:after="() => { FormatLastName(); editContext?.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.LastName))); StateHasChanged(); }"
                                       class="@GetInputClass(nameof(EmployeeData.LastName))"
                                       placeholder="e.g. Santos" />
                            <ValidationMessage For="@(() => EmployeeData.LastName)" class="text-red-500 text-xs mt-1" />
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Suffix</label>
                            <InputSelect @bind-Value="EmployeeData.Suffix" 
                                class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base">
                                <option value="">N/A</option>
                                <option value="Jr.">Jr.</option>
                                <option value="Sr.">Sr.</option>
                                <option value="II">II</option>
                                <option value="III">III</option>
                                <option value="IV">IV</option>
                            </InputSelect>
                        </div>
                    </div>
                    <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-2 sm:gap-4 lg:grid-cols-4">
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Birth Date <span class="text-red-500">*</span>
                            </label>
                            <InputDate @bind-Value="EmployeeData.BirthDate" @bind-Value:after="() => { CalculateAge(); editContext?.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.BirthDate))); StateHasChanged(); }"
                                class="@GetInputClass(nameof(EmployeeData.BirthDate))" />
                            <ValidationMessage For="@(() => EmployeeData.BirthDate)" class="text-red-500 text-xs mt-1" />
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Age <span class="text-red-500">*</span>
                            </label>
                            <InputNumber @bind-Value="EmployeeData.Age" 
                                @bind-Value:after="() => { editContext?.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.Age))); StateHasChanged(); }"
                                class="@GetInputClass(nameof(EmployeeData.Age))"
                                placeholder="e.g. 30" />
                            <ValidationMessage For="@(() => EmployeeData.Age)" class="text-red-500 text-xs mt-1" />
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Sex <span class="text-red-500">*</span>
                            </label>
                            <InputRadioGroup @bind-Value="EmployeeData.Sex" @bind-Value:after="() => { editContext?.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.Sex))); StateHasChanged(); }">
                                <div class="flex items-center gap-4 pt-1 sm:gap-6 sm:pt-2">
                                    <label class="flex cursor-pointer items-center">
                                        <InputRadio Value="@("Male")" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">Male</span>
                                    </label>
                                    <label class="flex cursor-pointer items-center">
                                        <InputRadio Value="@("Female")" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">Female</span>
                                    </label>
                                </div>
                            </InputRadioGroup>
                            <ValidationMessage For="@(() => EmployeeData.Sex)" class="text-red-500 text-xs mt-1" />
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Contact Number <span class="text-red-500">*</span>
                            </label>
                            <InputText @bind-Value="EmployeeData.ContactNumber" 
                                      @bind-Value:after="async () => { FormatContactNumber(); await CheckContactUniqueness(); editContext?.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.ContactNumber))); StateHasChanged(); }"
                                      maxlength="11"
                                      onkeypress="return /[0-9]/i.test(event.key) || event.key === 'Backspace' || event.key === 'Delete' || event.key === 'ArrowLeft' || event.key === 'ArrowRight'"
                                      class="@GetContactInputClassExplicit()"
                                      style="@GetContactInputStyle()"
                                      placeholder="e.g. 09123456789" />
                            <ValidationMessage For="@(() => EmployeeData.ContactNumber)" class="text-red-500 text-xs mt-1" />
                            @if (isContactDuplicate && !string.IsNullOrWhiteSpace(EmployeeData.ContactNumber))
                            {
                                <div class="text-red-500 text-xs mt-1">This contact number is already registered. Please use a different contact number.</div>
                            }
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4">
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Email <span class="text-red-500">*</span>
                            </label>
                            <InputText @bind-Value="EmployeeData.Email" 
                                      @bind-Value:after="async () => { await CheckEmailUniqueness(); editContext?.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.Email))); StateHasChanged(); }"
                                      type="email"
                                      class="@GetEmailInputClassExplicit()"
                                      style="@GetEmailInputStyle()"
                                      placeholder="e.g. juan.santos@email.com" />
                            <ValidationMessage For="@(() => EmployeeData.Email)" class="text-red-500 text-xs mt-1" />
                            @if (isEmailDuplicate && !string.IsNullOrWhiteSpace(EmployeeData.Email))
                            {
                                <div class="text-red-500 text-xs mt-1">This email is already registered. Please use a different email address.</div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Address -->
            <div class="mb-6 rounded-xl bg-white shadow sm:mb-8" style="overflow: visible;">
                <div class="px-6 py-6" style="overflow: visible;">
                    <h2 class="mb-4 border-b-2 border-blue-600 pb-2 text-lg font-bold text-blue-600 sm:mb-6 sm:text-xl">Address</h2>
                    
                    <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-2 sm:gap-4">
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">House No./Street</label>
                            <InputText @bind-Value="EmployeeData.HouseNo" 
                                      class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base"
                                      placeholder="e.g. 123" />
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Street Name</label>
                            <InputText @bind-Value="EmployeeData.StreetName" 
                                      class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base"
                                      placeholder="e.g. Main Street" />
                        </div>
                    </div>

                    <!-- Province -->
                    <div class="mb-3 sm:mb-4">
                        <div class="relative">
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Province <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <div @onclick="() => addressHandler?.ToggleProvinceDropdown()" 
                                     @onclick:stopPropagation="true"
                                     data-dropdown="province"
                                     class="@GetDropdownClass(nameof(EmployeeData.Province))">
                                    <span class="@(string.IsNullOrWhiteSpace(EmployeeData.Province) ? "text-gray-400" : "text-gray-700")">
                                        @(string.IsNullOrWhiteSpace(EmployeeData.Province) ? "Select Province" : EmployeeData.Province)
                                    </span>
                                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                                @if (addressHandler?.ShowProvinceDropdown == true)
                                {
                                    <div class="absolute z-[9999] mt-1 w-full rounded-lg border border-gray-300 bg-white shadow-lg" @onclick:stopPropagation="true" data-dropdown="province">
                                        <div class="border-b border-gray-200 p-2">
                                            <input type="text" 
                                                   @bind="addressHandler.ProvinceSearchText" 
                                                   @bind:after="FilterProvinces"
                                                   @onkeydown="HandleSearchKeyDown"
                                                   @onkeydown:stopPropagation="true"
                                                   placeholder="Search province..."
                                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0" />
                                        </div>
                                        <div class="max-h-60 overflow-auto">
                                            @if (addressHandler.FilteredProvinces.Any())
                                            {
                                                @foreach (var province in addressHandler.FilteredProvinces)
                                                {
                                                    <div @onclick="() => SelectProvince(province)" 
                                                         class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm @(EmployeeData.Province == province ? "bg-blue-100" : "")">
                                                        @province
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="px-4 py-2 text-sm text-gray-500">No results found</div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                            <ValidationMessage For="@(() => EmployeeData.Province)" class="text-red-500 text-xs mt-1" />
                        </div>
                    </div>

                    <!-- City -->
                    <div class="mb-3 sm:mb-4">
                        <div class="relative">
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Municipality/City <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <div @onclick="() => addressHandler?.ToggleCityDropdown()" 
                                     @onclick:stopPropagation="true"
                                     data-dropdown="city"
                                     class="@GetDropdownClass(nameof(EmployeeData.City)) @(string.IsNullOrWhiteSpace(EmployeeData.Province) ? "opacity-50 cursor-not-allowed" : "")"
                                     style="@(string.IsNullOrWhiteSpace(EmployeeData.Province) ? "pointer-events: none;" : "")">
                                    <span class="@(string.IsNullOrWhiteSpace(EmployeeData.City) ? "text-gray-400" : "text-gray-700")">
                                        @(string.IsNullOrWhiteSpace(EmployeeData.City) ? "Select City" : EmployeeData.City)
                                    </span>
                                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                                @if (addressHandler?.ShowCityDropdown == true && !string.IsNullOrWhiteSpace(EmployeeData.Province))
                                {
                                    <div class="absolute z-[9999] mt-1 w-full rounded-lg border border-gray-300 bg-white shadow-lg" @onclick:stopPropagation="true" data-dropdown="city">
                                        <div class="border-b border-gray-200 p-2">
                                            <input type="text" 
                                                   @bind="addressHandler.CitySearchText" 
                                                   @bind:after="FilterCities"
                                                   @onkeydown="HandleSearchKeyDown"
                                                   @onkeydown:stopPropagation="true"
                                                   placeholder="Search city..."
                                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0" />
                                        </div>
                                        <div class="max-h-60 overflow-auto">
                                            @if (addressHandler.FilteredCities.Any())
                                            {
                                                @foreach (var city in addressHandler.FilteredCities)
                                                {
                                                    <div @onclick="() => SelectCity(city)" 
                                                         class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm @(EmployeeData.City == city ? "bg-blue-100" : "")">
                                                        @city
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="px-4 py-2 text-sm text-gray-500">No results found</div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                            <ValidationMessage For="@(() => EmployeeData.City)" class="text-red-500 text-xs mt-1" />
                        </div>
                    </div>

                    <!-- Barangay -->
                    <div class="mb-3 sm:mb-4">
                        <div class="relative">
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Barangay <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <div @onclick="() => addressHandler?.ToggleBarangayDropdown()" 
                                     @onclick:stopPropagation="true"
                                     data-dropdown="barangay"
                                     class="@GetDropdownClass(nameof(EmployeeData.Barangay)) @(string.IsNullOrWhiteSpace(EmployeeData.City) ? "opacity-50 cursor-not-allowed" : "")"
                                     style="@(string.IsNullOrWhiteSpace(EmployeeData.City) ? "pointer-events: none;" : "")">
                                    <span class="@(string.IsNullOrWhiteSpace(EmployeeData.Barangay) ? "text-gray-400" : "text-gray-700")">
                                        @(string.IsNullOrWhiteSpace(EmployeeData.Barangay) ? "Select Barangay" : EmployeeData.Barangay)
                                    </span>
                                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                                @if (addressHandler?.ShowBarangayDropdown == true && !string.IsNullOrWhiteSpace(EmployeeData.City))
                                {
                                    <div class="absolute z-[9999] mt-1 w-full rounded-lg border border-gray-300 bg-white shadow-lg" @onclick:stopPropagation="true" data-dropdown="barangay">
                                        <div class="border-b border-gray-200 p-2">
                                            <input type="text" 
                                                   @bind="addressHandler.BarangaySearchText" 
                                                   @bind:after="FilterBarangays"
                                                   @onkeydown="HandleSearchKeyDown"
                                                   @onkeydown:stopPropagation="true"
                                                   placeholder="Search barangay..."
                                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0" />
                                        </div>
                                        <div class="max-h-60 overflow-auto">
                                            @if (addressHandler.FilteredBarangays.Any())
                                            {
                                                @foreach (var barangay in addressHandler.FilteredBarangays)
                                                {
                                                    <div @onclick="() => SelectBarangay(barangay)" 
                                                         class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm @(EmployeeData.Barangay == barangay ? "bg-blue-100" : "")">
                                                        @barangay
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="px-4 py-2 text-sm text-gray-500">No results found</div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                            <ValidationMessage For="@(() => EmployeeData.Barangay)" class="text-red-500 text-xs mt-1" />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4">
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Country</label>
                            <InputText @bind-Value="EmployeeData.Country" 
                                      @bind-Value:after="HandleCountryChange"
                                      class="@GetCountryClass()"
                                      placeholder="e.g. Philippines" />
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">ZIP Code</label>
                            <InputText @bind-Value="EmployeeData.ZipCode" 
                                      class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base"
                                      placeholder="Auto-filled"
                                      readonly />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency Contact -->
            <div class="mb-6 overflow-hidden rounded-xl bg-white shadow sm:mb-8">
                <div class="px-6 py-6">
                    <h2 class="mb-4 border-b-2 border-blue-600 pb-2 text-lg font-bold text-blue-600 sm:mb-6 sm:text-xl">Emergency Contact</h2>
                    
                    <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-2 sm:gap-4 lg:grid-cols-4">
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                First Name <span class="text-red-500">*</span>
                            </label>
                            <InputText @bind-Value="EmployeeData.EmergencyContactFirstName" 
                                      @bind-Value:after="() => { FormatEmergencyContactFirstName(); editContext?.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.EmergencyContactFirstName))); StateHasChanged(); }"
                                      class="@GetInputClass(nameof(EmployeeData.EmergencyContactFirstName))"
                                      placeholder="e.g. Maria" />
                            <ValidationMessage For="@(() => EmployeeData.EmergencyContactFirstName)" class="text-red-500 text-xs mt-1" />
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Middle Name</label>
                            <InputText @bind-Value="EmployeeData.EmergencyContactMiddleName" 
                                      @bind-Value:after="FormatEmergencyContactMiddleName"
                                      class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base"
                                      placeholder="e.g. Dela Cruz" />
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Last Name <span class="text-red-500">*</span>
                            </label>
                            <InputText @bind-Value="EmployeeData.EmergencyContactLastName" 
                                      @bind-Value:after="() => { FormatEmergencyContactLastName(); editContext?.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.EmergencyContactLastName))); StateHasChanged(); }"
                                      class="@GetInputClass(nameof(EmployeeData.EmergencyContactLastName))"
                                      placeholder="e.g. Santos" />
                            <ValidationMessage For="@(() => EmployeeData.EmergencyContactLastName)" class="text-red-500 text-xs mt-1" />
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Suffix</label>
                            <InputSelect @bind-Value="EmployeeData.EmergencyContactSuffix" 
                                class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base">
                                <option value="">N/A</option>
                                <option value="Jr.">Jr.</option>
                                <option value="Sr.">Sr.</option>
                                <option value="II">II</option>
                                <option value="III">III</option>
                                <option value="IV">IV</option>
                            </InputSelect>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4 lg:grid-cols-3">
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Relationship <span class="text-red-500">*</span>
                            </label>
                            <InputSelect @bind-Value="EmployeeData.EmergencyContactRelationship" 
                                        @bind-Value:after="() => { OnRelationshipChanged(); editContext?.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.EmergencyContactRelationship))); StateHasChanged(); }"
                                        class="@GetInputClassWithExtra(nameof(EmployeeData.EmergencyContactRelationship), "bg-white")">
                                <option value="">Select Relationship</option>
                                <option value="Spouse">Spouse</option>
                                <option value="Parent">Parent</option>
                                <option value="Sibling">Sibling</option>
                                <option value="Child">Child</option>
                                <option value="Relative">Relative</option>
                                <option value="Friend">Friend</option>
                                <option value="Other">Other</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => EmployeeData.EmergencyContactRelationship)" class="text-red-500 text-xs mt-1" />
                            @if (EmployeeData.EmergencyContactRelationship == "Other")
                            {
                                <InputText @bind-Value="EmployeeData.EmergencyContactRelationshipOther" 
                                          @bind-Value:after="() => { editContext?.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.EmergencyContactRelationshipOther))); StateHasChanged(); }"
                                          class="mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base"
                                          placeholder="Please specify" />
                            }
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Contact Number <span class="text-red-500">*</span>
                            </label>
                            <InputText @bind-Value="EmployeeData.EmergencyContactNumber" 
                                      @bind-Value:after="() => { FormatEmergencyContactNumber(); editContext?.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.EmergencyContactNumber))); StateHasChanged(); }"
                                      maxlength="11"
                                      onkeypress="return /[0-9]/i.test(event.key) || event.key === 'Backspace' || event.key === 'Delete' || event.key === 'ArrowLeft' || event.key === 'ArrowRight'"
                                      class="@GetInputClass(nameof(EmployeeData.EmergencyContactNumber))"
                                      placeholder="e.g. 09123456789" />
                            <ValidationMessage For="@(() => EmployeeData.EmergencyContactNumber)" class="text-red-500 text-xs mt-1" />
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Address</label>
                            <InputText @bind-Value="EmployeeData.EmergencyContactAddress" 
                                      class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base"
                                      placeholder="e.g. 123 Main Street, City" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Role and Account Information -->
            <div class="mb-6 overflow-hidden rounded-xl bg-white shadow sm:mb-8">
                <div class="px-6 py-6">
                    <h2 class="mb-4 border-b-2 border-blue-600 pb-2 text-lg font-bold text-blue-600 sm:mb-6 sm:text-xl">Role and Account Information</h2>
                    
                    <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4 lg:grid-cols-3">
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Role <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                @if (isLoadingRoles)
                                {
                                    <div class="flex items-center justify-center rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 text-sm sm:px-4 sm:py-2.5 sm:text-base">
                                        <svg class="mr-2 h-4 w-4 animate-spin text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span class="text-gray-600">Loading roles...</span>
                                    </div>
                                }
                                else
                                {
                                    <InputSelect @bind-Value="EmployeeData.Role" @bind-Value:after="OnRoleChanged" 
                                                class="@GetInputClassWithExtra(nameof(EmployeeData.Role), "bg-white")"
                                                disabled="@isLoadingRoleData">
                                        <option value="">Select Role</option>
                                        @if (availableRoles != null && availableRoles.Any())
                                        {
                                            @foreach (var role in availableRoles)
                                            {
                                                <option value="@role.RoleName">@role.RoleName</option>
                                            }
                                        }
                                    </InputSelect>
                                }
                            </div>
                            <ValidationMessage For="@(() => EmployeeData.Role)" class="text-red-500 text-xs mt-1" />
                        </div>
                        @if (ShowPasswordFields)
                        {
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Default Password</label>
                                @if (isLoadingRoleData)
                                {
                                    <div class="flex items-center justify-center rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 text-sm sm:px-4 sm:py-2.5 sm:text-base">
                                        <svg class="mr-2 h-4 w-4 animate-spin text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </div>
                                }
                                else
                                {
                                    <InputText @bind-Value="EmployeeData.DefaultPassword" 
                                              class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base"
                                              readonly />
                                }
                                <p class="mt-1 text-xs text-gray-500">Default password is automatically generated</p>
                            </div>
                        }
                        @if (!string.IsNullOrWhiteSpace(EmployeeData.Role))
                        {
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">System ID</label>
                                @if (isLoadingRoleData)
                                {
                                    <div class="flex items-center justify-center rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 text-sm sm:px-4 sm:py-2.5 sm:text-base">
                                        <svg class="mr-2 h-4 w-4 animate-spin text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </div>
                                }
                                else
                                {
                                    <InputText @bind-Value="EmployeeData.SystemId" 
                                              class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base"
                                              readonly />
                                }
                                <p class="mt-1 text-xs text-gray-500">System ID is automatically assigned</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Salary Information -->
            <div class="mb-6 overflow-hidden rounded-xl bg-white shadow sm:mb-8">
                <div class="px-6 py-6">
                    <h2 class="mb-4 border-b-2 border-blue-600 pb-2 text-lg font-bold text-blue-600 sm:mb-6 sm:text-xl">Salary Information</h2>
                    
                    <!-- Base Salary, Allowance, and Total -->
                    <div class="grid grid-cols-1 gap-3 sm:grid-cols-3 sm:gap-4">
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Base Salary <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <span class="-translate-y-1/2 absolute left-3 top-1/2 text-sm text-gray-600">₱</span>
                                @if (isLoadingRoleData)
                                {
                                    <div class="flex items-center justify-center rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 pl-8 text-right text-sm sm:px-4 sm:py-2.5 sm:text-base">
                                        <svg class="mr-2 h-4 w-4 animate-spin text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </div>
                                }
                                else
                                {
                                    <InputNumber @bind-Value="EmployeeData.BaseSalary" 
                                                 class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 pl-8 text-right text-sm text-gray-700 cursor-not-allowed sm:px-4 sm:py-2.5 sm:text-base"
                                                 placeholder="0.00"
                                                 readonly />
                                }
                            </div>
                            <ValidationMessage For="@(() => EmployeeData.BaseSalary)" class="text-red-500 text-xs mt-1" />
                            <p class="mt-1 text-xs text-gray-500">Automatically set based on role</p>
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Allowance</label>
                            <div class="relative">
                                <span class="-translate-y-1/2 absolute left-3 top-1/2 text-sm text-gray-600">₱</span>
                                @if (isLoadingRoleData)
                                {
                                    <div class="flex items-center justify-center rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 pl-8 text-right text-sm sm:px-4 sm:py-2.5 sm:text-base">
                                        <svg class="mr-2 h-4 w-4 animate-spin text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </div>
                                }
                                else
                                {
                                    <InputNumber @bind-Value="EmployeeData.Allowance" 
                                                 class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 pl-8 text-right text-sm text-gray-700 cursor-not-allowed sm:px-4 sm:py-2.5 sm:text-base"
                                                 placeholder="0.00"
                                                 readonly />
                                }
                            </div>
                            <p class="mt-1 text-xs text-gray-500">Automatically set based on role</p>
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Total</label>
                            <div class="relative">
                                <span class="-translate-y-1/2 absolute left-3 top-1/2 text-sm text-gray-600">₱</span>
                                @if (isLoadingRoleData)
                                {
                                    <div class="flex items-center justify-center rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 pl-8 text-right text-sm sm:px-4 sm:py-2.5 sm:text-base">
                                        <svg class="mr-2 h-4 w-4 animate-spin text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </div>
                                }
                                else
                                {
                                    <input type="text" 
                                           value="@FormatSalaryInput(EmployeeData.TotalSalary)" 
                                           readonly
                                           class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 pl-8 text-right text-sm font-semibold text-gray-700 sm:px-4 sm:py-2.5 sm:text-base"
                                           placeholder="0.00" />
                                }
                            </div>
                            <p class="mt-1 text-xs text-gray-500">Automatically calculated</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-6 flex justify-end gap-4">
                <button type="button" 
                    @onclick="Cancel"
                    @onkeydown:preventDefault="true"
                    class="rounded-lg bg-gray-500 px-6 py-2.5 text-sm font-semibold text-white shadow-md transition-all duration-300 hover:bg-gray-600 hover:shadow-lg">
                    Cancel
                </button>
                <button type="button" 
                    @onclick="HandleSubmitClick"
                    @onkeydown:preventDefault="true"
                    disabled="@isSubmitting"
                    class="rounded-lg bg-blue-600 px-6 py-2.5 text-sm font-semibold text-white shadow-md transition-all duration-300 hover:bg-blue-700 hover:shadow-lg disabled:cursor-not-allowed disabled:opacity-50">
                    @if (isSubmitting)
                    {
                        <span class="inline-flex items-center justify-center">
                            <svg class="-ml-1 mr-2 h-4 w-4 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Adding Employee...</span>
                        </span>
                    }
                    else
                    {
                        <span>Add Employee</span>
                    }
                </button>
            </div>
        </EditForm>
    </div>
</div>

<!-- Toast Notification (only for error cases) -->
@if (showToast)
{
    <ToastNotification Show="@showToast" Message="@toastMessage" Type="@toastType" OnClose="CloseToast" Duration="3000" />
}

<!-- Confirmation Modal -->
@if (showConfirmModal)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @onclick="HandleBackdropClick">
        <div id="add-employee-confirm-modal" class="w-full max-w-md overflow-hidden rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <!-- Modal Header -->
            <div class="flex items-center justify-between rounded-t-2xl bg-white px-6 py-2.5 border-b border-gray-200">
                <h3 class="text-base font-semibold @(confirmModalType == "cancel" || confirmModalType == "navigate" ? "text-red-500" : "text-blue-600")">@confirmModalTitle</h3>
                <button @onclick="CloseConfirmModal" class="text-gray-400 hover:text-gray-600" style="background: transparent; border: none; cursor: pointer; padding: 0; margin: 0;">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
 
            <!-- Modal Body -->
            <div class="rounded-b-2xl bg-white px-6 py-4">
                <p class="mb-4 text-sm text-gray-700">@confirmModalMessage</p>

                <div class="flex justify-end gap-2">
                    <button type="button" @onclick="CloseConfirmModal"
                            class="rounded-lg border border-gray-300 bg-transparent px-3 py-1.5 text-sm font-medium text-gray-700 transition-all hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="button" @onclick="ConfirmAction"
                            class="rounded-lg px-3 py-1.5 text-sm font-medium text-white transition-all hover:opacity-90 @(confirmModalType == "cancel" || confirmModalType == "navigate" ? "" : "bg-blue-600")"
                            style="@(confirmModalType == "cancel" || confirmModalType == "navigate" ? "background-color: #ef4444;" : "")">
                        @(confirmModalType == "submit" ? "Add Employee" : confirmModalType == "navigate" ? "Leave Page" : "Confirm")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Validation Error Modal -->
@if (showValidationModal)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @onclick="HandleBackdropClick">
        <div id="add-employee-validation-modal" class="w-full max-w-md overflow-hidden rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <!-- Modal Header -->
            <div class="flex items-center justify-between rounded-t-2xl bg-white px-6 py-2.5 border-b border-gray-200">
                <h3 class="text-base font-semibold text-red-500">Missing Required Fields</h3>
                <button @onclick="CloseValidationModal" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
 
            <!-- Modal Body -->
            <div class="px-6 py-4">
                <p class="mb-3 text-sm text-gray-700">
                    Please fill in the following required fields before submitting:
                </p>
                
                @if (missingFields.Any())
                {
                    <div class="mb-4 max-h-60 overflow-y-auto rounded-lg border border-gray-200 bg-gray-50 p-3">
                        <ul class="list-inside list-disc space-y-1 text-sm text-gray-700">
                            @foreach (var field in missingFields)
                            {
                                <li>@field</li>
                            }
                        </ul>
                    </div>
                }
                else
                {
                    <div class="mb-4 rounded-lg border border-gray-200 bg-gray-50 p-3">
                        <p class="text-sm text-gray-700">Please complete all required fields marked with <span class="text-red-500">*</span></p>
                    </div>
                }
            </div>

            <div class="flex justify-end border-t border-gray-200 px-6 py-3">
                <button type="button" @onclick="CloseValidationModal" class="rounded-lg px-3 py-1.5 text-sm font-medium text-white transition-all hover:opacity-90 bg-red-500">
                    OK
                </button>
            </div>
        </div>
    </div>
}

<!-- Duplicate Employee Warning Modal -->
@if (showDuplicateModal && duplicateCheckResult != null)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @onclick="HandleBackdropClick">
        <div id="add-employee-duplicate-modal" class="w-full max-w-2xl overflow-hidden rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <!-- Modal Header -->
            <div class="flex items-center justify-between rounded-t-2xl" style="background-color: #f59e0b; padding: 12px 24px;">
                <h3 class="text-lg font-semibold text-white" style="margin: 0;">⚠️ Potential Duplicate Employee Detected</h3>
                <button @onclick="CloseDuplicateModal" class="text-white hover:text-gray-200" style="background: transparent; border: none; cursor: pointer; padding: 0; margin: 0;">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
 
            <!-- Modal Body -->
            <div class="rounded-b-2xl bg-white" style="padding: 24px;">
                <p class="mb-4 text-sm text-gray-700" style="margin: 0 0 16px 0; line-height: 1.5;">
                    A potential duplicate employee record was found based on <strong>Full Name</strong>, <strong>Date of Birth</strong>, and <strong>Address</strong>.
                </p>
                
                <!-- Existing Employee Information -->
                <div class="mb-4 rounded-lg border-2 border-yellow-200 bg-yellow-50" style="padding: 16px;">
                    <h4 class="mb-3 text-sm font-semibold text-gray-800" style="margin: 0 0 12px 0;">Existing Employee Record:</h4>
                    <div class="space-y-2 text-sm text-gray-700">
                        <div class="flex">
                            <span class="font-medium" style="min-width: 140px;">System ID:</span>
                            <span>@duplicateCheckResult.ExistingSystemId</span>
                        </div>
                        <div class="flex">
                            <span class="font-medium" style="min-width: 140px;">Full Name:</span>
                            <span>@duplicateCheckResult.ExistingFullName</span>
                        </div>
                        <div class="flex">
                            <span class="font-medium" style="min-width: 140px;">Date of Birth:</span>
                            <span>@(duplicateCheckResult.ExistingBirthDate?.ToString("MM/dd/yyyy") ?? "N/A")</span>
                        </div>
                        <div class="flex">
                            <span class="font-medium" style="min-width: 140px;">Address:</span>
                            <span>@duplicateCheckResult.ExistingAddress</span>
                        </div>
                        <div class="flex">
                            <span class="font-medium" style="min-width: 140px;">Current Email:</span>
                            <span>@duplicateCheckResult.ExistingEmail</span>
                        </div>
                        <div class="flex">
                            <span class="font-medium" style="min-width: 140px;">Current Contact:</span>
                            <span>@duplicateCheckResult.ExistingContactNumber</span>
                        </div>
                    </div>
                </div>

                <!-- New Employee Information -->
                <div class="mb-4 rounded-lg border border-gray-200 bg-gray-50" style="padding: 16px;">
                    <h4 class="mb-3 text-sm font-semibold text-gray-800" style="margin: 0 0 12px 0;">New Employee Information:</h4>
                    <div class="space-y-2 text-sm text-gray-700">
                        <div class="flex">
                            <span class="font-medium" style="min-width: 140px;">New Email:</span>
                            <span>@(string.IsNullOrWhiteSpace(EmployeeData.Email) ? "Not provided" : EmployeeData.Email)</span>
                        </div>
                        <div class="flex">
                            <span class="font-medium" style="min-width: 140px;">New Contact:</span>
                            <span>@(string.IsNullOrWhiteSpace(EmployeeData.ContactNumber) ? "Not provided" : EmployeeData.ContactNumber)</span>
                        </div>
                    </div>
                </div>

                <p class="mb-4 text-sm text-gray-600" style="margin: 0 0 16px 0; line-height: 1.5;">
                    <strong>What would you like to do?</strong><br/>
                    • <strong>Update Existing:</strong> Update the existing employee's contact number and/or email with the new information.<br/>
                    • <strong>Create New:</strong> Proceed to create a new employee record (only if this is confirmed to be a different person).
                </p>

                <div class="flex justify-end gap-3" style="border-top: 1px solid #e5e7eb; padding-top: 16px; margin-top: 20px;">
                    <button type="button" @onclick="CloseDuplicateModal" 
                            class="rounded-lg text-sm font-medium text-gray-700 transition-all hover:bg-gray-100" 
                            style="background-color: #f3f4f6; padding: 10px 24px; margin: 0; border: none; cursor: pointer;">
                        Cancel
                    </button>
                    <button type="button" @onclick="ProceedWithNewEmployee" 
                            class="rounded-lg text-sm font-medium text-white transition-all hover:opacity-90" 
                            style="background-color: #3b82f6; padding: 10px 24px; margin: 0; border: none; cursor: pointer;">
                        Create New Employee
                    </button>
                    <button type="button" @onclick="UpdateExistingEmployee" 
                            disabled="@isSubmitting"
                            class="rounded-lg text-sm font-medium text-white transition-all hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed" 
                            style="background-color: #3b82f6; padding: 10px 24px; margin: 0; border: none; cursor: pointer;">
                        @if (isSubmitting)
                        {
                            <span>Updating...</span>
                        }
                        else
                        {
                            <span>Update Existing Employee</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private EditContext? editContext;
    private EmployeeFormData EmployeeData { get; set; } = new();
    private bool ShowPasswordFields { get; set; } = false;
    private EmployeeAddressHandler? addressHandler;
    private DotNetObjectReference<AddEmployee>? dotNetRef;
    
    // Validation and error handling
    private bool showValidationModal = false;
    private List<string> missingFields = new();
    
    // Confirmation modal
    private bool showConfirmModal = false;
    private string confirmModalTitle = "";
    private string confirmModalMessage = "";
    private string confirmModalType = ""; // "submit" or "cancel"
    
    // Loading state
    private bool isSubmitting = false;
    
    // Toast notification (only for error cases)
    private bool showToast = false;
    private string toastMessage = "";
    private ToastType toastType = ToastType.Success;
    
    // Salary input editing state
    private string? editingSalaryField = null;
    private string baseSalaryRawInput = "";
    private string allowanceRawInput = "";
    // Note: ElementReference fields kept for potential future use
    #pragma warning disable CS0169
    private ElementReference baseSalaryInputRef;
    private ElementReference allowanceInputRef;
    #pragma warning restore CS0169
    
    // Email uniqueness validation
    private bool isEmailDuplicate = false;
    private CancellationTokenSource? emailCheckCancellationTokenSource;
    
    // Contact number uniqueness validation
    private bool isContactDuplicate = false;
    private CancellationTokenSource? contactCheckCancellationTokenSource;
    
    // Duplicate employee detection
    private bool showDuplicateModal = false;
    private EmployeeDuplicateCheckResult? duplicateCheckResult = null;
    
    // Role fetching from database
    private List<BrightEnroll_DES.Data.Models.Role>? availableRoles = null;
    private bool isLoadingRoles = false;
    private bool isLoadingRoleData = false;
    
    // Navigation prevention
    private bool isNavigatingAway = false;
    private string? pendingNavigationUrl = null;

    protected override async Task OnInitializedAsync()
    {
        editContext = new EditContext(EmployeeData);
        dotNetRef = DotNetObjectReference.Create(this);
        addressHandler = new EmployeeAddressHandler(AddressService, EmployeeData, StateHasChanged);
        
        await LoadRolesFromDatabase();
    }
    
    // Load roles from database
    private async Task LoadRolesFromDatabase()
    {
        isLoadingRoles = true;
        StateHasChanged();
        
        try
        {
            availableRoles = await DbContext.Roles
                .Where(r => r.IsActive)
                .OrderBy(r => r.RoleName)
                .ToListAsync();
        }
        catch (Exception)
        {
            // Log error or show toast notification
            availableRoles = new List<BrightEnroll_DES.Data.Models.Role>();
        }
        finally
        {
            isLoadingRoles = false;
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && dotNetRef != null)
        {
            await JSRuntime.InvokeVoidAsync("setupClickOutsideHandler", dotNetRef);
            await JSRuntime.InvokeVoidAsync("setupNavigationGuard", dotNetRef, "/human-resource/add-employee");
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    public void Dispose()
    {
        dotNetRef?.Dispose();
        emailCheckCancellationTokenSource?.Cancel();
        emailCheckCancellationTokenSource?.Dispose();
        contactCheckCancellationTokenSource?.Cancel();
        contactCheckCancellationTokenSource?.Dispose();
    }
    
    // Handle navigation BEFORE it happens using NavigationLock
    private async Task OnBeforeInternalNavigation(LocationChangingContext context)
    {
        // If we're already navigating away (confirmed), allow it
        if (isNavigatingAway)
        {
            isNavigatingAway = false; // Reset flag after navigation
            return;
        }
        
        // If form has data, prevent navigation and show confirmation modal
        if (HasData())
        {
            // Prevent the navigation
            context.PreventNavigation();
            
            // Store the intended destination
            pendingNavigationUrl = context.TargetLocation;
            
            // Show confirmation modal - use InvokeAsync to ensure UI update
            await InvokeAsync(() =>
            {
                ShowNavigationConfirmModal();
            });
        }
    }
    
    // Show navigation confirmation modal
    private void ShowNavigationConfirmModal()
    {
        confirmModalTitle = "Unsaved Changes";
        confirmModalMessage = "You have unsaved changes. Are you sure you want to leave? All entered data will be lost.";
        confirmModalType = "navigate";
        showConfirmModal = true;
        StateHasChanged();
    }

    private void CloseAllDropdowns()
    {
        addressHandler?.CloseDropdowns();
    }

    [JSInvokable]
    public void CloseDropdownsFromJS()
    {
        addressHandler?.CloseDropdowns();
        StateHasChanged();
    }
    
    [JSInvokable]
    public async Task<bool> CheckBeforeNavigate(string targetUrl)
    {
        // If form has data, prevent navigation and show modal
        if (HasData())
        {
            await InvokeAsync(() =>
            {
                pendingNavigationUrl = targetUrl;
                ShowNavigationConfirmModal();
            });
            return true; // Prevent navigation
        }
        return false; // Allow navigation
    }

    // Name formatting methods
    private void FormatFirstName()
    {
        EmployeeData.FirstName = EmployeeFormHelpers.FormatName(EmployeeData.FirstName);
    }

    private void FormatMiddleName()
    {
        EmployeeData.MiddleName = EmployeeFormHelpers.FormatName(EmployeeData.MiddleName);
    }

    private void FormatLastName()
    {
        EmployeeData.LastName = EmployeeFormHelpers.FormatName(EmployeeData.LastName);
    }

    // Contact number formatting
    private void FormatContactNumber()
    {
        EmployeeData.ContactNumber = EmployeeFormHelpers.CleanContactNumber(EmployeeData.ContactNumber);
        if (EmployeeData.ContactNumber.Length > 11)
        {
            EmployeeData.ContactNumber = EmployeeData.ContactNumber.Substring(0, 11);
        }
    }

    // Emergency contact name formatting methods
    private void FormatEmergencyContactFirstName()
    {
        EmployeeData.EmergencyContactFirstName = EmployeeFormHelpers.FormatName(EmployeeData.EmergencyContactFirstName);
    }

    private void FormatEmergencyContactMiddleName()
    {
        EmployeeData.EmergencyContactMiddleName = EmployeeFormHelpers.FormatName(EmployeeData.EmergencyContactMiddleName);
    }

    private void FormatEmergencyContactLastName()
    {
        EmployeeData.EmergencyContactLastName = EmployeeFormHelpers.FormatName(EmployeeData.EmergencyContactLastName);
    }

    // Emergency contact number formatting
    private void FormatEmergencyContactNumber()
    {
        EmployeeData.EmergencyContactNumber = EmployeeFormHelpers.CleanContactNumber(EmployeeData.EmergencyContactNumber);
        if (EmployeeData.EmergencyContactNumber.Length > 11)
        {
            EmployeeData.EmergencyContactNumber = EmployeeData.EmergencyContactNumber.Substring(0, 11);
        }
    }

    // Age calculation
    private void CalculateAge()
    {
        if (EmployeeData.BirthDate.HasValue)
        {
            var today = DateTime.Today;
            var age = today.Year - EmployeeData.BirthDate.Value.Year;
            if (EmployeeData.BirthDate.Value.Date > today.AddYears(-age))
                age--;
            EmployeeData.Age = age;
        }
        else
        {
            EmployeeData.Age = null;
        }
    }

    // Address handler methods
    private void FilterProvinces()
    {
        addressHandler?.FilterProvinces();
    }

    private void FilterCities()
    {
        addressHandler?.FilterCities();
    }

    private void FilterBarangays()
    {
        addressHandler?.FilterBarangays();
    }

    private void SelectProvince(string province)
    {
        addressHandler?.SelectProvince(province);
        if (editContext != null)
        {
            editContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.Province)));
        }
        StateHasChanged();
    }

    private void SelectCity(string city)
    {
        addressHandler?.SelectCity(city);
        if (editContext != null)
        {
            editContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.City)));
        }
        StateHasChanged();
    }

    private void SelectBarangay(string barangay)
    {
        addressHandler?.SelectBarangay(barangay);
        if (editContext != null)
        {
            editContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.Barangay)));
        }
        StateHasChanged();
    }

    private void HandleSearchKeyDown(KeyboardEventArgs e)
    {
        // Prevent Enter key from submitting the form
    }

    private void HandleCountryChange()
    {
        if (!string.IsNullOrWhiteSpace(EmployeeData.Country) && 
            !EmployeeData.Country.Equals("Philippines", StringComparison.OrdinalIgnoreCase))
        {
            // Clear Philippine address fields if non-Philippines country is entered
            EmployeeData.Province = "";
            EmployeeData.City = "";
            EmployeeData.Barangay = "";
            EmployeeData.ZipCode = "";
            addressHandler?.CloseDropdowns();
        }
    }

    private string GetCountryClass()
    {
        var baseClass = "w-full px-3 py-2 sm:px-4 sm:py-2.5 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none focus:ring-0 text-sm sm:text-base";
        if (addressHandler?.IsCountryDisabled() == true)
        {
            return $"{baseClass} bg-gray-100 cursor-not-allowed";
        }
        return baseClass;
    }

    // Calculate total salary (Base Salary + Allowance)
    private void CalculateTotalSalary()
    {
        EmployeeData.TotalSalary = EmployeeData.BaseSalary + EmployeeData.Allowance;
        StateHasChanged();
    }

    // Role change handler
    private async Task OnRoleChanged()
    {
        isLoadingRoleData = true;
        StateHasChanged();
        
        try
        {
            if (!string.IsNullOrWhiteSpace(EmployeeData.Role) && availableRoles != null)
            {
                // Find the selected role from database
                var selectedRole = availableRoles.FirstOrDefault(r => r.RoleName == EmployeeData.Role);
                
                if (selectedRole != null)
                {
                    // Auto-populate salary information from database
                    EmployeeData.BaseSalary = selectedRole.BaseSalary;
                    EmployeeData.Allowance = selectedRole.Allowance;
                    CalculateTotalSalary();
                    
                    // Generate System ID for ALL roles (required by database)
                    EmployeeData.SystemId = await GenerateSystemIdAsync();
                    
                    // Generate password for ALL roles (required by database)
                    EmployeeData.DefaultPassword = GenerateDefaultPassword();
                }
                else
                {
                    // Role not found, reset values
                    EmployeeData.BaseSalary = 0;
                    EmployeeData.Allowance = 0;
                    EmployeeData.TotalSalary = 0;
                    EmployeeData.SystemId = "";
                    EmployeeData.DefaultPassword = "";
                }
            }
            else
            {
                // No role selected, clear all fields
                EmployeeData.BaseSalary = 0;
                EmployeeData.Allowance = 0;
                EmployeeData.TotalSalary = 0;
                EmployeeData.SystemId = "";
                EmployeeData.DefaultPassword = "";
            }
            
            // Roles with system access
            var rolesWithAccess = new[] { "Registrar", "Cashier", "Teacher", "HR", "System Admin", "Librarian" };
            ShowPasswordFields = rolesWithAccess.Contains(EmployeeData.Role);
        }
        finally
        {
            isLoadingRoleData = false;
            StateHasChanged();
        }
    }

    // Relationship change handler
    private void OnRelationshipChanged()
    {
        // Clear the "Other" field if relationship is changed away from "Other"
        if (EmployeeData.EmergencyContactRelationship != "Other")
        {
            EmployeeData.EmergencyContactRelationshipOther = "";
        }
    }

    // Format salary input with commas and 2 decimals
    private string FormatSalaryInput(decimal value)
    {
        if (value == 0)
            return "0.00";
        
        return value.ToString("N2");
    }

    // Get display value for salary field (raw when editing, formatted when not)
    private string GetSalaryDisplayValue(string fieldName)
    {
        if (editingSalaryField == fieldName)
        {
            if (fieldName == nameof(EmployeeData.BaseSalary))
            {
                // Format with commas while typing for Base Salary
                return FormatNumberWithCommas(baseSalaryRawInput);
            }
            else if (fieldName == nameof(EmployeeData.Allowance))
            {
                // Format with commas while typing for Allowance
                return FormatNumberWithCommas(allowanceRawInput);
            }
        }
        
        // Return formatted value when not editing
        if (fieldName == nameof(EmployeeData.BaseSalary))
            return FormatSalaryInput(EmployeeData.BaseSalary);
        else if (fieldName == nameof(EmployeeData.Allowance))
            return FormatSalaryInput(EmployeeData.Allowance);
        
        return "0";
    }

    // Format number string with commas (for display while typing)
    private string FormatNumberWithCommas(string numberString)
    {
        if (string.IsNullOrWhiteSpace(numberString) || numberString == ".")
            return numberString;

        // Remove any existing commas
        string cleaned = numberString.Replace(",", "");
        
        // Check if it has a decimal point
        if (cleaned.Contains('.'))
        {
            var parts = cleaned.Split('.');
            string integerPart = parts[0];
            string decimalPart = parts.Length > 1 ? parts[1] : "";
            
            // Format integer part with commas manually
            if (!string.IsNullOrWhiteSpace(integerPart) && long.TryParse(integerPart, out long intValue))
            {
                string formattedInteger = FormatIntegerWithCommas(intValue);
                return decimalPart.Length > 0 ? $"{formattedInteger}.{decimalPart}" : formattedInteger;
            }
            else if (string.IsNullOrWhiteSpace(integerPart))
            {
                return decimalPart.Length > 0 ? $".{decimalPart}" : ".";
            }
        }
        else
        {
            // No decimal point, format the whole number
            if (!string.IsNullOrWhiteSpace(cleaned) && long.TryParse(cleaned, out long intValue))
            {
                return FormatIntegerWithCommas(intValue);
            }
        }
        
        return numberString;
    }

    // Format integer with commas (e.g., 19000 -> "19,000")
    private string FormatIntegerWithCommas(long value)
    {
        if (value == 0)
            return "0";
        
        string result = "";
        string valueStr = value.ToString();
        int length = valueStr.Length;
        
        for (int i = 0; i < length; i++)
        {
            if (i > 0 && (length - i) % 3 == 0)
            {
                result += ",";
            }
            result += valueStr[i];
        }
        
        return result;
    }

    // Handle salary field focus - clear to "0" without decimal
    private async Task HandleSalaryFocus(FocusEventArgs e, string fieldName)
    {
        editingSalaryField = fieldName;
        
        if (fieldName == nameof(EmployeeData.BaseSalary))
        {
            // Remove decimal if value is whole number, otherwise show without trailing zeros
            if (EmployeeData.BaseSalary == 0)
            {
                baseSalaryRawInput = "";
            }
            else if (EmployeeData.BaseSalary == Math.Floor(EmployeeData.BaseSalary))
            {
                baseSalaryRawInput = ((int)EmployeeData.BaseSalary).ToString();
            }
            else
            {
                baseSalaryRawInput = EmployeeData.BaseSalary.ToString("0.##");
            }
            
            // Select all text for easy editing
            await Task.Delay(10);
            await JSRuntime.InvokeVoidAsync("eval", $"document.querySelector('[data-salary-field=\"{fieldName}\"]')?.select();");
        }
        else if (fieldName == nameof(EmployeeData.Allowance))
        {
            // Remove decimal if value is whole number, otherwise show without trailing zeros
            if (EmployeeData.Allowance == 0)
            {
                allowanceRawInput = "";
            }
            else if (EmployeeData.Allowance == Math.Floor(EmployeeData.Allowance))
            {
                allowanceRawInput = ((int)EmployeeData.Allowance).ToString();
            }
            else
            {
                allowanceRawInput = EmployeeData.Allowance.ToString("0.##");
            }
            
            // Select all text for easy editing
            await Task.Delay(10);
            await JSRuntime.InvokeVoidAsync("eval", $"document.querySelector('[data-salary-field=\"{fieldName}\"]')?.select();");
        }
        
        StateHasChanged();
    }

    // Handle salary field blur - format with 2 decimals
    private void HandleSalaryBlur(FocusEventArgs e, string fieldName)
    {
        editingSalaryField = null;
        
        // Parse and format the raw input
        string rawValue = "";
        if (fieldName == nameof(EmployeeData.BaseSalary))
        {
            rawValue = baseSalaryRawInput;
        }
        else if (fieldName == nameof(EmployeeData.Allowance))
        {
            rawValue = allowanceRawInput;
        }
        
        // Clean and parse
        string cleaned = rawValue.Replace("₱", "").Replace(",", "").Replace(" ", "").Trim();
        if (string.IsNullOrWhiteSpace(cleaned) || cleaned == ".")
        {
            cleaned = "0";
        }
        
        if (decimal.TryParse(cleaned, out decimal parsedValue))
        {
            // Round to 2 decimals (always show 2 decimal places)
            parsedValue = Math.Round(parsedValue, 2);
            
            // Update the appropriate field
            if (fieldName == nameof(EmployeeData.BaseSalary))
            {
                EmployeeData.BaseSalary = parsedValue;
                baseSalaryRawInput = "";
            }
            else if (fieldName == nameof(EmployeeData.Allowance))
            {
                EmployeeData.Allowance = parsedValue;
                allowanceRawInput = "";
            }
            
            // Recalculate total salary
            CalculateTotalSalary();
        }
        else
        {
            // If parsing fails, reset to 0
            if (fieldName == nameof(EmployeeData.BaseSalary))
            {
                EmployeeData.BaseSalary = 0;
                baseSalaryRawInput = "";
            }
            else if (fieldName == nameof(EmployeeData.Allowance))
            {
                EmployeeData.Allowance = 0;
                allowanceRawInput = "";
            }
            CalculateTotalSalary();
        }
        
        StateHasChanged();
    }

    // Handle salary input with validation and decimal limit
    private void HandleSalaryInput(ChangeEventArgs e, string fieldName)
    {
        var inputValue = e.Value?.ToString() ?? "";
        
        // Remove peso sign, commas, and spaces
        string cleaned = inputValue.Replace("₱", "").Replace(",", "").Replace(" ", "").Trim();
        
        if (string.IsNullOrWhiteSpace(cleaned) || cleaned == ".")
        {
            cleaned = "";
        }
        else
        {
            // Validate: only numbers and one dot
            var validChars = cleaned.Where(c => char.IsDigit(c) || c == '.').ToArray();
            var dotCount = validChars.Count(c => c == '.');
            
            if (dotCount > 1)
            {
                // Remove extra dots
                var firstDotIndex = Array.IndexOf(validChars, '.');
                validChars = validChars.Take(firstDotIndex + 1).Concat(validChars.Skip(firstDotIndex + 1).Where(c => c != '.')).ToArray();
            }
            
            cleaned = new string(validChars);
            
            // If starting with "0" and next char is a digit (not "."), replace the "0"
            if (cleaned.Length > 1 && cleaned[0] == '0' && char.IsDigit(cleaned[1]))
            {
                cleaned = cleaned.Substring(1);
            }
            
            // Limit decimal places to 2
            if (cleaned.Contains('.'))
            {
                var parts = cleaned.Split('.');
                if (parts.Length == 2 && parts[1].Length > 2)
                {
                    cleaned = parts[0] + "." + parts[1].Substring(0, 2);
                }
            }
        }
        
        // Update raw input (store without commas for parsing)
        if (fieldName == nameof(EmployeeData.BaseSalary))
        {
            baseSalaryRawInput = cleaned;
        }
        else if (fieldName == nameof(EmployeeData.Allowance))
        {
            allowanceRawInput = cleaned;
        }
        
        // Parse and update the field value (only if we have a valid number)
        if (!string.IsNullOrWhiteSpace(cleaned) && cleaned != "." && decimal.TryParse(cleaned, out decimal parsedValue))
        {
            // Round to 2 decimals
            parsedValue = Math.Round(parsedValue, 2);
            
            // Update the appropriate field
            if (fieldName == nameof(EmployeeData.BaseSalary))
            {
                EmployeeData.BaseSalary = parsedValue;
            }
            else if (fieldName == nameof(EmployeeData.Allowance))
            {
                EmployeeData.Allowance = parsedValue;
            }
            
            // Recalculate total salary
            CalculateTotalSalary();
        }
        else if (string.IsNullOrWhiteSpace(cleaned) || cleaned == ".")
        {
            // If empty or just a dot, set to 0
            if (fieldName == nameof(EmployeeData.BaseSalary))
            {
                EmployeeData.BaseSalary = 0;
            }
            else if (fieldName == nameof(EmployeeData.Allowance))
            {
                EmployeeData.Allowance = 0;
            }
            CalculateTotalSalary();
        }
        
        StateHasChanged();
    }

    // Handle keyboard input - only allow numbers and dot
    // Note: Input validation in HandleSalaryInput will filter invalid characters

    private string GenerateDefaultPassword()
    {
        return "BDESPassword123!";
    }

    private async Task<string> GenerateSystemIdAsync()
    {
        try
        {
            // Get next available system ID from database (incremental)
            return await UserRepository.GetNextSystemIdAsync();
        }
        catch (Exception ex)
        {
            // Fallback to random if database query fails
            Console.WriteLine($"Error generating system ID: {ex.Message}");
            var random = new Random();
            var number = random.Next(1000, 9999);
            return $"BDES-{number}";
        }
    }

    // Check email uniqueness with debouncing to avoid too many database calls
    // Fixed: Captures email value to prevent stale results and reduces delay
    private async Task CheckEmailUniqueness()
    {
        // Cancel any pending email check
        if (emailCheckCancellationTokenSource != null)
        {
            emailCheckCancellationTokenSource.Cancel();
            emailCheckCancellationTokenSource.Dispose();
            emailCheckCancellationTokenSource = null;
        }
        
        // Capture current email value to verify it hasn't changed after async operations
        var currentEmail = EmployeeData.Email?.Trim() ?? string.Empty;
        
        // Reset duplicate flag immediately when email changes
        isEmailDuplicate = false;
        StateHasChanged(); // Update UI immediately to clear any previous error state
        
        // If email is empty or invalid format, don't check
        if (string.IsNullOrWhiteSpace(currentEmail) || 
            !System.Text.RegularExpressions.Regex.IsMatch(currentEmail, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
        {
            return;
        }
        
        // Create new cancellation token source and store reference
        var tokenSource = new CancellationTokenSource();
        emailCheckCancellationTokenSource = tokenSource;
        var cancellationToken = tokenSource.Token;
        
        try
        {
            // Reduced debounce delay from 500ms to 300ms for faster response
            await Task.Delay(300, cancellationToken);
            
            // Verify email hasn't changed and cancellation wasn't requested
            if (!cancellationToken.IsCancellationRequested)
            {
                // Double-check that the email value hasn't changed during the delay
                var emailAfterDelay = EmployeeData.Email?.Trim() ?? string.Empty;
                if (emailAfterDelay != currentEmail)
                {
                    // Email changed during delay, don't update flag
                    return;
                }
                
                // Check if email exists in database
                var emailExists = await UserRepository.ExistsByEmailAsync(currentEmail);
                
                // Triple-check email hasn't changed after database call and token source is still active
                var emailAfterCheck = EmployeeData.Email?.Trim() ?? string.Empty;
                if (emailAfterCheck == currentEmail && 
                    !cancellationToken.IsCancellationRequested &&
                    emailCheckCancellationTokenSource == tokenSource) // Verify this is still the active check
                {
                    // Only update flag if email still matches and wasn't cancelled
                    isEmailDuplicate = emailExists;
                    StateHasChanged();
                }
            }
        }
        catch (OperationCanceledException)
        {
            // Expected when user types again before delay completes - do nothing
            // Flag remains false (already set above)
        }
        catch (Exception ex)
        {
            // Log error but don't block user input
            Console.WriteLine($"Error checking email uniqueness: {ex.Message}");
            // Only update flag if email still matches current value and this is still the active check
            var emailAfterError = EmployeeData.Email?.Trim() ?? string.Empty;
            if (emailAfterError == currentEmail && emailCheckCancellationTokenSource == tokenSource)
            {
                isEmailDuplicate = false;
                StateHasChanged();
            }
        }
        finally
        {
            // Only dispose if this is still the active token source (hasn't been replaced)
            if (emailCheckCancellationTokenSource == tokenSource)
            {
                try
                {
                    if (!cancellationToken.IsCancellationRequested)
                    {
                        tokenSource.Dispose();
                    }
                }
                catch
                {
                    // Ignore disposal errors
                }
                finally
                {
                    // Only clear if this is still the active source
                    if (emailCheckCancellationTokenSource == tokenSource)
                    {
                        emailCheckCancellationTokenSource = null;
                    }
                }
            }
        }
    }

    private async Task HandleSubmitClick()
    {
        // Only trigger validation when submit button is clicked
        if (editContext != null)
        {
            // Check for duplicate email before validating form
            if (isEmailDuplicate)
            {
                // Show validation error modal with email duplicate message
                missingFields.Clear();
                missingFields.Add("Email: This email is already registered. Please use a different email address.");
                showValidationModal = true;
                // Force UI update to show red border on email field
                editContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.Email)));
                StateHasChanged();
                return; // Prevent form submission
            }
            
            // Check for duplicate contact number before validating form
            if (isContactDuplicate)
            {
                // Show validation error modal with contact duplicate message
                missingFields.Clear();
                missingFields.Add("Contact Number: This contact number is already registered. Please use a different contact number.");
                showValidationModal = true;
                // Force UI update to show red border on contact field
                editContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.ContactNumber)));
                StateHasChanged();
                return; // Prevent form submission
            }
            
            // Validate the form - this will show validation errors
            var isValid = editContext.Validate();
            
            // Notify all required fields to ensure validation state is updated
            if (!isValid)
            {
                // Explicitly notify dropdown fields to trigger validation display
                editContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.Province)));
                editContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.City)));
                editContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.Barangay)));
            }
            
            // Only proceed if form is valid AND email/contact are not duplicate
            if (isValid && !isEmailDuplicate && !isContactDuplicate)
            {
                // Check for duplicate employee before showing confirmation modal
                // Duplicate check is based on: Full Name + DOB + Address
                await CheckForDuplicateEmployee();
                
                // If duplicate found, the modal will be shown by CheckForDuplicateEmployee
                // If no duplicate, proceed with normal confirmation
                if (!showDuplicateModal)
                {
                    // Show confirmation modal
                    confirmModalTitle = "Confirm Add Employee";
                    confirmModalMessage = "Are all the information correct? Do you want to add this employee?";
                    confirmModalType = "submit";
                    showConfirmModal = true;
                    StateHasChanged();
                }
            }
            else
            {
                // Collect all validation errors
                CollectMissingFields();
                // Show validation error modal
                showValidationModal = true;
                // Force UI update to show validation errors
                StateHasChanged();
            }
        }
    }
    
    // Simplified duplicate check: Only checks First Name + Last Name
    // If First Name + Last Name matches existing record, show modal with all details
    private async Task CheckForDuplicateEmployee()
    {
        try
        {
            // Only pass First Name and Last Name for duplicate check
            // Email and Contact Number have separate real-time duplicate detection
            var employeeData = new EmployeeRegistrationData
            {
                FirstName = EmployeeData.FirstName,
                LastName = EmployeeData.LastName
            };
            
            // Perform duplicate check (only First Name + Last Name)
            duplicateCheckResult = await EmployeeService.CheckForDuplicateEmployeeAsync(employeeData);
            
            // If duplicate found, show warning modal with all details
            if (duplicateCheckResult != null && duplicateCheckResult.IsDuplicate)
            {
                showDuplicateModal = true;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            // Log error but don't block submission
            Console.WriteLine($"Error checking for duplicate employee: {ex.Message}");
            // Continue with normal flow if check fails
        }
    }
    
    // Check contact number uniqueness with debouncing (similar to email)
    private async Task CheckContactUniqueness()
    {
        // Cancel any pending contact check
        if (contactCheckCancellationTokenSource != null)
        {
            contactCheckCancellationTokenSource.Cancel();
            contactCheckCancellationTokenSource.Dispose();
            contactCheckCancellationTokenSource = null;
        }
        
        // Capture current contact value to verify it hasn't changed after async operations
        var currentContact = EmployeeData.ContactNumber?.Trim() ?? string.Empty;
        
        // Reset duplicate flag immediately when contact changes
        isContactDuplicate = false;
        StateHasChanged(); // Update UI immediately to clear any previous error state
        
        // If contact is empty or invalid format, don't check
        if (string.IsNullOrWhiteSpace(currentContact) || currentContact.Length < 10)
        {
            return;
        }
        
        // Create new cancellation token source and store reference
        var tokenSource = new CancellationTokenSource();
        contactCheckCancellationTokenSource = tokenSource;
        var cancellationToken = tokenSource.Token;
        
        try
        {
            // Reduced debounce delay from 500ms to 300ms for faster response
            await Task.Delay(300, cancellationToken);
            
            // Verify contact hasn't changed and cancellation wasn't requested
            if (!cancellationToken.IsCancellationRequested)
            {
                // Double-check that the contact value hasn't changed during the delay
                var contactAfterDelay = EmployeeData.ContactNumber?.Trim() ?? string.Empty;
                if (contactAfterDelay != currentContact)
                {
                    // Contact changed during delay, don't update flag
                    return;
                }
                
                // Check if contact exists in database
                var contactExists = await UserRepository.ExistsByContactNumberAsync(currentContact);
                
                // Triple-check contact hasn't changed after database call and token source is still active
                var contactAfterCheck = EmployeeData.ContactNumber?.Trim() ?? string.Empty;
                if (contactAfterCheck == currentContact && 
                    !cancellationToken.IsCancellationRequested &&
                    contactCheckCancellationTokenSource == tokenSource) // Verify this is still the active check
                {
                    // Only update flag if contact still matches and wasn't cancelled
                    isContactDuplicate = contactExists;
                    StateHasChanged();
                }
            }
        }
        catch (OperationCanceledException)
        {
            // Expected when user types again before delay completes - do nothing
            // Flag remains false (already set above)
        }
        catch (Exception ex)
        {
            // Log error but don't block user input
            Console.WriteLine($"Error checking contact uniqueness: {ex.Message}");
            // Only update flag if contact still matches current value and this is still the active check
            var contactAfterError = EmployeeData.ContactNumber?.Trim() ?? string.Empty;
            if (contactAfterError == currentContact && contactCheckCancellationTokenSource == tokenSource)
            {
                isContactDuplicate = false;
                StateHasChanged();
            }
        }
        finally
        {
            // Only dispose if this is still the active token source
            if (contactCheckCancellationTokenSource == tokenSource)
            {
                try
                {
                    if (!cancellationToken.IsCancellationRequested)
                    {
                        tokenSource.Dispose();
                    }
                }
                catch
                {
                    // Ignore disposal errors
                }
                finally
                {
                    // Only clear if this is still the active source
                    if (contactCheckCancellationTokenSource == tokenSource)
                    {
                        contactCheckCancellationTokenSource = null;
                    }
                }
            }
        }
    }

    private void CollectMissingFields()
    {
        missingFields.Clear();
        
        if (editContext == null) return;
        
        // Get all fields with validation errors
        var modelType = editContext.Model.GetType();
        var properties = modelType.GetProperties();
        
        foreach (var property in properties)
        {
            var fieldIdentifier = new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, property.Name);
            var validationMessages = editContext.GetValidationMessages(fieldIdentifier);
            
            if (validationMessages.Any())
            {
                // Get user-friendly field name
                var fieldName = GetFieldDisplayName(property.Name);
                if (!string.IsNullOrWhiteSpace(fieldName) && !missingFields.Contains(fieldName))
                {
                    missingFields.Add(fieldName);
                }
            }
        }
    }

    private string GetFieldDisplayName(string fieldName)
    {
        // Map field names to user-friendly display names
        var fieldNameMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        {
            { "FirstName", "First Name" },
            { "LastName", "Last Name" },
            { "BirthDate", "Birth Date" },
            { "Age", "Age" },
            { "Sex", "Sex" },
            { "ContactNumber", "Contact Number" },
            { "Email", "Email" },
            { "Barangay", "Barangay" },
            { "City", "City" },
            { "Province", "Province" },
            { "EmergencyContactFirstName", "Emergency Contact - First Name" },
            { "EmergencyContactLastName", "Emergency Contact - Last Name" },
            { "EmergencyContactRelationship", "Emergency Contact - Relationship" },
            { "EmergencyContactNumber", "Emergency Contact - Contact Number" },
            { "Role", "Role" },
            { "BaseSalary", "Base Salary" }
        };
        
        return fieldNameMap.TryGetValue(fieldName, out var displayName) ? displayName : fieldName;
    }

    private void CloseValidationModal()
    {
        showValidationModal = false;
        missingFields.Clear();
        StateHasChanged();
    }

    private void Cancel()
    {
        // Show confirmation modal
        confirmModalTitle = "Cancel Add Employee";
        confirmModalMessage = "Are you sure you want to cancel? All entered data will be cleared.";
        confirmModalType = "cancel";
        showConfirmModal = true;
        StateHasChanged();
    }

    private bool HasData()
    {
        return !string.IsNullOrWhiteSpace(EmployeeData.FirstName) ||
               !string.IsNullOrWhiteSpace(EmployeeData.LastName) ||
               !string.IsNullOrWhiteSpace(EmployeeData.Email) ||
               !string.IsNullOrWhiteSpace(EmployeeData.ContactNumber) ||
               !string.IsNullOrWhiteSpace(EmployeeData.HouseNo) ||
               !string.IsNullOrWhiteSpace(EmployeeData.StreetName) ||
               EmployeeData.BirthDate.HasValue ||
               !string.IsNullOrWhiteSpace(EmployeeData.Province) ||
               !string.IsNullOrWhiteSpace(EmployeeData.City) ||
               !string.IsNullOrWhiteSpace(EmployeeData.Barangay);
    }

    private async Task HandleBackdropClick()
    {
        // If nested modals are open, don't close on backdrop click
        if (showConfirmModal || showValidationModal || showDuplicateModal)
        {
            return;
        }

        // If no data entered, allow closing
        if (!HasData())
        {
            NavigationManager.NavigateTo("/human-resource");
        }
        else
        {
            // If data exists, play sound and shake modal
            try
            {
                await JSRuntime.InvokeVoidAsync("handleModalBackdropClick", "add-employee-modal");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error calling handleModalBackdropClick: {ex.Message}");
            }
        }
    }

    private void CloseConfirmModal()
    {
        showConfirmModal = false;
        confirmModalTitle = "";
        confirmModalMessage = "";
        confirmModalType = "";
        pendingNavigationUrl = null;
        StateHasChanged();
    }
    
    // Close duplicate warning modal
    private void CloseDuplicateModal()
    {
        showDuplicateModal = false;
        duplicateCheckResult = null;
        StateHasChanged();
    }
    
    // Handle update existing employee (update contact/email only)
    private async Task UpdateExistingEmployee()
    {
        if (duplicateCheckResult == null || !duplicateCheckResult.ExistingEmployeeId.HasValue)
        {
            CloseDuplicateModal();
            return;
        }
        
        isSubmitting = true;
        StateHasChanged();
        
        try
        {
            // Update existing employee's contact and email
            var success = await EmployeeService.UpdateEmployeeContactInfoAsync(
                duplicateCheckResult.ExistingEmployeeId.Value,
                EmployeeData.ContactNumber,
                EmployeeData.Email
            );
            
            if (success)
            {
                // Success - navigate to human resource page
                NavigationManager.NavigateTo("/human-resource?toast=employee_updated");
            }
            else
            {
                // Show error
                toastMessage = "Failed to update employee contact information.";
                toastType = ToastType.Error;
                showToast = true;
                isSubmitting = false;
                CloseDuplicateModal();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            // Handle error
            Console.WriteLine($"Error updating employee: {ex.Message}");
            toastMessage = ErrorMessageHelper.ToHumanReadable($"Failed to update employee: {ex.Message}");
            toastType = ToastType.Error;
            showToast = true;
            isSubmitting = false;
            CloseDuplicateModal();
            StateHasChanged();
        }
    }
    
    // Handle proceed with new employee (user confirms it's a different person)
    private async Task ProceedWithNewEmployee()
    {
        // Close duplicate modal
        CloseDuplicateModal();
        
        // The duplicate modal itself serves as the confirmation
        // Directly submit the employee without showing another confirmation modal
        await SubmitEmployee();
    }

    private async Task ConfirmAction()
    {
        showConfirmModal = false;
        StateHasChanged();
        
        if (confirmModalType == "submit")
        {
            await SubmitEmployee();
        }
        else if (confirmModalType == "cancel")
        {
            // Navigate without toast notification for cancel
            isNavigatingAway = true;
            NavigationManager.NavigateTo("/human-resource");
        }
        else if (confirmModalType == "navigate")
        {
            // Confirm navigation away from page - always redirect to HR page
            isNavigatingAway = true;
            NavigationManager.NavigateTo("/human-resource");
            pendingNavigationUrl = null;
        }
        
        confirmModalTitle = "";
        confirmModalMessage = "";
        confirmModalType = "";
    }

    private async Task SubmitEmployee()
    {
        isSubmitting = true;
        StateHasChanged(); // Update UI to show loading state
        
        try
        {
            // Final check: Verify email is still unique before submission (prevents race conditions)
            if (!string.IsNullOrWhiteSpace(EmployeeData.Email))
            {
                var emailExists = await UserRepository.ExistsByEmailAsync(EmployeeData.Email);
                if (emailExists)
                {
                    isSubmitting = false;
                    isEmailDuplicate = true;
                    missingFields.Clear();
                    missingFields.Add("Email: This email is already registered. Please use a different email address.");
                    showValidationModal = true;
                    StateHasChanged();
                    return;
                }
            }
            
            // Final check: Verify contact number is still unique before submission (prevents race conditions)
            if (!string.IsNullOrWhiteSpace(EmployeeData.ContactNumber))
            {
                var contactExists = await UserRepository.ExistsByContactNumberAsync(EmployeeData.ContactNumber);
                if (contactExists)
                {
                    isSubmitting = false;
                    isContactDuplicate = true;
                    missingFields.Clear();
                    missingFields.Add("Contact Number: This contact number is already registered. Please use a different contact number.");
                    showValidationModal = true;
                    StateHasChanged();
                    return;
                }
            }
            
            // Map EmployeeFormData to EmployeeRegistrationData (DTO)
            var employeeData = new EmployeeRegistrationData
            {
                // Personal Information
                FirstName = EmployeeData.FirstName,
                MiddleName = EmployeeData.MiddleName,
                LastName = EmployeeData.LastName,
                Suffix = EmployeeData.Suffix,
                BirthDate = EmployeeData.BirthDate,
                Age = EmployeeData.Age,
                Sex = EmployeeData.Sex,
                ContactNumber = EmployeeData.ContactNumber,
                Email = EmployeeData.Email,
                Role = EmployeeData.Role,
                SystemId = EmployeeData.SystemId,
                DefaultPassword = EmployeeData.DefaultPassword,

                // Address Information
                HouseNo = EmployeeData.HouseNo,
                StreetName = EmployeeData.StreetName,
                Province = EmployeeData.Province,
                City = EmployeeData.City,
                Barangay = EmployeeData.Barangay,
                Country = EmployeeData.Country,
                ZipCode = EmployeeData.ZipCode,

                // Emergency Contact Information
                EmergencyContactFirstName = EmployeeData.EmergencyContactFirstName,
                EmergencyContactMiddleName = EmployeeData.EmergencyContactMiddleName,
                EmergencyContactLastName = EmployeeData.EmergencyContactLastName,
                EmergencyContactSuffix = EmployeeData.EmergencyContactSuffix,
                EmergencyContactRelationship = EmployeeData.EmergencyContactRelationship == "Other" 
                    ? EmployeeData.EmergencyContactRelationshipOther 
                    : EmployeeData.EmergencyContactRelationship,
                EmergencyContactNumber = EmployeeData.EmergencyContactNumber,
                EmergencyContactAddress = EmployeeData.EmergencyContactAddress,

                // Salary Information
                BaseSalary = EmployeeData.BaseSalary,
                Allowance = EmployeeData.Allowance
            };

            // Register employee using EmployeeService
            var userId = await EmployeeService.RegisterEmployeeAsync(employeeData);
            
            // Success - navigate to human resource page, toast will show on destination page
            NavigationManager.NavigateTo("/human-resource?toast=employee_added");
        }
        catch (Exception ex)
        {
            // Handle error - show error message to user
            Console.WriteLine($"Error adding employee: {ex.Message}");
            // For errors, show toast on current page since we're not navigating
            toastMessage = ErrorMessageHelper.ToHumanReadable($"Failed to add employee: {ex.Message}");
            toastType = ToastType.Error;
            showToast = true;
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void CloseToast()
    {
        showToast = false;
        toastMessage = "";
        StateHasChanged();
    }

    private void GoBack()
    {
        // Check if form has data before navigating
        if (HasData())
        {
            // Show confirmation modal
            pendingNavigationUrl = "/human-resource";
            ShowNavigationConfirmModal();
        }
        else
        {
            // No data, navigate directly
            NavigationManager.NavigateTo("/human-resource");
        }
    }

    // Explicit method for email input CSS class - ensures no green when duplicate is detected
    private string GetEmailInputClassExplicit()
    {
        var baseClass = "w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base";
        
        // PRIORITY 1: If duplicate email is detected, return ONLY red border classes - NO green classes at all
        // This check must happen FIRST before any other validation checks to prevent green border
        if (isEmailDuplicate && !string.IsNullOrWhiteSpace(EmployeeData.Email))
        {
            // Explicitly return only red classes - NO green classes included
            // This ensures Tailwind won't apply any green border styling
            return $"{baseClass} border-red-500 focus:border-red-500";
        }
        
        if (editContext == null) 
            return $"{baseClass} border-gray-300 focus:border-blue-500";

        var fieldIdentifier = new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.Email));
        var hasError = editContext.GetValidationMessages(fieldIdentifier).Any();
        var isModified = editContext.IsModified(fieldIdentifier);
        
        // PRIORITY 2: Check for standard validation errors - show red border
        if (hasError)
        {
            return $"{baseClass} border-red-500 focus:border-red-500";
        }
        
        // PRIORITY 3: Show green border ONLY if ALL conditions are met:
        // 1. Field is modified
        // 2. No validation errors
        // 3. Email is NOT duplicate (critical check - prevents green when duplicate detected)
        // 4. Email is not empty (additional safety check)
        // All conditions must be true - if ANY condition fails, no green border
        if (isModified && !hasError && !isEmailDuplicate && !string.IsNullOrWhiteSpace(EmployeeData.Email))
        {
            return $"{baseClass} border-green-500 focus:border-green-500";
        }
        
        return $"{baseClass} border-gray-300 focus:border-blue-500";
    }

    // Returns inline style to force red border when duplicate email is detected
    private string GetEmailInputStyle()
    {
        // Force red border with !important to override any Tailwind classes (including green)
        // This must override both normal and focus states
        if (isEmailDuplicate && !string.IsNullOrWhiteSpace(EmployeeData.Email))
        {
            // Use comprehensive inline styles to override all possible border colors
            // Target both normal state and :focus pseudo-class to ensure red border always shows
            // Use box-shadow as a backup since it has higher specificity than border-color in some cases
            return "border-color: #ef4444 !important; border-width: 1px !important; box-shadow: 0 0 0 1px #ef4444 !important; outline: none !important;";
        }
        // When not duplicate, return empty to allow normal Tailwind classes
        return "";
    }
    
    // Returns CSS class for contact number input - ensures no green when duplicate is detected
    private string GetContactInputClassExplicit()
    {
        var baseClass = "w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base";
        
        // PRIORITY 1: If duplicate contact is detected, return ONLY red border classes - NO green classes at all
        if (isContactDuplicate && !string.IsNullOrWhiteSpace(EmployeeData.ContactNumber))
        {
            return $"{baseClass} border-red-500 focus:border-red-500";
        }
        
        if (editContext == null) 
            return $"{baseClass} border-gray-300 focus:border-blue-500";

        var fieldIdentifier = new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, nameof(EmployeeData.ContactNumber));
        var hasError = editContext.GetValidationMessages(fieldIdentifier).Any();
        var isModified = editContext.IsModified(fieldIdentifier);
        
        // PRIORITY 2: Check for standard validation errors - show red border
        if (hasError)
        {
            return $"{baseClass} border-red-500 focus:border-red-500";
        }
        
        // PRIORITY 3: Show green border ONLY if ALL conditions are met
        if (isModified && !hasError && !isContactDuplicate && !string.IsNullOrWhiteSpace(EmployeeData.ContactNumber))
        {
            return $"{baseClass} border-green-500 focus:border-green-500";
        }
        
        return $"{baseClass} border-gray-300 focus:border-blue-500";
    }
    
    // Returns inline style to force red border when duplicate contact is detected
    private string GetContactInputStyle()
    {
        // Force red border with !important to override any Tailwind classes (including green)
        if (isContactDuplicate && !string.IsNullOrWhiteSpace(EmployeeData.ContactNumber))
        {
            return "border-color: #ef4444 !important; border-width: 1px !important; box-shadow: 0 0 0 1px #ef4444 !important; outline: none !important;";
        }
        return "";
    }

    // Returns CSS class for input fields based on validation
    private string GetInputClass(string fieldName)
    {
        if (editContext == null) 
            return "w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base";

        var fieldIdentifier = new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, fieldName);
        var hasError = editContext.GetValidationMessages(fieldIdentifier).Any();
        var isModified = editContext.IsModified(fieldIdentifier);
        
        var baseClass = "w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base";
        
        if (hasError)
        {
            return $"{baseClass} border-red-500 focus:border-red-500";
        }
        
        // Show green border for valid fields that have been modified
        if (isModified && !hasError)
        {
            return $"{baseClass} border-green-500 focus:border-green-500";
        }
        
        return $"{baseClass} border-gray-300 focus:border-blue-500";
    }

    // Returns CSS class for dropdown fields based on validation
    private string GetDropdownClass(string fieldName)
    {
        var baseClass = "flex w-full cursor-pointer items-center justify-between rounded-lg border bg-white px-3 py-2 text-sm focus-within:outline-none focus-within:ring-0 sm:px-4 sm:py-2.5 sm:text-base";
        
        if (editContext == null) 
            return $"{baseClass} border-gray-300 focus-within:border-blue-500";

        var fieldIdentifier = new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(editContext.Model, fieldName);
        var validationMessages = editContext.GetValidationMessages(fieldIdentifier);
        var hasError = validationMessages.Any();
        var isModified = editContext.IsModified(fieldIdentifier);
        
        // Explicitly check for validation errors
        if (hasError)
        {
            return $"{baseClass} border-red-500 focus-within:border-red-500";
        }
        
        // Show green border for valid fields that have been modified
        if (isModified && !hasError)
        {
            return $"{baseClass} border-green-500 focus-within:border-green-500";
        }
        
        return $"{baseClass} border-gray-300 focus-within:border-blue-500";
    }

    // Returns CSS class for input fields with extra classes
    private string GetInputClassWithExtra(string fieldName, string extraClasses = "")
    {
        var baseClass = GetInputClass(fieldName);
        if (!string.IsNullOrWhiteSpace(extraClasses))
        {
            return $"{baseClass} {extraClasses}";
        }
        return baseClass;
    }

}
