@page "/human-resource/employee-profile/{UserId:int}"
@layout Components.Layout.MainLayout
@inject NavigationManager NavigationManager
@inject BrightEnroll_DES.Services.Business.HR.EmployeeService EmployeeService
@using BrightEnroll_DES.Components.Pages.Admin.HumanResource.HRComponents
@using BrightEnroll_DES.Components.Pages.Admin.HumanResource.HRCS
@using BrightEnroll_DES.Data.Models
@using BrightEnroll_DES.Services

<PageTitle>Employee Profile</PageTitle>

<div class="text-gray-800">
    <h1 class="mb-6 text-2xl font-bold text-gray-800">Employee Profile</h1>
    @if (isLoading)
    {
        <div class="flex items-center justify-center py-12">
            <div class="flex flex-col items-center justify-center">
                <svg class="animate-spin h-8 w-8 text-gray-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Loading employee profile...</span>
            </div>
        </div>
    }
    else if (employeeData == null)
    {
        <div class="rounded-xl bg-white shadow p-6">
            <p class="text-center text-gray-500">Employee not found.</p>
            <button @onclick="GoBack" class="mt-4 flex items-center gap-2 rounded-lg bg-gray-600 px-4 py-2 text-sm font-medium text-white shadow-md transition-all duration-300 hover:bg-gray-700 hover:shadow-lg">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back
            </button>
        </div>
    }
    else
    {
        <EmployeeDetail EmployeeData="employeeData" InactiveReason="inactiveReason" OnBackClick="GoBack" OnDataUpdated="RefreshEmployeeData" />
    }
</div>

@code {
    [Parameter]
    public int UserId { get; set; }

    private EmployeeDataView? employeeData;
    private bool isLoading = true;
    private string? inactiveReason;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            employeeData = await EmployeeService.GetEmployeeDataViewByIdAsync(UserId);
            
            // Get inactive reason if employee is inactive
            if (employeeData != null && employeeData.Status?.Equals("Inactive", StringComparison.OrdinalIgnoreCase) == true)
            {
                inactiveReason = await EmployeeService.GetInactiveReasonAsync(UserId);
                Console.WriteLine($"Loaded inactive reason for user {UserId}: {inactiveReason ?? "null"}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading employee: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GoBack()
    {
        // Ensure any pending operations complete before navigating
        // This prevents DbContext concurrency issues when navigating back
        await Task.Delay(50);
        NavigationManager.NavigateTo("/human-resource", forceLoad: true);
    }

    private async Task RefreshEmployeeData()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            employeeData = await EmployeeService.GetEmployeeDataViewByIdAsync(UserId);
            
            // Get inactive reason if employee is inactive
            if (employeeData != null && employeeData.Status?.Equals("Inactive", StringComparison.OrdinalIgnoreCase) == true)
            {
                inactiveReason = await EmployeeService.GetInactiveReasonAsync(UserId);
                Console.WriteLine($"Refreshed inactive reason for user {UserId}: {inactiveReason ?? "null"}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing employee data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}

