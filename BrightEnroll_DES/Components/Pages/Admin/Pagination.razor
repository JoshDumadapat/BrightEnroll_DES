@namespace BrightEnroll_DES.Components.Pages.Admin

<!-- Pagination Footer -->
<div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between border-t border-gray-200 bg-gray-50 px-4 py-3 text-xs sm:text-sm text-gray-600">
    <span class="text-center sm:text-left">@GetDisplayText()</span>
    <div class="flex items-center justify-center sm:justify-end gap-2 flex-wrap">
        @if (TotalPages > 0)
        {
            <!-- Previous Button -->
            @if (CurrentPage > 1)
            {
                <button @onclick="() => GoToPage(CurrentPage - 1)" 
                        class="rounded-md px-3 py-1.5 text-xs text-gray-600 hover:bg-gray-200 transition-colors duration-150">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
            }

            <!-- Page Numbers -->
            @foreach (var pageNum in GetPageNumbers())
            {
                @if (pageNum == -1)
                {
                    <span class="px-1">...</span>
                }
                else
                {
                    <button @onclick="() => GoToPage(pageNum)" 
                            class="rounded-md px-3 py-1.5 text-xs transition-colors duration-150 @(pageNum == CurrentPage ? "text-white" : "text-gray-600 hover:bg-gray-200")"
                            style="@(pageNum == CurrentPage ? "background-color: #0E335D;" : "")">
                        @pageNum
                    </button>
                }
            }

            <!-- Next Button -->
            @if (CurrentPage < TotalPages)
            {
                <button @onclick="() => GoToPage(CurrentPage + 1)" 
                        class="rounded-md px-3 py-1.5 text-xs text-gray-600 hover:bg-gray-200 transition-colors duration-150">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            }
        }

        <span class="ml-2 sm:ml-4 whitespace-nowrap">Show</span>
        <select @bind="RowsPerPage" @bind:after="HandleRowsPerPageChanged" 
                class="rounded-lg border border-gray-300 bg-white px-2 py-1.5 text-xs text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400">
            @if (RowsPerPageOptions != null)
            {
                @foreach (var option in RowsPerPageOptions)
                {
                    <option value="@option">@option rows</option>
                }
            }
        </select>
    </div>
</div>

@code {
    [Parameter]
    public int TotalItems { get; set; } = 0;

    [Parameter]
    public int CurrentPage { get; set; } = 1;

    [Parameter]
    public int RowsPerPage { get; set; } = 5;

    [Parameter]
    public EventCallback<int> OnPageChanged { get; set; }

    [Parameter]
    public EventCallback<int> OnRowsPerPageChanged { get; set; }

    [Parameter]
    public string ItemName { get; set; } = "items";

    [Parameter]
    public List<int>? RowsPerPageOptions { get; set; }

    private int TotalPages => (int)Math.Ceiling((double)TotalItems / RowsPerPage);

    protected override void OnInitialized()
    {
        if (RowsPerPageOptions == null || !RowsPerPageOptions.Any())
        {
            RowsPerPageOptions = new List<int> { 5, 10, 20, 50 };
        }
        
        // Ensure RowsPerPage is in the options list
        if (!RowsPerPageOptions.Contains(RowsPerPage))
        {
            RowsPerPageOptions.Add(RowsPerPage);
            RowsPerPageOptions = RowsPerPageOptions.OrderBy(x => x).ToList();
        }
    }

    protected override void OnParametersSet()
    {
        // Ensure CurrentPage is within valid range
        if (CurrentPage < 1)
            CurrentPage = 1;
        if (TotalPages > 0 && CurrentPage > TotalPages)
            CurrentPage = TotalPages;
    }

    private void GoToPage(int page)
    {
        if (page >= 1 && page <= TotalPages && page != CurrentPage)
        {
            CurrentPage = page;
            OnPageChanged.InvokeAsync(CurrentPage);
        }
    }

    private async Task HandleRowsPerPageChanged()
    {
        // Reset to page 1 when rows per page changes
        CurrentPage = 1;
        await OnRowsPerPageChanged.InvokeAsync(RowsPerPage);
        await OnPageChanged.InvokeAsync(CurrentPage);
    }

    private List<int> GetPageNumbers()
    {
        var pages = new List<int>();
        
        if (TotalPages <= 0)
            return pages;

        const int maxVisiblePages = 7; // Show up to 7 page numbers
        
        if (TotalPages <= maxVisiblePages)
        {
            // Show all pages if total pages is less than max visible
            for (int i = 1; i <= TotalPages; i++)
            {
                pages.Add(i);
            }
        }
        else
        {
            // Always show first page
            pages.Add(1);

            int startPage = Math.Max(2, CurrentPage - 1);
            int endPage = Math.Min(TotalPages - 1, CurrentPage + 1);

            // Add ellipsis if needed before current range
            if (startPage > 2)
            {
                pages.Add(-1); // -1 represents ellipsis
            }

            // Add pages around current page
            for (int i = startPage; i <= endPage; i++)
            {
                if (i != 1 && i != TotalPages)
                {
                    pages.Add(i);
                }
            }

            // Add ellipsis if needed after current range
            if (endPage < TotalPages - 1)
            {
                pages.Add(-1); // -1 represents ellipsis
            }

            // Always show last page
            pages.Add(TotalPages);
        }

        return pages;
    }

    private string GetDisplayText()
    {
        if (TotalItems == 0)
            return $"0 {ItemName}";

        int startItem = (CurrentPage - 1) * RowsPerPage + 1;
        int endItem = Math.Min(CurrentPage * RowsPerPage, TotalItems);

        return $"{startItem}-{endItem} of {TotalItems} {ItemName}";
    }
}

