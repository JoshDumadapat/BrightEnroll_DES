@namespace BrightEnroll_DES.Components.Pages.Admin.Curriculum.CurriculumComponents
@using BrightEnroll_DES.Components.Pages.Admin.Curriculum.CurriculumComponents
@using BrightEnroll_DES.Components.Pages.Admin.Curriculum.CurriculumCS
@using BrightEnroll_DES.Services
@using DataModels = BrightEnroll_DES.Data.Models
@using System.Linq
@inject CurriculumService CurriculumService
@inject IJSRuntime JSRuntime

@if (Show)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @onclick="HandleBackdropClick">
        <div id="edit-assignment-modal" class="w-full max-w-5xl rounded-2xl bg-white shadow-xl max-h-[90vh] overflow-hidden flex flex-col" @onclick:stopPropagation="true">
            <!-- Modal Header -->
            <div class="flex items-center justify-center rounded-t-2xl bg-yellow-500 px-6 py-3 flex-shrink-0">
                <h3 class="text-lg font-semibold text-white">Edit Assigned Teacher</h3>
            </div>

            <!-- Modal Body -->
            <div class="px-6 py-4 rounded-b-2xl overflow-y-auto flex-1">
                <form @onsubmit="HandleSubmit" @onsubmit:preventDefault="true">
                    <!-- Grade Level, Section, Classroom, Adviser -->
                    <div class="mb-6 grid grid-cols-4 gap-4">
                        <!-- Grade Level -->
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-700">
                                Grade Level <span class="text-red-500">*</span>
                            </label>
                            <select @bind="SelectedGradeLevel" @bind:after="@(() => OnGradeLevelChanged())"
                                    class="w-full rounded-lg border-2 border-gray-200 bg-white px-4 py-2.5 text-sm font-medium text-gray-800 transition-all duration-200 outline-none hover:border-yellow-300 focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500/20"
                                    required>
                                <option value="">Select Grade Level</option>
                                @foreach (var gradeLevel in GradeLevels)
                                {
                                    <option value="@gradeLevel.GradeLevelName">@gradeLevel.GradeLevelName</option>
                                }
                            </select>
                        </div>

                        <!-- Section -->
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-700">
                                Section <span class="text-red-500">*</span>
                            </label>
                            <select @bind="SelectedSection" @bind:after="@(() => OnSectionChanged())"
                                    class="w-full rounded-lg border-2 border-gray-200 bg-white px-4 py-2.5 text-sm font-medium text-gray-800 transition-all duration-200 outline-none hover:border-yellow-300 focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500/20"
                                    disabled="@string.IsNullOrEmpty(SelectedGradeLevel)"
                                    required>
                                <option value="">Select Section</option>
                                @foreach (var sec in FilteredSections)
                                {
                                    <option value="@sec.SectionName">@sec.SectionName</option>
                                }
                            </select>
                        </div>

                        <!-- Classroom (read-only) -->
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-700">Classroom</label>
                            <input type="text" value="@SelectedClassroom"
                                   class="w-full rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-700 outline-none"
                                   readonly />
                        </div>

                        <!-- Adviser (read-only) -->
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-700">Adviser</label>
                            <input type="text" value="@AdviserTeacherName"
                                   class="w-full rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-700 outline-none"
                                   readonly />
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(SelectedSection) && !string.IsNullOrEmpty(SelectedGradeLevel))
                    {
                        <!-- Add Assignment Button -->
                        <div class="mb-4 flex justify-end">
                            <button type="button" @onclick="StartAddingAssignment"
                                    class="rounded-lg bg-yellow-500 px-4 py-2 text-sm font-medium text-white hover:bg-yellow-600">
                                + Add Assignment
                            </button>
                        </div>

                        <!-- Inline Editor (for Add/Edit) -->
                        @if (IsAddingRow || IsEditingRow)
                        {
                            <div class="mb-6 rounded-lg border border-gray-200 bg-gray-50 p-4">
                                <h4 class="mb-4 text-sm font-semibold text-gray-700">@(IsEditingRow ? "Edit Assignment" : "Add Assignment")</h4>
                                <div class="grid grid-cols-1 gap-4 md:grid-cols-4 lg:grid-cols-6">
                                    <!-- Subject -->
                                    <div class="md:col-span-2">
                                        <label class="mb-1.5 block text-xs font-semibold text-gray-700">
                                            Subject <span class="text-red-500">*</span>
                                        </label>
                                        <select @bind="WorkingRow.SubjectId"
                                                class="w-full rounded-lg border-2 border-gray-200 bg-white px-3 py-2 text-sm text-gray-800 outline-none hover:border-yellow-300 focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500/20">
                                            <option value="0">Select Subject</option>
                                            @foreach (var subject in AvailableSubjects)
                                            {
                                                <option value="@subject.SubjectId">@subject.SubjectName</option>
                                            }
                                        </select>
                                    </div>

                                    <!-- Start Time -->
                                    <div class="relative md:col-span-1">
                                        <label class="mb-1.5 block text-xs font-semibold text-gray-700">
                                            Start Time <span class="text-red-500">*</span>
                                        </label>
                                        <TimePicker @bind-TimeValue="WorkingRow.StartTime"
                                                    OnTimeChanged="OnWorkingRowChanged" />
                                    </div>

                                    <!-- End Time -->
                                    <div class="relative md:col-span-1">
                                        <label class="mb-1.5 block text-xs font-semibold text-gray-700">
                                            End Time <span class="text-red-500">*</span>
                                        </label>
                                        <TimePicker @bind-TimeValue="WorkingRow.EndTime"
                                                    OnTimeChanged="OnWorkingRowChanged" />
                                    </div>

                                    <!-- Days -->
                                    <div class="md:col-span-2">
                                        <label class="mb-1.5 block text-xs font-semibold text-gray-700">
                                            Days <span class="text-red-500">*</span>
                                        </label>
                                        <div class="flex flex-wrap gap-2">
                                            @foreach (var day in DaysOfWeek)
                                            {
                                                <label class="group relative flex cursor-pointer items-center">
                                                    <input type="checkbox"
                                                           checked="@WorkingRow.Days.Contains(day)"
                                                           @onchange="(_ => ToggleDay(day))"
                                                           class="peer sr-only" />
                                                    <div class="flex items-center rounded-lg border-2 border-gray-200 bg-white px-3 py-1.5 text-xs font-semibold text-gray-600 transition-all duration-200 peer-checked:border-yellow-500 peer-checked:bg-yellow-50 peer-checked:text-yellow-700 hover:border-yellow-300 hover:bg-gray-50">
                                                        <span>@day</span>
                                                    </div>
                                                </label>
                                            }
                                        </div>
                                    </div>

                                    <!-- Teacher -->
                                    <div class="md:col-span-2">
                                        <label class="mb-1.5 block text-xs font-semibold text-gray-700">
                                            Teacher <span class="text-red-500">*</span>
                                        </label>
                                        <select @bind="WorkingRow.TeacherId"
                                                class="w-full rounded-lg border-2 border-gray-200 bg-white px-3 py-2 text-sm text-gray-800 outline-none hover:border-yellow-300 focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500/20">
                                            <option value="0">Select Teacher</option>
                                            @foreach (var teacher in Teachers)
                                            {
                                                <option value="@teacher.UserId">@($"{teacher.FirstName} {teacher.LastName}")</option>
                                            }
                                        </select>
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(RowErrorMessage))
                                {
                                    <div class="mt-3 rounded-lg bg-red-50 border border-red-200 px-4 py-2 text-xs text-red-600">
                                        @RowErrorMessage
                                    </div>
                                }

                                <div class="mt-4 flex justify-end gap-2">
                                    <button type="button" @onclick="CancelEditing"
                                            class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                                        Cancel
                                    </button>
                                    <button type="button" @onclick="SaveWorkingRow"
                                            disabled="@(!CanSaveWorkingRow)"
                                            class="rounded-lg bg-yellow-500 px-4 py-2 text-sm font-medium text-white hover:bg-yellow-600 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                        @(IsEditingRow ? "Update" : "Add to List")
                                    </button>
                                </div>
                            </div>
                        }

                        <!-- Assignments Table -->
                        @if (AssignmentRows.Any())
                        {
                            <div class="mb-6">
                                <h4 class="mb-3 text-sm font-semibold text-gray-700">Assign Teachers to Subjects</h4>
                                <div class="overflow-x-auto rounded-lg border border-gray-200 bg-white">
                                    <table class="min-w-full text-sm">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-3 py-2.5 text-left text-xs font-medium text-gray-600">Subject</th>
                                                <th class="px-3 py-2.5 text-left text-xs font-medium text-gray-600">Schedule</th>
                                                <th class="px-3 py-2.5 text-left text-xs font-medium text-gray-600">Teacher</th>
                                                <th class="px-3 py-2.5 text-center text-xs font-medium text-gray-600">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-100">
                                            @for (int i = 0; i < AssignmentRows.Count; i++)
                                            {
                                                var rowIndex = i;
                                                var row = AssignmentRows[rowIndex];
                                                <tr class="hover:bg-gray-50 transition-colors">
                                                    <td class="px-3 py-2.5 font-medium text-gray-800">@row.SubjectName</td>
                                                    <td class="px-3 py-2.5">
                                                        <div class="text-xs text-gray-600">
                                                            @string.Join(", ", row.Days): @FormatTime(row.StartTimeSpan) - @FormatTime(row.EndTimeSpan)
                                                        </div>
                                                    </td>
                                                    <td class="px-3 py-2.5 text-gray-800">@row.TeacherName</td>
                                                    <td class="px-3 py-2.5 text-center">
                                                        <div class="flex items-center justify-center gap-2">
                                                            <button type="button"
                                                                    @onclick="@(() => StartEditingAssignment(rowIndex))"
                                                                    class="inline-flex items-center justify-center rounded-md bg-blue-50 px-2.5 py-1 text-xs font-medium text-blue-600 hover:bg-blue-100">
                                                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                </svg>
                                                            </button>
                                                            <button type="button"
                                                                    @onclick="@(() => RemoveAssignmentRow(rowIndex))"
                                                                    class="inline-flex items-center justify-center rounded-md bg-red-50 px-2.5 py-1 text-xs font-medium text-red-600 hover:bg-red-100">
                                                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                                          d="M9 3h6m-7 4h8l-1 11a2 2 0 01-2 2H9a2 2 0 01-2-2L6 7h12M10 11v6m4-6v6" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="mb-6 rounded-lg border border-gray-200 bg-gray-50 p-8 text-center">
                                <p class="text-sm text-gray-500">No assignments yet. Click "Add Assignment" to add subjects.</p>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="mb-6 rounded-lg border border-gray-200 bg-gray-50 p-8 text-center">
                            <p class="text-sm text-gray-500">Please select a section to start assigning teachers.</p>
                        </div>
                    }

                    <div class="mt-6 flex justify-end gap-3 flex-shrink-0">
                        <button type="button" @onclick="ShowCancelConfirm" class="rounded-lg border border-gray-300 bg-transparent px-6 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="button" @onclick="ShowSubmitConfirm" disabled="@(!CanSubmit)"
                                class="rounded-lg bg-yellow-500 px-6 py-2 text-sm font-medium text-white hover:bg-yellow-600 disabled:bg-gray-300 disabled:cursor-not-allowed">
                            Update Class
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- Confirmation Modal for Submit -->
@if (showSubmitConfirmModal)
{
    <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-50" @onclick="CloseSubmitConfirmModal">
        <div id="edit-assignment-submit-modal" class="w-full max-w-md rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <div class="flex items-center justify-between rounded-t-2xl bg-white px-6 py-2.5 border-b border-gray-200">
                <h3 class="text-base font-semibold text-yellow-600">Confirm Update Class</h3>
                <button @onclick="CloseSubmitConfirmModal" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="px-6 py-4">
                <p class="text-sm text-gray-700">Are you sure you want to update the class for <strong>@SelectedSection</strong>?</p>
                <p class="text-xs text-gray-600 mt-2">This will update <strong>@AdviserTeacherName</strong> as the homeroom teacher (adviser) and update assignments for all @AssignmentRows.Count subject(s) with their assigned teachers and schedules.</p>
            </div>
            <div class="flex justify-end gap-2 border-t border-gray-200 px-6 py-3">
                <button @onclick="CloseSubmitConfirmModal" class="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button @onclick="ConfirmSubmit" class="rounded-lg bg-yellow-500 px-3 py-1.5 text-sm font-medium text-white hover:bg-yellow-600">
                    Confirm
                </button>
            </div>
        </div>
    </div>
}

<!-- Confirmation Modal for Cancel -->
@if (showCancelConfirmModal)
{
    <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-50" @onclick="CloseCancelConfirmModal">
        <div id="edit-assignment-cancel-modal" class="w-full max-w-md rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <div class="flex items-center justify-between rounded-t-2xl bg-white px-6 py-2.5 border-b border-gray-200">
                <h3 class="text-base font-semibold text-red-500">Cancel Edit Assignment</h3>
                <button @onclick="CloseCancelConfirmModal" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="px-6 py-4">
                <p class="mb-4 text-sm text-gray-700">Are you sure you want to cancel? All changes will be discarded.</p>
                <div class="flex justify-end">
                    <button @onclick="ConfirmCancel" class="rounded-lg px-3 py-1.5 text-sm font-medium text-white transition-all hover:opacity-90" style="background-color: #f87171;">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Validation Error Modal -->
@if (showValidationModal)
{
    <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-50" @onclick="CloseValidationModal">
        <div id="edit-assignment-validation-modal" class="w-full max-w-md rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <div class="flex items-center rounded-t-2xl bg-red-500 px-6 py-2">
                <h3 class="text-base font-semibold text-white">Validation Error</h3>
            </div>
            <div class="px-6 py-4">
                <p class="mb-3 text-sm font-medium text-gray-800">Please fill in the following required fields:</p>
                <ul class="list-inside list-disc space-y-1 text-sm text-gray-700">
                    @foreach (var error in validationErrors)
                    {
                        <li>@error</li>
                    }
                </ul>
            </div>
            <div class="flex justify-end border-t border-gray-200 px-6 py-3">
                <button @onclick="CloseValidationModal" class="rounded-lg px-3 py-1.5 text-sm font-medium text-white hover:opacity-90 bg-red-500">
                    OK
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public TeacherAssignmentModel Assignment { get; set; } = new();
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSubmit { get; set; }

    private List<DataModels.UserEntity> Teachers { get; set; } = new();
    private List<DataModels.GradeLevel> GradeLevels { get; set; } = new();
    private List<DataModels.Section> AvailableSections { get; set; } = new();
    private List<DataModels.Section> FilteredSections { get; set; } = new();
    private List<DataModels.Subject> AvailableSubjects { get; set; } = new();
    private List<AssignmentRow> AssignmentRows { get; set; } = new();
    
    private string SelectedSection { get; set; } = "";
    private string SelectedGradeLevel { get; set; } = "";
    private string SelectedClassroom { get; set; } = "";
    private string AdviserTeacherName { get; set; } = "";
    private int? SelectedSectionId { get; set; }
    private int? SelectedClassroomId { get; set; }
    private int? SelectedGradeLevelId { get; set; }
    private int? AssignmentId { get; set; }
    
    // Inline editor state
    private bool IsAddingRow { get; set; } = false;
    private bool IsEditingRow { get; set; } = false;
    private int? EditingRowIndex { get; set; } = null;
    private AssignmentRow WorkingRow { get; set; } = new();
    private string RowErrorMessage { get; set; } = "";
    private readonly List<string> DaysOfWeek = new() { "M", "T", "W", "TH", "F" };
    
    private bool showSubmitConfirmModal = false;
    private bool showCancelConfirmModal = false;
    private bool showValidationModal = false;
    private List<string> validationErrors = new();

    protected override async Task OnParametersSetAsync()
    {
        if (Show && Assignment != null && !string.IsNullOrEmpty(Assignment.Id))
        {
            await LoadDataAsync();
            await LoadExistingAssignmentData();
        }
    }

    private async Task LoadDataAsync()
    {
        try
        {
            Teachers = await CurriculumService.GetTeachersAsync();
            GradeLevels = await CurriculumService.GetAllGradeLevelsAsync();
            var allSections = await CurriculumService.GetAllSectionsAsync();
            AvailableSections = allSections.OrderBy(s => s.GradeLevelId).ThenBy(s => s.SectionName).ToList();
            FilteredSections = new List<DataModels.Section>();
        }
        catch (Exception)
        {
        }
    }

    private async Task LoadExistingAssignmentData()
    {
        try
        {
            // Parse assignment ID from format "ASG-001" or use AssignmentId
            if (Assignment.Id.StartsWith("ASG-"))
            {
                var idStr = Assignment.Id.Replace("ASG-", "");
                if (int.TryParse(idStr, out var id))
                {
                    AssignmentId = id;
                }
            }
            else if (Assignment.AssignmentId > 0)
            {
                AssignmentId = Assignment.AssignmentId;
            }

            if (!AssignmentId.HasValue) return;

            // Load the existing assignment from database
            var dbAssignment = await CurriculumService.GetTeacherAssignmentByIdAsync(AssignmentId.Value);
            if (dbAssignment == null) return;

            // Set grade level and section
            if (dbAssignment.Section != null)
            {
                SelectedGradeLevel = dbAssignment.Section.GradeLevel?.GradeLevelName ?? "";
                SelectedSection = dbAssignment.Section.SectionName ?? "";
                SelectedSectionId = dbAssignment.SectionId;
                SelectedClassroom = dbAssignment.Section.Classroom?.RoomName ?? "";
                SelectedClassroomId = dbAssignment.Section.ClassroomId;
                
                if (dbAssignment.Section.GradeLevelId > 0)
                {
                    SelectedGradeLevelId = dbAssignment.Section.GradeLevelId;
                    FilteredSections = AvailableSections
                        .Where(s => s.GradeLevelId == dbAssignment.Section.GradeLevelId)
                        .OrderBy(s => s.SectionName)
                        .ToList();
                }
            }

            // Set adviser teacher name - try to get from adviser assignment
            var allAssignments = await CurriculumService.GetAllTeacherAssignmentsAsync();
            var adviserAssignment = allAssignments
                .FirstOrDefault(a => a.SectionId == SelectedSectionId && a.Role == "adviser");
            
            if (adviserAssignment?.Teacher != null)
            {
                AdviserTeacherName = $"{adviserAssignment.Teacher.FirstName} {adviserAssignment.Teacher.LastName}";
                AssignmentId = adviserAssignment.AssignmentId; // Use adviser assignment ID for updates
            }
            else if (dbAssignment.Teacher != null)
            {
                AdviserTeacherName = $"{dbAssignment.Teacher.FirstName} {dbAssignment.Teacher.LastName}";
            }

            // Load subjects for the grade level
            await LoadSubjects();

            // Load class schedules (do this before LoadAssignmentRows to avoid concurrent DbContext access)
            var allClassSchedules = await CurriculumService.GetAllClassSchedulesAsync();

            // Load existing assignments and convert to AssignmentRow list (pass already-loaded data)
            await LoadAssignmentRows(allAssignments, allClassSchedules);

            StateHasChanged();
        }
        catch (Exception)
        {
        }
    }

    private async Task LoadSubjects()
    {
        if (!SelectedGradeLevelId.HasValue)
        {
            AvailableSubjects.Clear();
            return;
        }

        try
        {
            var allSubjects = await CurriculumService.GetAllSubjectsAsync();
            AvailableSubjects = allSubjects
                .Where(s => s.GradeLevelId == SelectedGradeLevelId.Value)
                .OrderBy(s => s.SubjectName)
                .ToList();
        }
        catch (Exception)
        {
            AvailableSubjects.Clear();
        }
    }

    private Task LoadAssignmentRows(List<DataModels.TeacherSectionAssignment> allAssignments, List<DataModels.ClassSchedule> allClassSchedules)
    {
        AssignmentRows = new List<AssignmentRow>();

        if (!SelectedSectionId.HasValue)
        {
            return Task.CompletedTask;
        }

        try
        {
            // Use already-loaded assignments instead of making another database call
            var sectionAssignments = allAssignments
                .Where(a => a.SectionId == SelectedSectionId.Value && a.Role == "subject_teacher" && a.SubjectId.HasValue)
                .ToList();

            // Group schedules by assignment and then by time (same start/end time = same AssignmentRow)
            foreach (var assignment in sectionAssignments)
            {
                var subjectName = assignment.Subject?.SubjectName ?? "Unknown subject";
                var teacherName = assignment.Teacher != null 
                    ? $"{assignment.Teacher.FirstName} {assignment.Teacher.LastName}" 
                    : "";

                var schedules = allClassSchedules
                    .Where(s => s.AssignmentId == assignment.AssignmentId)
                    .ToList();

                // Group by time range (same start/end time)
                var timeGroups = schedules
                    .GroupBy(s => new { s.StartTime, s.EndTime })
                    .ToList();

                foreach (var timeGroup in timeGroups)
                {
                    var days = timeGroup.Select(s => s.DayOfWeek).OrderBy(d => GetDayOrder(d)).ToList();
                    
                    AssignmentRows.Add(new AssignmentRow
                    {
                        SubjectId = assignment.SubjectId!.Value,
                        SubjectName = subjectName,
                        TeacherId = assignment.TeacherId,
                        TeacherName = teacherName,
                        StartTime = timeGroup.Key.StartTime.ToString(@"hh\:mm"),
                        EndTime = timeGroup.Key.EndTime.ToString(@"hh\:mm"),
                        StartTimeSpan = timeGroup.Key.StartTime,
                        EndTimeSpan = timeGroup.Key.EndTime,
                        Days = days
                    });
                }
            }
        }
        catch (Exception)
        {
            AssignmentRows.Clear();
        }

        return Task.CompletedTask;
    }

    private async Task OnGradeLevelChanged()
    {
        if (string.IsNullOrEmpty(SelectedGradeLevel))
        {
            FilteredSections.Clear();
            SelectedSection = "";
            SelectedClassroom = "";
            SelectedSectionId = null;
            SelectedClassroomId = null;
            SelectedGradeLevelId = null;
            AssignmentRows.Clear();
            StateHasChanged();
            return;
        }

        var gradeLevel = GradeLevels.FirstOrDefault(g => g.GradeLevelName == SelectedGradeLevel);
        if (gradeLevel != null)
        {
            SelectedGradeLevelId = gradeLevel.GradeLevelId;
            FilteredSections = AvailableSections
                .Where(s => s.GradeLevelId == gradeLevel.GradeLevelId)
                .OrderBy(s => s.SectionName)
                .ToList();
        }
        else
        {
            FilteredSections.Clear();
            SelectedGradeLevelId = null;
        }

        SelectedSection = "";
        SelectedClassroom = "";
        SelectedSectionId = null;
        SelectedClassroomId = null;
        AssignmentRows.Clear();
        await LoadSubjects();
        
        StateHasChanged();
    }

    private async Task OnSectionChanged()
    {
        if (string.IsNullOrEmpty(SelectedSection))
        {
            SelectedClassroom = "";
            SelectedSectionId = null;
            SelectedClassroomId = null;
            AssignmentRows.Clear();
            StateHasChanged();
            return;
        }

        var section = FilteredSections.FirstOrDefault(s => s.SectionName == SelectedSection);
        if (section != null)
        {
            SelectedSectionId = section.SectionId;
            SelectedClassroom = section.Classroom?.RoomName ?? "";
            SelectedClassroomId = section.ClassroomId;
            
            await LoadSubjects();
            
            // Load data sequentially to avoid concurrent DbContext access
            var allAssignments = await CurriculumService.GetAllTeacherAssignmentsAsync();
            var allClassSchedules = await CurriculumService.GetAllClassSchedulesAsync();
            await LoadAssignmentRows(allAssignments, allClassSchedules);
        }
        
        StateHasChanged();
    }

    // Inline editor methods
    private void StartAddingAssignment()
    {
        WorkingRow = new AssignmentRow();
        IsAddingRow = true;
        IsEditingRow = false;
        EditingRowIndex = null;
        RowErrorMessage = "";
        StateHasChanged();
    }

    private void StartEditingAssignment(int index)
    {
        if (index >= 0 && index < AssignmentRows.Count)
        {
            var row = AssignmentRows[index];
            WorkingRow = new AssignmentRow
            {
                SubjectId = row.SubjectId,
                SubjectName = row.SubjectName,
                TeacherId = row.TeacherId,
                TeacherName = row.TeacherName,
                StartTime = row.StartTime,
                EndTime = row.EndTime,
                StartTimeSpan = row.StartTimeSpan,
                EndTimeSpan = row.EndTimeSpan,
                Days = new List<string>(row.Days)
            };
            IsEditingRow = true;
            IsAddingRow = false;
            EditingRowIndex = index;
            RowErrorMessage = "";
            StateHasChanged();
        }
    }

    private void CancelEditing()
    {
        WorkingRow = new AssignmentRow();
        IsAddingRow = false;
        IsEditingRow = false;
        EditingRowIndex = null;
        RowErrorMessage = "";
        StateHasChanged();
    }

    private void OnWorkingRowChanged()
    {
        RowErrorMessage = "";
        StateHasChanged();
    }

    private void ToggleDay(string day)
    {
        if (WorkingRow.Days.Contains(day))
        {
            WorkingRow.Days.Remove(day);
        }
        else
        {
            WorkingRow.Days.Add(day);
        }
        StateHasChanged();
    }

    private bool CanSaveWorkingRow
    {
        get
        {
            if (WorkingRow.SubjectId <= 0 || WorkingRow.TeacherId <= 0 || !WorkingRow.Days.Any())
            {
                return false;
            }

            if (!TimeSpan.TryParse(WorkingRow.StartTime, out var start))
            {
                return false;
            }

            if (!TimeSpan.TryParse(WorkingRow.EndTime, out var end))
            {
                return false;
            }

            return end > start;
        }
    }

    private void SaveWorkingRow()
    {
        RowErrorMessage = "";

        if (!CanSaveWorkingRow)
        {
            RowErrorMessage = "Please select subject, teacher, valid time range, and at least one day.";
            return;
        }

        var subject = AvailableSubjects.FirstOrDefault(s => s.SubjectId == WorkingRow.SubjectId);
        var teacher = Teachers.FirstOrDefault(t => t.UserId == WorkingRow.TeacherId);

        if (subject == null || teacher == null)
        {
            RowErrorMessage = "Invalid subject or teacher selection.";
            return;
        }

        // Parse times
        TimeSpan.TryParse(WorkingRow.StartTime, out var start);
        TimeSpan.TryParse(WorkingRow.EndTime, out var end);

        if (IsEditingRow && EditingRowIndex.HasValue)
        {
            // Update existing row
            var index = EditingRowIndex.Value;
            if (index >= 0 && index < AssignmentRows.Count)
            {
                AssignmentRows[index] = new AssignmentRow
                {
                    SubjectId = WorkingRow.SubjectId,
                    SubjectName = subject.SubjectName,
                    TeacherId = WorkingRow.TeacherId,
                    TeacherName = $"{teacher.FirstName} {teacher.LastName}",
                    StartTime = WorkingRow.StartTime,
                    EndTime = WorkingRow.EndTime,
                    StartTimeSpan = start,
                    EndTimeSpan = end,
                    Days = new List<string>(WorkingRow.Days)
                };
            }
        }
        else
        {
            // Add new row
            AssignmentRows.Add(new AssignmentRow
            {
                SubjectId = WorkingRow.SubjectId,
                SubjectName = subject.SubjectName,
                TeacherId = WorkingRow.TeacherId,
                TeacherName = $"{teacher.FirstName} {teacher.LastName}",
                StartTime = WorkingRow.StartTime,
                EndTime = WorkingRow.EndTime,
                StartTimeSpan = start,
                EndTimeSpan = end,
                Days = new List<string>(WorkingRow.Days)
            });
        }

        CancelEditing();
    }

    private void RemoveAssignmentRow(int index)
    {
        if (index >= 0 && index < AssignmentRows.Count)
        {
            AssignmentRows.RemoveAt(index);
            StateHasChanged();
        }
    }

    private bool CanSubmit
    {
        get
        {
            if (string.IsNullOrWhiteSpace(SelectedGradeLevel) || !SelectedGradeLevelId.HasValue)
                return false;
                
            if (string.IsNullOrWhiteSpace(SelectedSection) || !SelectedSectionId.HasValue)
                return false;

            if (string.IsNullOrWhiteSpace(AdviserTeacherName))
                return false;

            return AssignmentRows.Any();
        }
    }

    private bool ValidateForm()
    {
        validationErrors.Clear();
        
        if (string.IsNullOrWhiteSpace(SelectedGradeLevel) || !SelectedGradeLevelId.HasValue)
        {
            validationErrors.Add("Grade Level is required");
        }
        
        if (string.IsNullOrWhiteSpace(SelectedSection) || !SelectedSectionId.HasValue)
        {
            validationErrors.Add("Section is required");
        }
        
        if (string.IsNullOrWhiteSpace(AdviserTeacherName))
        {
            validationErrors.Add("Adviser is required");
        }
        
        if (!AssignmentRows.Any())
        {
            validationErrors.Add("Please add at least one subject assignment.");
        }
        
        return validationErrors.Count == 0;
    }

    private void ShowSubmitConfirm()
    {
        if (!ValidateForm())
        {
            showValidationModal = true;
            return;
        }
        
        if (CanSubmit)
        {
            showSubmitConfirmModal = true;
        }
    }

    private void CloseValidationModal()
    {
        showValidationModal = false;
    }

    private void CloseSubmitConfirmModal()
    {
        showSubmitConfirmModal = false;
    }

    private async Task ConfirmSubmit()
    {
        showSubmitConfirmModal = false;
        await HandleSubmit();
    }

    private void ShowCancelConfirm()
    {
        if (HasData())
        {
            showCancelConfirmModal = true;
        }
        else
        {
            OnClose.InvokeAsync();
        }
    }

    private void CloseCancelConfirmModal()
    {
        showCancelConfirmModal = false;
    }

    private async Task ConfirmCancel()
    {
        showCancelConfirmModal = false;
        await OnClose.InvokeAsync();
    }

    private bool HasData()
    {
        return !string.IsNullOrWhiteSpace(SelectedGradeLevel) ||
               !string.IsNullOrWhiteSpace(SelectedSection) ||
               !string.IsNullOrWhiteSpace(AdviserTeacherName) ||
               AssignmentRows.Any();
    }

    private int GetDayOrder(string day)
    {
        return day switch
        {
            "M" => 1,
            "T" => 2,
            "W" => 3,
            "TH" => 4,
            "F" => 5,
            "Sat" => 6,
            "Sun" => 7,
            _ => 99
        };
    }

    private string FormatTime(TimeSpan time)
    {
        var hours = time.Hours;
        var minutes = time.Minutes;
        var period = hours < 12 ? "AM" : "PM";
        var displayHour = hours % 12;
        if (displayHour == 0) displayHour = 12;
        return $"{displayHour}:{minutes:D2} {period}";
    }

    private async Task HandleBackdropClick()
    {
        if (showSubmitConfirmModal || showCancelConfirmModal || showValidationModal)
        {
            return;
        }
        
        if (!HasData())
        {
            await OnClose.InvokeAsync();
        }
        else
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("handleModalBackdropClick", "edit-assignment-modal");
            }
            catch (Exception)
            {
            }
        }
    }

    private async Task HandleSubmit()
    {
        // If anything fails here, we want to see the exception instead of silently swallowing it.

        if (!SelectedSectionId.HasValue || !SelectedClassroomId.HasValue)
        {
            return;
        }

        var section = AvailableSections.FirstOrDefault(s => s.SectionId == SelectedSectionId.Value);
        if (section == null)
        {
            return;
        }

        // Update or create adviser assignment
        var adviserTeacher = Teachers.FirstOrDefault(t => 
            $"{t.FirstName} {t.LastName}" == AdviserTeacherName);
        
        if (adviserTeacher == null)
        {
            // Let the validation layer handle missing adviser
            return;
        }

        // Get or create adviser assignment
        // First check if adviser assignment exists by loading all assignments
        var allAssignments = await CurriculumService.GetAllTeacherAssignmentsAsync();
        var existingAdviserAssignment = allAssignments
            .FirstOrDefault(a => a.SectionId == SelectedSectionId.Value && a.Role == "adviser");

        if (existingAdviserAssignment != null)
        {
            // Reload the assignment fresh from database to avoid tracking conflicts
            var adviserAssignment = await CurriculumService.GetTeacherAssignmentByIdAsync(existingAdviserAssignment.AssignmentId);
            if (adviserAssignment != null)
            {
                // Update existing adviser assignment
                adviserAssignment.TeacherId = adviserTeacher.UserId;
                await CurriculumService.UpdateTeacherAssignmentAsync(adviserAssignment);
            }
        }
        else
        {
            // Create new adviser assignment
            var newAdviserAssignment = new DataModels.TeacherSectionAssignment
            {
                TeacherId = adviserTeacher.UserId,
                SectionId = SelectedSectionId.Value,
                SubjectId = null,
                Role = "adviser"
            };
            await CurriculumService.CreateTeacherAssignmentAsync(newAdviserAssignment);
        }

        // Delete all existing subject_teacher assignments and their ClassSchedule entries for this section
        var existingSubjectAssignments = allAssignments
            .Where(a => a.SectionId == SelectedSectionId.Value && a.Role == "subject_teacher")
            .ToList();

        var allClassSchedules = await CurriculumService.GetAllClassSchedulesAsync();
        
        foreach (var existingAssignment in existingSubjectAssignments)
        {
            // Delete all ClassSchedule entries for this assignment
            var schedules = allClassSchedules
                .Where(s => s.AssignmentId == existingAssignment.AssignmentId)
                .ToList();
            
            foreach (var schedule in schedules)
            {
                await CurriculumService.DeleteClassScheduleAsync(schedule.ScheduleId);
            }

            // Delete the assignment (soft delete - archives it)
            await CurriculumService.DeleteTeacherAssignmentAsync(existingAssignment.AssignmentId);
        }

        // Create new assignments from AssignmentRows (same pattern as AddAssignmentModal)
        foreach (var row in AssignmentRows)
        {
            var assignment = new DataModels.TeacherSectionAssignment
            {
                TeacherId = row.TeacherId,
                SectionId = SelectedSectionId.Value,
                SubjectId = row.SubjectId,
                Role = "subject_teacher"
            };

            assignment = await CurriculumService.CreateTeacherAssignmentAsync(assignment);

            // Create ClassSchedule entries for each day
            foreach (var day in row.Days)
            {
                var classSchedule = new DataModels.ClassSchedule
                {
                    AssignmentId = assignment.AssignmentId,
                    DayOfWeek = day,
                    StartTime = row.StartTimeSpan,
                    EndTime = row.EndTimeSpan,
                    RoomId = SelectedClassroomId.Value
                };
                await CurriculumService.CreateClassScheduleAsync(classSchedule);
            }
        }

        // Notify parent to refresh and close modal
        await OnSubmit.InvokeAsync();
        await OnClose.InvokeAsync();
    }

    // AssignmentRow model (same as AddAssignmentModal)
    public class AssignmentRow
    {
        public int SubjectId { get; set; }
        public string SubjectName { get; set; } = "";
        public int TeacherId { get; set; }
        public string TeacherName { get; set; } = "";
        // Time strings used for binding with TimePicker
        public string StartTime { get; set; } = "";
        public string EndTime { get; set; } = "";
        // Parsed TimeSpan values used when creating ClassSchedule
        public TimeSpan StartTimeSpan { get; set; }
        public TimeSpan EndTimeSpan { get; set; }
        public List<string> Days { get; set; } = new();
    }
}
