@page "/gradebook"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Components.Pages.Admin.Gradebook.GradebookComponents
@using BrightEnroll_DES.Services.RoleBase
@using BrightEnroll_DES.Services
@inject IAuthorizationService AuthorizationService
@inject ILoadingService LoadingService
@inject Microsoft.AspNetCore.Components.NavigationManager Navigation

<PageTitle>Gradebook</PageTitle>

<RoleAuthorizeView RequiredPermission="@Permissions.ViewGradebook">

<div class="text-gray-800">
    <h1 class="mb-6 text-2xl font-bold text-gray-800">Gradebook</h1>
    
    <!-- Tabs Card -->
    <div class="mb-6 overflow-hidden rounded-xl border-b border-gray-200 bg-white px-4 py-2 shadow">
        <div class="flex items-center gap-6">
            <button @onclick='() => SetActiveTab("entry")' 
                    class="@GetTabClasses("entry")">
                Grade Entry
            </button>
            <button @onclick='() => SetActiveTab("records")' 
                    class="@GetTabClasses("records")">
                Grade Records
            </button>
            <button @onclick='() => SetActiveTab("reportcards")' 
                    class="@GetTabClasses("reportcards")">
                Report Cards
            </button>
        </div>
    </div>

    <!-- Card Container -->
    <div class="overflow-hidden rounded-xl bg-white shadow">
        @if (activeTab == "entry")
        {
            <GradeEntry @key="@($"entry-{_componentKey}")" />
        }
        else if (activeTab == "records")
        {
            <GradeRecords @key="@($"records-{_componentKey}")" />
        }
        else if (activeTab == "reportcards")
        {
            <ReportCards @key="@($"reportcards-{_componentKey}")" />
        }
    </div>
</div>

@code {
    private string activeTab = "entry";
    private string _componentKey = Guid.NewGuid().ToString();

    protected override void OnInitialized()
    {
        // Hide loading screen immediately when page loads
        // This ensures smooth transition from login without showing loading overlay
        LoadingService.HideLoading();
        
        // Check for tab parameter in URL
        var uri = new Uri(Navigation.Uri);
        var query = ParseQueryString(uri.Query);
        
        if (query.TryGetValue("tab", out var tabValue))
        {
            var validTabs = new[] { "entry", "records", "reportcards" };
            if (validTabs.Contains(tabValue, StringComparer.OrdinalIgnoreCase))
            {
                activeTab = tabValue.ToLower();
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Handle navigation changes (e.g., when coming from notification or URL changes)
        var uri = new Uri(Navigation.Uri);
        var query = ParseQueryString(uri.Query);
        
        if (query.TryGetValue("tab", out var tabValue))
        {
            var validTabs = new[] { "entry", "records", "reportcards" };
            if (validTabs.Contains(tabValue, StringComparer.OrdinalIgnoreCase))
            {
                var newTab = tabValue.ToLower();
                if (activeTab != newTab)
                {
                    activeTab = newTab;
                    // Force component refresh by changing key
                    _componentKey = Guid.NewGuid().ToString();
                    StateHasChanged();
                    
                    // Small delay to ensure DOM is ready
                    await Task.Delay(100);
                    StateHasChanged();
                }
            }
        }
    }

    private async Task SetActiveTab(string tab)
    {
        if (activeTab == tab) return;
        
        activeTab = tab;
        // Force component refresh by changing key
        _componentKey = Guid.NewGuid().ToString();
        
        // Update URL without navigation
        var uri = new Uri(Navigation.Uri);
        var baseUri = uri.GetLeftPart(UriPartial.Path);
        Navigation.NavigateTo($"{baseUri}?tab={tab}", forceLoad: false);
        
        StateHasChanged();
        
        // Small delay to ensure DOM is ready before next operation
        await Task.Delay(100);
        StateHasChanged();
    }

    private string GetTabClasses(string tab)
    {
        var baseClasses = "px-4 py-2 text-sm font-semibold transition-colors duration-200 border-b-2";
        if (activeTab == tab)
        {
            return $"{baseClasses} border-blue-600 text-blue-600";
        }
        return $"{baseClasses} border-transparent text-gray-600 hover:text-gray-800";
    }

    private Dictionary<string, string> ParseQueryString(string queryString)
    {
        var result = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        
        if (string.IsNullOrWhiteSpace(queryString))
            return result;
        
        // Remove leading '?' if present
        if (queryString.StartsWith("?"))
            queryString = queryString.Substring(1);
        
        var pairs = queryString.Split('&', StringSplitOptions.RemoveEmptyEntries);
        foreach (var pair in pairs)
        {
            var parts = pair.Split('=', 2);
            if (parts.Length == 2)
            {
                var key = Uri.UnescapeDataString(parts[0]);
                var value = Uri.UnescapeDataString(parts[1]);
                result[key] = value;
            }
        }
        
        return result;
    }
}

</RoleAuthorizeView>

