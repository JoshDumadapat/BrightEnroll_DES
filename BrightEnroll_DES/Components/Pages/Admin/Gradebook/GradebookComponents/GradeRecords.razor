@namespace BrightEnroll_DES.Components.Pages.Admin.Gradebook.GradebookComponents
@using BrightEnroll_DES.Services.Business.Academic
@using BrightEnroll_DES.Services.Authentication
@using BrightEnroll_DES.Data.Models
@using Microsoft.AspNetCore.Components.Web
@inject GradeService GradeService
@inject TeacherService TeacherService
@inject IAuthService AuthService

<div class="p-6">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="mb-4 rounded-lg bg-red-50 p-4 text-red-700">
            @errorMessage
        </div>
    }

    <!-- Filters -->
    <div class="mb-6 border-b border-gray-200 px-3 py-4 sm:px-6">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                <div class="relative flex w-full items-center sm:w-auto sm:min-w-[200px]">
                    <span class="absolute left-4 flex items-center justify-center">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </span>
                    <input type="text" @bind="searchTerm" @bind:event="oninput" @onkeypress="HandleSearchKeyPress"
                           placeholder="Search student..."
                           class="w-full rounded-lg border border-gray-300 py-2 pl-11 pr-4 text-sm text-gray-700 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400" />
                </div>
                <select @bind="selectedSchoolYear" @bind:after="OnFilterChanged"
                        class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                    @foreach (var year in availableSchoolYears)
                    {
                        <option value="@year">@year</option>
                    }
                </select>
                <select @bind="selectedSectionId" @bind:after="OnFilterChanged"
                        class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                    <option value="0">All Sections</option>
                    @foreach (var sec in availableSections)
                    {
                        <option value="@sec.SectionId">@sec.SectionName</option>
                    }
                </select>
                <select @bind="selectedSubjectId" @bind:after="OnFilterChanged"
                        class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                    <option value="0">All Subjects</option>
                    @foreach (var subj in availableSubjects)
                    {
                        <option value="@subj.SubjectId">@subj.SubjectName</option>
                    }
                </select>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
            <thead class="bg-gray-100 font-semibold text-gray-600">
                <tr>
                    <th class="px-4 py-3 text-left">Student ID</th>
                    <th class="px-4 py-3 text-left">Name</th>
                    <th class="px-4 py-3 text-left">Section</th>
                    <th class="px-4 py-3 text-center">Q1</th>
                    <th class="px-4 py-3 text-center">Q2</th>
                    <th class="px-4 py-3 text-center">Q3</th>
                    <th class="px-4 py-3 text-center">Q4</th>
                    <th class="px-4 py-3 text-center">Final</th>
                    <th class="px-4 py-3 text-center">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y">
                @if (isLoading)
                {
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">Loading grade records...</td>
                    </tr>
                }
                else if (!gradeRecords.Any())
                {
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">No grade records found.</td>
                    </tr>
                }
                else
                {
                    @foreach (var record in gradeRecords)
                    {
                        <tr class="transition hover:bg-gray-50">
                            <td class="px-4 py-3">@record.StudentId</td>
                            <td class="px-4 py-3">@record.Name</td>
                            <td class="px-4 py-3">@record.Section</td>
                            <td class="px-4 py-3 text-center font-semibold">@(record.Q1 > 0 ? record.Q1.ToString("F2") : "-")</td>
                            <td class="px-4 py-3 text-center font-semibold">@(record.Q2 > 0 ? record.Q2.ToString("F2") : "-")</td>
                            <td class="px-4 py-3 text-center font-semibold">@(record.Q3 > 0 ? record.Q3.ToString("F2") : "-")</td>
                            <td class="px-4 py-3 text-center font-semibold">@(record.Q4 > 0 ? record.Q4.ToString("F2") : "-")</td>
                            <td class="px-4 py-3 text-center font-bold text-blue-600">@(record.Final > 0 ? record.Final.ToString("F2") : "-")</td>
                            <td class="flex items-center justify-center gap-2 px-4 py-3">
                                <button @onclick="() => ViewGradeHistory(record)" 
                                        class="flex items-center gap-1.5 rounded-lg bg-blue-50 px-3 py-1.5 text-xs font-medium text-blue-400 transition-colors hover:bg-blue-100">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                    View History
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- Footer -->
    <div class="flex items-center justify-between bg-gray-50 px-4 py-3 text-sm text-gray-600">
        <span>Showing @gradeRecords.Count record(s)</span>
    </div>
</div>

@code {
    private List<GradeRecordDto> gradeRecords = new();
    private List<Section> availableSections = new();
    private List<Subject> availableSubjects = new();
    private List<string> availableSchoolYears = new();
    private string selectedSchoolYear = "";
    private int selectedSectionId = 0;
    private int selectedSubjectId = 0;
    private string searchTerm = "";
    private int teacherId = 0;
    private string errorMessage = "";
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        var currentUser = AuthService.CurrentUser;
        if (currentUser == null)
        {
            errorMessage = "You must be logged in to view grade records.";
            return;
        }

        teacherId = currentUser.user_ID;

        // Initialize school years
        var currentYear = DateTime.Now.Year;
        var nextYear = currentYear + 1;
        selectedSchoolYear = $"{currentYear}-{nextYear}";
        availableSchoolYears = new List<string>();
        for (int i = 0; i < 3; i++)
        {
            var year = currentYear - i;
            availableSchoolYears.Add($"{year}-{year + 1}");
        }

        await LoadFiltersAsync();
        await LoadGradeRecordsAsync();
    }

    private async Task LoadFiltersAsync()
    {
        try
        {
            if (teacherId == 0) return;

            // Load assigned sections
            availableSections = await TeacherService.GetAssignedSectionsForGradeEntryAsync(teacherId, selectedSchoolYear);

            // Load assigned subjects
            var assignments = await TeacherService.GetAssignedSectionsAsync(teacherId, selectedSchoolYear);
            var subjectIds = assignments
                .SelectMany(a => a.Subjects)
                .Distinct()
                .ToList();

            // Get subject details
            // Note: We need to get subject names from assignments or use a different approach
            // For now, we'll load all subjects and filter in the service
            availableSubjects.Clear();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading filters: {ex.Message}";
        }
    }

    private async Task LoadGradeRecordsAsync()
    {
        try
        {
            if (teacherId == 0) return;

            isLoading = true;
            errorMessage = "";
            StateHasChanged();

            gradeRecords = await GradeService.GetGradeRecordsAsync(
                teacherId,
                selectedSchoolYear,
                selectedSectionId > 0 ? selectedSectionId : null,
                selectedSubjectId > 0 ? selectedSubjectId : null,
                string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm
            );
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading grade records: {ex.Message}";
            gradeRecords.Clear();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnFilterChanged()
    {
        await LoadGradeRecordsAsync();
    }

    private async Task HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoadGradeRecordsAsync();
        }
    }

    private void ViewGradeHistory(GradeRecordDto record)
    {
        // TODO: Implement grade history modal/view
        // For now, just show an alert
        // You can create a modal component similar to StudentRecordViewModal
    }
}

