@namespace BrightEnroll_DES.Components.Pages.Admin.Gradebook.GradebookComponents
@using BrightEnroll_DES.Services.Business.Academic
@using BrightEnroll_DES.Services.Authentication
@using BrightEnroll_DES.Data.Models
@using BrightEnroll_DES.Services.QuestPDF
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inject GradeService GradeService
@inject TeacherService TeacherService
@inject SchoolYearService SchoolYearService
@inject IAuthService AuthService
@inject IJSRuntime JSRuntime
@inject GradeFormPdfGenerator PdfGenerator

<div class="p-6">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="mb-4 rounded-lg bg-red-50 p-4 text-red-700">
            @errorMessage
        </div>
    }

    <!-- School Year Indicator -->
    @if (!string.IsNullOrEmpty(selectedSchoolYear))
    {
        <div class="mb-4 flex items-center justify-start">
            <div class="flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-4 py-2">
                <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span class="text-sm font-semibold text-blue-800">Current School Year: <span class="font-bold">@selectedSchoolYear</span></span>
            </div>
        </div>
    }

    <!-- Filters -->
    <div class="mb-6 border-b border-gray-200 px-3 py-4 sm:px-6 no-print">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                <div class="relative flex w-full items-center sm:w-auto sm:min-w-[200px]">
                    <span class="absolute left-4 flex items-center justify-center">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </span>
                    <input type="text" @bind="searchTerm" @bind:event="oninput" @onkeypress="HandleSearchKeyPress"
                           placeholder="Search student..."
                           class="w-full rounded-lg border border-gray-300 py-2 pl-11 pr-4 text-sm text-gray-700 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400" />
                </div>
                <select @bind="selectedSchoolYear" @bind:after="OnFilterChanged"
                        class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                    @foreach (var year in availableSchoolYears)
                    {
                        <option value="@year">@year</option>
                    }
                </select>
                <select @bind="selectedSectionId" @bind:after="OnFilterChanged"
                        class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                    <option value="0">All Sections</option>
                    @foreach (var sec in availableSections)
                    {
                        <option value="@sec.SectionId">@sec.SectionName</option>
                    }
                </select>
                <select @bind="selectedSubjectId" @bind:after="OnFilterChanged"
                        class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                    <option value="0">All Subjects</option>
                    @foreach (var subj in availableSubjects)
                    {
                        <option value="@subj.SubjectId">@subj.SubjectName</option>
                    }
                </select>
            </div>
            <div class="flex items-center gap-2">
                <button @onclick="PrintPreview" 
                        disabled="@(isLoading || !IsPrintEnabled())"
                        class="flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-md transition-all duration-300 hover:bg-blue-700 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    <span>Print Preview</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto" id="grade-records-table">
        <table class="min-w-full text-sm">
            <thead class="bg-gray-100 font-semibold text-gray-600">
                <tr>
                    <th class="px-4 py-3 text-left">Student ID</th>
                    <th class="px-4 py-3 text-left">Name</th>
                    <th class="px-4 py-3 text-left">Section</th>
                    <th class="px-4 py-3 text-left">Subject</th>
                    <th class="px-4 py-3 text-center">Q1</th>
                    <th class="px-4 py-3 text-center">Q2</th>
                    <th class="px-4 py-3 text-center">Q3</th>
                    <th class="px-4 py-3 text-center">Q4</th>
                    <th class="px-4 py-3 text-center">Final</th>
                    <th class="px-4 py-3 text-center">Remarks</th>
                </tr>
            </thead>
            <tbody class="divide-y">
                @if (isLoading)
                {
                    <tr>
                        <td colspan="10" class="px-4 py-8 text-center text-gray-500">Loading grade records...</td>
                    </tr>
                }
                else if (!gradeRecords.Any())
                {
                    <tr>
                        <td colspan="10" class="px-4 py-8 text-center text-gray-500">No grade records found.</td>
                    </tr>
                }
                else
                {
                    @foreach (var record in gradeRecords)
                    {
                        <tr class="transition hover:bg-gray-50">
                            <td class="px-4 py-3">@record.StudentId</td>
                            <td class="px-4 py-3">@record.Name</td>
                            <td class="px-4 py-3">@record.Section</td>
                            <td class="px-4 py-3 font-medium">@record.Subject</td>
                            <td class="px-4 py-3 text-center font-semibold">@(record.Q1 > 0 ? record.Q1.ToString("F2") : "-")</td>
                            <td class="px-4 py-3 text-center font-semibold">@(record.Q2 > 0 ? record.Q2.ToString("F2") : "-")</td>
                            <td class="px-4 py-3 text-center font-semibold">@(record.Q3 > 0 ? record.Q3.ToString("F2") : "-")</td>
                            <td class="px-4 py-3 text-center font-semibold">@(record.Q4 > 0 ? record.Q4.ToString("F2") : "-")</td>
                            <td class="px-4 py-3 text-center font-bold text-blue-600">@(record.Final > 0 ? record.Final.ToString("F2") : "-")</td>
                            <td class="px-4 py-3 text-center">
                                @if (record.Remarks == "Incomplete" || record.Remarks == "No Grade")
                                {
                                    <span class="rounded-md bg-yellow-100 px-3 py-1 text-xs font-medium text-yellow-700">@record.Remarks</span>
                                }
                                else if (record.Remarks == "Outstanding" || record.Remarks == "Very Satisfactory")
                                {
                                    <span class="rounded-md bg-green-100 px-3 py-1 text-xs font-medium text-green-700">@record.Remarks</span>
                                }
                                else if (record.Remarks == "Did Not Meet Expectations")
                                {
                                    <span class="rounded-md bg-red-100 px-3 py-1 text-xs font-medium text-red-700">@record.Remarks</span>
                                }
                                else
                                {
                                    <span class="rounded-md bg-gray-100 px-3 py-1 text-xs font-medium text-gray-700">@record.Remarks</span>
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- Footer -->
    <div class="flex items-center justify-between bg-gray-50 px-4 py-3 text-sm text-gray-600 no-print">
        <span>Showing @gradeRecords.Count record(s)</span>
    </div>
</div>

@code {
    private List<GradeRecordDto> gradeRecords = new();
    private List<Section> availableSections = new();
    private List<Subject> availableSubjects = new();
    private List<string> availableSchoolYears = new();
    private string selectedSchoolYear = "";
    private int selectedSectionId = 0;
    private int selectedSubjectId = 0;
    private string searchTerm = "";
    private int teacherId = 0;
    private string errorMessage = "";
    private bool isLoading = false;

    private bool _hasInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        var currentUser = AuthService.CurrentUser;
        if (currentUser == null)
        {
            errorMessage = "You must be logged in to view grade records.";
            return;
        }

        teacherId = currentUser.user_ID;

        // Get active school year from database
        var activeSchoolYear = await SchoolYearService.GetActiveSchoolYearNameAsync();
        if (!string.IsNullOrEmpty(activeSchoolYear))
        {
            selectedSchoolYear = activeSchoolYear;
        }
        else
        {
            // Fallback to calculated school year
            var currentYear = DateTime.Now.Year;
            var nextYear = currentYear + 1;
            selectedSchoolYear = $"{currentYear}-{nextYear}";
        }
        
        // Get all available school years from database
        availableSchoolYears = await SchoolYearService.GetAvailableSchoolYearsAsync();
        
        // If no school years in database, generate current and past 2 years as fallback
        if (!availableSchoolYears.Any())
        {
            var currentYear = DateTime.Now.Year;
            for (int i = 0; i < 3; i++)
            {
                var year = currentYear - i;
                availableSchoolYears.Add($"{year}-{year + 1}");
            }
        }

        await LoadFiltersAsync();
        await LoadGradeRecordsAsync();
        _hasInitialized = true;
    }

    protected override async Task OnParametersSetAsync()
    {
        // Refresh data when component parameters change (e.g., when switching tabs)
        if (_hasInitialized)
        {
            // Small delay to ensure DOM is ready
            await Task.Delay(50);
            await InvokeAsync(StateHasChanged);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Ensure JavaScript is ready after first render
            await Task.Delay(100);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadFiltersAsync()
    {
        try
        {
            if (teacherId == 0) return;

            // Load assigned sections
            availableSections = await TeacherService.GetAssignedSectionsForGradeEntryAsync(teacherId, selectedSchoolYear);

            // Load assigned subjects - get unique subjects from all assigned sections
            var allSubjects = new List<Subject>();
            foreach (var section in availableSections)
            {
                var sectionSubjects = await TeacherService.GetAssignedSubjectsForGradeEntryAsync(teacherId, section.SectionId);
                allSubjects.AddRange(sectionSubjects);
            }
            
            // Get unique subjects
            availableSubjects = allSubjects
                .GroupBy(s => s.SubjectId)
                .Select(g => g.First())
                .OrderBy(s => s.SubjectName)
                .ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading filters: {ex.Message}";
        }
    }

    private async Task LoadGradeRecordsAsync()
    {
        try
        {
            if (teacherId == 0) return;

            isLoading = true;
            errorMessage = "";
            StateHasChanged();

            gradeRecords = await GradeService.GetGradeRecordsAsync(
                teacherId,
                selectedSchoolYear,
                selectedSectionId > 0 ? selectedSectionId : null,
                selectedSubjectId > 0 ? selectedSubjectId : null,
                string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm
            );
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading grade records: {ex.Message}";
            gradeRecords.Clear();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnFilterChanged()
    {
        await LoadGradeRecordsAsync();
    }

    private async Task HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoadGradeRecordsAsync();
        }
    }

    private bool IsPrintEnabled()
    {
        // Print is enabled only when all filters are selected: School Year, Section, and Subject
        return !string.IsNullOrWhiteSpace(selectedSchoolYear) 
            && selectedSectionId > 0 
            && selectedSubjectId > 0
            && gradeRecords.Any();
    }

    private async Task PrintPreview()
    {
        if (!IsPrintEnabled())
        {
            await JSRuntime.InvokeVoidAsync("alert", "Please select School Year, Section, and Subject before printing.");
            return;
        }

        try
        {
            isLoading = true;
            await InvokeAsync(StateHasChanged);

            // Generate PDF
            var pdfBytes = await PdfGenerator.GenerateGradeFormAsync(
                selectedSectionId,
                selectedSubjectId,
                selectedSchoolYear,
                teacherId
            );

            if (pdfBytes == null || pdfBytes.Length == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Error: PDF generation returned empty data.");
                isLoading = false;
                await InvokeAsync(StateHasChanged);
                return;
            }

            // Create filename
            var sectionName = availableSections.FirstOrDefault(s => s.SectionId == selectedSectionId)?.SectionName ?? "Section";
            var subjectName = availableSubjects.FirstOrDefault(s => s.SubjectId == selectedSubjectId)?.SubjectName ?? "Subject";
            var fileName = $"GradeForm_{sectionName}_{subjectName}_{selectedSchoolYear.Replace("-", "_")}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
            
            // Convert to base64 for download
            var base64Content = Convert.ToBase64String(pdfBytes);
            
            // Download the file - the JavaScript function will handle errors
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "application/pdf", base64Content);
        }
        catch (Microsoft.JSInterop.JSException jsEx)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"JavaScript error: {jsEx.Message}");
            Console.WriteLine($"JS Error: {jsEx.Message}\n{jsEx.StackTrace}");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error generating grade form PDF: {ex.Message}");
            Console.WriteLine($"Error: {ex.Message}\n{ex.StackTrace}");
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }
}

