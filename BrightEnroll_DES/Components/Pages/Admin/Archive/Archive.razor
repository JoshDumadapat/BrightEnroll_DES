@page "/archive"
@layout Components.Layout.MainLayout
@inject NavigationManager NavigationManager
@using BrightEnroll_DES.Components.Pages.Admin.ArchiveComponents
@using BrightEnroll_DES.Components.Pages.Admin.Archive

<PageTitle>Archive</PageTitle>

<div class="text-gray-800">
    <h1 class="mb-6 text-2xl font-bold text-gray-800">Archive</h1>
    <!-- Tabs Card -->
    <div class="mb-6 overflow-hidden rounded-xl border-b border-gray-200 bg-white px-4 py-2 shadow">
        <div class="flex items-center gap-6">
            <button @onclick="() => SelectedTab = TabType.StudentArchive" 
                    class="@GetTabClasses(TabType.StudentArchive)">
                Student Archive
            </button>
            <button @onclick="() => SelectedTab = TabType.EmployeeArchive" 
                    class="@GetTabClasses(TabType.EmployeeArchive)">
                Employee Archive
            </button>
        </div>
    </div>

    <!-- Card Container -->
    <div class="overflow-hidden rounded-xl bg-white shadow">
        @if (SelectedTab == TabType.StudentArchive)
        {
            <StudentArchive Students="ArchivedStudents" RowsPerPage="RowsPerPage" />
        }
        else if (SelectedTab == TabType.EmployeeArchive)
        {
            <EmployeeArchive Employees="ArchivedEmployees" RowsPerPage="RowsPerPage" OnEmployeeReactivated="HandleEmployeeReactivated" />
        }
    </div>
</div>

@code {
    private enum TabType
    {
        StudentArchive,
        EmployeeArchive
    }

    private TabType SelectedTab { get; set; } = TabType.StudentArchive;

    [Inject] private BrightEnroll_DES.Services.Business.Students.ArchiveService ArchiveService { get; set; } = null!;

    private string GetTabClasses(TabType tab)
    {
        bool isSelected = SelectedTab == tab;
        
        return tab switch
        {
            TabType.StudentArchive => isSelected
                ? "px-3 py-2 text-sm font-semibold text-blue-600 border-b-2 border-blue-600"
                : "px-3 py-2 text-sm font-semibold text-blue-600 transition-colors duration-200 hover:text-blue-700",
            TabType.EmployeeArchive => isSelected
                ? "px-3 py-2 text-sm font-semibold text-purple-600 border-b-2 border-purple-600"
                : "px-3 py-2 text-sm font-semibold text-purple-600 transition-colors duration-200 hover:text-purple-700",
            _ => "px-3 py-2 text-sm font-semibold"
        };
    }

    private int RowsPerPage { get; set; } = 5;

    private List<ArchivedStudent> ArchivedStudents { get; set; } = new();
    private List<ArchivedEmployee> ArchivedEmployees { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // Check query string for a requested tab (e.g., /archive?tab=employee)
        var uri = new Uri(NavigationManager.Uri);
        var query = ParseQueryString(uri.Query);

        if (query.TryGetValue("tab", out var tabValue))
        {
            if (string.Equals(tabValue, "employee", StringComparison.OrdinalIgnoreCase))
            {
                SelectedTab = TabType.EmployeeArchive;
            }
            else if (string.Equals(tabValue, "student", StringComparison.OrdinalIgnoreCase))
            {
                SelectedTab = TabType.StudentArchive;
            }
        }

        await LoadArchivedStudentsAsync();
        await LoadArchivedEmployeesAsync();
    }

    private async Task LoadArchivedStudentsAsync()
    {
        try
        {
            ArchivedStudents = await ArchiveService.GetArchivedStudentsAsync();
        }
        catch
        {
            // Log error if needed
            ArchivedStudents = new List<ArchivedStudent>();
        }
    }

    private async Task LoadArchivedEmployeesAsync()
    {
        try
        {
            ArchivedEmployees = await ArchiveService.GetArchivedEmployeesAsync();
        }
        catch
        {
            ArchivedEmployees = new List<ArchivedEmployee>();
        }
    }

    private async Task HandleEmployeeReactivated()
    {
        // Reload archived employees after reactivation
        await LoadArchivedEmployeesAsync();
        StateHasChanged();
    }

    // Simple query-string parser (key=value&key2=value2)
    private Dictionary<string, string> ParseQueryString(string queryString)
    {
        var query = new Dictionary<string, string>();

        if (string.IsNullOrWhiteSpace(queryString))
            return query;

        if (queryString.StartsWith("?"))
            queryString = queryString[1..];

        var pairs = queryString.Split('&', StringSplitOptions.RemoveEmptyEntries);
        foreach (var pair in pairs)
        {
            var parts = pair.Split('=', 2);
            if (parts.Length == 2)
            {
                var key = Uri.UnescapeDataString(parts[0]);
                var value = Uri.UnescapeDataString(parts[1]);
                query[key] = value;
            }
        }

        return query;
    }
}

