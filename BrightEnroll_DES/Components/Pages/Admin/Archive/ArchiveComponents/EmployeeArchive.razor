@namespace BrightEnroll_DES.Components.Pages.Admin.ArchiveComponents
@using BrightEnroll_DES.Components.Pages.Admin
@using BrightEnroll_DES.Components.Pages.Admin.Archive
@using BrightEnroll_DES.Services.Business.HR
@using BrightEnroll_DES.Services.Authentication
@using BrightEnroll_DES.Components
@inject EmployeeService EmployeeService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

@* Employee Archive Component with Filters *@
<!-- Toast Notification -->
<ToastNotification Show="@showToast" Message="@toastMessage" Type="@toastType" OnClose="CloseToast" Duration="4000" />
<!-- Filters -->
<div class="border-b border-gray-200 px-3 py-4 sm:px-6">
    <label class="mb-2 block text-sm font-bold text-gray-700">Filter:</label>
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
            <div class="relative flex w-full items-center sm:w-auto sm:min-w-[200px]">
                <span class="absolute left-4 flex items-center justify-center">
                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </span>
                <input type="text" placeholder="Search here..." @bind="SearchText"
                       class="w-full rounded-lg border border-gray-300 py-2 pl-11 pr-4 text-sm text-gray-700 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400" />
            </div>
            <select @bind="RoleFilter" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                <option value="">Role</option>
                <option value="Teacher">Teacher</option>
                <option value="Registrar">Registrar</option>
                <option value="Cashier">Cashier</option>
                <option value="Admin">Admin</option>
            </select>
            <select @bind="StatusFilter" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                <option value="">Status</option>
                <option value="Inactive">Inactive</option>
            </select>
        </div>
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
            <div class="group relative">
                <button @onclick="ClearFilters" class="flex w-full items-center justify-center gap-2 rounded-lg bg-gray-500 px-4 py-2 font-semibold text-white shadow-md transition-all duration-300 hover:bg-gray-600 hover:shadow-lg sm:w-auto" style="font-size: 13px;">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Clear
                </button>
                <span class="tooltip-delay">Clear all filters</span>
            </div>
            <div class="group relative">
                <button @onclick="ExportPDF" class="flex w-full items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 py-2 font-semibold text-white shadow-md transition-all duration-300 hover:bg-blue-700 hover:shadow-lg sm:w-auto" style="font-size: 13px;">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Export
                </button>
                <span class="tooltip-delay">Export archived employees to file</span>
            </div>
        </div>
    </div>
</div>

<!-- Table -->
<div class="overflow-x-auto">
    <table class="min-w-full text-sm table-fixed">
        <thead class="bg-gray-100 font-semibold text-gray-600">
            <tr>
                <th class="px-4 py-3 text-left whitespace-nowrap w-24">ID</th>
                <th class="px-4 py-3 text-left whitespace-nowrap w-40">Name</th>
                <th class="px-4 py-3 text-left whitespace-nowrap w-64">Address</th>
                <th class="px-4 py-3 text-left whitespace-nowrap w-48">Email</th>
                <th class="px-4 py-3 text-left whitespace-nowrap w-32">Role</th>
                <th class="px-4 py-3 text-left whitespace-nowrap w-48">Reason</th>
                <th class="px-4 py-3 text-left whitespace-nowrap w-28">Status</th>
                <th class="px-4 py-3 text-left whitespace-nowrap w-36">Archived Date</th>
                <th class="px-4 py-3 text-center whitespace-nowrap w-32">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y">
            @if (Employees != null && Employees.Any())
            {
                @foreach (var emp in PaginatedEmployees)
                {
                    <tr class="transition hover:bg-gray-50">
                        <td class="px-4 py-3 truncate" title="@emp.Id">@emp.Id</td>
                        <td class="px-4 py-3 truncate" title="@emp.Name">@emp.Name</td>
                        <td class="px-4 py-3 truncate" title="@emp.Address">@emp.Address</td>
                        <td class="px-4 py-3 truncate" title="@emp.Email">@emp.Email</td>
                        <td class="px-4 py-3 truncate" title="@emp.Role">@emp.Role</td>
                        <td class="px-4 py-3">
                            @if (!string.IsNullOrWhiteSpace(emp.ArchivedReason))
                            {
                                <span class="text-xs text-gray-700 truncate block" title="@emp.ArchivedReason">
                                    @emp.ArchivedReason
                                </span>
                            }
                            else
                            {
                                <span class="text-xs text-gray-400">-</span>
                            }
                        </td>
                        <td class="px-4 py-3">
                            <button @onclick="() => OpenActivateModal(emp)" class="inline-flex items-center rounded-md bg-red-100 px-2.5 py-1 text-[11px] font-medium text-red-700 transition-colors hover:bg-red-200 cursor-pointer whitespace-nowrap">
                                @emp.Status
                            </button>
                        </td>
                        <td class="px-4 py-3 text-gray-600 truncate" title="@emp.ArchivedDate">@emp.ArchivedDate</td>
                        <td class="px-4 py-3">
                            <div class="flex items-center justify-center">
                                <!-- View Button -->
                                <button @onclick="() => ViewEmployee(emp)" class="flex items-center gap-1.5 rounded-lg bg-blue-50 px-3 py-1.5 text-xs font-medium text-blue-400 transition-colors hover:bg-blue-100 whitespace-nowrap">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                    <span class="hidden sm:inline">View</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="9" class="px-4 py-12 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p class="text-base font-medium text-gray-600">No Data Available Currently</p>
                            <p class="text-sm text-gray-500 mt-1">There are no archived employees to display at this time.</p>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Footer with Pagination -->
<Pagination TotalItems="@FilteredEmployees.Count" 
            CurrentPage="@CurrentPage" 
            RowsPerPage="@RowsPerPage"
            ItemName="archived employees"
            OnPageChanged="HandlePageChanged"
            OnRowsPerPageChanged="HandleRowsPerPageChanged" />

<!-- View Employee Modal -->
@if (ShowViewModal && SelectedEmployee != null)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @onclick="HandleViewBackdropClick">
        <div id="view-employee-modal" class="w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <!-- Modal Header -->
            <div class="sticky top-0 flex items-center justify-between rounded-t-2xl bg-blue-600 px-6 py-4">
                <h3 class="text-lg font-semibold text-white">Employee Information</h3>
                <button @onclick="CloseViewModal" class="text-white hover:text-gray-200 transition-colors">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="px-6 py-6">
                <!-- Personal Information Section -->
                <div class="mb-6">
                    <h4 class="mb-4 text-base font-semibold text-gray-800 border-b border-gray-200 pb-2">Personal Information</h4>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-1">Employee ID</label>
                            <p class="text-sm text-gray-900">@SelectedEmployee.Id</p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-1">Full Name</label>
                            <p class="text-sm text-gray-900">@SelectedEmployee.Name</p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-1">Email</label>
                            <p class="text-sm text-gray-900">@(string.IsNullOrWhiteSpace(SelectedEmployee.Email) ? "-" : SelectedEmployee.Email)</p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-1">Contact</label>
                            <p class="text-sm text-gray-900">@(string.IsNullOrWhiteSpace(SelectedEmployee.Contact) ? "-" : SelectedEmployee.Contact)</p>
                        </div>
                        <div class="sm:col-span-2">
                            <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-1">Address</label>
                            <p class="text-sm text-gray-900">@(string.IsNullOrWhiteSpace(SelectedEmployee.Address) ? "-" : SelectedEmployee.Address)</p>
                        </div>
                    </div>
                </div>

                <!-- Employment Information Section -->
                <div class="mb-6">
                    <h4 class="mb-4 text-base font-semibold text-gray-800 border-b border-gray-200 pb-2">Employment Information</h4>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-1">Role</label>
                            <p class="text-sm text-gray-900">@SelectedEmployee.Role</p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-1">Status</label>
                            <span class="inline-flex items-center rounded-md bg-red-100 px-2.5 py-1 text-xs font-medium text-red-700">
                                @SelectedEmployee.Status
                            </span>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-1">Archived Date</label>
                            <p class="text-sm text-gray-900">@SelectedEmployee.ArchivedDate</p>
                        </div>
                    </div>
                </div>

                <!-- Archive Reason Section -->
                <div class="mb-6">
                    <h4 class="mb-4 text-base font-semibold text-gray-800 border-b border-gray-200 pb-2">Archive Reason</h4>
                    <div class="rounded-lg border border-gray-200 bg-gray-50 p-4">
                        @if (!string.IsNullOrWhiteSpace(SelectedEmployee.ArchivedReason))
                        {
                            <p class="text-sm text-gray-700 whitespace-pre-wrap">@SelectedEmployee.ArchivedReason</p>
                        }
                        else
                        {
                            <p class="text-sm text-gray-400 italic">No reason provided</p>
                        }
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="sticky bottom-0 flex justify-end gap-3 border-t border-gray-200 bg-gray-50 px-6 py-4 rounded-b-2xl">
                <button @onclick="CloseViewModal" 
                        class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50">
                    Close
                </button>
            </div>
        </div>
    </div>
}

<!-- Activate Employee Modal -->
@if (ShowActivateModal)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @onclick="HandleBackdropClick">
        <div id="activate-employee-modal" class="w-full max-w-md overflow-hidden rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <!-- Modal Header -->
            <div class="flex items-center justify-between rounded-t-2xl" style="background-color: #10b981; padding: 10px 20px;">
                <h3 class="text-base font-semibold text-white" style="margin: 0;">Activate Employee</h3>
                <button @onclick="CloseActivateModal" class="text-white hover:text-gray-200" style="background: transparent; border: none; cursor: pointer; padding: 0; margin: 0;">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="rounded-b-2xl bg-white" style="padding: 18px 20px 20px 20px;">
                <div style="margin: 0 0 20px 0;">
                    <!-- Performed by (current user) -->
                    <div class="mb-3 p-3 rounded-lg bg-gray-50 border border-gray-200">
                        <p class="text-[11px] font-medium text-gray-600 tracking-wide uppercase mb-1">
                            Performed by
                        </p>
                        <p class="text-sm font-medium text-gray-900 leading-snug">
                            @GetCurrentUserDisplayName()
                        </p>
                        <p class="text-[11px] text-gray-500 mt-1">
                            ID: @GetCurrentUserId()
                        </p>
                    </div>

                    <!-- Employee that will be activated -->
                    <div class="mb-4 p-3 rounded-lg bg-green-50 border border-green-200">
                        <p class="text-[11px] font-medium text-green-700 tracking-wide uppercase mb-1">
                            Employee to be Activated
                        </p>
                        <p class="text-sm sm:text-base font-semibold text-green-800 leading-snug">
                            @SelectedEmployee?.Name
                        </p>
                        <p class="text-xs text-green-600 mt-1">
                            ID: @SelectedEmployee?.Id
                        </p>
                    </div>

                    <!-- Archive reason display (read-only) -->
                    @if (!string.IsNullOrWhiteSpace(SelectedEmployee?.ArchivedReason))
                    {
                        <div class="mb-4 p-3 rounded-lg bg-gray-50 border border-gray-200">
                            <p class="text-[11px] font-medium text-gray-600 tracking-wide uppercase mb-1">
                                Previous Archive Reason
                            </p>
                            <p class="text-xs text-gray-700 leading-snug">
                                @SelectedEmployee.ArchivedReason
                            </p>
                        </div>
                    }
                </div>
                <div class="flex justify-end" style="border-top: 1px solid #e5e7eb; padding-top: 12px; margin-top: 16px;">
                    <button type="button" @onclick="ConfirmActivate" 
                            disabled="@isReactivating"
                            class="rounded-lg text-xs font-semibold text-white transition-all hover:opacity-90 disabled:cursor-not-allowed disabled:bg-gray-200 disabled:text-gray-500"
                            style="background-color: #10b981; padding: 8px 18px; margin: 0; border: none; cursor: pointer;">
                        @if (isReactivating)
                        {
                            <span class="inline-flex items-center">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Activating...
                            </span>
                        }
                        else
                        {
                            <span>Activate</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public List<ArchivedEmployee>? Employees { get; set; }

    [Parameter]
    public int RowsPerPage { get; set; } = 5;

    [Parameter]
    public EventCallback OnEmployeeReactivated { get; set; }

    // Filter properties
    private string SearchText { get; set; } = "";
    private string RoleFilter { get; set; } = "";
    private string StatusFilter { get; set; } = "";

    // Pagination state
    private int CurrentPage { get; set; } = 1;

    // Activate modal state
    private bool ShowActivateModal { get; set; } = false;
    // View modal state
    private bool ShowViewModal { get; set; } = false;
    private ArchivedEmployee? SelectedEmployee { get; set; }
    private bool isReactivating = false;
    private string? toastMessage;
    private ToastType toastType;
    private bool showToast = false;

    // Computed property for filtered employees
    private List<BrightEnroll_DES.Components.Pages.Admin.Archive.ArchivedEmployee> FilteredEmployees
    {
        get
        {
            if (Employees == null || !Employees.Any())
                return new List<BrightEnroll_DES.Components.Pages.Admin.Archive.ArchivedEmployee>();

            var filtered = Employees.AsEnumerable();

            // Search filter
            if (!string.IsNullOrWhiteSpace(SearchText))
            {
                filtered = filtered.Where(e => 
                    e.Name.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                    e.Id.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                    e.Email.Contains(SearchText, StringComparison.OrdinalIgnoreCase));
            }

            // Role filter
            if (!string.IsNullOrWhiteSpace(RoleFilter))
            {
                filtered = filtered.Where(e => e.Role == RoleFilter);
            }

            // Status filter
            if (!string.IsNullOrWhiteSpace(StatusFilter))
            {
                filtered = filtered.Where(e => e.Status == StatusFilter);
            }

            return filtered.ToList();
        }
    }

    // Computed property for paginated employees
    private List<BrightEnroll_DES.Components.Pages.Admin.Archive.ArchivedEmployee> PaginatedEmployees
    {
        get
        {
            var filtered = FilteredEmployees;
            return filtered
                .Skip((CurrentPage - 1) * RowsPerPage)
                .Take(RowsPerPage)
                .ToList();
        }
    }

    private void ClearFilters()
    {
        SearchText = "";
        RoleFilter = "";
        StatusFilter = "";
        CurrentPage = 1;
        StateHasChanged();
    }

    private void HandlePageChanged(int page)
    {
        CurrentPage = page;
        StateHasChanged();
    }

    private void HandleRowsPerPageChanged(int rowsPerPage)
    {
        RowsPerPage = rowsPerPage;
        CurrentPage = 1;
        StateHasChanged();
    }

    private void ExportPDF()
    {
        // Export PDF logic will be implemented here
    }

    private void ViewEmployee(ArchivedEmployee employee)
    {
        SelectedEmployee = employee;
        ShowViewModal = true;
        StateHasChanged();
    }

    private void CloseViewModal()
    {
        ShowViewModal = false;
        SelectedEmployee = null;
        StateHasChanged();
    }

    private void HandleViewBackdropClick()
    {
        CloseViewModal();
    }

    private void OpenActivateModal(ArchivedEmployee employee)
    {
        SelectedEmployee = employee;
        ShowActivateModal = true;
        StateHasChanged();
    }

    private void CloseActivateModal()
    {
        ShowActivateModal = false;
        SelectedEmployee = null;
        StateHasChanged();
    }

    private void HandleBackdropClick()
    {
        CloseActivateModal();
    }

    private async Task ConfirmActivate()
    {
        if (SelectedEmployee == null)
            return;

        var currentUser = AuthService.CurrentUser;
        if (currentUser == null)
        {
            toastMessage = "You must be logged in to perform this action.";
            toastType = ToastType.Error;
            showToast = true;
            StateHasChanged();
            return;
        }

        try
        {
            isReactivating = true;
            StateHasChanged();

            // Update status to Active (no reason needed for activation)
            var success = await EmployeeService.UpdateUserStatusAsync(
                SelectedEmployee.UserId,
                "Active",
                currentUser.user_ID,
                null
            );

            if (success)
            {
                toastMessage = $"Employee {SelectedEmployee.Name} has been activated successfully.";
                toastType = ToastType.Success;
                showToast = true;

                // Close modal
                CloseActivateModal();

                // Notify parent component to reload archived employees
                await OnEmployeeReactivated.InvokeAsync();
            }
            else
            {
                toastMessage = "Failed to activate employee. Please try again.";
                toastType = ToastType.Error;
                showToast = true;
            }
        }
        catch (Exception ex)
        {
            toastMessage = $"Error activating employee: {ex.Message}";
            toastType = ToastType.Error;
            showToast = true;
        }
        finally
        {
            isReactivating = false;
            StateHasChanged();
        }
    }

    private string GetCurrentUserDisplayName()
    {
        var user = AuthService.CurrentUser;
        if (user == null) return "Unknown User";
        
        var nameParts = new List<string> { user.first_name };
        if (!string.IsNullOrWhiteSpace(user.mid_name))
            nameParts.Add(user.mid_name);
        nameParts.Add(user.last_name);
        if (!string.IsNullOrWhiteSpace(user.suffix))
            nameParts.Add(user.suffix);
        
        return string.Join(" ", nameParts);
    }

    private string GetCurrentUserId()
    {
        var user = AuthService.CurrentUser;
        return user?.system_ID ?? "N/A";
    }

    private void CloseToast()
    {
        showToast = false;
        StateHasChanged();
    }
}

