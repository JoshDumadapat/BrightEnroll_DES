@namespace BrightEnroll_DES.Components.Pages.Admin.StudentRecord.StudentRecordComponents
@using BrightEnroll_DES.Components.Pages.Admin.StudentRecord.StudentRecordCS
@using BrightEnroll_DES.Components.Pages.Admin.Enrollment.EnrollmentCS
@using BrightEnroll_DES.Services.Business.Students
@using BrightEnroll_DES.Services.Infrastructure
@using BrightEnroll_DES.Components
@using System.Linq
@inject StudentService StudentService
@inject AddressService AddressService
@* Student Info Tab Content *@

<!-- Edit Button Outside Container - Right Aligned -->
<div class="mb-4 flex items-center justify-end">
    @if (!IsEditing)
    {
        <button @onclick="EnableEditMode" class="flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-md transition-all duration-300 hover:bg-blue-700 hover:shadow-lg">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Edit
        </button>
    }
</div>

<!-- All Information in One Card -->
<div class="overflow-hidden rounded-xl bg-white shadow">
    <div class="px-6 py-6">

        <!-- Personal Information Section -->
        <div class="mb-6">
            <h2 class="text-lg font-bold text-blue-600 mb-4">Personal Information</h2>
            
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="mb-4 rounded-lg bg-red-50 border border-red-200 p-3">
                    <p class="text-sm text-red-600">@ErrorMessage</p>
                </div>
            }
            @if (!string.IsNullOrEmpty(SuccessMessage))
            {
                <div class="mb-4 rounded-lg bg-green-50 border border-green-200 p-3">
                    <p class="text-sm text-green-600">@SuccessMessage</p>
                </div>
            }

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-3 sm:mb-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        First Name <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.FirstName" @bind:after="() => { FormatFirstName(); StateHasChanged(); }" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.FirstName
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Middle Name</label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.MiddleName" @bind:after="FormatMiddleName" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.MiddleName
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Last Name <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.LastName" @bind:after="() => { FormatLastName(); StateHasChanged(); }" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.LastName
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Suffix</label>
                    @if (IsEditing)
                    {
                        <select @bind="EditModel.Suffix" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                            @foreach (var suffix in SuffixOptions)
                            {
                                <option value="@suffix">@suffix</option>
                            }
                        </select>
                    }
                    else
                    {
                        <div class="relative">
                            <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                                @(string.IsNullOrEmpty(StudentData.Suffix) ? "N/A" : StudentData.Suffix)
                            </div>
                            <svg class="absolute right-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    }
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-3 sm:mb-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Birth Date <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <input type="date" @bind="EditModel.BirthDate" @bind:format="yyyy-MM-dd" @bind:after="HandleBirthDateChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    }
                    else
                    {
                        <div class="relative">
                            <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                                @(StudentData.BirthDate?.ToString("M / d / yyyy") ?? "N/A")
                            </div>
                            <svg class="absolute right-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Place of Birth <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.PlaceOfBirth" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.PlaceOfBirth
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Sex <span class="text-red-500">*</span>
                    </label>
                    <div class="flex items-center gap-4 sm:gap-6 pt-1 sm:pt-2">
                        <label class="flex items-center">
                            <input type="radio" checked="@(IsEditing ? EditModel.Sex == "Male" : StudentData.Sex == "Male")" 
                                   @onchange="@(() => { if (IsEditing) EditModel.Sex = "Male"; })" 
                                   disabled="@(!IsEditing)"
                                   class="w-4 h-4 text-blue-600 border-gray-300" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">Male</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" checked="@(IsEditing ? EditModel.Sex == "Female" : StudentData.Sex == "Female")" 
                                   @onchange="@(() => { if (IsEditing) EditModel.Sex = "Female"; })" 
                                   disabled="@(!IsEditing)"
                                   class="w-4 h-4 text-blue-600 border-gray-300" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">Female</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Mother Tongue <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <select @bind="EditModel.MotherTongue" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                            @foreach (var tongue in MotherTongueOptions)
                            {
                                <option value="@tongue">@tongue</option>
                            }
                        </select>
                    }
                    else
                    {
                        <div class="relative">
                            <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                                @(string.IsNullOrEmpty(StudentData.MotherTongue) ? "N/A" : StudentData.MotherTongue)
                            </div>
                            <svg class="absolute right-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    }
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Indigenous Peoples (IP) Community?
                    </label>
                    <div class="flex items-center gap-3 sm:gap-4 pt-1 sm:pt-2">
                        <label class="flex items-center">
                            <input type="radio" checked="@(IsEditing ? EditModel.IsIPCommunity == "Yes" : StudentData.IsIPCommunity == "Yes")" 
                                   @onchange="@(() => { if (IsEditing) EditModel.IsIPCommunity = "Yes"; })" 
                                   disabled="@(!IsEditing)"
                                   class="w-4 h-4 text-blue-600 border-gray-300" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">Yes</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" checked="@(IsEditing ? EditModel.IsIPCommunity == "No" : StudentData.IsIPCommunity == "No")" 
                                   @onchange="@(() => { if (IsEditing) EditModel.IsIPCommunity = "No"; })" 
                                   disabled="@(!IsEditing)"
                                   class="w-4 h-4 text-blue-600 border-gray-300" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">No</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">If Yes, please specify:</label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.IPCommunitySpecify" disabled="@(EditModel.IsIPCommunity != "Yes")" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed" />
                    }
                    else
                    {
                        <div class="relative">
                            <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                                @(string.IsNullOrEmpty(StudentData.IPCommunitySpecify) ? "N/A" : StudentData.IPCommunitySpecify)
                            </div>
                            <svg class="absolute right-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        4Ps Beneficiary?
                    </label>
                    <div class="flex items-center gap-3 sm:gap-4 pt-1 sm:pt-2">
                        <label class="flex items-center">
                            <input type="radio" checked="@(IsEditing ? EditModel.Is4PsBeneficiary == "Yes" : StudentData.Is4PsBeneficiary == "Yes")" 
                                   @onchange="@(() => { if (IsEditing) EditModel.Is4PsBeneficiary = "Yes"; })" 
                                   disabled="@(!IsEditing)"
                                   class="w-4 h-4 text-blue-600 border-gray-300" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">Yes</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" checked="@(IsEditing ? EditModel.Is4PsBeneficiary == "No" : StudentData.Is4PsBeneficiary == "No")" 
                                   @onchange="@(() => { if (IsEditing) EditModel.Is4PsBeneficiary = "No"; })" 
                                   disabled="@(!IsEditing)"
                                   class="w-4 h-4 text-blue-600 border-gray-300" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">No</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">If Yes, 4Ps Household ID:</label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.FourPsHouseholdId" disabled="@(EditModel.Is4PsBeneficiary != "Yes")" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @(string.IsNullOrEmpty(StudentData.FourPsHouseholdId) ? "N/A" : StudentData.FourPsHouseholdId)
                        </div>
                    }
                </div>
            </div>

        </div>

        <hr class="my-6 sm:my-8 border-gray-200" />

        <!-- Current Address Section -->
        <div class="mb-6">
            <h2 class="text-lg sm:text-xl font-bold text-blue-600 mb-4 sm:mb-6">Current Address</h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-3 sm:mb-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">House No./Street</label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.CurrentHouseNo" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @(string.IsNullOrEmpty(StudentData.CurrentHouseNo) ? "N/A" : StudentData.CurrentHouseNo)
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Street Name</label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.CurrentStreetName" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @(string.IsNullOrEmpty(StudentData.CurrentStreetName) ? "N/A" : StudentData.CurrentStreetName)
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Barangay <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <select @bind="EditModel.CurrentBarangay" @bind:after="StateHasChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="">Select Barangay</option>
                            @foreach (var barangay in AvailableBarangays)
                            {
                                <option value="@barangay">@barangay</option>
                            }
                        </select>
                    }
                    else
                    {
                        <div class="relative">
                            <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                                @StudentData.CurrentBarangay
                            </div>
                            <svg class="absolute right-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    }
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Municipality/City <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <select @bind="EditModel.CurrentCity" @bind:after="OnCurrentCityChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="">Select City</option>
                            @foreach (var city in AvailableCities)
                            {
                                <option value="@city">@city</option>
                            }
                        </select>
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.CurrentCity
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Province <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <select @bind="EditModel.CurrentProvince" @bind:after="OnCurrentProvinceChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="">Select Province</option>
                            @foreach (var province in AvailableProvinces)
                            {
                                <option value="@province">@province</option>
                            }
                        </select>
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.CurrentProvince
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Country <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <select @bind="EditModel.CurrentCountry" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="Philippines">Philippines</option>
                            <option value="Other">Other</option>
                        </select>
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.CurrentCountry
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        ZIP Code <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.CurrentZipCode" maxlength="10" onkeypress="return /[0-9]/i.test(event.key) || event.key === 'Backspace' || event.key === 'Delete' || event.key === 'ArrowLeft' || event.key === 'ArrowRight'" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.CurrentZipCode
                        </div>
                    }
                </div>
            </div>
        </div>

        <hr class="my-6 sm:my-8 border-gray-200" />

        <!-- Permanent Address Section -->
        <div class="mb-6">
            <h2 class="text-lg sm:text-xl font-bold text-blue-600 mb-4 sm:mb-6">Permanent Address</h2>
            
            <div class="mb-3 sm:mb-4">
                <label class="flex items-center">
                    <input type="checkbox" checked="@(IsEditing ? EditModel.SameAsCurrentAddress : StudentData.SameAsCurrentAddress)" 
                           @onchange="@((ChangeEventArgs e) => { if (IsEditing) { EditModel.SameAsCurrentAddress = (bool)(e.Value ?? false); OnSameAsCurrentAddressChanged(); } })" 
                           disabled="@(!IsEditing)"
                           class="w-4 h-4 text-blue-600 border-gray-300 rounded" />
                    <span class="ml-2 text-xs sm:text-sm font-medium text-gray-700">Same with your current Address?</span>
                </label>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 mb-3 sm:mb-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">House No./Street</label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.PermanentHouseNo" disabled="@EditModel.SameAsCurrentAddress" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @(string.IsNullOrEmpty(StudentData.PermanentHouseNo) ? "N/A" : StudentData.PermanentHouseNo)
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Street Name</label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.PermanentStreetName" disabled="@EditModel.SameAsCurrentAddress" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @(string.IsNullOrEmpty(StudentData.PermanentStreetName) ? "N/A" : StudentData.PermanentStreetName)
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Barangay <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <select @bind="EditModel.PermanentBarangay" @bind:after="StateHasChanged" disabled="@EditModel.SameAsCurrentAddress" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed">
                            <option value="">Select Barangay</option>
                            @foreach (var barangay in PermanentBarangays)
                            {
                                <option value="@barangay">@barangay</option>
                            }
                        </select>
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.PermanentBarangay
                        </div>
                    }
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Municipality/City <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <select @bind="EditModel.PermanentCity" @bind:after="OnPermanentCityChanged" disabled="@EditModel.SameAsCurrentAddress" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed">
                            <option value="">Select City</option>
                            @foreach (var city in PermanentCities)
                            {
                                <option value="@city">@city</option>
                            }
                        </select>
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.PermanentCity
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Province <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <select @bind="EditModel.PermanentProvince" @bind:after="OnPermanentProvinceChanged" disabled="@EditModel.SameAsCurrentAddress" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed">
                            <option value="">Select Province</option>
                            @foreach (var province in AvailableProvinces)
                            {
                                <option value="@province">@province</option>
                            }
                        </select>
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.PermanentProvince
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Country <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <select @bind="EditModel.PermanentCountry" disabled="@EditModel.SameAsCurrentAddress" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed">
                            <option value="Philippines">Philippines</option>
                            <option value="Other">Other</option>
                        </select>
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.PermanentCountry
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        ZIP Code <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.PermanentZipCode" disabled="@EditModel.SameAsCurrentAddress" maxlength="10" onkeypress="return /[0-9]/i.test(event.key) || event.key === 'Backspace' || event.key === 'Delete' || event.key === 'ArrowLeft' || event.key === 'ArrowRight'" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.PermanentZipCode
                        </div>
                    }
                </div>
            </div>
        </div>

        <hr class="my-6 sm:my-8 border-gray-200" />

        <!-- Guardian Information Section -->
        <div class="mb-6">
            <h2 class="text-lg sm:text-xl font-bold text-blue-600 mb-4 sm:mb-6">Guardian Information</h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-3 sm:mb-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        First Name <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.GuardianFirstName" @bind:after="() => { FormatGuardianFirstName(); StateHasChanged(); }" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.GuardianFirstName
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Middle Name</label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.GuardianMiddleName" @bind:after="FormatGuardianMiddleName" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @(string.IsNullOrEmpty(StudentData.GuardianMiddleName) ? "N/A" : StudentData.GuardianMiddleName)
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Last Name <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.GuardianLastName" @bind:after="() => { FormatGuardianLastName(); StateHasChanged(); }" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.GuardianLastName
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Contact Number <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.GuardianContactNumber" maxlength="11" onkeypress="return /[0-9]/i.test(event.key) || event.key === 'Backspace' || event.key === 'Delete' || event.key === 'ArrowLeft' || event.key === 'ArrowRight'" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="e.g. 09123456789" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.GuardianContactNumber
                        </div>
                    }
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Relationship <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <select @bind="EditModel.GuardianRelationship" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="">Select Relationship</option>
                            @foreach (var relationship in RelationshipOptions)
                            {
                                <option value="@relationship">@relationship</option>
                            }
                        </select>
                    }
                    else
                    {
                        <div class="relative">
                            <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                                @(string.IsNullOrEmpty(StudentData.GuardianRelationship) ? "N/A" : StudentData.GuardianRelationship)
                            </div>
                            <svg class="absolute right-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    }
                </div>
            </div>
        </div>

        <hr class="my-6 sm:my-8 border-gray-200" />

        <!-- Enrollment Details Section -->
        <div>
            <h2 class="text-lg sm:text-xl font-bold text-blue-600 mb-4 sm:mb-6">Enrollment Details</h2>
            
            <div class="mb-4 sm:mb-6">
                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2 sm:mb-3">
                    Student Type <span class="text-red-500">*</span>
                </label>
                <div class="flex flex-wrap gap-4 sm:gap-6">
                    <label class="flex items-center">
                        <input type="radio" checked="@(StudentData.StudentType == "New Student")" disabled class="w-4 h-4 text-blue-600 border-gray-300" />
                        <span class="ml-2 text-xs sm:text-sm text-gray-700">New Student</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" checked="@(StudentData.StudentType == "Returnee")" disabled class="w-4 h-4 text-blue-600 border-gray-300" />
                        <span class="ml-2 text-xs sm:text-sm text-gray-700">Returnee</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" checked="@(StudentData.StudentType == "Transferee")" disabled class="w-4 h-4 text-blue-600 border-gray-300" />
                        <span class="ml-2 text-xs sm:text-sm text-gray-700">Transferee</span>
                    </label>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">With LRN?</label>
                    <div class="flex items-center gap-3 sm:gap-4 pt-1 sm:pt-2">
                        <label class="flex items-center">
                            <input type="radio" checked="@(IsEditing ? EditModel.HasLRN == "Yes" : StudentData.HasLRN == "Yes")" 
                                   @onchange="@(() => { if (IsEditing) { EditModel.HasLRN = "Yes"; HandleHasLRNChange(); } })" 
                                   disabled="@(!IsEditing)"
                                   class="w-4 h-4 text-blue-600 border-gray-300" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">Yes</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" checked="@(IsEditing ? EditModel.HasLRN == "No" : StudentData.HasLRN == "No")" 
                                   @onchange="@(() => { if (IsEditing) { EditModel.HasLRN = "No"; HandleHasLRNChange(); } })" 
                                   disabled="@(!IsEditing)"
                                   class="w-4 h-4 text-blue-600 border-gray-300" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">No</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Learner Reference No. <span class="text-red-500">*</span>
                    </label>
                    @if (IsEditing)
                    {
                        <input type="text" @bind="EditModel.LearnerReferenceNo" @bind:after="() => { HandleLRNChange(); StateHasChanged(); }" disabled="@(EditModel.HasLRN != "Yes")" maxlength="12" onkeypress="return /[0-9]/i.test(event.key)" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="e.g. 123456789012" />
                    }
                    else
                    {
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base @(StudentData.LearnerReferenceNo == "N/A" ? "text-gray-500" : "text-gray-700")">
                            @(string.IsNullOrEmpty(StudentData.LearnerReferenceNo) ? "Pending" : StudentData.LearnerReferenceNo)
                        </div>
                    }
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        School year <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.SchoolYear
                        </div>
                        <svg class="absolute right-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                        Grade to Enroll <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 sm:px-4 sm:py-2.5 text-sm sm:text-base text-gray-700">
                            @StudentData.GradeToEnroll
                        </div>
                        <svg class="absolute right-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 sm:p-4">
                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2 sm:mb-3">
                    Requirements
                </label>

                @* Show only the requirement groups that apply based on Student Type *@

                @if (IsNewStudent || IsTransferee)
                {
                    <!-- New Student Requirements -->
                    <p class="mb-2 text-[11px] font-semibold uppercase text-gray-500">New / Transferee</p>
                    <div class="space-y-1.5 sm:space-y-2 mb-3">
                        <label class="flex items-center">
                            <input type="checkbox" checked="@(IsEditing ? EditModel.HasPSABirthCert : StudentData.HasPSABirthCert)" 
                                   @onchange="@((ChangeEventArgs e) => { if (IsEditing) EditModel.HasPSABirthCert = (bool)(e.Value ?? false); })"
                                   disabled="@(!IsEditing)" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">PSA Birth Certificate</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" checked="@(IsEditing ? EditModel.HasBaptismalCert : StudentData.HasBaptismalCert)" 
                                   @onchange="@((ChangeEventArgs e) => { if (IsEditing) EditModel.HasBaptismalCert = (bool)(e.Value ?? false); })"
                                   disabled="@(!IsEditing)" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">Baptismal Certificate</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" checked="@(IsEditing ? EditModel.HasReportCard : StudentData.HasReportCard)" 
                                   @onchange="@((ChangeEventArgs e) => { if (IsEditing) EditModel.HasReportCard = (bool)(e.Value ?? false); })"
                                   disabled="@(!IsEditing)" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">Report Card</span>
                        </label>
                    </div>
                }

                @if (IsTransferee)
                {
                    <!-- Transferee Only Requirements -->
                    <p class="mb-2 text-[11px] font-semibold uppercase text-gray-500">Transferee</p>
                    <div class="space-y-1.5 sm:space-y-2 mb-3">
                        <label class="flex items-center">
                            <input type="checkbox" checked="@(IsEditing ? EditModel.HasForm138 : StudentData.HasForm138)" 
                                   @onchange="@((ChangeEventArgs e) => { if (IsEditing) EditModel.HasForm138 = (bool)(e.Value ?? false); })"
                                   disabled="@(!IsEditing)" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">Form 138 (Report Card)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" checked="@(IsEditing ? EditModel.HasForm137 : StudentData.HasForm137)" 
                                   @onchange="@((ChangeEventArgs e) => { if (IsEditing) EditModel.HasForm137 = (bool)(e.Value ?? false); })"
                                   disabled="@(!IsEditing)" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">Form 137 (Permanent Record)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" checked="@(IsEditing ? EditModel.HasGoodMoralCert : StudentData.HasGoodMoralCert)" 
                                   @onchange="@((ChangeEventArgs e) => { if (IsEditing) EditModel.HasGoodMoralCert = (bool)(e.Value ?? false); })"
                                   disabled="@(!IsEditing)" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">Good Moral Certificate</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" checked="@(IsEditing ? EditModel.HasTransferCert : StudentData.HasTransferCert)" 
                                   @onchange="@((ChangeEventArgs e) => { if (IsEditing) EditModel.HasTransferCert = (bool)(e.Value ?? false); })"
                                   disabled="@(!IsEditing)" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">Transfer Certificate</span>
                        </label>
                    </div>
                }

                @* Only show returnee-specific requirements if student was originally a returnee *@
                @* For students who were originally "New Student" or "Transferee" but are now "Returnee", 
                   these requirements should only be validated in "For Enrollment" tab, not shown here *@
                @{
                    var wasOriginallyReturnee = string.Equals(StudentData.OriginalStudentType ?? StudentData.StudentType, "Returnee", StringComparison.OrdinalIgnoreCase);
                }
                @if (IsReturnee && wasOriginallyReturnee)
                {
                    <!-- Returnee Requirements (only if originally a returnee) -->
                    <p class="mb-2 text-[11px] font-semibold uppercase text-gray-500">Returnee</p>
                    <div class="space-y-1.5 sm:space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" checked="@(IsEditing ? EditModel.HasUpdatedEnrollmentForm : StudentData.HasUpdatedEnrollmentForm)" 
                                   @onchange="@((ChangeEventArgs e) => { if (IsEditing) EditModel.HasUpdatedEnrollmentForm = (bool)(e.Value ?? false); })"
                                   disabled="@(!IsEditing)" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">Updated Enrollment Form</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" checked="@(IsEditing ? EditModel.HasClearance : StudentData.HasClearance)" 
                                   @onchange="@((ChangeEventArgs e) => { if (IsEditing) EditModel.HasClearance = (bool)(e.Value ?? false); })"
                                   disabled="@(!IsEditing)" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded" />
                            <span class="ml-2 text-xs sm:text-sm text-gray-700">Clearance</span>
                        </label>
                    </div>
                }
            </div>
        </div>
        
        @if (IsEditing)
        {
            <div class="mt-6 flex justify-end gap-3 border-t border-gray-200 pt-4 px-6 pb-6">
                <button @onclick="HandleCancelClick" class="flex items-center justify-center gap-2 rounded-lg bg-gray-500 px-4 py-2 font-semibold text-white shadow-md transition-all duration-300 hover:bg-gray-600 hover:shadow-lg" style="font-size: 13px;">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Cancel
                </button>
                <button @onclick="HandleUpdateClick" disabled="@IsSaving" class="flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 py-2 font-semibold text-white shadow-md transition-all duration-300 hover:bg-blue-700 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" style="font-size: 13px;">
                    @if (IsSaving)
                    {
                        <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                        </svg>
                        <span>Update</span>
                    }
                </button>
            </div>
        }
    </div>
</div>

<!-- Cancel Confirmation Modal -->
@if (ShowCancelConfirmModal)
{
    <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-50" @onclick="CloseCancelConfirmModal">
        <div id="student-info-cancel-modal" class="w-full max-w-md rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <div class="flex items-center justify-between rounded-t-2xl bg-white px-6 py-2.5 border-b border-gray-200">
                <h3 class="text-base font-semibold text-yellow-600">Discard Changes?</h3>
                <button @onclick="CloseCancelConfirmModal" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="px-6 py-4">
                <p class="text-sm text-gray-700">You have unsaved changes. Are you sure you want to cancel? All changes will be lost.</p>
            </div>
            <div class="flex justify-end gap-2 border-t border-gray-200 px-6 py-3">
                <button @onclick="CloseCancelConfirmModal" class="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50">
                    No, Keep Editing
                </button>
                <button @onclick="ConfirmCancel" class="rounded-lg bg-yellow-500 px-3 py-1.5 text-sm font-medium text-white hover:bg-yellow-600">
                    Yes, Discard Changes
                </button>
            </div>
        </div>
    </div>
}

<!-- Update Confirmation Modal -->
@if (ShowUpdateConfirmModal)
{
    <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-50" @onclick="CloseUpdateConfirmModal">
        <div id="student-info-update-modal" class="w-full max-w-md rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <div class="flex items-center justify-between rounded-t-2xl bg-white px-6 py-2.5 border-b border-gray-200">
                <h3 class="text-base font-semibold text-blue-600">Confirm Update</h3>
                <button @onclick="CloseUpdateConfirmModal" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="px-6 py-4">
                <p class="text-sm text-gray-700">Are you sure you want to update the student information?</p>
            </div>
            <div class="flex justify-end gap-2 border-t border-gray-200 px-6 py-3">
                <button @onclick="CloseUpdateConfirmModal" class="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button @onclick="ConfirmUpdate" class="rounded-lg bg-blue-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-blue-700">
                    Confirm Update
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public StudentDetailData StudentData { get; set; } = new();

    [Parameter]
    public EventCallback<StudentDetailData> OnStudentUpdated { get; set; }

    [Parameter]
    public EventCallback<bool> OnEditingStateChanged { get; set; }

    private bool IsEditing { get; set; } = false;
    private StudentEditModel EditModel { get; set; } = new();
    private bool IsSaving { get; set; } = false;
    private string? ErrorMessage { get; set; }
    private string? SuccessMessage { get; set; }

    // Address dropdowns
    private List<string> AvailableProvinces { get; set; } = new();
    private List<string> AvailableCities { get; set; } = new();
    private List<string> AvailableBarangays { get; set; } = new();
    private List<string> PermanentCities { get; set; } = new();
    private List<string> PermanentBarangays { get; set; } = new();

    // Suffix options
    private readonly List<string> SuffixOptions = new() { "N/A", "Jr.", "Sr.", "II", "III", "IV" };

    // Mother tongue options
    private readonly List<string> MotherTongueOptions = new() { "Tagalog", "Cebuano", "Ilocano", "Hiligaynon", "Bicol", "Waray", "Kapampangan", "Pangasinan", "Other" };

    // Relationship options
    private readonly List<string> RelationshipOptions = new() { "Father", "Mother", "Guardian", "Grandfather", "Grandmother", "Uncle", "Aunt", "Other" };

    private bool IsNewStudent => string.Equals(StudentData.StudentType, "New Student", StringComparison.OrdinalIgnoreCase);
    private bool IsTransferee => string.Equals(StudentData.StudentType, "Transferee", StringComparison.OrdinalIgnoreCase);
    private bool IsReturnee => string.Equals(StudentData.StudentType, "Returnee", StringComparison.OrdinalIgnoreCase);

    protected override void OnInitialized()
    {
        AvailableProvinces = AddressService.GetAllProvinces();
        InitializeAddressData();
    }

    protected override void OnParametersSet()
    {
        if (!IsEditing)
        {
            InitializeAddressData();
        }
    }

    private void InitializeAddressData()
    {
        // Initialize EditModel with current StudentData for address dropdowns
        EditModel = new StudentEditModel
        {
            CurrentProvince = StudentData.CurrentProvince,
            CurrentCity = StudentData.CurrentCity,
            CurrentBarangay = StudentData.CurrentBarangay,
            PermanentProvince = StudentData.PermanentProvince,
            PermanentCity = StudentData.PermanentCity,
            PermanentBarangay = StudentData.PermanentBarangay
        };
        
        LoadCities();
        LoadBarangays();
        LoadPermanentCities();
        LoadPermanentBarangays();
    }

    private StudentEditModel OriginalEditModel { get; set; } = new();
    private bool HasUnsavedChanges => IsEditing && !AreModelsEqual(OriginalEditModel, EditModel);
    
    private bool AreModelsEqual(StudentEditModel original, StudentEditModel current)
    {
        return original.FirstName == current.FirstName &&
               original.MiddleName == current.MiddleName &&
               original.LastName == current.LastName &&
               original.Suffix == current.Suffix &&
               original.BirthDate == current.BirthDate &&
               original.PlaceOfBirth == current.PlaceOfBirth &&
               original.Sex == current.Sex &&
               original.MotherTongue == current.MotherTongue &&
               original.IsIPCommunity == current.IsIPCommunity &&
               original.IPCommunitySpecify == current.IPCommunitySpecify &&
               original.Is4PsBeneficiary == current.Is4PsBeneficiary &&
               original.FourPsHouseholdId == current.FourPsHouseholdId &&
               original.CurrentHouseNo == current.CurrentHouseNo &&
               original.CurrentStreetName == current.CurrentStreetName &&
               original.CurrentBarangay == current.CurrentBarangay &&
               original.CurrentCity == current.CurrentCity &&
               original.CurrentProvince == current.CurrentProvince &&
               original.CurrentCountry == current.CurrentCountry &&
               original.CurrentZipCode == current.CurrentZipCode &&
               original.SameAsCurrentAddress == current.SameAsCurrentAddress &&
               original.PermanentHouseNo == current.PermanentHouseNo &&
               original.PermanentStreetName == current.PermanentStreetName &&
               original.PermanentBarangay == current.PermanentBarangay &&
               original.PermanentCity == current.PermanentCity &&
               original.PermanentProvince == current.PermanentProvince &&
               original.PermanentCountry == current.PermanentCountry &&
               original.PermanentZipCode == current.PermanentZipCode &&
               original.GuardianFirstName == current.GuardianFirstName &&
               original.GuardianMiddleName == current.GuardianMiddleName &&
               original.GuardianLastName == current.GuardianLastName &&
               original.GuardianSuffix == current.GuardianSuffix &&
               original.GuardianContactNumber == current.GuardianContactNumber &&
               original.GuardianRelationship == current.GuardianRelationship &&
               original.LearnerReferenceNo == current.LearnerReferenceNo &&
               // Requirements
               original.HasPSABirthCert == current.HasPSABirthCert &&
               original.HasBaptismalCert == current.HasBaptismalCert &&
               original.HasReportCard == current.HasReportCard &&
               original.HasForm138 == current.HasForm138 &&
               original.HasForm137 == current.HasForm137 &&
               original.HasGoodMoralCert == current.HasGoodMoralCert &&
               original.HasTransferCert == current.HasTransferCert &&
               original.HasUpdatedEnrollmentForm == current.HasUpdatedEnrollmentForm &&
               original.HasClearance == current.HasClearance;
    }

    private async Task EnableEditMode()
    {
        IsEditing = true;
        ErrorMessage = null;
        SuccessMessage = null;
        
        if (OnEditingStateChanged.HasDelegate)
        {
            await OnEditingStateChanged.InvokeAsync(true);
        }
        
        // Initialize edit model from StudentData
        EditModel = new StudentEditModel
        {
            StudentId = StudentData.Id,
            FirstName = StudentData.FirstName,
            MiddleName = StudentData.MiddleName,
            LastName = StudentData.LastName,
            Suffix = StudentData.Suffix,
            BirthDate = StudentData.BirthDate ?? DateTime.Now.AddYears(-10),
            Age = StudentData.BirthDate.HasValue ? (int)((DateTime.Now - StudentData.BirthDate.Value).TotalDays / 365.25) : 10,
            PlaceOfBirth = StudentData.PlaceOfBirth,
            Sex = StudentData.Sex,
            MotherTongue = StudentData.MotherTongue,
            IsIPCommunity = StudentData.IsIPCommunity,
            IPCommunitySpecify = StudentData.IPCommunitySpecify,
            Is4PsBeneficiary = StudentData.Is4PsBeneficiary,
            FourPsHouseholdId = StudentData.FourPsHouseholdId,
            CurrentHouseNo = StudentData.CurrentHouseNo,
            CurrentStreetName = StudentData.CurrentStreetName,
            CurrentBarangay = StudentData.CurrentBarangay,
            CurrentCity = StudentData.CurrentCity,
            CurrentProvince = StudentData.CurrentProvince,
            CurrentCountry = StudentData.CurrentCountry,
            CurrentZipCode = StudentData.CurrentZipCode,
            SameAsCurrentAddress = StudentData.SameAsCurrentAddress,
            PermanentHouseNo = StudentData.PermanentHouseNo,
            PermanentStreetName = StudentData.PermanentStreetName,
            PermanentBarangay = StudentData.PermanentBarangay,
            PermanentCity = StudentData.PermanentCity,
            PermanentProvince = StudentData.PermanentProvince,
            PermanentCountry = StudentData.PermanentCountry,
            PermanentZipCode = StudentData.PermanentZipCode,
            GuardianFirstName = StudentData.GuardianFirstName,
            GuardianMiddleName = StudentData.GuardianMiddleName,
            GuardianLastName = StudentData.GuardianLastName,
            GuardianSuffix = StudentData.GuardianSuffix,
            GuardianContactNumber = StudentData.GuardianContactNumber,
            GuardianRelationship = StudentData.GuardianRelationship,
            StudentType = StudentData.StudentType,
            HasLRN = StudentData.HasLRN,
            LearnerReferenceNo = StudentData.LearnerReferenceNo == "N/A" ? "" : StudentData.LearnerReferenceNo,
            GradeToEnroll = StudentData.GradeToEnroll,
            SchoolYear = StudentData.SchoolYear,
            Status = StudentData.Status,
            // Requirements
            HasPSABirthCert = StudentData.HasPSABirthCert,
            HasBaptismalCert = StudentData.HasBaptismalCert,
            HasReportCard = StudentData.HasReportCard,
            HasForm138 = StudentData.HasForm138,
            HasForm137 = StudentData.HasForm137,
            HasGoodMoralCert = StudentData.HasGoodMoralCert,
            HasTransferCert = StudentData.HasTransferCert,
            HasUpdatedEnrollmentForm = StudentData.HasUpdatedEnrollmentForm,
            HasClearance = StudentData.HasClearance
        };

        // Store original values for comparison
        OriginalEditModel = new StudentEditModel
        {
            StudentId = EditModel.StudentId,
            FirstName = EditModel.FirstName,
            MiddleName = EditModel.MiddleName,
            LastName = EditModel.LastName,
            Suffix = EditModel.Suffix,
            BirthDate = EditModel.BirthDate,
            Age = EditModel.Age,
            PlaceOfBirth = EditModel.PlaceOfBirth,
            Sex = EditModel.Sex,
            MotherTongue = EditModel.MotherTongue,
            IsIPCommunity = EditModel.IsIPCommunity,
            IPCommunitySpecify = EditModel.IPCommunitySpecify,
            Is4PsBeneficiary = EditModel.Is4PsBeneficiary,
            FourPsHouseholdId = EditModel.FourPsHouseholdId,
            CurrentHouseNo = EditModel.CurrentHouseNo,
            CurrentStreetName = EditModel.CurrentStreetName,
            CurrentBarangay = EditModel.CurrentBarangay,
            CurrentCity = EditModel.CurrentCity,
            CurrentProvince = EditModel.CurrentProvince,
            CurrentCountry = EditModel.CurrentCountry,
            CurrentZipCode = EditModel.CurrentZipCode,
            SameAsCurrentAddress = EditModel.SameAsCurrentAddress,
            PermanentHouseNo = EditModel.PermanentHouseNo,
            PermanentStreetName = EditModel.PermanentStreetName,
            PermanentBarangay = EditModel.PermanentBarangay,
            PermanentCity = EditModel.PermanentCity,
            PermanentProvince = EditModel.PermanentProvince,
            PermanentCountry = EditModel.PermanentCountry,
            PermanentZipCode = EditModel.PermanentZipCode,
            GuardianFirstName = EditModel.GuardianFirstName,
            GuardianMiddleName = EditModel.GuardianMiddleName,
            GuardianLastName = EditModel.GuardianLastName,
            GuardianSuffix = EditModel.GuardianSuffix,
            GuardianContactNumber = EditModel.GuardianContactNumber,
            GuardianRelationship = EditModel.GuardianRelationship,
            LearnerReferenceNo = EditModel.LearnerReferenceNo,
            // Requirements
            HasPSABirthCert = EditModel.HasPSABirthCert,
            HasBaptismalCert = EditModel.HasBaptismalCert,
            HasReportCard = EditModel.HasReportCard,
            HasForm138 = EditModel.HasForm138,
            HasForm137 = EditModel.HasForm137,
            HasGoodMoralCert = EditModel.HasGoodMoralCert,
            HasTransferCert = EditModel.HasTransferCert,
            HasUpdatedEnrollmentForm = EditModel.HasUpdatedEnrollmentForm,
            HasClearance = EditModel.HasClearance
        };

        LoadCities();
        LoadBarangays();
        LoadPermanentCities();
        LoadPermanentBarangays();
        StateHasChanged();
    }

    // Confirmation modal state
    private bool ShowCancelConfirmModal { get; set; } = false;
    private bool ShowUpdateConfirmModal { get; set; } = false;

    private async Task HandleCancelClick()
    {
        if (HasUnsavedChanges)
        {
            ShowCancelConfirmModal = true;
            StateHasChanged();
        }
        else
        {
            await CancelEdit();
        }
    }

    private void HandleUpdateClick()
    {
        if (HasUnsavedChanges)
        {
            ShowUpdateConfirmModal = true;
            StateHasChanged();
        }
        else
        {
            // No changes, just close edit mode
            IsEditing = false;
            StateHasChanged();
        }
    }

    private void CloseCancelConfirmModal()
    {
        ShowCancelConfirmModal = false;
        StateHasChanged();
    }

    private void CloseUpdateConfirmModal()
    {
        ShowUpdateConfirmModal = false;
        StateHasChanged();
    }

    private async Task ConfirmCancel()
    {
        ShowCancelConfirmModal = false;
        await CancelEdit();
    }

    private async Task ConfirmUpdate()
    {
        ShowUpdateConfirmModal = false;
        await SaveChanges();
    }

    private async Task CancelEdit()
    {
        IsEditing = false;
        EditModel = new StudentEditModel();
        OriginalEditModel = new StudentEditModel();
        ErrorMessage = null;
        SuccessMessage = null;
        
        if (OnEditingStateChanged.HasDelegate)
        {
            await OnEditingStateChanged.InvokeAsync(false);
        }
        
        StateHasChanged();
    }

    private async Task SaveChanges()
    {
        if (IsSaving) return;

        IsSaving = true;
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            await StudentService.UpdateStudentAsync(EditModel);
            
            // Small delay to ensure database changes are committed
            await Task.Delay(100);
            
            // Reload student data from database to ensure we have the latest information
            // This ensures we get any computed values or related data that may have changed
            var updatedEntity = await StudentService.GetStudentByIdAsync(EditModel.StudentId);
            
            if (updatedEntity != null)
            {
                // Rebuild StudentData from the reloaded entity
                var fullName = $"{updatedEntity.FirstName} {updatedEntity.MiddleName} {updatedEntity.LastName}"
                    .Replace("  ", " ")
                    .Trim();
                
                var hasRealLrn = !string.IsNullOrWhiteSpace(updatedEntity.Lrn);
                var rawLrn = updatedEntity.Lrn ?? string.Empty;
                
                var latestEnrollment = updatedEntity.SectionEnrollments
                    .OrderByDescending(e => e.CreatedAt)
                    .FirstOrDefault();
                
                var sectionName = latestEnrollment?.Section?.SectionName ?? string.Empty;
                var gradeLevelName = latestEnrollment?.Section?.GradeLevel?.GradeLevelName ?? updatedEntity.GradeLevel ?? string.Empty;
                var schoolYear = latestEnrollment?.SchoolYear ?? updatedEntity.SchoolYr ?? string.Empty;
                
                // Update StudentData with fresh data from database
                StudentData.FirstName = updatedEntity.FirstName;
                StudentData.MiddleName = updatedEntity.MiddleName ?? string.Empty;
                StudentData.LastName = updatedEntity.LastName;
                StudentData.Suffix = updatedEntity.Suffix ?? string.Empty;
                StudentData.BirthDate = updatedEntity.Birthdate;
                StudentData.PlaceOfBirth = updatedEntity.PlaceOfBirth ?? string.Empty;
                StudentData.Sex = updatedEntity.Sex;
                StudentData.MotherTongue = updatedEntity.MotherTongue ?? string.Empty;
                StudentData.IsIPCommunity = updatedEntity.IpComm ? "Yes" : "No";
                StudentData.IPCommunitySpecify = updatedEntity.IpSpecify ?? string.Empty;
                StudentData.Is4PsBeneficiary = updatedEntity.FourPs ? "Yes" : "No";
                StudentData.FourPsHouseholdId = updatedEntity.FourPsHseId ?? string.Empty;
                StudentData.CurrentHouseNo = updatedEntity.HseNo ?? string.Empty;
                StudentData.CurrentStreetName = updatedEntity.Street ?? string.Empty;
                StudentData.CurrentBarangay = updatedEntity.Brngy ?? string.Empty;
                StudentData.CurrentCity = updatedEntity.City ?? string.Empty;
                StudentData.CurrentProvince = updatedEntity.Province ?? string.Empty;
                StudentData.CurrentCountry = updatedEntity.Country ?? string.Empty;
                StudentData.CurrentZipCode = updatedEntity.ZipCode ?? string.Empty;
                StudentData.PermanentHouseNo = updatedEntity.PhseNo ?? string.Empty;
                StudentData.PermanentStreetName = updatedEntity.Pstreet ?? string.Empty;
                StudentData.PermanentBarangay = updatedEntity.Pbrngy ?? string.Empty;
                StudentData.PermanentCity = updatedEntity.Pcity ?? string.Empty;
                StudentData.PermanentProvince = updatedEntity.Pprovince ?? string.Empty;
                StudentData.PermanentCountry = updatedEntity.Pcountry ?? string.Empty;
                StudentData.PermanentZipCode = updatedEntity.PzipCode ?? string.Empty;
                StudentData.GuardianFirstName = updatedEntity.Guardian?.FirstName ?? string.Empty;
                StudentData.GuardianMiddleName = updatedEntity.Guardian?.MiddleName ?? string.Empty;
                StudentData.GuardianLastName = updatedEntity.Guardian?.LastName ?? string.Empty;
                StudentData.GuardianSuffix = updatedEntity.Guardian?.Suffix ?? string.Empty;
                StudentData.GuardianContactNumber = updatedEntity.Guardian?.ContactNum ?? string.Empty;
                StudentData.GuardianRelationship = updatedEntity.Guardian?.Relationship ?? string.Empty;
                StudentData.FullName = fullName;
                StudentData.GradeLevel = gradeLevelName;
                StudentData.Section = sectionName;
                StudentData.SchoolYear = schoolYear;
                StudentData.Status = updatedEntity.Status;
                StudentData.LRN = hasRealLrn ? rawLrn : "N/A";
                StudentData.HasLRN = hasRealLrn ? "Yes" : "No";
                StudentData.LearnerReferenceNo = hasRealLrn ? rawLrn : "N/A";
                StudentData.StudentType = updatedEntity.StudentType;
                StudentData.GradeToEnroll = gradeLevelName;
                
                // Update requirements from the entity
                StudentData.HasPSABirthCert = updatedEntity.Requirements?.Any(r => r.RequirementName == "PSA Birth Certificate") ?? false;
                StudentData.HasBaptismalCert = updatedEntity.Requirements?.Any(r => r.RequirementName == "Baptismal Certificate") ?? false;
                StudentData.HasReportCard = updatedEntity.Requirements?.Any(r => r.RequirementName == "Report Card") ?? false;
                StudentData.HasForm138 = updatedEntity.Requirements?.Any(r => r.RequirementName == "Form 138 (Report Card)") ?? false;
                StudentData.HasForm137 = updatedEntity.Requirements?.Any(r => r.RequirementName == "Form 137 (Permanent Record)") ?? false;
                StudentData.HasGoodMoralCert = updatedEntity.Requirements?.Any(r => r.RequirementName == "Good Moral Certificate") ?? false;
                StudentData.HasTransferCert = updatedEntity.Requirements?.Any(r => r.RequirementName == "Transfer Certificate") ?? false;
                StudentData.HasUpdatedEnrollmentForm = updatedEntity.Requirements?.Any(r => r.RequirementName == "Updated Enrollment Form") ?? false;
                StudentData.HasClearance = updatedEntity.Requirements?.Any(r => r.RequirementName == "Clearance") ?? false;
            }

            SuccessMessage = "Student information updated successfully!";
            IsEditing = false;
            OriginalEditModel = new StudentEditModel();

            if (OnEditingStateChanged.HasDelegate)
            {
                await OnEditingStateChanged.InvokeAsync(false);
            }

            // Notify parent component with updated data
            await OnStudentUpdated.InvokeAsync(StudentData);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error updating student: {ex.Message}";
        }
        finally
        {
            IsSaving = false;
            StateHasChanged();
        }
    }

    private void LoadCities()
    {
        if (!string.IsNullOrWhiteSpace(EditModel.CurrentProvince))
        {
            AvailableCities = AddressService.GetCitiesByProvince(EditModel.CurrentProvince);
        }
        else
        {
            AvailableCities = new List<string>();
        }
    }

    private void LoadBarangays()
    {
        if (!string.IsNullOrWhiteSpace(EditModel.CurrentProvince) && !string.IsNullOrWhiteSpace(EditModel.CurrentCity))
        {
            AvailableBarangays = AddressService.GetBarangaysByCity(EditModel.CurrentCity, EditModel.CurrentProvince);
        }
        else
        {
            AvailableBarangays = new List<string>();
        }
    }

    private void LoadPermanentCities()
    {
        if (!string.IsNullOrWhiteSpace(EditModel.PermanentProvince))
        {
            PermanentCities = AddressService.GetCitiesByProvince(EditModel.PermanentProvince);
        }
        else
        {
            PermanentCities = new List<string>();
        }
    }

    private void LoadPermanentBarangays()
    {
        if (!string.IsNullOrWhiteSpace(EditModel.PermanentProvince) && !string.IsNullOrWhiteSpace(EditModel.PermanentCity))
        {
            PermanentBarangays = AddressService.GetBarangaysByCity(EditModel.PermanentCity, EditModel.PermanentProvince);
        }
        else
        {
            PermanentBarangays = new List<string>();
        }
    }

    private void OnCurrentProvinceChanged()
    {
        EditModel.CurrentCity = string.Empty;
        EditModel.CurrentBarangay = string.Empty;
        LoadCities();
        LoadBarangays();
        StateHasChanged();
    }

    private void OnCurrentCityChanged()
    {
        EditModel.CurrentBarangay = string.Empty;
        LoadBarangays();
        StateHasChanged();
    }

    private void OnPermanentProvinceChanged()
    {
        EditModel.PermanentCity = string.Empty;
        EditModel.PermanentBarangay = string.Empty;
        LoadPermanentCities();
        LoadPermanentBarangays();
        StateHasChanged();
    }

    private void OnPermanentCityChanged()
    {
        EditModel.PermanentBarangay = string.Empty;
        LoadPermanentBarangays();
        StateHasChanged();
    }

    private void OnSameAsCurrentAddressChanged()
    {
        if (EditModel.SameAsCurrentAddress)
        {
            EditModel.PermanentHouseNo = EditModel.CurrentHouseNo;
            EditModel.PermanentStreetName = EditModel.CurrentStreetName;
            EditModel.PermanentBarangay = EditModel.CurrentBarangay;
            EditModel.PermanentCity = EditModel.CurrentCity;
            EditModel.PermanentProvince = EditModel.CurrentProvince;
            EditModel.PermanentCountry = EditModel.CurrentCountry;
            EditModel.PermanentZipCode = EditModel.CurrentZipCode;
        }
        StateHasChanged();
    }

    // Format name to capitalize first letter of each word, rest lowercase
    private string FormatName(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return name;

        // Split by spaces and format each word
        var words = name.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
        var formattedWords = words.Select(word =>
        {
            if (string.IsNullOrEmpty(word))
                return word;
            
            // First letter uppercase, rest lowercase
            return char.ToUpper(word[0]) + word.Substring(1).ToLower();
        });

        return string.Join(" ", formattedWords);
    }

    // Name formatting handlers
    private void FormatFirstName()
    {
        if (EditModel != null)
        {
            EditModel.FirstName = FormatName(EditModel.FirstName);
        }
    }

    private void FormatMiddleName()
    {
        if (EditModel != null)
        {
            EditModel.MiddleName = FormatName(EditModel.MiddleName);
        }
    }

    private void FormatLastName()
    {
        if (EditModel != null)
        {
            EditModel.LastName = FormatName(EditModel.LastName);
        }
    }

    private void FormatGuardianFirstName()
    {
        if (EditModel != null)
        {
            EditModel.GuardianFirstName = FormatName(EditModel.GuardianFirstName);
        }
    }

    private void FormatGuardianMiddleName()
    {
        if (EditModel != null)
        {
            EditModel.GuardianMiddleName = FormatName(EditModel.GuardianMiddleName);
        }
    }

    private void FormatGuardianLastName()
    {
        if (EditModel != null)
        {
            EditModel.GuardianLastName = FormatName(EditModel.GuardianLastName);
        }
    }

    private void HandleHasLRNChange()
    {
        if (EditModel != null)
        {
            if (EditModel.HasLRN == "No")
            {
                EditModel.LearnerReferenceNo = "N/A";
            }
            else if (EditModel.HasLRN == "Yes" && EditModel.LearnerReferenceNo == "N/A")
            {
                EditModel.LearnerReferenceNo = string.Empty;
            }
        }
    }

    private void HandleLRNChange()
    {
        if (EditModel != null && EditModel.HasLRN == "No")
        {
            EditModel.LearnerReferenceNo = "N/A";
        }
    }

    private void HandleBirthDateChanged()
    {
        if (EditModel != null && EditModel.BirthDate != default)
        {
            var today = DateTime.Today;
            var age = today.Year - EditModel.BirthDate.Year;
            if (EditModel.BirthDate.Date > today.AddYears(-age))
            {
                age--;
            }
            EditModel.Age = age;
        }
    }
}
