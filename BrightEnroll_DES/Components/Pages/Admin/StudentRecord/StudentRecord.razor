@page "/student-record"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Components.Pages.Admin.StudentRecord.StudentRecordComponents
@using BrightEnroll_DES.Components.Pages.Admin.StudentRecord.StudentRecordCS
@using BrightEnroll_DES.Services.RoleBase
@using BrightEnroll_DES.Services.Business.Students
@using BrightEnroll_DES.Services.Business.Academic
@using BrightEnroll_DES.Components
@using BrightEnroll_DES.Data
@using BrightEnroll_DES.Data.Models
@inject BrightEnroll_DES.Services.RoleBase.IAuthorizationService AuthorizationService
@inject StudentService StudentService
@inject GradeService GradeService
@inject SchoolYearService SchoolYearService
@inject ArchiveService ArchiveService
@inject AppDbContext _context

<PageTitle>Student Record</PageTitle>

<RoleAuthorizeView RequiredPermission="@Permissions.ViewStudentRecord">

<div class="text-gray-800">
    <div class="mb-6 flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-800">Student Record</h1>
        @if (!string.IsNullOrEmpty(CurrentSchoolYear))
        {
            <div class="flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-4 py-2">
                <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span class="text-sm font-semibold text-blue-800">School Year: <span class="font-bold">@CurrentSchoolYear</span></span>
            </div>
        }
    </div>
    @if (ShowDetailView)
    {
        <StudentDetail StudentData="SelectedStudentData" AcademicRecords="SelectedAcademicRecords" EnrollmentRecords="SelectedEnrollmentRecords" OnBackClick="HandleBackClick" />
    }
    else
    {
    <!-- Card Container -->
    <div class="overflow-hidden rounded-xl bg-white shadow">
        <!-- Filters -->
        <div class="border-b border-gray-200 px-3 py-4 sm:px-6">
            <label class="mb-2 block text-sm font-bold text-gray-700">Filter:</label>
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                    <div class="relative flex w-full items-center sm:w-auto sm:min-w-[200px]">
                        <span class="absolute left-4 flex items-center justify-center">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </span>
                        <input type="text" placeholder="Search here..." @bind="SearchText" @bind:after="OnFilterChanged"
                               class="w-full rounded-lg border border-gray-300 py-2 pl-11 pr-4 text-sm text-gray-700 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400" />
                    </div>
                    <select @bind="SchoolYearFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                        <option value="all">All Years</option>
                        <option value="current">Current (@CurrentSchoolYear)</option>
                        @if (!string.IsNullOrEmpty(CurrentSchoolYear) && AvailableSchoolYears.Contains(CurrentSchoolYear))
                        {
                            <option value="@CurrentSchoolYear">@CurrentSchoolYear</option>
                        }
                        @foreach (var sy in AvailableSchoolYears.Where(sy => sy != CurrentSchoolYear))
                        {
                            <option value="@sy">@sy</option>
                        }
                    </select>
                    <select @bind="StatusFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                        <option value="all">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="For Payment">For Payment</option>
                        <option value="Partially Paid">Partially Paid</option>
                        <option value="Fully Paid">Fully Paid</option>
                        <option value="Enrolled">Enrolled</option>
                        <option value="Eligible">Eligible</option>
                    </select>
                    <select @bind="LrnStatusFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                        <option value="">LRN Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Assigned">Assigned</option>
                    </select>
                    <select @bind="DocumentStatusFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                        <option value="">Document Status</option>
                        <option value="Validated">Validated</option>
                        <option value="Not Validated">Not Validated</option>
                    </select>
                    <select @bind="GradeFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                        <option value="">Grade Level</option>
                        @foreach (var grade in AvailableGrades)
                        {
                            <option value="@grade">@grade</option>
                        }
                    </select>
                    <select @bind="SectionFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                        <option value="">Section</option>
                        @foreach (var secName in AvailableSections)
                        {
                            <option value="@secName">@secName</option>
                        }
                    </select>
                </div>
                <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                    <div class="group relative">
                        <button @onclick="ClearFilters" class="flex w-full items-center justify-center gap-2 rounded-lg bg-gray-500 px-4 py-2 font-semibold text-white shadow-md transition-all duration-300 hover:bg-gray-600 hover:shadow-lg sm:w-auto" style="font-size: 13px;">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            Clear
                        </button>
                        <span class="tooltip-delay">Clear all filters</span>
                    </div>
                    <div class="group relative">
                        <button class="flex w-full items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 py-2 font-semibold text-white shadow-md transition-all duration-300 hover:bg-blue-700 hover:shadow-lg sm:w-auto" style="font-size: 13px;">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Export
                        </button>
                        <span class="tooltip-delay">Export student records to file</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <table class="min-w-full text-sm">
            <thead class="bg-gray-100 font-semibold text-gray-600">
                <tr>
                    <th class="px-4 py-3 text-left">ID</th>
                    <th class="px-4 py-3 text-left">Name</th>
                    <th class="px-4 py-3 text-left">LRN</th>
                    <th class="px-4 py-3 text-left">Grade Level</th>
                    <th class="px-4 py-3 text-left">Section</th>
                    <th class="px-4 py-3 text-left">Documents</th>
                    <th class="px-4 py-3 text-left">Status</th>
                    <th class="px-4 py-3 text-center">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y">
                @if (PaginatedStudents != null && PaginatedStudents.Any())
                {
                    @foreach (var student in PaginatedStudents)
                    {
                        <tr class="transition hover:bg-gray-50">
                            <td class="px-4 py-3">@student.Id</td>
                            <td class="px-4 py-3">@student.Name</td>

                            @if (student.LRN == "N/A")
                            {
                                <td class="px-4 py-3"><span class="text-xs font-semibold text-gray-400">@student.LRN</span></td>
                            }
                            else
                            {
                                <td class="px-4 py-3">@student.LRN</td>
                            }

                            <td class="px-4 py-3">@student.GradeLevel</td>
                            <td class="px-4 py-3">@student.Section</td>

                            <td class="px-4 py-3 text-sm text-gray-700">
                                @if (student.Documents == "Validated")
                                {
                                    <span class="text-xs font-semibold text-blue-600">Validated</span>
                                }
                                else
                                {
                                    <span class="text-xs font-semibold text-gray-400">Not Validated</span>
                                }
                            </td>

                            <td class="px-4 py-3">
                                @if (student.Status == "Enrolled")
                                {
                                    <span class="text-xs font-semibold text-green-600">Enrolled</span>
                                }
                                else if (student.Status == "Fully Paid")
                                {
                                    <span class="text-xs font-semibold text-green-600">@student.Status</span>
                                }
                                else if (student.Status == "Partially Paid")
                                {
                                    <span class="text-xs font-semibold text-orange-600">@student.Status</span>
                                }
                                else if (student.Status == "For Payment")
                                {
                                    <span class="text-xs font-semibold text-blue-600">@student.Status</span>
                                }
                                else
                                {
                                    <span class="text-xs font-semibold text-gray-600">@student.Status</span>
                                }
                            </td>

                            <td class="flex items-center justify-center gap-2 px-4 py-3">
                                <!-- View Button -->
                                <button @onclick="() => HandleViewClick(student)" class="flex items-center gap-1.5 rounded-lg bg-blue-50 px-3 py-1.5 text-xs font-medium text-blue-400 transition-colors hover:bg-blue-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M5 1a2 2 0 0 0-2 2v2.256c.318-.112.653-.19 1-.229V3a1 1 0 0 1 1-1h3v2.5A1.5 1.5 0 0 0 9.5 6H12v7a1 1 0 0 1-1 1h-.085c.114.323.114.677 0 1H11a2 2 0 0 0 2-2V5.414a1.5 1.5 0 0 0-.44-1.06L9.647 1.439A1.5 1.5 0 0 0 8.586 1H5Zm6.793 4H9.5a.5.5 0 0 1-.5-.5V2.207L11.793 5Zm-5.197 7.303a3.5 3.5 0 1 1 .707-.707l2.55 2.55a.5.5 0 0 1-.707.708l-2.55-2.55ZM7 9.5a2.5 2.5 0 1 0-5 0a2.5 2.5 0 0 0 5 0Z"/>
                                    </svg>
                                    <span class="hidden sm:inline">View</span>
                                </button>
                                <!-- Drop Button -->
                                <button @onclick="() => HandleDropClick(student)" class="flex items-center gap-1.5 rounded-lg bg-red-50 px-3 py-1.5 text-xs font-medium text-red-400 transition-colors hover:bg-red-100">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    <span class="hidden sm:inline">Drop</span>
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="8" class="px-4 py-12 text-center text-sm text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <p class="text-base font-medium text-gray-600">No Records Available</p>
                                <p class="text-sm text-gray-500 mt-1">There are no student records to display at this time.</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <!-- Footer with Pagination -->
        <Pagination TotalItems="@FilteredStudents.Count()"
                    CurrentPage="@CurrentPage"
                    RowsPerPage="@RowsPerPage"
                    ItemName="students"
                    OnPageChanged="HandlePageChanged"
                    OnRowsPerPageChanged="HandleRowsPerPageChanged" />
    </div>
    }
</div>

<!-- Drop Confirmation Modal -->
@if (ShowDropConfirmationModal)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @onclick="CloseDropConfirmationModal">
        <div id="drop-student-confirmation-modal" class="w-full max-w-md overflow-hidden rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <!-- Modal Header -->
            <div class="flex items-center justify-between rounded-t-2xl bg-white px-6 py-2.5 border-b border-gray-200">
                <h3 class="text-base font-semibold text-red-500">Confirm Drop Student</h3>
                <button @onclick="CloseDropConfirmationModal" class="text-gray-400 hover:text-gray-600" style="background: transparent; border: none; cursor: pointer; padding: 0; margin: 0;">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
 
            <!-- Modal Body -->
            <div class="rounded-b-2xl bg-white px-6 py-4">
                <p class="mb-4 text-sm text-gray-700">
                    Are you sure you want to drop <strong>@StudentToDrop?.Name</strong>? 
                    This action will move the student to the archive module and cannot be undone.
                </p>

                <div class="mb-4">
                    <label class="mb-2 block text-sm font-medium text-gray-700">Reason for Dropping <span class="text-red-500">*</span></label>
                    <textarea @bind="DropReason" 
                              placeholder="Enter reason for dropping this student..."
                              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-700 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400"
                              rows="3"
                              maxlength="500"></textarea>
                    <p class="mt-1 text-xs text-gray-500">@DropReason.Length / 500 characters</p>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" @onclick="CloseDropConfirmationModal"
                            class="rounded-lg border border-gray-300 bg-transparent px-3 py-1.5 text-sm font-medium text-gray-700 transition-all hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="button" @onclick="ConfirmDropStudent"
                            class="rounded-lg px-3 py-1.5 text-sm font-medium text-white transition-all hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed"
                            style="background-color: #ef4444;"
                            disabled="@(string.IsNullOrWhiteSpace(DropReason))">
                        Confirm Drop
                    </button>
                </div>
            </div>
        </div>
    </div>
}

</RoleAuthorizeView>

@code {
    private bool ShowDetailView { get; set; } = false;
    private StudentDetailData SelectedStudentData { get; set; } = new();
    private List<AcademicRecordData> SelectedAcademicRecords { get; set; } = new();
    private List<EnrollmentStatusData> SelectedEnrollmentRecords { get; set; } = new();

    private string SearchText { get; set; } = string.Empty;
    private string SchoolYearFilter { get; set; } = "all";
    private string StatusFilter { get; set; } = "all";
    private string LrnStatusFilter { get; set; } = string.Empty;
    private string DocumentStatusFilter { get; set; } = string.Empty;
    private string GradeFilter { get; set; } = string.Empty;
    private string SectionFilter { get; set; } = string.Empty;

    // Pagination state
    private int CurrentPage { get; set; } = 1;
    private int RowsPerPage { get; set; } = 9;

    private List<EnrolledStudentDto> StudentRecords { get; set; } = new();

    private IEnumerable<string> AvailableGrades =>
        StudentRecords.Select(s => s.GradeLevel)
                      .Where(g => !string.IsNullOrWhiteSpace(g) && g != "N/A")
                      .Distinct()
                      .OrderBy(g => g);

    private IEnumerable<string> AvailableSections =>
        StudentRecords.Select(s => s.Section)
                      .Where(s => !string.IsNullOrWhiteSpace(s) && s != "N/A")
                      .Distinct()
                      .OrderBy(s => s);

    private IEnumerable<EnrolledStudentDto> FilteredStudents =>
        StudentRecords.Where(s =>
            (string.IsNullOrWhiteSpace(SearchText) ||
             s.Name.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
             s.Id.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
             s.LRN.Contains(SearchText, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrWhiteSpace(GradeFilter) || s.GradeLevel == GradeFilter) &&
            (string.IsNullOrWhiteSpace(SectionFilter) || s.Section == SectionFilter) &&
            (string.IsNullOrWhiteSpace(DocumentStatusFilter) || 
             s.Documents == DocumentStatusFilter ||
             (DocumentStatusFilter == "Validated" && (s.Documents == "Validated" || s.Documents == "Verified")) ||
             (DocumentStatusFilter == "Not Validated" && (s.Documents == "Not Validated" || s.Documents == "Not verified" || s.Documents == "Pending"))) &&
            (string.IsNullOrWhiteSpace(LrnStatusFilter) ||
                (LrnStatusFilter == "Assigned" && s.LRN != "N/A") ||
                (LrnStatusFilter == "Pending" && s.LRN == "N/A")));

    private IEnumerable<EnrolledStudentDto> PaginatedStudents
        => FilteredStudents.Skip((CurrentPage - 1) * RowsPerPage)
                           .Take(RowsPerPage);

    private string CurrentSchoolYear { get; set; } = "";
    private List<string> AvailableSchoolYears { get; set; } = new();

    private bool _hasInitialized = false;

    // Drop confirmation modal state
    private bool ShowDropConfirmationModal { get; set; } = false;
    private EnrolledStudentDto? StudentToDrop { get; set; }
    private string DropReason { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Load current school year
        CurrentSchoolYear = await SchoolYearService.GetActiveSchoolYearNameAsync() ?? "";
        // Load available school years for filter (already sorted descending by service)
        AvailableSchoolYears = await SchoolYearService.GetAvailableSchoolYearsAsync();
        await LoadStudentsAsync();
        _hasInitialized = true;
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload data when parameters change (e.g., when navigating back from Enrollment or Finance page)
        if (_hasInitialized && !ShowDetailView)
        {
            // Check if school year has changed
            var activeSchoolYear = await SchoolYearService.GetActiveSchoolYearNameAsync() ?? "";
            bool schoolYearChanged = CurrentSchoolYear != activeSchoolYear;
            
            if (schoolYearChanged)
            {
                CurrentSchoolYear = activeSchoolYear;
            }
            
            // Clear EF Core change tracker to ensure fresh data
            _context.ChangeTracker.Clear();
            
            // Small delay to ensure any pending database changes are committed
            await Task.Delay(100);
            
            // Reload students list if not in detail view
            await LoadStudentsAsync();
            StateHasChanged();
        }
    }

    private async Task LoadStudentsAsync()
    {
        try
        {
            // Clear EF Core change tracker to ensure fresh data is loaded
            // This prevents showing stale/cached data
            _context.ChangeTracker.Clear();
            
            // Small delay to ensure any pending database changes are committed
            await Task.Delay(100);
            
            // Get filter values (convert "all" to null for service method)
            var schoolYearFilter = SchoolYearFilter?.ToLower() == "all" ? null : SchoolYearFilter;
            var statusFilter = StatusFilter?.ToLower() == "all" ? null : StatusFilter;
            
            // Query from tbl_Student directly with filters
            StudentRecords = await StudentService.GetAllStudentRecordsAsync(schoolYearFilter, statusFilter);
        }
        catch
        {
            StudentRecords = new List<EnrolledStudentDto>();
        }
    }

    private async Task OnFilterChanged()
    {
        CurrentPage = 1;
        await LoadStudentsAsync();
        StateHasChanged();
    }

    private async Task ClearFilters()
    {
        SearchText = string.Empty;
        SchoolYearFilter = "all";
        StatusFilter = "all";
        LrnStatusFilter = string.Empty;
        DocumentStatusFilter = string.Empty;
        GradeFilter = string.Empty;
        SectionFilter = string.Empty;
        CurrentPage = 1;
        await LoadStudentsAsync();
        StateHasChanged();
    }

    private void HandlePageChanged(int page)
    {
        CurrentPage = page;
        StateHasChanged();
    }

    private void HandleRowsPerPageChanged(int rowsPerPage)
    {
        RowsPerPage = rowsPerPage;
        CurrentPage = 1;
        StateHasChanged();
    }

    private async Task HandleViewClick(EnrolledStudentDto student)
    {
        // Clear change tracker before loading student to ensure fresh data
        _context.ChangeTracker.Clear();
        
        var entity = await StudentService.GetStudentByIdAsync(student.Id);
        if (entity == null)
        {
            return;
        }

        var fullName = $"{entity.FirstName} {entity.MiddleName} {entity.LastName}"
            .Replace("  ", " ")
            .Trim();

        var hasRealLrn = !string.IsNullOrWhiteSpace(entity.Lrn);
        var rawLrn = entity.Lrn ?? string.Empty;

        // Get latest enrollment for this student
        // Prioritize current active school year enrollment, then most recent by CreatedAt
        var currentActiveSchoolYear = await SchoolYearService.GetActiveSchoolYearNameAsync();
        var latestEnrollment = entity.SectionEnrollments
            .OrderByDescending(e => !string.IsNullOrEmpty(currentActiveSchoolYear) && e.SchoolYear == currentActiveSchoolYear)
            .ThenByDescending(e => e.CreatedAt)
            .FirstOrDefault();
        
        // Determine original student type - check if student has previous enrollments
        // If they do, they were originally "New Student" or "Transferee", not "Returnee"
        // If no previous enrollments, use current student type as original
        string originalStudentType = entity.StudentType ?? string.Empty;
        var enrollmentCount = entity.SectionEnrollments?.Count ?? 0;
        if (enrollmentCount > 1 && string.Equals(entity.StudentType, "Returnee", StringComparison.OrdinalIgnoreCase))
        {
            // Student is currently a returnee but has previous enrollments
            // They were originally "New Student" or "Transferee"
            // For simplicity, we'll check the first enrollment's context or assume "New Student"
            // Since requirements are what matter, we'll check what requirements exist from original enrollment
            originalStudentType = "New Student"; // Default assumption - could be refined by checking first enrollment
        }
        else if (enrollmentCount <= 1)
        {
            // First enrollment - original type is current type
            originalStudentType = entity.StudentType ?? string.Empty;
        }

        var sectionName = latestEnrollment?.Section?.SectionName ?? string.Empty;
        // Prioritize enrollment record's grade level, but fall back to student's GradeLevel (which is updated during re-enrollment)
        var gradeLevelName = latestEnrollment?.Section?.GradeLevel?.GradeLevelName ?? entity.GradeLevel ?? string.Empty;
        // Prioritize enrollment record's school year, but fall back to student's SchoolYr (which is updated during re-enrollment)
        var schoolYear = latestEnrollment?.SchoolYear ?? entity.SchoolYr ?? string.Empty;

        // Helper to check if an unchanging requirement exists (submitted or verified)
        // Unchanging requirements like PSA Birth Certificate, Baptismal Certificate, etc. 
        // are valid across all enrollments, so we check if they exist at all
        bool IsUnchangingRequirementProvided(string requirementName)
        {
            var requirement = entity.Requirements?.FirstOrDefault(r => 
                string.Equals(r.RequirementName, requirementName, StringComparison.OrdinalIgnoreCase));
            if (requirement == null)
            {
                return false;
            }

            // Consider requirement as provided if it exists and is not "not submitted"
            // This includes: "verified", "submitted", "pending", etc.
            return !string.IsNullOrWhiteSpace(requirement.Status) &&
                   !requirement.Status.Equals("not submitted", StringComparison.OrdinalIgnoreCase);
        }

        // Determine if PSA Birth Certificate is provided
        bool hasBirthCert = IsUnchangingRequirementProvided("PSA Birth Certificate");

        SelectedStudentData = new StudentDetailData
        {
            Id = entity.StudentId,
            FullName = fullName,
            FirstName = entity.FirstName,
            MiddleName = entity.MiddleName ?? string.Empty,
            LastName = entity.LastName,
            Suffix = entity.Suffix ?? string.Empty,
            GradeLevel = gradeLevelName,
            Section = sectionName,
            SchoolYear = schoolYear,
            Status = entity.Status,
            LRN = hasRealLrn ? rawLrn : "N/A",

            BirthDate = entity.Birthdate,
            PlaceOfBirth = entity.PlaceOfBirth ?? string.Empty,
            Sex = entity.Sex,
            MotherTongue = entity.MotherTongue ?? string.Empty,
            IsIPCommunity = entity.IpComm ? "Yes" : "No",
            IPCommunitySpecify = entity.IpSpecify ?? string.Empty,
            Is4PsBeneficiary = entity.FourPs ? "Yes" : "No",
            FourPsHouseholdId = entity.FourPsHseId ?? string.Empty,

            CurrentHouseNo = entity.HseNo ?? string.Empty,
            CurrentStreetName = entity.Street ?? string.Empty,
            CurrentBarangay = entity.Brngy ?? string.Empty,
            CurrentCity = entity.City ?? string.Empty,
            CurrentProvince = entity.Province ?? string.Empty,
            CurrentCountry = entity.Country ?? string.Empty,
            CurrentZipCode = entity.ZipCode ?? string.Empty,

            // Permanent address
            PermanentHouseNo = entity.PhseNo ?? string.Empty,
            PermanentStreetName = entity.Pstreet ?? string.Empty,
            PermanentBarangay = entity.Pbrngy ?? string.Empty,
            PermanentCity = entity.Pcity ?? string.Empty,
            PermanentProvince = entity.Pprovince ?? string.Empty,
            PermanentCountry = entity.Pcountry ?? string.Empty,
            PermanentZipCode = entity.PzipCode ?? string.Empty,

            GuardianFirstName = entity.Guardian?.FirstName ?? string.Empty,
            GuardianMiddleName = entity.Guardian?.MiddleName ?? string.Empty,
            GuardianLastName = entity.Guardian?.LastName ?? string.Empty,
            GuardianSuffix = entity.Guardian?.Suffix ?? string.Empty,
            GuardianContactNumber = entity.Guardian?.ContactNum ?? string.Empty,
            GuardianRelationship = entity.Guardian?.Relationship ?? string.Empty,

            StudentType = entity.StudentType ?? string.Empty,
            OriginalStudentType = originalStudentType,
            HasLRN = hasRealLrn ? "Yes" : "No",
            LearnerReferenceNo = hasRealLrn ? rawLrn : "N/A",
            GradeToEnroll = gradeLevelName,
            HasBirthCertificate = hasBirthCert,

            // Detailed requirement checklist - Show all unchanging requirements from any enrollment
            // Unchanging requirements persist across all school years
            HasPSABirthCert = IsUnchangingRequirementProvided("PSA Birth Certificate"),
            HasBaptismalCert = IsUnchangingRequirementProvided("Baptismal Certificate"),
            HasReportCard = IsUnchangingRequirementProvided("Report Card"),
            HasForm138 = IsUnchangingRequirementProvided("Form 138 (Report Card)"),
            HasForm137 = IsUnchangingRequirementProvided("Form 137 (Permanent Record)"),
            HasGoodMoralCert = IsUnchangingRequirementProvided("Good Moral Certificate"),
            HasTransferCert = IsUnchangingRequirementProvided("Transfer Certificate"),
            // Transient requirements (only shown for returnees in original enrollment context)
            HasUpdatedEnrollmentForm = IsUnchangingRequirementProvided("Updated Enrollment Form"),
            HasClearance = IsUnchangingRequirementProvided("Clearance"),

            PaymentStatus = entity.PaymentStatus ?? "N/A"
        };

        // Load academic records from database
        await LoadAcademicRecordsAsync(entity.StudentId);

        // Build enrollment status records from all enrollments
        SelectedEnrollmentRecords = (entity.SectionEnrollments ?? Enumerable.Empty<Data.Models.StudentSectionEnrollment>())
            .OrderByDescending(e => e.CreatedAt)
            .Select(e => new EnrollmentStatusData
            {
                SchoolYear = e.SchoolYear,
                Grade = e.Section?.GradeLevel?.GradeLevelName ?? entity.GradeLevel ?? string.Empty,
                Section = e.Section?.SectionName ?? string.Empty,
                Type = entity.StudentType ?? string.Empty,
                Documents = DocumentsVerifiedHelper.CalculateDocumentsVerified(entity.Requirements, entity.StudentType) ? "Verified" : "Pending",
                PaymentStatus = entity.PaymentStatus ?? "N/A",
                Status = e.Status
            })
            .ToList();

        ShowDetailView = true;
        StateHasChanged();
    }

    private async Task HandleBackClick()
    {
        ShowDetailView = false;
        
        // Clear EF Core change tracker to ensure fresh data
        _context.ChangeTracker.Clear();
        
        // Small delay to ensure any pending database changes are committed
        await Task.Delay(100);
        
        // Reload students list when going back
        await LoadStudentsAsync();
        // Clear selected data when going back
        SelectedStudentData = new StudentDetailData();
        SelectedAcademicRecords = new List<AcademicRecordData>();
        SelectedEnrollmentRecords = new List<EnrollmentStatusData>();
        StateHasChanged();
    }

    private async Task HandleStudentUpdated(StudentDetailData updatedData)
    {
        // Small delay to ensure database changes are committed
        await Task.Delay(100);
        
        // Reload the student data to get the latest information
        var entity = await StudentService.GetStudentByIdAsync(updatedData.Id);
        if (entity != null)
        {
            // Rebuild SelectedStudentData with updated information
            var fullName = $"{entity.FirstName} {entity.MiddleName} {entity.LastName}"
                .Replace("  ", " ")
                .Trim();

            var hasRealLrn = !string.IsNullOrWhiteSpace(entity.Lrn);
            var rawLrn = entity.Lrn ?? string.Empty;

            // Prioritize current active school year enrollment, then most recent by CreatedAt
            var currentActiveSchoolYear = await SchoolYearService.GetActiveSchoolYearNameAsync();
            var latestEnrollment = entity.SectionEnrollments
                .OrderByDescending(e => !string.IsNullOrEmpty(currentActiveSchoolYear) && e.SchoolYear == currentActiveSchoolYear)
                .ThenByDescending(e => e.CreatedAt)
                .FirstOrDefault();

            var sectionName = latestEnrollment?.Section?.SectionName ?? string.Empty;
            // Prioritize enrollment record's grade level, but fall back to student's GradeLevel (which is updated during re-enrollment)
            var gradeLevelName = latestEnrollment?.Section?.GradeLevel?.GradeLevelName ?? entity.GradeLevel ?? string.Empty;
            // Prioritize enrollment record's school year, but fall back to student's SchoolYr (which is updated during re-enrollment)
            var schoolYear = latestEnrollment?.SchoolYear ?? entity.SchoolYr ?? string.Empty;

            SelectedStudentData = new StudentDetailData
            {
                Id = entity.StudentId,
                FullName = fullName,
                FirstName = entity.FirstName,
                MiddleName = entity.MiddleName ?? string.Empty,
                LastName = entity.LastName,
                Suffix = entity.Suffix ?? string.Empty,
                GradeLevel = gradeLevelName,
                Section = sectionName,
                SchoolYear = schoolYear,
                Status = entity.Status,
                LRN = hasRealLrn ? rawLrn : "N/A",
                BirthDate = entity.Birthdate,
                PlaceOfBirth = entity.PlaceOfBirth ?? string.Empty,
                Sex = entity.Sex,
                MotherTongue = entity.MotherTongue ?? string.Empty,
                IsIPCommunity = entity.IpComm ? "Yes" : "No",
                IPCommunitySpecify = entity.IpSpecify ?? string.Empty,
                Is4PsBeneficiary = entity.FourPs ? "Yes" : "No",
                FourPsHouseholdId = entity.FourPsHseId ?? string.Empty,
                CurrentHouseNo = entity.HseNo ?? string.Empty,
                CurrentStreetName = entity.Street ?? string.Empty,
                CurrentBarangay = entity.Brngy ?? string.Empty,
                CurrentCity = entity.City ?? string.Empty,
                CurrentProvince = entity.Province ?? string.Empty,
                CurrentCountry = entity.Country ?? string.Empty,
                CurrentZipCode = entity.ZipCode ?? string.Empty,
                PermanentHouseNo = entity.PhseNo ?? string.Empty,
                PermanentStreetName = entity.Pstreet ?? string.Empty,
                PermanentBarangay = entity.Pbrngy ?? string.Empty,
                PermanentCity = entity.Pcity ?? string.Empty,
                PermanentProvince = entity.Pprovince ?? string.Empty,
                PermanentCountry = entity.Pcountry ?? string.Empty,
                PermanentZipCode = entity.PzipCode ?? string.Empty,
                GuardianFirstName = entity.Guardian?.FirstName ?? string.Empty,
                GuardianMiddleName = entity.Guardian?.MiddleName ?? string.Empty,
                GuardianLastName = entity.Guardian?.LastName ?? string.Empty,
                GuardianSuffix = entity.Guardian?.Suffix ?? string.Empty,
                GuardianContactNumber = entity.Guardian?.ContactNum ?? string.Empty,
                GuardianRelationship = entity.Guardian?.Relationship ?? string.Empty,
                StudentType = entity.StudentType,
                HasLRN = hasRealLrn ? "Yes" : "No",
                LearnerReferenceNo = hasRealLrn ? rawLrn : "N/A",
                GradeToEnroll = gradeLevelName
            };
        }
        
        // Reload students list to reflect changes
        await LoadStudentsAsync();
        StateHasChanged();
    }

    /// <summary>
    /// Loads academic records for a student from the database
    /// </summary>
    private async Task LoadAcademicRecordsAsync(string studentId)
    {
        try
        {
            // Get the student entity to access enrollment history
            var studentEntity = await StudentService.GetStudentByIdAsync(studentId);
            if (studentEntity == null)
            {
                SelectedAcademicRecords = new List<AcademicRecordData>();
                return;
            }

            // Get all unique school years from student's enrollment history
            var schoolYears = studentEntity.SectionEnrollments
                .Select(e => e.SchoolYear)
                .Where(sy => !string.IsNullOrWhiteSpace(sy))
                .Distinct()
                .ToList();

            // If no enrollments, also check current and previous years
            if (!schoolYears.Any())
            {
                var currentYear = DateTime.Now.Year;
                for (int i = 0; i < 4; i++)
                {
                    schoolYears.Add($"{currentYear - i}-{currentYear - i + 1}");
                }
            }

            var allGrades = new List<BrightEnroll_DES.Data.Models.Grade>();
            
            // Get grades for each school year
            foreach (var schoolYear in schoolYears)
            {
                try
                {
                    var grades = await GradeService.GetStudentGradesAsync(studentId, schoolYear);
                    if (grades != null && grades.Any())
                    {
                        allGrades.AddRange(grades);
                    }
                }
                catch
                {
                    // Continue if one year fails
                }
            }
            
            if (!allGrades.Any())
            {
                SelectedAcademicRecords = new List<AcademicRecordData>();
                return;
            }

            // Group grades by school year and subject
            var academicRecords = allGrades
                .GroupBy(g => new 
                { 
                    g.SchoolYear, 
                    g.SubjectId, 
                    SubjectName = g.Subject?.SubjectName ?? string.Empty,
                    GradeLevelName = g.Section?.GradeLevel?.GradeLevelName ?? string.Empty
                })
                .Select(group =>
                {
                    var q1Grade = group.FirstOrDefault(g => g.GradingPeriod == "Q1" || g.GradingPeriod == "Quarter 1");
                    var q2Grade = group.FirstOrDefault(g => g.GradingPeriod == "Q2" || g.GradingPeriod == "Quarter 2");
                    var q3Grade = group.FirstOrDefault(g => g.GradingPeriod == "Q3" || g.GradingPeriod == "Quarter 3");
                    var q4Grade = group.FirstOrDefault(g => g.GradingPeriod == "Q4" || g.GradingPeriod == "Quarter 4");

                    // Check if quarters have valid grades
                    var hasQ1 = q1Grade?.FinalGrade.HasValue == true && q1Grade.FinalGrade.Value > 0;
                    var hasQ2 = q2Grade?.FinalGrade.HasValue == true && q2Grade.FinalGrade.Value > 0;
                    var hasQ3 = q3Grade?.FinalGrade.HasValue == true && q3Grade.FinalGrade.Value > 0;
                    var hasQ4 = q4Grade?.FinalGrade.HasValue == true && q4Grade.FinalGrade.Value > 0;

                    // Count how many quarters have grades
                    var quartersWithGrades = new List<decimal>();
                    if (hasQ1) quartersWithGrades.Add(q1Grade!.FinalGrade!.Value);
                    if (hasQ2) quartersWithGrades.Add(q2Grade!.FinalGrade!.Value);
                    if (hasQ3) quartersWithGrades.Add(q3Grade!.FinalGrade!.Value);
                    if (hasQ4) quartersWithGrades.Add(q4Grade!.FinalGrade!.Value);
                    
                    var finalGrade = quartersWithGrades.Any() ? quartersWithGrades.Average() : 0m;
                    
                    // Determine remarks based on completeness and grade
                    string remarks;
                    if (!quartersWithGrades.Any())
                    {
                        remarks = "No Grade";
                    }
                    else if (quartersWithGrades.Count < 4)
                    {
                        // Incomplete - not all quarters have grades
                        remarks = "Incomplete";
                    }
                    else
                    {
                        // All quarters present - calculate descriptive rating
                        var transmutedGrade = GradeService.GetTransmutedGrade(finalGrade);
                        remarks = GradeService.GetDescriptiveRating(transmutedGrade);
                    }

                    return new AcademicRecordData
                    {
                        SchoolYear = group.Key.SchoolYear,
                        Grade = group.Key.GradeLevelName,
                        Subject = group.Key.SubjectName,
                        Q1 = q1Grade?.FinalGrade.HasValue == true && q1Grade.FinalGrade.Value > 0 
                            ? q1Grade.FinalGrade.Value.ToString("F2") 
                            : "-",
                        Q2 = q2Grade?.FinalGrade.HasValue == true && q2Grade.FinalGrade.Value > 0 
                            ? q2Grade.FinalGrade.Value.ToString("F2") 
                            : "-",
                        Q3 = q3Grade?.FinalGrade.HasValue == true && q3Grade.FinalGrade.Value > 0 
                            ? q3Grade.FinalGrade.Value.ToString("F2") 
                            : "-",
                        Q4 = q4Grade?.FinalGrade.HasValue == true && q4Grade.FinalGrade.Value > 0 
                            ? q4Grade.FinalGrade.Value.ToString("F2") 
                            : "-",
                        FinalGrade = finalGrade > 0 ? finalGrade.ToString("F2") : "-",
                        Remarks = remarks
                    };
                })
                .OrderByDescending(r => r.SchoolYear)
                .ThenBy(r => r.Subject)
                .ToList();

            SelectedAcademicRecords = academicRecords;
        }
        catch (Exception ex)
        {
            // Log error but don't crash - just show empty list
            System.Diagnostics.Debug.WriteLine($"Error loading academic records: {ex.Message}");
            SelectedAcademicRecords = new List<AcademicRecordData>();
        }
    }

    private void HandleDropClick(EnrolledStudentDto student)
    {
        StudentToDrop = student;
        DropReason = string.Empty; // Reset reason when opening modal
        ShowDropConfirmationModal = true;
        StateHasChanged();
    }

    private void CloseDropConfirmationModal()
    {
        ShowDropConfirmationModal = false;
        StudentToDrop = null;
        DropReason = string.Empty; // Clear reason when closing modal
        StateHasChanged();
    }

    private async Task ConfirmDropStudent()
    {
        if (StudentToDrop == null)
        {
            CloseDropConfirmationModal();
            return;
        }

        if (string.IsNullOrWhiteSpace(DropReason))
        {
            return; // Don't proceed if reason is empty
        }

        try
        {
            // Archive the student with "Drop" status and the provided reason
            await ArchiveService.ArchiveStudentAsync(
                StudentToDrop.Id,
                "Drop",
                notes: null,
                archivedBy: null,
                reason: DropReason.Trim()
            );

            // Close the modal
            CloseDropConfirmationModal();

            // Reload the student list to reflect the change
            await LoadStudentsAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            // Log error (in a real app, you might want to show an error message to the user)
            System.Diagnostics.Debug.WriteLine($"Error dropping student: {ex.Message}");
            CloseDropConfirmationModal();
            // You might want to show an error notification here
        }
    }

}
