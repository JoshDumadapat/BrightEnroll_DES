@page "/student-record"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Components.Pages.Admin.StudentRecord.StudentRecordComponents
@using BrightEnroll_DES.Components.Pages.Admin.StudentRecord.StudentRecordCS
@using BrightEnroll_DES.Services.RoleBase
@using BrightEnroll_DES.Services.Business.Students
@using BrightEnroll_DES.Services.Business.Academic
@using BrightEnroll_DES.Components
@inject BrightEnroll_DES.Services.RoleBase.IAuthorizationService AuthorizationService
@inject StudentService StudentService
@inject GradeService GradeService
@inject SchoolYearService SchoolYearService
@inject ArchiveService ArchiveService
@inject BrightEnroll_DES.Services.Business.Audit.AuditLogService AuditLogService
@inject BrightEnroll_DES.Services.Authentication.IAuthService AuthService

<PageTitle>Student Record</PageTitle>

<RoleAuthorizeView RequiredPermission="@Permissions.ViewStudentRecord">

<div class="text-gray-800">
    <div class="mb-6 flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-800">Student Record</h1>
        @if (!string.IsNullOrEmpty(CurrentSchoolYear))
        {
            <div class="flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-4 py-2">
                <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span class="text-sm font-semibold text-blue-800">School Year: <span class="font-bold">@CurrentSchoolYear</span></span>
            </div>
        }
    </div>
    @if (ShowDetailView)
    {
        <StudentDetail StudentData="SelectedStudentData" AcademicRecords="SelectedAcademicRecords" EnrollmentRecords="SelectedEnrollmentRecords" OnBackClick="HandleBackClick" />
    }
    else
    {
    <!-- Card Container -->
    <div class="overflow-hidden rounded-xl bg-white shadow">
        <!-- Filters -->
        <div class="border-b border-gray-200 px-3 py-4 sm:px-6">
            <label class="mb-2 block text-sm font-bold text-gray-700">Filter:</label>
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                    <div class="relative flex w-full items-center sm:w-auto sm:min-w-[200px]">
                        <span class="absolute left-4 flex items-center justify-center">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </span>
                        <input type="text" placeholder="Search here..." @bind="SearchText" @bind:after="OnFilterChanged"
                               class="w-full rounded-lg border border-gray-300 py-2 pl-11 pr-4 text-sm text-gray-700 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400" />
                    </div>
                    <select @bind="LrnStatusFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                        <option value="">LRN Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Assigned">Assigned</option>
                    </select>
                    <select @bind="DocumentStatusFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                        <option value="">Document Status</option>
                        <option value="Validated">Validated</option>
                        <option value="Not Validated">Not Validated</option>
                    </select>
                    <select @bind="GradeFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                        <option value="">Grade Level</option>
                        @foreach (var grade in AvailableGrades)
                        {
                            <option value="@grade">@grade</option>
                        }
                    </select>
                    <select @bind="SectionFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                        <option value="">Section</option>
                        @foreach (var secName in AvailableSections)
                        {
                            <option value="@secName">@secName</option>
                        }
                    </select>
                </div>
                <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                    <div class="group relative">
                        <button @onclick="ClearFilters" class="flex w-full items-center justify-center gap-2 rounded-lg bg-gray-500 px-4 py-2 font-semibold text-white shadow-md transition-all duration-300 hover:bg-gray-600 hover:shadow-lg sm:w-auto" style="font-size: 13px;">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            Clear
                        </button>
                        <span class="tooltip-delay">Clear all filters</span>
                    </div>
                    <div class="group relative">
                        <button class="flex w-full items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 py-2 font-semibold text-white shadow-md transition-all duration-300 hover:bg-blue-700 hover:shadow-lg sm:w-auto" style="font-size: 13px;">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Export
                        </button>
                        <span class="tooltip-delay">Export student records to file</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <table class="min-w-full text-sm">
            <thead class="bg-gray-100 font-semibold text-gray-600">
                <tr>
                    <th class="px-4 py-3 text-left">ID</th>
                    <th class="px-4 py-3 text-left">Name</th>
                    <th class="px-4 py-3 text-left">LRN</th>
                    <th class="px-4 py-3 text-left">Grade Level</th>
                    <th class="px-4 py-3 text-left">Section</th>
                    <th class="px-4 py-3 text-left">Documents</th>
                    <th class="px-4 py-3 text-left">Status</th>
                    <th class="px-4 py-3 text-center">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y">
                @if (PaginatedStudents != null && PaginatedStudents.Any())
                {
                    @foreach (var student in PaginatedStudents)
                    {
                        <tr class="transition hover:bg-gray-50">
                            <td class="px-4 py-3">@student.Id</td>
                            <td class="px-4 py-3">@student.Name</td>

                            @if (student.LRN == "N/A")
                            {
                                <td class="px-4 py-3"><span class="text-xs font-semibold text-gray-400">@student.LRN</span></td>
                            }
                            else
                            {
                                <td class="px-4 py-3">@student.LRN</td>
                            }

                            <td class="px-4 py-3">@student.GradeLevel</td>
                            <td class="px-4 py-3">@student.Section</td>

                            <td class="px-4 py-3 text-sm text-gray-700">
                                @if (student.Documents == "Validated")
                                {
                                    <span class="text-xs font-semibold text-green-600">Validated</span>
                                }
                                else
                                {
                                    <span class="text-xs font-semibold text-gray-400">Not Validated</span>
                                }
                            </td>

                            <td class="px-4 py-3">
                                @if (student.Status == "Enrolled")
                                {
                                    <span class="rounded-full bg-green-100 px-2.5 py-1 text-[11px] font-medium text-green-700">Enrolled</span>
                                }
                                else
                                {
                                    <span class="rounded-full bg-gray-100 px-2.5 py-1 text-[11px] font-medium text-gray-700">@student.Status</span>
                                }
                            </td>

                            <td class="flex items-center justify-center gap-2 px-4 py-3">
                                <!-- View Button -->
                                <button @onclick="() => HandleViewClick(student)" class="flex items-center gap-1.5 rounded-lg bg-blue-50 px-3 py-1.5 text-xs font-medium text-blue-400 transition-colors hover:bg-blue-100">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                    <span class="hidden sm:inline">View</span>
                                </button>
                                <!-- Drop Button -->
                                <button @onclick="() => HandleDropClick(student)" class="flex items-center gap-1.5 rounded-lg bg-red-50 px-3 py-1.5 text-xs font-medium text-red-400 transition-colors hover:bg-red-100">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    <span class="hidden sm:inline">Drop</span>
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="8" class="px-4 py-12 text-center text-sm text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <svg class="h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <p class="text-base font-medium text-gray-600">No Records Available</p>
                                <p class="text-sm text-gray-500 mt-1">There are no student records to display at this time.</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <!-- Footer with Pagination -->
        <Pagination TotalItems="@FilteredStudents.Count()"
                    CurrentPage="@CurrentPage"
                    RowsPerPage="@RowsPerPage"
                    ItemName="students"
                    OnPageChanged="HandlePageChanged"
                    OnRowsPerPageChanged="HandleRowsPerPageChanged" />
    </div>
    }
</div>

<!-- Drop Student Confirmation Modal -->
@if (ShowDropModal)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @onclick="HandleDropModalBackdropClick">
        <div id="drop-student-modal" class="w-full max-w-md overflow-hidden rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <!-- Modal Header -->
            <div class="flex items-center justify-between rounded-t-2xl bg-white px-6 py-2.5 border-b border-gray-200">
                <h3 class="text-base font-semibold text-red-500">Confirm Drop Student</h3>
                <button @onclick="CloseDropModal" class="text-gray-400 hover:text-gray-600" style="background: transparent; border: none; cursor: pointer; padding: 0; margin: 0;">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
 
            <!-- Modal Body -->
            <div class="rounded-b-2xl bg-white px-6 py-4">
                <p class="mb-4 text-sm text-gray-700">
                    Are you sure you want to drop <strong>@SelectedStudentForDrop?.Name</strong>? This action will move the student to the archive module and cannot be undone.
                </p>
                
                @{
                    var currentUser = AuthService.CurrentUser;
                    var droppedByName = currentUser != null 
                        ? $"{currentUser.first_name} {currentUser.last_name}".Trim()
                        : "Unknown";
                    var droppedByRole = currentUser?.user_role ?? "Unknown";
                }
                
                @if (currentUser != null)
                {
                    <div class="mb-4 rounded-lg border border-blue-100 bg-blue-50 px-4 py-3">
                        <p class="text-xs font-medium text-blue-800">
                            <span class="font-semibold">Dropped by:</span> @droppedByName (@droppedByRole)
                        </p>
                    </div>
                }

                <div class="mb-4">
                    <label class="mb-2 block text-sm font-medium text-gray-700">
                        Reason for Dropping <span class="text-red-500">*</span>
                    </label>
                    <textarea @bind="DropReason" 
                              @bind:event="oninput"
                              maxlength="500"
                              placeholder="Enter reason for dropping this student..."
                              class="w-full rounded-lg border border-blue-200 px-4 py-2 text-sm text-gray-700 outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-400 resize-none"
                              rows="4"></textarea>
                    <p class="mt-1 text-xs text-gray-500">@DropReason.Length/500 characters</p>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" @onclick="CloseDropModal"
                            class="rounded-lg border border-gray-300 bg-transparent px-4 py-2 text-sm font-medium text-gray-700 transition-all hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="button" @onclick="ConfirmDropStudent"
                            disabled="@(string.IsNullOrWhiteSpace(DropReason))"
                            class="rounded-lg px-4 py-2 text-sm font-medium text-white transition-all hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed"
                            style="background-color: #ec4899;">
                        Confirm Drop
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Toast Notification -->
<ToastNotification Show="@showToast" Message="@toastMessage" Type="@toastType" OnClose="CloseToast" Duration="4000" />

@code {
    private bool ShowDetailView { get; set; } = false;
    private StudentDetailData SelectedStudentData { get; set; } = new();
    private List<AcademicRecordData> SelectedAcademicRecords { get; set; } = new();
    private List<EnrollmentStatusData> SelectedEnrollmentRecords { get; set; } = new();

    private string SearchText { get; set; } = string.Empty;
    private string LrnStatusFilter { get; set; } = string.Empty;
    private string DocumentStatusFilter { get; set; } = string.Empty;
    private string GradeFilter { get; set; } = string.Empty;
    private string SectionFilter { get; set; } = string.Empty;

    // Pagination state
    private int CurrentPage { get; set; } = 1;
    private int RowsPerPage { get; set; } = 9;

    private List<EnrolledStudentDto> StudentRecords { get; set; } = new();

    private IEnumerable<string> AvailableGrades =>
        StudentRecords.Select(s => s.GradeLevel)
                      .Where(g => !string.IsNullOrWhiteSpace(g) && g != "N/A")
                      .Distinct()
                      .OrderBy(g => g);

    private IEnumerable<string> AvailableSections =>
        StudentRecords.Select(s => s.Section)
                      .Where(s => !string.IsNullOrWhiteSpace(s) && s != "N/A")
                      .Distinct()
                      .OrderBy(s => s);

    private IEnumerable<EnrolledStudentDto> FilteredStudents =>
        StudentRecords.Where(s =>
            (string.IsNullOrWhiteSpace(SearchText) ||
             s.Name.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
             s.Id.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
             s.LRN.Contains(SearchText, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrWhiteSpace(GradeFilter) || s.GradeLevel == GradeFilter) &&
            (string.IsNullOrWhiteSpace(SectionFilter) || s.Section == SectionFilter) &&
            (string.IsNullOrWhiteSpace(DocumentStatusFilter) || 
             s.Documents == DocumentStatusFilter ||
             (DocumentStatusFilter == "Validated" && (s.Documents == "Validated" || s.Documents == "Verified")) ||
             (DocumentStatusFilter == "Not Validated" && (s.Documents == "Not Validated" || s.Documents == "Not verified" || s.Documents == "Pending"))) &&
            (string.IsNullOrWhiteSpace(LrnStatusFilter) ||
                (LrnStatusFilter == "Assigned" && s.LRN != "N/A") ||
                (LrnStatusFilter == "Pending" && s.LRN == "N/A")));

    private IEnumerable<EnrolledStudentDto> PaginatedStudents
        => FilteredStudents.Skip((CurrentPage - 1) * RowsPerPage)
                           .Take(RowsPerPage);

    private string CurrentSchoolYear { get; set; } = "";

    private bool _hasInitialized = false;

    // Drop Student Modal State
    private bool ShowDropModal { get; set; } = false;
    private EnrolledStudentDto? SelectedStudentForDrop { get; set; }
    private string DropReason { get; set; } = string.Empty;

    // Toast Notification State
    private bool showToast = false;
    private string toastMessage = string.Empty;
    private ToastType toastType = ToastType.Success;

    protected override async Task OnInitializedAsync()
    {
        // Load current school year
        CurrentSchoolYear = await SchoolYearService.GetActiveSchoolYearNameAsync() ?? "";
        await LoadStudentsAsync();
        _hasInitialized = true;
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload data when parameters change (e.g., when navigating back to this page)
        if (_hasInitialized && !ShowDetailView)
        {
            // Reload students list if not in detail view
            await LoadStudentsAsync();
            StateHasChanged();
        }
    }

    private async Task LoadStudentsAsync()
    {
        try
        {
            // Small delay to ensure any pending database changes are committed
            await Task.Delay(50);
            
            // Use GetAllStudentRecordsAsync to show all students (with enrollment records or ledgers)
            // This is different from GetEnrolledStudentsAsync which only shows "Enrolled" status
            StudentRecords = await StudentService.GetAllStudentRecordsAsync(CurrentSchoolYear);
        }
        catch
        {
            StudentRecords = new List<EnrolledStudentDto>();
        }
    }

    private void OnFilterChanged()
    {
        CurrentPage = 1;
        StateHasChanged();
    }

    private void ClearFilters()
    {
        SearchText = string.Empty;
        LrnStatusFilter = string.Empty;
        DocumentStatusFilter = string.Empty;
        GradeFilter = string.Empty;
        SectionFilter = string.Empty;
        CurrentPage = 1;
        StateHasChanged();
    }

    private void HandlePageChanged(int page)
    {
        CurrentPage = page;
        StateHasChanged();
    }

    private void HandleRowsPerPageChanged(int rowsPerPage)
    {
        RowsPerPage = rowsPerPage;
        CurrentPage = 1;
        StateHasChanged();
    }

    private async Task HandleViewClick(EnrolledStudentDto student)
    {
        var entity = await StudentService.GetStudentByIdAsync(student.Id);
        if (entity == null)
        {
            return;
        }

        var fullName = $"{entity.FirstName} {entity.MiddleName} {entity.LastName}"
            .Replace("  ", " ")
            .Trim();

        var hasRealLrn = !string.IsNullOrWhiteSpace(entity.Lrn);
        var rawLrn = entity.Lrn ?? string.Empty;

        // Get latest enrollment for this student
        var latestEnrollment = entity.SectionEnrollments
            .OrderByDescending(e => e.CreatedAt)
            .FirstOrDefault();

        var sectionName = latestEnrollment?.Section?.SectionName ?? string.Empty;
        var gradeLevelName = latestEnrollment?.Section?.GradeLevel?.GradeLevelName ?? entity.GradeLevel ?? string.Empty;
        var schoolYear = latestEnrollment?.SchoolYear ?? entity.SchoolYr ?? string.Empty;

        // Helper to check a requirement by name using Status field (\"verified\" => checked)
        bool IsRequirementChecked(string requirementName)
        {
            var requirement = entity.Requirements?.FirstOrDefault(r => r.RequirementName == requirementName);
            if (requirement == null)
            {
                return false;
            }

            return !string.IsNullOrWhiteSpace(requirement.Status) &&
                   requirement.Status.Equals("verified", StringComparison.OrdinalIgnoreCase);
        }

        // Determine if PSA Birth Certificate is verified
        bool hasBirthCert = IsRequirementChecked("PSA Birth Certificate");

        SelectedStudentData = new StudentDetailData
        {
            Id = entity.StudentId,
            FullName = fullName,
            FirstName = entity.FirstName,
            MiddleName = entity.MiddleName ?? string.Empty,
            LastName = entity.LastName,
            Suffix = entity.Suffix ?? string.Empty,
            GradeLevel = gradeLevelName,
            Section = sectionName,
            SchoolYear = schoolYear,
            Status = entity.Status,
            LRN = hasRealLrn ? rawLrn : "N/A",

            BirthDate = entity.Birthdate,
            PlaceOfBirth = entity.PlaceOfBirth ?? string.Empty,
            Sex = entity.Sex,
            MotherTongue = entity.MotherTongue ?? string.Empty,
            IsIPCommunity = entity.IpComm ? "Yes" : "No",
            IPCommunitySpecify = entity.IpSpecify ?? string.Empty,
            Is4PsBeneficiary = entity.FourPs ? "Yes" : "No",
            FourPsHouseholdId = entity.FourPsHseId ?? string.Empty,

            CurrentHouseNo = entity.HseNo ?? string.Empty,
            CurrentStreetName = entity.Street ?? string.Empty,
            CurrentBarangay = entity.Brngy ?? string.Empty,
            CurrentCity = entity.City ?? string.Empty,
            CurrentProvince = entity.Province ?? string.Empty,
            CurrentCountry = entity.Country ?? string.Empty,
            CurrentZipCode = entity.ZipCode ?? string.Empty,

            // Permanent address
            PermanentHouseNo = entity.PhseNo ?? string.Empty,
            PermanentStreetName = entity.Pstreet ?? string.Empty,
            PermanentBarangay = entity.Pbrngy ?? string.Empty,
            PermanentCity = entity.Pcity ?? string.Empty,
            PermanentProvince = entity.Pprovince ?? string.Empty,
            PermanentCountry = entity.Pcountry ?? string.Empty,
            PermanentZipCode = entity.PzipCode ?? string.Empty,

            GuardianFirstName = entity.Guardian?.FirstName ?? string.Empty,
            GuardianMiddleName = entity.Guardian?.MiddleName ?? string.Empty,
            GuardianLastName = entity.Guardian?.LastName ?? string.Empty,
            GuardianSuffix = entity.Guardian?.Suffix ?? string.Empty,
            GuardianContactNumber = entity.Guardian?.ContactNum ?? string.Empty,
            GuardianRelationship = entity.Guardian?.Relationship ?? string.Empty,

            StudentType = entity.StudentType,
            HasLRN = hasRealLrn ? "Yes" : "No",
            LearnerReferenceNo = hasRealLrn ? rawLrn : "N/A",
            GradeToEnroll = gradeLevelName,
            HasBirthCertificate = hasBirthCert,

            // Detailed requirement checklist
            HasPSABirthCert = IsRequirementChecked("PSA Birth Certificate"),
            HasBaptismalCert = IsRequirementChecked("Baptismal Certificate"),
            HasReportCard = IsRequirementChecked("Report Card"),
            HasForm138 = IsRequirementChecked("Form 138 (Report Card)"),
            HasForm137 = IsRequirementChecked("Form 137 (Permanent Record)"),
            HasGoodMoralCert = IsRequirementChecked("Good Moral Certificate"),
            HasTransferCert = IsRequirementChecked("Transfer Certificate"),
            HasUpdatedEnrollmentForm = IsRequirementChecked("Updated Enrollment Form"),
            HasClearance = IsRequirementChecked("Clearance"),

            PaymentStatus = entity.PaymentStatus ?? "N/A"
        };

        // Load academic records from database
        await LoadAcademicRecordsAsync(entity.StudentId);

        // Build enrollment status records from all enrollments
        SelectedEnrollmentRecords = entity.SectionEnrollments
            .OrderByDescending(e => e.CreatedAt)
            .Select(e => new EnrollmentStatusData
            {
                SchoolYear = e.SchoolYear,
                Grade = e.Section.GradeLevel?.GradeLevelName ?? entity.GradeLevel ?? string.Empty,
                Section = e.Section.SectionName ?? string.Empty,
                Type = entity.StudentType,
                Documents = DocumentsVerifiedHelper.CalculateDocumentsVerified(entity.Requirements, entity.StudentType) ? "Verified" : "Pending",
                PaymentStatus = entity.PaymentStatus ?? "N/A",
                Status = e.Status
            })
            .ToList();

        ShowDetailView = true;
        StateHasChanged();
    }

    private async Task HandleBackClick()
    {
        ShowDetailView = false;
        // Reload students list when going back
        await LoadStudentsAsync();
        // Clear selected data when going back
        SelectedStudentData = new StudentDetailData();
        SelectedAcademicRecords = new List<AcademicRecordData>();
        SelectedEnrollmentRecords = new List<EnrollmentStatusData>();
        StateHasChanged();
    }

    private async Task HandleStudentUpdated(StudentDetailData updatedData)
    {
        // Small delay to ensure database changes are committed
        await Task.Delay(100);
        
        // Reload the student data to get the latest information
        var entity = await StudentService.GetStudentByIdAsync(updatedData.Id);
        if (entity != null)
        {
            // Rebuild SelectedStudentData with updated information
            var fullName = $"{entity.FirstName} {entity.MiddleName} {entity.LastName}"
                .Replace("  ", " ")
                .Trim();

            var hasRealLrn = !string.IsNullOrWhiteSpace(entity.Lrn);
            var rawLrn = entity.Lrn ?? string.Empty;

            var latestEnrollment = entity.SectionEnrollments
                .OrderByDescending(e => e.CreatedAt)
                .FirstOrDefault();

            var sectionName = latestEnrollment?.Section?.SectionName ?? string.Empty;
            var gradeLevelName = latestEnrollment?.Section?.GradeLevel?.GradeLevelName ?? entity.GradeLevel ?? string.Empty;
            var schoolYear = latestEnrollment?.SchoolYear ?? entity.SchoolYr ?? string.Empty;

            SelectedStudentData = new StudentDetailData
            {
                Id = entity.StudentId,
                FullName = fullName,
                FirstName = entity.FirstName,
                MiddleName = entity.MiddleName ?? string.Empty,
                LastName = entity.LastName,
                Suffix = entity.Suffix ?? string.Empty,
                GradeLevel = gradeLevelName,
                Section = sectionName,
                SchoolYear = schoolYear,
                Status = entity.Status,
                LRN = hasRealLrn ? rawLrn : "N/A",
                BirthDate = entity.Birthdate,
                PlaceOfBirth = entity.PlaceOfBirth ?? string.Empty,
                Sex = entity.Sex,
                MotherTongue = entity.MotherTongue ?? string.Empty,
                IsIPCommunity = entity.IpComm ? "Yes" : "No",
                IPCommunitySpecify = entity.IpSpecify ?? string.Empty,
                Is4PsBeneficiary = entity.FourPs ? "Yes" : "No",
                FourPsHouseholdId = entity.FourPsHseId ?? string.Empty,
                CurrentHouseNo = entity.HseNo ?? string.Empty,
                CurrentStreetName = entity.Street ?? string.Empty,
                CurrentBarangay = entity.Brngy ?? string.Empty,
                CurrentCity = entity.City ?? string.Empty,
                CurrentProvince = entity.Province ?? string.Empty,
                CurrentCountry = entity.Country ?? string.Empty,
                CurrentZipCode = entity.ZipCode ?? string.Empty,
                PermanentHouseNo = entity.PhseNo ?? string.Empty,
                PermanentStreetName = entity.Pstreet ?? string.Empty,
                PermanentBarangay = entity.Pbrngy ?? string.Empty,
                PermanentCity = entity.Pcity ?? string.Empty,
                PermanentProvince = entity.Pprovince ?? string.Empty,
                PermanentCountry = entity.Pcountry ?? string.Empty,
                PermanentZipCode = entity.PzipCode ?? string.Empty,
                GuardianFirstName = entity.Guardian?.FirstName ?? string.Empty,
                GuardianMiddleName = entity.Guardian?.MiddleName ?? string.Empty,
                GuardianLastName = entity.Guardian?.LastName ?? string.Empty,
                GuardianSuffix = entity.Guardian?.Suffix ?? string.Empty,
                GuardianContactNumber = entity.Guardian?.ContactNum ?? string.Empty,
                GuardianRelationship = entity.Guardian?.Relationship ?? string.Empty,
                StudentType = entity.StudentType,
                HasLRN = hasRealLrn ? "Yes" : "No",
                LearnerReferenceNo = hasRealLrn ? rawLrn : "N/A",
                GradeToEnroll = gradeLevelName
            };
        }
        
        // Reload students list to reflect changes
        await LoadStudentsAsync();
        StateHasChanged();
    }

    /// <summary>
    /// Loads academic records for a student from the database
    /// </summary>
    private async Task LoadAcademicRecordsAsync(string studentId)
    {
        try
        {
            // Get the student entity to access enrollment history
            var studentEntity = await StudentService.GetStudentByIdAsync(studentId);
            if (studentEntity == null)
            {
                SelectedAcademicRecords = new List<AcademicRecordData>();
                return;
            }

            // Get all unique school years from student's enrollment history
            var schoolYears = studentEntity.SectionEnrollments
                .Select(e => e.SchoolYear)
                .Where(sy => !string.IsNullOrWhiteSpace(sy))
                .Distinct()
                .ToList();

            // If no enrollments, also check current and previous years
            if (!schoolYears.Any())
            {
                var currentYear = DateTime.Now.Year;
                for (int i = 0; i < 4; i++)
                {
                    schoolYears.Add($"{currentYear - i}-{currentYear - i + 1}");
                }
            }

            var allGrades = new List<BrightEnroll_DES.Data.Models.Grade>();
            
            // Get grades for each school year
            foreach (var schoolYear in schoolYears)
            {
                try
                {
                    var grades = await GradeService.GetStudentGradesAsync(studentId, schoolYear);
                    if (grades != null && grades.Any())
                    {
                        allGrades.AddRange(grades);
                    }
                }
                catch
                {
                    // Continue if one year fails
                }
            }
            
            if (!allGrades.Any())
            {
                SelectedAcademicRecords = new List<AcademicRecordData>();
                return;
            }

            // Group grades by school year and subject
            var academicRecords = allGrades
                .GroupBy(g => new 
                { 
                    g.SchoolYear, 
                    g.SubjectId, 
                    SubjectName = g.Subject?.SubjectName ?? string.Empty,
                    GradeLevelName = g.Section?.GradeLevel?.GradeLevelName ?? string.Empty
                })
                .Select(group =>
                {
                    var q1Grade = group.FirstOrDefault(g => g.GradingPeriod == "Q1" || g.GradingPeriod == "Quarter 1");
                    var q2Grade = group.FirstOrDefault(g => g.GradingPeriod == "Q2" || g.GradingPeriod == "Quarter 2");
                    var q3Grade = group.FirstOrDefault(g => g.GradingPeriod == "Q3" || g.GradingPeriod == "Quarter 3");
                    var q4Grade = group.FirstOrDefault(g => g.GradingPeriod == "Q4" || g.GradingPeriod == "Quarter 4");

                    // Check if quarters have valid grades
                    var hasQ1 = q1Grade?.FinalGrade.HasValue == true && q1Grade.FinalGrade.Value > 0;
                    var hasQ2 = q2Grade?.FinalGrade.HasValue == true && q2Grade.FinalGrade.Value > 0;
                    var hasQ3 = q3Grade?.FinalGrade.HasValue == true && q3Grade.FinalGrade.Value > 0;
                    var hasQ4 = q4Grade?.FinalGrade.HasValue == true && q4Grade.FinalGrade.Value > 0;

                    // Count how many quarters have grades
                    var quartersWithGrades = new List<decimal>();
                    if (hasQ1) quartersWithGrades.Add(q1Grade!.FinalGrade!.Value);
                    if (hasQ2) quartersWithGrades.Add(q2Grade!.FinalGrade!.Value);
                    if (hasQ3) quartersWithGrades.Add(q3Grade!.FinalGrade!.Value);
                    if (hasQ4) quartersWithGrades.Add(q4Grade!.FinalGrade!.Value);
                    
                    var finalGrade = quartersWithGrades.Any() ? quartersWithGrades.Average() : 0m;
                    
                    // Determine remarks based on completeness and grade
                    string remarks;
                    if (!quartersWithGrades.Any())
                    {
                        remarks = "No Grade";
                    }
                    else if (quartersWithGrades.Count < 4)
                    {
                        // Incomplete - not all quarters have grades
                        remarks = "Incomplete";
                    }
                    else
                    {
                        // All quarters present - calculate descriptive rating
                        var transmutedGrade = GradeService.GetTransmutedGrade(finalGrade);
                        remarks = GradeService.GetDescriptiveRating(transmutedGrade);
                    }

                    return new AcademicRecordData
                    {
                        SchoolYear = group.Key.SchoolYear,
                        Grade = group.Key.GradeLevelName,
                        Subject = group.Key.SubjectName,
                        Q1 = q1Grade?.FinalGrade.HasValue == true && q1Grade.FinalGrade.Value > 0 
                            ? q1Grade.FinalGrade.Value.ToString("F2") 
                            : "-",
                        Q2 = q2Grade?.FinalGrade.HasValue == true && q2Grade.FinalGrade.Value > 0 
                            ? q2Grade.FinalGrade.Value.ToString("F2") 
                            : "-",
                        Q3 = q3Grade?.FinalGrade.HasValue == true && q3Grade.FinalGrade.Value > 0 
                            ? q3Grade.FinalGrade.Value.ToString("F2") 
                            : "-",
                        Q4 = q4Grade?.FinalGrade.HasValue == true && q4Grade.FinalGrade.Value > 0 
                            ? q4Grade.FinalGrade.Value.ToString("F2") 
                            : "-",
                        FinalGrade = finalGrade > 0 ? finalGrade.ToString("F2") : "-",
                        Remarks = remarks
                    };
                })
                .OrderByDescending(r => r.SchoolYear)
                .ThenBy(r => r.Subject)
                .ToList();

            SelectedAcademicRecords = academicRecords;
        }
        catch (Exception ex)
        {
            // Log error but don't crash - just show empty list
            System.Diagnostics.Debug.WriteLine($"Error loading academic records: {ex.Message}");
            SelectedAcademicRecords = new List<AcademicRecordData>();
        }
    }

    private void HandleDropClick(EnrolledStudentDto student)
    {
        SelectedStudentForDrop = student;
        DropReason = string.Empty;
        ShowDropModal = true;
        StateHasChanged();
    }

    private void CloseDropModal()
    {
        ShowDropModal = false;
        SelectedStudentForDrop = null;
        DropReason = string.Empty;
        StateHasChanged();
    }

    private void HandleDropModalBackdropClick()
    {
        CloseDropModal();
    }

    private async Task ConfirmDropStudent()
    {
        if (SelectedStudentForDrop == null || string.IsNullOrWhiteSpace(DropReason))
        {
            ShowToast("Please provide a reason for dropping the student.", ToastType.Error);
            return;
        }

        try
        {
            // Get current user information for audit logging
            var currentUser = AuthService.CurrentUser;
            var droppedByName = currentUser != null 
                ? $"{currentUser.first_name} {currentUser.last_name}".Trim()
                : "Unknown";
            var droppedById = currentUser?.user_ID;
            var droppedByRole = currentUser?.user_role ?? "Unknown";

            // Archive the student with status "Withdrawn" and the provided reason
            await ArchiveService.ArchiveStudentAsync(
                studentId: SelectedStudentForDrop.Id,
                archiveReason: "Withdrawn", // Status
                reason: DropReason.Trim() // Archive reason
            );

            // Create audit log entry for dropping the student
            if (AuditLogService != null)
            {
                try
                {
                    await AuditLogService.CreateStudentDropLogAsync(
                        studentId: SelectedStudentForDrop.Id,
                        studentName: SelectedStudentForDrop.Name,
                        archiveReason: "Withdrawn",
                        droppedBy: droppedByName,
                        droppedById: droppedById,
                        userRole: droppedByRole,
                        ipAddress: null
                    );
                }
                catch
                {
                    // Don't fail the drop operation if audit logging fails
                }
            }

            ShowToast($"Student {SelectedStudentForDrop.Name} has been dropped and moved to archive.", ToastType.Success);
            
            // Close modal and reload students
            CloseDropModal();
            await LoadStudentsAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ShowToast($"Error dropping student: {ex.Message}", ToastType.Error);
        }
    }

    private void ShowToast(string message, ToastType type)
    {
        toastMessage = message;
        toastType = type;
        showToast = true;
        StateHasChanged();
    }

    private void CloseToast()
    {
        showToast = false;
        StateHasChanged();
    }

}
</RoleAuthorizeView>
