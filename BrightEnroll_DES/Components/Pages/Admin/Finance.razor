@page "/finance"
@layout Components.Layout.MainLayout
@inject IJSRuntime JSRuntime
@inject BrightEnroll_DES.Services.Finance.FeeService FeeService
@inject Microsoft.Extensions.Logging.ILogger<Finance> Logger

@using BrightEnroll_DES.Components.Pages.Admin.FinanceComponents
@using BrightEnroll_DES.Services.Finance
@using BrightEnroll_DES.Components
@using BrightEnroll_DES.Services
@using Microsoft.Extensions.Logging

<PageTitle>Finance</PageTitle>

<!-- Toast Notification -->
<ToastNotification Show="@showToast" Message="@toastMessage" Type="@toastType" OnClose="CloseToast" Duration="4000" />

<div class="text-gray-800">
    <h1 class="mb-6 text-2xl font-bold text-gray-800">Finance</h1>
    
    <!-- Tabs Card -->
    <div class="mb-6 overflow-hidden rounded-xl border-b border-gray-200 bg-white px-4 py-2 shadow">
        <div class="flex items-center gap-6">
            <button @onclick='() => SetActiveTab("FeeSetup")' 
                    class="@GetTabClasses("FeeSetup")"
                    style="@GetFeeSetupStyle()">
                Fee Setup
            </button>
            <button @onclick='() => SetActiveTab("Payments")' 
                    class="@GetTabClasses("Payments")">
                Payments
            </button>
            <button @onclick='() => SetActiveTab("Expenses")' 
                    class="@GetTabClasses("Expenses")">
                Expenses
            </button>
            <button @onclick='() => SetActiveTab("Records")' 
                    class="@GetTabClasses("Records")">
                Records
            </button>
        </div>
    </div>

    <!-- Card Container -->
    <div class="overflow-hidden rounded-xl bg-white shadow">
        @if (activeTab == "FeeSetup")
        {
            <FeeSetup FeeList="FeeList" 
                      OnFeeAdded="HandleFeeAdded" 
                      OnFeeUpdated="HandleFeeUpdated" />
        }
        else if (activeTab == "Payments")
        {
            <Payments PaymentData="PaymentData" 
                      OnPaymentProcessed="HandlePaymentProcessed" />
        }
        else if (activeTab == "Expenses")
        {
            <Expenses ExpenseForm="ExpenseForm" 
                      OnExpenseSaved="HandleExpenseSaved" />
        }
        else if (activeTab == "Records")
        {
            <Records PaymentRecords="PaymentRecords" 
                     OnViewPaymentDetails="HandleViewPaymentDetails" 
                     OnEditPaymentRecord="HandleEditPaymentRecord" 
                     OnExportPDF="HandleExportPDF" />
        }
    </div>
</div>

@code {
    private string activeTab = "FeeSetup";

    // Fee Setup Data
    private List<FeeModel> FeeList = new();
    
    // Toast notification
    private bool showToast = false;
    private string toastMessage = "";
    private ToastType toastType = ToastType.Success;
    
    // Prevent concurrent submissions
    private bool _isProcessingFee = false;

    // Payments Data
    private PaymentDataModel PaymentData = new()
    {
        StudentId = "547635",
        StudentName = "Darrell Carol",
        GradeLevel = "Grade 1",
        TotalFee = 11300,
        AmountPaid = 8300,
        Balance = 3000,
        PaymentStatus = "Partially Paid",
        NewPaymentAmount = 0,
        PaymentMethod = "Cash"
    };

    // Expenses Data
    private ExpenseFormModel ExpenseForm = new()
    {
        ExpenseId = $"EXP-{DateTime.Now:yyyyMMddHHmmss}",
        RecordedBy = "Admin User",
        ExpenseDate = DateTime.Now,
        PaymentMethod = "Cash",
        Status = "Pending"
    };

    // Records Data
    private List<PaymentRecord> PaymentRecords = new()
    {
        new() { StudentId = "547635", Name = "Darrell Carol", Grade = "Grade 1", TotalFee = 11300, AmountPaid = 8300, Balance = 3000, PaymentStatus = "Partially Paid" }
    };

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private string GetFeeSetupStyle()
    {
        bool isSelected = activeTab == "FeeSetup";
        if (isSelected)
        {
            return "color: #0E335D; border-bottom: 2px solid #0E335D;";
        }
        else
        {
            return "color: #0E335D;";
        }
    }

    private string GetTabClasses(string tab)
    {
        bool isSelected = activeTab == tab;
        
        return tab switch
        {
            "FeeSetup" => isSelected
                ? "px-3 py-2 text-sm font-semibold"
                : "px-3 py-2 text-sm font-semibold transition-colors duration-200",
            "Payments" => isSelected
                ? "px-3 py-2 text-sm font-semibold text-green-600 border-b-2 border-green-600"
                : "px-3 py-2 text-sm font-semibold text-green-600 transition-colors duration-200 hover:text-green-700",
            "Expenses" => isSelected
                ? "px-3 py-2 text-sm font-semibold text-orange-600 border-b-2 border-orange-600"
                : "px-3 py-2 text-sm font-semibold text-orange-600 transition-colors duration-200 hover:text-orange-700",
            "Records" => isSelected
                ? "px-3 py-2 text-sm font-semibold text-blue-600 border-b-2 border-blue-600"
                : "px-3 py-2 text-sm font-semibold text-blue-600 transition-colors duration-200 hover:text-blue-700",
            _ => "px-3 py-2 text-sm font-semibold"
        };
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadFeesAsync();
    }

    private async Task LoadFeesAsync()
    {
        try
        {
            var fees = await FeeService.GetAllFeesAsync();
            
            // Map Fee entities to FeeModel for UI
            FeeList = fees.Select(f => new FeeModel
            {
                GradeLevel = f.GradeLevel?.GradeLevelName ?? "N/A",
                TuitionFee = f.TuitionFee,
                MiscFee = f.MiscFee,
                OtherFee = f.OtherFee,
                TuitionBreakdown = f.Breakdowns
                    .Where(b => b.BreakdownType == "Tuition")
                    .OrderBy(b => b.DisplayOrder)
                    .Select(b => new FeeBreakdownItem
                    {
                        Name = b.ItemName,
                        AmountString = b.Amount.ToString("N2")
                    }).ToList(),
                MiscBreakdown = f.Breakdowns
                    .Where(b => b.BreakdownType == "Misc")
                    .OrderBy(b => b.DisplayOrder)
                    .Select(b => new FeeBreakdownItem
                    {
                        Name = b.ItemName,
                        AmountString = b.Amount.ToString("N2")
                    }).ToList(),
                OtherBreakdown = f.Breakdowns
                    .Where(b => b.BreakdownType == "Other")
                    .OrderBy(b => b.DisplayOrder)
                    .Select(b => new FeeBreakdownItem
                    {
                        Name = b.ItemName,
                        AmountString = b.Amount.ToString("N2")
                    }).ToList()
            }).ToList();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading fees: {Message}", ex.Message);
            FeeList = new List<FeeModel>();
            
            // Show error toast
            toastMessage = ErrorMessageHelper.ToHumanReadable($"Failed to load fees: {ex.Message}");
            toastType = ToastType.Error;
            showToast = true;
        }
        finally
        {
            StateHasChanged();
        }
    }

    // Event Handlers
    private async Task HandleFeeAdded(FeeModel fee)
    {
        // Prevent concurrent submissions
        if (_isProcessingFee)
        {
            return;
        }
        
        _isProcessingFee = true;
        StateHasChanged();
        
        try
        {
            // Get grade level ID from name
            var gradeLevels = await FeeService.GetAllGradeLevelsAsync();
            var gradeLevel = gradeLevels.FirstOrDefault(g => g.GradeLevelName == fee.GradeLevel);
            
            if (gradeLevel == null)
            {
                Logger?.LogError("Grade level not found: {GradeLevel}", fee.GradeLevel);
                toastMessage = ErrorMessageHelper.ToHumanReadable($"Grade level '{fee.GradeLevel}' not found. Please select a valid grade level.");
                toastType = ToastType.Error;
                showToast = true;
                StateHasChanged();
                return;
            }

            // Create request with breakdown items (filter out empty items)
            var request = new CreateFeeRequest
            {
                GradeLevelId = gradeLevel.GradeLevelId,
                TuitionFee = fee.TuitionFee,
                MiscFee = fee.MiscFee,
                OtherFee = fee.OtherFee,
                TuitionBreakdown = fee.TuitionBreakdown
                    .Where(b => !string.IsNullOrWhiteSpace(b.Name) && b.Amount > 0)
                    .Select(b => new FeeBreakdownItemDto
                    {
                        Name = b.Name.Trim(),
                        Amount = b.Amount
                    }).ToList(),
                MiscBreakdown = fee.MiscBreakdown
                    .Where(b => !string.IsNullOrWhiteSpace(b.Name) && b.Amount > 0)
                    .Select(b => new FeeBreakdownItemDto
                    {
                        Name = b.Name.Trim(),
                        Amount = b.Amount
                    }).ToList(),
                OtherBreakdown = fee.OtherBreakdown
                    .Where(b => !string.IsNullOrWhiteSpace(b.Name) && b.Amount > 0)
                    .Select(b => new FeeBreakdownItemDto
                    {
                        Name = b.Name.Trim(),
                        Amount = b.Amount
                    }).ToList(),
                CreatedBy = "Admin" // TODO: Get from current user context
            };

            await FeeService.CreateFeeAsync(request);
            
            // Reload fees from database
            await LoadFeesAsync();
            
            // Show success toast
            toastMessage = $"Fee for {fee.GradeLevel} added successfully!";
            toastType = ToastType.Success;
            showToast = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error adding fee: {Message}. Stack trace: {StackTrace}", ex.Message, ex.StackTrace);
            
            // Show error toast
            toastMessage = ErrorMessageHelper.ToHumanReadable($"Failed to add fee: {ex.Message}");
            toastType = ToastType.Error;
            showToast = true;
            StateHasChanged();
        }
        finally
        {
            _isProcessingFee = false;
            StateHasChanged();
        }
    }

    private async Task HandleFeeUpdated(FeeModel fee)
    {
        try
        {
            // Get grade level ID from name
            var gradeLevels = await FeeService.GetAllGradeLevelsAsync();
            var gradeLevel = gradeLevels.FirstOrDefault(g => g.GradeLevelName == fee.GradeLevel);
            
            if (gradeLevel == null)
            {
                Logger?.LogError("Grade level not found: {GradeLevel}", fee.GradeLevel);
                toastMessage = ErrorMessageHelper.ToHumanReadable($"Grade level '{fee.GradeLevel}' not found.");
                toastType = ToastType.Error;
                showToast = true;
                StateHasChanged();
                return;
            }

            // Get existing fee
            var existingFee = await FeeService.GetFeeByGradeLevelIdAsync(gradeLevel.GradeLevelId);
            
            if (existingFee == null)
            {
                Logger?.LogError("Fee not found for grade level: {GradeLevel}", fee.GradeLevel);
                toastMessage = ErrorMessageHelper.ToHumanReadable($"Fee not found for {fee.GradeLevel}.");
                toastType = ToastType.Error;
                showToast = true;
                StateHasChanged();
                return;
            }

            // Create update request with breakdown items (filter out empty items)
            var request = new UpdateFeeRequest
            {
                TuitionFee = fee.TuitionFee,
                MiscFee = fee.MiscFee,
                OtherFee = fee.OtherFee,
                TuitionBreakdown = fee.TuitionBreakdown
                    .Where(b => !string.IsNullOrWhiteSpace(b.Name) && b.Amount > 0)
                    .Select(b => new FeeBreakdownItemDto
                    {
                        Name = b.Name.Trim(),
                        Amount = b.Amount
                    }).ToList(),
                MiscBreakdown = fee.MiscBreakdown
                    .Where(b => !string.IsNullOrWhiteSpace(b.Name) && b.Amount > 0)
                    .Select(b => new FeeBreakdownItemDto
                    {
                        Name = b.Name.Trim(),
                        Amount = b.Amount
                    }).ToList(),
                OtherBreakdown = fee.OtherBreakdown
                    .Where(b => !string.IsNullOrWhiteSpace(b.Name) && b.Amount > 0)
                    .Select(b => new FeeBreakdownItemDto
                    {
                        Name = b.Name.Trim(),
                        Amount = b.Amount
                    }).ToList(),
                UpdatedBy = "Admin" // TODO: Get from current user context
            };

            await FeeService.UpdateFeeAsync(existingFee.FeeId, request);
            
            // Reload fees from database
            await LoadFeesAsync();
            
            // Show success toast
            toastMessage = $"Fee for {fee.GradeLevel} updated successfully!";
            toastType = ToastType.Success;
            showToast = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error updating fee: {Message}. Stack trace: {StackTrace}", ex.Message, ex.StackTrace);
            
            // Show error toast
            toastMessage = ErrorMessageHelper.ToHumanReadable($"Failed to update fee: {ex.Message}");
            toastType = ToastType.Error;
            showToast = true;
            StateHasChanged();
        }
    }
    
    private void CloseToast()
    {
        showToast = false;
        toastMessage = "";
        StateHasChanged();
    }

    private void HandlePaymentProcessed(PaymentDataModel paymentData)
    {
        // Update payment records
        var record = PaymentRecords.FirstOrDefault(r => r.StudentId == paymentData.StudentId);
        if (record != null)
        {
            record.AmountPaid = paymentData.AmountPaid;
            record.Balance = paymentData.Balance;
            record.PaymentStatus = paymentData.PaymentStatus;
        }
        else
        {
            PaymentRecords.Add(new PaymentRecord
            {
                StudentId = paymentData.StudentId,
                Name = paymentData.StudentName,
                Grade = paymentData.GradeLevel,
                TotalFee = paymentData.TotalFee,
                AmountPaid = paymentData.AmountPaid,
                Balance = paymentData.Balance,
                PaymentStatus = paymentData.PaymentStatus
            });
        }
        StateHasChanged();
    }

    private void HandleExpenseSaved(ExpenseFormModel expenseForm)
    {
        // TODO: Save expense to database
        // For now, just reset the form
        ExpenseForm = new ExpenseFormModel
        {
            ExpenseId = $"EXP-{DateTime.Now:yyyyMMddHHmmss}",
            RecordedBy = "Admin User",
            ExpenseDate = DateTime.Now,
            PaymentMethod = "Cash",
            Status = "Pending"
        };
        StateHasChanged();
    }

    private void HandleViewPaymentDetails(PaymentRecord record)
    {
        // TODO: Implement view payment details logic
        // Could open a modal or navigate to a detail page
    }

    private void HandleEditPaymentRecord(PaymentRecord record)
    {
        // TODO: Implement edit payment record logic
        // Could open a modal or navigate to an edit page
    }

    private async Task HandleExportPDF()
    {
        // TODO: Implement PDF export functionality
        // This would typically generate a PDF with all payment records
        await Task.CompletedTask;
    }
}
