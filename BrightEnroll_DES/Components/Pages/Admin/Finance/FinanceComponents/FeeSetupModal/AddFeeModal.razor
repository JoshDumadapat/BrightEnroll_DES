@namespace BrightEnroll_DES.Components.Pages.Admin.Finance.FinanceComponents.FeeSetupModal
@using BrightEnroll_DES.Components.Pages.Admin.Finance.FinanceComponents
@using BrightEnroll_DES.Components.Pages.Admin.HumanResource.HRComponents
@using BrightEnroll_DES.Components.Pages.Admin.HumanResource.HRCS
@using BrightEnroll_DES.Components
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.Business.Finance
@using BrightEnroll_DES.Data.Models
@using System.Linq
@inject BrightEnroll_DES.Services.Business.Finance.FeeService FeeService
@inject IJSRuntime JSRuntime

<!-- Toast Notification -->
<ToastNotification Show="@showToast" Message="@toastMessage" Type="@toastType" OnClose="CloseToast" Duration="4000" />

@if (IsVisible)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @onclick="HandleBackdropClick">
        <div id="add-fee-modal" class="flex max-h-[90vh] w-full max-w-5xl flex-col rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <!-- Modal Header -->
            <div class="flex items-center justify-center rounded-t-2xl bg-blue-600 px-6 py-2 flex-shrink-0">
                <h3 class="text-lg font-semibold text-white">Add Fee</h3>
            </div>

            <!-- Modal Body - Scrollable -->
            <div class="overflow-y-auto px-6 py-4 flex-1">
                <form @onsubmit:preventDefault="true">
                    <!-- Row 1: Grade Level -->
                    <div class="mb-4">
                        <label class="mb-2 block text-base font-medium text-gray-700">
                            Select Grade Level <span class="text-red-500">*</span>
                        </label>
                        <select @bind="FormData.GradeLevel" @bind:after="OnGradeLevelChanged" required
                                class="w-full rounded-lg border @(gradeLevelError ? "border-red-500" : "border-gray-300") bg-white px-3 py-2.5 text-base text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400">
                            <option value="">Select Grade Level</option>
                            @if (AvailableGradeLevels.Any())
                            {
                                @foreach (var gradeLevel in AvailableGradeLevels)
                                {
                                    <option value="@gradeLevel.GradeLevelName">@gradeLevel.GradeLevelName</option>
                                }
                            }
                            else
                            {
                                <option value="" disabled>No available grade levels (all have fees)</option>
                            }
                        </select>
                        @if (gradeLevelError)
                        {
                            <p class="mt-1 text-sm text-red-600">@gradeLevelErrorMessage</p>
                        }
                        @if (ExistingFees != null && ExistingFees.Any() && !AvailableGradeLevels.Any())
                        {
                            <p class="mt-1 text-sm text-amber-600">All grade levels already have fees. To modify a fee, please use the Edit button on the existing fee entry.</p>
                        }
                    </div>

                    <!-- Row 2: Three Columns for Fee Breakdowns -->
                    <div class="mb-4 grid grid-cols-3 gap-4">
                        <!-- Tuition Fee Column -->
                        <div class="flex flex-col">
                            <label class="mb-2 block text-base font-medium text-gray-700">
                                Tuition Fee <span class="text-red-500">*</span>
                            </label>
                            <div class="flex flex-col border border-gray-200 rounded-lg bg-gray-50" style="max-height: 280px;">
                                <div class="overflow-y-auto flex-1 p-2 space-y-2">
                                    @foreach (var item in TuitionBreakdown)
                                    {
                                        <div class="flex flex-col gap-1 bg-white p-2 rounded border border-gray-200">
                                            <input type="text" @bind="item.Name" @bind:after="@(() => { FormatItemName(item); OnTuitionChanged(); })" 
                                                   placeholder="Item name"
                                                   class="w-full rounded border border-gray-300 bg-white px-2 py-1.5 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-400" />
                                            <div class="flex items-center gap-1">
                                                <div class="relative flex-1">
                                                    <span class="absolute left-2 top-1/2 -translate-y-1/2 text-sm text-gray-600">₱</span>
                                                    <input type="text" 
                                                           value="@GetAmountDisplayValue(item)" 
                                                           @oninput='(e) => HandleAmountInput(e, item, "tuition")' 
                                                           onkeypress="return (event.key === '.' && this.value.includes('.')) ? false : (/[0-9.]/i.test(event.key) || event.key === 'Backspace' || event.key === 'Delete' || event.key === 'ArrowLeft' || event.key === 'ArrowRight' || event.key === 'Tab' || event.key === 'Enter')"
                                                           @onpaste='(e) => HandleAmountPaste(e, item, "tuition")' 
                                                           @onfocus='(e) => HandleAmountFocus(e, item)' 
                                                           @onblur='(e) => HandleAmountBlur(e, item, "tuition")' 
                                                           pattern="[0-9.]*"
                                                           inputmode="decimal"
                                                           placeholder="0.00"
                                                           class="w-full rounded border border-gray-300 bg-white pl-7 pr-2 py-1.5 text-sm text-right text-gray-700 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-400" />
                                                </div>
                                                <button type="button" @onclick="() => OnRemoveTuitionItem(item)" 
                                                        class="rounded bg-red-50 p-1.5 text-red-600 hover:bg-red-100">
                                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <button type="button" @onclick="OnAddTuitionItem" 
                                        class="mx-2 mb-2 rounded-full border border-dashed border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 hover:bg-gray-100">
                                    + Add Item
                                </button>
                            </div>
                            <div class="relative mt-2">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-600">₱</span>
                                <input type="text" value="@FormData.TuitionFeeString" readonly
                                       placeholder="0.00"
                                       class="w-full rounded-lg border border-gray-300 bg-gray-50 pl-8 pr-3 py-2.5 text-base text-right text-gray-700 outline-none" />
                            </div>
                        </div>

                        <!-- Misc Fee Column -->
                        <div class="flex flex-col">
                            <label class="mb-2 block text-base font-medium text-gray-700">
                                Misc Fee <span class="text-red-500">*</span>
                            </label>
                            <div class="flex flex-col border border-gray-200 rounded-lg bg-gray-50" style="max-height: 280px;">
                                <div class="overflow-y-auto flex-1 p-2 space-y-2">
                                    @foreach (var item in MiscBreakdown)
                                    {
                                        <div class="flex flex-col gap-1 bg-white p-2 rounded border border-gray-200">
                                            <input type="text" @bind="item.Name" @bind:after="@(() => { FormatItemName(item); OnMiscChanged(); })" 
                                                   placeholder="Item name"
                                                   class="w-full rounded border border-gray-300 bg-white px-2 py-1.5 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-400" />
                                            <div class="flex items-center gap-1">
                                                <div class="relative flex-1">
                                                    <span class="absolute left-2 top-1/2 -translate-y-1/2 text-sm text-gray-600">₱</span>
                                                    <input type="text" 
                                                           value="@GetAmountDisplayValue(item)" 
                                                           @oninput='(e) => HandleAmountInput(e, item, "misc")' 
                                                           onkeypress="return (event.key === '.' && this.value.includes('.')) ? false : (/[0-9.]/i.test(event.key) || event.key === 'Backspace' || event.key === 'Delete' || event.key === 'ArrowLeft' || event.key === 'ArrowRight' || event.key === 'Tab' || event.key === 'Enter')"
                                                           @onpaste='(e) => HandleAmountPaste(e, item, "misc")' 
                                                           @onfocus='(e) => HandleAmountFocus(e, item)' 
                                                           @onblur='(e) => HandleAmountBlur(e, item, "misc")' 
                                                           pattern="[0-9.]*"
                                                           inputmode="decimal"
                                                           placeholder="0.00"
                                                           class="w-full rounded border border-gray-300 bg-white pl-7 pr-2 py-1.5 text-sm text-right text-gray-700 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-400" />
                                                </div>
                                                <button type="button" @onclick="() => OnRemoveMiscItem(item)" 
                                                        class="rounded bg-red-50 p-1.5 text-red-600 hover:bg-red-100">
                                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <button type="button" @onclick="OnAddMiscItem" 
                                        class="mx-2 mb-2 rounded-full border border-dashed border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 hover:bg-gray-100">
                                    + Add Item
                                </button>
                            </div>
                            <div class="relative mt-2">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-600">₱</span>
                                <input type="text" value="@FormData.MiscFeeString" readonly
                                       placeholder="0.00"
                                       class="w-full rounded-lg border border-gray-300 bg-gray-50 pl-8 pr-3 py-2.5 text-base text-right text-gray-700 outline-none" />
                            </div>
                        </div>

                        <!-- Other Fee Column -->
                        <div class="flex flex-col">
                            <label class="mb-2 block text-base font-medium text-gray-700">
                                Other Fee <span class="text-red-500">*</span>
                            </label>
                            <div class="flex flex-col border border-gray-200 rounded-lg bg-gray-50" style="max-height: 280px;">
                                <div class="overflow-y-auto flex-1 p-2 space-y-2">
                                    @foreach (var item in OtherBreakdown)
                                    {
                                        <div class="flex flex-col gap-1 bg-white p-2 rounded border border-gray-200">
                                            <input type="text" @bind="item.Name" @bind:after="@(() => { FormatItemName(item); OnOtherChanged(); })" 
                                                   placeholder="Item name"
                                                   class="w-full rounded border border-gray-300 bg-white px-2 py-1.5 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-400" />
                                            <div class="flex items-center gap-1">
                                                <div class="relative flex-1">
                                                    <span class="absolute left-2 top-1/2 -translate-y-1/2 text-sm text-gray-600">₱</span>
                                                    <input type="text" 
                                                           value="@GetAmountDisplayValue(item)" 
                                                           @oninput='(e) => HandleAmountInput(e, item, "other")' 
                                                           onkeypress="return (event.key === '.' && this.value.includes('.')) ? false : (/[0-9.]/i.test(event.key) || event.key === 'Backspace' || event.key === 'Delete' || event.key === 'ArrowLeft' || event.key === 'ArrowRight' || event.key === 'Tab' || event.key === 'Enter')"
                                                           @onpaste='(e) => HandleAmountPaste(e, item, "other")' 
                                                           @onfocus='(e) => HandleAmountFocus(e, item)' 
                                                           @onblur='(e) => HandleAmountBlur(e, item, "other")' 
                                                           pattern="[0-9.]*"
                                                           inputmode="decimal"
                                                           placeholder="0.00"
                                                           class="w-full rounded border border-gray-300 bg-white pl-7 pr-2 py-1.5 text-sm text-right text-gray-700 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-400" />
                                                </div>
                                                <button type="button" @onclick="() => OnRemoveOtherItem(item)" 
                                                        class="rounded bg-red-50 p-1.5 text-red-600 hover:bg-red-100">
                                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <button type="button" @onclick="OnAddOtherItem" 
                                        class="mx-2 mb-2 rounded-full border border-dashed border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 hover:bg-gray-100">
                                    + Add Item
                                </button>
                            </div>
                            <div class="relative mt-2">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-base text-gray-600">₱</span>
                                <input type="text" value="@FormData.OtherFeeString" readonly
                                       placeholder="0.00"
                                       class="w-full rounded-lg border border-gray-300 bg-gray-50 pl-8 pr-3 py-2.5 text-base text-right text-gray-700 outline-none" />
                            </div>
                        </div>
                    </div>

                    <!-- Total Fee -->
                    <div class="mb-4">
                        <label class="mb-2 block text-base font-medium text-gray-700">Total Fee:</label>
                        <div class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2.5 text-base font-semibold text-gray-700 text-right">
                            ₱ @TotalFee.ToString("N2")
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Modal Footer - Fixed -->
            <div class="flex justify-end gap-3 border-t border-gray-200 bg-white px-6 py-4 rounded-b-2xl flex-shrink-0">
                <button type="button" @onclick="HandleCancelClick" class="rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-base font-medium text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button type="button" @onclick="HandleSubmitClick" 
                        disabled="@_isProcessing"
                        class="rounded-lg bg-blue-600 px-4 py-2.5 text-base font-medium text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    @if (_isProcessing)
                    {
                        <span>Processing...</span>
                    }
                    else
                    {
                        <span>Add</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

<!-- Confirmation Modal for Submit -->
@if (showSubmitConfirmModal)
{
    <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-50" @onclick="CloseSubmitConfirmModal">
        <div id="add-fee-submit-modal" class="w-full max-w-md rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <div class="flex items-center justify-between rounded-t-2xl bg-white px-6 py-2.5 border-b border-gray-200">
                <h3 class="text-base font-semibold text-blue-600">Confirm Submission</h3>
                <button @onclick="CloseSubmitConfirmModal" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="px-6 py-4">
                <p class="text-sm text-gray-700">Are you sure you want to add this fee for <strong>@FormData.GradeLevel</strong>?</p>
                <p class="mt-2 text-sm text-gray-600">Total Fee: <strong>Php @TotalFee.ToString("N2")</strong></p>
            </div>
            <div class="flex justify-end gap-2 border-t border-gray-200 px-6 py-3">
                <button @onclick="CloseSubmitConfirmModal" class="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button @onclick="ConfirmSubmit" class="rounded-lg bg-blue-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-blue-700">
                    Confirm
                </button>
            </div>
        </div>
    </div>
}

<!-- Confirmation Modal for Cancel -->
@if (showCancelConfirmModal)
{
    <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-50" @onclick="CloseCancelConfirmModal">
        <div id="add-fee-cancel-modal" class="w-full max-w-md rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <div class="flex items-center justify-between rounded-t-2xl bg-white px-6 py-2.5 border-b border-gray-200">
                <h3 class="text-base font-semibold text-red-500">Cancel Add Fee</h3>
                <button @onclick="CloseCancelConfirmModal" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="px-6 py-4">
                <p class="mb-4 text-sm text-gray-700">Are you sure you want to cancel? All entered data will be cleared.</p>
                <div class="flex justify-end">
                    <button @onclick="ConfirmCancel" class="rounded-lg px-3 py-1.5 text-sm font-medium text-white transition-all hover:opacity-90" style="background-color: #ef4444;">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Validation Error Modal -->
@if (showValidationModal)
{
    <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-50" @onclick="CloseValidationModal">
        <div id="add-fee-validation-modal" class="w-full max-w-md rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <div class="flex items-center justify-between rounded-t-2xl bg-white px-6 py-2.5 border-b border-gray-200">
                <h3 class="text-base font-semibold text-red-500">Validation Error</h3>
            </div>
            <div class="px-6 py-4">
                <p class="mb-3 text-sm font-medium text-gray-800">Please fill in the following required fields:</p>
                <ul class="list-inside list-disc space-y-1 text-sm text-gray-700">
                    @foreach (var error in validationErrors)
                    {
                        <li>@error</li>
                    }
                </ul>
            </div>
            <div class="flex justify-end border-t border-gray-200 px-6 py-3">
                <button @onclick="CloseValidationModal" class="rounded-lg px-4 py-2 text-sm font-semibold text-white transition-all hover:opacity-90" style="background-color: #ef4444;">
                    OK
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<FeeModel> OnSubmit { get; set; }
    [Parameter] public List<FeeModel>? ExistingFees { get; set; } // List of existing fees to prevent duplicates

    private FeeFormData FormData { get; set; } = new();
    private List<FeeBreakdownItem> TuitionBreakdown { get; set; } = new();
    private List<FeeBreakdownItem> MiscBreakdown { get; set; } = new();
    private List<FeeBreakdownItem> OtherBreakdown { get; set; } = new();
    private List<GradeLevel> availableGradeLevels = new();
    
    // Get grade levels that are available (not already having fees)
    private List<GradeLevel> AvailableGradeLevels
    {
        get
        {
            if (ExistingFees == null || !ExistingFees.Any())
                return availableGradeLevels;
            
            // Get list of grade levels that already have fees
            var existingGradeLevels = ExistingFees
                .Where(f => !string.IsNullOrWhiteSpace(f.GradeLevel))
                .Select(f => f.GradeLevel)
                .ToHashSet(StringComparer.OrdinalIgnoreCase);
            
            // Filter out grade levels that already have fees
            return availableGradeLevels
                .Where(g => !existingGradeLevels.Contains(g.GradeLevelName))
                .ToList();
        }
    }

    private decimal TotalFee => FormData.TuitionFee + FormData.MiscFee + FormData.OtherFee;
    
    // Track which item is being edited for formatting
    private FeeBreakdownItem? editingAmountItem = null;
    private Dictionary<FeeBreakdownItem, string> amountRawInputs = new();
    
    // Toast notification
    private bool showToast = false;
    private string toastMessage = "";
    private ToastType toastType = ToastType.Success;
    
    // Confirmation modals
    private bool showSubmitConfirmModal = false;
    private bool showCancelConfirmModal = false;
    
    // Validation modal
    private bool showValidationModal = false;
    private List<string> validationErrors = new();
    
    // Grade level duplicate validation
    private bool gradeLevelError = false;
    private string gradeLevelErrorMessage = "";

    private bool _wasVisible = false;
    
    // Prevent concurrent submissions
    private bool _isProcessing = false;
    
    // Prevent concurrent grade level loading
    private bool _isLoadingGradeLevels = false;

    protected override async Task OnInitializedAsync()
    {
        // Load grade levels on initial load
        if (IsVisible)
        {
            await LoadGradeLevelsAsync();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Load grade levels when modal becomes visible (every time it opens)
        if (IsVisible && !_wasVisible)
        {
            await LoadGradeLevelsAsync();
        }
        _wasVisible = IsVisible;
        await base.OnParametersSetAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Fallback: Load grade levels if modal is visible but data hasn't loaded yet
        if (IsVisible && (!availableGradeLevels.Any() || availableGradeLevels.Count == 0))
        {
            await LoadGradeLevelsAsync();
        }
    }

    private async Task LoadGradeLevelsAsync()
    {
        // Prevent concurrent loading
        if (_isLoadingGradeLevels)
        {
            return;
        }
        
        _isLoadingGradeLevels = true;
        
        try
        {
            var gradeLevels = await FeeService.GetAllGradeLevelsAsync();
            if (gradeLevels != null && gradeLevels.Any())
            {
                availableGradeLevels = gradeLevels;
                Console.WriteLine($"Loaded {gradeLevels.Count} grade levels from database");
            }
            else
            {
                availableGradeLevels = new List<GradeLevel>();
                Console.WriteLine("Warning: No grade levels found in database. Make sure tbl_GradeLevel has data.");
                
                // Show warning toast
                toastMessage = "No grade levels found in database. Please ensure grade levels are seeded.";
                toastType = ToastType.Error;
                showToast = true;
            }
        }
        catch (Exception ex)
        {
            availableGradeLevels = new List<GradeLevel>();
            
            // Check for specific error types
            string errorMsg = ex.Message;
            if (ex.InnerException != null)
            {
                errorMsg = ex.InnerException.Message;
            }
            
            // Check if it's a table/object not found error
            if (errorMsg.Contains("Invalid object name", StringComparison.OrdinalIgnoreCase) ||
                errorMsg.Contains("tbl_GradeLevel", StringComparison.OrdinalIgnoreCase) ||
                errorMsg.Contains("does not exist", StringComparison.OrdinalIgnoreCase) ||
                errorMsg.Contains("Could not find", StringComparison.OrdinalIgnoreCase))
            {
                toastMessage = "Grade levels table not found. Please ensure the database is properly initialized.";
            }
            // Check if it's a connection error specifically
            else if (errorMsg.Contains("A network-related", StringComparison.OrdinalIgnoreCase) ||
                     errorMsg.Contains("server was not found", StringComparison.OrdinalIgnoreCase) ||
                     errorMsg.Contains("provider: Named Pipes Provider", StringComparison.OrdinalIgnoreCase) ||
                     errorMsg.Contains("provider: TCP Provider", StringComparison.OrdinalIgnoreCase))
            {
                toastMessage = "Unable to connect to the database. Please check your database server is running and try again.";
            }
            // Check if it's a timeout
            else if (errorMsg.Contains("timeout", StringComparison.OrdinalIgnoreCase))
            {
                toastMessage = "Database connection timed out. Please try again.";
            }
            // Use ErrorMessageHelper for other errors
            else
            {
                toastMessage = ErrorMessageHelper.ToHumanReadable($"Failed to load grade levels: {ex.Message}");
            }
            
            toastType = ToastType.Error;
            showToast = true;
        }
        finally
        {
            _isLoadingGradeLevels = false;
        }
        StateHasChanged();
    }

    public void Reset()
    {
        FormData = new FeeFormData();
        TuitionBreakdown = new List<FeeBreakdownItem>();
        MiscBreakdown = new List<FeeBreakdownItem>();
        OtherBreakdown = new List<FeeBreakdownItem>();
        amountRawInputs.Clear();
        editingAmountItem = null;
        validationErrors.Clear();
        showValidationModal = false;
        showSubmitConfirmModal = false;
        showCancelConfirmModal = false;
        _isProcessing = false;
        gradeLevelError = false;
        gradeLevelErrorMessage = "";
    }
    
    private void OnGradeLevelChanged()
    {
        // Reset error state
        gradeLevelError = false;
        gradeLevelErrorMessage = "";
        
        // Check if selected grade level already has a fee
        if (!string.IsNullOrWhiteSpace(FormData.GradeLevel) && ExistingFees != null && ExistingFees.Any())
        {
            var hasExistingFee = ExistingFees.Any(f => 
                string.Equals(f.GradeLevel, FormData.GradeLevel, StringComparison.OrdinalIgnoreCase));
            if (hasExistingFee)
            {
                gradeLevelError = true;
                gradeLevelErrorMessage = $"Grade Level '{FormData.GradeLevel}' already has a fee. Each grade level can only have one fee entry. Please select a different grade level or edit the existing fee.";
            }
        }
        
        StateHasChanged();
    }

    private bool HasData()
    {
        return !string.IsNullOrWhiteSpace(FormData.GradeLevel) ||
               TuitionBreakdown.Any() ||
               MiscBreakdown.Any() ||
               OtherBreakdown.Any() ||
               FormData.TuitionFee > 0 ||
               FormData.MiscFee > 0 ||
               FormData.OtherFee > 0;
    }

    private async Task HandleBackdropClick()
    {
        // If nested modals are open, don't close on backdrop click
        if (showSubmitConfirmModal || showCancelConfirmModal || showValidationModal)
        {
            return;
        }

        // If no data entered, allow closing
        if (!HasData())
        {
            await OnClose.InvokeAsync();
        }
        else
        {
            // If data exists, play sound and shake modal
            try
            {
                await JSRuntime.InvokeVoidAsync("handleModalBackdropClick", "add-fee-modal");
            }
            catch (Exception)
            {
            }
        }
    }

    private void HandleCancelClick()
    {
        if (HasData())
        {
            showCancelConfirmModal = true;
        }
        else
        {
            ConfirmCancel();
        }
    }

    private void CloseCancelConfirmModal()
    {
        showCancelConfirmModal = false;
    }

    private void ConfirmCancel()
    {
        Reset();
        OnClose.InvokeAsync();
    }

    private void HandleSubmitClick()
    {
        // Validate before showing confirmation
        if (!ValidateForm())
        {
            showValidationModal = true;
            return;
        }
        
        showSubmitConfirmModal = true;
    }

    private void CloseSubmitConfirmModal()
    {
        showSubmitConfirmModal = false;
    }

    private bool ValidateForm()
    {
        validationErrors.Clear();
        
        // Check Grade Level
        if (string.IsNullOrWhiteSpace(FormData.GradeLevel))
        {
            validationErrors.Add("Grade Level is required");
        }
        else
        {
            // Check if grade level already has a fee (duplicate prevention)
            if (ExistingFees != null && ExistingFees.Any())
            {
                var hasExistingFee = ExistingFees.Any(f => 
                    string.Equals(f.GradeLevel, FormData.GradeLevel, StringComparison.OrdinalIgnoreCase));
                if (hasExistingFee)
                {
                    validationErrors.Add($"Grade Level '{FormData.GradeLevel}' already has a fee. Each grade level can only have one fee entry. Please select a different grade level or edit the existing fee.");
                }
            }
        }
        
        // Check Tuition Fee is required
        bool hasTuitionItems = TuitionBreakdown.Any(item => !string.IsNullOrWhiteSpace(item.Name) && item.Amount > 0);
        if (!hasTuitionItems || FormData.TuitionFee <= 0)
        {
            validationErrors.Add("Tuition Fee is required. Please add at least one tuition fee item with a name and amount.");
        }
        
        // Check if at least one fee category has items (Misc or Other can be optional, but Tuition is required)
        bool hasMiscItems = MiscBreakdown.Any(item => !string.IsNullOrWhiteSpace(item.Name) && item.Amount > 0);
        bool hasOtherItems = OtherBreakdown.Any(item => !string.IsNullOrWhiteSpace(item.Name) && item.Amount > 0);
        
        // Validate individual items
        var allItems = TuitionBreakdown.Concat(MiscBreakdown).Concat(OtherBreakdown).ToList();
        foreach (var item in allItems)
        {
            if (string.IsNullOrWhiteSpace(item.Name) && item.Amount > 0)
            {
                validationErrors.Add("Items with amounts must have a name");
            }
            if (!string.IsNullOrWhiteSpace(item.Name) && item.Amount <= 0)
            {
                validationErrors.Add($"Item '{item.Name}' must have an amount greater than 0");
            }
        }
        
        return validationErrors.Count == 0;
    }

    private void CloseValidationModal()
    {
        showValidationModal = false;
    }

    private async Task ConfirmSubmit()
    {
        // Prevent concurrent submissions
        if (_isProcessing)
        {
            return;
        }
        
        showSubmitConfirmModal = false;
        _isProcessing = true;
        StateHasChanged();
        
        try
        {
            var fee = new FeeModel
            {
                GradeLevel = FormData.GradeLevel,
                TuitionFee = FormData.TuitionFee,
                MiscFee = FormData.MiscFee,
                OtherFee = FormData.OtherFee,
                DiscountFee = 0, // Discount removed from Add Fee modal
                TuitionBreakdown = TuitionBreakdown.Where(item => !string.IsNullOrWhiteSpace(item.Name) && item.Amount > 0).ToList(),
                MiscBreakdown = MiscBreakdown.Where(item => !string.IsNullOrWhiteSpace(item.Name) && item.Amount > 0).ToList(),
                OtherBreakdown = OtherBreakdown.Where(item => !string.IsNullOrWhiteSpace(item.Name) && item.Amount > 0).ToList(),
                DiscountBreakdown = new List<FeeBreakdownItem>() // Discount removed from Add Fee modal
            };
            
            await OnSubmit.InvokeAsync(fee);
            Reset();
            
            // Success toast will be shown by parent component
        }
        catch (Exception ex)
        {
            // Show error toast
            toastMessage = ErrorMessageHelper.ToHumanReadable($"Failed to add fee: {ex.Message}");
            toastType = ToastType.Error;
            showToast = true;
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }

    private void CloseToast()
    {
        showToast = false;
        toastMessage = "";
        StateHasChanged();
    }

    private void OnAddTuitionItem()
    {
        TuitionBreakdown.Add(new FeeBreakdownItem());
        StateHasChanged();
    }

    private void OnRemoveTuitionItem(FeeBreakdownItem item)
    {
        TuitionBreakdown.Remove(item);
        OnTuitionChanged();
    }

    private void OnTuitionChanged()
    {
        var total = TuitionBreakdown.Sum(item => item.Amount);
        FormData.TuitionFeeString = total.ToString("N2");
        StateHasChanged();
    }

    private void OnAddMiscItem()
    {
        MiscBreakdown.Add(new FeeBreakdownItem());
        StateHasChanged();
    }

    private void OnRemoveMiscItem(FeeBreakdownItem item)
    {
        MiscBreakdown.Remove(item);
        OnMiscChanged();
    }

    private void OnMiscChanged()
    {
        var total = MiscBreakdown.Sum(item => item.Amount);
        FormData.MiscFeeString = total.ToString("N2");
        StateHasChanged();
    }

    private void OnAddOtherItem()
    {
        OtherBreakdown.Add(new FeeBreakdownItem());
        StateHasChanged();
    }

    private void OnRemoveOtherItem(FeeBreakdownItem item)
    {
        OtherBreakdown.Remove(item);
        OnOtherChanged();
    }

    private void OnOtherChanged()
    {
        var total = OtherBreakdown.Sum(item => item.Amount);
        FormData.OtherFeeString = total.ToString("N2");
        StateHasChanged();
    }

    // Get display value for amount field (formatted with commas)
    private string GetAmountDisplayValue(FeeBreakdownItem item)
    {
        if (editingAmountItem == item && amountRawInputs.ContainsKey(item))
        {
            return FormatNumberWithCommas(amountRawInputs[item]);
        }
        
        // Return formatted value when not editing
        if (item.Amount > 0)
        {
            return item.Amount.ToString("N2");
        }
        return "";
    }


    // Handle paste to filter invalid characters
    private async Task HandleAmountPaste(ClipboardEventArgs e, FeeBreakdownItem item, string category)
    {
        // Blazor handles paste events automatically, no need for JavaScript eval
        await Task.CompletedTask;
        
        // Get clipboard text
        var clipboardText = await JSRuntime.InvokeAsync<string>("navigator.clipboard.readText");
        
        if (!string.IsNullOrWhiteSpace(clipboardText))
        {
            // Filter to only allow digits and period
            var validChars = clipboardText.Where(c => char.IsDigit(c) || c == '.').ToArray();
            var cleaned = new string(validChars);
            
            // Ensure only one decimal point
            var dotCount = cleaned.Count(c => c == '.');
            if (dotCount > 1)
            {
                var firstDotIndex = cleaned.IndexOf('.');
                cleaned = cleaned.Substring(0, firstDotIndex + 1) + cleaned.Substring(firstDotIndex + 1).Replace(".", "");
            }
            
            // Limit decimal places to 2
            if (cleaned.Contains('.'))
            {
                var parts = cleaned.Split('.');
                if (parts.Length == 2 && parts[1].Length > 2)
                {
                    cleaned = parts[0] + "." + parts[1].Substring(0, 2);
                }
            }
            
            // Update the item's amount
            if (!string.IsNullOrWhiteSpace(cleaned) && cleaned != "." && decimal.TryParse(cleaned, out decimal parsedValue))
            {
                parsedValue = Math.Round(parsedValue, 2);
                item.AmountString = parsedValue.ToString("N2");
                amountRawInputs[item] = cleaned;
                
                // Update the appropriate category total
                if (category == "tuition")
                    OnTuitionChanged();
                else if (category == "misc")
                    OnMiscChanged();
                else if (category == "other")
                    OnOtherChanged();
                
                StateHasChanged();
            }
        }
    }

    // Format number string with commas (for display while typing)
    private string FormatNumberWithCommas(string numberString)
    {
        if (string.IsNullOrWhiteSpace(numberString) || numberString == ".")
            return numberString;

        // Remove any existing commas
        string cleaned = numberString.Replace(",", "");
        
        // Check if it has a decimal point
        if (cleaned.Contains('.'))
        {
            var parts = cleaned.Split('.');
            string integerPart = parts[0];
            string decimalPart = parts.Length > 1 ? parts[1] : "";
            
            // Format integer part with commas
            if (!string.IsNullOrWhiteSpace(integerPart) && long.TryParse(integerPart, out long intValue))
            {
                string formattedInteger = intValue.ToString("N0").Replace(".", ",");
                return formattedInteger + (parts.Length > 1 ? "." + decimalPart : "");
            }
        }
        else if (long.TryParse(cleaned, out long value))
        {
            return value.ToString("N0").Replace(".", ",");
        }
        
        return numberString;
    }


    // Handle amount input with auto-formatting and strict validation - IMMEDIATELY filters invalid characters
    private void HandleAmountInput(ChangeEventArgs e, FeeBreakdownItem item, string category)
    {
        var inputValue = e.Value?.ToString() ?? "";
        
        // IMMEDIATELY filter: Remove ALL non-numeric characters except period
        // This prevents letters and special characters from appearing at all
        var validChars = inputValue.Where(c => char.IsDigit(c) || c == '.').ToArray();
        string cleaned = new string(validChars);
        
        // Remove peso sign, commas, spaces if any got through
        cleaned = cleaned.Replace("₱", "").Replace(",", "").Replace(" ", "").Trim();
        
        if (string.IsNullOrWhiteSpace(cleaned) || cleaned == ".")
        {
            cleaned = "";
        }
        else
        {
            // Ensure only one decimal point
            var dotCount = cleaned.Count(c => c == '.');
            if (dotCount > 1)
            {
                // Keep only the first decimal point
                var firstDotIndex = cleaned.IndexOf('.');
                cleaned = cleaned.Substring(0, firstDotIndex + 1) + cleaned.Substring(firstDotIndex + 1).Replace(".", "");
            }
            
            // If starting with "0" and next char is a digit (not "."), remove the leading "0"
            if (cleaned.Length > 1 && cleaned[0] == '0' && char.IsDigit(cleaned[1]))
            {
                cleaned = cleaned.Substring(1);
            }
            
            // Limit decimal places to 2
            if (cleaned.Contains('.'))
            {
                var parts = cleaned.Split('.');
                if (parts.Length == 2 && parts[1].Length > 2)
                {
                    cleaned = parts[0] + "." + parts[1].Substring(0, 2);
                }
            }
        }
        
        // Store raw input (without commas for parsing)
        amountRawInputs[item] = cleaned;
        
        // Parse and update the item's AmountString
        if (!string.IsNullOrWhiteSpace(cleaned) && cleaned != "." && decimal.TryParse(cleaned, out decimal parsedValue))
        {
            // Round to 2 decimals
            parsedValue = Math.Round(parsedValue, 2);
            item.AmountString = parsedValue.ToString("N2");
            
            // Update the appropriate category total
            if (category == "tuition")
                OnTuitionChanged();
            else if (category == "misc")
                OnMiscChanged();
            else if (category == "other")
                OnOtherChanged();
        }
        else if (string.IsNullOrWhiteSpace(cleaned) || cleaned == ".")
        {
            item.AmountString = "";
            if (category == "tuition")
                OnTuitionChanged();
            else if (category == "misc")
                OnMiscChanged();
            else if (category == "other")
                OnOtherChanged();
        }
        
        // Force update the input field to reflect the cleaned value immediately
        // This ensures invalid characters are removed as soon as they're typed
        StateHasChanged();
    }

    // Handle focus - start editing
    private void HandleAmountFocus(Microsoft.AspNetCore.Components.Web.FocusEventArgs e, FeeBreakdownItem item)
    {
        editingAmountItem = item;
        if (!amountRawInputs.ContainsKey(item))
        {
            if (item.Amount > 0)
            {
                amountRawInputs[item] = item.Amount == Math.Floor(item.Amount) 
                    ? ((int)item.Amount).ToString() 
                    : item.Amount.ToString("0.##");
            }
            else
            {
                amountRawInputs[item] = "";
            }
        }
        StateHasChanged();
    }

    // Handle blur - finish editing
    private void HandleAmountBlur(Microsoft.AspNetCore.Components.Web.FocusEventArgs e, FeeBreakdownItem item, string category)
    {
        editingAmountItem = null;
        
        // Ensure the value is properly formatted
        if (amountRawInputs.ContainsKey(item))
        {
            string rawValue = amountRawInputs[item];
            if (!string.IsNullOrWhiteSpace(rawValue) && rawValue != "." && decimal.TryParse(rawValue, out decimal parsedValue))
            {
                parsedValue = Math.Round(parsedValue, 2);
                item.AmountString = parsedValue.ToString("N2");
            }
            else
            {
                item.AmountString = "";
            }
            amountRawInputs.Remove(item);
        }
        
        StateHasChanged();
    }

    // Format item name to capitalize first letter of each word
    private void FormatItemName(FeeBreakdownItem item)
    {
        item.Name = EmployeeFormHelpers.FormatName(item.Name);
    }
}

