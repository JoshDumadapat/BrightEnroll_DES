@namespace BrightEnroll_DES.Components.Pages.Admin.Finance.FinanceComponents
@using BrightEnroll_DES.Services.Business.Reports
@using BrightEnroll_DES.Services.QuestPDF
@using BrightEnroll_DES.Services.Authentication
@using BrightEnroll_DES.Data
@using BrightEnroll_DES.Data.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Rendering
@using BrightEnroll_DES.Components
@inject AccountingReportService AccountingReportService
@inject AppDbContext DbContext
@inject IJSRuntime JSRuntime
@inject FinanceReportsPdfGenerator PdfGenerator
@inject IAuthService AuthService
@inject BrightEnroll_DES.Services.RoleBase.IAuthorizationService AuthorizationService

<ToastNotification Show="@showToast" Message="@toastMessage" Type="@toastType" OnClose="CloseToast" Duration="4000" />

<div class="p-6 space-y-6">
    <!-- Filter Bar -->
    <div class="rounded-xl border border-gray-200 bg-white p-4 shadow">
        <div class="mb-4 flex flex-wrap items-end gap-4">
            <div class="flex-1 min-w-[200px]">
                <label class="mb-2 block text-sm font-medium text-gray-700">Date Range</label>
                <div class="flex gap-2">
                    <input type="date" @bind="fromDate" @bind:format="yyyy-MM-dd"
                           class="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200" />
                    <span class="self-center text-gray-500">to</span>
                    <input type="date" @bind="toDate" @bind:format="yyyy-MM-dd"
                           class="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200" />
                </div>
            </div>
            <div class="min-w-[150px]">
                <label class="mb-2 block text-sm font-medium text-gray-700">Grade Level</label>
                <select @bind="selectedGradeLevel" 
                        class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    <option value="">All Grades</option>
                    @foreach (var grade in gradeLevels)
                    {
                        <option value="@grade">@grade</option>
                    }
                </select>
            </div>
            <div class="flex gap-2">
                <button @onclick="GenerateReport" 
                        disabled="@isLoading"
                        class="flex items-center gap-2 rounded-lg bg-blue-600 px-6 py-2 text-sm font-semibold text-white shadow-md transition-all hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    @if (isLoading)
                    {
                        <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Generating...</span>
                    }
                    else
                    {
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        <span>Generate Report</span>
                    }
                </button>
                <button type="button"
                        @onclick="ExportToPdf"
                        @onclick:preventDefault="false"
                        disabled="@(isLoading || isExporting || !reportGenerated)"
                        class="flex items-center gap-2 rounded-lg bg-green-600 px-6 py-2 text-sm font-semibold text-white shadow-md transition-all hover:bg-green-700 hover:shadow-lg active:bg-green-800 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:opacity-50">
                    @if (isExporting)
                    {
                        <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Exporting...</span>
                    }
                    else
                    {
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span>Export PDF</span>
                    }
                </button>
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            <span class="text-xs text-gray-500 mr-1">Quick presets:</span>
            <button @onclick='() => SetDatePreset("ThisMonth")' 
                    class="rounded-md border border-gray-300 bg-white px-2.5 py-1 text-xs text-gray-600 hover:bg-gray-50 hover:border-gray-400 transition-colors">
                This Month
            </button>
            <button @onclick='() => SetDatePreset("LastMonth")' 
                    class="rounded-md border border-gray-300 bg-white px-2.5 py-1 text-xs text-gray-600 hover:bg-gray-50 hover:border-gray-400 transition-colors">
                Last Month
            </button>
            <button @onclick='() => SetDatePreset("ThisYear")' 
                    class="rounded-md border border-gray-300 bg-white px-2.5 py-1 text-xs text-gray-600 hover:bg-gray-50 hover:border-gray-400 transition-colors">
                This Year
            </button>
            <button @onclick='() => SetDatePreset("LastYear")' 
                    class="rounded-md border border-gray-300 bg-white px-2.5 py-1 text-xs text-gray-600 hover:bg-gray-50 hover:border-gray-400 transition-colors">
                Last Year
            </button>
            <button @onclick='() => SetDatePreset("Last3Months")' 
                    class="rounded-md border border-gray-300 bg-white px-2.5 py-1 text-xs text-gray-600 hover:bg-gray-50 hover:border-gray-400 transition-colors">
                Last 3 Months
            </button>
            <button @onclick='() => SetDatePreset("Last6Months")' 
                    class="rounded-md border border-gray-300 bg-white px-2.5 py-1 text-xs text-gray-600 hover:bg-gray-50 hover:border-gray-400 transition-colors">
                Last 6 Months
            </button>
        </div>
    </div>

    <!-- Report Type Selector -->
    <div class="rounded-xl border border-gray-200 bg-white p-4 shadow">
        <h3 class="mb-4 text-sm font-semibold text-gray-700">Select Report Type</h3>
        <div class="grid grid-cols-2 gap-3 md:grid-cols-3 lg:grid-cols-6">
            <button @onclick='() => SetActiveReport("IncomeStatement")' 
                    class="@GetReportButtonClasses("IncomeStatement")">
                <svg class="mx-auto h-6 w-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span class="text-xs font-medium">Income Statement</span>
            </button>
            <button @onclick='() => SetActiveReport("CashFlow")' 
                    class="@GetReportButtonClasses("CashFlow")">
                <svg class="mx-auto h-6 w-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-xs font-medium">Cash Flow</span>
            </button>
            <button @onclick='() => SetActiveReport("AccountsReceivable")' 
                    class="@GetReportButtonClasses("AccountsReceivable")">
                <svg class="mx-auto h-6 w-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span class="text-xs font-medium">A/R Aging</span>
            </button>
            <button @onclick='() => SetActiveReport("PaymentHistory")' 
                    class="@GetReportButtonClasses("PaymentHistory")">
                <svg class="mx-auto h-6 w-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-xs font-medium">Payment History</span>
            </button>
            <button @onclick='() => SetActiveReport("ExpenseAnalysis")' 
                    class="@GetReportButtonClasses("ExpenseAnalysis")">
                <svg class="mx-auto h-6 w-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                <span class="text-xs font-medium">Expense Analysis</span>
            </button>
            <button @onclick='() => SetActiveReport("GeneralLedger")' 
                    class="@GetReportButtonClasses("GeneralLedger")">
                <svg class="mx-auto h-6 w-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span class="text-xs font-medium">General Ledger</span>
            </button>
            <button @onclick='() => SetActiveReport("BalanceSheet")' 
                    class="@GetReportButtonClasses("BalanceSheet")">
                <svg class="mx-auto h-6 w-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                <span class="text-xs font-medium">Balance Sheet</span>
            </button>
        </div>
    </div>

    <!-- Report Content -->
    @if (reportGenerated)
    {
        <div class="rounded-xl border border-gray-200 bg-white shadow">
            <!-- Report Header -->
            <div class="border-b border-gray-200 bg-gray-50 px-6 py-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">@GetReportTitle()</h2>
                        @if (activeReport == "BalanceSheet")
                        {
                            <p class="mt-1 text-sm text-gray-600">As of: @toDate.ToString("MMM dd, yyyy")</p>
                        }
                        else
                        {
                            <p class="mt-1 text-sm text-gray-600">Period: @fromDate.ToString("MMM dd, yyyy") - @toDate.ToString("MMM dd, yyyy")</p>
                        }
                </div>
            </div>

            <!-- Summary KPI Cards -->
            <div class="border-b border-gray-200 px-6 py-4">
                @RenderKPICards()
            </div>

            <!-- Breakdown Tabs -->
            <div class="border-b border-gray-200 bg-gray-50 px-6">
                <div class="flex gap-1">
                    <button @onclick='() => SetActiveBreakdown("Overview")' 
                            class="@GetBreakdownTabClasses("Overview")">
                        Overview
                    </button>
                    <button @onclick='() => SetActiveBreakdown("Details")' 
                            class="@GetBreakdownTabClasses("Details")">
                        Details
                    </button>
                </div>
            </div>

            <!-- Breakdown Content -->
            <div class="p-6">
                @RenderBreakdownContent()
            </div>
        </div>
    }
    else
    {
        <div class="rounded-xl border border-gray-200 bg-white p-12 text-center shadow">
            <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p class="text-lg font-medium text-gray-600">Select filters and generate a report</p>
            <p class="mt-2 text-sm text-gray-500">Choose a report type above and click "Generate Report" to view financial data</p>
        </div>
    }
</div>

@code {
    private string activeReport = "IncomeStatement";
    private string activeBreakdown = "Overview";
    private DateTime fromDate = DateTime.Now.AddMonths(-1);
    private DateTime toDate = DateTime.Now;
    private string selectedGradeLevel = "";
    private bool isLoading = false;
    private bool isExporting = false;
    private bool reportGenerated = false;
    private List<string> gradeLevels = new();

    // Toast notification state
    private bool showToast = false;
    private string toastMessage = "";
    private ToastType toastType = ToastType.Success;

    // Report Data
    private IncomeStatement? incomeStatement;
    private CashFlowReport? cashFlowReport;
    private List<AccountsReceivableRecord>? arRecords;
    private List<PaymentHistoryRecord>? paymentHistory;
    private ExpenseAnalysisReport? expenseAnalysis;
    private GeneralLedgerData? generalLedger;
    private List<RevenueBreakdownItem>? revenueBreakdown;
    private BalanceSheetReport? balanceSheetReport;
    
    // Details tab data
    private List<PaymentHistoryRecord>? incomeStatementPayments;
    private List<Data.Models.Expense>? incomeStatementExpenses;
    private List<PaymentHistoryRecord>? cashFlowInflows;
    private List<Data.Models.Expense>? cashFlowOutflows;

    private bool IsCashier { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if user is cashier
        IsCashier = AuthorizationService.HasRole("Cashier");
        await LoadGradeLevels();
    }

    private async Task LoadGradeLevels()
    {
        try
        {
            gradeLevels = await DbContext.GradeLevels
                .OrderBy(g => g.GradeLevelName)
                .Select(g => g.GradeLevelName)
                .ToListAsync();
        }
        catch
        {
            gradeLevels = new List<string> { "Grade 1", "Grade 2", "Grade 3", "Grade 4", "Grade 5", "Grade 6" };
        }
    }

    private void SetActiveReport(string report)
    {
        activeReport = report;
        reportGenerated = false;
        StateHasChanged();
    }

    private void SetActiveBreakdown(string breakdown)
    {
        activeBreakdown = breakdown;
        StateHasChanged();
    }

    private string GetReportButtonClasses(string report)
    {
        bool isSelected = activeReport == report;
        return isSelected
            ? "flex flex-col items-center justify-center rounded-lg border-2 border-blue-600 bg-blue-50 p-4 transition-all hover:bg-blue-100"
            : "flex flex-col items-center justify-center rounded-lg border-2 border-gray-200 bg-white p-4 transition-all hover:border-gray-300 hover:bg-gray-50";
    }

    private string GetBreakdownTabClasses(string tab)
    {
        bool isSelected = activeBreakdown == tab;
        return isSelected
            ? "px-4 py-2 text-sm font-semibold text-blue-600 border-b-2 border-blue-600"
            : "px-4 py-2 text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors";
    }

    private string GetReportTitle()
    {
        return activeReport switch
        {
            "IncomeStatement" => "Income Statement (Profit & Loss)",
            "CashFlow" => "Cash Flow Statement",
            "AccountsReceivable" => "Accounts Receivable Aging Report",
            "PaymentHistory" => "Payment History Report",
            "ExpenseAnalysis" => "Expense Analysis Report",
            "GeneralLedger" => "General Ledger",
            "BalanceSheet" => "Balance Sheet",
            _ => "Financial Report"
        };
    }

    private void SetDatePreset(string preset)
    {
        var now = DateTime.Now;
        switch (preset)
        {
            case "ThisMonth":
                fromDate = new DateTime(now.Year, now.Month, 1);
                toDate = now;
                break;
            case "LastMonth":
                var lastMonth = now.AddMonths(-1);
                fromDate = new DateTime(lastMonth.Year, lastMonth.Month, 1);
                toDate = new DateTime(lastMonth.Year, lastMonth.Month, DateTime.DaysInMonth(lastMonth.Year, lastMonth.Month));
                break;
            case "ThisYear":
                fromDate = new DateTime(now.Year, 1, 1);
                toDate = now;
                break;
            case "LastYear":
                fromDate = new DateTime(now.Year - 1, 1, 1);
                toDate = new DateTime(now.Year - 1, 12, 31);
                break;
            case "Last3Months":
                fromDate = now.AddMonths(-3);
                toDate = now;
                break;
            case "Last6Months":
                fromDate = now.AddMonths(-6);
                toDate = now;
                break;
        }
        StateHasChanged();
    }

    private async Task GenerateReport()
    {
        // Validate date range
        if (toDate < fromDate)
        {
            ShowToast("Invalid date range. 'To Date' must be greater than or equal to 'From Date'.", ToastType.Error);
            return;
        }

        isLoading = true;
        reportGenerated = false;
        StateHasChanged();

        try
        {
            // Clear EF Core change tracker to ensure fresh data is loaded
            DbContext.ChangeTracker.Clear();
            
            // Small delay to ensure any pending database changes are committed
            await Task.Delay(100);
            
            switch (activeReport)
            {
                case "IncomeStatement":
                    incomeStatement = await AccountingReportService.GetIncomeStatementAsync(fromDate, toDate);
                    revenueBreakdown = await GetRevenueBreakdownAsync(fromDate, toDate);
                    // Load details data
                    incomeStatementPayments = await AccountingReportService.GetPaymentHistoryAsync(fromDate, toDate);
                    incomeStatementExpenses = await DbContext.Expenses
                        .Where(e => e.ExpenseDate >= fromDate && e.ExpenseDate <= toDate && e.Status == "Approved")
                        .OrderByDescending(e => e.ExpenseDate)
                        .ToListAsync();
                    break;
                case "CashFlow":
                    cashFlowReport = await AccountingReportService.GetCashFlowReportAsync(fromDate, toDate);
                    // Load details data
                    cashFlowInflows = await AccountingReportService.GetPaymentHistoryAsync(fromDate, toDate);
                    cashFlowOutflows = await DbContext.Expenses
                        .Where(e => e.ExpenseDate >= fromDate && e.ExpenseDate <= toDate && e.Status == "Approved")
                        .OrderByDescending(e => e.ExpenseDate)
                        .ToListAsync();
                    break;
                case "AccountsReceivable":
                    arRecords = await AccountingReportService.GetAccountsReceivableAsync(toDate);
                    break;
                case "PaymentHistory":
                    paymentHistory = await AccountingReportService.GetPaymentHistoryAsync(fromDate, toDate);
                    break;
                case "ExpenseAnalysis":
                            expenseAnalysis = await GetExpenseAnalysisAsync(fromDate, toDate);
                    break;
                case "GeneralLedger":
                    generalLedger = await GetGeneralLedgerAsync(fromDate, toDate);
                    break;
                case "BalanceSheet":
                    balanceSheetReport = await AccountingReportService.GetBalanceSheetAsync(toDate);
                    break;
            }

            reportGenerated = true;
            activeBreakdown = "Overview";
            
            // Show success message with record count
            var recordCount = GetRecordCount();
            if (recordCount > 0)
            {
                ShowToast($"Report generated successfully. Found {recordCount} record(s).", ToastType.Success);
            }
            else
            {
                ShowToast("Report generated, but no data found for the selected period.", ToastType.Edit);
            }
        }
        catch (Exception ex)
        {
            reportGenerated = false;
            ShowToast($"Error generating report: {ex.Message}", ToastType.Error);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private int GetRecordCount()
    {
        return activeReport switch
        {
            "IncomeStatement" => incomeStatement != null ? 1 : 0,
            "CashFlow" => cashFlowReport != null ? 1 : 0,
            "AccountsReceivable" => arRecords?.Count ?? 0,
            "PaymentHistory" => paymentHistory?.Count ?? 0,
            "ExpenseAnalysis" => expenseAnalysis?.TotalCount ?? 0,
            "GeneralLedger" => generalLedger?.Entries.Count ?? 0,
            "BalanceSheet" => balanceSheetReport != null ? 1 : 0,
            _ => 0
        };
    }

    private RenderFragment RenderKPICards()
    {
        return builder =>
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4");

            switch (activeReport)
            {
                case "IncomeStatement":
                    if (incomeStatement != null)
                    {
                        RenderKPICard(builder, "Total Revenue", incomeStatement.Revenue, "text-green-600", "↑");
                        RenderKPICard(builder, "Total Expenses", incomeStatement.TotalExpenses, "text-red-600", "↓");
                        RenderKPICard(builder, "Net Income", incomeStatement.NetIncome, incomeStatement.NetIncome >= 0 ? "text-blue-600" : "text-red-600", incomeStatement.NetIncome >= 0 ? "↑" : "↓");
                        RenderKPICard(builder, "Profit Margin", incomeStatement.Revenue > 0 ? (incomeStatement.NetIncome / incomeStatement.Revenue * 100) : 0, "text-purple-600", "%");
                    }
                    else
                    {
                        RenderEmptyKPICards(builder, 4);
                    }
                    break;

                case "CashFlow":
                    if (cashFlowReport != null)
                    {
                        RenderKPICard(builder, "Cash Inflow", cashFlowReport.TotalInflow, "text-green-600", "↑");
                        RenderKPICard(builder, "Cash Outflow", cashFlowReport.TotalOutflow, "text-red-600", "↓");
                        RenderKPICard(builder, "Net Cash Flow", cashFlowReport.NetCashFlow, cashFlowReport.NetCashFlow >= 0 ? "text-blue-600" : "text-red-600", cashFlowReport.NetCashFlow >= 0 ? "↑" : "↓");
                        RenderKPICard(builder, "Cash Balance", cashFlowReport.NetCashFlow, "text-indigo-600", "");
                    }
                    else
                    {
                        RenderEmptyKPICards(builder, 4);
                    }
                    break;

                case "AccountsReceivable":
                    if (arRecords != null && arRecords.Any())
                    {
                        var totalAR = arRecords.Sum(r => r.OutstandingBalance);
                        var current = arRecords.Where(r => r.AgingBucket == "Current").Sum(r => r.OutstandingBalance);
                        var overdue = arRecords.Where(r => r.AgingBucket != "Current").Sum(r => r.OutstandingBalance);
                        RenderKPICard(builder, "Total A/R", totalAR, "text-blue-600", "");
                        RenderKPICard(builder, "Current", current, "text-green-600", "");
                        RenderKPICard(builder, "Overdue", overdue, "text-red-600", "");
                        RenderKPICard(builder, "Total Accounts", arRecords.Count, "text-gray-600", "accounts");
                    }
                    else
                    {
                        RenderEmptyKPICards(builder, 4);
                    }
                    break;

                case "ExpenseAnalysis":
                    if (expenseAnalysis != null)
                    {
                        RenderKPICard(builder, "Total Expenses", expenseAnalysis.TotalExpenses, "text-red-600", "↓");
                        RenderKPICard(builder, "Total Count", expenseAnalysis.TotalCount, "text-gray-600", "items");
                        var approved = expenseAnalysis.ByStatus?.FirstOrDefault(s => s.Status == "Approved")?.Amount ?? 0;
                        var pending = expenseAnalysis.ByStatus?.FirstOrDefault(s => s.Status == "Pending")?.Amount ?? 0;
                        RenderKPICard(builder, "Approved", approved, "text-green-600", "");
                        RenderKPICard(builder, "Pending", pending, "text-yellow-600", "");
                    }
                    else
                    {
                        RenderEmptyKPICards(builder, 4);
                    }
                    break;

                case "PaymentHistory":
                    if (paymentHistory != null && paymentHistory.Any())
                    {
                        var totalPayments = paymentHistory.Sum(p => p.Amount);
                        RenderKPICard(builder, "Total Payments", totalPayments, "text-green-600", "↑");
                        RenderKPICard(builder, "Payment Count", paymentHistory.Count, "text-blue-600", "transactions");
                        var avgPayment = paymentHistory.Count > 0 ? totalPayments / paymentHistory.Count : 0;
                        RenderKPICard(builder, "Avg Payment", avgPayment, "text-purple-600", "");
                        var cashPayments = paymentHistory.Where(p => p.PaymentMethod == "Cash").Sum(p => p.Amount);
                        RenderKPICard(builder, "Cash Payments", cashPayments, "text-indigo-600", "");
                    }
                    else
                    {
                        RenderEmptyKPICards(builder, 4);
                    }
                    break;

                case "GeneralLedger":
                    if (generalLedger != null && generalLedger.Entries.Any())
                    {
                        var totalCredits = generalLedger.Entries.Sum(e => e.Credit);
                        var totalDebits = generalLedger.Entries.Sum(e => e.Debit);
                        // FIXED: Net Balance should be Total Debits - Total Credits (should always be 0 for balanced ledger)
                        var netBalance = totalDebits - totalCredits;
                        RenderKPICard(builder, "Total Credits", totalCredits, "text-green-600", "");
                        RenderKPICard(builder, "Total Debits", totalDebits, "text-red-600", "");
                        RenderKPICard(builder, "Net Balance", netBalance, Math.Abs(netBalance) < 0.01m ? "text-green-600" : "text-red-600", "");
                        RenderKPICard(builder, "Transactions", generalLedger.Entries.Count, "text-gray-600", "transactions");
                    }
                    else
                    {
                        RenderEmptyKPICards(builder, 4);
                    }
                    break;

                case "BalanceSheet":
                    if (balanceSheetReport != null)
                    {
                        RenderKPICard(builder, "Total Assets", balanceSheetReport.TotalAssets, "text-blue-600", "");
                        RenderKPICard(builder, "Total Liabilities", balanceSheetReport.TotalLiabilities, "text-red-600", "");
                        RenderKPICard(builder, "Total Equity", balanceSheetReport.TotalEquity, "text-green-600", "");
                        var balanceStatus = balanceSheetReport.IsBalanced ? "Balanced" : "Unbalanced";
                        // Render Status card with text only (no currency value)
                        builder.OpenElement(0, "div");
                        builder.AddAttribute(1, "class", "rounded-lg border border-gray-200 bg-white p-4 shadow-sm");
                        builder.OpenElement(2, "p");
                        builder.AddAttribute(3, "class", "text-xs font-medium text-gray-600 mb-1");
                        builder.AddContent(4, "Status");
                        builder.CloseElement();
                        builder.OpenElement(5, "p");
                        builder.AddAttribute(6, "class", $"text-2xl font-bold {(balanceSheetReport.IsBalanced ? "text-green-600" : "text-red-600")}");
                        builder.AddContent(7, balanceStatus);
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    else
                    {
                        RenderEmptyKPICards(builder, 4);
                    }
                    break;
            }

            builder.CloseElement();
        };
    }

    private void RenderEmptyKPICards(RenderTreeBuilder builder, int count)
    {
        for (int i = 0; i < count; i++)
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "rounded-lg border border-gray-200 bg-gray-50 p-4 shadow-sm");
            builder.OpenElement(2, "p");
            builder.AddAttribute(3, "class", "text-xs font-medium text-gray-400 mb-1");
            builder.AddContent(4, "—");
            builder.CloseElement();
            builder.OpenElement(5, "p");
            builder.AddAttribute(6, "class", "text-2xl font-bold text-gray-300");
            builder.AddContent(7, "—");
            builder.CloseElement();
            builder.CloseElement();
        }
    }

    private void RenderKPICard(RenderTreeBuilder builder, string label, decimal value, string colorClass, string suffix)
    {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "rounded-lg border border-gray-200 bg-white p-4 shadow-sm");
        builder.OpenElement(2, "p");
        builder.AddAttribute(3, "class", "text-xs font-medium text-gray-600 mb-1");
        builder.AddContent(4, label);
        builder.CloseElement();
        builder.OpenElement(5, "div");
        builder.AddAttribute(6, "class", "flex items-baseline gap-2");
        builder.OpenElement(7, "p");
        builder.AddAttribute(8, "class", $"text-2xl font-bold {colorClass}");
        bool isPercentage = suffix == "%";
        if (isPercentage)
        {
            builder.AddContent(9, $"{value:N2}%");
        }
        else if (suffix == "accounts" || suffix == "transactions" || suffix == "items")
        {
            builder.AddContent(9, $"{value:N0} {suffix}");
        }
        else
        {
            builder.AddContent(9, FormatCurrency(value));
        if (!string.IsNullOrEmpty(suffix) && suffix != "↑" && suffix != "↓")
        {
                builder.AddContent(10, " " + suffix);
            }
        }
        builder.CloseElement();
        if (suffix == "↑" || suffix == "↓")
        {
            builder.OpenElement(11, "span");
            builder.AddAttribute(12, "class", $"text-sm {colorClass}");
            builder.AddContent(13, suffix);
            builder.CloseElement();
        }
        builder.CloseElement();
        builder.CloseElement();
    }

    private RenderFragment RenderBreakdownContent()
    {
        return builder =>
        {
            switch (activeBreakdown)
            {
                case "Overview":
                    RenderOverviewTab(builder);
                    break;
                case "Details":
                    RenderDetailsTab(builder);
                    break;
            }
        };
    }

    private void RenderOverviewTab(RenderTreeBuilder builder)
    {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "space-y-6");

        switch (activeReport)
        {
            case "IncomeStatement":
                if (incomeStatement != null)
                {
                    builder.OpenElement(2, "div");
                    builder.AddAttribute(3, "class", "grid grid-cols-1 gap-6 md:grid-cols-2");
                    
                    // Revenue Breakdown
                    builder.OpenElement(4, "div");
                    builder.AddAttribute(5, "class", "rounded-lg border border-green-200 bg-green-50 p-4");
                    builder.OpenElement(6, "h3");
                    builder.AddAttribute(7, "class", "mb-4 text-lg font-semibold text-green-800");
                    builder.AddContent(8, "Revenue Breakdown");
                    builder.CloseElement();
                    builder.OpenElement(9, "div");
                    builder.AddAttribute(10, "class", "space-y-2");
                    
                    // Show revenue breakdown by payment method
                    if (revenueBreakdown != null && revenueBreakdown.Any())
                    {
                        foreach (var item in revenueBreakdown.OrderByDescending(r => r.Amount))
                        {
                            builder.OpenElement(11, "div");
                            builder.AddAttribute(12, "class", "flex items-center justify-between rounded bg-white p-3");
                            builder.OpenElement(13, "span");
                            builder.AddAttribute(14, "class", "font-medium text-gray-700");
                            builder.AddContent(15, item.PaymentMethod);
                            builder.CloseElement();
                            builder.OpenElement(16, "span");
                            builder.AddAttribute(17, "class", "font-semibold text-green-600");
                            builder.AddContent(18, FormatCurrency(item.Amount));
                            builder.CloseElement();
                            builder.CloseElement();
                        }
                    }
                    else
                    {
                        builder.OpenElement(19, "div");
                        builder.AddAttribute(20, "class", "rounded bg-white p-3 text-center text-sm text-gray-500");
                        builder.AddContent(21, "No revenue data available");
                        builder.CloseElement();
                    }
                    
                    // Total Revenue at the bottom
                    builder.OpenElement(22, "div");
                    builder.AddAttribute(23, "class", "mt-3 flex items-center justify-between rounded bg-green-100 p-3 border-t-2 border-green-300");
                    builder.OpenElement(24, "span");
                    builder.AddAttribute(25, "class", "font-bold text-green-800");
                    builder.AddContent(26, "Total Revenue");
                    builder.CloseElement();
                    builder.OpenElement(27, "span");
                    builder.AddAttribute(28, "class", "font-bold text-green-800");
                    builder.AddContent(29, FormatCurrency(incomeStatement.Revenue));
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();

                    // Expense Breakdown
                    builder.OpenElement(19, "div");
                    builder.AddAttribute(20, "class", "rounded-lg border border-red-200 bg-red-50 p-4");
                    builder.OpenElement(21, "h3");
                    builder.AddAttribute(22, "class", "mb-4 text-lg font-semibold text-red-800");
                    builder.AddContent(23, "Expense Breakdown by Category");
                    builder.CloseElement();
                    if (incomeStatement.ExpensesByCategory != null && incomeStatement.ExpensesByCategory.Any())
                    {
                        builder.OpenElement(24, "div");
                        builder.AddAttribute(25, "class", "space-y-2");
                        foreach (var expense in incomeStatement.ExpensesByCategory.OrderByDescending(e => e.Amount))
                        {
                            builder.OpenElement(26, "div");
                            builder.AddAttribute(27, "class", "flex items-center justify-between rounded bg-white p-3");
                            builder.OpenElement(28, "span");
                            builder.AddAttribute(29, "class", "font-medium text-gray-700");
                            builder.AddContent(30, expense.Category);
                            builder.CloseElement();
                            builder.OpenElement(31, "span");
                            builder.AddAttribute(32, "class", "font-semibold text-red-600");
                            builder.AddContent(33, FormatCurrency(expense.Amount));
                            builder.CloseElement();
                            builder.CloseElement();
                        }
                        builder.CloseElement();
                    }
                    else
                    {
                        builder.OpenElement(34, "p");
                        builder.AddAttribute(35, "class", "text-sm text-gray-500");
                        builder.AddContent(36, "No expenses recorded in this period.");
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                    builder.CloseElement();
                }
                break;

            case "CashFlow":
                if (cashFlowReport != null)
                {
                    // Cash Inflow/Outflow comparison
                    builder.OpenElement(22, "div");
                    builder.AddAttribute(23, "class", "grid grid-cols-1 gap-6 md:grid-cols-2");
                    
                    // Inflows
                    builder.OpenElement(24, "div");
                    builder.AddAttribute(25, "class", "rounded-lg border border-green-200 bg-green-50 p-4");
                    builder.OpenElement(26, "h3");
                    builder.AddAttribute(27, "class", "mb-4 text-lg font-semibold text-green-800");
                    builder.AddContent(28, "Cash Inflows");
                    builder.CloseElement();
                    if (cashFlowReport.CashInflows != null && cashFlowReport.CashInflows.Any())
                    {
                        builder.OpenElement(29, "div");
                        builder.AddAttribute(30, "class", "space-y-2");
                        foreach (var inflow in cashFlowReport.CashInflows)
                        {
                            builder.OpenElement(31, "div");
                            builder.AddAttribute(32, "class", "flex items-center justify-between");
                            builder.OpenElement(33, "span");
                            builder.AddAttribute(34, "class", "text-sm text-gray-700");
                            builder.AddContent(35, inflow.Category);
                            builder.CloseElement();
                            builder.OpenElement(36, "span");
                            builder.AddAttribute(37, "class", "font-semibold text-green-700");
                            builder.AddContent(38, FormatCurrency(inflow.Amount));
                            builder.CloseElement();
                            builder.CloseElement();
                        }
                        builder.CloseElement();
                    }
                    else
                    {
                        builder.OpenElement(39, "div");
                        builder.AddAttribute(40, "class", "rounded bg-white p-4 text-center");
                        builder.OpenElement(41, "p");
                        builder.AddAttribute(42, "class", "text-sm text-gray-500");
                        builder.AddContent(43, "No cash inflows for the selected period");
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    builder.CloseElement();

                    // Outflows
                    builder.OpenElement(44, "div");
                    builder.AddAttribute(45, "class", "rounded-lg border border-red-200 bg-red-50 p-4");
                    builder.OpenElement(46, "h3");
                    builder.AddAttribute(47, "class", "mb-4 text-lg font-semibold text-red-800");
                    builder.AddContent(48, "Cash Outflows");
                    builder.CloseElement();
                    if (cashFlowReport.CashOutflows != null && cashFlowReport.CashOutflows.Any())
                    {
                        builder.OpenElement(49, "div");
                        builder.AddAttribute(50, "class", "space-y-2");
                        foreach (var outflow in cashFlowReport.CashOutflows)
                        {
                            builder.OpenElement(51, "div");
                            builder.AddAttribute(52, "class", "flex items-center justify-between");
                            builder.OpenElement(53, "span");
                            builder.AddAttribute(54, "class", "text-sm text-gray-700");
                            builder.AddContent(55, outflow.Category);
                            builder.CloseElement();
                            builder.OpenElement(56, "span");
                            builder.AddAttribute(57, "class", "font-semibold text-red-700");
                            builder.AddContent(58, FormatCurrency(outflow.Amount));
                            builder.CloseElement();
                            builder.CloseElement();
                        }
                        builder.CloseElement();
                    }
                    else
                    {
                        builder.OpenElement(59, "div");
                        builder.AddAttribute(60, "class", "rounded bg-white p-4 text-center");
                        builder.OpenElement(61, "p");
                        builder.AddAttribute(62, "class", "text-sm text-gray-500");
                        builder.AddContent(63, "No cash outflows for the selected period");
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                    builder.CloseElement();
                }
                else
                {
                    builder.OpenElement(64, "div");
                    builder.AddAttribute(65, "class", "rounded-lg border border-gray-200 bg-gray-50 p-8 text-center");
                    builder.OpenElement(66, "p");
                    builder.AddAttribute(67, "class", "text-sm font-medium text-gray-600");
                    builder.AddContent(68, "No cash flow data available for the selected period");
                    builder.CloseElement();
                    builder.CloseElement();
                }
                break;

            case "AccountsReceivable":
                if (arRecords != null && arRecords.Any())
                {
                    // Aging Summary
                    var agingSummary = arRecords.GroupBy(r => r.AgingBucket)
                        .Select(g => new { Bucket = g.Key, Amount = g.Sum(r => r.OutstandingBalance), Count = g.Count() })
                        .OrderBy(x => x.Bucket == "Current" ? 0 : x.Bucket == "31-60 Days" ? 1 : x.Bucket == "61-90 Days" ? 2 : 3)
                        .ToList();

                    builder.OpenElement(54, "div");
                    builder.AddAttribute(55, "class", "rounded-lg border border-gray-200 bg-gray-50 p-4");
                    builder.OpenElement(56, "h3");
                    builder.AddAttribute(57, "class", "mb-4 text-lg font-semibold text-gray-800");
                    builder.AddContent(58, "Aging Summary");
                    builder.CloseElement();
                    builder.OpenElement(59, "div");
                    builder.AddAttribute(60, "class", "space-y-2");
                    foreach (var item in agingSummary)
                    {
                        builder.OpenElement(61, "div");
                        builder.AddAttribute(62, "class", "flex items-center justify-between rounded bg-white p-3");
                        builder.OpenElement(63, "span");
                        builder.AddAttribute(64, "class", "font-medium text-gray-700");
                        builder.AddContent(65, $"{item.Bucket} ({item.Count} accounts)");
                        builder.CloseElement();
                        builder.OpenElement(66, "span");
                        builder.AddAttribute(67, "class", "font-semibold text-gray-800");
                        builder.AddContent(68, FormatCurrency(item.Amount));
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                    builder.CloseElement();
                }
                else
                {
                    builder.OpenElement(69, "div");
                    builder.AddAttribute(70, "class", "rounded-lg border border-gray-200 bg-gray-50 p-8 text-center");
                    builder.OpenElement(71, "p");
                    builder.AddAttribute(72, "class", "text-sm font-medium text-gray-600");
                    builder.AddContent(73, "No accounts receivable data available");
                    builder.CloseElement();
                    builder.CloseElement();
                }
                break;

            case "PaymentHistory":
                if (paymentHistory != null && paymentHistory.Any())
                {
                    var totalPayments = paymentHistory.Sum(p => p.Amount);
                    var paymentMethods = paymentHistory.GroupBy(p => p.PaymentMethod)
                        .Select(g => new { Method = g.Key, Amount = g.Sum(p => p.Amount), Count = g.Count() })
                        .OrderByDescending(x => x.Amount)
                        .ToList();

                    builder.OpenElement(100, "div");
                    builder.AddAttribute(101, "class", "grid grid-cols-1 gap-6 md:grid-cols-2");
                    
                    // Payment Method Breakdown
                    builder.OpenElement(102, "div");
                    builder.AddAttribute(103, "class", "rounded-lg border border-gray-200 bg-gray-50 p-4");
                    builder.OpenElement(104, "h3");
                    builder.AddAttribute(105, "class", "mb-4 text-lg font-semibold text-gray-800");
                    builder.AddContent(106, "Payment Method Breakdown");
                    builder.CloseElement();
                    builder.OpenElement(107, "div");
                    builder.AddAttribute(108, "class", "space-y-2");
                    foreach (var method in paymentMethods)
                    {
                        builder.OpenElement(109, "div");
                        builder.AddAttribute(110, "class", "flex items-center justify-between rounded bg-white p-3");
                        builder.OpenElement(111, "span");
                        builder.AddAttribute(112, "class", "font-medium text-gray-700");
                        builder.AddContent(113, $"{method.Method} ({method.Count} transactions)");
                        builder.CloseElement();
                        builder.OpenElement(114, "span");
                        builder.AddAttribute(115, "class", "font-semibold text-green-600");
                        builder.AddContent(116, FormatCurrency(method.Amount));
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                    builder.CloseElement();

                    // Summary Stats
                    builder.OpenElement(117, "div");
                    builder.AddAttribute(118, "class", "rounded-lg border border-gray-200 bg-gray-50 p-4");
                    builder.OpenElement(119, "h3");
                    builder.AddAttribute(120, "class", "mb-4 text-lg font-semibold text-gray-800");
                    builder.AddContent(121, "Summary Statistics");
                    builder.CloseElement();
                    builder.OpenElement(122, "div");
                    builder.AddAttribute(123, "class", "space-y-3");
                    builder.OpenElement(124, "div");
                    builder.AddAttribute(125, "class", "flex items-center justify-between");
                    builder.OpenElement(126, "span");
                    builder.AddAttribute(127, "class", "text-sm text-gray-600");
                    builder.AddContent(128, "Total Transactions");
                    builder.CloseElement();
                    builder.OpenElement(129, "span");
                    builder.AddAttribute(130, "class", "font-semibold text-gray-800");
                    builder.AddContent(131, paymentHistory.Count.ToString("N0"));
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.OpenElement(132, "div");
                    builder.AddAttribute(133, "class", "flex items-center justify-between");
                    builder.OpenElement(134, "span");
                    builder.AddAttribute(135, "class", "text-sm text-gray-600");
                    builder.AddContent(136, "Average Payment");
                    builder.CloseElement();
                    builder.OpenElement(137, "span");
                    builder.AddAttribute(138, "class", "font-semibold text-purple-600");
                    builder.AddContent(139, FormatCurrency(totalPayments / paymentHistory.Count));
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                }
                break;

            case "ExpenseAnalysis":
                if (expenseAnalysis != null)
                {
                    builder.OpenElement(140, "div");
                    builder.AddAttribute(141, "class", "grid grid-cols-1 gap-6 md:grid-cols-3");
                    
                    // By Category
                    builder.OpenElement(142, "div");
                    builder.AddAttribute(143, "class", "rounded-lg border border-gray-200 bg-gray-50 p-4");
                    builder.OpenElement(144, "h3");
                    builder.AddAttribute(145, "class", "mb-4 text-lg font-semibold text-gray-800");
                    builder.AddContent(146, "By Category");
                    builder.CloseElement();
                    if (expenseAnalysis.ByCategory != null && expenseAnalysis.ByCategory.Any())
                    {
                        builder.OpenElement(147, "div");
                        builder.AddAttribute(148, "class", "space-y-2");
                        foreach (var category in expenseAnalysis.ByCategory.OrderByDescending(c => c.Amount))
                        {
                            builder.OpenElement(149, "div");
                            builder.AddAttribute(150, "class", "flex items-center justify-between rounded bg-white p-3");
                            builder.OpenElement(151, "span");
                            builder.AddAttribute(152, "class", "font-medium text-gray-700");
                            builder.AddContent(153, category.Category);
                            builder.CloseElement();
                            builder.OpenElement(154, "span");
                            builder.AddAttribute(155, "class", "font-semibold text-red-600");
                            builder.AddContent(156, FormatCurrency(category.Amount));
                            builder.CloseElement();
                            builder.CloseElement();
                        }
                        builder.CloseElement();
                    }
                    builder.CloseElement();

                    // By Status
                    builder.OpenElement(157, "div");
                    builder.AddAttribute(158, "class", "rounded-lg border border-gray-200 bg-gray-50 p-4");
                    builder.OpenElement(159, "h3");
                    builder.AddAttribute(160, "class", "mb-4 text-lg font-semibold text-gray-800");
                    builder.AddContent(161, "By Status");
                    builder.CloseElement();
                    if (expenseAnalysis.ByStatus != null && expenseAnalysis.ByStatus.Any())
                    {
                        builder.OpenElement(162, "div");
                        builder.AddAttribute(163, "class", "space-y-2");
                        foreach (var status in expenseAnalysis.ByStatus)
                        {
                            builder.OpenElement(164, "div");
                            builder.AddAttribute(165, "class", "flex items-center justify-between rounded bg-white p-3");
                            builder.OpenElement(166, "span");
                            var statusColor = status.Status == "Approved" ? "text-green-700" : 
                                            status.Status == "Pending" ? "text-yellow-700" : 
                                            "text-red-700";
                            builder.AddAttribute(167, "class", $"font-medium {statusColor}");
                            builder.AddContent(168, status.Status);
                            builder.CloseElement();
                            builder.OpenElement(169, "span");
                            builder.AddAttribute(170, "class", "font-semibold text-gray-800");
                            builder.AddContent(171, FormatCurrency(status.Amount));
                            builder.CloseElement();
                            builder.CloseElement();
                        }
                        builder.CloseElement();
                    }
                    builder.CloseElement();

                    // By Payment Method
                    builder.OpenElement(172, "div");
                    builder.AddAttribute(173, "class", "rounded-lg border border-gray-200 bg-gray-50 p-4");
                    builder.OpenElement(174, "h3");
                    builder.AddAttribute(175, "class", "mb-4 text-lg font-semibold text-gray-800");
                    builder.AddContent(176, "By Payment Method");
                    builder.CloseElement();
                    if (expenseAnalysis.ByPaymentMethod != null && expenseAnalysis.ByPaymentMethod.Any())
                    {
                        builder.OpenElement(177, "div");
                        builder.AddAttribute(178, "class", "space-y-2");
                        foreach (var method in expenseAnalysis.ByPaymentMethod.OrderByDescending(m => m.Amount))
                        {
                            builder.OpenElement(178, "div");
                            builder.AddAttribute(179, "class", "flex items-center justify-between rounded bg-white p-3");
                            builder.OpenElement(180, "span");
                            builder.AddAttribute(181, "class", "font-medium text-gray-700");
                            builder.AddContent(182, method.PaymentMethod);
                            builder.CloseElement();
                            builder.OpenElement(183, "span");
                            builder.AddAttribute(184, "class", "font-semibold text-gray-800");
                            builder.AddContent(185, FormatCurrency(method.Amount));
                            builder.CloseElement();
                            builder.CloseElement();
                        }
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                    builder.CloseElement();
                }
                break;

                case "GeneralLedger":
                    if (generalLedger != null && generalLedger.Entries.Any())
                    {
                        var totalCredits = generalLedger.Entries.Sum(e => e.Credit);
                        var totalDebits = generalLedger.Entries.Sum(e => e.Debit);
                        var isBalanced = Math.Abs(totalDebits - totalCredits) < 0.01m; // Allow for rounding
                        // FIXED: Net Balance should be Total Debits - Total Credits (should always be 0 for balanced ledger)
                        var netBalance = totalDebits - totalCredits;

                        builder.OpenElement(186, "div");
                        builder.AddAttribute(187, "class", "grid grid-cols-1 gap-6 md:grid-cols-2");
                        
                        // Summary
                        builder.OpenElement(188, "div");
                        builder.AddAttribute(189, "class", "rounded-lg border border-gray-200 bg-gray-50 p-4");
                        builder.OpenElement(190, "h3");
                        builder.AddAttribute(191, "class", "mb-4 text-lg font-semibold text-gray-800");
                        builder.AddContent(192, "Summary");
                        builder.CloseElement();
                        builder.OpenElement(193, "div");
                        builder.AddAttribute(194, "class", "space-y-3");
                        builder.OpenElement(195, "div");
                        builder.AddAttribute(196, "class", "flex items-center justify-between rounded bg-white p-3");
                        builder.OpenElement(197, "span");
                        builder.AddAttribute(198, "class", "font-medium text-gray-700");
                        builder.AddContent(199, "Total Credits");
                        builder.CloseElement();
                        builder.OpenElement(200, "span");
                        builder.AddAttribute(201, "class", "font-semibold text-green-600");
                        builder.AddContent(202, FormatCurrency(totalCredits));
                        builder.CloseElement();
                        builder.CloseElement();
                        builder.OpenElement(203, "div");
                        builder.AddAttribute(204, "class", "flex items-center justify-between rounded bg-white p-3");
                        builder.OpenElement(205, "span");
                        builder.AddAttribute(206, "class", "font-medium text-gray-700");
                        builder.AddContent(207, "Total Debits");
                        builder.CloseElement();
                        builder.OpenElement(208, "span");
                        builder.AddAttribute(209, "class", "font-semibold text-red-600");
                        builder.AddContent(210, FormatCurrency(totalDebits));
                        builder.CloseElement();
                        builder.CloseElement();
                        builder.OpenElement(211, "div");
                        builder.AddAttribute(212, "class", "flex items-center justify-between rounded bg-white p-3");
                        builder.OpenElement(213, "span");
                        builder.AddAttribute(214, "class", "font-medium text-gray-700");
                        builder.AddContent(215, "Net Balance");
                        builder.CloseElement();
                        builder.OpenElement(216, "span");
                        builder.AddAttribute(217, "class", $"font-semibold {(Math.Abs(netBalance) < 0.01m ? "text-green-600" : "text-red-600")}");
                        builder.AddContent(218, FormatCurrency(netBalance));
                        builder.CloseElement();
                        builder.CloseElement();
                        builder.OpenElement(219, "div");
                        builder.AddAttribute(220, "class", "flex items-center justify-between rounded bg-white p-3");
                        builder.OpenElement(221, "span");
                        builder.AddAttribute(222, "class", "font-medium text-gray-700");
                        builder.AddContent(223, "Balance Check");
                        builder.CloseElement();
                        builder.OpenElement(224, "span");
                        builder.AddAttribute(225, "class", $"font-semibold {(isBalanced ? "text-green-600" : "text-red-600")}");
                        builder.AddContent(226, isBalanced ? "✓ Balanced" : $"Out of Balance: {FormatCurrency(Math.Abs(totalDebits - totalCredits))}");
                        builder.CloseElement();
                        builder.CloseElement();
                        builder.OpenElement(227, "div");
                        builder.AddAttribute(228, "class", "flex items-center justify-between rounded bg-white p-3");
                        builder.OpenElement(229, "span");
                        builder.AddAttribute(230, "class", "font-medium text-gray-700");
                        builder.AddContent(231, "Transaction Count");
                        builder.CloseElement();
                        builder.OpenElement(232, "span");
                        builder.AddAttribute(233, "class", "font-semibold text-gray-800");
                        builder.AddContent(234, generalLedger.Entries.Count.ToString("N0"));
                        builder.CloseElement();
                        builder.CloseElement();
                        builder.CloseElement();
                        builder.CloseElement();

                    // Balance Trend
                    builder.OpenElement(225, "div");
                    builder.AddAttribute(226, "class", "rounded-lg border border-gray-200 bg-gray-50 p-4");
                    builder.OpenElement(227, "h3");
                    builder.AddAttribute(228, "class", "mb-4 text-lg font-semibold text-gray-800");
                    builder.AddContent(229, "Balance Trend");
                    builder.CloseElement();
                    builder.OpenElement(230, "div");
                    builder.AddAttribute(231, "class", "space-y-2");
                    var monthlyBalances = generalLedger.Entries
                        .GroupBy(e => new { e.Date.Year, e.Date.Month })
                        .Select(g => new { 
                            Month = new DateTime(g.Key.Year, g.Key.Month, 1).ToString("MMM yyyy"),
                            Balance = g.OrderByDescending(e => e.Date).Last().Balance
                        })
                        .OrderBy(x => x.Month)
                        .ToList();
                    foreach (var month in monthlyBalances)
                    {
                        builder.OpenElement(232, "div");
                        builder.AddAttribute(233, "class", "flex items-center justify-between rounded bg-white p-3");
                        builder.OpenElement(234, "span");
                        builder.AddAttribute(235, "class", "font-medium text-gray-700");
                        builder.AddContent(236, month.Month);
                        builder.CloseElement();
                        builder.OpenElement(237, "span");
                        builder.AddAttribute(238, "class", $"font-semibold {(month.Balance >= 0 ? "text-blue-600" : "text-red-600")}");
                        builder.AddContent(239, FormatCurrency(month.Balance));
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                }
                else
                {
                    builder.OpenElement(250, "div");
                    builder.AddAttribute(251, "class", "rounded-lg border border-gray-200 bg-gray-50 p-8 text-center");
                    builder.OpenElement(252, "p");
                    builder.AddAttribute(253, "class", "text-sm font-medium text-gray-600");
                    builder.AddContent(254, "No general ledger data available for the selected period");
                    builder.CloseElement();
                    builder.CloseElement();
                }
                break;

            case "BalanceSheet":
                if (balanceSheetReport != null)
                {
                    builder.OpenElement(300, "div");
                    builder.AddAttribute(301, "class", "grid grid-cols-1 gap-6 md:grid-cols-3");
                    
                    // Assets Section
                    builder.OpenElement(302, "div");
                    builder.AddAttribute(303, "class", "rounded-lg border border-blue-200 bg-blue-50 p-4");
                    builder.OpenElement(304, "h3");
                    builder.AddAttribute(305, "class", "mb-4 text-lg font-semibold text-blue-800");
                    builder.AddContent(306, "Assets");
                    builder.CloseElement();
                    builder.OpenElement(307, "div");
                    builder.AddAttribute(308, "class", "space-y-2");
                    if (balanceSheetReport.Assets != null && balanceSheetReport.Assets.Any())
                    {
                        foreach (var asset in balanceSheetReport.Assets.Where(a => a.Balance != 0))
                        {
                            builder.OpenElement(309, "div");
                            builder.AddAttribute(310, "class", "flex items-center justify-between rounded bg-white p-3");
                            builder.OpenElement(311, "div");
                            builder.OpenElement(312, "span");
                            builder.AddAttribute(313, "class", "block text-xs font-medium text-gray-600");
                            builder.AddContent(314, asset.AccountCode);
                            builder.CloseElement();
                            builder.OpenElement(315, "span");
                            builder.AddAttribute(316, "class", "block text-sm font-medium text-gray-700");
                            builder.AddContent(317, asset.AccountName);
                            builder.CloseElement();
                            builder.CloseElement();
                            builder.OpenElement(318, "span");
                            builder.AddAttribute(319, "class", "font-semibold text-blue-600");
                            builder.AddContent(320, FormatCurrency(asset.Balance));
                            builder.CloseElement();
                            builder.CloseElement();
                        }
                    }
                    builder.OpenElement(321, "div");
                    builder.AddAttribute(322, "class", "mt-3 flex items-center justify-between rounded bg-blue-100 p-3 border-t-2 border-blue-300");
                    builder.OpenElement(323, "span");
                    builder.AddAttribute(324, "class", "font-bold text-blue-800");
                    builder.AddContent(325, "Total Assets");
                    builder.CloseElement();
                    builder.OpenElement(326, "span");
                    builder.AddAttribute(327, "class", "font-bold text-blue-800");
                    builder.AddContent(328, FormatCurrency(balanceSheetReport.TotalAssets));
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();

                    // Liabilities Section
                    builder.OpenElement(330, "div");
                    builder.AddAttribute(331, "class", "rounded-lg border border-red-200 bg-red-50 p-4");
                    builder.OpenElement(332, "h3");
                    builder.AddAttribute(333, "class", "mb-4 text-lg font-semibold text-red-800");
                    builder.AddContent(334, "Liabilities");
                    builder.CloseElement();
                    builder.OpenElement(335, "div");
                    builder.AddAttribute(336, "class", "space-y-2");
                    if (balanceSheetReport.Liabilities != null && balanceSheetReport.Liabilities.Any())
                    {
                        foreach (var liability in balanceSheetReport.Liabilities.Where(l => l.Balance != 0))
                        {
                            builder.OpenElement(337, "div");
                            builder.AddAttribute(338, "class", "flex items-center justify-between rounded bg-white p-3");
                            builder.OpenElement(339, "div");
                            builder.OpenElement(340, "span");
                            builder.AddAttribute(341, "class", "block text-xs font-medium text-gray-600");
                            builder.AddContent(342, liability.AccountCode);
                            builder.CloseElement();
                            builder.OpenElement(343, "span");
                            builder.AddAttribute(344, "class", "block text-sm font-medium text-gray-700");
                            builder.AddContent(345, liability.AccountName);
                            builder.CloseElement();
                            builder.CloseElement();
                            builder.OpenElement(346, "span");
                            builder.AddAttribute(347, "class", "font-semibold text-red-600");
                            builder.AddContent(348, FormatCurrency(liability.Balance));
                            builder.CloseElement();
                            builder.CloseElement();
                        }
                    }
                    builder.OpenElement(349, "div");
                    builder.AddAttribute(350, "class", "mt-3 flex items-center justify-between rounded bg-red-100 p-3 border-t-2 border-red-300");
                    builder.OpenElement(351, "span");
                    builder.AddAttribute(352, "class", "font-bold text-red-800");
                    builder.AddContent(353, "Total Liabilities");
                    builder.CloseElement();
                    builder.OpenElement(354, "span");
                    builder.AddAttribute(355, "class", "font-bold text-red-800");
                    builder.AddContent(356, FormatCurrency(balanceSheetReport.TotalLiabilities));
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();

                    // Equity Section
                    builder.OpenElement(360, "div");
                    builder.AddAttribute(361, "class", "rounded-lg border border-green-200 bg-green-50 p-4");
                    builder.OpenElement(362, "h3");
                    builder.AddAttribute(363, "class", "mb-4 text-lg font-semibold text-green-800");
                    builder.AddContent(364, "Equity");
                    builder.CloseElement();
                    builder.OpenElement(365, "div");
                    builder.AddAttribute(366, "class", "space-y-2");
                    if (balanceSheetReport.Equity != null && balanceSheetReport.Equity.Any())
                    {
                        foreach (var equity in balanceSheetReport.Equity.Where(e => e.Balance != 0))
                        {
                            builder.OpenElement(367, "div");
                            builder.AddAttribute(368, "class", "flex items-center justify-between rounded bg-white p-3");
                            builder.OpenElement(369, "div");
                            builder.OpenElement(370, "span");
                            builder.AddAttribute(371, "class", "block text-xs font-medium text-gray-600");
                            builder.AddContent(372, equity.AccountCode);
                            builder.CloseElement();
                            builder.OpenElement(373, "span");
                            builder.AddAttribute(374, "class", "block text-sm font-medium text-gray-700");
                            builder.AddContent(375, equity.AccountName);
                            builder.CloseElement();
                            builder.CloseElement();
                            builder.OpenElement(376, "span");
                            builder.AddAttribute(377, "class", "font-semibold text-green-600");
                            builder.AddContent(378, FormatCurrency(equity.Balance));
                            builder.CloseElement();
                            builder.CloseElement();
                        }
                    }
                    builder.OpenElement(379, "div");
                    builder.AddAttribute(380, "class", "mt-3 flex items-center justify-between rounded bg-green-100 p-3 border-t-2 border-green-300");
                    builder.OpenElement(381, "span");
                    builder.AddAttribute(382, "class", "font-bold text-green-800");
                    builder.AddContent(383, "Total Equity");
                    builder.CloseElement();
                    builder.OpenElement(384, "span");
                    builder.AddAttribute(385, "class", "font-bold text-green-800");
                    builder.AddContent(386, FormatCurrency(balanceSheetReport.TotalEquity));
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();

                    // Balance Check
                    builder.OpenElement(390, "div");
                    builder.AddAttribute(391, "class", "mt-6 rounded-lg border-2 p-4 " + (balanceSheetReport.IsBalanced ? "border-green-300 bg-green-50" : "border-red-300 bg-red-50"));
                    builder.OpenElement(392, "div");
                    builder.AddAttribute(393, "class", "flex items-center justify-between");
                    builder.OpenElement(394, "span");
                    builder.AddAttribute(395, "class", "font-bold " + (balanceSheetReport.IsBalanced ? "text-green-800" : "text-red-800"));
                    builder.AddContent(396, balanceSheetReport.IsBalanced ? "✓ Balance Sheet is Balanced" : "✗ Balance Sheet is Unbalanced");
                    builder.CloseElement();
                    builder.OpenElement(397, "span");
                    builder.AddAttribute(398, "class", "font-bold " + (balanceSheetReport.IsBalanced ? "text-green-800" : "text-red-800"));
                    builder.AddContent(399, $"Assets = Liabilities + Equity: {FormatCurrency(balanceSheetReport.TotalAssets)} = {FormatCurrency(balanceSheetReport.TotalLiabilities + balanceSheetReport.TotalEquity)}");
                    builder.CloseElement();
                    builder.CloseElement();
                    if (!balanceSheetReport.IsBalanced)
                    {
                        builder.OpenElement(400, "div");
                        builder.AddAttribute(401, "class", "mt-2 text-sm " + (balanceSheetReport.Difference > 0 ? "text-red-700" : "text-red-700"));
                        builder.AddContent(402, $"Difference: {FormatCurrency(Math.Abs(balanceSheetReport.Difference))}");
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                }
                else
                {
                    builder.OpenElement(410, "div");
                    builder.AddAttribute(411, "class", "rounded-lg border border-gray-200 bg-gray-50 p-8 text-center");
                    builder.OpenElement(412, "p");
                    builder.AddAttribute(413, "class", "text-sm font-medium text-gray-600");
                    builder.AddContent(414, "No balance sheet data available");
                    builder.CloseElement();
                    builder.CloseElement();
                }
                break;
        }

        builder.CloseElement();
    }

    private void RenderByGradeTab(RenderTreeBuilder builder)
    {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "rounded-lg border border-gray-200 bg-gray-50 p-4");
        builder.OpenElement(2, "p");
        builder.AddAttribute(3, "class", "text-sm text-gray-600");
        builder.AddContent(4, "Grade-level breakdown will be displayed here. This requires additional data aggregation.");
        builder.CloseElement();
        builder.CloseElement();
    }

    private void RenderByMonthTab(RenderTreeBuilder builder)
    {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "space-y-4");

        switch (activeReport)
        {
            case "CashFlow":
                if (cashFlowReport != null && cashFlowReport.MonthlyBreakdown != null && cashFlowReport.MonthlyBreakdown.Any())
                {
                    builder.OpenElement(2, "div");
                    builder.AddAttribute(3, "class", "overflow-x-auto rounded-lg border border-gray-200");
                    builder.OpenElement(4, "table");
                    builder.AddAttribute(5, "class", "w-full border-collapse text-sm");
                    builder.OpenElement(6, "thead");
                    builder.OpenElement(7, "tr");
                    builder.AddAttribute(8, "class", "border-b-2 border-gray-300 bg-gray-50");
                    builder.OpenElement(9, "th");
                    builder.AddAttribute(10, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(11, "Month");
                    builder.CloseElement();
                    builder.OpenElement(12, "th");
                    builder.AddAttribute(13, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700");
                    builder.AddContent(14, "Cash In");
                    builder.CloseElement();
                    builder.OpenElement(15, "th");
                    builder.AddAttribute(16, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700");
                    builder.AddContent(17, "Cash Out");
                    builder.CloseElement();
                    builder.OpenElement(18, "th");
                    builder.AddAttribute(19, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700");
                    builder.AddContent(20, "Net Flow");
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.OpenElement(21, "tbody");
                    foreach (var month in cashFlowReport.MonthlyBreakdown)
                    {
                        builder.OpenElement(22, "tr");
                        builder.AddAttribute(23, "class", "border-b border-gray-100 hover:bg-gray-50");
                        builder.OpenElement(24, "td");
                        builder.AddAttribute(25, "class", "px-4 py-3 text-sm font-medium text-gray-800");
                        builder.AddContent(26, month.MonthName);
                        builder.CloseElement();
                        builder.OpenElement(27, "td");
                        builder.AddAttribute(28, "class", "px-4 py-3 text-right text-sm text-green-600");
                        builder.AddContent(29, FormatCurrency(month.CashIn));
                        builder.CloseElement();
                        builder.OpenElement(30, "td");
                        builder.AddAttribute(31, "class", "px-4 py-3 text-right text-sm text-red-600");
                        builder.AddContent(32, FormatCurrency(month.CashOut));
                        builder.CloseElement();
                        builder.OpenElement(33, "td");
                        builder.AddAttribute(34, "class", $"px-4 py-3 text-right text-sm font-semibold {(month.NetCashFlow >= 0 ? "text-blue-600" : "text-red-600")}");
                        builder.AddContent(35, FormatCurrency(month.NetCashFlow));
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                }
                break;

            case "ExpenseAnalysis":
                if (expenseAnalysis != null && expenseAnalysis.MonthlyTrends != null && expenseAnalysis.MonthlyTrends.Any())
                {
                    builder.OpenElement(36, "div");
                    builder.AddAttribute(37, "class", "overflow-x-auto rounded-lg border border-gray-200");
                    builder.OpenElement(38, "table");
                    builder.AddAttribute(39, "class", "w-full border-collapse text-sm");
                    builder.OpenElement(40, "thead");
                    builder.OpenElement(41, "tr");
                    builder.AddAttribute(42, "class", "border-b-2 border-gray-300 bg-gray-50");
                    builder.OpenElement(43, "th");
                    builder.AddAttribute(44, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(45, "Month");
                    builder.CloseElement();
                    builder.OpenElement(46, "th");
                    builder.AddAttribute(47, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700");
                    builder.AddContent(48, "Amount");
                    builder.CloseElement();
                    builder.OpenElement(49, "th");
                    builder.AddAttribute(50, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700");
                    builder.AddContent(51, "Count");
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.OpenElement(52, "tbody");
                    foreach (var trend in expenseAnalysis.MonthlyTrends.OrderBy(t => t.Year).ThenBy(t => t.Month))
                    {
                        builder.OpenElement(53, "tr");
                        builder.AddAttribute(54, "class", "border-b border-gray-100 hover:bg-gray-50");
                        builder.OpenElement(55, "td");
                        builder.AddAttribute(56, "class", "px-4 py-3 text-sm font-medium text-gray-800");
                        builder.AddContent(57, trend.MonthName);
                        builder.CloseElement();
                        builder.OpenElement(58, "td");
                        builder.AddAttribute(59, "class", "px-4 py-3 text-right text-sm font-semibold text-red-600");
                        builder.AddContent(60, FormatCurrency(trend.Amount));
                        builder.CloseElement();
                        builder.OpenElement(61, "td");
                        builder.AddAttribute(62, "class", "px-4 py-3 text-right text-sm text-gray-600");
                        builder.AddContent(63, trend.Count.ToString("N0"));
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                }
                else
                {
                    builder.OpenElement(64, "div");
                    builder.AddAttribute(65, "class", "rounded-lg border border-gray-200 bg-gray-50 p-4 text-center");
                    builder.OpenElement(66, "p");
                    builder.AddAttribute(67, "class", "text-sm text-gray-600");
                    builder.AddContent(68, "Monthly breakdown will be displayed here.");
                    builder.CloseElement();
                    builder.CloseElement();
                }
                break;

            default:
                builder.OpenElement(69, "div");
                builder.AddAttribute(70, "class", "rounded-lg border border-gray-200 bg-gray-50 p-4 text-center");
                builder.OpenElement(71, "p");
                builder.AddAttribute(72, "class", "text-sm text-gray-600");
                builder.AddContent(73, "Monthly breakdown will be displayed here.");
                builder.CloseElement();
                builder.CloseElement();
                break;
        }

        builder.CloseElement();
    }

    private void RenderDetailsTab(RenderTreeBuilder builder)
    {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "space-y-4");

        switch (activeReport)
        {
            case "GeneralLedger":
                if (generalLedger != null && generalLedger.Entries.Any())
                {
                    builder.OpenElement(2, "div");
                    builder.AddAttribute(3, "class", "overflow-x-auto rounded-lg border border-gray-200");
                    builder.OpenElement(4, "table");
                    builder.AddAttribute(5, "class", "w-full border-collapse text-sm");
                    builder.OpenElement(6, "thead");
                    builder.OpenElement(7, "tr");
                    builder.AddAttribute(8, "class", "border-b-2 border-gray-300 bg-gray-50");
                    builder.OpenElement(9, "th");
                    builder.AddAttribute(10, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(11, "Date");
                    builder.CloseElement();
                    builder.OpenElement(12, "th");
                    builder.AddAttribute(13, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(14, "Entry #");
                    builder.CloseElement();
                    builder.OpenElement(15, "th");
                    builder.AddAttribute(16, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(17, "Account");
                    builder.CloseElement();
                    builder.OpenElement(18, "th");
                    builder.AddAttribute(19, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(20, "Description");
                    builder.CloseElement();
                    builder.OpenElement(21, "th");
                    builder.AddAttribute(22, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(23, "Type");
                    builder.CloseElement();
                    builder.OpenElement(24, "th");
                    builder.AddAttribute(25, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700");
                    builder.AddContent(26, "Debit");
                    builder.CloseElement();
                    builder.OpenElement(27, "th");
                    builder.AddAttribute(28, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700");
                    builder.AddContent(29, "Credit");
                    builder.CloseElement();
                    builder.OpenElement(30, "th");
                    builder.AddAttribute(31, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700");
                    builder.AddContent(32, "Balance");
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.OpenElement(27, "tbody");
                    foreach (var entry in generalLedger.Entries)
                    {
                        builder.OpenElement(28, "tr");
                        builder.AddAttribute(29, "class", "border-b border-gray-100 hover:bg-gray-50");
                        builder.OpenElement(33, "td");
                        builder.AddAttribute(34, "class", "px-4 py-3 text-gray-700");
                        builder.AddContent(35, entry.Date.ToString("MMM dd, yyyy"));
                        builder.CloseElement();
                        builder.OpenElement(36, "td");
                        builder.AddAttribute(37, "class", "px-4 py-3 text-xs font-mono text-gray-600");
                        builder.AddContent(38, entry.EntryNumber);
                        builder.CloseElement();
                        builder.OpenElement(39, "td");
                        builder.AddAttribute(40, "class", "px-4 py-3");
                        builder.OpenElement(41, "div");
                        builder.AddAttribute(42, "class", "flex flex-col");
                        builder.OpenElement(43, "span");
                        builder.AddAttribute(44, "class", "text-xs font-semibold text-gray-800");
                        builder.AddContent(45, $"{entry.AccountCode} - {entry.AccountName}");
                        builder.CloseElement();
                        builder.CloseElement();
                        builder.CloseElement();
                        builder.OpenElement(46, "td");
                        builder.AddAttribute(47, "class", "px-4 py-3 text-gray-800");
                        builder.AddContent(48, entry.Description);
                        builder.CloseElement();
                        builder.OpenElement(49, "td");
                        builder.AddAttribute(50, "class", "px-4 py-3");
                        builder.OpenElement(51, "span");
                        builder.AddAttribute(52, "class", $"inline-flex rounded-full px-2 py-1 text-xs font-medium {(entry.Type == "Payment" ? "bg-green-100 text-green-800" : entry.Type == "Expense" ? "bg-red-100 text-red-800" : "bg-blue-100 text-blue-800")}");
                        builder.AddContent(53, entry.Type);
                        builder.CloseElement();
                        builder.CloseElement();
                        builder.OpenElement(54, "td");
                        builder.AddAttribute(55, "class", "px-4 py-3 text-right text-red-600 font-medium");
                        builder.AddContent(56, entry.Debit > 0 ? FormatCurrency(entry.Debit) : "—");
                        builder.CloseElement();
                        builder.OpenElement(57, "td");
                        builder.AddAttribute(58, "class", "px-4 py-3 text-right text-green-600 font-medium");
                        builder.AddContent(59, entry.Credit > 0 ? FormatCurrency(entry.Credit) : "—");
                        builder.CloseElement();
                        builder.OpenElement(60, "td");
                        builder.AddAttribute(61, "class", $"px-4 py-3 text-right font-semibold {(entry.Balance >= 0 ? "text-blue-600" : "text-red-600")}");
                        builder.AddContent(62, FormatCurrency(entry.Balance));
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                }
                break;

            case "PaymentHistory":
                if (paymentHistory != null && paymentHistory.Any())
                {
                    builder.OpenElement(50, "div");
                    builder.AddAttribute(51, "class", "overflow-x-auto rounded-lg border border-gray-200");
                    builder.OpenElement(52, "table");
                    builder.AddAttribute(53, "class", "w-full border-collapse text-sm");
                    builder.OpenElement(54, "thead");
                    builder.OpenElement(55, "tr");
                    builder.AddAttribute(56, "class", "border-b-2 border-gray-300 bg-gray-50");
                    builder.OpenElement(57, "th");
                    builder.AddAttribute(58, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(59, "Date");
                    builder.CloseElement();
                    builder.OpenElement(60, "th");
                    builder.AddAttribute(61, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(62, "Student");
                    builder.CloseElement();
                    builder.OpenElement(63, "th");
                    builder.AddAttribute(64, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(65, "Grade");
                    builder.CloseElement();
                    builder.OpenElement(66, "th");
                    builder.AddAttribute(67, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700");
                    builder.AddContent(68, "Amount");
                    builder.CloseElement();
                    builder.OpenElement(69, "th");
                    builder.AddAttribute(70, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(71, "Method");
                    builder.CloseElement();
                    builder.OpenElement(72, "th");
                    builder.AddAttribute(73, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(74, "OR Number");
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.OpenElement(75, "tbody");
                    foreach (var payment in paymentHistory.OrderByDescending(p => p.PaymentDate))
                    {
                        builder.OpenElement(76, "tr");
                        builder.AddAttribute(77, "class", "border-b border-gray-100 hover:bg-gray-50");
                        builder.OpenElement(78, "td");
                        builder.AddAttribute(79, "class", "px-4 py-3 text-gray-700");
                        builder.AddContent(80, payment.PaymentDate.ToString("MMM dd, yyyy"));
                        builder.CloseElement();
                        builder.OpenElement(81, "td");
                        builder.AddAttribute(82, "class", "px-4 py-3 font-medium text-gray-800");
                        builder.AddContent(83, payment.StudentName);
                        builder.CloseElement();
                        builder.OpenElement(84, "td");
                        builder.AddAttribute(85, "class", "px-4 py-3 text-gray-600");
                        builder.AddContent(86, payment.GradeLevel);
                        builder.CloseElement();
                        builder.OpenElement(87, "td");
                        builder.AddAttribute(88, "class", "px-4 py-3 text-right font-semibold text-green-600");
                        builder.AddContent(89, FormatCurrency(payment.Amount));
                        builder.CloseElement();
                        builder.OpenElement(90, "td");
                        builder.AddAttribute(91, "class", "px-4 py-3 text-gray-600");
                        builder.AddContent(92, payment.PaymentMethod);
                        builder.CloseElement();
                        builder.OpenElement(93, "td");
                        builder.AddAttribute(94, "class", "px-4 py-3 text-gray-600");
                        builder.AddContent(95, payment.OrNumber);
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                }
                break;

            case "AccountsReceivable":
                if (arRecords != null && arRecords.Any())
                {
                    builder.OpenElement(96, "div");
                    builder.AddAttribute(97, "class", "overflow-x-auto rounded-lg border border-gray-200");
                    builder.OpenElement(98, "table");
                    builder.AddAttribute(99, "class", "w-full border-collapse text-sm");
                    builder.OpenElement(100, "thead");
                    builder.OpenElement(101, "tr");
                    builder.AddAttribute(102, "class", "border-b-2 border-gray-300 bg-gray-50");
                    builder.OpenElement(103, "th");
                    builder.AddAttribute(104, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(105, "Student");
                    builder.CloseElement();
                    builder.OpenElement(106, "th");
                    builder.AddAttribute(107, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(108, "Grade");
                    builder.CloseElement();
                    builder.OpenElement(109, "th");
                    builder.AddAttribute(110, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700");
                    builder.AddContent(111, "Total Fee");
                    builder.CloseElement();
                    builder.OpenElement(112, "th");
                    builder.AddAttribute(113, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700");
                    builder.AddContent(114, "Amount Paid");
                    builder.CloseElement();
                    builder.OpenElement(115, "th");
                    builder.AddAttribute(116, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700");
                    builder.AddContent(117, "Balance");
                    builder.CloseElement();
                    builder.OpenElement(118, "th");
                    builder.AddAttribute(119, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700");
                    builder.AddContent(120, "Aging");
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.OpenElement(121, "tbody");
                    foreach (var record in arRecords.OrderByDescending(r => r.OutstandingBalance))
                    {
                        builder.OpenElement(122, "tr");
                        builder.AddAttribute(123, "class", "border-b border-gray-100 hover:bg-gray-50");
                        builder.OpenElement(124, "td");
                        builder.AddAttribute(125, "class", "px-4 py-3 font-medium text-gray-800");
                        builder.AddContent(126, record.StudentName);
                        builder.CloseElement();
                        builder.OpenElement(127, "td");
                        builder.AddAttribute(128, "class", "px-4 py-3 text-gray-600");
                        builder.AddContent(129, record.GradeLevel);
                        builder.CloseElement();
                        builder.OpenElement(130, "td");
                        builder.AddAttribute(131, "class", "px-4 py-3 text-right text-gray-700");
                        builder.AddContent(132, FormatCurrency(record.TotalFee));
                        builder.CloseElement();
                        builder.OpenElement(133, "td");
                        builder.AddAttribute(134, "class", "px-4 py-3 text-right text-green-600");
                        builder.AddContent(135, FormatCurrency(record.AmountPaid));
                        builder.CloseElement();
                        builder.OpenElement(136, "td");
                        builder.AddAttribute(137, "class", "px-4 py-3 text-right font-semibold text-red-600");
                        builder.AddContent(138, FormatCurrency(record.OutstandingBalance));
                        builder.CloseElement();
                        builder.OpenElement(139, "td");
                        builder.AddAttribute(140, "class", "px-4 py-3");
                        builder.OpenElement(141, "span");
                        var agingColor = record.AgingBucket == "Current" ? "bg-green-100 text-green-800" :
                                        record.AgingBucket == "31-60 Days" ? "bg-yellow-100 text-yellow-800" :
                                        record.AgingBucket == "61-90 Days" ? "bg-orange-100 text-orange-800" :
                                        "bg-red-100 text-red-800";
                        builder.AddAttribute(142, "class", $"inline-flex rounded-full px-2 py-1 text-xs font-medium {agingColor}");
                        builder.AddContent(143, record.AgingBucket);
                        builder.CloseElement();
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                }
                break;

            case "IncomeStatement":
                builder.OpenElement(200, "div");
                builder.AddAttribute(201, "class", "space-y-6");

                // Revenue Section
                builder.OpenElement(202, "div");
                builder.AddAttribute(203, "class", "rounded-lg border border-green-200 bg-white");
                builder.OpenElement(204, "div");
                builder.AddAttribute(205, "class", "bg-green-50 px-4 py-3 border-b border-green-200");
                builder.OpenElement(206, "h3");
                builder.AddAttribute(207, "class", "text-sm font-bold text-green-800");
                builder.AddContent(208, "Revenue (Payments)");
                builder.CloseElement(); // h3
                builder.CloseElement(); // header div
                
                if (incomeStatementPayments != null && incomeStatementPayments.Any())
                {
                    builder.OpenElement(209, "div");
                    builder.AddAttribute(210, "class", "overflow-x-auto overflow-y-auto max-h-[420px]");
                    builder.OpenElement(211, "table");
                    builder.AddAttribute(212, "class", "w-full border-collapse text-sm");
                    builder.OpenElement(213, "thead");
                    builder.AddAttribute(214, "class", "sticky top-0 bg-gray-50 z-10");
                    builder.OpenElement(215, "tr");
                    builder.AddAttribute(216, "class", "border-b-2 border-gray-300 bg-gray-50");
                    builder.OpenElement(217, "th");
                    builder.AddAttribute(218, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(219, "Date");
                    builder.CloseElement();
                    builder.OpenElement(220, "th");
                    builder.AddAttribute(221, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(222, "Student");
                    builder.CloseElement();
                    builder.OpenElement(223, "th");
                    builder.AddAttribute(224, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(225, "Grade");
                    builder.CloseElement();
                    builder.OpenElement(226, "th");
                    builder.AddAttribute(227, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(228, "Amount");
                    builder.CloseElement();
                    builder.OpenElement(229, "th");
                    builder.AddAttribute(230, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(231, "Method");
                    builder.CloseElement();
                    builder.OpenElement(232, "th");
                    builder.AddAttribute(233, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(234, "OR Number");
                    builder.CloseElement();
                    builder.CloseElement(); // tr
                    builder.CloseElement(); // thead
                    builder.OpenElement(234, "tbody");
                    foreach (var payment in incomeStatementPayments.OrderByDescending(p => p.PaymentDate))
                    {
                        builder.OpenElement(235, "tr");
                        builder.AddAttribute(236, "class", "border-b border-gray-100 hover:bg-gray-50");
                        builder.OpenElement(237, "td");
                        builder.AddAttribute(238, "class", "px-4 py-3 text-gray-700");
                        builder.AddContent(239, payment.PaymentDate.ToString("MMM dd, yyyy"));
                        builder.CloseElement();
                        builder.OpenElement(240, "td");
                        builder.AddAttribute(241, "class", "px-4 py-3 font-medium text-gray-800");
                        builder.AddContent(242, payment.StudentName);
                        builder.CloseElement();
                        builder.OpenElement(243, "td");
                        builder.AddAttribute(244, "class", "px-4 py-3 text-gray-600");
                        builder.AddContent(245, payment.GradeLevel);
                        builder.CloseElement();
                        builder.OpenElement(246, "td");
                        builder.AddAttribute(247, "class", "px-4 py-3 text-right font-semibold text-green-600");
                        builder.AddContent(248, FormatCurrency(payment.Amount));
                        builder.CloseElement();
                        builder.OpenElement(249, "td");
                        builder.AddAttribute(250, "class", "px-4 py-3 text-gray-600");
                        builder.AddContent(251, payment.PaymentMethod);
                        builder.CloseElement();
                        builder.OpenElement(252, "td");
                        builder.AddAttribute(253, "class", "px-4 py-3 text-gray-600");
                        builder.AddContent(254, payment.OrNumber);
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    builder.CloseElement(); // tbody
                    builder.CloseElement(); // table
                    builder.CloseElement(); // overflow div
                }
                else
                {
                    builder.OpenElement(255, "div");
                    builder.AddAttribute(256, "class", "p-4 text-center");
                    builder.OpenElement(257, "p");
                    builder.AddAttribute(258, "class", "text-sm text-gray-500");
                    builder.AddContent(259, "No revenue transactions found.");
                    builder.CloseElement(); // p
                    builder.CloseElement(); // div
                }
                builder.CloseElement(); // Revenue Section div

                // Expenses Section
                builder.OpenElement(260, "div");
                builder.AddAttribute(261, "class", "rounded-lg border border-red-200 bg-white");
                builder.OpenElement(262, "div");
                builder.AddAttribute(263, "class", "bg-red-50 px-4 py-3 border-b border-red-200");
                builder.OpenElement(264, "h3");
                builder.AddAttribute(265, "class", "text-sm font-bold text-red-800");
                builder.AddContent(266, "Expenses");
                builder.CloseElement(); // h3
                builder.CloseElement(); // header div
                
                if (incomeStatementExpenses != null && incomeStatementExpenses.Any())
                {
                    builder.OpenElement(267, "div");
                    builder.AddAttribute(268, "class", "overflow-x-auto overflow-y-auto max-h-[420px]");
                    builder.OpenElement(269, "table");
                    builder.AddAttribute(270, "class", "w-full border-collapse text-sm");
                    builder.OpenElement(271, "thead");
                    builder.AddAttribute(272, "class", "sticky top-0 bg-gray-50 z-10");
                    builder.OpenElement(273, "tr");
                    builder.AddAttribute(274, "class", "border-b-2 border-gray-300 bg-gray-50");
                    builder.OpenElement(275, "th");
                    builder.AddAttribute(276, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(277, "Date");
                    builder.CloseElement();
                    builder.OpenElement(278, "th");
                    builder.AddAttribute(279, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(280, "Description");
                    builder.CloseElement();
                    builder.OpenElement(281, "th");
                    builder.AddAttribute(282, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(283, "Category");
                    builder.CloseElement();
                    builder.OpenElement(284, "th");
                    builder.AddAttribute(285, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(286, "Amount");
                    builder.CloseElement();
                    builder.OpenElement(287, "th");
                    builder.AddAttribute(288, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(289, "Payment Method");
                    builder.CloseElement();
                    builder.CloseElement(); // tr
                    builder.CloseElement(); // thead
                    builder.OpenElement(289, "tbody");
                    foreach (var expense in incomeStatementExpenses)
                    {
                        builder.OpenElement(290, "tr");
                        builder.AddAttribute(291, "class", "border-b border-gray-100 hover:bg-gray-50");
                        builder.OpenElement(292, "td");
                        builder.AddAttribute(293, "class", "px-4 py-3 text-gray-700");
                        builder.AddContent(294, expense.ExpenseDate.ToString("MMM dd, yyyy"));
                        builder.CloseElement();
                        builder.OpenElement(295, "td");
                        builder.AddAttribute(296, "class", "px-4 py-3 font-medium text-gray-800");
                        builder.AddContent(297, expense.Description ?? "N/A");
                        builder.CloseElement();
                        builder.OpenElement(298, "td");
                        builder.AddAttribute(299, "class", "px-4 py-3 text-gray-600");
                        builder.AddContent(300, expense.Category ?? "Uncategorized");
                        builder.CloseElement();
                        builder.OpenElement(301, "td");
                        builder.AddAttribute(302, "class", "px-4 py-3 text-right font-semibold text-red-600");
                        builder.AddContent(303, FormatCurrency(expense.Amount));
                        builder.CloseElement();
                        builder.OpenElement(304, "td");
                        builder.AddAttribute(305, "class", "px-4 py-3 text-gray-600");
                        builder.AddContent(306, expense.PaymentMethod ?? "Cash");
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    builder.CloseElement(); // tbody
                    builder.CloseElement(); // table
                    builder.CloseElement(); // overflow div
                }
                else
                {
                    builder.OpenElement(307, "div");
                    builder.AddAttribute(308, "class", "p-4 text-center");
                    builder.OpenElement(309, "p");
                    builder.AddAttribute(310, "class", "text-sm text-gray-500");
                    builder.AddContent(311, "No expense transactions found.");
                    builder.CloseElement(); // p
                    builder.CloseElement(); // div
                }
                builder.CloseElement(); // Expenses Section div
                builder.CloseElement(); // main container div (200)
                break;

            case "CashFlow":
                builder.OpenElement(400, "div");
                builder.AddAttribute(401, "class", "space-y-6");

                // Cash Inflows Section
                builder.OpenElement(402, "div");
                builder.AddAttribute(403, "class", "rounded-lg border border-green-200 bg-white");
                builder.OpenElement(404, "div");
                builder.AddAttribute(405, "class", "bg-green-50 px-4 py-3 border-b border-green-200");
                builder.OpenElement(406, "h3");
                builder.AddAttribute(407, "class", "text-sm font-bold text-green-800");
                builder.AddContent(408, "Cash Inflows (Payments)");
                builder.CloseElement(); // h3
                builder.CloseElement(); // header div
                
                if (cashFlowInflows != null && cashFlowInflows.Any())
                {
                    builder.OpenElement(409, "div");
                    builder.AddAttribute(410, "class", "overflow-x-auto overflow-y-auto max-h-[420px]");
                    builder.OpenElement(411, "table");
                    builder.AddAttribute(412, "class", "w-full border-collapse text-sm");
                    builder.OpenElement(413, "thead");
                    builder.AddAttribute(414, "class", "sticky top-0 bg-gray-50 z-10");
                    builder.OpenElement(415, "tr");
                    builder.AddAttribute(416, "class", "border-b-2 border-gray-300 bg-gray-50");
                    builder.OpenElement(417, "th");
                    builder.AddAttribute(418, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(419, "Date");
                    builder.CloseElement();
                    builder.OpenElement(420, "th");
                    builder.AddAttribute(421, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(422, "Student");
                    builder.CloseElement();
                    builder.OpenElement(423, "th");
                    builder.AddAttribute(424, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(425, "Grade");
                    builder.CloseElement();
                    builder.OpenElement(426, "th");
                    builder.AddAttribute(427, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(428, "Amount");
                    builder.CloseElement();
                    builder.OpenElement(429, "th");
                    builder.AddAttribute(430, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(431, "Method");
                    builder.CloseElement();
                    builder.OpenElement(432, "th");
                    builder.AddAttribute(433, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(434, "OR Number");
                    builder.CloseElement();
                    builder.CloseElement(); // tr
                    builder.CloseElement(); // thead
                    builder.OpenElement(434, "tbody");
                    foreach (var payment in cashFlowInflows.OrderByDescending(p => p.PaymentDate))
                    {
                        builder.OpenElement(435, "tr");
                        builder.AddAttribute(436, "class", "border-b border-gray-100 hover:bg-gray-50");
                        builder.OpenElement(437, "td");
                        builder.AddAttribute(438, "class", "px-4 py-3 text-gray-700");
                        builder.AddContent(439, payment.PaymentDate.ToString("MMM dd, yyyy"));
                        builder.CloseElement();
                        builder.OpenElement(440, "td");
                        builder.AddAttribute(441, "class", "px-4 py-3 font-medium text-gray-800");
                        builder.AddContent(442, payment.StudentName);
                        builder.CloseElement();
                        builder.OpenElement(443, "td");
                        builder.AddAttribute(444, "class", "px-4 py-3 text-gray-600");
                        builder.AddContent(445, payment.GradeLevel);
                        builder.CloseElement();
                        builder.OpenElement(446, "td");
                        builder.AddAttribute(447, "class", "px-4 py-3 text-right font-semibold text-green-600");
                        builder.AddContent(448, FormatCurrency(payment.Amount));
                        builder.CloseElement();
                        builder.OpenElement(449, "td");
                        builder.AddAttribute(450, "class", "px-4 py-3 text-gray-600");
                        builder.AddContent(451, payment.PaymentMethod);
                        builder.CloseElement();
                        builder.OpenElement(452, "td");
                        builder.AddAttribute(453, "class", "px-4 py-3 text-gray-600");
                        builder.AddContent(454, payment.OrNumber);
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    builder.CloseElement(); // tbody
                    builder.CloseElement(); // table
                    builder.CloseElement(); // overflow div
                }
                else
                {
                    builder.OpenElement(455, "div");
                    builder.AddAttribute(456, "class", "p-4 text-center");
                    builder.OpenElement(457, "p");
                    builder.AddAttribute(458, "class", "text-sm text-gray-500");
                    builder.AddContent(459, "No cash inflow transactions found.");
                    builder.CloseElement(); // p
                    builder.CloseElement(); // div
                }
                builder.CloseElement(); // Cash Inflows Section div

                // Cash Outflows Section
                builder.OpenElement(460, "div");
                builder.AddAttribute(461, "class", "rounded-lg border border-red-200 bg-white");
                builder.OpenElement(462, "div");
                builder.AddAttribute(463, "class", "bg-red-50 px-4 py-3 border-b border-red-200");
                builder.OpenElement(464, "h3");
                builder.AddAttribute(465, "class", "text-sm font-bold text-red-800");
                builder.AddContent(466, "Cash Outflows (Expenses)");
                builder.CloseElement(); // h3
                builder.CloseElement(); // header div
                
                if (cashFlowOutflows != null && cashFlowOutflows.Any())
                {
                    builder.OpenElement(467, "div");
                    builder.AddAttribute(468, "class", "overflow-x-auto overflow-y-auto max-h-[420px]");
                    builder.OpenElement(469, "table");
                    builder.AddAttribute(470, "class", "w-full border-collapse text-sm");
                    builder.OpenElement(471, "thead");
                    builder.AddAttribute(472, "class", "sticky top-0 bg-gray-50 z-10");
                    builder.OpenElement(473, "tr");
                    builder.AddAttribute(474, "class", "border-b-2 border-gray-300 bg-gray-50");
                    builder.OpenElement(475, "th");
                    builder.AddAttribute(476, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(477, "Date");
                    builder.CloseElement();
                    builder.OpenElement(478, "th");
                    builder.AddAttribute(479, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(480, "Description");
                    builder.CloseElement();
                    builder.OpenElement(481, "th");
                    builder.AddAttribute(482, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(483, "Category");
                    builder.CloseElement();
                    builder.OpenElement(484, "th");
                    builder.AddAttribute(485, "class", "px-4 py-3 text-right text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(486, "Amount");
                    builder.CloseElement();
                    builder.OpenElement(487, "th");
                    builder.AddAttribute(488, "class", "px-4 py-3 text-left text-xs font-semibold text-gray-700 bg-gray-50");
                    builder.AddContent(489, "Payment Method");
                    builder.CloseElement();
                    builder.CloseElement(); // tr
                    builder.CloseElement(); // thead
                    builder.OpenElement(489, "tbody");
                    foreach (var expense in cashFlowOutflows)
                    {
                        builder.OpenElement(490, "tr");
                        builder.AddAttribute(491, "class", "border-b border-gray-100 hover:bg-gray-50");
                        builder.OpenElement(492, "td");
                        builder.AddAttribute(493, "class", "px-4 py-3 text-gray-700");
                        builder.AddContent(494, expense.ExpenseDate.ToString("MMM dd, yyyy"));
                        builder.CloseElement();
                        builder.OpenElement(495, "td");
                        builder.AddAttribute(496, "class", "px-4 py-3 font-medium text-gray-800");
                        builder.AddContent(497, expense.Description ?? "N/A");
                        builder.CloseElement();
                        builder.OpenElement(498, "td");
                        builder.AddAttribute(499, "class", "px-4 py-3 text-gray-600");
                        builder.AddContent(500, expense.Category ?? "Uncategorized");
                        builder.CloseElement();
                        builder.OpenElement(501, "td");
                        builder.AddAttribute(502, "class", "px-4 py-3 text-right font-semibold text-red-600");
                        builder.AddContent(503, FormatCurrency(expense.Amount));
                        builder.CloseElement();
                        builder.OpenElement(504, "td");
                        builder.AddAttribute(505, "class", "px-4 py-3 text-gray-600");
                        builder.AddContent(506, expense.PaymentMethod ?? "Cash");
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    builder.CloseElement(); // tbody
                    builder.CloseElement(); // table
                    builder.CloseElement(); // overflow div
                }
                else
                {
                    builder.OpenElement(507, "div");
                    builder.AddAttribute(508, "class", "p-4 text-center");
                    builder.OpenElement(509, "p");
                    builder.AddAttribute(510, "class", "text-sm text-gray-500");
                    builder.AddContent(511, "No cash outflow transactions found.");
                    builder.CloseElement(); // p
                    builder.CloseElement(); // div
                }
                builder.CloseElement(); // Cash Outflows Section div
                builder.CloseElement(); // main container div (400)
                break;

            default:
                builder.OpenElement(144, "div");
                builder.AddAttribute(145, "class", "rounded-lg border border-gray-200 bg-gray-50 p-4 text-center");
                builder.OpenElement(146, "p");
                builder.AddAttribute(147, "class", "text-sm text-gray-600");
                builder.AddContent(148, "Detailed transaction list will be displayed here.");
                builder.CloseElement();
                builder.CloseElement();
                break;
        }

        builder.CloseElement();
    }

    private async Task<ExpenseAnalysisReport> GetExpenseAnalysisAsync(DateTime fromDate, DateTime toDate)
    {
        return await AccountingReportService.GetExpenseAnalysisAsync(fromDate, toDate);
    }

    private async Task<List<RevenueBreakdownItem>> GetRevenueBreakdownAsync(DateTime fromDate, DateTime toDate)
    {
        // Get all payments in the period with student information
        var payments = await DbContext.StudentPayments
            .Include(p => p.Student)
            .Where(p => p.CreatedAt >= fromDate && p.CreatedAt <= toDate)
            .ToListAsync();

        // Get fee structures for all grade levels with grade level names
        var fees = await DbContext.Fees
            .Where(f => f.IsActive)
            .Include(f => f.GradeLevel)
            .ToListAsync();

        var breakdown = new List<RevenueBreakdownItem>();
        decimal totalTuition = 0;
        decimal totalMisc = 0;
        decimal totalOther = 0;

        foreach (var payment in payments)
        {
            if (payment.Student == null || string.IsNullOrEmpty(payment.Student.GradeLevel)) continue;

            // Find the fee structure for this student's grade level by matching grade level name
            var fee = fees.FirstOrDefault(f => 
                f.GradeLevel != null && 
                f.GradeLevel.GradeLevelName == payment.Student.GradeLevel);
            
            if (fee == null) continue;

            decimal totalFee = fee.TuitionFee + fee.MiscFee + fee.OtherFee;
            if (totalFee == 0) continue;

            // Calculate proportional allocation of payment to each fee category
            decimal tuitionRatio = fee.TuitionFee / totalFee;
            decimal miscRatio = fee.MiscFee / totalFee;
            decimal otherRatio = fee.OtherFee / totalFee;

            totalTuition += payment.Amount * tuitionRatio;
            totalMisc += payment.Amount * miscRatio;
            totalOther += payment.Amount * otherRatio;
        }

        // Add breakdown items (ERP Standard: Revenue by Source)
        if (totalTuition > 0)
        {
            breakdown.Add(new RevenueBreakdownItem
            {
                PaymentMethod = "Tuition Fees",
                Amount = totalTuition,
                Count = 0
            });
        }

        if (totalMisc > 0)
        {
            breakdown.Add(new RevenueBreakdownItem
            {
                PaymentMethod = "Miscellaneous Fees",
                Amount = totalMisc,
                Count = 0
            });
        }

        if (totalOther > 0)
        {
            breakdown.Add(new RevenueBreakdownItem
            {
                PaymentMethod = "Other Fees",
                Amount = totalOther,
                Count = 0
            });
        }

        return breakdown.OrderByDescending(r => r.Amount).ToList();
    }

    private async Task<GeneralLedgerData> GetGeneralLedgerAsync(DateTime fromDate, DateTime toDate)
    {
        var ledger = new GeneralLedgerData();
        
        // Try to get from Journal Entries (ERP approach) - Double-entry bookkeeping
        // Include all journal entries with Posted status within the date range
        // Use date-only comparison to ensure we capture entries for the full day
        var fromDateOnly = fromDate.Date;
        var toDateOnly = toDate.Date.AddDays(1).AddTicks(-1); // End of day
        
        var journalEntryLines = await DbContext.JournalEntryLines
            .Include(l => l.JournalEntry)
                .ThenInclude(je => je.CreatedByUser)
            .Include(l => l.Account)
            .Where(l => l.JournalEntry.EntryDate >= fromDateOnly && 
                       l.JournalEntry.EntryDate <= toDateOnly &&
                       l.JournalEntry.Status == "Posted")
            .OrderBy(l => l.JournalEntry.EntryDate)
            .ThenBy(l => l.JournalEntry.EntryNumber)
            .ThenBy(l => l.LineNumber)
            .ToListAsync();

        // Check if we have payroll transactions that might not have journal entries yet
        // This can happen if journal entries weren't created during approval
        // Use date-only comparison to ensure we capture transactions for the full day
        var payrollInDateRange = await DbContext.PayrollTransactions
            .Where(pt => pt.Status == "Paid" &&
                       ((pt.PaymentDate.HasValue && pt.PaymentDate.Value.Date >= fromDateOnly && pt.PaymentDate.Value.Date <= toDateOnly) ||
                        (!pt.PaymentDate.HasValue && pt.CreatedAt.Date >= fromDateOnly && pt.CreatedAt.Date <= toDateOnly)))
            .Select(pt => pt.TransactionId)
            .ToListAsync();

        // Check if journal entries exist for these payroll transactions
        // For batch payroll, the ReferenceId is set to the first transaction ID in the batch
        // So we check if any transaction ID in our list has a corresponding journal entry
        var payrollWithJournalEntries = new List<int>();
        if (payrollInDateRange.Any())
        {
            // Get all payroll journal entries in the date range
            var payrollJournalEntries = await DbContext.JournalEntries
                .Where(je => je.ReferenceType == "Payroll" && 
                            je.Status == "Posted" &&
                            je.EntryDate >= fromDateOnly && 
                            je.EntryDate <= toDateOnly)
                .Select(je => je.ReferenceId ?? 0)
                .ToListAsync();
            
            // For batch payroll, the journal entry uses the first transaction ID as ReferenceId
            // So we need to check if the first transaction of each batch has a journal entry
            // If it does, all transactions in that batch are covered by that single journal entry
            var batchPayrollTransactions = await DbContext.PayrollTransactions
                .Where(pt => payrollInDateRange.Contains(pt.TransactionId) && pt.BatchTimestamp.HasValue)
                .ToListAsync();
            
            // Group by batch and check if the first transaction (which is used as ReferenceId) has a journal entry
            var batchGroups = batchPayrollTransactions
                .Where(pt => pt.BatchTimestamp.HasValue)
                .GroupBy(pt => pt.BatchTimestamp!.Value)
                .ToList();
            
            foreach (var batchGroup in batchGroups)
            {
                var batchTransactionIds = batchGroup.Select(pt => pt.TransactionId).OrderBy(id => id).ToList();
                var firstTransactionId = batchTransactionIds.First();
                
                // If the first transaction (used as ReferenceId) has a journal entry, all transactions in batch are covered
                if (payrollJournalEntries.Contains(firstTransactionId))
                {
                    payrollWithJournalEntries.AddRange(batchTransactionIds);
                }
            }
            
            // For individual (non-batch) payroll, check directly
            var individualPayrollIds = payrollInDateRange
                .Except(batchPayrollTransactions.Select(pt => pt.TransactionId))
                .ToList();
            
            foreach (var transId in individualPayrollIds)
            {
                if (payrollJournalEntries.Contains(transId))
                {
                    payrollWithJournalEntries.Add(transId);
                }
            }
        }

        // If we have payroll transactions without journal entries, we'll include them in fallback
        var hasPayrollWithoutJournalEntries = payrollInDateRange.Any(ptId => !payrollWithJournalEntries.Contains(ptId));

        // If we have journal entries OR if we have payroll without journal entries, use journal entries first
        // Then supplement with payroll transactions that don't have journal entries
        if (journalEntryLines.Any() || hasPayrollWithoutJournalEntries)
        {
            // Use journal entries - proper double-entry bookkeeping
            var accountBalances = new Dictionary<int, decimal>(); // AccountId -> Running Balance

            foreach (var line in journalEntryLines)
            {
                // Calculate running balance per account
                if (!accountBalances.ContainsKey(line.AccountId))
                {
                    accountBalances[line.AccountId] = 0;
                }

                // Update balance based on account type and normal balance
                if (line.Account != null)
                {
                    if (line.Account.NormalBalance == "Debit")
                    {
                        // Assets, Expenses: Debit increases, Credit decreases
                        accountBalances[line.AccountId] += line.DebitAmount - line.CreditAmount;
                    }
                    else
                    {
                        // Liabilities, Equity, Revenue: Credit increases, Debit decreases
                        accountBalances[line.AccountId] += line.CreditAmount - line.DebitAmount;
                    }
                }

                // Determine transaction type from reference type
                string transactionType = line.JournalEntry.ReferenceType switch
                {
                    "Payment" => "Payment",
                    "Expense" => "Expense",
                    "Payroll" => "Payroll",
                    _ => "Journal Entry"
                };

                ledger.Entries.Add(new LedgerEntry
                {
                    Date = line.JournalEntry.EntryDate,
                    EntryNumber = line.JournalEntry.EntryNumber,
                    AccountCode = line.Account?.AccountCode ?? "N/A",
                    AccountName = line.Account?.AccountName ?? "Unknown Account",
                    Description = line.Description ?? line.JournalEntry.Description ?? "No description",
                    Type = transactionType,
                    Debit = line.DebitAmount,
                    Credit = line.CreditAmount,
                    Balance = accountBalances[line.AccountId]
                });
            }
        }
        else
        {
            // Fallback to old method (backward compatibility) - Single-entry
            // This includes payroll transactions that may not have journal entries yet
            decimal runningBalance = 0;

            // Get all payments (Credits - Revenue)
            var payments = await DbContext.StudentPayments
                .Where(p => p.CreatedAt >= fromDate && p.CreatedAt <= toDate)
                .OrderBy(p => p.CreatedAt)
                .ToListAsync();

            foreach (var payment in payments)
            {
                runningBalance += payment.Amount;
                ledger.Entries.Add(new LedgerEntry
                {
                    Date = payment.CreatedAt,
                    EntryNumber = $"PMT-{payment.PaymentId}",
                    AccountCode = "4000",
                    AccountName = "Tuition Fee Revenue",
                    Description = $"Payment from Student {payment.StudentId}",
                    Type = "Payment",
                    Credit = payment.Amount,
                    Debit = 0,
                    Balance = runningBalance
                });
            }

            // Get all expenses (Debits - Expenses)
            var expenses = await DbContext.Expenses
                .Where(e => e.ExpenseDate >= fromDate && e.ExpenseDate <= toDate && e.Status == "Approved")
                .OrderBy(e => e.ExpenseDate)
                .ToListAsync();

            foreach (var expense in expenses)
            {
                runningBalance -= expense.Amount;
                ledger.Entries.Add(new LedgerEntry
                {
                    Date = expense.ExpenseDate,
                    EntryNumber = $"EXP-{expense.ExpenseId}",
                    AccountCode = "5100",
                    AccountName = expense.Category ?? "Other Operating Expenses",
                    Description = $"{expense.Category}: {expense.Description}",
                    Type = "Expense",
                    Credit = 0,
                    Debit = expense.Amount,
                    Balance = runningBalance
                });
            }

            // Get all payroll transactions (Paid status) - Include in fallback
            // Use PaymentDate if available, otherwise CreatedAt
            var payrollTransactions = await DbContext.PayrollTransactions
                .Include(pt => pt.User)
                .Where(pt => pt.Status == "Paid" &&
                           ((pt.PaymentDate.HasValue && pt.PaymentDate.Value >= fromDate && pt.PaymentDate.Value <= toDate) ||
                            (!pt.PaymentDate.HasValue && pt.CreatedAt >= fromDate && pt.CreatedAt <= toDate)))
                .OrderBy(pt => pt.PaymentDate ?? pt.CreatedAt)
                .ToListAsync();

            // Group payroll by batch (same BatchTimestamp) to create consolidated entries
            var payrollBatches = payrollTransactions
                .Where(pt => pt.BatchTimestamp.HasValue)
                .GroupBy(pt => pt.BatchTimestamp!.Value)
                .ToList();

            var individualPayroll = payrollTransactions
                .Where(pt => !pt.BatchTimestamp.HasValue)
                .ToList();

            // Process batch payroll transactions
            foreach (var batch in payrollBatches)
            {
                var batchTransactions = batch.ToList();
                var firstTransaction = batchTransactions.First();
                var transactionDate = firstTransaction.PaymentDate ?? firstTransaction.CreatedAt;
                
                // Aggregate batch totals
                var totalGrossSalary = batchTransactions.Sum(pt => pt.GrossSalary);
                var totalDeductions = batchTransactions.Sum(pt => pt.TotalDeductions);
                var totalNetSalary = batchTransactions.Sum(pt => pt.NetSalary);
                var totalCompanyContribution = batchTransactions.Sum(pt => pt.TotalCompanyContribution);
                var employeeCount = batchTransactions.Count;

                // Salaries Expense (Debit)
                runningBalance -= totalGrossSalary;
                ledger.Entries.Add(new LedgerEntry
                {
                    Date = transactionDate,
                    EntryNumber = $"PRL-BATCH-{firstTransaction.TransactionId}",
                    AccountCode = "5000",
                    AccountName = "Salaries Expense",
                    Description = $"Batch Payroll - {employeeCount} employee(s) - {firstTransaction.PayPeriod}",
                    Type = "Payroll",
                    Credit = 0,
                    Debit = totalGrossSalary,
                    Balance = runningBalance
                });

                // Payroll Tax Expense (Debit) - if deductions exist
                if (totalDeductions > 0)
                {
                    runningBalance -= totalDeductions;
                    ledger.Entries.Add(new LedgerEntry
                    {
                        Date = transactionDate,
                        EntryNumber = $"PRL-BATCH-{firstTransaction.TransactionId}",
                        AccountCode = "5100",
                        AccountName = "Other Expenses",
                        Description = $"Payroll deductions (SSS, PhilHealth, Pag-IBIG, Tax) - {employeeCount} employee(s)",
                        Type = "Payroll",
                        Credit = 0,
                        Debit = totalDeductions,
                        Balance = runningBalance
                    });
                }

                // Cash (Credit) - Net Pay
                runningBalance += totalNetSalary;
                ledger.Entries.Add(new LedgerEntry
                {
                    Date = transactionDate,
                    EntryNumber = $"PRL-BATCH-{firstTransaction.TransactionId}",
                    AccountCode = "1000",
                    AccountName = "Cash",
                    Description = $"Net pay payment - {employeeCount} employee(s)",
                    Type = "Payroll",
                    Credit = totalNetSalary,
                    Debit = 0,
                    Balance = runningBalance
                });

                // Accrued Payroll Taxes (Credit) - Company Contributions + Employee Deductions
                if (totalCompanyContribution > 0 || totalDeductions > 0)
                {
                    var totalAccrued = totalCompanyContribution + totalDeductions;
                    runningBalance += totalAccrued;
                    ledger.Entries.Add(new LedgerEntry
                    {
                        Date = transactionDate,
                        EntryNumber = $"PRL-BATCH-{firstTransaction.TransactionId}",
                        AccountCode = "2100",
                        AccountName = "Accrued Payroll Taxes",
                        Description = $"Company contributions and employee deductions - {employeeCount} employee(s)",
                        Type = "Payroll",
                        Credit = totalAccrued,
                        Debit = 0,
                        Balance = runningBalance
                    });
                }
            }

            // Process individual payroll transactions (not part of a batch)
            foreach (var payroll in individualPayroll)
            {
                var transactionDate = payroll.PaymentDate ?? payroll.CreatedAt;

                // Salaries Expense (Debit)
                runningBalance -= payroll.GrossSalary;
                ledger.Entries.Add(new LedgerEntry
                {
                    Date = transactionDate,
                    EntryNumber = $"PRL-{payroll.TransactionId}",
                    AccountCode = "5000",
                    AccountName = "Salaries Expense",
                    Description = $"Gross salary for {payroll.PayPeriod}",
                    Type = "Payroll",
                    Credit = 0,
                    Debit = payroll.GrossSalary,
                    Balance = runningBalance
                });

                // Payroll Tax Expense (Debit) - if deductions exist
                if (payroll.TotalDeductions > 0)
                {
                    runningBalance -= payroll.TotalDeductions;
                    ledger.Entries.Add(new LedgerEntry
                    {
                        Date = transactionDate,
                        EntryNumber = $"PRL-{payroll.TransactionId}",
                        AccountCode = "5100",
                        AccountName = "Other Expenses",
                        Description = $"Payroll deductions (SSS, PhilHealth, Pag-IBIG, Tax)",
                        Type = "Payroll",
                        Credit = 0,
                        Debit = payroll.TotalDeductions,
                        Balance = runningBalance
                    });
                }

                // Cash (Credit) - Net Pay
                runningBalance += payroll.NetSalary;
                ledger.Entries.Add(new LedgerEntry
                {
                    Date = transactionDate,
                    EntryNumber = $"PRL-{payroll.TransactionId}",
                    AccountCode = "1000",
                    AccountName = "Cash",
                    Description = $"Net pay payment",
                    Type = "Payroll",
                    Credit = payroll.NetSalary,
                    Debit = 0,
                    Balance = runningBalance
                });

                // Accrued Payroll Taxes (Credit) - Company Contributions + Employee Deductions
                if (payroll.TotalCompanyContribution > 0 || payroll.TotalDeductions > 0)
                {
                    var totalAccrued = payroll.TotalCompanyContribution + payroll.TotalDeductions;
                    runningBalance += totalAccrued;
                    ledger.Entries.Add(new LedgerEntry
                    {
                        Date = transactionDate,
                        EntryNumber = $"PRL-{payroll.TransactionId}",
                        AccountCode = "2100",
                        AccountName = "Accrued Payroll Taxes",
                        Description = $"Company contributions and employee deductions",
                        Type = "Payroll",
                        Credit = totalAccrued,
                        Debit = 0,
                        Balance = runningBalance
                    });
                }
            }
        }

        // Sort by date, then by entry number, then by line number
        ledger.Entries = ledger.Entries
            .OrderBy(e => e.Date)
            .ThenBy(e => e.EntryNumber)
            .ToList();

        return ledger;
    }

    private bool HasReportData()
    {
        return activeReport switch
        {
            "IncomeStatement" => incomeStatement != null,
            "CashFlow" => cashFlowReport != null,
            "AccountsReceivable" => arRecords != null && arRecords.Any(),
            "PaymentHistory" => paymentHistory != null && paymentHistory.Any(),
            "ExpenseAnalysis" => expenseAnalysis != null,
            "GeneralLedger" => generalLedger != null && generalLedger.Entries.Any(),
            "BalanceSheet" => balanceSheetReport != null,
            _ => false
        };
    }

    private async Task ExportToPdf()
    {
        // Check if report has been generated first
        if (!reportGenerated)
        {
            ShowToast("Please generate a report first before exporting.", ToastType.Error);
            return;
        }

        // Validate date range
        if (toDate < fromDate)
        {
            ShowToast("Invalid date range. 'To Date' must be greater than or equal to 'From Date'.", ToastType.Error);
            return;
        }

        if (isExporting) return;

        isExporting = true;
        StateHasChanged();

        try
        {
            // Check if report data exists (should exist if reportGenerated is true, but double-check)
            if (!HasReportData())
            {
                // Clear EF Core change tracker to ensure fresh data is loaded
                DbContext.ChangeTracker.Clear();
                
                // Small delay to ensure any pending database changes are committed
                await Task.Delay(100);
                
                // Fetch data based on active report type
                switch (activeReport)
                {
                    case "IncomeStatement":
                        incomeStatement = await AccountingReportService.GetIncomeStatementAsync(fromDate, toDate);
                        revenueBreakdown = await GetRevenueBreakdownAsync(fromDate, toDate);
                        incomeStatementPayments = await AccountingReportService.GetPaymentHistoryAsync(fromDate, toDate);
                        incomeStatementExpenses = await DbContext.Expenses
                            .Where(e => e.ExpenseDate >= fromDate && e.ExpenseDate <= toDate && e.Status == "Approved")
                            .OrderByDescending(e => e.ExpenseDate)
                            .ToListAsync();
                        break;
                    case "CashFlow":
                        cashFlowReport = await AccountingReportService.GetCashFlowReportAsync(fromDate, toDate);
                        cashFlowInflows = await AccountingReportService.GetPaymentHistoryAsync(fromDate, toDate);
                        cashFlowOutflows = await DbContext.Expenses
                            .Where(e => e.ExpenseDate >= fromDate && e.ExpenseDate <= toDate && e.Status == "Approved")
                            .OrderByDescending(e => e.ExpenseDate)
                            .ToListAsync();
                        break;
                    case "AccountsReceivable":
                        arRecords = await AccountingReportService.GetAccountsReceivableAsync(toDate);
                        break;
                    case "PaymentHistory":
                        paymentHistory = await AccountingReportService.GetPaymentHistoryAsync(fromDate, toDate);
                        break;
                    case "ExpenseAnalysis":
                        expenseAnalysis = await GetExpenseAnalysisAsync(fromDate, toDate);
                        break;
                    case "GeneralLedger":
                        generalLedger = await GetGeneralLedgerAsync(fromDate, toDate);
                        break;
                    case "BalanceSheet":
                        balanceSheetReport = await AccountingReportService.GetBalanceSheetAsync(toDate);
                        break;
                }
            }

            // Get current user for "Generated By"
            var currentUser = AuthService.CurrentUser;
            var generatedBy = currentUser != null 
                ? $"{currentUser.first_name} {currentUser.last_name}".Trim()
                : "System";

            byte[] pdfBytes;
            string fileName;

            switch (activeReport)
            {
                case "IncomeStatement":
                    if (incomeStatement == null)
                    {
                        ShowToast("No income statement data to export.", ToastType.Error);
                        return;
                    }
                    pdfBytes = await PdfGenerator.GenerateIncomeStatementPdfAsync(incomeStatement, fromDate, toDate, generatedBy);
                    fileName = $"Income_Statement_{fromDate:yyyyMMdd}_{toDate:yyyyMMdd}.pdf";
                    break;

                case "CashFlow":
                    if (cashFlowReport == null)
                    {
                        ShowToast("No cash flow data to export.", ToastType.Error);
                        return;
                    }
                    pdfBytes = await PdfGenerator.GenerateCashFlowPdfAsync(cashFlowReport, fromDate, toDate, generatedBy);
                    fileName = $"Cash_Flow_Statement_{fromDate:yyyyMMdd}_{toDate:yyyyMMdd}.pdf";
                    break;

                case "AccountsReceivable":
                    if (arRecords == null || !arRecords.Any())
                    {
                        ShowToast("No accounts receivable data to export.", ToastType.Error);
                        return;
                    }
                    pdfBytes = await PdfGenerator.GenerateAccountsReceivablePdfAsync(arRecords, toDate, generatedBy);
                    fileName = $"Accounts_Receivable_Aging_{toDate:yyyyMMdd}.pdf";
                    break;

                case "PaymentHistory":
                    if (paymentHistory == null || !paymentHistory.Any())
                    {
                        ShowToast("No payment history data to export.", ToastType.Error);
                        return;
                    }
                    pdfBytes = await PdfGenerator.GeneratePaymentHistoryPdfAsync(paymentHistory, fromDate, toDate, generatedBy);
                    fileName = $"Payment_History_{fromDate:yyyyMMdd}_{toDate:yyyyMMdd}.pdf";
                    break;

                case "ExpenseAnalysis":
                    if (expenseAnalysis == null)
                    {
                        ShowToast("No expense analysis data to export.", ToastType.Error);
                        return;
                    }
                    pdfBytes = await PdfGenerator.GenerateExpenseAnalysisPdfAsync(expenseAnalysis, fromDate, toDate, generatedBy);
                    fileName = $"Expense_Analysis_{fromDate:yyyyMMdd}_{toDate:yyyyMMdd}.pdf";
                    break;

                case "GeneralLedger":
                    if (generalLedger == null || !generalLedger.Entries.Any())
                    {
                        ShowToast("No general ledger data to export.", ToastType.Error);
                        return;
                    }
                    // Convert private GeneralLedgerData to DTO
                    var ledgerDto = new BrightEnroll_DES.Services.QuestPDF.GeneralLedgerDataDto
                    {
                        Entries = generalLedger.Entries.Select(e => new BrightEnroll_DES.Services.QuestPDF.LedgerEntryDto
                        {
                            Date = e.Date,
                            EntryNumber = e.EntryNumber,
                            AccountCode = e.AccountCode,
                            AccountName = e.AccountName,
                            Description = e.Description,
                            Type = e.Type,
                            Debit = e.Debit,
                            Credit = e.Credit,
                            Balance = e.Balance
                        }).ToList()
                    };
                    pdfBytes = await PdfGenerator.GenerateGeneralLedgerPdfAsync(ledgerDto, fromDate, toDate, generatedBy);
                    fileName = $"General_Ledger_{fromDate:yyyyMMdd}_{toDate:yyyyMMdd}.pdf";
                    break;

                case "BalanceSheet":
                    if (balanceSheetReport == null)
                    {
                        ShowToast("No balance sheet data to export.", ToastType.Error);
                        return;
                    }
                    pdfBytes = await PdfGenerator.GenerateBalanceSheetPdfAsync(balanceSheetReport, toDate, generatedBy);
                    fileName = $"Balance_Sheet_{toDate:yyyyMMdd}.pdf";
                    break;

                default:
                    ShowToast("Unknown report type.", ToastType.Error);
                    return;
            }

            // Convert to base64 and download
            var base64Content = Convert.ToBase64String(pdfBytes);
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "application/pdf", base64Content);

            ShowToast("PDF exported successfully!", ToastType.Success);
        }
        catch (Exception ex)
        {
            ShowToast($"Error exporting to PDF: {ex.Message}", ToastType.Error);
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private void ShowToast(string message, ToastType type)
    {
        toastMessage = message;
        toastType = type;
        showToast = true;
        StateHasChanged();
    }

    private void CloseToast()
    {
        showToast = false;
        StateHasChanged();
    }

    private string FormatCurrency(decimal amount)
    {
        return $"₱{amount:N2}";
    }

    // Helper classes
    private class GeneralLedgerData 
    {
        public List<LedgerEntry> Entries { get; set; } = new();
    }

    private class LedgerEntry
    {
        public DateTime Date { get; set; }
        public string EntryNumber { get; set; } = string.Empty;
        public string AccountCode { get; set; } = string.Empty;
        public string AccountName { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty; // Payment, Expense, Payroll
        public decimal Debit { get; set; }
        public decimal Credit { get; set; }
        public decimal Balance { get; set; }
    }

    private class RevenueBreakdownItem
    {
        public string PaymentMethod { get; set; } = string.Empty;
        public decimal Amount { get; set; }
        public int Count { get; set; }
    }
}


