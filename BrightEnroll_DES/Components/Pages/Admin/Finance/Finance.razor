@page "/finance"
@layout Components.Layout.MainLayout
@using Microsoft.JSInterop
@using BrightEnroll_DES.Components.Pages.Admin.Finance.FinanceComponents
@using BrightEnroll_DES.Services.Business.Finance
@using BrightEnroll_DES.Components
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.RoleBase
@using BrightEnroll_DES.Data.Models
@using BrightEnroll_DES.Data
@using Microsoft.Extensions.Logging
@using Microsoft.EntityFrameworkCore
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject AppDbContext _context
@inject BrightEnroll_DES.Services.Business.Finance.FeeService FeeService
@inject BrightEnroll_DES.Services.Business.Finance.DiscountService DiscountService
@inject BrightEnroll_DES.Services.Business.Finance.ExpenseService ExpenseService
@inject BrightEnroll_DES.Services.Business.Finance.PaymentService PaymentService
@inject BrightEnroll_DES.Services.Business.Notifications.ApprovalNotificationService ApprovalNotificationService
@inject BrightEnroll_DES.Services.Business.Notifications.NotificationService NotificationService
@inject BrightEnroll_DES.Services.Infrastructure.ILoadingService LoadingService
@inject ILogger<Finance> Logger
@inject BrightEnroll_DES.Services.Seeders.DatabaseSeeder DatabaseSeeder
@inject IAuthorizationService AuthorizationService

<PageTitle>Finance</PageTitle>

<RoleAuthorizeView RequiredPermission="@Permissions.ViewFinance">


<div class="text-gray-800">
    <h1 class="mb-6 text-2xl font-bold text-gray-800">Finance</h1>
    
    <!-- Tabs Card -->
    <div class="mb-6 overflow-hidden rounded-xl border-b border-gray-200 bg-white px-4 py-2 shadow">
        <div class="flex items-center gap-6">
            @if (AuthorizationService.HasPermission(Permissions.CreateFee) || AuthorizationService.HasPermission(Permissions.EditFee))
            {
                <button @onclick='async () => await SetActiveTab("FeeSetup")' 
                        class="@GetTabClasses("FeeSetup")"
                        style="@GetFeeSetupStyle()">
                    Fee Setup
                </button>
            }
            @if (AuthorizationService.HasPermission(Permissions.ManageExpenses))
            {
                <button @onclick='async () => await SetActiveTab("Expenses")' 
                        class="@GetTabClasses("Expenses")">
                    Expenses
                </button>
            }
            <button @onclick='async () => await SetActiveTab("Payments")' 
                    class="@GetTabClasses("Payments")">
                Payments
            </button>
            <button @onclick='async () => await SetActiveTab("Records")' 
                    class="@GetTabClasses("Records")">
                Records
            </button>
            <button @onclick='async () => await SetActiveTab("Reports")' 
                    class="@GetTabClasses("Reports")">
                Reports
            </button>
            @if (AuthorizationService.HasPermission(Permissions.ManageExpenses))
            {
                <button @onclick='async () => await SetActiveTab("Approvals")' 
                        class="@GetTabClasses("Approvals") relative">
                    Approvals
                    @if (pendingApprovalsCount > 0)
                    {
                        <span class="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white">
                            @(pendingApprovalsCount > 9 ? "9+" : pendingApprovalsCount.ToString())
                        </span>
                    }
                </button>
            }
        </div>
    </div>

    <!-- Card Container -->
    <div class="overflow-hidden rounded-xl bg-white shadow">
        @if (activeTab == "FeeSetup")
        {
            <FeeSetup FeeList="FeeList" 
                      IsLoading="isLoadingFees"
                      OnFeeAdded="HandleFeeAdded" 
                      OnFeeUpdated="HandleFeeUpdated"
                      DiscountList="DiscountList"
                      IsLoadingDiscounts="isLoadingDiscounts"
                      OnDiscountAdded="HandleDiscountAdded"
                      OnDiscountUpdated="HandleDiscountUpdated"
                      OnDiscountDeleted="HandleDiscountDeleted" />
        }
        else if (activeTab == "Expenses")
        {
            <Expenses ExpenseForm="ExpenseForm"
                      ExpenseList="ExpenseRecords"
                      OnExpenseSaved="HandleExpenseSaved"
                      OnArchiveExpense="HandleArchiveExpense" />
        }
        else if (activeTab == "Payments")
        {
            <Payments PaymentData="PaymentData" 
                      OnPaymentProcessed="HandlePaymentProcessed" />
        }
        else if (activeTab == "Records")
        {
            <Records PaymentRecords="PaymentRecords" 
                     OnViewPaymentDetails="HandleViewPaymentDetails" 
                     OnExportPDF="HandleExportPDF" />
        }
        else if (activeTab == "Reports")
        {
            <FinanceReports />
        }
        else if (activeTab == "Approvals")
        {
            <Approvals OnApprovalProcessed="HandleApprovalProcessed" />
        }
    </div>
</div>

<!-- Payment Details View Modal -->
@if (ShowPaymentDetailsModal && SelectedPaymentRecord != null)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 overflow-y-auto py-8" @onclick="ClosePaymentDetailsModal">
        <div class="w-full max-w-4xl mx-4 bg-white rounded-lg shadow-2xl overflow-hidden" @onclick:stopPropagation="true">
            <!-- Modal Header -->
            <div class="flex items-center justify-between border-b border-gray-200 bg-blue-600 px-6 py-4 rounded-t-lg">
                <div>
                    <h2 class="text-lg font-semibold text-white">Payment Details</h2>
                    <p class="text-xs text-blue-100 mt-0.5">Student ID: @SelectedPaymentRecord.StudentId</p>
                </div>
                <button type="button"
                        class="text-white hover:text-gray-200 transition-colors"
                        @onclick="ClosePaymentDetailsModal">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="max-h-[75vh] overflow-y-auto px-6 py-4">
                @if (PaymentHistory != null && PaymentHistory.Any())
                {
                    <!-- Student Summary -->
                    <div class="mb-6 rounded-lg border border-gray-200 bg-gray-50 p-4">
                        <h3 class="mb-4 text-base font-semibold text-gray-800">Student Summary</h3>
                        <div class="grid grid-cols-2 gap-4 md:grid-cols-4">
                            <div>
                                <p class="text-xs font-medium text-gray-600 mb-1">Student Name</p>
                                <p class="text-sm font-semibold text-gray-800">@SelectedPaymentRecord.Name</p>
                            </div>
                            <div>
                                <p class="text-xs font-medium text-gray-600 mb-1">Grade Level</p>
                                <p class="text-sm font-semibold text-gray-800">@SelectedPaymentRecord.Grade</p>
                            </div>
                            <div>
                                <p class="text-xs font-medium text-gray-600 mb-1">Total Fee</p>
                                <p class="text-sm font-semibold text-gray-800">₱@SelectedPaymentRecord.TotalFee.ToString("N2")</p>
                            </div>
                            <div>
                                <p class="text-xs font-medium text-gray-600 mb-1">Balance</p>
                                <p class="text-sm font-semibold @(SelectedPaymentRecord.Balance > 0 ? "text-red-600" : "text-green-600")">
                                    ₱@SelectedPaymentRecord.Balance.ToString("N2")
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Payment History Table -->
                    <div class="mb-4">
                        <h3 class="mb-3 text-base font-semibold text-gray-800">Payment History & Audit Trail</h3>
                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Date & Time</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">OR Number</th>
                                        <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Amount</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Payment Method</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Processed By</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    @foreach (var payment in PaymentHistory.OrderByDescending(p => p.CreatedAt))
                                    {
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 text-gray-700">
                                                <div class="text-xs font-medium">@payment.CreatedAt.ToString("MMM dd, yyyy")</div>
                                                <div class="text-xs text-gray-500">@payment.CreatedAt.ToString("hh:mm tt")</div>
                                            </td>
                                            <td class="px-4 py-3">
                                                <span class="font-medium text-gray-800">@payment.OrNumber</span>
                                            </td>
                                            <td class="px-4 py-3 text-right">
                                                <span class="font-semibold text-green-600">₱@payment.Amount.ToString("N2")</span>
                                            </td>
                                            <td class="px-4 py-3 text-gray-700">@payment.PaymentMethod</td>
                                            <td class="px-4 py-3">
                                                <div class="text-xs text-gray-700">
                                                    <div class="font-medium">@(string.IsNullOrWhiteSpace(payment.ProcessedBy) ? "N/A" : payment.ProcessedBy)</div>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="bg-gray-50">
                                    <tr>
                                        <td colspan="2" class="px-4 py-3 text-right font-semibold text-gray-800">Total Paid:</td>
                                        <td class="px-4 py-3 text-right font-bold text-green-600">
                                            ₱@PaymentHistory.Sum(p => p.Amount).ToString("N2")
                                        </td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                }
                else
                {
                    <div class="py-12 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-sm font-medium text-gray-600">No payment history available</p>
                        <p class="text-xs text-gray-500 mt-1">This student has not made any payments yet.</p>
                    </div>
                }
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-3 border-t border-gray-200 bg-gray-50 px-6 py-3 rounded-b-lg">
                <button type="button"
                        @onclick="ClosePaymentDetailsModal"
                        class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>
}

@code {
    private string activeTab = "";
    private int pendingApprovalsCount = 0;

    // Fee Setup Data
    private List<FeeModel> FeeList = new();
    private bool isLoadingFees = true; // Inline loading state
    
    // Discount Setup Data
    private List<DiscountModel> DiscountList = new();
    private bool isLoadingDiscounts = false;
    
    
    // Prevent concurrent submissions
    private bool _isProcessingFee = false;

    // Payments Data
    private PaymentDataModel PaymentData = new()
    {
        StudentId = "",
        StudentName = "",
        GradeLevel = "",
        TotalFee = 0,
        AmountPaid = 0,
        Balance = 0,
        PaymentStatus = "",
        NewPaymentAmount = 0,
        PaymentMethod = "Cash"
    };

    // Expenses Data
    private ExpenseFormModel ExpenseForm = new()
    {
        ExpenseId = $"EXP-{DateTime.Now:yyyyMMddHHmmss}",
        RecordedBy = "Admin User",
        ExpenseDate = DateTime.Now,
        PaymentMethod = "Cash",
        Status = "Pending"
    };
    private List<ExpenseRecord> ExpenseRecords = new();

    // Records Data
    private List<PaymentRecord> PaymentRecords = new();
    
    // Payment Details Modal
    private bool ShowPaymentDetailsModal = false;
    private PaymentRecord? SelectedPaymentRecord = null;
    private List<Data.Models.LedgerPayment> PaymentHistory = new();
    
    // Payment search state (used when switching to Payments tab)
    // Note: These fields were previously used but are no longer needed

    private async Task SetActiveTab(string tab)
    {
        // Prevent Cashier from accessing restricted tabs
        if (tab == "FeeSetup" && !AuthorizationService.HasPermission(Permissions.CreateFee) && !AuthorizationService.HasPermission(Permissions.EditFee))
        {
            return;
        }
        if (tab == "Expenses" && !AuthorizationService.HasPermission(Permissions.ManageExpenses))
        {
            return;
        }
        activeTab = tab;
        
        // Clear EF Core change tracker before loading data for the tab
        _context.ChangeTracker.Clear();
        
        // Load data when switching to specific tabs
        if (tab == "FeeSetup")
        {
            // Always load discounts when switching to Fee Setup (they might have been added/updated)
            await LoadDiscountsAsync();
            await LoadFeesAsync();
        }
        
        if (tab == "Records")
        {
            // Always reload payment records when switching to Records tab
            await LoadPaymentRecordsAsync();
        }
        
        if (tab == "Expenses")
        {
            // Always reload expenses when switching to Expenses tab
            await LoadExpensesAsync();
        }
        
        if (tab == "Payments")
        {
            // Clear payment data when switching to Payments tab to ensure fresh search
            PaymentData = new PaymentDataModel
            {
                StudentId = "",
                StudentName = "",
                GradeLevel = "",
                TotalFee = 0,
                AmountPaid = 0,
                Balance = 0,
                PaymentStatus = "",
                NewPaymentAmount = 0,
                PaymentMethod = "Cash"
            };
            // Reset search state when switching tabs
        }
        
        if (tab == "Reports")
        {
            // Clear change tracker when switching to Reports tab to ensure fresh data
            // Reports are generated on-demand, so no need to pre-load
            // But clearing change tracker ensures fresh data when generating reports
        }
        
        // Refresh approval count when switching to Approvals or Expenses tab
        if (tab == "Approvals" || tab == "Expenses")
        {
            await LoadPendingApprovalsCount();
        }
        
        StateHasChanged();
    }

    private string GetFeeSetupStyle()
    {
        bool isSelected = activeTab == "FeeSetup";
        if (isSelected)
        {
            return "color: #0E335D; border-bottom: 2px solid #0E335D;";
        }
        else
        {
            return "color: #0E335D;";
        }
    }

    private string GetTabClasses(string tab)
    {
        bool isSelected = activeTab == tab;
        
        return tab switch
        {
            "FeeSetup" => isSelected
                ? "px-3 py-2 text-sm font-semibold"
                : "px-3 py-2 text-sm font-semibold transition-colors duration-200",
            "Payments" => isSelected
                ? "px-3 py-2 text-sm font-semibold text-green-600 border-b-2 border-green-600"
                : "px-3 py-2 text-sm font-semibold text-green-600 transition-colors duration-200 hover:text-green-700",
            "Expenses" => isSelected
                ? "px-3 py-2 text-sm font-semibold text-orange-600 border-b-2 border-orange-600"
                : "px-3 py-2 text-sm font-semibold text-orange-600 transition-colors duration-200 hover:text-orange-700",
            "Records" => isSelected
                ? "px-3 py-2 text-sm font-semibold text-blue-600 border-b-2 border-blue-600"
                : "px-3 py-2 text-sm font-semibold text-blue-600 transition-colors duration-200 hover:text-blue-700",
            "Reports" => isSelected
                ? "px-3 py-2 text-sm font-semibold text-purple-600 border-b-2 border-purple-600"
                : "px-3 py-2 text-sm font-semibold text-purple-600 transition-colors duration-200 hover:text-purple-700",
            _ => "px-3 py-2 text-sm font-semibold"
        };
    }

    protected override async Task OnInitializedAsync()
    {
        // Check for tab parameter in URL
        var uri = new Uri(Navigation.Uri);
        var query = ParseQueryString(uri.Query);
        
        if (query.TryGetValue("tab", out var tabValue))
        {
            // Validate tab exists and user has permission
            var validTabs = new[] { "FeeSetup", "Expenses", "Payments", "Records", "Reports", "Approvals" };
            if (validTabs.Contains(tabValue, StringComparer.OrdinalIgnoreCase))
            {
                activeTab = tabValue;
            }
        }
        
        // Set default tab based on permissions if no tab in URL
        if (string.IsNullOrEmpty(activeTab))
        {
            // Cashier should only see Payments and Records
            if (AuthorizationService.HasPermission(Permissions.CreateFee) || AuthorizationService.HasPermission(Permissions.EditFee))
            {
                activeTab = "FeeSetup";
            }
            else
            {
                activeTab = "Payments";
            }
        }

        // Load pending approvals count
        await LoadPendingApprovalsCount();

        // Hide loading screen immediately when page loads
        LoadingService.HideLoading();
        
        // Load fees inline (no full-screen loading - uses inline loading indicator)
        isLoadingFees = true;
        try
        {
            await LoadFeesAsync();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading fees: {Message}", ex.Message);
            FeeList = new List<FeeModel>();
        }
        finally
        {
            isLoadingFees = false;
            StateHasChanged();
        }

        // Load expenses list
        try
        {
            await LoadExpensesAsync();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading expenses: {Message}", ex.Message);
        }

        // Load discounts if Fee Setup is the active tab
        if (activeTab == "FeeSetup")
        {
            try
            {
                await LoadDiscountsAsync();
            }
            catch (Exception ex)
            {
                Logger?.LogError(ex, "Error loading discounts: {Message}", ex.Message);
                DiscountList = new List<DiscountModel>();
            }
        }

        // Load payment records
        try
        {
            await LoadPaymentRecordsAsync();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading payment records: {Message}", ex.Message);
            
            // Check if it's a missing table error
            string errorMsg = ex.Message;
            if (ex.InnerException != null)
            {
                errorMsg = ex.InnerException.Message;
            }
            
            if (errorMsg.Contains("Invalid object name", StringComparison.OrdinalIgnoreCase) ||
                errorMsg.Contains("tbl_StudentPayments", StringComparison.OrdinalIgnoreCase) ||
                errorMsg.Contains("does not exist", StringComparison.OrdinalIgnoreCase) ||
                errorMsg.Contains("tbl_Expenses", StringComparison.OrdinalIgnoreCase) ||
                errorMsg.Contains("tbl_Fees", StringComparison.OrdinalIgnoreCase) ||
                errorMsg.Contains("tbl_GradeLevel", StringComparison.OrdinalIgnoreCase))
            {
                // Try to automatically create missing finance tables
                try
                {
                    Logger?.LogInformation("Attempting to create missing finance tables...");
                    await DatabaseSeeder.EnsureFinanceTablesExistAsync();
                    Logger?.LogInformation("Finance tables created successfully. Retrying payment records load...");
                    
                    // Retry loading payment records after creating tables
                    await LoadPaymentRecordsAsync();
                    
                }
                catch (Exception createEx)
                {
                    Logger?.LogError(createEx, "Failed to create finance tables: {Message}", createEx.Message);
                }
            }
            // Don't show error toast for other payment record errors as it's not critical on initial load
        }
    }

    private async Task LoadPendingApprovalsCount()
    {
        try
        {
            pendingApprovalsCount = await ApprovalNotificationService.GetPendingApprovalsCountAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading pending approvals count");
        }
    }

    private async Task LoadFeesAsync()
    {
        // Add timeout to prevent infinite loading
        using (var cts = new CancellationTokenSource(TimeSpan.FromSeconds(10)))
        {
            try
            {
                // Clear EF Core change tracker to ensure fresh data is loaded
                _context.ChangeTracker.Clear();
                
                // Small delay to ensure any pending database changes are committed
                await Task.Delay(100);
                
                var fees = await FeeService.GetAllFeesAsync();
                
                // Map Fee entities to FeeModel for UI
                FeeList = fees.Select(f => new FeeModel
                {
                    GradeLevel = f.GradeLevel?.GradeLevelName ?? "N/A",
                    TuitionFee = f.TuitionFee,
                    MiscFee = f.MiscFee,
                    OtherFee = f.OtherFee,
                    TuitionBreakdown = f.Breakdowns
                        .Where(b => b.BreakdownType == "Tuition")
                        .OrderBy(b => b.DisplayOrder)
                        .Select(b => new FeeBreakdownItem
                        {
                            Name = b.ItemName,
                            AmountString = b.Amount.ToString("N2")
                        }).ToList(),
                    MiscBreakdown = f.Breakdowns
                        .Where(b => b.BreakdownType == "Misc")
                        .OrderBy(b => b.DisplayOrder)
                        .Select(b => new FeeBreakdownItem
                        {
                            Name = b.ItemName,
                            AmountString = b.Amount.ToString("N2")
                        }).ToList(),
                    OtherBreakdown = f.Breakdowns
                        .Where(b => b.BreakdownType == "Other")
                        .OrderBy(b => b.DisplayOrder)
                        .Select(b => new FeeBreakdownItem
                        {
                            Name = b.ItemName,
                            AmountString = b.Amount.ToString("N2")
                        }).ToList()
                }).ToList();
            }
            catch (OperationCanceledException)
            {
                Logger?.LogError("Timeout loading fees: Operation took too long (10 seconds)");
                throw new TimeoutException("Loading fees timed out. The service may not be properly connected.");
            }
        }
    }

    private async Task LoadExpensesAsync()
    {
        // Add timeout to prevent infinite loading
        using (var cts = new CancellationTokenSource(TimeSpan.FromSeconds(10)))
        {
            try
            {
                // Clear EF Core change tracker to ensure fresh data is loaded
                _context.ChangeTracker.Clear();
                
                // Small delay to ensure any pending database changes are committed
                await Task.Delay(100);
                
                var expenses = await ExpenseService.GetExpensesAsync();

                ExpenseRecords = expenses.Select(e => new ExpenseRecord
                {
                    ExpenseId = e.ExpenseCode,
                    ExpenseDate = e.ExpenseDate,
                    Category = e.Category,
                    Description = e.Description ?? string.Empty,
                    Payee = e.Payee ?? string.Empty,
                    Amount = e.Amount,
                    PaymentMethod = e.PaymentMethod,
                    ReceiptNumber = e.OrNumber ?? string.Empty,
                    RecordedBy = e.RecordedBy ?? string.Empty,
                    ApprovedBy = e.ApprovedBy ?? string.Empty,
                    Status = e.Status
                }).ToList();
            }
            catch (OperationCanceledException)
            {
                Logger?.LogError("Timeout loading expenses: Operation took too long (10 seconds)");
                throw new TimeoutException("Loading expenses timed out. The service may not be properly connected.");
            }
        }
    }

    // Event Handlers
    private async Task HandleFeeAdded(FeeModel fee)
    {
        // Prevent concurrent submissions
        if (_isProcessingFee)
        {
            return;
        }
        
        _isProcessingFee = true;
        StateHasChanged();
        
        try
        {
            // Get grade level ID from name
            var gradeLevels = await FeeService.GetAllGradeLevelsAsync();
            var gradeLevel = gradeLevels.FirstOrDefault(g => g.GradeLevelName == fee.GradeLevel);
            
            if (gradeLevel == null)
            {
                Logger?.LogError("Grade level not found: {GradeLevel}", fee.GradeLevel);
                StateHasChanged();
                return;
            }

            // Create request with breakdown items (filter out empty items)
            var request = new CreateFeeRequest
            {
                GradeLevelId = gradeLevel.GradeLevelId,
                TuitionFee = fee.TuitionFee,
                MiscFee = fee.MiscFee,
                OtherFee = fee.OtherFee,
                TuitionBreakdown = fee.TuitionBreakdown
                    .Where(b => !string.IsNullOrWhiteSpace(b.Name) && b.Amount > 0)
                    .Select(b => new FeeBreakdownItemDto
                    {
                        Name = b.Name.Trim(),
                        Amount = b.Amount
                    }).ToList(),
                MiscBreakdown = fee.MiscBreakdown
                    .Where(b => !string.IsNullOrWhiteSpace(b.Name) && b.Amount > 0)
                    .Select(b => new FeeBreakdownItemDto
                    {
                        Name = b.Name.Trim(),
                        Amount = b.Amount
                    }).ToList(),
                OtherBreakdown = fee.OtherBreakdown
                    .Where(b => !string.IsNullOrWhiteSpace(b.Name) && b.Amount > 0)
                    .Select(b => new FeeBreakdownItemDto
                    {
                        Name = b.Name.Trim(),
                        Amount = b.Amount
                    }).ToList(),
                CreatedBy = "Admin" // TODO: Get from current user context
            };

            await FeeService.CreateFeeAsync(request);
            
            // Small delay to ensure transaction is committed and audit logging has started
            await Task.Delay(100);
            
            // Clear change tracker before reloading to avoid concurrency issues
            _context.ChangeTracker.Clear();
            
            // Reload fees from database
            await LoadFeesAsync();
            
            StateHasChanged();
        }
        catch (InvalidOperationException ioEx) when (ioEx.Message.Contains("second operation") || ioEx.Message.Contains("DbContext"))
        {
            Logger?.LogWarning(ioEx, "DbContext concurrency issue when adding fee. Retrying after delay...");
            await Task.Delay(200);
            _context.ChangeTracker.Clear();
            try
            {
                await LoadFeesAsync();
            }
            catch (Exception retryEx)
            {
                Logger?.LogError(retryEx, "Error reloading fees after retry: {Message}", retryEx.Message);
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error adding fee: {Message}. Stack trace: {StackTrace}", ex.Message, ex.StackTrace);
            
            Logger?.LogError(ex, "Error adding fee: {Message}", ex.Message);
            StateHasChanged();
        }
        finally
        {
            _isProcessingFee = false;
            StateHasChanged();
        }
    }

    private async Task HandleFeeUpdated(FeeModel fee)
    {
        try
        {
            // Get grade level ID from name
            var gradeLevels = await FeeService.GetAllGradeLevelsAsync();
            var gradeLevel = gradeLevels.FirstOrDefault(g => g.GradeLevelName == fee.GradeLevel);
            
            if (gradeLevel == null)
            {
                Logger?.LogError("Grade level not found: {GradeLevel}", fee.GradeLevel);
                StateHasChanged();
                return;
            }

            // Get existing fee
            var existingFee = await FeeService.GetFeeByGradeLevelIdAsync(gradeLevel.GradeLevelId);
            
            if (existingFee == null)
            {
                Logger?.LogError("Fee not found for grade level: {GradeLevel}", fee.GradeLevel);
                StateHasChanged();
                return;
            }

            // Create update request with breakdown items (filter out empty items)
            var request = new UpdateFeeRequest
            {
                TuitionFee = fee.TuitionFee,
                MiscFee = fee.MiscFee,
                OtherFee = fee.OtherFee,
                TuitionBreakdown = fee.TuitionBreakdown
                    .Where(b => !string.IsNullOrWhiteSpace(b.Name) && b.Amount > 0)
                    .Select(b => new FeeBreakdownItemDto
                    {
                        Name = b.Name.Trim(),
                        Amount = b.Amount
                    }).ToList(),
                MiscBreakdown = fee.MiscBreakdown
                    .Where(b => !string.IsNullOrWhiteSpace(b.Name) && b.Amount > 0)
                    .Select(b => new FeeBreakdownItemDto
                    {
                        Name = b.Name.Trim(),
                        Amount = b.Amount
                    }).ToList(),
                OtherBreakdown = fee.OtherBreakdown
                    .Where(b => !string.IsNullOrWhiteSpace(b.Name) && b.Amount > 0)
                    .Select(b => new FeeBreakdownItemDto
                    {
                        Name = b.Name.Trim(),
                        Amount = b.Amount
                    }).ToList(),
                UpdatedBy = "Admin" // TODO: Get from current user context
            };

            await FeeService.UpdateFeeAsync(existingFee.FeeId, request);
            
            // Small delay to ensure transaction is committed and audit logging has started
            await Task.Delay(100);
            
            // Clear change tracker before reloading to avoid concurrency issues
            _context.ChangeTracker.Clear();
            
            // Reload fees from database
            await LoadFeesAsync();
            
            StateHasChanged();
        }
        catch (InvalidOperationException ioEx) when (ioEx.Message.Contains("second operation") || ioEx.Message.Contains("DbContext"))
        {
            Logger?.LogWarning(ioEx, "DbContext concurrency issue when updating fee. Retrying after delay...");
            await Task.Delay(200);
            _context.ChangeTracker.Clear();
            try
            {
                await LoadFeesAsync();
            }
            catch (Exception retryEx)
            {
                Logger?.LogError(retryEx, "Error reloading fees after retry: {Message}", retryEx.Message);
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error updating fee: {Message}. Stack trace: {StackTrace}", ex.Message, ex.StackTrace);
            
            Logger?.LogError(ex, "Error updating fee: {Message}", ex.Message);
            StateHasChanged();
        }
    }

    // Discount Handlers
    private async Task LoadDiscountsAsync()
    {
        isLoadingDiscounts = true;
        StateHasChanged();
        
        try
        {
            // Clear EF Core change tracker to ensure fresh data is loaded
            _context.ChangeTracker.Clear();
            
            // Small delay to ensure any pending database changes are committed
            await Task.Delay(100);
            
            var discounts = await DiscountService.GetAllDiscountsAsync();
            
            DiscountList = discounts.Select(d => new DiscountModel
            {
                DiscountId = d.DiscountId,
                DiscountType = d.DiscountType,
                DiscountName = d.DiscountName,
                RateOrValue = d.RateOrValue,
                IsPercentage = d.IsPercentage,
                MaxAmount = d.MaxAmount,
                MinAmount = d.MinAmount,
                Description = d.Description,
                IsActive = d.IsActive
            }).ToList();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading discounts: {Message}", ex.Message);
            DiscountList = new List<DiscountModel>();
        }
        finally
        {
            isLoadingDiscounts = false;
            StateHasChanged();
        }
    }

    private async Task HandleDiscountAdded(DiscountModel discount)
    {
        try
        {
            var request = new CreateDiscountRequest
            {
                DiscountType = discount.DiscountType,
                DiscountName = discount.DiscountName,
                RateOrValue = discount.RateOrValue,
                IsPercentage = discount.IsPercentage,
                MaxAmount = discount.MaxAmount,
                MinAmount = discount.MinAmount,
                Description = discount.Description,
                IsActive = discount.IsActive
            };

            await DiscountService.CreateDiscountAsync(request);
            
            // Small delay to ensure transaction is committed and audit logging has started
            await Task.Delay(100);
            
            // Clear change tracker before reloading to avoid concurrency issues
            _context.ChangeTracker.Clear();
            
            // Reload discounts from database
            await LoadDiscountsAsync();
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error adding discount: {Message}", ex.Message);
            StateHasChanged();
        }
    }

    private async Task HandleDiscountUpdated(DiscountModel discount)
    {
        try
        {
            var existingDiscount = await DiscountService.GetDiscountByIdAsync(discount.DiscountId);
            
            if (existingDiscount == null)
            {
                Logger?.LogError("Discount not found: {DiscountId}", discount.DiscountId);
                StateHasChanged();
                return;
            }

            var request = new UpdateDiscountRequest
            {
                DiscountType = discount.DiscountType,
                DiscountName = discount.DiscountName,
                RateOrValue = discount.RateOrValue,
                IsPercentage = discount.IsPercentage,
                MaxAmount = discount.MaxAmount,
                MinAmount = discount.MinAmount,
                Description = discount.Description,
                IsActive = discount.IsActive
            };

            await DiscountService.UpdateDiscountAsync(discount.DiscountId, request);
            
            // Small delay to ensure transaction is committed and audit logging has started
            await Task.Delay(100);
            
            // Clear change tracker before reloading to avoid concurrency issues
            _context.ChangeTracker.Clear();
            
            // Reload discounts from database
            await LoadDiscountsAsync();
            
            // Show success toast
            StateHasChanged();
        }
        catch (InvalidOperationException ioEx) when (ioEx.Message.Contains("second operation") || ioEx.Message.Contains("DbContext"))
        {
            Logger?.LogWarning(ioEx, "DbContext concurrency issue when updating discount. Retrying after delay...");
            await Task.Delay(200);
            _context.ChangeTracker.Clear();
            try
            {
                await LoadDiscountsAsync();
            }
            catch (Exception retryEx)
            {
                Logger?.LogError(retryEx, "Error reloading discounts after retry: {Message}", retryEx.Message);
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error updating discount: {Message}", ex.Message);
            StateHasChanged();
        }
    }

    private async Task HandleDiscountDeleted(DiscountModel discount)
    {
        try
        {
            await DiscountService.DeleteDiscountAsync(discount.DiscountId);
            
            // Small delay to ensure transaction is committed and audit logging has started
            await Task.Delay(100);
            
            // Clear change tracker before reloading to avoid concurrency issues
            _context.ChangeTracker.Clear();
            
            // Reload discounts from database
            await LoadDiscountsAsync();
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error removing discount: {Message}", ex.Message);
            StateHasChanged();
        }
    }
    
    private async Task HandleApprovalProcessed()
    {
        // Small delay to ensure database changes are committed
        await Task.Delay(200);
        
        // Clear change tracker to ensure fresh data
        _context.ChangeTracker.Clear();
        
        // Refresh pending approvals count immediately
        await LoadPendingApprovalsCount();
        
        // Refresh expense list to show updated status immediately
        await LoadExpensesAsync();
        
        // Force UI update
        StateHasChanged();
    }
    
    protected override async Task OnParametersSetAsync()
    {
        // Handle navigation changes (e.g., when coming from notification or Enrollment page)
        var uri = new Uri(Navigation.Uri);
        var query = ParseQueryString(uri.Query);
        
        // Clear EF Core change tracker to ensure fresh data when navigating back
        _context.ChangeTracker.Clear();
        
        // Small delay to ensure any pending database changes are committed
        await Task.Delay(100);
        
        if (query.TryGetValue("tab", out var tabValue))
        {
            var validTabs = new[] { "FeeSetup", "Expenses", "Payments", "Records", "Reports", "Approvals" };
            if (validTabs.Contains(tabValue, StringComparer.OrdinalIgnoreCase))
            {
                if (activeTab != tabValue)
                {
                    activeTab = tabValue;
                    // Refresh data when switching tabs
                    await RefreshDataForTab(activeTab);
                    
                    // If coming from expense notification, ensure Approvals shows Expenses tab
                    if (activeTab == "Approvals" && query.TryGetValue("expense", out var expenseParam) && expenseParam == "true")
                    {
                        // The Approvals component will handle this via its activeTab defaulting to "Expenses"
                        StateHasChanged();
                    }
                }
            }
        }
        else
        {
            // If no tab in URL, refresh current tab data to ensure it's up-to-date
            // This is important when navigating back from Enrollment or Student Record pages
            await RefreshDataForTab(activeTab);
        }
    }
    
    private async Task RefreshDataForTab(string tab)
    {
        try
        {
            // Clear EF Core change tracker before refreshing
            _context.ChangeTracker.Clear();
            
            // Small delay to ensure any pending database changes are committed
            await Task.Delay(50);
            
            switch (tab)
            {
                case "FeeSetup":
                    await LoadFeesAsync();
                    await LoadDiscountsAsync();
                    break;
                case "Expenses":
                    await LoadExpensesAsync();
                    await LoadPendingApprovalsCount();
                    break;
                case "Approvals":
                    await LoadPendingApprovalsCount();
                    break;
                case "Payments":
                    // Payments tab loads data on-demand when searching, no pre-load needed
                    break;
                case "Records":
                    await LoadPaymentRecordsAsync();
                    break;
                case "Reports":
                    // Reports are generated on-demand, no pre-load needed
                    break;
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error refreshing data for tab {Tab}: {Message}", tab, ex.Message);
        }
    }
    
    private Dictionary<string, string> ParseQueryString(string queryString)
    {
        var query = new Dictionary<string, string>();
        
        if (string.IsNullOrWhiteSpace(queryString))
            return query;
        
        if (queryString.StartsWith("?"))
            queryString = queryString.Substring(1);
        
        var pairs = queryString.Split('&', StringSplitOptions.RemoveEmptyEntries);
        foreach (var pair in pairs)
        {
            var parts = pair.Split('=', 2);
            if (parts.Length == 2)
            {
                var key = Uri.UnescapeDataString(parts[0]);
                var value = Uri.UnescapeDataString(parts[1]);
                query[key] = value;
            }
        }
        
        return query;
    }

    private async Task HandlePaymentProcessed(PaymentDataModel paymentData)
    {
        try
        {
            // Clear EF Core change tracker to ensure fresh data
            _context.ChangeTracker.Clear();
            
            // Small delay to ensure database changes are committed
            await Task.Delay(150);
            
            // Reload payment records to get updated data
            await LoadPaymentRecordsAsync();
            
            // Also refresh expenses if needed (in case payment affects expense approvals)
            if (activeTab == "Expenses")
            {
                await LoadExpensesAsync();
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error handling payment processed: {Message}", ex.Message);
            StateHasChanged();
        }
    }

    private async Task LoadPaymentRecordsAsync()
    {
        try
        {
            // Clear EF Core change tracker to ensure fresh data is loaded
            _context.ChangeTracker.Clear();
            
            // Small delay to ensure any pending database changes are committed
            await Task.Delay(100);
            
            // Get all active students (exclude archived students)
            var archivedStatuses = new[] { "Rejected by School", "Application Withdrawn", "Application Withdraw", "Withdrawn", "Graduated", "Transferred" };
            var allStudents = await _context.Students
                .Include(s => s.Guardian)
                .Where(s => s.Status == null || !archivedStatuses.Contains(s.Status))
                .ToListAsync();
            
            var paymentRecords = new List<PaymentRecord>();
            
            foreach (var student in allStudents)
            {
                // Try to get payment info for this student
                var paymentInfo = await PaymentService.GetStudentPaymentInfoAsync(student.StudentId);
                
                // Get latest payment for ProcessedBy info
                var latestPayment = paymentInfo != null 
                    ? await PaymentService.GetLatestPaymentAsync(student.StudentId)
                    : null;
                
                // If student has payment info, use it; otherwise show as unpaid
                if (paymentInfo != null)
                {
                    paymentRecords.Add(new PaymentRecord
                    {
                        StudentId = student.StudentId,
                        Name = paymentInfo.StudentName,
                        Grade = paymentInfo.GradeLevel ?? student.GradeLevel ?? "N/A",
                        TotalFee = paymentInfo.TotalFee,
                        AmountPaid = paymentInfo.AmountPaid,
                        Balance = paymentInfo.Balance,
                        PaymentStatus = paymentInfo.PaymentStatus,
                        ProcessedBy = latestPayment?.ProcessedBy ?? "N/A",
                        LastPaymentDate = latestPayment?.CreatedAt
                    });
                }
                else
                {
                    // Student has no ledger yet - show as unpaid
                    var studentName = $"{student.FirstName} {(!string.IsNullOrWhiteSpace(student.MiddleName) ? student.MiddleName + " " : "")}{student.LastName}{(!string.IsNullOrWhiteSpace(student.Suffix) ? " " + student.Suffix : "")}".Trim();
                    
                    paymentRecords.Add(new PaymentRecord
                    {
                        StudentId = student.StudentId,
                        Name = studentName,
                        Grade = student.GradeLevel ?? "N/A",
                        TotalFee = 0,
                        AmountPaid = 0,
                        Balance = 0,
                        PaymentStatus = "Unpaid",
                        ProcessedBy = "N/A",
                        LastPaymentDate = null
                    });
                }
            }
            
            // Sort by latest payment date (most recent first), then by student ID for consistency
            PaymentRecords = paymentRecords
                .OrderByDescending(p => p.LastPaymentDate ?? DateTime.MinValue)
                .ThenByDescending(p => p.StudentId)
                .ToList();
            
            Logger?.LogInformation("Loaded {Count} payment records (out of {TotalStudents} students)", PaymentRecords.Count, allStudents.Count);
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading payment records: {Message}", ex.Message);
            PaymentRecords = new List<PaymentRecord>();
            Logger?.LogError(ex, "Error loading payment records: {Message}", ex.Message);
        }
    }

    private async Task HandleExpenseSaved(ExpenseFormModel expenseForm)
    {
        try
        {
            // Parse amount string (e.g., "Php 1,000.00") to decimal
            decimal amount = 0;
            if (!string.IsNullOrWhiteSpace(expenseForm.Amount))
            {
                var cleaned = expenseForm.Amount
                    .Replace("Php", "", StringComparison.OrdinalIgnoreCase)
                    .Replace("₱", string.Empty)
                    .Replace(",", string.Empty)
                    .Trim();

                if (!decimal.TryParse(cleaned, out amount))
                {
                    throw new Exception("Invalid amount. Please enter a valid number (e.g., 1000 or 1,000.00).");
                }
            }

            bool isExisting = ExpenseRecords.Any(e => 
                !string.IsNullOrWhiteSpace(e.ExpenseId) && 
                e.ExpenseId == expenseForm.ExpenseId);

            if (!isExisting)
            {
                var createRequest = new CreateExpenseRequest
                {
                    ExpenseCode = expenseForm.ExpenseId,
                    Category = expenseForm.Category,
                    Description = expenseForm.Description,
                    Amount = amount,
                    ExpenseDate = expenseForm.ExpenseDate,
                    Payee = expenseForm.Payee,
                    OrNumber = expenseForm.OrNumber,
                    PaymentMethod = expenseForm.PaymentMethod,
                    ApprovedBy = expenseForm.ApprovedBy,
                    Status = expenseForm.Status,
                    RecordedBy = expenseForm.RecordedBy
                };

                await ExpenseService.CreateExpenseAsync(createRequest);

                
                // Small delay to ensure database changes are committed
                await Task.Delay(100);
                
                // Refresh pending approvals count immediately after expense creation
                await LoadPendingApprovalsCount();
                
                // Refresh expenses list to show the new expense
                await LoadExpensesAsync();
                
                // Force UI update
                StateHasChanged();
            }
            else
            {
                var updateRequest = new UpdateExpenseRequest
                {
                    Category = expenseForm.Category,
                    Description = expenseForm.Description,
                    Amount = amount,
                    ExpenseDate = expenseForm.ExpenseDate,
                    Payee = expenseForm.Payee,
                    OrNumber = expenseForm.OrNumber,
                    PaymentMethod = expenseForm.PaymentMethod,
                    ApprovedBy = expenseForm.ApprovedBy,
                    Status = expenseForm.Status,
                    RecordedBy = expenseForm.RecordedBy
                };

                await ExpenseService.UpdateExpenseAsync(expenseForm.ExpenseId, updateRequest);

            }

            // Small delay to ensure database changes are committed
            await Task.Delay(100);

            // Refresh expenses list after add or update
            await LoadExpensesAsync();
            
            // Force UI update to show the new expense in the list
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error saving expense: {Message}", ex.Message);
            StateHasChanged();
        }
        finally
        {
            // Reset the form after saving or error, keeping UX consistent
            ExpenseForm = new ExpenseFormModel
            {
                ExpenseId = $"EXP-{DateTime.Now:yyyyMMddHHmmss}",
                RecordedBy = "Admin User",
                ExpenseDate = DateTime.Now,
                PaymentMethod = "Cash",
                Status = "Pending"
            };
            StateHasChanged();
        }
    }

    private async Task HandleArchiveExpense(string expenseId)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(expenseId))
            {
                return;
            }

            await ExpenseService.ArchiveExpenseAsync(expenseId);
            await LoadExpensesAsync();

        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error archiving expense: {Message}", ex.Message);
        }
    }

    private async Task HandleViewPaymentDetails(PaymentRecord record)
    {
        try
        {
            SelectedPaymentRecord = record;
            PaymentHistory = await PaymentService.GetPaymentsByStudentIdAsync(record.StudentId);
            ShowPaymentDetailsModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading payment details: {Message}", ex.Message);
        }
    }

    private void ClosePaymentDetailsModal()
    {
        ShowPaymentDetailsModal = false;
        SelectedPaymentRecord = null;
        PaymentHistory = new();
        StateHasChanged();
    }

    private async Task HandleExportPDF()
    {
        // TODO: Implement PDF export functionality
        // This would typically generate a PDF with all payment records
        await Task.CompletedTask;
    }
}
</RoleAuthorizeView>
