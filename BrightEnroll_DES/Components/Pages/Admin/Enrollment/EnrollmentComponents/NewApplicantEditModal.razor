@namespace BrightEnroll_DES.Components.Pages.Admin.Enrollment.EnrollmentComponents
@using BrightEnroll_DES.Models
@using BrightEnroll_DES.Components.Pages.Admin.Enrollment.EnrollmentCS
@using BrightEnroll_DES.Services.Infrastructure
@using BrightEnroll_DES.Services.Business.Finance
@using BrightEnroll_DES.Services.Business.Academic
@using BrightEnroll_DES.Data.Models
@using BrightEnroll_DES.Services.QuestPDF
@using System.Linq
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using Microsoft.Extensions.Logging

@if (Show)
{
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @onclick="HandleBackdropClick">
    <div class="relative w-full max-w-5xl max-h-[90vh] flex flex-col rounded-2xl bg-white shadow-xl modal-scroll"
         @onclick:stopPropagation="true">

        <!-- Header - Fixed, not scrollable -->
        <div class="flex items-center justify-between border-b border-gray-200 px-6 py-3 bg-blue-700 rounded-t-2xl flex-shrink-0">
            <div>
                <h2 class="text-lg font-semibold text-white">@(IsForEnrollmentContext ? "Review & Enroll Student" : "Edit Applicant")</h2>
                <p class="text-xs text-blue-100">@(IsForEnrollmentContext ? "Review student information and change status to Enrolled." : "Update the student information and requirements.")</p>
            </div>
            <button @onclick="OnCancelClicked"
                    class="rounded-full p-1 text-blue-100 hover:bg-blue-600 hover:text-white">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Body - Scrollable -->
        <div class="px-4 py-4 sm:px-6 sm:py-5 md:px-8 md:py-6 overflow-y-auto flex-1">
            @if (EditContext == null || Model == null)
            {
                <div class="flex items-center justify-center py-12 text-gray-500">
                    <svg class="mr-2 h-5 w-5 animate-spin text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading student data...
                </div>
            }
            else
            {
                <EditForm EditContext="@EditContext">
                    <DataAnnotationsValidator />

                    <!-- Personal Information (mirrors StudentRegistration) -->
                    <div class="mb-6 sm:mb-8">
                        <h2 class="mb-4 text-lg font-bold text-blue-600 sm:mb-6 sm:text-xl">Personal Information</h2>

                        <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-2 sm:gap-4 lg:grid-cols-4">
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    First Name <span class="text-red-500">*</span>
                                </label>
                                <InputText @bind-Value="Model.FirstName"
                                           @bind-Value:after="() => { FormatFirstName(); StateHasChanged(); }"
                                           class="@GetInputClass(nameof(Model.FirstName))" />
                                <ValidationMessage For="@(() => Model.FirstName)" class="text-red-500 text-xs mt-1" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Middle Name</label>
                                <InputText @bind-Value="Model.MiddleName"
                                           @bind-Value:after="FormatMiddleName"
                                           class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Last Name <span class="text-red-500">*</span>
                                </label>
                                <InputText @bind-Value="Model.LastName"
                                           @bind-Value:after="() => { FormatLastName(); StateHasChanged(); }"
                                           class="@GetInputClass(nameof(Model.LastName))" />
                                <ValidationMessage For="@(() => Model.LastName)" class="text-red-500 text-xs mt-1" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Suffix</label>
                                <InputSelect @bind-Value="Model.Suffix"
                                             class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base">
                                    <option value="">N/A</option>
                                    <option value="Jr.">Jr.</option>
                                    <option value="Sr.">Sr.</option>
                                    <option value="II">II</option>
                                    <option value="III">III</option>
                                    <option value="IV">IV</option>
                                </InputSelect>
                            </div>
                        </div>

                        <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-2 sm:gap-4 lg:grid-cols-4">
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Birth Date <span class="text-red-500">*</span>
                                </label>
                                <InputDate @bind-Value="Model.BirthDate"
                                           @bind-Value:after="HandleBirthDateChanged"
                                           class="@GetInputClass(nameof(Model.BirthDate))" />
                                <ValidationMessage For="@(() => Model.BirthDate)" class="text-red-500 text-xs mt-1" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Age <span class="text-red-500">*</span>
                                </label>
                                <InputNumber @bind-Value="Model.Age"
                                             class="@GetInputClass(nameof(Model.Age))" />
                                <ValidationMessage For="@(() => Model.Age)" class="text-red-500 text-xs mt-1" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Place of Birth <span class="text-red-500">*</span>
                                </label>
                                <InputText @bind-Value="Model.PlaceOfBirth"
                                           class="@GetInputClass(nameof(Model.PlaceOfBirth))" />
                                <ValidationMessage For="@(() => Model.PlaceOfBirth)" class="text-red-500 text-xs mt-1" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Sex <span class="text-red-500">*</span>
                                </label>
                                <InputSelect @bind-Value="Model.Sex"
                                             class="@GetInputClass(nameof(Model.Sex))">
                                    <option value="">Select</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => Model.Sex)" class="text-red-500 text-xs mt-1" />
                            </div>
                        </div>

                    <!-- Additional personal details: Mother Tongue, IP, 4Ps -->
                    <div class="mb-3">
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Mother Tongue <span class="text-red-500">*</span>
                            </label>
                            <InputSelect @bind-Value="Model.MotherTongue"
                                         class="@GetInputClass(nameof(Model.MotherTongue))">
                                <option value="">Select</option>
                                <option value="Tagalog">Tagalog</option>
                                <option value="Cebuano">Cebuano</option>
                                <option value="Ilocano">Ilocano</option>
                                <option value="Hiligaynon">Hiligaynon</option>
                                <option value="Waray">Waray</option>
                                <option value="Other">Other</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => Model.MotherTongue)" class="text-red-500 text-xs mt-1" />
                            @if (Model.MotherTongue == "Other")
                            {
                                <InputText @bind-Value="Model.MotherTongueOther"
                                           class="mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none sm:px-4 sm:py-2.5 sm:text-base"
                                           placeholder="Please specify mother tongue" />
                            }
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4 lg:grid-cols-3">
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Indigenous Peoples (IP) Community?
                            </label>
                            <InputRadioGroup @bind-Value="Model.IsIPCommunity">
                                <div class="flex items-center gap-3 pt-1 sm:gap-4 sm:pt-2">
                                    <label class="flex cursor-pointer items-center">
                                        <InputRadio Value="@("Yes")" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">Yes</span>
                                    </label>
                                    <label class="flex cursor-pointer items-center">
                                        <InputRadio Value="@("No")" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">No</span>
                                    </label>
                                </div>
                            </InputRadioGroup>
                        </div>

                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                If Yes, please specify:
                            </label>
                            <InputSelect @bind-Value="Model.IPCommunitySpecify"
                                         disabled="@(Model.IsIPCommunity != "Yes")"
                                         class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed sm:px-4 sm:py-2.5 sm:text-base">
                                <option value="">N/A</option>
                                <option value="Lumad">Lumad</option>
                                <option value="Manobo">Manobo</option>
                                <option value="B'laan">B'laan</option>
                                <option value="Other">Other</option>
                            </InputSelect>
                            @if (Model.IPCommunitySpecify == "Other" && Model.IsIPCommunity == "Yes")
                            {
                                <InputText @bind-Value="Model.IPCommunitySpecifyOther"
                                           class="mt-2 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none sm:px-4 sm:py-2.5 sm:text-base"
                                           placeholder="Please specify" />
                            }
                        </div>

                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                4Ps Beneficiary?
                            </label>
                            <InputRadioGroup @bind-Value="Model.Is4PsBeneficiary">
                                <div class="flex items-center gap-3 pt-1 sm:gap-4 sm:pt-2">
                                    <label class="flex cursor-pointer items-center">
                                        <InputRadio Value="@("Yes")" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">Yes</span>
                                    </label>
                                    <label class="flex cursor-pointer items-center">
                                        <InputRadio Value="@("No")" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">No</span>
                                    </label>
                                </div>
                            </InputRadioGroup>
                            <label class="mt-3 mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                If Yes, 4Ps Household ID:
                            </label>
                            <InputText @bind-Value="Model.FourPsHouseholdId"
                                       disabled="@(Model.Is4PsBeneficiary != "Yes")"
                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed sm:px-4 sm:py-2.5 sm:text-base"
                                       placeholder="N/A" />
                        </div>
                    </div>
                    </div>

                    <!-- Current Address (mirrors StudentRegistration layout, simplified inputs) -->
                    <hr class="my-6 border-gray-200 sm:my-8" />
                    <div class="mb-6 sm:mb-8">
                        <h2 class="mb-4 text-lg font-bold text-blue-600 sm:mb-6 sm:text-xl">Current Address</h2>

                        <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-3 sm:gap-4">
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    House No./Street
                                </label>
                                <InputText @bind-Value="Model.CurrentHouseNo"
                                           class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base"
                                           placeholder="e.g. 123" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Street Name
                                </label>
                                <InputText @bind-Value="Model.CurrentStreetName"
                                           class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base"
                                           placeholder="e.g. Rizal Street" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Barangay <span class="text-red-500">*</span>
                                </label>
                                <InputText @bind-Value="Model.CurrentBarangay"
                                           class="@GetInputClass(nameof(Model.CurrentBarangay))"
                                           placeholder="Barangay" />
                                <ValidationMessage For="@(() => Model.CurrentBarangay)" class="text-red-500 text-xs mt-1" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4 lg:grid-cols-4">
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Province <span class="text-red-500">*</span>
                                </label>
                                <InputText @bind-Value="Model.CurrentProvince"
                                           class="@GetInputClass(nameof(Model.CurrentProvince))"
                                           placeholder="Province" />
                                <ValidationMessage For="@(() => Model.CurrentProvince)" class="text-red-500 text-xs mt-1" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Municipality/City <span class="text-red-500">*</span>
                                </label>
                                <InputText @bind-Value="Model.CurrentCity"
                                           class="@GetInputClass(nameof(Model.CurrentCity))"
                                           placeholder="City / Municipality" />
                                <ValidationMessage For="@(() => Model.CurrentCity)" class="text-red-500 text-xs mt-1" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Country <span class="text-red-500">*</span>
                                </label>
                                <InputText @bind-Value="Model.CurrentCountry"
                                           class="@GetInputClass(nameof(Model.CurrentCountry))"
                                           placeholder="Country" />
                                <ValidationMessage For="@(() => Model.CurrentCountry)" class="text-red-500 text-xs mt-1" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    ZIP Code <span class="text-red-500">*</span>
                                </label>
                                <InputText @bind-Value="Model.CurrentZipCode"
                                           maxlength="10"
                                           onkeypress="return /[0-9]/i.test(event.key) || event.key === 'Backspace' || event.key === 'Delete' || event.key === 'ArrowLeft' || event.key === 'ArrowRight'"
                                           class="@GetInputClass(nameof(Model.CurrentZipCode))"
                                           placeholder="ZIP Code" />
                                <ValidationMessage For="@(() => Model.CurrentZipCode)" class="text-red-500 text-xs mt-1" />
                            </div>
                        </div>
                    </div>

                    <!-- Permanent Address (Same as current toggle, simplified inputs) -->
                    <hr class="my-6 border-gray-200 sm:my-8" />
                    <div class="mb-6 sm:mb-8">
                        <h2 class="mb-4 text-lg font-bold text-blue-600 sm:mb-6 sm:text-xl">Permanent Address</h2>

                        <div class="mb-3 sm:mb-4">
                            <label class="flex cursor-pointer items-center">
                                <InputCheckbox @bind-Value="Model.SameAsCurrentAddress"
                                               @bind-Value:after="HandleSameAsCurrentAddressChanged"
                                               class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                <span class="ml-2 text-xs font-medium text-gray-700 sm:text-sm">
                                    Same with your Current Address?
                                </span>
                            </label>
                        </div>

                        <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-3 sm:gap-4">
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    House No./Street
                                </label>
                                <InputText @bind-Value="Model.PermanentHouseNo"
                                           disabled="Model.SameAsCurrentAddress"
                                           class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed sm:px-4 sm:py-2.5 sm:text-base"
                                           placeholder="House No./Street" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Street Name
                                </label>
                                <InputText @bind-Value="Model.PermanentStreetName"
                                           disabled="Model.SameAsCurrentAddress"
                                           class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed sm:px-4 sm:py-2.5 sm:text-base"
                                           placeholder="Street Name" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Barangay
                                </label>
                                <InputText @bind-Value="Model.PermanentBarangay"
                                           disabled="Model.SameAsCurrentAddress"
                                           class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed sm:px-4 sm:py-2.5 sm:text-base"
                                           placeholder="Barangay" />
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4 lg:grid-cols-4">
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Province
                                </label>
                                <InputText @bind-Value="Model.PermanentProvince"
                                           disabled="Model.SameAsCurrentAddress"
                                           class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed sm:px-4 sm:py-2.5 sm:text-base"
                                           placeholder="Province" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Municipality/City
                                </label>
                                <InputText @bind-Value="Model.PermanentCity"
                                           disabled="Model.SameAsCurrentAddress"
                                           class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed sm:px-4 sm:py-2.5 sm:text-base"
                                           placeholder="City / Municipality" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Country
                                </label>
                                <InputText @bind-Value="Model.PermanentCountry"
                                           disabled="Model.SameAsCurrentAddress"
                                           class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed sm:px-4 sm:py-2.5 sm:text-base"
                                           placeholder="Country" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    ZIP Code
                                </label>
                                <InputText @bind-Value="Model.PermanentZipCode"
                                           disabled="Model.SameAsCurrentAddress"
                                           maxlength="10"
                                           onkeypress="return /[0-9]/i.test(event.key) || event.key === 'Backspace' || event.key === 'Delete' || event.key === 'ArrowLeft' || event.key === 'ArrowRight'"
                                           class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed sm:px-4 sm:py-2.5 sm:text-base"
                                           placeholder="ZIP Code" />
                            </div>
                        </div>
                    </div>

                    <!-- Guardian Information (mirrors StudentRegistration, simplified) -->
                    <hr class="my-6 border-gray-200 sm:my-8" />

                    <div class="mb-6 sm:mb-8">
                        <h2 class="mb-4 text-lg font-bold text-blue-600 sm:mb-6 sm:text-xl">Guardian Information</h2>

                        <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-2 sm:gap-4 lg:grid-cols-4">
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    First Name <span class="text-red-500">*</span>
                                </label>
                                <InputText @bind-Value="Model.GuardianFirstName"
                                           @bind-Value:after="() => { FormatGuardianFirstName(); StateHasChanged(); }"
                                           class="@GetInputClass(nameof(Model.GuardianFirstName))" />
                                <ValidationMessage For="@(() => Model.GuardianFirstName)" class="text-red-500 text-xs mt-1" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Middle Name</label>
                                <InputText @bind-Value="Model.GuardianMiddleName"
                                           @bind-Value:after="FormatGuardianMiddleName"
                                           class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Last Name <span class="text-red-500">*</span>
                                </label>
                                <InputText @bind-Value="Model.GuardianLastName"
                                           @bind-Value:after="() => { FormatGuardianLastName(); StateHasChanged(); }"
                                           class="@GetInputClass(nameof(Model.GuardianLastName))" />
                                <ValidationMessage For="@(() => Model.GuardianLastName)" class="text-red-500 text-xs mt-1" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Suffix
                                </label>
                                <InputSelect @bind-Value="Model.GuardianSuffix"
                                             class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base">
                                    <option value="">N/A</option>
                                    <option value="Jr.">Jr.</option>
                                    <option value="Sr.">Sr.</option>
                                    <option value="II">II</option>
                                    <option value="III">III</option>
                                    <option value="IV">IV</option>
                                </InputSelect>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4">
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Contact Number <span class="text-red-500">*</span>
                                </label>
                                <InputText @bind-Value="Model.GuardianContactNumber"
                                           @bind-Value:after="() => { if (EditContext != null) EditContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(EditContext.Model, nameof(Model.GuardianContactNumber))); StateHasChanged(); }"
                                           maxlength="11"
                                           onkeypress="return /[0-9]/i.test(event.key) || event.key === 'Backspace' || event.key === 'Delete' || event.key === 'ArrowLeft' || event.key === 'ArrowRight'"
                                           class="@GetInputClass(nameof(Model.GuardianContactNumber))"
                                           placeholder="e.g. 09123456789" />
                                <ValidationMessage For="@(() => Model.GuardianContactNumber)" class="text-red-500 text-xs mt-1" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Relationship <span class="text-red-500">*</span>
                                </label>
                                <InputSelect @bind-Value="Model.GuardianRelationship"
                                             class="@GetInputClass(nameof(Model.GuardianRelationship))">
                                    <option value="">Select Relationship</option>
                                    <option value="Father">Father</option>
                                    <option value="Mother">Mother</option>
                                    <option value="Guardian">Guardian</option>
                                    <option value="Other">Other</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => Model.GuardianRelationship)" class="text-red-500 text-xs mt-1" />
                            </div>
                            @if (Model.GuardianRelationship == "Other")
                            {
                                <div>
                                    <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                        Please specify:
                                    </label>
                                    <InputText @bind-Value="Model.GuardianRelationshipOther"
                                               class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base"
                                               placeholder="e.g. Yaya" />
                                </div>
                            }
                        </div>
                    </div>

                    <hr class="my-6 border-gray-200 sm:my-8" />

                    <!-- Enrollment Details & Requirements -->
                    <div class="mb-6 sm:mb-8">
                        <h2 class="mb-4 text-lg font-bold text-blue-600 sm:mb-6 sm:text-xl">Enrollment Details</h2>

                        <div class="mb-4">
                            <label class="mb-2 block text-xs font-medium text-gray-700 sm:mb-3 sm:text-sm">
                                Student Type <span class="text-red-500">*</span>
                            </label>
                            <InputRadioGroup @bind-Value="Model.StudentType">
                                <div class="flex flex-wrap gap-4 sm:gap-6">
                                    <label class="flex cursor-pointer items-center">
                                        <InputRadio Value="@("New Student")" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">New Student</span>
                                    </label>
                                    <label class="flex cursor-pointer items-center">
                                        <InputRadio Value="@("Returnee")" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">Returnee</span>
                                    </label>
                                    <label class="flex cursor-pointer items-center">
                                        <InputRadio Value="@("Transferee")" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">Transferee</span>
                                    </label>
                                </div>
                            </InputRadioGroup>
                            <ValidationMessage For="@(() => Model.StudentType)" class="text-red-500 text-xs mt-1" />
                        </div>

                        <div class="mb-4 grid grid-cols-1 gap-3 sm:mb-6 sm:grid-cols-2 sm:gap-4 lg:grid-cols-4">
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    With LRN?
                                </label>
                                <InputRadioGroup @bind-Value="Model.HasLRN" @bind-Value:after="HandleHasLRNChange">
                                    <div class="flex items-center gap-3 pt-1 sm:gap-4 sm:pt-2">
                                        <label class="flex cursor-pointer items-center">
                                            <InputRadio Value="@("Yes")" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500" />
                                            <span class="ml-2 text-xs text-gray-700 sm:text-sm">Yes</span>
                                        </label>
                                        <label class="flex cursor-pointer items-center">
                                            <InputRadio Value="@("No")" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500" />
                                            <span class="ml-2 text-xs text-gray-700 sm:text-sm">No</span>
                                        </label>
                                    </div>
                                </InputRadioGroup>
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    LRN
                                </label>
                                <InputText @bind-Value="Model.LearnerReferenceNo"
                                           @bind-Value:after="() => { HandleLRNChange(); if (EditContext != null) EditContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(EditContext.Model, nameof(Model.LearnerReferenceNo))); StateHasChanged(); }"
                                           disabled="@(Model.HasLRN != "Yes")"
                                           maxlength="12"
                                           onkeypress="return /[0-9]/i.test(event.key)"
                                           class="@($"{GetInputClass(nameof(Model.LearnerReferenceNo))} disabled:cursor-not-allowed disabled:bg-gray-100")"
                                           placeholder="e.g. 123456789012" />
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    School Year <span class="text-red-500">*</span>
                                </label>
                                <InputSelect @bind-Value="Model.SchoolYear"
                                             disabled="@IsReEnrollContext"
                                             class="@($"w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base {(IsReEnrollContext ? "disabled:cursor-not-allowed disabled:bg-gray-100" : "")}")">
                                    <option value="">Select School Year</option>
                                    @foreach (var sy in AvailableSchoolYears)
                                    {
                                        <option value="@sy" selected="@(Model != null && string.Equals(sy, Model.SchoolYear, StringComparison.OrdinalIgnoreCase))">@sy</option>
                                    }
                                    @* If student's current school year from tbl_Student is not in AvailableSchoolYears, add it as an option *@
                                    @* This ensures the student's current school year is always visible and selectable *@
                                    @if (Model != null && !string.IsNullOrWhiteSpace(Model.SchoolYear) && 
                                         !AvailableSchoolYears.Any(sy => string.Equals(sy?.Trim(), Model.SchoolYear?.Trim(), StringComparison.OrdinalIgnoreCase)))
                                    {
                                        <option value="@Model.SchoolYear" selected>@Model.SchoolYear</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => Model.SchoolYear)" class="text-red-500 text-xs mt-1" />
                                @if (IsReEnrollContext)
                                {
                                    <p class="mt-1 text-xs text-gray-500">School year cannot be changed for enrolled students.</p>
                                }
                            </div>
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Grade to Enroll <span class="text-red-500">*</span>
                                </label>
                                <InputSelect @bind-Value="Model.GradeToEnroll"
                                             disabled="@IsReEnrollContext"
                                             class="@($"w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base {(IsReEnrollContext ? "disabled:cursor-not-allowed disabled:bg-gray-100" : "")}")">
                                    <option value="">Select Grade</option>
                                    @* Display all grade levels from tbl_GradeLevel *@
                                    @foreach (var gradeLevel in AvailableGradeLevels)
                                    {
                                        <option value="@gradeLevel.GradeLevelName" selected="@(Model != null && gradeLevel.GradeLevelName != null && string.Equals(gradeLevel.GradeLevelName, Model.GradeToEnroll, StringComparison.OrdinalIgnoreCase))">@gradeLevel.GradeLevelName</option>
                                    }
                                    @* If student's current grade level from tbl_Student is not in AvailableGradeLevels, add it as an option *@
                                    @* This ensures the student's current grade level is always visible and selectable *@
                                    @if (Model != null && !string.IsNullOrWhiteSpace(Model.GradeToEnroll) && 
                                         !AvailableGradeLevels.Any(g => g.GradeLevelName != null && 
                                                                       string.Equals(g.GradeLevelName.Trim(), Model.GradeToEnroll.Trim(), StringComparison.OrdinalIgnoreCase)))
                                    {
                                        <option value="@Model.GradeToEnroll" selected>@Model.GradeToEnroll</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => Model.GradeToEnroll)" class="text-red-500 text-xs mt-1" />
                                @if (IsReEnrollContext)
                                {
                                    <p class="mt-1 text-xs text-gray-500">Grade level cannot be changed for enrolled students.</p>
                                }
                            </div>
                        </div>

                        <!-- Requirements - mirror StudentRegistration checkboxes with type logic -->
                        <div class="mb-4 rounded-lg border border-gray-200 bg-gray-50 p-3 sm:p-4">
                            <label class="mb-2 block text-xs font-medium text-gray-700 sm:mb-3 sm:text-sm">
                                Requirements
                            </label>
                            <div class="space-y-2">
                                @if (Model.StudentType == "New Student")
                                {
                                    <label class="flex cursor-pointer items-center">
                                        <InputCheckbox @bind-Value="Model.HasPSABirthCert"
                                                       class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">
                                            PSA Birth Certificate (photocopy &amp; original for verification)
                                        </span>
                                    </label>
                                    <label class="flex cursor-pointer items-center">
                                        <InputCheckbox @bind-Value="Model.HasBaptismalCert"
                                                       class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">
                                            Baptismal Certificate (if applicable, for Catholic schools)
                                        </span>
                                    </label>
                                    <label class="flex cursor-pointer items-center">
                                        <InputCheckbox @bind-Value="Model.HasReportCard"
                                                       class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">
                                            Report Card / Form 138 (from preschool if available)
                                        </span>
                                    </label>
                                }
                                else if (Model.StudentType == "Transferee")
                                {
                                    <label class="flex cursor-pointer items-center">
                                        <InputCheckbox @bind-Value="Model.HasPSABirthCert"
                                                       class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">
                                            PSA Birth Certificate
                                        </span>
                                    </label>
                                    <label class="flex cursor-pointer items-center">
                                        <InputCheckbox @bind-Value="Model.HasBaptismalCert"
                                                       class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">
                                            Baptismal Certificate (if applicable)
                                        </span>
                                    </label>
                                    <label class="flex cursor-pointer items-center">
                                        <InputCheckbox @bind-Value="Model.HasForm138"
                                                       class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">
                                            Form 138 (Report Card)
                                        </span>
                                    </label>
                                    <label class="flex cursor-pointer items-center">
                                        <InputCheckbox @bind-Value="Model.HasForm137"
                                                       class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">
                                            Form 137 (Permanent Record)
                                        </span>
                                    </label>
                                    <label class="flex cursor-pointer items-center">
                                        <InputCheckbox @bind-Value="Model.HasGoodMoralCert"
                                                       class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">
                                            Certificate of Good Moral Character
                                        </span>
                                    </label>
                                    <label class="flex cursor-pointer items-center">
                                        <InputCheckbox @bind-Value="Model.HasTransferCert"
                                                       class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">
                                            Transfer Certificate / Honorable Dismissal
                                        </span>
                                    </label>
                                }
                                else if (Model.StudentType == "Returnee")
                                {
                                    <label class="flex cursor-pointer items-center">
                                        <InputCheckbox @bind-Value="Model.HasForm138"
                                                       class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">
                                            Form 138 (Report Card)
                                        </span>
                                    </label>
                                    <label class="flex cursor-pointer items-center">
                                        <InputCheckbox @bind-Value="Model.HasUpdatedEnrollmentForm"
                                                       class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">
                                            Updated Enrollment Form
                                        </span>
                                    </label>
                                    <label class="flex cursor-pointer items-center">
                                        <InputCheckbox @bind-Value="Model.HasClearance"
                                                       class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <span class="ml-2 text-xs text-gray-700 sm:text-sm">
                                            Clearance (if required)
                                        </span>
                                    </label>
                                }
                            </div>
                        </div>

                        <!-- Status field - moved below Requirements -->
                        <div class="mb-4 grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4">
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Application Status <span class="text-red-500">*</span>
                                </label>
                                @if (IsForEnrollmentContext && (Model.Status == "Partially Paid" || Model.Status == "Fully Paid"))
                                {
                                    @* Disable dropdown for payment statuses - they are auto-set by payment system *@
                                    <select @bind="Model.Status" 
                                            disabled
                                            class="@GetStatusSelectClass()">
                                        <option value="@Model.Status" selected style="@(Model.Status == "Partially Paid" ? "background-color: #fed7aa; color: #9a3412;" : "background-color: #dcfce7; color: #166534;")">@Model.Status</option>
                                    </select>
                                }
                                else
                                {
                                    <select @bind="Model.Status" 
                                            @bind:after="HandleStatusChange"
                                            class="@GetStatusSelectClass()">
                        @if (IsForEnrollmentContext)
                        {
                            @if (IsReEnrollContext)
                            {
                                <!-- Show current status (e.g., Enrolled) and allow switching to Re-enroll (Eligible) -->
                                <option value="@Model.Status" disabled>@Model.Status</option>
                                <option value="Eligible" style="background-color: #e0f2fe; color: #075985;">Re-enroll (Eligible)</option>
                            }
                            else
                            {
                                @* For enrollment context, show appropriate options based on current status *@
                                @if (Model.Status == "Enrolled")
                                {
                                    @* If already enrolled, show enrolled as selected and allow other actions *@
                                    <option value="Enrolled" selected style="background-color: #dcfce7; color: #166534;">Enrolled</option>
                                    <option value="Rejected by School" style="background-color: #fee2e2; color: #991b1b;">Reject</option>
                                    <option value="Application Withdrawn" style="background-color: #fed7aa; color: #9a3412;">Withdraw</option>
                                }
                                else
                                {
                                    @* For other statuses (For Payment, etc.), show all standard options *@
                                    <option value="For Payment" style="background-color: #dbeafe; color: #1e40af;" selected="@(Model.Status == "For Payment")">For Payment</option>
                                    <option value="Enrolled" style="background-color: #dcfce7; color: #166534;">Enrolled</option>
                                    <option value="Rejected by School" style="background-color: #fee2e2; color: #991b1b;">Reject</option>
                                    <option value="Application Withdrawn" style="background-color: #fed7aa; color: #9a3412;">Withdraw</option>
                                }
                            }
                        }
                        else
                        {
                            <option value="Pending" style="background-color: #fef3c7; color: #92400e;">Pending</option>
                            <option value="For Payment" style="background-color: #dbeafe; color: #1e40af;">For Payment</option>
                            <option value="Rejected by School" style="background-color: #fee2e2; color: #991b1b;">Reject</option>
                            <option value="Application Withdrawn" style="background-color: #fed7aa; color: #9a3412;">Withdraw</option>
                        }
                                    </select>
                                }
                                @* Show informational message when status is payment-related *@
                                @if (IsForEnrollmentContext && (Model.Status == "Partially Paid" || Model.Status == "Fully Paid"))
                                {
                                    <p class="mt-1 text-xs text-gray-500">Payment status: <strong>@Model.Status</strong>. This status is automatically set by the payment system. Use the "Enroll Student" button below to complete enrollment.</p>
                                }
                                
                                <!-- Display error if trying to enroll without payment -->
                                @if (ShowEnrollmentError && IsForEnrollmentContext)
                                {
                                    <div class="mt-2 rounded-lg border border-red-200 bg-red-50 p-3">
                                        <p class="text-sm text-red-600">
                                            <strong>Cannot enroll student:</strong> Student must have "Partially Paid" or "Fully Paid" status to be enrolled. Please process payment first.
                                        </p>
                                    </div>
                                }
                                
                                <!-- Display reason if status is Reject or Withdraw and reason exists -->
                                @if ((Model.Status == "Rejected by School" || Model.Status == "Application Withdrawn") && !string.IsNullOrWhiteSpace(Model.RejectionReason))
                                {
                                    <div class="mt-3 rounded-lg border p-3 @(Model.Status == "Rejected by School" ? "border-red-200 bg-red-50" : "border-orange-200 bg-orange-50")">
                                        <label class="mb-1 block text-xs font-semibold text-gray-700">
                                            Reason:
                                        </label>
                                        <p class="text-sm text-gray-800 whitespace-pre-wrap">@Model.RejectionReason</p>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

            <!-- Actions -->
            <div class="mt-4 flex flex-col justify-end gap-3 sm:flex-row sm:gap-4">
                <button type="button"
                        @onclick="OnCancelClicked"
                        class="min-w-[120px] rounded-lg bg-gray-500 px-5 py-2 text-sm font-semibold text-white shadow-md transition-all duration-300 hover:bg-gray-600 hover:shadow-lg">
                    Cancel
                </button>

                @if (Model != null && Model.Status == "For Payment")
                {
                    <button type="button"
                            @onclick="PrintPaymentSlip"
                            disabled="@IsGeneratingPdf"
                            class="min-w-[160px] rounded-lg bg-green-600 px-5 py-2 text-sm font-semibold text-white shadow-md transition-all duration-300 hover:bg-green-700 hover:shadow-lg disabled:cursor-not-allowed disabled:opacity-50">
                        @if (IsGeneratingPdf)
                        {
                            <span class="inline-flex items-center">
                                <svg class="-ml-1 mr-2 h-4 w-4 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Generating...
                            </span>
                        }
                        else
                        {
                            <span class="inline-flex items-center">
                                <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                </svg>
                                Print Payment Slip
                            </span>
                        }
                    </button>
                }

                @if (IsForEnrollmentContext && Model != null && (Model.Status == "Partially Paid" || Model.Status == "Fully Paid"))
                {
                    <button type="button"
                            @onclick="OpenEnrollModal"
                            class="min-w-[140px] rounded-lg bg-green-600 px-5 py-2 text-sm font-semibold text-white shadow-md transition-all duration-300 hover:bg-green-700 hover:shadow-lg">
                        Enroll Student
                    </button>
                }

                <button type="button"
                        @onclick="OnSaveClicked"
                        disabled="@IsSaving"
                        class="min-w-[120px] rounded-lg bg-blue-600 px-5 py-2 text-sm font-semibold text-white shadow-md transition-all duration-300 hover:bg-blue-700 hover:shadow-lg disabled:cursor-not-allowed disabled:opacity-50">
                    @if (IsSaving)
                    {
                        <span class="inline-flex items-center">
                            <svg class="-ml-1 mr-2 h-4 w-4 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Saving...
                        </span>
                    }
                    else
                    {
                        <span>Save Changes</span>
                    }
                </button>
            </div>
                </EditForm>
            }
        </div>
    </div>
</div>
}

@* Enrollment Assignment Modal *@
@if (ShowEnrollModal && Model != null)
{
    <div class="fixed inset-0 z-[55] flex items-center justify-center bg-black bg-opacity-50" @onclick="CloseEnrollModal">
        <div class="relative w-full max-w-3xl max-h-[90vh] flex flex-col rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <!-- Header - Fixed, not scrollable -->
            <div class="flex items-center justify-between border-b border-gray-200 px-6 py-3 bg-green-600 rounded-t-2xl flex-shrink-0">
                <div>
                    <h2 class="text-lg font-semibold text-white">Enroll Student to Section</h2>
                    <p class="text-xs text-green-100">Assign the student to a section and review the adviser, schedule, and available slots.</p>
                </div>
                <button @onclick="CloseEnrollModal"
                        class="rounded-full p-1 text-white hover:bg-green-700">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Body - Scrollable -->
            <div class="px-6 py-4 space-y-4 overflow-y-auto flex-1">
                <!-- Student & Grade Info -->
                <div class="rounded-lg border border-gray-200 bg-gray-50 p-3 sm:p-4">
                    <p class="text-sm font-semibold text-gray-800">
                        @Model.FirstName @Model.MiddleName @Model.LastName (@Model.StudentId)
                    </p>
                    <p class="mt-1 text-xs text-gray-600">
                        Grade to Enroll: <span class="font-semibold">@Model.GradeToEnroll</span> |
                        School Year: <span class="font-semibold">@Model.SchoolYear</span>
                    </p>
                    <p class="mt-1 text-xs text-gray-600">
                        Current Status: <span class="font-semibold">@Model.Status</span> |
                        Payment Status: <span class="font-semibold">@((Model.Status == "Fully Paid" || Model.Status == "Partially Paid") ? Model.Status : "N/A")</span>
                    </p>
                </div>

                <!-- Section selection -->
                <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4">
                    <div>
                        <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                            Section <span class="text-red-500">*</span>
                        </label>
                        <InputSelect @bind-Value="SelectedSectionId"
                                     @bind-Value:after="OnSectionChanged"
                                     class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base">
                            @if (AvailableSections.Count == 0)
                            {
                                <option value="">No sections available</option>
                            }
                            else
                            {
                                @foreach (var sec in AvailableSections)
                                {
                                    <option value="@sec.SectionId">@sec.SectionName</option>
                                }
                            }
                        </InputSelect>
                        @if (AvailableSlots.HasValue)
                        {
                            <p class="mt-1 text-xs text-gray-600">
                                Capacity: <span class="font-semibold">@SelectedSectionCapacity</span> |
                                Enrolled: <span class="font-semibold">@SelectedSectionEnrolledCount</span> |
                                Available Slots: <span class="font-semibold">@AvailableSlots</span>
                            </p>
                        }
                    </div>
                    <div class="flex flex-col">
                        <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                            Adviser
                        </label>
                        <div class="rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-800 sm:px-4 sm:py-2.5 sm:text-base flex items-center">
                            <span>@(!string.IsNullOrWhiteSpace(SelectedSectionAdviser) ? SelectedSectionAdviser : "N/A")</span>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(SelectedSectionRoom))
                        {
                            <p class="mt-1 text-xs text-gray-600">
                                Room: <span class="font-semibold">@SelectedSectionRoom</span>
                            </p>
                        }
                    </div>
                </div>

                <!-- Schedule preview -->
                <div class="mt-2">
                    <label class="mb-2 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                        Section Schedule
                    </label>
                    @if (IsLoadingSectionDetails)
                    {
                        <div class="flex items-center gap-2 text-xs text-gray-500">
                            <svg class="h-4 w-4 animate-spin text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading schedule...
                        </div>
                    }
                    else if (UnifiedScheduleRows.Any())
                    {
                        <div class="max-h-64 overflow-y-auto rounded-lg border border-gray-200 bg-white">
                            <table class="min-w-full text-xs sm:text-sm">
                                <thead class="sticky top-0 bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-semibold text-gray-700">Subject</th>
                                        <th class="px-3 py-2 text-left font-semibold text-gray-700">Schedule</th>
                                        <th class="px-3 py-2 text-left font-semibold text-gray-700">Teacher</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    @foreach (var row in UnifiedScheduleRows)
                                    {
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-3 py-1.5 text-gray-800">@row.Subject</td>
                                            <td class="px-3 py-1.5 text-gray-700">@row.DayPattern: @row.TimeRange</td>
                                            <td class="px-3 py-1.5 text-gray-700">@row.Teacher</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-xs text-gray-500">No schedule has been configured for this section yet.</p>
                    }
                </div>
            </div>

            <!-- Footer - Fixed, not scrollable -->
            <div class="flex justify-end gap-3 border-t border-gray-200 bg-gray-50 px-6 py-3 rounded-b-2xl flex-shrink-0">
                <button type="button"
                        @onclick="CloseEnrollModal"
                        class="min-w-[100px] rounded-lg bg-gray-200 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-300">
                    Close
                </button>
                <button type="button"
                        @onclick="ConfirmEnrollStudent"
                        disabled="@(SelectedSectionId == null || AvailableSections.Count == 0)"
                        class="min-w-[140px] rounded-lg bg-green-600 px-4 py-2 text-sm font-semibold text-white shadow-md transition-all duration-300 hover:bg-green-700 hover:shadow-lg disabled:cursor-not-allowed disabled:opacity-50">
                    Confirm Enrollment
                </button>
            </div>
        </div>
    </div>
}

<!-- Archive Confirmation Modal -->
@if (ShowRejectionModal && Model != null)
{
    <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-50" @onclick="CloseRejectionModal">
        <div class="relative w-full max-w-md rounded-2xl bg-white shadow-xl" @onclick:stopPropagation="true">
            <!-- Header - Dynamic background based on status -->
            <div class="flex items-center justify-between px-4 py-2.5 rounded-t-2xl @(Model.Status == "Rejected by School" ? "bg-red-600" : "bg-orange-600")">
                <h2 class="text-lg font-semibold text-white">@(Model.Status == "Rejected by School" ? "Reject Application" : "Withdraw Application")</h2>
                <button @onclick="CloseRejectionModal"
                        class="rounded-full p-1 text-white hover:opacity-80 transition-colors">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Body -->
            <div class="px-4 py-4">
                <!-- Descriptive text -->
                <p class="mb-3 text-sm text-gray-700">
                    You are about to <strong>@(Model.Status == "Rejected by School" ? "reject" : "withdraw")</strong> <strong>@GetStudentFullName()</strong>'s application. Please provide a reason for this action:
                </p>

                <!-- Student info box -->
                <div class="mb-3 rounded-lg bg-gray-50 border border-gray-200 p-2.5">
                    <p class="text-xs font-medium text-gray-500 mb-0.5">@(Model.Status == "Rejected by School" ? "Rejecting" : "Withdrawing") application:</p>
                    <p class="text-sm font-semibold text-gray-900">@GetStudentFullName()</p>
                    <p class="text-xs text-gray-600">ID: @Model.StudentId</p>
                </div>

                <!-- Reason field -->
                <div class="mb-0">
                    <label class="mb-1.5 block text-sm font-semibold text-gray-700">
                        Reason <span class="text-red-500">*</span>
                    </label>
                    <textarea @bind="RejectionReason"
                              @bind:after="StateHasChanged"
                              rows="4"
                              class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 focus:border-red-500 focus:outline-none focus:ring-2 focus:ring-red-200 resize-y"
                              placeholder="Enter the reason for @(Model.Status == "Rejected by School" ? "rejecting" : "withdrawing") this application..."></textarea>
                    @if (string.IsNullOrWhiteSpace(RejectionReason) && ShowRejectionError)
                    {
                        <p class="mt-1 text-xs text-red-600">Reason is required</p>
                    }
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-end gap-3 border-t border-gray-200 bg-gray-50 px-4 py-3 rounded-b-2xl">
                <button type="button"
                        @onclick="ConfirmRejection"
                        class="min-w-[100px] rounded-lg px-5 py-2 text-sm font-semibold text-white shadow-md transition-all duration-300 @(Model.Status == "Rejected by School" ? "bg-red-600 hover:bg-red-700" : "bg-orange-600 hover:bg-orange-700")">
                    Confirm
                </button>
            </div>
        </div>
    </div>
}

<style>
    .modal-scroll {
        scrollbar-width: none;
    }

    .modal-scroll::-webkit-scrollbar {
        display: none;
    }

    /* Color-coded status options */
    select option.status-pending {
        background-color: #fef3c7 !important;
        color: #92400e !important;
    }

    select option.status-for-enrollment {
        background-color: #dbeafe !important;
        color: #1e40af !important;
    }

    select option.status-rejected {
        background-color: #fee2e2 !important;
        color: #991b1b !important;
    }

    /* Ensure options are visible when dropdown is open */
    select option {
        padding: 8px 12px;
    }
</style>

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public StudentEditModel? Model { get; set; }
    [Parameter] public bool IsForEnrollmentContext { get; set; } = false;
    // When true, modal is opened from Enrolled tab for re-enrollment; limit status options.
    [Parameter] public bool IsReEnrollContext { get; set; } = false;
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<StudentEditModel> OnSave { get; set; }

    private EditContext? EditContext;
    private bool IsSaving { get; set; }
    private bool IsGeneratingPdf { get; set; } = false;
    private bool ShowRejectionModal { get; set; } = false;
    private string RejectionReason { get; set; } = string.Empty;
    private bool ShowRejectionError { get; set; } = false;
    private bool ShowEnrollmentError { get; set; } = false;
    private string? PreviousStatus { get; set; }

    private List<string> AvailableSchoolYears { get; set; } = new();
    private List<GradeLevel> AvailableGradeLevels { get; set; } = new();

    [Inject] private SchoolYearService SchoolYearService { get; set; } = null!;
    [Inject] private CurriculumService CurriculumService { get; set; } = null!;
    [Inject] private PaymentSlipPdfGenerator PaymentSlipPdfGenerator { get; set; } = null!;
    [Inject] private IJSRuntime JSRuntime { get; set; } = null!;
    [Inject] private ILogger<NewApplicantEditModal>? Logger { get; set; }

    // Enroll modal state
    private bool ShowEnrollModal { get; set; } = false;
    private List<Section> AvailableSections { get; set; } = new();
    private int? SelectedSectionId { get; set; }
    private bool IsLoadingSectionDetails { get; set; } = false;
    private List<FinalClassView> SectionSchedule { get; set; } = new();
    private string SelectedSectionAdviser { get; set; } = string.Empty;
    private int? AvailableSlots { get; set; }
    private int SelectedSectionCapacity { get; set; }
    private int SelectedSectionEnrolledCount { get; set; }
    private string SelectedSectionRoom { get; set; } = string.Empty;

    // Flattened schedule rows for display
    private class ScheduleRow
    {
        public string Subject { get; set; } = string.Empty;
        public string TimeRange { get; set; } = string.Empty;
        public string DayPattern { get; set; } = string.Empty;
        public string Teacher { get; set; } = string.Empty;
        public string Room { get; set; } = string.Empty;
    }

    private List<ScheduleRow> KinderScheduleRows { get; set; } = new();
    private List<ScheduleRow> ElementaryScheduleRows { get; set; } = new();
    private List<ScheduleRow> UnifiedScheduleRows { get; set; } = new();

    private bool IsKinderOrPreSchool =>
        Model != null && IsKinderOrPreSchoolGrade(Model.GradeToEnroll);

    protected override async Task OnInitializedAsync()
    {
        // Load school years
        AvailableSchoolYears = await SchoolYearService.GetAvailableSchoolYearsAsync();

        // Load grade levels for dropdown
        await LoadGradeLevelsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Model != null && (EditContext == null || EditContext.Model != Model))
        {
            EditContext = new EditContext(Model);
            PreviousStatus = Model.Status;
            RejectionReason = Model.RejectionReason ?? string.Empty;
        }

        // Reload grade levels and school years when modal is shown to ensure data is fresh
        // This is important if the modal component is reused
        if (Show && Model != null)
        {
            await LoadGradeLevelsAsync();
            AvailableSchoolYears = await SchoolYearService.GetAvailableSchoolYearsAsync();
            
            // CRITICAL: Log the initial state before any modifications
            Logger?.LogInformation(
                "Modal OnParametersSetAsync - Initial Model.SchoolYear={SchoolYear}, Model.GradeToEnroll={GradeToEnroll}",
                Model.SchoolYear, Model.GradeToEnroll);
            
            // CRITICAL: Preserve Model.SchoolYear and Model.GradeToEnroll if they're already set
            // These should come from student.SchoolYr and student.GradeLevel in HandleEnrolledStudentView
            // Only override if they're empty/null
            var originalSchoolYear = Model.SchoolYear;
            var originalGradeToEnroll = Model.GradeToEnroll;
            
            // CRITICAL: Ensure student's school year is in available options BEFORE rendering
            var trimmedSchoolYear = originalSchoolYear?.Trim() ?? string.Empty;
            if (!string.IsNullOrWhiteSpace(trimmedSchoolYear) && 
                !AvailableSchoolYears.Any(sy => string.Equals(sy?.Trim(), trimmedSchoolYear, StringComparison.OrdinalIgnoreCase)))
            {
                AvailableSchoolYears.Add(trimmedSchoolYear);
            }
            
            // CRITICAL: Log the original values BEFORE any modifications
            Logger?.LogInformation(
                "OnParametersSetAsync - ORIGINAL values from Model: SchoolYear='{SchoolYear}', GradeToEnroll='{GradeToEnroll}', IsReEnrollContext={IsReEnrollContext}",
                originalSchoolYear, originalGradeToEnroll, IsReEnrollContext);
            
            // CRITICAL: For enrolled students (IsReEnrollContext), ALWAYS preserve the exact value from tbl_Student
            // DO NOT override it, even if it's not in AvailableSchoolYears
            if (IsReEnrollContext)
            {
                // For enrolled students, preserve the exact value from student.SchoolYr
                // This value comes directly from tbl_Student and must be displayed as-is
                Model.SchoolYear = trimmedSchoolYear;
                Logger?.LogInformation(
                    "IsReEnrollContext=true: Preserving exact SchoolYear from tbl_Student: '{SchoolYear}' (empty={IsEmpty})",
                    Model.SchoolYear, string.IsNullOrWhiteSpace(Model.SchoolYear));
            }
            else
            {
                // For non-enrolled students, preserve the value from database if it exists
                // Only set a default if it's truly empty/null
                if (string.IsNullOrWhiteSpace(trimmedSchoolYear))
                {
                    // If Model.SchoolYear is empty, set it to active school year
                    var activeSchoolYear = await SchoolYearService.GetActiveSchoolYearNameAsync();
                    if (!string.IsNullOrWhiteSpace(activeSchoolYear) && AvailableSchoolYears.Contains(activeSchoolYear))
                    {
                        Model.SchoolYear = activeSchoolYear;
                        Logger?.LogInformation("Model.SchoolYear was empty, set to active school year: {SchoolYear}", activeSchoolYear);
                    }
                    else if (AvailableSchoolYears.Any())
                    {
                        // Fallback to first available school year
                        Model.SchoolYear = AvailableSchoolYears.First();
                        Logger?.LogInformation("Model.SchoolYear was empty, set to first available: {SchoolYear}", Model.SchoolYear);
                    }
                }
                else
                {
                    // CRITICAL: Preserve the student's school year from database
                    Model.SchoolYear = trimmedSchoolYear;
                    Logger?.LogInformation(
                        "Preserving Model.SchoolYear from database: '{SchoolYear}'",
                        Model.SchoolYear);
                }
            }
            
            // CRITICAL: Ensure student's grade level is in available options BEFORE rendering
            var trimmedGradeToEnroll = originalGradeToEnroll?.Trim() ?? string.Empty;
            if (!string.IsNullOrWhiteSpace(trimmedGradeToEnroll) && 
                !AvailableGradeLevels.Any(g => g.GradeLevelName != null && 
                                               string.Equals(g.GradeLevelName.Trim(), trimmedGradeToEnroll, StringComparison.OrdinalIgnoreCase)))
            {
                AvailableGradeLevels.Add(new GradeLevel { GradeLevelName = trimmedGradeToEnroll });
            }
            
            // CRITICAL: Handle GradeToEnroll - ALWAYS preserve the exact value from tbl_Student
            // For enrolled students (IsReEnrollContext), NEVER override, even if it's not in AvailableGradeLevels
            if (IsReEnrollContext)
            {
                // For enrolled students, preserve the exact value from student.GradeLevel
                // This value comes directly from tbl_Student and must be displayed as-is
                Model.GradeToEnroll = trimmedGradeToEnroll;
                Logger?.LogInformation(
                    "IsReEnrollContext=true: Preserving exact GradeToEnroll from tbl_Student: '{GradeLevel}' (empty={IsEmpty})",
                    Model.GradeToEnroll, string.IsNullOrWhiteSpace(Model.GradeToEnroll));
                
                if (string.IsNullOrWhiteSpace(Model.GradeToEnroll))
                {
                    Logger?.LogWarning(
                        "CRITICAL: Model.GradeToEnroll is empty for enrolled student. " +
                        "This might indicate the student's grade level was not set correctly in HandleEnrolledStudentView. " +
                        "Student's grade level from tbl_Student might be null or empty in the database.");
                }
            }
            else
            {
                // For non-enrolled students, preserve the value from database
                Model.GradeToEnroll = trimmedGradeToEnroll;
                
                if (string.IsNullOrWhiteSpace(Model.GradeToEnroll))
                {
                    Logger?.LogWarning(
                        "Model.GradeToEnroll is empty when modal opens. " +
                        "This might indicate the student's grade level was not set correctly in HandleForEnrollmentEdit.");
                }
                else
                {
                    Logger?.LogInformation(
                        "Preserving Model.GradeToEnroll from database: '{GradeLevel}'",
                        Model.GradeToEnroll);
                }
            }
            
            // Log final state to verify values are preserved
            Logger?.LogInformation(
                "Modal OnParametersSetAsync - Final Model.SchoolYear={SchoolYear}, Model.GradeToEnroll={GradeToEnroll}",
                Model.SchoolYear, Model.GradeToEnroll);
            
            // CRITICAL: Force EditContext to recognize the changes and update the UI
            if (EditContext != null)
            {
                EditContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(EditContext.Model, nameof(Model.SchoolYear)));
                EditContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(EditContext.Model, nameof(Model.GradeToEnroll)));
            }
            
            // Force UI update to ensure dropdowns display the correct values
            StateHasChanged();
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Only log on first render to avoid infinite loops
        // The dropdowns should already display correct values from OnParametersSetAsync
        if (firstRender && Show && Model != null && IsReEnrollContext)
        {
            Logger?.LogInformation(
                "OnAfterRenderAsync (firstRender) - Dropdowns should display: SchoolYear={SchoolYear}, GradeToEnroll={GradeToEnroll}",
                Model.SchoolYear, Model.GradeToEnroll);
            
            // CRITICAL: Force another update after first render to ensure dropdowns are properly bound
            // This handles cases where the options load after the initial render
            if (EditContext != null)
            {
                EditContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(EditContext.Model, nameof(Model.SchoolYear)));
                EditContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(EditContext.Model, nameof(Model.GradeToEnroll)));
                StateHasChanged();
            }
        }
        
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task LoadSectionsForEnrollmentAsync()
    {
        AvailableSections = new List<Section>();
        SelectedSectionId = null;
        AvailableSlots = null;
        SelectedSectionAdviser = string.Empty;
        SectionSchedule = new List<FinalClassView>();

        if (Model == null || string.IsNullOrWhiteSpace(Model.GradeToEnroll))
        {
            Logger?.LogWarning("LoadSectionsForEnrollmentAsync: Model or GradeToEnroll is null/empty");
            return;
        }

        // Ensure grade levels are loaded
        if (!AvailableGradeLevels.Any())
        {
            await LoadGradeLevelsAsync();
        }

        // Map grade level name to GradeLevelId using case-insensitive comparison
        var gradeToEnrollTrimmed = Model.GradeToEnroll.Trim();
        var grade = AvailableGradeLevels.FirstOrDefault(g => 
            !string.IsNullOrWhiteSpace(g.GradeLevelName) && 
            string.Equals(g.GradeLevelName.Trim(), gradeToEnrollTrimmed, StringComparison.OrdinalIgnoreCase));

        Logger?.LogInformation(
            "LoadSectionsForEnrollmentAsync: GradeToEnroll='{GradeToEnroll}', Found Grade={Found}, GradeLevelId={GradeLevelId}, AvailableGradeLevels={Count}",
            gradeToEnrollTrimmed, 
            grade != null, 
            grade?.GradeLevelId,
            AvailableGradeLevels.Count);

        if (grade == null)
        {
            Logger?.LogWarning(
                "LoadSectionsForEnrollmentAsync: Could not find grade level matching '{GradeToEnroll}'. Available grades: {AvailableGrades}",
                gradeToEnrollTrimmed,
                string.Join(", ", AvailableGradeLevels.Select(g => g.GradeLevelName)));
        }

        var allSections = await CurriculumService.GetAllSectionsAsync();
        Logger?.LogInformation("LoadSectionsForEnrollmentAsync: Loaded {Count} total sections from database", allSections.Count);

        if (grade != null)
        {
            AvailableSections = allSections
                .Where(s => s.GradeLevelId == grade.GradeLevelId)
                .OrderBy(s => s.SectionName)
                .ToList();
            
            Logger?.LogInformation(
                "LoadSectionsForEnrollmentAsync: Found {Count} sections for GradeLevelId={GradeLevelId} (Grade={GradeName})",
                AvailableSections.Count, 
                grade.GradeLevelId, 
                grade.GradeLevelName);
        }
        else
        {
            // Try to find sections by matching grade level name directly on sections
            AvailableSections = allSections
                .Where(s => s.GradeLevel != null && 
                           !string.IsNullOrWhiteSpace(s.GradeLevel.GradeLevelName) &&
                           string.Equals(s.GradeLevel.GradeLevelName.Trim(), gradeToEnrollTrimmed, StringComparison.OrdinalIgnoreCase))
                .OrderBy(s => s.SectionName)
                .ToList();

            if (!AvailableSections.Any())
            {
                Logger?.LogWarning(
                    "LoadSectionsForEnrollmentAsync: No sections found matching grade '{GradeToEnroll}'. Showing all sections as fallback.",
                    gradeToEnrollTrimmed);
                // Fallback: all sections
                AvailableSections = allSections
                    .OrderBy(s => s.GradeLevelId)
                    .ThenBy(s => s.SectionName)
                    .ToList();
            }
            else
            {
                Logger?.LogInformation(
                    "LoadSectionsForEnrollmentAsync: Found {Count} sections by direct grade name matching",
                    AvailableSections.Count);
            }
        }

        if (AvailableSections.Any())
        {
            // Default to previously selected section if any, otherwise first section
            if (Model.SectionId.HasValue && AvailableSections.Any(s => s.SectionId == Model.SectionId.Value))
            {
                SelectedSectionId = Model.SectionId.Value;
            }
            else
            {
                SelectedSectionId = AvailableSections.First().SectionId;
            }

            await LoadSectionDetailsAsync();
        }
        else
        {
            Logger?.LogWarning("LoadSectionsForEnrollmentAsync: No sections available for enrollment");
        }
    }

    private async Task LoadSectionDetailsAsync()
    {
        if (Model == null || !SelectedSectionId.HasValue)
        {
            return;
        }

        var section = AvailableSections.FirstOrDefault(s => s.SectionId == SelectedSectionId.Value);
        if (section == null)
        {
            return;
        }

        IsLoadingSectionDetails = true;
        AvailableSlots = null;
        SelectedSectionAdviser = string.Empty;
        SelectedSectionRoom = string.Empty;
        SectionSchedule = new List<FinalClassView>();
        KinderScheduleRows = new List<ScheduleRow>();
        ElementaryScheduleRows = new List<ScheduleRow>();
        UnifiedScheduleRows = new List<ScheduleRow>();

        try
        {
            SelectedSectionCapacity = section.Capacity;

            // Compute enrolled count & available slots
            if (!string.IsNullOrWhiteSpace(Model.SchoolYear))
            {
                SelectedSectionEnrolledCount = await CurriculumService.GetSectionEnrollmentCountAsync(section.SectionId, Model.SchoolYear);
                AvailableSlots = Math.Max(0, section.Capacity - SelectedSectionEnrolledCount);
            }

            // Load adviser - first try from section navigation, then from assignments
            if (section.Adviser != null)
            {
                SelectedSectionAdviser = $"{section.Adviser.FirstName} {section.Adviser.LastName}";
            }
            else
            {
                // Fallback: fetch from TeacherSectionAssignment with role "adviser"
                var allAssignments = await CurriculumService.GetAllTeacherAssignmentsAsync();
                var adviserAssignment = allAssignments
                    .FirstOrDefault(a => a.SectionId == section.SectionId && 
                                         !a.IsArchived &&
                                         string.Equals(a.Role, "adviser", StringComparison.OrdinalIgnoreCase));
                
                SelectedSectionAdviser = adviserAssignment?.Teacher != null
                    ? $"{adviserAssignment.Teacher.FirstName} {adviserAssignment.Teacher.LastName}"
                    : string.Empty;
            }

            // Room: use section classroom as primary source
            SelectedSectionRoom = section.Classroom?.RoomName ?? string.Empty;

            // Use final class view for all grade levels (matches curriculum pages)
            var finalClasses = await CurriculumService.GetFinalClassesAsync();
            SectionSchedule = finalClasses
                .Where(fc => !string.IsNullOrWhiteSpace(fc.SectionName) && 
                             fc.SectionName == section.SectionName &&
                             !string.IsNullOrWhiteSpace(fc.GradeLevel) &&
                             fc.GradeLevel == Model.GradeToEnroll &&
                             fc.StartTime.HasValue &&
                             fc.EndTime.HasValue &&
                             !string.IsNullOrWhiteSpace(fc.DayOfWeek))
                .OrderBy(fc => fc.DayOfWeek ?? "")
                .ThenBy(fc => fc.StartTime ?? TimeSpan.Zero)
                .ToList();

            // Fallback room from schedule if needed
            if (string.IsNullOrWhiteSpace(SelectedSectionRoom))
            {
                var firstClassWithRoom = SectionSchedule.FirstOrDefault(fc => !string.IsNullOrWhiteSpace(fc.Classroom));
                SelectedSectionRoom = firstClassWithRoom?.Classroom ?? string.Empty;
            }

            // Build flattened schedule rows for unified display
            if (SectionSchedule.Any())
            {
                UnifiedScheduleRows = BuildScheduleRows(SectionSchedule, includeTeacher: true);
            }
        }
        finally
        {
            IsLoadingSectionDetails = false;
            StateHasChanged();
        }
    }

    private async Task LoadGradeLevelsAsync()
    {
        try
        {
            var gradeLevels = await CurriculumService.GetAllGradeLevelsAsync();
            AvailableGradeLevels = gradeLevels.OrderBy(g => g.GradeLevelId).ToList();
        }
        catch (Exception)
        {
            AvailableGradeLevels = new List<GradeLevel>();
        }
    }

    private async Task OpenEnrollModal()
    {
        if (!IsForEnrollmentContext || Model == null)
        {
            return;
        }

        // Only allow enrollment when payment is at least partial
        if (Model.Status != "Partially Paid" && Model.Status != "Fully Paid")
        {
            return;
        }

        // Ensure grade levels are loaded before loading sections
        if (!AvailableGradeLevels.Any())
        {
            await LoadGradeLevelsAsync();
        }

        Logger?.LogInformation(
            "OpenEnrollModal: Opening enrollment modal for StudentId={StudentId}, GradeToEnroll='{GradeToEnroll}', SchoolYear='{SchoolYear}'",
            Model.StudentId, 
            Model.GradeToEnroll, 
            Model.SchoolYear);

        await LoadSectionsForEnrollmentAsync();
        ShowEnrollModal = true;
        StateHasChanged();
    }

    private async Task OnSectionChanged()
    {
        await LoadSectionDetailsAsync();
    }

    private void CloseEnrollModal()
    {
        ShowEnrollModal = false;
        IsLoadingSectionDetails = false;
    }

    private Task ConfirmEnrollStudent()
    {
        if (Model == null || !SelectedSectionId.HasValue)
        {
            return Task.CompletedTask;
        }

        // Assign selected section to model; StudentService will persist and enforce capacity on save
        Model.SectionId = SelectedSectionId.Value;

        // Update status to Enrolled; SaveEditedApplicantAsync + StudentService.UpdateStudentAsync will persist this
        Model.Status = "Enrolled";
        PreviousStatus = Model.Status;

        ShowEnrollModal = false;
        IsLoadingSectionDetails = false;

        // Refresh status styling
        StateHasChanged();

        return Task.CompletedTask;
    }

    private async Task PrintPaymentSlip()
    {
        if (Model == null || Model.Status != "For Payment")
        {
            return;
        }

        IsGeneratingPdf = true;
        StateHasChanged();

        try
        {
            var studentName = $"{Model.FirstName} {Model.MiddleName} {Model.LastName}".Replace("  ", " ").Trim();
            if (!string.IsNullOrWhiteSpace(Model.Suffix))
            {
                studentName += $" {Model.Suffix}";
            }

            var slipData = new PaymentSlipPdfGenerator.PaymentSlipData
            {
                StudentId = Model.StudentId,
                StudentName = studentName,
                GradeLevel = Model.GradeToEnroll ?? "N/A",
                SchoolYear = Model.SchoolYear ?? "N/A",
                Status = Model.Status,
                DateGenerated = DateTime.Now
            };

            var pdfBytes = PaymentSlipPdfGenerator.GeneratePaymentSlip(slipData);
            var fileName = $"PaymentSlip_{Model.StudentId}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
            var base64Content = Convert.ToBase64String(pdfBytes);
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "application/pdf", base64Content);
        }
        catch (Exception ex)
        {
            // Log error - in a real app you might want to show a toast notification
            Console.WriteLine($"Error generating payment slip: {ex.Message}");
        }
        finally
        {
            IsGeneratingPdf = false;
            StateHasChanged();
        }
    }

    private static bool IsKinderOrPreSchoolGrade(string? gradeName)
    {
        if (string.IsNullOrWhiteSpace(gradeName))
        {
            return false;
        }

        var g = gradeName.ToLowerInvariant();
        return g.Contains("kinder") || g.Contains("pre") || g.Contains("preschool") || g.Contains("pre-school");
    }

    private static string BuildDayPattern(IEnumerable<string?> days)
    {
        var orderedCodes = new[] { "M", "T", "W", "TH", "F", "Sat", "Sun" };
        var normalized = days
            .Where(d => !string.IsNullOrWhiteSpace(d))
            .Select(d => d!.Trim())
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(d =>
            {
                var idx = Array.FindIndex(orderedCodes, c => c.Equals(d, StringComparison.OrdinalIgnoreCase));
                return idx < 0 ? int.MaxValue : idx;
            })
            .ToList();

        // Map TH -> Th for readability and join with commas (e.g., "M, T, W")
        var mapped = normalized.Select(d =>
            d.Equals("TH", StringComparison.OrdinalIgnoreCase) ? "Th" : d);

        return string.Join(", ", mapped);
    }

    private static List<ScheduleRow> BuildScheduleRows(List<FinalClassView> rawSchedule, bool includeTeacher)
    {
        var rows = new List<ScheduleRow>();

        if (rawSchedule == null || !rawSchedule.Any())
        {
            return rows;
        }

        // Filter out entries with null times or days
        var validSchedule = rawSchedule
            .Where(fc => fc.StartTime.HasValue && fc.EndTime.HasValue && !string.IsNullOrWhiteSpace(fc.DayOfWeek))
            .ToList();

        if (!validSchedule.Any())
        {
            return rows;
        }

        // Group by subject + time (+ teacher/room for elementary view)
        var groups = validSchedule
            .GroupBy(fc => new
            {
                Subject = string.IsNullOrWhiteSpace(fc.SubjectName) ? "Homeroom" : fc.SubjectName!,
                StartTime = fc.StartTime!.Value,
                EndTime = fc.EndTime!.Value,
                Teacher = includeTeacher ? (fc.TeacherName ?? string.Empty) : string.Empty,
                Room = fc.Classroom ?? string.Empty
            });

        foreach (var g in groups)
        {
            var dayPattern = BuildDayPattern(g.Select(fc => fc.DayOfWeek));

            string FormatTime(TimeSpan time)
            {
                var hours = time.Hours;
                var minutes = time.Minutes;
                var period = hours < 12 ? "AM" : "PM";
                var displayHour = hours % 12;
                if (displayHour == 0) displayHour = 12;
                return $"{displayHour}:{minutes:D2} {period}";
            }

            var timeRange = $"{FormatTime(g.Key.StartTime)} - {FormatTime(g.Key.EndTime)}";

            rows.Add(new ScheduleRow
            {
                Subject = g.Key.Subject,
                TimeRange = timeRange,
                DayPattern = dayPattern,
                Teacher = includeTeacher ? (string.IsNullOrWhiteSpace(g.Key.Teacher) ? "N/A" : g.Key.Teacher) : string.Empty,
                Room = string.IsNullOrWhiteSpace(g.Key.Room) ? "N/A" : g.Key.Room
            });
        }

        // Order by time then subject for consistent display
        return rows
            .OrderBy(r => r.TimeRange)
            .ThenBy(r => r.Subject)
            .ToList();
    }

    private void HandleHasLRNChange()
    {
        if (Model == null)
        {
            return;
        }

        if (Model.HasLRN == "No")
        {
            Model.LearnerReferenceNo = "N/A";
            if (EditContext != null)
            {
                EditContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(EditContext.Model, nameof(Model.LearnerReferenceNo)));
            }
        }
        else if (Model.HasLRN == "Yes" && Model.LearnerReferenceNo == "N/A")
        {
            Model.LearnerReferenceNo = string.Empty;
            if (EditContext != null)
            {
                EditContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(EditContext.Model, nameof(Model.LearnerReferenceNo)));
            }
        }
        StateHasChanged();
    }

    private void HandleBirthDateChanged()
    {
        if (Model == null)
        {
            return;
        }

        var today = DateTime.Today;
        var age = today.Year - Model.BirthDate.Year;
        if (Model.BirthDate.Date > today.AddYears(-age))
        {
            age--;
        }
        Model.Age = age;
    }

    private void HandleSameAsCurrentAddressChanged()
    {
        if (Model == null)
        {
            return;
        }

        if (Model.SameAsCurrentAddress)
        {
            Model.PermanentHouseNo = Model.CurrentHouseNo;
            Model.PermanentStreetName = Model.CurrentStreetName;
            Model.PermanentBarangay = Model.CurrentBarangay;
            Model.PermanentCity = Model.CurrentCity;
            Model.PermanentProvince = Model.CurrentProvince;
            Model.PermanentCountry = Model.CurrentCountry;
            Model.PermanentZipCode = Model.CurrentZipCode;
        }
        else
        {
            Model.PermanentHouseNo = string.Empty;
            Model.PermanentStreetName = string.Empty;
            Model.PermanentBarangay = string.Empty;
            Model.PermanentCity = string.Empty;
            Model.PermanentProvince = string.Empty;
            Model.PermanentCountry = string.Empty;
            Model.PermanentZipCode = string.Empty;
        }
    }

    private void HandleStatusChange()
    {
        if (Model == null)
        {
            return;
        }

        // Prevent changing from automated payment statuses (Partially Paid, Fully Paid)
        // These can only be set by the payment system - they should not appear in dropdown
        // This is a safety check in case status is somehow changed programmatically
        if (IsForEnrollmentContext && 
            (PreviousStatus == "Partially Paid" || PreviousStatus == "Fully Paid") &&
            Model.Status != PreviousStatus &&
            Model.Status != "Enrolled" &&
            Model.Status != "Rejected by School" &&
            Model.Status != "Application Withdrawn")
        {
            // Revert to previous status - payment statuses are automated
            Model.Status = PreviousStatus;
            StateHasChanged();
            return;
        }

        // Prevent enrollment if status is "For Payment"
        if (IsForEnrollmentContext && Model.Status == "Enrolled" && PreviousStatus == "For Payment")
        {
            // Revert to previous status and show error message
            Model.Status = PreviousStatus ?? "For Payment";
            ShowEnrollmentError = true;
            StateHasChanged();
            return;
        }

        // If status changed to "Rejected by School" or "Application Withdrawn", show confirmation modal
        if ((Model.Status == "Rejected by School" || Model.Status == "Application Withdrawn") && 
            PreviousStatus != Model.Status)
        {
            ShowRejectionModal = true;
            RejectionReason = Model.RejectionReason ?? string.Empty;
            ShowRejectionError = false;
        }
        // If status changed away from archive statuses, clear reason
        else if (Model.Status != "Rejected by School" && Model.Status != "Application Withdrawn" && 
                 (PreviousStatus == "Rejected by School" || PreviousStatus == "Application Withdrawn"))
        {
            RejectionReason = string.Empty;
            Model.RejectionReason = null;
        }

        // Clear enrollment error if status is valid for enrollment
        if (Model.Status == "Partially Paid" || Model.Status == "Fully Paid" || Model.Status == "Enrolled")
        {
            ShowEnrollmentError = false;
        }

        PreviousStatus = Model.Status;
        StateHasChanged();
    }

    private void CloseRejectionModal()
    {
        if (Model != null && PreviousStatus != null)
        {
            // Revert status to previous value
            Model.Status = PreviousStatus;
        }
        ShowRejectionModal = false;
        RejectionReason = string.Empty;
        ShowRejectionError = false;
        StateHasChanged();
    }

    private void ConfirmRejection()
    {
        if (string.IsNullOrWhiteSpace(RejectionReason))
        {
            ShowRejectionError = true;
            StateHasChanged();
            return;
        }

        if (Model != null)
        {
            Model.RejectionReason = RejectionReason;
        }

        ShowRejectionModal = false;
        ShowRejectionError = false;
        StateHasChanged();
    }

    private string GetStudentFullName()
    {
        if (Model == null)
            return "Student";

        var name = $"{Model.FirstName} {Model.MiddleName} {Model.LastName}".Replace("  ", " ").Trim();
        if (!string.IsNullOrWhiteSpace(Model.Suffix))
        {
            name += $" {Model.Suffix}";
        }
        return name;
    }

    private async Task OnSaveClicked()
    {
        if (EditContext == null || Model == null)
            return;

        var isValid = EditContext.Validate();
        if (!isValid)
        {
            return;
        }

        if (OnSave.HasDelegate)
        {
            IsSaving = true;
            try
            {
                await OnSave.InvokeAsync(Model);
            }
            finally
            {
                IsSaving = false;
            }
        }
    }

    private async Task OnCancelClicked()
    {
        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }
    }

    private async Task HandleBackdropClick()
    {
        await OnCancelClicked();
    }

    // Format name to capitalize first letter of each word, rest lowercase
    private string FormatName(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return name;

        // Split by spaces and format each word
        var words = name.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
        var formattedWords = words.Select(word =>
        {
            if (string.IsNullOrEmpty(word))
                return word;
            
            // First letter uppercase, rest lowercase
            return char.ToUpper(word[0]) + word.Substring(1).ToLower();
        });

        return string.Join(" ", formattedWords);
    }

    // Name formatting handlers
    private void FormatFirstName()
    {
        if (Model != null)
        {
            Model.FirstName = FormatName(Model.FirstName);
            if (EditContext != null)
            {
                EditContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(EditContext.Model, nameof(Model.FirstName)));
            }
        }
    }

    private void FormatMiddleName()
    {
        if (Model != null)
        {
            Model.MiddleName = FormatName(Model.MiddleName);
        }
    }

    private void FormatLastName()
    {
        if (Model != null)
        {
            Model.LastName = FormatName(Model.LastName);
            if (EditContext != null)
            {
                EditContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(EditContext.Model, nameof(Model.LastName)));
            }
        }
    }

    private void FormatGuardianFirstName()
    {
        if (Model != null)
        {
            Model.GuardianFirstName = FormatName(Model.GuardianFirstName);
            if (EditContext != null)
            {
                EditContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(EditContext.Model, nameof(Model.GuardianFirstName)));
            }
        }
    }

    private void FormatGuardianMiddleName()
    {
        if (Model != null)
        {
            Model.GuardianMiddleName = FormatName(Model.GuardianMiddleName);
        }
    }

    private void FormatGuardianLastName()
    {
        if (Model != null)
        {
            Model.GuardianLastName = FormatName(Model.GuardianLastName);
            if (EditContext != null)
            {
                EditContext.NotifyFieldChanged(new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(EditContext.Model, nameof(Model.GuardianLastName)));
            }
        }
    }

    private void HandleLRNChange()
    {
        if (Model != null && Model.HasLRN == "No")
        {
            Model.LearnerReferenceNo = "N/A";
        }
    }

    private string GetInputClass(string fieldName)
    {
        if (EditContext == null)
        {
            return "w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base";
        }

        var fi = new Microsoft.AspNetCore.Components.Forms.FieldIdentifier(EditContext.Model, fieldName);
        var hasError = EditContext.GetValidationMessages(fi).Any();
        var isModified = EditContext.IsModified(fi);

        var baseClass = "w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base";

        if (hasError)
        {
            return $"{baseClass} border-red-500 focus:border-red-500";
        }

        if (isModified && !hasError)
        {
            return $"{baseClass} border-green-500 focus:border-green-500";
        }

        return $"{baseClass} border-gray-300 focus:border-blue-500";
    }

    private string GetStatusSelectClass()
    {
        if (Model == null) return "w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base";

        var baseClass = "w-full rounded-lg border px-3 py-2 text-sm font-medium focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base";

        return Model.Status switch
        {
            "Pending" => $"{baseClass} border-yellow-300 bg-yellow-50 text-yellow-800 focus:border-yellow-500",
            "For Payment" => $"{baseClass} border-blue-300 bg-blue-50 text-blue-800 focus:border-blue-500",
            "Partially Paid" => $"{baseClass} border-orange-300 bg-orange-50 text-orange-800 focus:border-orange-500",
            "Fully Paid" => $"{baseClass} border-green-300 bg-green-50 text-green-800 focus:border-green-500",
            "Enrolled" => $"{baseClass} border-green-400 bg-green-100 text-green-900 focus:border-green-600",
            "Rejected by School" => $"{baseClass} border-red-300 bg-red-50 text-red-800 focus:border-red-500",
            "Application Withdrawn" => $"{baseClass} border-orange-300 bg-orange-50 text-orange-800 focus:border-orange-500",
            _ => $"{baseClass} border-gray-300 bg-white text-gray-700 focus:border-blue-500"
        };
    }
}


