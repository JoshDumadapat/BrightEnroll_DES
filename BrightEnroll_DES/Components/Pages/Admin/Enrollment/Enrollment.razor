@page "/enrollment"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Components.Pages.Admin.Enrollment.EnrollmentComponents
@using BrightEnroll_DES.Components.Pages.Admin.Enrollment.EnrollmentCS
@using BrightEnroll_DES.Components.Pages.Admin.StudentRecord.StudentRecordComponents
@using BrightEnroll_DES.Components.Pages.Admin.StudentRecord.StudentRecordCS
@using BrightEnroll_DES.Data.Models
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.Business.Academic
@using BrightEnroll_DES.Components
@using BrightEnroll_DES.Services.RoleBase
@using Microsoft.Extensions.Logging
@using Microsoft.EntityFrameworkCore
@inject StudentService StudentService
@inject EnrollmentStatusService EnrollmentStatusService
@inject ReEnrollmentService ReEnrollmentService
@inject PaymentService PaymentService
@inject ArchiveService ArchiveService
@inject SchoolYearService SchoolYearService
@inject ILoadingService LoadingService
@inject ILogger<Enrollment> Logger
@inject IAuthorizationService AuthorizationService
@inject BrightEnroll_DES.Services.QuestPDF.Form1PdfGenerator Form1PdfGenerator
@inject IJSRuntime JSRuntime
@inject BrightEnroll_DES.Data.AppDbContext _context

<PageTitle>Enrollment</PageTitle>

<RoleAuthorizeView RequiredPermission="@Permissions.ViewEnrollment">

<!-- Toast Notification -->
<ToastNotification Show="@showToast" Message="@toastMessage" Type="@toastType" OnClose="@CloseToast" Duration="4000" />

<div class="text-gray-800">
    <div class="mb-6 flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-800">Enrollment</h1>
        @if (!string.IsNullOrEmpty(CurrentSchoolYear))
        {
            <div class="flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-4 py-2">
                <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span class="text-sm font-semibold text-blue-800">School Year: <span class="font-bold">@CurrentSchoolYear</span></span>
            </div>
        }
    </div>
    <!-- Tabs Card -->
    <div class="mb-6 overflow-hidden rounded-xl border-b border-gray-200 bg-white px-4 py-2 shadow">
        <div class="flex items-center gap-6">
            <button @onclick="() => SelectedTab = TabType.NewApplicants" 
                    class="@GetTabClasses(TabType.NewApplicants)"
                    style="@GetNewApplicantsStyle()">
                New Applicants
            </button>
            <button @onclick="() => SelectedTab = TabType.ForEnrollment" 
                    class="@GetTabClasses(TabType.ForEnrollment)">
                For Enrollment
            </button>
            <button @onclick="() => SelectedTab = TabType.ReEnrollment" 
                    class="@GetTabClasses(TabType.ReEnrollment)">
                Re-enrollment
            </button>
            <button @onclick="() => SelectedTab = TabType.EnrolledStudent" 
                    class="@GetTabClasses(TabType.EnrolledStudent)">
                Enrolled Student
            </button>
        </div>
    </div>

    <!-- Card Container -->
    <div class="overflow-hidden rounded-xl bg-white shadow">
        @if (SelectedTab == TabType.NewApplicants)
        {
            @if (ShowNewApplicantDetail && SelectedStudentDetail != null)
            {
                <StudentDetail StudentData="SelectedStudentDetail"
                               AcademicRecords="SelectedAcademicRecords"
                               EnrollmentRecords="SelectedEnrollmentRecords"
                               OnBackClick="CloseNewApplicantDetail" />
            }
            else
            {
                <NewApplicant Students="Applicants"
                              RowsPerPage="RowsPerPage"
                              IsLoading="isLoading"
                              OnEditStudent="HandleNewApplicantEdit" />
            }

        }
        else if (SelectedTab == TabType.ForEnrollment)
        {
            <ForEnrollment Students="ForEnrollmentStudents" 
                          RowsPerPage="RowsPerPage" 
                          IsLoading="isLoading"
                          OnEditStudent="HandleForEnrollmentEdit" />
        }
        else if (SelectedTab == TabType.ReEnrollment)
        {
            <ReEnrollment Students="ReEnrollmentStudents" 
                         RowsPerPage="RowsPerPage" 
                         IsLoading="isLoading"
                         OnReEnroll="HandleReEnrollmentRefresh"
                         OnRefresh="HandleReEnrollmentRefreshAll" />
        }
        else if (SelectedTab == TabType.EnrolledStudent)
        {
            <Enrolled Students="EnrolledStudents" 
                     RowsPerPage="RowsPerPage" 
                     IsLoading="isLoading" 
                     OnViewStudent="HandleEnrolledStudentView"
                     OnViewHistory="ShowEnrollmentHistoryAsync" />
        }
    </div>

    <!-- Edit Modal - Shared across all tabs -->
    @if (ShowEditModal && EditModel != null)
    {
        <NewApplicantEditModal Show="ShowEditModal"
                               Model="EditModel"
                               IsForEnrollmentContext="IsForEnrollmentContext"
                               OnCancel="CloseEditModal"
                               OnSave="SaveEditedApplicantAsync" />
    }

    <!-- Enrolled Student View / Re-enroll Modal -->
    @if (ShowEnrolledViewModal && EnrolledViewModel != null)
    {
        <NewApplicantEditModal Show="ShowEnrolledViewModal"
                               Model="EnrolledViewModel"
                               IsForEnrollmentContext="true"
                               IsReEnrollContext="true"
                               OnCancel="CloseEnrolledViewModal"
                               OnSave="SaveEditedApplicantAsync" />
    }

    <!-- Enrollment History Modal -->
    @if (ShowEnrollmentHistoryModal)
    {
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @onclick="CloseEnrollmentHistory">
            <div class="w-full max-w-4xl max-h-[90vh] overflow-y-auto rounded-xl bg-white shadow-2xl" @onclick:stopPropagation="true">
                <EnrollmentHistory StudentId="@SelectedStudentForHistory" 
                                 EnrollmentRecords="@EnrollmentHistoryData"
                                 OnClose="CloseEnrollmentHistory" />
            </div>
        </div>
    }
</div>

@code {
    private enum TabType
    {
        NewApplicants,
        ForEnrollment,
        ReEnrollment,
        EnrolledStudent
    }

    private TabType SelectedTab { get; set; } = TabType.NewApplicants;

    private string GetNewApplicantsStyle()
    {
        bool isSelected = SelectedTab == TabType.NewApplicants;
        if (isSelected)
        {
            return "color: #0E335D; border-bottom: 2px solid #0E335D;";
        }
        else
        {
            return "color: #0E335D;";
        }
    }

    private string GetTabClasses(TabType tab)
    {
        bool isSelected = SelectedTab == tab;
        
        return tab switch
        {
            TabType.NewApplicants => isSelected
                ? "px-3 py-2 text-sm font-semibold"
                : "px-3 py-2 text-sm font-semibold transition-colors duration-200",
            TabType.ForEnrollment => isSelected
                ? "px-3 py-2 text-sm font-semibold text-blue-600 border-b-2 border-blue-600"
                : "px-3 py-2 text-sm font-semibold text-blue-600 transition-colors duration-200 hover:text-blue-700",
            TabType.ReEnrollment => isSelected
                ? "px-3 py-2 text-sm font-semibold text-purple-600 border-b-2 border-purple-600"
                : "px-3 py-2 text-sm font-semibold text-purple-600 transition-colors duration-200 hover:text-purple-700",
            TabType.EnrolledStudent => isSelected
                ? "px-3 py-2 text-sm font-semibold text-green-600 border-b-2 border-green-600"
                : "px-3 py-2 text-sm font-semibold text-green-600 transition-colors duration-200 hover:text-green-700",
            _ => "px-3 py-2 text-sm font-semibold"
        };
    }

    private int RowsPerPage { get; set; } = 5;

    private List<NewApplicant.Student> Applicants = new();

    private List<ForEnrollment.ForEnrollmentStudent> ForEnrollmentStudents = new();

    private List<ReEnrollmentStudent> ReEnrollmentStudents = new()
    {
        new() { Id = "00001", Name = "Christine Brooks", LRN = "129706182734", Date = "04 Sep 2025", Type = "Eligible", GradeLevel = "Kinder", Documents = "Validated", Status = "Pending" },
        new() { Id = "00002", Name = "Rosie Pearson", LRN = "129706182712", Date = "28 May 2025", Type = "Eligible", GradeLevel = "Kinder", Documents = "Validated", Status = "Pending" },
        new() { Id = "00003", Name = "Darrell Caldwell", LRN = "129706182737", Date = "23 Nov 2025", Type = "Eligible", GradeLevel = "G1", Documents = "Validated", Status = "Pending" },
        new() { Id = "00004", Name = "Gilbert Johnston", LRN = "129706182715", Date = "05 Feb 2025", Type = "Eligible", GradeLevel = "Kinder", Documents = "Validated", Status = "Pending" },
        new() { Id = "00005", Name = "Alan Cain", LRN = "129706182748", Date = "29 Jul 2025", Type = "Eligible", GradeLevel = "G4", Documents = "Validated", Status = "Pending" },
        new() { Id = "00006", Name = "Alfred Murray", LRN = "129706182719", Date = "15 Aug 2025", Type = "Eligible", GradeLevel = "Kinder", Documents = "Validated", Status = "Pending" },
        new() { Id = "00007", Name = "Maggie Sullivan", LRN = "129706182733", Date = "21 Dec 2025", Type = "Eligible", GradeLevel = "G1", Documents = "Validated", Status = "Pending" },
        new() { Id = "00008", Name = "Rosie Todd", LRN = "129706182732", Date = "30 Apr 2025", Type = "Eligible", GradeLevel = "G5", Documents = "Validated", Status = "Pending" },
        new() { Id = "00009", Name = "Dollie Hines", LRN = "129706182721", Date = "09 Jan 2025", Type = "Eligible", GradeLevel = "G3", Documents = "Validated", Status = "Pending" }
    };

    private List<EnrolledStudent> EnrolledStudents = new();
    private bool isLoading = true;

    // Edit modal state for New Applicants
    private bool ShowEditModal { get; set; } = false;
    private StudentEditModel? EditModel { get; set; }
    private bool IsForEnrollmentContext { get; set; } = false;

    // New Applicant detail state
    private bool ShowNewApplicantDetail { get; set; } = false;
    private BrightEnroll_DES.Data.Models.Student? SelectedNewApplicant { get; set; }
    private StudentDetailData? SelectedStudentDetail { get; set; }
    private List<AcademicRecordData> SelectedAcademicRecords { get; set; } = new();
    private List<EnrollmentStatusData> SelectedEnrollmentRecords { get; set; } = new();

    // Enrolled student view modal state
    private bool ShowEnrolledViewModal { get; set; } = false;
    private StudentEditModel? EnrolledViewModel { get; set; }

    // Enrollment history modal state
    private bool ShowEnrollmentHistoryModal { get; set; } = false;
    private string SelectedStudentForHistory { get; set; } = "";

    // Toast notification state
    private bool showToast = false;
    private string toastMessage = "";
    private ToastType toastType = ToastType.Success;

    private void ShowToast(string message, ToastType type)
    {
        toastMessage = message;
        toastType = type;
        showToast = true;
        StateHasChanged();
    }

    private void CloseToast()
    {
        showToast = false;
        StateHasChanged();
    }

    private string CurrentSchoolYear { get; set; } = "";

    protected override async Task OnInitializedAsync()
    {
        // Load current active school year
        CurrentSchoolYear = await SchoolYearService.GetActiveSchoolYearNameAsync() ?? "";
        
        // Hide loading screen immediately when page loads
        LoadingService.HideLoading();
        
        isLoading = true;
        try
        {
            await LoadNewApplicantsAsync();
            await LoadForEnrollmentStudentsAsync();
            await LoadReEnrollmentStudentsAsync();
            await LoadEnrolledStudentsAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadNewApplicantsAsync()
    {
        try
        {
            var newApplicantsDto = await StudentService.GetNewApplicantsAsync();
            
            // Map NewApplicantDto to NewApplicant.Student
            Applicants = newApplicantsDto.Select(dto => new NewApplicant.Student
            {
                Id = dto.Id,
                Name = dto.Name,
                LRN = dto.LRN ?? "N/A",
                Date = dto.Date,
                Type = dto.Type,
                GradeLevel = dto.GradeLevel,
                Status = dto.Status,
                DocumentsVerified = dto.DocumentsVerified
            }).ToList();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading new applicants: {Message}", ex.Message);
            Applicants = new List<NewApplicant.Student>();
        }
    }

    private async Task LoadEnrolledStudentsAsync()
    {
        try
        {
            // Pass current active school year to filter enrolled students
            var enrolledStudentsDto = await StudentService.GetEnrolledStudentsAsync(CurrentSchoolYear);
            
            // Map EnrolledStudentDto to EnrolledStudent
            EnrolledStudents = enrolledStudentsDto.Select(dto => new EnrolledStudent
            {
                Id = dto.Id,
                Name = dto.Name,
                LRN = dto.LRN,
                Date = dto.Date,
                GradeLevel = dto.GradeLevel,
                Section = dto.Section,
                Documents = dto.Documents,
                Status = dto.Status
            }).ToList();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading enrolled students: {Message}", ex.Message);
            EnrolledStudents = new List<EnrolledStudent>();
        }
    }

    private async Task HandleEnrolledStudentView(string studentId)
    {
        isLoading = true;
        IsForEnrollmentContext = true;

        try
        {
            var student = await StudentService.GetStudentByIdAsync(studentId);
            if (student == null)
            {
                ShowToast($"Student {studentId} not found.", ToastType.Error);
                return;
            }

            // Normalize LRN similar to other handlers
            var rawLrn = student.Lrn?.Trim() ?? string.Empty;
            var normalizedLrn = rawLrn.ToUpperInvariant();
            bool hasRealLrn = !string.IsNullOrWhiteSpace(rawLrn) &&
                              normalizedLrn != "N/A" &&
                              normalizedLrn != "NA" &&
                              normalizedLrn != "PENDING" &&
                              normalizedLrn != "NULL";

            // Determine current logical status for display: prefer section enrollment status if available
            var currentStatus = student.SectionEnrollments
                ?.OrderByDescending(e => e.CreatedAt)
                .FirstOrDefault()
                ?.Status;

            if (string.IsNullOrWhiteSpace(currentStatus))
            {
                currentStatus = string.IsNullOrWhiteSpace(student.Status)
                    ? "Enrolled"
                    : student.Status;
            }

            EnrolledViewModel = new StudentEditModel
            {
                StudentId = student.StudentId,
                FirstName = student.FirstName,
                MiddleName = student.MiddleName ?? string.Empty,
                LastName = student.LastName,
                Suffix = student.Suffix ?? string.Empty,
                BirthDate = student.Birthdate,
                Age = student.Age,
                PlaceOfBirth = student.PlaceOfBirth ?? string.Empty,
                Sex = student.Sex,
                MotherTongue = student.MotherTongue ?? string.Empty,
                IsIPCommunity = student.IpComm ? "Yes" : "No",
                IPCommunitySpecify = student.IpSpecify ?? string.Empty,
                Is4PsBeneficiary = student.FourPs ? "Yes" : "No",
                FourPsHouseholdId = student.FourPsHseId ?? string.Empty,

                CurrentHouseNo = student.HseNo ?? string.Empty,
                CurrentStreetName = student.Street ?? string.Empty,
                CurrentBarangay = student.Brngy ?? string.Empty,
                CurrentCity = student.City ?? string.Empty,
                CurrentProvince = student.Province ?? string.Empty,
                CurrentCountry = student.Country ?? string.Empty,
                CurrentZipCode = student.ZipCode ?? string.Empty,

                SameAsCurrentAddress = false,
                PermanentHouseNo = student.PhseNo ?? string.Empty,
                PermanentStreetName = student.Pstreet ?? string.Empty,
                PermanentBarangay = student.Pbrngy ?? string.Empty,
                PermanentCity = student.Pcity ?? string.Empty,
                PermanentProvince = student.Pprovince ?? string.Empty,
                PermanentCountry = student.Pcountry ?? string.Empty,
                PermanentZipCode = student.PzipCode ?? string.Empty,

                GuardianFirstName = student.Guardian?.FirstName ?? string.Empty,
                GuardianMiddleName = student.Guardian?.MiddleName ?? string.Empty,
                GuardianLastName = student.Guardian?.LastName ?? string.Empty,
                GuardianSuffix = student.Guardian?.Suffix ?? string.Empty,
                GuardianContactNumber = student.Guardian?.ContactNum ?? string.Empty,
                GuardianRelationship = student.Guardian?.Relationship ?? string.Empty,

                StudentType = student.StudentType ?? string.Empty,
                HasLRN = hasRealLrn ? "Yes" : "No",
                LearnerReferenceNo = hasRealLrn ? rawLrn : "N/A",
                SchoolYear = student.SchoolYr ?? string.Empty,
                GradeToEnroll = student.GradeLevel ?? string.Empty,
                Status = currentStatus,

                // Requirements (view + possible re-enroll)
                HasPSABirthCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "PSA Birth Certificate")),
                HasBaptismalCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Baptismal Certificate")),
                HasReportCard = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Report Card")),
                HasForm138 = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Form 138 (Report Card)")),
                HasForm137 = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Form 137 (Permanent Record)")),
                HasGoodMoralCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Good Moral Certificate")),
                HasTransferCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Transfer Certificate")),
                HasUpdatedEnrollmentForm = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Updated Enrollment Form")),
                HasClearance = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Clearance"))
            };

            ShowEnrolledViewModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading enrolled student view for {StudentId}: {Message}", studentId, ex.Message);
            ShowToast($"Error loading student: {ex.Message}", ToastType.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void CloseEnrolledViewModal()
    {
        ShowEnrolledViewModal = false;
        EnrolledViewModel = null;
    }

    private async Task HandleNewApplicantEdit(string studentId)
    {
        isLoading = true;
        try
        {
            var student = await StudentService.GetStudentByIdAsync(studentId);
            SelectedNewApplicant = student;

            if (student != null)
            {
                var fullName = $"{student.FirstName} {student.MiddleName} {student.LastName}".Replace("  ", " ").Trim();

                var documentsVerified = student.Requirements != null &&
                                        student.Requirements.Any() &&
                                        student.Requirements.All(IsRequirementVerified);

                // Normalize LRN to detect placeholder values (e.g., "N/A", "Pending")
                var rawLrn = student.Lrn?.Trim() ?? string.Empty;
                var normalizedLrn = rawLrn.ToUpperInvariant();
                bool hasRealLrn = !string.IsNullOrWhiteSpace(rawLrn) &&
                                  normalizedLrn != "N/A" &&
                                  normalizedLrn != "NA" &&
                                  normalizedLrn != "PENDING" &&
                                  normalizedLrn != "NULL";

                SelectedStudentDetail = new StudentDetailData
                {
                    Id = student.StudentId,
                    FullName = fullName,
                    FirstName = student.FirstName,
                    MiddleName = student.MiddleName ?? string.Empty,
                    LastName = student.LastName,
                    Suffix = student.Suffix ?? "N/A",
                    GradeLevel = student.GradeLevel ?? "N/A",
                    Section = "N/A",
                    SchoolYear = student.SchoolYr ?? "N/A",
                    Status = student.Status ?? string.Empty,
                    LRN = hasRealLrn ? rawLrn : "N/A",
                    BirthDate = student.Birthdate,
                    PlaceOfBirth = student.PlaceOfBirth ?? "N/A",
                    Sex = student.Sex,
                    MotherTongue = student.MotherTongue ?? "N/A",
                    IsIPCommunity = student.IpComm == true ? "Yes" : "No",
                    IPCommunitySpecify = student.IpSpecify ?? string.Empty,
                    Is4PsBeneficiary = student.FourPs == true ? "Yes" : "No",
                    FourPsHouseholdId = student.FourPsHseId ?? string.Empty,
                    CurrentHouseNo = student.HseNo ?? string.Empty,
                    CurrentStreetName = student.Street ?? string.Empty,
                    CurrentBarangay = student.Brngy ?? string.Empty,
                    CurrentCity = student.City ?? string.Empty,
                    CurrentProvince = student.Province ?? string.Empty,
                    CurrentCountry = student.Country ?? string.Empty,
                    CurrentZipCode = student.ZipCode ?? string.Empty,
                    SameAsCurrentAddress = false,
                    PermanentHouseNo = student.PhseNo ?? string.Empty,
                    PermanentStreetName = student.Pstreet ?? string.Empty,
                    PermanentBarangay = student.Pbrngy ?? string.Empty,
                    PermanentCity = student.Pcity ?? string.Empty,
                    PermanentProvince = student.Pprovince ?? string.Empty,
                    PermanentCountry = student.Pcountry ?? string.Empty,
                    PermanentZipCode = student.PzipCode ?? string.Empty,
                    GuardianFirstName = student.Guardian?.FirstName ?? string.Empty,
                    GuardianMiddleName = student.Guardian?.MiddleName ?? string.Empty,
                    GuardianLastName = student.Guardian?.LastName ?? string.Empty,
                    GuardianSuffix = student.Guardian?.Suffix ?? string.Empty,
                    GuardianContactNumber = student.Guardian?.ContactNum ?? string.Empty,
                    GuardianRelationship = student.Guardian?.Relationship ?? string.Empty,
                    StudentType = student.StudentType ?? string.Empty,
                    HasLRN = hasRealLrn ? "Yes" : "No",
                    LearnerReferenceNo = hasRealLrn ? rawLrn : "N/A",
                    GradeToEnroll = student.GradeLevel ?? "N/A",
                    HasBirthCertificate = student.Requirements != null && student.Requirements.Any(IsRequirementVerified),

                    // Detailed requirement checklist - mirror registration logic
                    HasPSABirthCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "PSA Birth Certificate")),
                    HasBaptismalCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Baptismal Certificate")),
                    HasReportCard = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Report Card")),
                    HasForm138 = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Form 138 (Report Card)")),
                    HasForm137 = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Form 137 (Permanent Record)")),
                    HasGoodMoralCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Good Moral Certificate")),
                    HasTransferCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Transfer Certificate")),
                    HasUpdatedEnrollmentForm = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Updated Enrollment Form")),
                    HasClearance = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Clearance"))
                };

                SelectedAcademicRecords = new List<AcademicRecordData>();
                SelectedEnrollmentRecords = new List<EnrollmentStatusData>
                {
                    new()
                    {
                        SchoolYear = student.SchoolYr ?? "N/A",
                        Grade = student.GradeLevel ?? "N/A",
                        Section = "N/A",
                        Type = student.StudentType ?? string.Empty,
                        Documents = documentsVerified ? "Validated" : "Not Validated",
                        Status = student.Status ?? string.Empty
                    }
                };

                // Load section enrollments to check if student has previous enrollments (re-enrolled student)
                await _context.Entry(student).Collection(s => s.SectionEnrollments).LoadAsync();
                
                // Determine school year and grade level for enrollment
                string schoolYearForEnrollment = CurrentSchoolYear; // Use active school year by default
                string gradeToEnroll = student.GradeLevel ?? string.Empty;
                
                // If student has previous enrollments (re-enrolled student), calculate next grade level
                if (student.SectionEnrollments != null && student.SectionEnrollments.Any())
                {
                    // Get most recent enrollment to determine current grade
                    var mostRecentEnrollment = student.SectionEnrollments
                        .OrderByDescending(e => e.SchoolYear)
                        .ThenByDescending(e => e.CreatedAt)
                        .FirstOrDefault();
                    
                    if (mostRecentEnrollment != null)
                    {
                        // Load section and grade level
                        await _context.Entry(mostRecentEnrollment).Reference(e => e.Section).LoadAsync();
                        if (mostRecentEnrollment.Section != null)
                        {
                            await _context.Entry(mostRecentEnrollment.Section).Reference(s => s.GradeLevel).LoadAsync();
                            var currentGradeLevel = mostRecentEnrollment.Section.GradeLevel?.GradeLevelName;
                            
                            // Calculate next grade level for re-enrollment
                            if (!string.IsNullOrWhiteSpace(currentGradeLevel))
                            {
                                gradeToEnroll = ReEnrollmentService.GetNextGradeLevel(currentGradeLevel) ?? gradeToEnroll;
                            }
                        }
                    }
                }
                else
                {
                    // New student - use their registered school year if available, otherwise use active school year
                    if (string.IsNullOrWhiteSpace(student.SchoolYr))
                    {
                        schoolYearForEnrollment = CurrentSchoolYear;
                    }
                    else
                    {
                        schoolYearForEnrollment = student.SchoolYr;
                    }
                }

                // Prepare edit model for modal (mirrors registration + status/requirements)

                EditModel = new StudentEditModel
                {
                    StudentId = student.StudentId,
                    FirstName = student.FirstName,
                    MiddleName = student.MiddleName ?? string.Empty,
                    LastName = student.LastName,
                    Suffix = student.Suffix ?? string.Empty,
                    BirthDate = student.Birthdate,
                    Age = student.Age,
                    PlaceOfBirth = student.PlaceOfBirth ?? string.Empty,
                    Sex = student.Sex,
                    MotherTongue = student.MotherTongue ?? string.Empty,
                    MotherTongueOther = string.Empty, // Not stored in Student model
                    IsIPCommunity = student.IpComm == true ? "Yes" : "No",
                    IPCommunitySpecify = student.IpSpecify ?? string.Empty,
                    IPCommunitySpecifyOther = string.Empty, // Not stored in Student model
                    Is4PsBeneficiary = student.FourPs == true ? "Yes" : "No",
                    FourPsHouseholdId = student.FourPsHseId ?? string.Empty,
                    CurrentHouseNo = student.HseNo ?? string.Empty,
                    CurrentStreetName = student.Street ?? string.Empty,
                    CurrentBarangay = student.Brngy ?? string.Empty,
                    CurrentCity = student.City ?? string.Empty,
                    CurrentProvince = student.Province ?? string.Empty,
                    CurrentCountry = student.Country ?? string.Empty,
                    CurrentZipCode = student.ZipCode ?? string.Empty,
                    SameAsCurrentAddress = false,
                    PermanentHouseNo = student.PhseNo ?? string.Empty,
                    PermanentStreetName = student.Pstreet ?? string.Empty,
                    PermanentBarangay = student.Pbrngy ?? string.Empty,
                    PermanentCity = student.Pcity ?? string.Empty,
                    PermanentProvince = student.Pprovince ?? string.Empty,
                    PermanentCountry = student.Pcountry ?? string.Empty,
                    PermanentZipCode = student.PzipCode ?? string.Empty,
                    GuardianFirstName = student.Guardian?.FirstName ?? string.Empty,
                    GuardianMiddleName = student.Guardian?.MiddleName ?? string.Empty,
                    GuardianLastName = student.Guardian?.LastName ?? string.Empty,
                    GuardianSuffix = student.Guardian?.Suffix ?? string.Empty,
                    GuardianContactNumber = student.Guardian?.ContactNum ?? string.Empty,
                    GuardianRelationship = student.Guardian?.Relationship ?? string.Empty,
                    GuardianRelationshipOther = string.Empty, // Not stored in Guardian model
                    StudentType = student.StudentType ?? string.Empty,
                    HasLRN = hasRealLrn ? "Yes" : "No",
                    LearnerReferenceNo = hasRealLrn ? rawLrn : "N/A",
                    SchoolYear = schoolYearForEnrollment, // Use active school year for re-enrolled students, or student's school year for new students
                    GradeToEnroll = gradeToEnroll, // Calculated next grade level for re-enrolled students
                    Status = student.Status ?? "Pending",
                    // Map requirement checkboxes from Status field (since IsVerified is ignored in AppDbContext)
                    // Check Status field directly - "verified" means checked, anything else means unchecked
                    HasPSABirthCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "PSA Birth Certificate")),
                    HasBaptismalCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Baptismal Certificate")),
                    HasReportCard = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Report Card")),
                    HasForm138 = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Form 138 (Report Card)")),
                    HasForm137 = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Form 137 (Permanent Record)")),
                    HasGoodMoralCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Good Moral Certificate")),
                    HasTransferCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Transfer Certificate")),
                    HasUpdatedEnrollmentForm = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Updated Enrollment Form")),
                    HasClearance = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Clearance"))
                };

                // Load reason from archive if student was previously archived
                if (student.Status == "Rejected by School" || student.Status == "Application Withdrawn")
                {
                    try
                    {
                        var archive = await ArchiveService.GetArchivedStudentAsync(student.StudentId);
                        if (archive != null && !string.IsNullOrWhiteSpace(archive.Reason))
                        {
                            EditModel.RejectionReason = archive.Reason;
                        }
                    }
                    catch
                    {
                        // Archive not found or error - continue without reason
                    }
                }

                IsForEnrollmentContext = false;
                ShowEditModal = true;
                ShowNewApplicantDetail = false;
            }
            else
            {
                ShowNewApplicantDetail = false;
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading new applicant detail for {StudentId}: {Message}", studentId, ex.Message);
            SelectedNewApplicant = null;
            SelectedStudentDetail = null;
            SelectedAcademicRecords = new List<AcademicRecordData>();
            SelectedEnrollmentRecords = new List<EnrollmentStatusData>();
            ShowNewApplicantDetail = false;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleForEnrollmentEdit(string studentId)
    {
        isLoading = true;
        IsForEnrollmentContext = true;
        try
        {
            var student = await StudentService.GetStudentByIdAsync(studentId);

            if (student != null)
            {
                // Prepare edit model for modal (mirrors registration + status/requirements)
                var rawLrn = student.Lrn?.Trim() ?? string.Empty;
                var normalizedLrn = rawLrn.ToUpperInvariant();
                bool hasRealLrn = !string.IsNullOrWhiteSpace(rawLrn) &&
                                  normalizedLrn != "N/A" &&
                                  normalizedLrn != "NA" &&
                                  normalizedLrn != "PENDING" &&
                                  normalizedLrn != "NULL";

                // Load section enrollments to check if student has previous enrollments
                await _context.Entry(student).Collection(s => s.SectionEnrollments).LoadAsync();
                
                // Determine school year and grade level for enrollment
                string schoolYearForEnrollment = CurrentSchoolYear; // Use active school year by default
                string gradeToEnroll = student.GradeLevel ?? string.Empty;
                
                // If student has previous enrollments, calculate next grade level
                if (student.SectionEnrollments != null && student.SectionEnrollments.Any())
                {
                    // Get most recent enrollment to determine current grade
                    var mostRecentEnrollment = student.SectionEnrollments
                        .OrderByDescending(e => e.SchoolYear)
                        .ThenByDescending(e => e.CreatedAt)
                        .FirstOrDefault();
                    
                    if (mostRecentEnrollment != null)
                    {
                        // Load section and grade level
                        await _context.Entry(mostRecentEnrollment).Reference(e => e.Section).LoadAsync();
                        if (mostRecentEnrollment.Section != null)
                        {
                            await _context.Entry(mostRecentEnrollment.Section).Reference(s => s.GradeLevel).LoadAsync();
                            var currentGradeLevel = mostRecentEnrollment.Section.GradeLevel?.GradeLevelName;
                            
                            // Calculate next grade level for re-enrollment
                            if (!string.IsNullOrWhiteSpace(currentGradeLevel))
                            {
                                gradeToEnroll = ReEnrollmentService.GetNextGradeLevel(currentGradeLevel) ?? gradeToEnroll;
                            }
                        }
                    }
                }

                EditModel = new StudentEditModel
                {
                    StudentId = student.StudentId,
                    FirstName = student.FirstName,
                    MiddleName = student.MiddleName ?? string.Empty,
                    LastName = student.LastName,
                    Suffix = student.Suffix ?? string.Empty,
                    BirthDate = student.Birthdate,
                    Age = student.Age,
                    PlaceOfBirth = student.PlaceOfBirth ?? string.Empty,
                    Sex = student.Sex,
                    MotherTongue = student.MotherTongue ?? string.Empty,
                    MotherTongueOther = string.Empty, // Not stored in Student model
                    IsIPCommunity = student.IpComm == true ? "Yes" : "No",
                    IPCommunitySpecify = student.IpSpecify ?? string.Empty,
                    IPCommunitySpecifyOther = string.Empty, // Not stored in Student model
                    Is4PsBeneficiary = student.FourPs == true ? "Yes" : "No",
                    FourPsHouseholdId = student.FourPsHseId ?? string.Empty,
                    CurrentHouseNo = student.HseNo ?? string.Empty,
                    CurrentStreetName = student.Street ?? string.Empty,
                    CurrentBarangay = student.Brngy ?? string.Empty,
                    CurrentCity = student.City ?? string.Empty,
                    CurrentProvince = student.Province ?? string.Empty,
                    CurrentCountry = student.Country ?? string.Empty,
                    CurrentZipCode = student.ZipCode ?? string.Empty,
                    SameAsCurrentAddress = false,
                    PermanentHouseNo = student.PhseNo ?? string.Empty,
                    PermanentStreetName = student.Pstreet ?? string.Empty,
                    PermanentBarangay = student.Pbrngy ?? string.Empty,
                    PermanentCity = student.Pcity ?? string.Empty,
                    PermanentProvince = student.Pprovince ?? string.Empty,
                    PermanentCountry = student.Pcountry ?? string.Empty,
                    PermanentZipCode = student.PzipCode ?? string.Empty,
                    GuardianFirstName = student.Guardian?.FirstName ?? string.Empty,
                    GuardianMiddleName = student.Guardian?.MiddleName ?? string.Empty,
                    GuardianLastName = student.Guardian?.LastName ?? string.Empty,
                    GuardianSuffix = student.Guardian?.Suffix ?? string.Empty,
                    GuardianContactNumber = student.Guardian?.ContactNum ?? string.Empty,
                    GuardianRelationship = student.Guardian?.Relationship ?? string.Empty,
                    GuardianRelationshipOther = string.Empty, // Not stored in Guardian model
                    StudentType = student.StudentType ?? string.Empty,
                    HasLRN = hasRealLrn ? "Yes" : "No",
                    LearnerReferenceNo = hasRealLrn ? rawLrn : "N/A",
                    SchoolYear = schoolYearForEnrollment, // Use active school year, not student's old school year
                    GradeToEnroll = gradeToEnroll, // Calculated next grade level for re-enrolled students
                    Status = student.Status ?? "For Payment",
                    // Map requirement checkboxes from Status field (since IsVerified is ignored in AppDbContext)
                    // Check Status field directly - "verified" means checked, anything else means unchecked
                    HasPSABirthCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "PSA Birth Certificate")),
                    HasBaptismalCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Baptismal Certificate")),
                    HasReportCard = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Report Card")),
                    HasForm138 = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Form 138 (Report Card)")),
                    HasForm137 = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Form 137 (Permanent Record)")),
                    HasGoodMoralCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Good Moral Certificate")),
                    HasTransferCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Transfer Certificate")),
                    HasUpdatedEnrollmentForm = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Updated Enrollment Form")),
                    HasClearance = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Clearance"))
                };

                ShowEditModal = true;
                StateHasChanged(); // Trigger UI update to show modal
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading for enrollment student detail for {StudentId}: {Message}", studentId, ex.Message);
            EditModel = null;
            ShowToast($"Error loading student: {ex.Message}", ToastType.Error);
        }
        finally
        {
            isLoading = false;
            StateHasChanged(); // Ensure UI updates even if there's an error
        }
    }

    // Treat a requirement as verified if either the new boolean flag is true
    // or, for older records, the legacy Status string is "verified".
    private static bool IsRequirementVerified(StudentRequirement r)
    {
        if (r == null) return false;

        if (r.IsVerified)
        {
            return true;
        }

        return !string.IsNullOrWhiteSpace(r.Status) &&
               r.Status.Equals("verified", StringComparison.OrdinalIgnoreCase);
    }
    
    // Check if a requirement is checked based on Status field (since IsVerified is ignored in AppDbContext)
    // Status "verified" means checked, anything else means unchecked
    private static bool IsRequirementChecked(StudentRequirement? requirement)
    {
        if (requirement == null) return false;
        
        // Check Status field as primary source (since IsVerified is ignored in EF Core)
        return !string.IsNullOrWhiteSpace(requirement.Status) &&
               requirement.Status.Equals("verified", StringComparison.OrdinalIgnoreCase);
    }
    
    // Helper method to calculate if all required documents for a student type are verified
    private static bool CalculateDocumentsVerifiedForStudent(ICollection<StudentRequirement>? requirements, string? studentType)
    {
        if (requirements == null || !requirements.Any())
        {
            return false;
        }
        
        // Get the list of required document names for this student type
        var requiredNames = GetRequiredDocumentNamesForStudentType(studentType);
        
        if (!requiredNames.Any())
        {
            return false; // No requirements defined for this student type
        }
        
        // Check if all required documents are verified
        foreach (var requiredName in requiredNames)
        {
            var requirement = requirements.FirstOrDefault(r => r.RequirementName == requiredName);
            if (requirement == null)
            {
                // Required document doesn't exist - not verified
                return false;
            }
            
            // Check if this requirement is verified (using Status field since IsVerified is ignored)
            bool isVerified = !string.IsNullOrWhiteSpace(requirement.Status) && 
                             requirement.Status.Equals("verified", StringComparison.OrdinalIgnoreCase);
            
            if (!isVerified)
            {
                // At least one required document is not verified
                return false;
            }
        }
        
        // All required documents are verified
        return true;
    }
    
    // Helper method to get required document names for a student type
    private static HashSet<string> GetRequiredDocumentNamesForStudentType(string? studentType)
    {
        var requiredNames = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        
        if (string.IsNullOrWhiteSpace(studentType))
        {
            return requiredNames;
        }
        
        var studentTypeLower = studentType.ToLower();
        
        switch (studentTypeLower)
        {
            case "new student":
                requiredNames.Add("PSA Birth Certificate");
                requiredNames.Add("Baptismal Certificate");
                requiredNames.Add("Report Card");
                break;
                
            case "transferee":
                requiredNames.Add("PSA Birth Certificate");
                requiredNames.Add("Baptismal Certificate");
                requiredNames.Add("Form 138 (Report Card)");
                requiredNames.Add("Form 137 (Permanent Record)");
                requiredNames.Add("Good Moral Certificate");
                requiredNames.Add("Transfer Certificate");
                break;
                
            case "returnee":
                requiredNames.Add("Form 138 (Report Card)");
                requiredNames.Add("Updated Enrollment Form");
                requiredNames.Add("Clearance");
                break;
        }
        
        return requiredNames;
    }

    private void CloseNewApplicantDetail()
    {
        ShowNewApplicantDetail = false;
        SelectedNewApplicant = null;
        SelectedStudentDetail = null;
        SelectedAcademicRecords = new List<AcademicRecordData>();
        SelectedEnrollmentRecords = new List<EnrollmentStatusData>();
        ShowEditModal = false;
        EditModel = null;
    }

    private void CloseEditModal()
    {
        ShowEditModal = false;
        EditModel = null;
        IsForEnrollmentContext = false;
    }

    private async Task SaveEditedApplicantAsync(StudentEditModel model)
    {
        try
        {
            // Get current student to check status transition
            var currentStudent = await StudentService.GetStudentByIdAsync(model.StudentId);
            string? oldStatus = currentStudent?.Status;
            bool statusChanged = currentStudent != null && currentStudent.Status != model.Status;
            
            if (statusChanged)
            {
                // Use EnrollmentStatusService to validate and update status
                var statusUpdated = await EnrollmentStatusService.UpdateStudentStatusAsync(
                    model.StudentId, 
                    model.Status);
                
                if (!statusUpdated)
                {
                    Logger?.LogWarning(
                        "Status transition not allowed for student {StudentId}: {OldStatus} -> {NewStatus}",
                        model.StudentId, oldStatus ?? "Unknown", model.Status);
                    // Continue with update anyway, but log the warning
                }
            }

            // Update student information
            await StudentService.UpdateStudentAsync(model);
            
            // Generate and download Form 1 PDF if student is being enrolled
            if (statusChanged && model.Status == "Enrolled" && !string.IsNullOrWhiteSpace(model.SchoolYear))
            {
                try
                {
                    var pdfBytes = await Form1PdfGenerator.GenerateForm1Async(model.StudentId, model.SchoolYear);
                    var fileName = $"Form1_Enrollment_{model.StudentId}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
                    var base64Content = Convert.ToBase64String(pdfBytes);
                    await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "application/pdf", base64Content);
                }
                catch (Exception pdfEx)
                {
                    Logger?.LogError(pdfEx, "Error generating Form 1 PDF for student {StudentId}: {Message}", model.StudentId, pdfEx.Message);
                    // Don't fail the enrollment if PDF generation fails
                }
            }
            
            // If student is rejected or withdrawn, archive them
            // Note: Status is already updated by UpdateStudentAsync above, so we just need to mark as archived
            if (model.Status == "Rejected by School" || model.Status == "Application Withdrawn" || model.Status == "Application Withdraw")
            {
                try
                {
                    // Check if already archived
                    var isArchived = await ArchiveService.IsStudentArchivedAsync(model.StudentId);
                    if (!isArchived)
                    {
                        // Archive the student (status is already updated, this just confirms archiving)
                        await ArchiveService.ArchiveStudentAsync(
                            model.StudentId,
                            model.Status, // Status already updated by UpdateStudentAsync
                            notes: null,
                            archivedBy: null,
                            reason: model.RejectionReason
                        );
                    }
                    else
                    {
                        // Update existing archive with reason
                        await ArchiveService.UpdateArchiveAsync(
                            model.StudentId,
                            archiveReason: model.Status,
                            reason: model.RejectionReason
                        );
                    }
                    
                    // Show success toast for archiving
                    ShowToast($"Student {model.StudentId} has been archived with status: {model.Status}.", ToastType.Success);
                }
                catch (Exception archiveEx)
                {
                    // Log full error details for debugging
                    Logger?.LogError(archiveEx, 
                        "Error archiving student {StudentId}: {Message}. " +
                        "Stack Trace: {StackTrace}. " +
                        "Inner Exception: {InnerException}",
                        model.StudentId, 
                        archiveEx.Message,
                        archiveEx.StackTrace,
                        archiveEx.InnerException?.Message ?? "None");
                    
                    // Show detailed error message
                    var errorMsg = archiveEx.Message;
                    if (archiveEx.InnerException != null)
                    {
                        errorMsg += $" ({archiveEx.InnerException.Message})";
                    }
                    ShowToast($"Error archiving student: {errorMsg}", ToastType.Error);
                }
            }
            else if (statusChanged)
            {
                // Determine toast type based on new status
                if (model.Status == "For Payment" || model.Status == "Eligible" || model.Status == "Enrolled")
                {
                    // Green toast for enrollment success
                    string statusMessage = model.Status switch
                    {
                        "For Payment" => "moved to For Enrollment",
                        "Eligible" => "marked as eligible for enrollment",
                        "Enrolled" => "successfully enrolled",
                        _ => $"status changed to {model.Status}"
                    };
                    ShowToast($"Student {model.StudentId} {statusMessage}.", ToastType.Success);
                }
                else
                {
                    // Yellow toast for other status changes
                    ShowToast($"Student {model.StudentId} status updated from {oldStatus} to {model.Status}.", ToastType.Edit);
                }
            }
            else
            {
                // Yellow toast for edit without status change
                ShowToast($"Student {model.StudentId} information updated.", ToastType.Edit);
            }
            
            ShowEditModal = false;

            // Refresh tables so changes reflect in UI
            await LoadNewApplicantsAsync();
            await LoadForEnrollmentStudentsAsync();
            await LoadReEnrollmentStudentsAsync();
            await LoadEnrolledStudentsAsync();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error updating applicant {StudentId}: {Message}", model.StudentId, ex.Message);
            ShowToast($"Error updating student: {ex.Message}", ToastType.Error);
        }
    }

    private async Task LoadForEnrollmentStudentsAsync()
    {
        try
        {
            // STRICT FILTERING: Only get students with enrollment records for the ACTIVE school year
            // This ensures closed school years don't show students from other years
            
            // Get enrollments for the active school year with statuses that allow enrollment
            var enrollments = await _context.StudentSectionEnrollments
                .Include(e => e.Student)
                    .ThenInclude(s => s.Requirements)
                .Include(e => e.Section)
                    .ThenInclude(s => s.GradeLevel)
                .Where(e => e.SchoolYear == CurrentSchoolYear && 
                           (e.Status == "Pending" || e.Status == "For Payment" || 
                            e.Status == "Partially Paid" || e.Status == "Fully Paid"))
                .ToListAsync();

            // Also get students without enrollment records yet (new applicants)
            var studentsWithoutEnrollments = await EnrollmentStatusService.GetStudentsByStatusesAsync(
                CurrentSchoolYear,
                "For Payment",
                "Partially Paid",
                "Fully Paid"
            );

            // Filter out students who already have enrollments (to avoid duplicates)
            var enrollmentStudentIds = enrollments.Select(e => e.StudentId).Distinct().ToList();
            var newStudentsOnly = studentsWithoutEnrollments
                .Where(s => !enrollmentStudentIds.Contains(s.StudentId))
                .ToList();

            // Get status logs for all students
            var allStudentIds = enrollments.Select(e => e.StudentId)
                .Concat(newStudentsOnly.Select(s => s.StudentId))
                .Distinct()
                .ToList();
            var statusLogs = await EnrollmentStatusService.GetLatestStatusLogsAsync(allStudentIds);

            // Build ForEnrollmentStudents from enrollments
            var enrollmentStudentsList = new List<ForEnrollment.ForEnrollmentStudent>();
            foreach (var e in enrollments)
            {
                var s = e.Student;
                
                // Get payment info for THIS school year
                var paymentInfo = await PaymentService.GetStudentPaymentInfoBySchoolYearAsync(s.StudentId, CurrentSchoolYear);
                
                // Use enrollment status, or fall back to student status
                var status = e.Status ?? s.Status ?? "For Payment";
                var paymentStatus = paymentInfo?.PaymentStatus ?? 
                    (status == "Fully Paid" ? "Fully Paid" : 
                     status == "Partially Paid" ? "Partially Paid" : "Unpaid");

                // Get grade level from enrollment's section (at enrollment time), NOT from student's main record
                // This ensures historical accuracy
                var gradeLevel = e.Section?.GradeLevel?.GradeLevelName ?? s.GradeLevel ?? "N/A";

                var statusLog = statusLogs.GetValueOrDefault(s.StudentId);
                var changedBy = statusLog?.ChangedByName ?? "N/A";
                var changedOn = statusLog?.CreatedAt;

                enrollmentStudentsList.Add(new ForEnrollment.ForEnrollmentStudent
                {
                    Id = s.StudentId,
                    Name = $"{s.FirstName} {s.MiddleName} {s.LastName}".Replace("  ", " ").Trim(),
                    LRN = s.Lrn ?? "N/A",
                    Date = FormatDate(s.DateRegistered),
                    Type = s.StudentType,
                    GradeLevel = gradeLevel,
                    Status = status,
                    PaymentStatus = paymentStatus,
                    DocumentsVerified = CalculateDocumentsVerifiedForStudent(s.Requirements, s.StudentType),
                    ChangedBy = changedBy,
                    ChangedOn = changedOn
                });
            }
            var enrollmentStudents = enrollmentStudentsList;

            // Build ForEnrollmentStudents from new students without enrollments
            var newStudentsList = new List<ForEnrollment.ForEnrollmentStudent>();
            foreach (var s in newStudentsOnly)
            {
                var status = s.Status ?? "For Payment";
                var paymentStatus = s.PaymentStatus;

                if (string.IsNullOrWhiteSpace(paymentStatus))
                {
                    paymentStatus = status switch
                    {
                        "Fully Paid" => "Fully Paid",
                        "Partially Paid" => "Partially Paid",
                        _ => "Unpaid"
                    };
                }

                // For re-enrolled students without enrollment records yet, calculate next grade level
                // Get their most recent enrollment to determine current grade level
                string? gradeLevelToShow = null;
                
                // Load section enrollments if not already loaded
                await _context.Entry(s).Collection(st => st.SectionEnrollments).LoadAsync();
                
                if (s.SectionEnrollments != null && s.SectionEnrollments.Any())
                {
                    // Get most recent enrollment (by school year, then by creation date)
                    var mostRecentEnrollment = s.SectionEnrollments
                        .OrderByDescending(e => e.SchoolYear)
                        .ThenByDescending(e => e.CreatedAt)
                        .FirstOrDefault();
                    
                    if (mostRecentEnrollment != null)
                    {
                        // Load section and grade level
                        await _context.Entry(mostRecentEnrollment).Reference(e => e.Section).LoadAsync();
                        if (mostRecentEnrollment.Section != null)
                        {
                            await _context.Entry(mostRecentEnrollment.Section).Reference(sec => sec.GradeLevel).LoadAsync();
                            var currentGradeLevel = mostRecentEnrollment.Section.GradeLevel?.GradeLevelName;
                            
                            // Calculate next grade level for re-enrollment
                            if (!string.IsNullOrWhiteSpace(currentGradeLevel))
                            {
                                gradeLevelToShow = ReEnrollmentService.GetNextGradeLevel(currentGradeLevel);
                            }
                        }
                    }
                }
                
                // Fallback to student's grade level if no enrollment found or calculation failed
                if (string.IsNullOrWhiteSpace(gradeLevelToShow))
                {
                    gradeLevelToShow = s.GradeLevel ?? "N/A";
                }

                var statusLog = statusLogs.GetValueOrDefault(s.StudentId);
                var changedBy = statusLog?.ChangedByName ?? "N/A";
                var changedOn = statusLog?.CreatedAt;

                newStudentsList.Add(new ForEnrollment.ForEnrollmentStudent
                {
                    Id = s.StudentId,
                    Name = $"{s.FirstName} {s.MiddleName} {s.LastName}".Replace("  ", " ").Trim(),
                    LRN = s.Lrn ?? "N/A",
                    Date = FormatDate(s.DateRegistered),
                    Type = s.StudentType,
                    GradeLevel = gradeLevelToShow,
                    Status = status,
                    PaymentStatus = paymentStatus,
                    DocumentsVerified = CalculateDocumentsVerifiedForStudent(s.Requirements, s.StudentType),
                    ChangedBy = changedBy,
                    ChangedOn = changedOn
                });
            }
            var newStudents = newStudentsList;

            // Combine and return
            ForEnrollmentStudents = enrollmentStudents.Concat(newStudents)
                .OrderByDescending(s => s.Date)
                .ToList();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading for enrollment students: {Message}", ex.Message);
            ForEnrollmentStudents = new List<ForEnrollment.ForEnrollmentStudent>();
        }
    }

    private async Task LoadReEnrollmentStudentsAsync()
    {
        try
        {
            // NEW DESIGN: Show students from PREVIOUS school years (old students who want to re-enroll)
            // The re-enrollment tab shows students from any previous school year, not just the immediate previous
            
            if (string.IsNullOrWhiteSpace(CurrentSchoolYear))
            {
                ReEnrollmentStudents = new List<ReEnrollmentStudent>();
                return;
            }

            // Archived statuses - students with these statuses should NOT appear in re-enrollment
            var archivedStatuses = new[] { "Rejected by School", "Application Withdrawn", "Application Withdraw", "Withdrawn", "Graduated", "Transferred" };
            
            // Get all students who have enrollment records from PREVIOUS school years
            // These are old students who may want to re-enroll in the current school year
            // Exclude archived students
            var previousSchoolYearEnrollments = await _context.StudentSectionEnrollments
                .Include(e => e.Student)
                    .ThenInclude(s => s.Requirements)
                .Include(e => e.Section)
                    .ThenInclude(s => s.GradeLevel)
                .Where(e => e.SchoolYear != CurrentSchoolYear && 
                           e.Status == "Enrolled" &&
                           !archivedStatuses.Contains(e.Student.Status ?? "")) // Only completed enrollments from previous years, exclude archived
                .ToListAsync();

            // Group by student to get unique students
            var previousYearStudents = previousSchoolYearEnrollments
                .Select(e => e.Student)
                .Where(s => s != null)
                .Distinct()
                .ToList();
            
            // Filter out students who:
            // 1. Already have enrollment for current school year, OR
            // 2. Have status "For Payment", "Partially Paid", or "Fully Paid" (already re-enrolled for current SY)
            var currentYearEnrollmentStudentIds = await _context.StudentSectionEnrollments
                .Where(e => e.SchoolYear == CurrentSchoolYear)
                .Select(e => e.StudentId)
                .Distinct()
                .ToListAsync();

            // Get students who are already in enrollment process for current SY
            var studentsInEnrollmentProcess = await _context.Students
                .Where(s => (s.Status == "For Payment" || s.Status == "Partially Paid" || s.Status == "Fully Paid") &&
                           !string.IsNullOrWhiteSpace(CurrentSchoolYear))
                .Select(s => s.StudentId)
                .Distinct()
                .ToListAsync();

            var candidatesForReEnrollment = previousYearStudents
                .Where(s => !currentYearEnrollmentStudentIds.Contains(s.StudentId) &&
                           !studentsInEnrollmentProcess.Contains(s.StudentId))
                .ToList();

            var reEnrollmentList = new List<ReEnrollmentStudent>();
            
            foreach (var student in candidatesForReEnrollment)
            {
                // Get the most recent enrollment from previous school years
                await _context.Entry(student).Collection(s => s.SectionEnrollments).LoadAsync();
                
                var mostRecentEnrollment = student.SectionEnrollments
                    .Where(e => e.SchoolYear != CurrentSchoolYear && e.Status == "Enrolled")
                    .OrderByDescending(e => e.SchoolYear)
                    .ThenByDescending(e => e.CreatedAt)
                    .FirstOrDefault();

                if (mostRecentEnrollment == null)
                    continue;

                // Load section details to get grade level
                await _context.Entry(mostRecentEnrollment).Reference(e => e.Section).LoadAsync();
                if (mostRecentEnrollment.Section != null)
                {
                    await _context.Entry(mostRecentEnrollment.Section).Reference(s => s.GradeLevel).LoadAsync();
                }

                var previousSchoolYear = mostRecentEnrollment.SchoolYear;
                var previousGradeLevel = mostRecentEnrollment.Section?.GradeLevel?.GradeLevelName ?? student.GradeLevel ?? "N/A";

                // Check eligibility for current school year enrollment:
                // 1. Check if student has complete grades (Q1-Q4) for the previous school year
                // 2. Check if student has no failing grades (general average >= 75)
                // 3. Check if student has paid all previous balances
                
                bool isEligible = true;
                string eligibilityReason = "";

                if (mostRecentEnrollment.SectionId > 0)
                {
                    // Check complete grades
                    var hasCompleteGrades = await ReEnrollmentService.HasCompleteGradesAsync(
                        student.StudentId, 
                        previousSchoolYear, 
                        mostRecentEnrollment.SectionId);

                    if (!hasCompleteGrades)
                    {
                        isEligible = false;
                        eligibilityReason = "Incomplete grades";
                }
                    else
                    {
                        // Check general average (passing grade is >= 75)
                        var generalAverage = await ReEnrollmentService.CalculateGeneralAverageAsync(
                            student.StudentId,
                            mostRecentEnrollment.SectionId,
                            previousSchoolYear);

                        if (generalAverage < 75)
                        {
                            isEligible = false;
                            eligibilityReason = $"Failed (Average: {generalAverage:F2})";
                        }
                    }
                }

                // Check if student has outstanding balance for the previous school year
                var previousYearPaymentInfo = await PaymentService.GetStudentPaymentInfoBySchoolYearAsync(
                    student.StudentId, 
                    previousSchoolYear);

                if (previousYearPaymentInfo != null && previousYearPaymentInfo.Balance > 0)
                {
                    isEligible = false;
                    eligibilityReason = string.IsNullOrEmpty(eligibilityReason) 
                        ? $"Outstanding balance: Php {previousYearPaymentInfo.Balance:N2}"
                        : $"{eligibilityReason}, Outstanding balance: Php {previousYearPaymentInfo.Balance:N2}";
                }

                // Get payment information for display (from previous school year)
                var paymentInfo = previousYearPaymentInfo ?? await PaymentService.GetStudentPaymentInfoBySchoolYearAsync(
                    student.StudentId, 
                    previousSchoolYear);
                
                reEnrollmentList.Add(new ReEnrollmentStudent
                {
                    Id = student.StudentId,
                    Name = $"{student.FirstName} {student.MiddleName} {student.LastName}".Replace("  ", " ").Trim(),
                    LRN = student.Lrn ?? "N/A",
                    Date = FormatDate(student.DateRegistered),
                    Type = "Old Student", // These are old students from previous school years
                    GradeLevel = previousGradeLevel, // Show grade level from previous enrollment
                    Documents = student.Requirements != null && 
                               student.Requirements.Any() && 
                               student.Requirements.All(r => r.IsVerified || 
                                   (!string.IsNullOrWhiteSpace(r.Status) && 
                                    r.Status.Equals("verified", StringComparison.OrdinalIgnoreCase))) 
                               ? "Validated" : "Not Validated",
                    Status = isEligible ? "Eligible" : $"Not Eligible ({eligibilityReason})",
                    TotalFee = paymentInfo?.TotalFee ?? 0,
                    AmountPaid = paymentInfo?.AmountPaid ?? 0,
                    Balance = paymentInfo?.Balance ?? 0,
                    PaymentStatus = paymentInfo?.PaymentStatus ?? (paymentInfo?.Balance > 0 ? "Unpaid" : "Fully Paid"), // Show "Fully Paid" when balance is 0
                    PreviousSchoolYear = previousSchoolYear, // Store previous school year for reference
                    IsEligible = isEligible
                });
            }
            
            ReEnrollmentStudents = reEnrollmentList.OrderByDescending(s => s.PreviousSchoolYear).ToList();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading re-enrollment students: {Message}", ex.Message);
            ReEnrollmentStudents = new List<ReEnrollmentStudent>();
        }
    }

    private string FormatDate(DateTime? date)
    {
        if (date == null || !date.HasValue)
            return "N/A";

        return date.Value.ToString("MMM. d, yyyy");
    }

    private string FormatDate(string dateString)
    {
        if (string.IsNullOrWhiteSpace(dateString))
            return "N/A";

        // Try to parse the date string in various formats
        if (DateTime.TryParse(dateString, out DateTime date))
        {
            return date.ToString("MMM. d, yyyy");
        }

        // If parsing fails, try common formats
        string[] formats = { "dd MMM yyyy", "MMM dd, yyyy", "yyyy-MM-dd", "MM/dd/yyyy", "dd/MM/yyyy" };
        foreach (var format in formats)
        {
            if (DateTime.TryParseExact(dateString, format, System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.None, out date))
            {
                return date.ToString("MMM. d, yyyy");
            }
        }

        // If all parsing fails, return original string
        return dateString;
    }

    private async Task HandleReEnrollmentRefresh(string studentId)
    {
        try
        {
            // Clear EF Core change tracker to ensure fresh data is loaded
            _context.ChangeTracker.Clear();
            
            // Refresh the re-enrollment list after a student is re-enrolled
            // Also refresh For Enrollment tab since the student should now appear there with "For Payment" status
            await LoadReEnrollmentStudentsAsync();
            await LoadForEnrollmentStudentsAsync(); // Student should now appear in For Enrollment tab
            await LoadEnrolledStudentsAsync();
            
            // Force UI update
            StateHasChanged();
            
            ShowToast($"Student {studentId} has been successfully re-enrolled and moved to For Enrollment tab with 'For Payment' status.", ToastType.Success);
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error refreshing data after re-enrollment for student {StudentId}: {Message}", studentId, ex.Message);
            ShowToast($"Student {studentId} has been re-enrolled, but there was an error refreshing the display. Please refresh the page.", ToastType.Error);
        }
    }

    private async Task HandleReEnrollmentRefreshAll()
    {
        // Refresh all lists after marking students eligible
        await LoadReEnrollmentStudentsAsync();
        await LoadEnrolledStudentsAsync();
    }

    private async Task ShowEnrollmentHistoryAsync(string studentId)
    {
        SelectedStudentForHistory = studentId;
        ShowEnrollmentHistoryModal = true;
        StateHasChanged();

        // Load enrollment history
        try
        {
            var student = await StudentService.GetStudentByIdAsync(studentId);
            if (student != null)
            {
                // Load section enrollments
                await _context.Entry(student).Collection(s => s.SectionEnrollments).LoadAsync();
                
                var historyRecords = new List<EnrollmentHistoryRecord>();
                
                foreach (var enrollment in student.SectionEnrollments.OrderByDescending(e => e.SchoolYear))
                {
                    // Load section details
                    await _context.Entry(enrollment).Reference(e => e.Section).LoadAsync();
                    if (enrollment.Section != null)
                    {
                        await _context.Entry(enrollment.Section).Reference(s => s.GradeLevel).LoadAsync();
                    }

                    // Get payment info for THIS specific school year (historical data)
                    var paymentInfo = await PaymentService.GetStudentPaymentInfoBySchoolYearAsync(studentId, enrollment.SchoolYear);
                    
                    // Use the section's grade level (at enrollment time), not the current student grade level
                    var gradeLevelAtEnrollment = enrollment.Section?.GradeLevel?.GradeLevelName ?? "N/A";
                    
                    // Determine student type at enrollment time
                    // If this is not the first enrollment, it should be "Returnee" or "Old Student"
                    var enrollmentCount = student.SectionEnrollments.Count(e => e.SchoolYear.CompareTo(enrollment.SchoolYear) < 0);
                    var studentTypeAtEnrollment = enrollmentCount > 0 ? "Returnee" : (student.StudentType ?? "N/A");
                    
                    historyRecords.Add(new EnrollmentHistoryRecord
                    {
                        SchoolYear = enrollment.SchoolYear,
                        GradeLevel = gradeLevelAtEnrollment, // Use section's grade level at enrollment time
                        Section = enrollment.Section?.SectionName ?? "N/A",
                        Status = enrollment.Status,
                        StudentType = studentTypeAtEnrollment,
                        EnrollmentDate = enrollment.CreatedAt,
                        PaymentStatus = paymentInfo?.PaymentStatus ?? "Unpaid",
                        TotalFee = paymentInfo?.TotalFee ?? 0,
                        AmountPaid = paymentInfo?.AmountPaid ?? 0,
                        Balance = paymentInfo?.Balance ?? 0,
                        UpdatedAt = enrollment.UpdatedAt?.ToString("MMM. d, yyyy") ?? enrollment.CreatedAt.ToString("MMM. d, yyyy")
                    });
                }

                // Find and update the EnrollmentHistory component
                // Note: We'll need to pass this data through a parameter or use a service
                // For now, we'll store it in a field that the component can access
                EnrollmentHistoryData = historyRecords;
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading enrollment history for student {StudentId}: {Message}", studentId, ex.Message);
            ShowToast($"Error loading enrollment history: {ex.Message}", ToastType.Error);
        }
    }

    private void CloseEnrollmentHistory()
    {
        ShowEnrollmentHistoryModal = false;
        SelectedStudentForHistory = "";
        EnrollmentHistoryData = new List<EnrollmentHistoryRecord>();
        StateHasChanged();
    }

    private List<EnrollmentHistoryRecord> EnrollmentHistoryData { get; set; } = new();
}
</RoleAuthorizeView>
