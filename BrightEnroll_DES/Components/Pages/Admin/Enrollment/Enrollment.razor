@page "/enrollment"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Components.Pages.Admin.Enrollment.EnrollmentComponents
@using BrightEnroll_DES.Components.Pages.Admin.Enrollment.EnrollmentCS
@using BrightEnroll_DES.Components.Pages.Admin.StudentRecord.StudentRecordComponents
@using BrightEnroll_DES.Components.Pages.Admin.StudentRecord.StudentRecordCS
@using BrightEnroll_DES.Data.Models
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Components
@using BrightEnroll_DES.Services.RoleBase
@using Microsoft.Extensions.Logging
@inject StudentService StudentService
@inject EnrollmentStatusService EnrollmentStatusService
@inject ArchiveService ArchiveService
@inject ILoadingService LoadingService
@inject ILogger<Enrollment> Logger
@inject IAuthorizationService AuthorizationService

<PageTitle>Enrollment</PageTitle>

<RoleAuthorizeView RequiredPermission="@Permissions.ViewEnrollment">

<!-- Toast Notification -->
<ToastNotification Show="@showToast" Message="@toastMessage" Type="@toastType" OnClose="@CloseToast" Duration="4000" />

<div class="text-gray-800">
    <h1 class="mb-6 text-2xl font-bold text-gray-800">Enrollment</h1>
    <!-- Tabs Card -->
    <div class="mb-6 overflow-hidden rounded-xl border-b border-gray-200 bg-white px-4 py-2 shadow">
        <div class="flex items-center gap-6">
            <button @onclick="() => SelectedTab = TabType.NewApplicants" 
                    class="@GetTabClasses(TabType.NewApplicants)"
                    style="@GetNewApplicantsStyle()">
                New Applicants
            </button>
            <button @onclick="() => SelectedTab = TabType.ForEnrollment" 
                    class="@GetTabClasses(TabType.ForEnrollment)">
                For Enrollment
            </button>
            <button @onclick="() => SelectedTab = TabType.ReEnrollment" 
                    class="@GetTabClasses(TabType.ReEnrollment)">
                Re-enrollment
            </button>
            <button @onclick="() => SelectedTab = TabType.EnrolledStudent" 
                    class="@GetTabClasses(TabType.EnrolledStudent)">
                Enrolled Student
            </button>
        </div>
    </div>

    <!-- Card Container -->
    <div class="overflow-hidden rounded-xl bg-white shadow">
        @if (SelectedTab == TabType.NewApplicants)
        {
            @if (ShowNewApplicantDetail && SelectedStudentDetail != null)
            {
                <StudentDetail StudentData="SelectedStudentDetail"
                               AcademicRecords="SelectedAcademicRecords"
                               EnrollmentRecords="SelectedEnrollmentRecords"
                               OnBackClick="CloseNewApplicantDetail" />
            }
            else
            {
                <NewApplicant Students="Applicants"
                              RowsPerPage="RowsPerPage"
                              IsLoading="isLoading"
                              OnEditStudent="HandleNewApplicantEdit" />
            }

        }
        else if (SelectedTab == TabType.ForEnrollment)
        {
            <ForEnrollment Students="ForEnrollmentStudents" 
                          RowsPerPage="RowsPerPage" 
                          IsLoading="isLoading"
                          OnEditStudent="HandleForEnrollmentEdit" />
        }
        else if (SelectedTab == TabType.ReEnrollment)
        {
            <ReEnrollment Students="ReEnrollmentStudents" RowsPerPage="RowsPerPage" IsLoading="isLoading" />
        }
        else if (SelectedTab == TabType.EnrolledStudent)
        {
            <Enrolled Students="EnrolledStudents" RowsPerPage="RowsPerPage" IsLoading="isLoading" />
        }
    </div>

    <!-- Edit Modal - Shared across all tabs -->
    @if (ShowEditModal && EditModel != null)
    {
        <NewApplicantEditModal Show="ShowEditModal"
                               Model="EditModel"
                               IsForEnrollmentContext="IsForEnrollmentContext"
                               OnCancel="CloseEditModal"
                               OnSave="SaveEditedApplicantAsync" />
    }
</div>

@code {
    private enum TabType
    {
        NewApplicants,
        ForEnrollment,
        ReEnrollment,
        EnrolledStudent
    }

    private TabType SelectedTab { get; set; } = TabType.NewApplicants;

    private string GetNewApplicantsStyle()
    {
        bool isSelected = SelectedTab == TabType.NewApplicants;
        if (isSelected)
        {
            return "color: #0E335D; border-bottom: 2px solid #0E335D;";
        }
        else
        {
            return "color: #0E335D;";
        }
    }

    private string GetTabClasses(TabType tab)
    {
        bool isSelected = SelectedTab == tab;
        
        return tab switch
        {
            TabType.NewApplicants => isSelected
                ? "px-3 py-2 text-sm font-semibold"
                : "px-3 py-2 text-sm font-semibold transition-colors duration-200",
            TabType.ForEnrollment => isSelected
                ? "px-3 py-2 text-sm font-semibold text-blue-600 border-b-2 border-blue-600"
                : "px-3 py-2 text-sm font-semibold text-blue-600 transition-colors duration-200 hover:text-blue-700",
            TabType.ReEnrollment => isSelected
                ? "px-3 py-2 text-sm font-semibold text-purple-600 border-b-2 border-purple-600"
                : "px-3 py-2 text-sm font-semibold text-purple-600 transition-colors duration-200 hover:text-purple-700",
            TabType.EnrolledStudent => isSelected
                ? "px-3 py-2 text-sm font-semibold text-green-600 border-b-2 border-green-600"
                : "px-3 py-2 text-sm font-semibold text-green-600 transition-colors duration-200 hover:text-green-700",
            _ => "px-3 py-2 text-sm font-semibold"
        };
    }

    private int RowsPerPage { get; set; } = 5;

    private List<NewApplicant.Student> Applicants = new();

    private List<ForEnrollment.ForEnrollmentStudent> ForEnrollmentStudents = new();

    private List<ReEnrollmentStudent> ReEnrollmentStudents = new()
    {
        new() { Id = "00001", Name = "Christine Brooks", LRN = "129706182734", Date = "04 Sep 2025", Type = "Eligible", GradeLevel = "Kinder", Documents = "Verified", Status = "Pending" },
        new() { Id = "00002", Name = "Rosie Pearson", LRN = "129706182712", Date = "28 May 2025", Type = "Eligible", GradeLevel = "Kinder", Documents = "Verified", Status = "Pending" },
        new() { Id = "00003", Name = "Darrell Caldwell", LRN = "129706182737", Date = "23 Nov 2025", Type = "Eligible", GradeLevel = "G1", Documents = "Verified", Status = "Pending" },
        new() { Id = "00004", Name = "Gilbert Johnston", LRN = "129706182715", Date = "05 Feb 2025", Type = "Eligible", GradeLevel = "Kinder", Documents = "Verified", Status = "Pending" },
        new() { Id = "00005", Name = "Alan Cain", LRN = "129706182748", Date = "29 Jul 2025", Type = "Eligible", GradeLevel = "G4", Documents = "Verified", Status = "Pending" },
        new() { Id = "00006", Name = "Alfred Murray", LRN = "129706182719", Date = "15 Aug 2025", Type = "Eligible", GradeLevel = "Kinder", Documents = "Verified", Status = "Pending" },
        new() { Id = "00007", Name = "Maggie Sullivan", LRN = "129706182733", Date = "21 Dec 2025", Type = "Eligible", GradeLevel = "G1", Documents = "Verified", Status = "Pending" },
        new() { Id = "00008", Name = "Rosie Todd", LRN = "129706182732", Date = "30 Apr 2025", Type = "Eligible", GradeLevel = "G5", Documents = "Verified", Status = "Pending" },
        new() { Id = "00009", Name = "Dollie Hines", LRN = "129706182721", Date = "09 Jan 2025", Type = "Eligible", GradeLevel = "G3", Documents = "Verified", Status = "Pending" }
    };

    private List<EnrolledStudent> EnrolledStudents = new();
    private bool isLoading = true;

    // Edit modal state for New Applicants
    private bool ShowEditModal { get; set; } = false;
    private StudentEditModel? EditModel { get; set; }
    private bool IsForEnrollmentContext { get; set; } = false;

    // New Applicant detail state
    private bool ShowNewApplicantDetail { get; set; } = false;
    private BrightEnroll_DES.Data.Models.Student? SelectedNewApplicant { get; set; }
    private StudentDetailData? SelectedStudentDetail { get; set; }
    private List<AcademicRecordData> SelectedAcademicRecords { get; set; } = new();
    private List<EnrollmentStatusData> SelectedEnrollmentRecords { get; set; } = new();

    // Toast notification state
    private bool showToast = false;
    private string toastMessage = "";
    private ToastType toastType = ToastType.Success;

    private void ShowToast(string message, ToastType type)
    {
        toastMessage = message;
        toastType = type;
        showToast = true;
        StateHasChanged();
    }

    private void CloseToast()
    {
        showToast = false;
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        // Hide loading screen immediately when page loads
        LoadingService.HideLoading();
        
        isLoading = true;
        try
        {
            await LoadNewApplicantsAsync();
            await LoadForEnrollmentStudentsAsync();
            await LoadReEnrollmentStudentsAsync();
            await LoadEnrolledStudentsAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadNewApplicantsAsync()
    {
        try
        {
            var newApplicantsDto = await StudentService.GetNewApplicantsAsync();
            
            // Map NewApplicantDto to NewApplicant.Student
            Applicants = newApplicantsDto.Select(dto => new NewApplicant.Student
            {
                Id = dto.Id,
                Name = dto.Name,
                LRN = dto.LRN ?? "N/A",
                Date = dto.Date,
                Type = dto.Type,
                GradeLevel = dto.GradeLevel,
                Status = dto.Status,
                DocumentsVerified = dto.DocumentsVerified
            }).ToList();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading new applicants: {Message}", ex.Message);
            Applicants = new List<NewApplicant.Student>();
        }
    }

    private async Task LoadEnrolledStudentsAsync()
    {
        try
        {
            var enrolledStudentsDto = await StudentService.GetEnrolledStudentsAsync();
            
            // Map EnrolledStudentDto to EnrolledStudent
            EnrolledStudents = enrolledStudentsDto.Select(dto => new EnrolledStudent
            {
                Id = dto.Id,
                Name = dto.Name,
                LRN = dto.LRN,
                Date = dto.Date,
                GradeLevel = dto.GradeLevel,
                Section = dto.Section,
                Documents = dto.Documents,
                Status = dto.Status
            }).ToList();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading enrolled students: {Message}", ex.Message);
            EnrolledStudents = new List<EnrolledStudent>();
        }
    }

    private async Task HandleNewApplicantEdit(string studentId)
    {
        isLoading = true;
        try
        {
            var student = await StudentService.GetStudentByIdAsync(studentId);
            SelectedNewApplicant = student;

            if (student != null)
            {
                var fullName = $"{student.FirstName} {student.MiddleName} {student.LastName}".Replace("  ", " ").Trim();

                var documentsVerified = student.Requirements != null &&
                                        student.Requirements.Any() &&
                                        student.Requirements.All(IsRequirementVerified);

                SelectedStudentDetail = new StudentDetailData
                {
                    Id = student.StudentId,
                    FullName = fullName,
                    FirstName = student.FirstName,
                    MiddleName = student.MiddleName ?? string.Empty,
                    LastName = student.LastName,
                    Suffix = student.Suffix ?? "N/A",
                    GradeLevel = student.GradeLevel ?? "N/A",
                    Section = "N/A",
                    SchoolYear = student.SchoolYr ?? "N/A",
                    Status = student.Status ?? string.Empty,
                    LRN = student.Lrn ?? "N/A",
                    BirthDate = student.Birthdate,
                    PlaceOfBirth = student.PlaceOfBirth ?? "N/A",
                    Sex = student.Sex,
                    MotherTongue = student.MotherTongue ?? "N/A",
                    IsIPCommunity = student.IpComm == true ? "Yes" : "No",
                    IPCommunitySpecify = student.IpSpecify ?? string.Empty,
                    Is4PsBeneficiary = student.FourPs == true ? "Yes" : "No",
                    FourPsHouseholdId = student.FourPsHseId ?? string.Empty,
                    CurrentHouseNo = student.HseNo ?? string.Empty,
                    CurrentStreetName = student.Street ?? string.Empty,
                    CurrentBarangay = student.Brngy ?? string.Empty,
                    CurrentCity = student.City ?? string.Empty,
                    CurrentProvince = student.Province ?? string.Empty,
                    CurrentCountry = student.Country ?? string.Empty,
                    CurrentZipCode = student.ZipCode ?? string.Empty,
                    SameAsCurrentAddress = false,
                    PermanentHouseNo = student.PhseNo ?? string.Empty,
                    PermanentStreetName = student.Pstreet ?? string.Empty,
                    PermanentBarangay = student.Pbrngy ?? string.Empty,
                    PermanentCity = student.Pcity ?? string.Empty,
                    PermanentProvince = student.Pprovince ?? string.Empty,
                    PermanentCountry = student.Pcountry ?? string.Empty,
                    PermanentZipCode = student.PzipCode ?? string.Empty,
                    GuardianFirstName = student.Guardian?.FirstName ?? string.Empty,
                    GuardianMiddleName = student.Guardian?.MiddleName ?? string.Empty,
                    GuardianLastName = student.Guardian?.LastName ?? string.Empty,
                    GuardianSuffix = student.Guardian?.Suffix ?? string.Empty,
                    GuardianContactNumber = student.Guardian?.ContactNum ?? string.Empty,
                    GuardianRelationship = student.Guardian?.Relationship ?? string.Empty,
                    StudentType = student.StudentType ?? string.Empty,
                    HasLRN = string.IsNullOrWhiteSpace(student.Lrn) ? "No" : "Yes",
                    LearnerReferenceNo = student.Lrn ?? "N/A",
                    GradeToEnroll = student.GradeLevel ?? "N/A",
                    HasBirthCertificate = student.Requirements != null && student.Requirements.Any(IsRequirementVerified)
                };

                SelectedAcademicRecords = new List<AcademicRecordData>();
                SelectedEnrollmentRecords = new List<EnrollmentStatusData>
                {
                    new()
                    {
                        SchoolYear = student.SchoolYr ?? "N/A",
                        Grade = student.GradeLevel ?? "N/A",
                        Section = "N/A",
                        Type = student.StudentType ?? string.Empty,
                        Documents = documentsVerified ? "Verified" : "Not verified",
                        Status = student.Status ?? string.Empty
                    }
                };

                // Prepare edit model for modal (mirrors registration + status/requirements)
                EditModel = new StudentEditModel
                {
                    StudentId = student.StudentId,
                    FirstName = student.FirstName,
                    MiddleName = student.MiddleName ?? string.Empty,
                    LastName = student.LastName,
                    Suffix = student.Suffix ?? string.Empty,
                    BirthDate = student.Birthdate,
                    Age = student.Age,
                    PlaceOfBirth = student.PlaceOfBirth ?? string.Empty,
                    Sex = student.Sex,
                    MotherTongue = student.MotherTongue ?? string.Empty,
                    MotherTongueOther = string.Empty, // Not stored in Student model
                    IsIPCommunity = student.IpComm == true ? "Yes" : "No",
                    IPCommunitySpecify = student.IpSpecify ?? string.Empty,
                    IPCommunitySpecifyOther = string.Empty, // Not stored in Student model
                    Is4PsBeneficiary = student.FourPs == true ? "Yes" : "No",
                    FourPsHouseholdId = student.FourPsHseId ?? string.Empty,
                    CurrentHouseNo = student.HseNo ?? string.Empty,
                    CurrentStreetName = student.Street ?? string.Empty,
                    CurrentBarangay = student.Brngy ?? string.Empty,
                    CurrentCity = student.City ?? string.Empty,
                    CurrentProvince = student.Province ?? string.Empty,
                    CurrentCountry = student.Country ?? string.Empty,
                    CurrentZipCode = student.ZipCode ?? string.Empty,
                    SameAsCurrentAddress = false,
                    PermanentHouseNo = student.PhseNo ?? string.Empty,
                    PermanentStreetName = student.Pstreet ?? string.Empty,
                    PermanentBarangay = student.Pbrngy ?? string.Empty,
                    PermanentCity = student.Pcity ?? string.Empty,
                    PermanentProvince = student.Pprovince ?? string.Empty,
                    PermanentCountry = student.Pcountry ?? string.Empty,
                    PermanentZipCode = student.PzipCode ?? string.Empty,
                    GuardianFirstName = student.Guardian?.FirstName ?? string.Empty,
                    GuardianMiddleName = student.Guardian?.MiddleName ?? string.Empty,
                    GuardianLastName = student.Guardian?.LastName ?? string.Empty,
                    GuardianSuffix = student.Guardian?.Suffix ?? string.Empty,
                    GuardianContactNumber = student.Guardian?.ContactNum ?? string.Empty,
                    GuardianRelationship = student.Guardian?.Relationship ?? string.Empty,
                    GuardianRelationshipOther = string.Empty, // Not stored in Guardian model
                    StudentType = student.StudentType ?? string.Empty,
                    HasLRN = string.IsNullOrWhiteSpace(student.Lrn) ? "No" : "Yes",
                    LearnerReferenceNo = student.Lrn ?? "N/A",
                    SchoolYear = student.SchoolYr ?? string.Empty,
                    GradeToEnroll = student.GradeLevel ?? string.Empty,
                    Status = student.Status ?? "Pending",
                    // Map requirement checkboxes from Status field (since IsVerified is ignored in AppDbContext)
                    // Check Status field directly - "verified" means checked, anything else means unchecked
                    HasPSABirthCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "PSA Birth Certificate")),
                    HasBaptismalCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Baptismal Certificate")),
                    HasReportCard = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Report Card")),
                    HasForm138 = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Form 138 (Report Card)")),
                    HasForm137 = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Form 137 (Permanent Record)")),
                    HasGoodMoralCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Good Moral Certificate")),
                    HasTransferCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Transfer Certificate")),
                    HasUpdatedEnrollmentForm = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Updated Enrollment Form")),
                    HasClearance = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Clearance"))
                };

                // Load reason from archive if student was previously archived
                if (student.Status == "Rejected by School" || student.Status == "Application Withdrawn")
                {
                    try
                    {
                        var archive = await ArchiveService.GetArchivedStudentAsync(student.StudentId);
                        if (archive != null && !string.IsNullOrWhiteSpace(archive.Reason))
                        {
                            EditModel.RejectionReason = archive.Reason;
                        }
                    }
                    catch
                    {
                        // Archive not found or error - continue without reason
                    }
                }

                IsForEnrollmentContext = false;
                ShowEditModal = true;
                ShowNewApplicantDetail = false;
            }
            else
            {
                ShowNewApplicantDetail = false;
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading new applicant detail for {StudentId}: {Message}", studentId, ex.Message);
            SelectedNewApplicant = null;
            SelectedStudentDetail = null;
            SelectedAcademicRecords = new List<AcademicRecordData>();
            SelectedEnrollmentRecords = new List<EnrollmentStatusData>();
            ShowNewApplicantDetail = false;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleForEnrollmentEdit(string studentId)
    {
        isLoading = true;
        IsForEnrollmentContext = true;
        try
        {
            var student = await StudentService.GetStudentByIdAsync(studentId);

            if (student != null)
            {
                // Prepare edit model for modal (mirrors registration + status/requirements)
                EditModel = new StudentEditModel
                {
                    StudentId = student.StudentId,
                    FirstName = student.FirstName,
                    MiddleName = student.MiddleName ?? string.Empty,
                    LastName = student.LastName,
                    Suffix = student.Suffix ?? string.Empty,
                    BirthDate = student.Birthdate,
                    Age = student.Age,
                    PlaceOfBirth = student.PlaceOfBirth ?? string.Empty,
                    Sex = student.Sex,
                    MotherTongue = student.MotherTongue ?? string.Empty,
                    MotherTongueOther = string.Empty, // Not stored in Student model
                    IsIPCommunity = student.IpComm == true ? "Yes" : "No",
                    IPCommunitySpecify = student.IpSpecify ?? string.Empty,
                    IPCommunitySpecifyOther = string.Empty, // Not stored in Student model
                    Is4PsBeneficiary = student.FourPs == true ? "Yes" : "No",
                    FourPsHouseholdId = student.FourPsHseId ?? string.Empty,
                    CurrentHouseNo = student.HseNo ?? string.Empty,
                    CurrentStreetName = student.Street ?? string.Empty,
                    CurrentBarangay = student.Brngy ?? string.Empty,
                    CurrentCity = student.City ?? string.Empty,
                    CurrentProvince = student.Province ?? string.Empty,
                    CurrentCountry = student.Country ?? string.Empty,
                    CurrentZipCode = student.ZipCode ?? string.Empty,
                    SameAsCurrentAddress = false,
                    PermanentHouseNo = student.PhseNo ?? string.Empty,
                    PermanentStreetName = student.Pstreet ?? string.Empty,
                    PermanentBarangay = student.Pbrngy ?? string.Empty,
                    PermanentCity = student.Pcity ?? string.Empty,
                    PermanentProvince = student.Pprovince ?? string.Empty,
                    PermanentCountry = student.Pcountry ?? string.Empty,
                    PermanentZipCode = student.PzipCode ?? string.Empty,
                    GuardianFirstName = student.Guardian?.FirstName ?? string.Empty,
                    GuardianMiddleName = student.Guardian?.MiddleName ?? string.Empty,
                    GuardianLastName = student.Guardian?.LastName ?? string.Empty,
                    GuardianSuffix = student.Guardian?.Suffix ?? string.Empty,
                    GuardianContactNumber = student.Guardian?.ContactNum ?? string.Empty,
                    GuardianRelationship = student.Guardian?.Relationship ?? string.Empty,
                    GuardianRelationshipOther = string.Empty, // Not stored in Guardian model
                    StudentType = student.StudentType ?? string.Empty,
                    HasLRN = string.IsNullOrWhiteSpace(student.Lrn) ? "No" : "Yes",
                    LearnerReferenceNo = student.Lrn ?? "N/A",
                    SchoolYear = student.SchoolYr ?? string.Empty,
                    GradeToEnroll = student.GradeLevel ?? string.Empty,
                    Status = student.Status ?? "For Payment",
                    // Map requirement checkboxes from Status field (since IsVerified is ignored in AppDbContext)
                    // Check Status field directly - "verified" means checked, anything else means unchecked
                    HasPSABirthCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "PSA Birth Certificate")),
                    HasBaptismalCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Baptismal Certificate")),
                    HasReportCard = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Report Card")),
                    HasForm138 = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Form 138 (Report Card)")),
                    HasForm137 = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Form 137 (Permanent Record)")),
                    HasGoodMoralCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Good Moral Certificate")),
                    HasTransferCert = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Transfer Certificate")),
                    HasUpdatedEnrollmentForm = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Updated Enrollment Form")),
                    HasClearance = IsRequirementChecked(student.Requirements?.FirstOrDefault(r => r.RequirementName == "Clearance"))
                };

                ShowEditModal = true;
                StateHasChanged(); // Trigger UI update to show modal
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading for enrollment student detail for {StudentId}: {Message}", studentId, ex.Message);
            EditModel = null;
            ShowToast($"Error loading student: {ex.Message}", ToastType.Error);
        }
        finally
        {
            isLoading = false;
            StateHasChanged(); // Ensure UI updates even if there's an error
        }
    }

    // Treat a requirement as verified if either the new boolean flag is true
    // or, for older records, the legacy Status string is "verified".
    private static bool IsRequirementVerified(StudentRequirement r)
    {
        if (r == null) return false;

        if (r.IsVerified)
        {
            return true;
        }

        return !string.IsNullOrWhiteSpace(r.Status) &&
               r.Status.Equals("verified", StringComparison.OrdinalIgnoreCase);
    }
    
    // Check if a requirement is checked based on Status field (since IsVerified is ignored in AppDbContext)
    // Status "verified" means checked, anything else means unchecked
    private static bool IsRequirementChecked(StudentRequirement? requirement)
    {
        if (requirement == null) return false;
        
        // Check Status field as primary source (since IsVerified is ignored in EF Core)
        return !string.IsNullOrWhiteSpace(requirement.Status) &&
               requirement.Status.Equals("verified", StringComparison.OrdinalIgnoreCase);
    }
    
    // Helper method to calculate if all required documents for a student type are verified
    private static bool CalculateDocumentsVerifiedForStudent(ICollection<StudentRequirement>? requirements, string? studentType)
    {
        if (requirements == null || !requirements.Any())
        {
            return false;
        }
        
        // Get the list of required document names for this student type
        var requiredNames = GetRequiredDocumentNamesForStudentType(studentType);
        
        if (!requiredNames.Any())
        {
            return false; // No requirements defined for this student type
        }
        
        // Check if all required documents are verified
        foreach (var requiredName in requiredNames)
        {
            var requirement = requirements.FirstOrDefault(r => r.RequirementName == requiredName);
            if (requirement == null)
            {
                // Required document doesn't exist - not verified
                return false;
            }
            
            // Check if this requirement is verified (using Status field since IsVerified is ignored)
            bool isVerified = !string.IsNullOrWhiteSpace(requirement.Status) && 
                             requirement.Status.Equals("verified", StringComparison.OrdinalIgnoreCase);
            
            if (!isVerified)
            {
                // At least one required document is not verified
                return false;
            }
        }
        
        // All required documents are verified
        return true;
    }
    
    // Helper method to get required document names for a student type
    private static HashSet<string> GetRequiredDocumentNamesForStudentType(string? studentType)
    {
        var requiredNames = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        
        if (string.IsNullOrWhiteSpace(studentType))
        {
            return requiredNames;
        }
        
        var studentTypeLower = studentType.ToLower();
        
        switch (studentTypeLower)
        {
            case "new student":
                requiredNames.Add("PSA Birth Certificate");
                requiredNames.Add("Baptismal Certificate");
                requiredNames.Add("Report Card");
                break;
                
            case "transferee":
                requiredNames.Add("PSA Birth Certificate");
                requiredNames.Add("Baptismal Certificate");
                requiredNames.Add("Form 138 (Report Card)");
                requiredNames.Add("Form 137 (Permanent Record)");
                requiredNames.Add("Good Moral Certificate");
                requiredNames.Add("Transfer Certificate");
                break;
                
            case "returnee":
                requiredNames.Add("Form 138 (Report Card)");
                requiredNames.Add("Updated Enrollment Form");
                requiredNames.Add("Clearance");
                break;
        }
        
        return requiredNames;
    }

    private void CloseNewApplicantDetail()
    {
        ShowNewApplicantDetail = false;
        SelectedNewApplicant = null;
        SelectedStudentDetail = null;
        SelectedAcademicRecords = new List<AcademicRecordData>();
        SelectedEnrollmentRecords = new List<EnrollmentStatusData>();
        ShowEditModal = false;
        EditModel = null;
    }

    private void CloseEditModal()
    {
        ShowEditModal = false;
        EditModel = null;
        IsForEnrollmentContext = false;
    }

    private async Task SaveEditedApplicantAsync(StudentEditModel model)
    {
        try
        {
            // Get current student to check status transition
            var currentStudent = await StudentService.GetStudentByIdAsync(model.StudentId);
            string? oldStatus = currentStudent?.Status;
            bool statusChanged = currentStudent != null && currentStudent.Status != model.Status;
            
            if (statusChanged)
            {
                // Use EnrollmentStatusService to validate and update status
                var statusUpdated = await EnrollmentStatusService.UpdateStudentStatusAsync(
                    model.StudentId, 
                    model.Status);
                
                if (!statusUpdated)
                {
                    Logger?.LogWarning(
                        "Status transition not allowed for student {StudentId}: {OldStatus} -> {NewStatus}",
                        model.StudentId, oldStatus ?? "Unknown", model.Status);
                    // Continue with update anyway, but log the warning
                }
            }

            // Update student information
            await StudentService.UpdateStudentAsync(model);
            
            // If student is rejected or withdrawn, archive them
            // Note: Status is already updated by UpdateStudentAsync above, so we just need to mark as archived
            if (model.Status == "Rejected by School" || model.Status == "Application Withdrawn" || model.Status == "Application Withdraw")
            {
                try
                {
                    // Check if already archived
                    var isArchived = await ArchiveService.IsStudentArchivedAsync(model.StudentId);
                    if (!isArchived)
                    {
                        // Archive the student (status is already updated, this just confirms archiving)
                        await ArchiveService.ArchiveStudentAsync(
                            model.StudentId,
                            model.Status, // Status already updated by UpdateStudentAsync
                            notes: null,
                            archivedBy: null,
                            reason: model.RejectionReason
                        );
                    }
                    else
                    {
                        // Update existing archive with reason
                        await ArchiveService.UpdateArchiveAsync(
                            model.StudentId,
                            archiveReason: model.Status,
                            reason: model.RejectionReason
                        );
                    }
                    
                    // Show success toast for archiving
                    ShowToast($"Student {model.StudentId} has been archived with status: {model.Status}.", ToastType.Success);
                }
                catch (Exception archiveEx)
                {
                    // Log full error details for debugging
                    Logger?.LogError(archiveEx, 
                        "Error archiving student {StudentId}: {Message}. " +
                        "Stack Trace: {StackTrace}. " +
                        "Inner Exception: {InnerException}",
                        model.StudentId, 
                        archiveEx.Message,
                        archiveEx.StackTrace,
                        archiveEx.InnerException?.Message ?? "None");
                    
                    // Show detailed error message
                    var errorMsg = archiveEx.Message;
                    if (archiveEx.InnerException != null)
                    {
                        errorMsg += $" ({archiveEx.InnerException.Message})";
                    }
                    ShowToast($"Error archiving student: {errorMsg}", ToastType.Error);
                }
            }
            else if (statusChanged)
            {
                // Determine toast type based on new status
                if (model.Status == "For Payment" || model.Status == "Eligible" || model.Status == "Enrolled")
                {
                    // Green toast for enrollment success
                    string statusMessage = model.Status switch
                    {
                        "For Payment" => "moved to For Enrollment",
                        "Eligible" => "marked as eligible for enrollment",
                        "Enrolled" => "successfully enrolled",
                        _ => $"status changed to {model.Status}"
                    };
                    ShowToast($"Student {model.StudentId} {statusMessage}.", ToastType.Success);
                }
                else
                {
                    // Yellow toast for other status changes
                    ShowToast($"Student {model.StudentId} status updated from {oldStatus} to {model.Status}.", ToastType.Edit);
                }
            }
            else
            {
                // Yellow toast for edit without status change
                ShowToast($"Student {model.StudentId} information updated.", ToastType.Edit);
            }
            
            ShowEditModal = false;

            // Refresh tables so changes reflect in UI
            await LoadNewApplicantsAsync();
            await LoadForEnrollmentStudentsAsync();
            await LoadReEnrollmentStudentsAsync();
            await LoadEnrolledStudentsAsync();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error updating applicant {StudentId}: {Message}", model.StudentId, ex.Message);
            ShowToast($"Error updating student: {ex.Message}", ToastType.Error);
        }
    }

    private async Task LoadForEnrollmentStudentsAsync()
    {
        try
        {
            // Get students with status: For Payment, Partially Paid, or Fully Paid
            // These are all students eligible for enrollment (payment status determines eligibility)
            var students = await EnrollmentStatusService.GetStudentsByStatusesAsync(
                "For Payment", 
                "Partially Paid", 
                "Fully Paid"
            );
            
            ForEnrollmentStudents = students.Select(s => new ForEnrollment.ForEnrollmentStudent
            {
                Id = s.StudentId,
                Name = $"{s.FirstName} {s.MiddleName} {s.LastName}".Replace("  ", " ").Trim(),
                LRN = s.Lrn ?? "N/A",
                Date = FormatDate(s.DateRegistered),
                Type = s.StudentType,
                GradeLevel = s.GradeLevel ?? "N/A",
                Status = s.Status ?? "For Payment",
                PaymentStatus = s.PaymentStatus ?? "Unpaid",
                DocumentsVerified = CalculateDocumentsVerifiedForStudent(s.Requirements, s.StudentType)
            }).ToList();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading for enrollment students: {Message}", ex.Message);
            ForEnrollmentStudents = new List<ForEnrollment.ForEnrollmentStudent>();
        }
    }

    private async Task LoadReEnrollmentStudentsAsync()
    {
        try
        {
            // Get students with Eligible status
            var students = await EnrollmentStatusService.GetStudentsByStatusAsync("Eligible");
            
            ReEnrollmentStudents = students.Select(s => new ReEnrollmentStudent
            {
                Id = s.StudentId,
                Name = $"{s.FirstName} {s.MiddleName} {s.LastName}".Replace("  ", " ").Trim(),
                LRN = s.Lrn ?? "N/A",
                Date = FormatDate(s.DateRegistered),
                Type = "Eligible", // All in re-enrollment are eligible
                GradeLevel = s.GradeLevel ?? "N/A",
                Documents = s.Requirements != null && 
                           s.Requirements.Any() && 
                           s.Requirements.All(r => r.IsVerified || 
                               (!string.IsNullOrWhiteSpace(r.Status) && 
                                r.Status.Equals("verified", StringComparison.OrdinalIgnoreCase))) 
                           ? "Verified" : "Not verified",
                Status = s.Status
            }).ToList();
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading re-enrollment students: {Message}", ex.Message);
            ReEnrollmentStudents = new List<ReEnrollmentStudent>();
        }
    }

    private string FormatDate(DateTime? date)
    {
        if (date == null || !date.HasValue)
            return "N/A";

        return date.Value.ToString("MMM. d, yyyy");
    }

    private string FormatDate(string dateString)
    {
        if (string.IsNullOrWhiteSpace(dateString))
            return "N/A";

        // Try to parse the date string in various formats
        if (DateTime.TryParse(dateString, out DateTime date))
        {
            return date.ToString("MMM. d, yyyy");
        }

        // If parsing fails, try common formats
        string[] formats = { "dd MMM yyyy", "MMM dd, yyyy", "yyyy-MM-dd", "MM/dd/yyyy", "dd/MM/yyyy" };
        foreach (var format in formats)
        {
            if (DateTime.TryParseExact(dateString, format, System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.None, out date))
            {
                return date.ToString("MMM. d, yyyy");
            }
        }

        // If all parsing fails, return original string
        return dateString;
    }
}
</RoleAuthorizeView>
