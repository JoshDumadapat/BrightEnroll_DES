@namespace BrightEnroll_DES.Components.Pages.SuperAdmin.AuditLogComponents
@using BrightEnroll_DES.Components.Pages.SuperAdmin.AuditLogCS
@inject IJSRuntime JSRuntime
@* SuperAdmin Audit Log Card Component with Filters *@

<!-- Filters -->
<div class="border-b border-gray-200 px-3 py-4 sm:px-6">
    <label class="mb-2 block text-sm font-bold text-gray-700">Filter:</label>
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
            <div class="relative flex w-full items-center sm:w-auto sm:min-w-[200px]">
                <span class="absolute left-4 flex items-center justify-center">
                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </span>
                <div class="group relative w-full">
                    <input type="text" placeholder="Search here..." @bind="SearchText" @bind:after="OnSearchChanged"
                           class="w-full rounded-lg border border-gray-300 py-2 pl-11 pr-4 text-sm text-gray-700 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400" />
                    <span class="tooltip-delay">Search audit logs by user, action, module, description, or log ID</span>
                </div>
            </div>
            <div class="group relative">
                <select @bind="ModuleFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                    <option value="">All Modules</option>
                    <option value="Super Admin">Super Admin</option>
                    <option value="Customer Management">Customer Management</option>
                    <option value="Subscription Management">Subscription Management</option>
                    <option value="Support">Support</option>
                    <option value="BIR Compliance">BIR Compliance</option>
                    <option value="Sales">Sales</option>
                    <option value="Cloud Management">Cloud Management</option>
                    <option value="Settings">Settings</option>
                    <option value="Authentication">Authentication</option>
                </select>
                <span class="tooltip-delay">Filter logs by module category</span>
            </div>
            <div class="group relative">
                <select @bind="ActionFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                    <option value="">All Actions</option>
                    <option value="User Login">User Login</option>
                    <option value="User Logout">User Logout</option>
                    <option value="Failed Login Attempt">Failed Login Attempt</option>
                    <option value="Create Customer">Create Customer</option>
                    <option value="Update Customer">Update Customer</option>
                    <option value="Delete Customer">Delete Customer</option>
                    <option value="Create Subscription">Create Subscription</option>
                    <option value="Update Subscription">Update Subscription</option>
                    <option value="Cancel Subscription">Cancel Subscription</option>
                    <option value="Create Support Ticket">Create Support Ticket</option>
                    <option value="Update Support Ticket">Update Support Ticket</option>
                    <option value="Create Invoice">Create Invoice</option>
                    <option value="Process Payment">Process Payment</option>
                    <option value="BIR Filing">BIR Filing</option>
                    <option value="System Settings Change">System Settings Change</option>
                    <option value="Export Report">Export Report</option>
                    <option value="Delete Record">Delete Record</option>
                </select>
                <span class="tooltip-delay">Filter logs by specific action type</span>
            </div>
            <div class="group relative">
                <select @bind="StatusFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                    <option value="">All Status</option>
                    <option value="Success">Success</option>
                    <option value="Failed">Failed</option>
                </select>
                <span class="tooltip-delay">Filter logs by status (Success or Failed)</span>
            </div>
            <div class="group relative">
                <select @bind="SeverityFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                    <option value="">All Severity</option>
                    <option value="Low">Low</option>
                    <option value="Moderate">Moderate</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                </select>
                <span class="tooltip-delay">Filter logs by severity level (Low, Moderate, High, Critical)</span>
            </div>
            <div class="group relative">
                <select @bind="RoleFilter" @bind:after="OnFilterChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-600 outline-none focus:border-gray-300 focus:ring-2 focus:ring-blue-400 sm:w-auto">
                    <option value="">All Roles</option>
                    <option value="SuperAdmin">SuperAdmin</option>
                    <option value="Super Admin">Super Admin</option>
                </select>
                <span class="tooltip-delay">Filter logs by user role</span>
            </div>
        </div>
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
            <button @onclick="ClearFilters" class="flex w-full items-center justify-center gap-2 rounded-lg bg-gray-500 px-4 py-2 font-semibold text-white shadow-md transition-all duration-300 hover:bg-gray-600 hover:shadow-lg sm:w-auto" style="font-size: 13px;">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Clear
            </button>
            <div class="group relative">
                <button @onclick="ExportPDF" class="flex w-full items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 py-2 font-semibold text-white shadow-md transition-all duration-300 hover:bg-blue-700 hover:shadow-lg sm:w-auto" style="font-size: 13px;">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Export
                </button>
                <span class="tooltip-delay">Export audit logs to PDF file</span>
            </div>
        </div>
    </div>
</div>

<!-- List View Container (Scrollable) -->
<div class="max-h-[450px] overflow-y-auto">
    @if (Logs != null && Logs.Any() && FilteredLogs.Any())
    {
        <div class="divide-y divide-gray-200">
            @foreach (var log in PaginatedLogs)
            {
                var isSelected = SelectedLog?.Id == log.Id;
                var isHovered = HoveredLog?.Id == log.Id;
                var isFirstLog = log == PaginatedLogs.First();
                var showBlueIndicator = isHovered || (isSelected && ShowDetailModal) || (isFirstLog && !ShowDetailModal && HoveredLog == null);
                <div @onclick="() => OpenDetailModal(log)" 
                     @onmouseenter="() => HoverLog(log)"
                     @onmouseleave="() => HoverLog(null)"
                     class="group relative cursor-pointer px-4 py-4 transition-all duration-150 sm:px-6 @(isHovered ? "bg-gray-100" : "bg-white") hover:bg-gray-50">
                    <div class="absolute left-0 top-0 h-full w-1 transition-colors duration-150 @(showBlueIndicator ? "bg-blue-500" : "bg-gray-300")"></div>
                <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                    <!-- Left Section: Module, Action, Description -->
                    <div class="flex-1 min-w-0">
                        <div class="mb-2 flex flex-wrap items-center gap-2">
                            <span class="group relative inline-block rounded-full bg-gray-500 px-2.5 py-0.5 text-xs font-semibold text-white whitespace-nowrap">
                                @log.Module
                                <span class="tooltip-delay">Module: @log.Module</span>
                            </span>
                            <span class="group relative inline-block rounded-full px-2.5 py-0.5 text-xs font-medium @GetStatusClass(log.Status) whitespace-nowrap">
                                @log.Status
                                <span class="tooltip-delay">Status: @log.Status</span>
                            </span>
                            @{
                                var severity = string.IsNullOrWhiteSpace(log.Severity) 
                                    ? DetermineSeverity(log.Action, log.Module, log.Status) 
                                    : log.Severity;
                            }
                            <span class="group relative inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs font-semibold @GetSeverityClass(severity) whitespace-nowrap shadow-sm">
                                @if (severity.Equals("High", StringComparison.OrdinalIgnoreCase) || severity.Equals("Critical", StringComparison.OrdinalIgnoreCase))
                                {
                                    <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                }
                                else if (severity.Equals("Moderate", StringComparison.OrdinalIgnoreCase) || severity.Equals("Medium", StringComparison.OrdinalIgnoreCase))
                                {
                                    <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                }
                                else
                                {
                                    <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                }
                                <span>@severity</span>
                                <span class="tooltip-delay">Severity Level: @severity - @GetSeverityDescription(severity)</span>
                            </span>
                        </div>
                        <h3 class="mb-1 text-sm font-semibold text-blue-600">
                            @log.Action
                        </h3>
                        <p class="text-sm text-gray-600 line-clamp-1">@log.Description</p>
                    </div>

                    <!-- Middle Section: User, Role, Timestamp, IP -->
                    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-6">
                        <div class="flex items-center gap-2 text-xs text-gray-600">
                            <svg class="h-4 w-4 flex-shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <div class="flex flex-col sm:flex-row sm:gap-1">
                                <span class="font-medium text-gray-900">@log.User</span>
                                <span class="text-gray-500 sm:before:content-['â€¢'] sm:before:mx-1">@log.Role</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-gray-500">
                            <svg class="h-4 w-4 flex-shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>@log.Timestamp.ToString("MMM dd, yyyy HH:mm")</span>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-gray-500">
                            <svg class="h-4 w-4 flex-shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                            </svg>
                            <span>@log.IpAddress</span>
                        </div>
                    </div>
                </div>
            </div>
        }
        </div>
    }
    else
    {
        <div class="flex flex-col items-center justify-center py-12">
            <svg class="h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p class="text-base font-medium text-gray-600">No Audit Log Entries Found</p>
            <p class="text-sm text-gray-500 mt-1">There are no audit log entries matching your filters.</p>
        </div>
    }
</div>

<!-- Pagination Footer -->
@if (Logs != null && Logs.Any() && FilteredLogs.Any())
{
    <div class="flex items-center justify-between border-t border-gray-200 bg-gray-50 px-4 py-3 text-sm text-gray-600">
        <span>@($"{((CurrentPage - 1) * RowsPerPage) + 1}-{Math.Min(CurrentPage * RowsPerPage, FilteredLogs.Count)} of {FilteredLogs.Count} audit log entries")</span>
        <div class="flex items-center gap-2">
            @if (TotalPages > 0)
            {
                @for (int i = 1; i <= Math.Min(TotalPages, 10); i++)
                {
                    <button @onclick="() => HandlePageChanged(i)" 
                            class="rounded-md px-3 py-1 text-xs @(i == CurrentPage ? "bg-blue-900 text-white" : "text-gray-600 hover:bg-gray-200")">
                        @i
                    </button>
                }
                @if (TotalPages > 10)
                {
                    <span>...</span>
                    <button @onclick="() => HandlePageChanged(TotalPages)" 
                            class="rounded-md px-3 py-1 text-xs text-gray-600 hover:bg-gray-200">
                        @TotalPages
                    </button>
                }
            }
            <span class="ml-4">Show</span>
            <div class="group relative">
                <select value="@RowsPerPage" @onchange="OnRowsPerPageChanged" 
                        class="rounded-md border px-2 py-1 text-xs text-gray-600">
                    <option value="5">5 rows</option>
                    <option value="10">10 rows</option>
                    <option value="20">20 rows</option>
                    <option value="50">50 rows</option>
                </select>
                <span class="tooltip-delay">Select number of audit log entries to display per page</span>
            </div>
        </div>
    </div>
}

<!-- Detail Modal -->
@if (SelectedLog != null && ShowDetailModal)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4" @onclick="HandleBackdropClick">
        <div id="audit-log-detail-modal" class="w-full max-w-2xl rounded-xl bg-white shadow-2xl" @onclick:stopPropagation="true">
            <!-- Modal Header -->
            <div class="border-b border-gray-200 border-t-4 border-t-blue-500 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="mb-2 flex flex-wrap items-center gap-2">
                            <span class="rounded-full bg-gray-500 px-3 py-1 text-xs font-semibold text-white">
                                @SelectedLog.Module
                            </span>
                            <span class="rounded-full px-3 py-1 text-xs font-medium @GetStatusClass(SelectedLog.Status)">
                                @SelectedLog.Status
                            </span>
                            @{
                                var modalSeverity = string.IsNullOrWhiteSpace(SelectedLog.Severity) 
                                    ? DetermineSeverity(SelectedLog.Action, SelectedLog.Module, SelectedLog.Status) 
                                    : SelectedLog.Severity;
                            }
                            <span class="inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold @GetSeverityClass(modalSeverity) shadow-sm">
                                @if (modalSeverity.Equals("High", StringComparison.OrdinalIgnoreCase) || modalSeverity.Equals("Critical", StringComparison.OrdinalIgnoreCase))
                                {
                                    <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                }
                                else if (modalSeverity.Equals("Moderate", StringComparison.OrdinalIgnoreCase) || modalSeverity.Equals("Medium", StringComparison.OrdinalIgnoreCase))
                                {
                                    <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                }
                                else
                                {
                                    <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                }
                                <span>@modalSeverity</span>
                            </span>
                        </div>
                        <h2 class="text-xl font-bold text-blue-600">@SelectedLog.Action</h2>
                        <p class="mt-1 text-sm text-gray-500">Log ID: @SelectedLog.Id</p>
                    </div>
                    <button @onclick="CloseDetailModal" class="ml-4 rounded-lg p-2 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="max-h-[70vh] overflow-y-auto px-6 py-6">
                <div class="space-y-4">
                    <!-- Description -->
                    <div>
                        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">Description</label>
                        <p class="text-sm text-gray-900">@SelectedLog.Description</p>
                    </div>

                    <!-- User Information -->
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">User</label>
                            <p class="text-sm font-medium text-gray-900">@SelectedLog.User</p>
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">Role</label>
                            <p class="text-sm font-medium text-gray-900">@SelectedLog.Role</p>
                        </div>
                    </div>

                    <!-- Timestamp and IP -->
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">Timestamp</label>
                            <p class="text-sm font-medium text-gray-900">@SelectedLog.Timestamp.ToString("MMMM dd, yyyy 'at' HH:mm:ss")</p>
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">IP Address</label>
                            <p class="text-sm font-medium text-gray-900">@SelectedLog.IpAddress</p>
                        </div>
                    </div>

                    <!-- Module and Action -->
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">Module</label>
                            <p class="text-sm font-medium text-gray-900">@SelectedLog.Module</p>
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">Action</label>
                            <p class="text-sm font-medium text-gray-900">@SelectedLog.Action</p>
                        </div>
                    </div>

                    <!-- Status and Severity -->
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">Status</label>
                            <p class="text-sm font-medium text-gray-900">@SelectedLog.Status</p>
                        </div>
                        <div>
                            <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">Severity</label>
                            @{
                                var detailSeverity = string.IsNullOrWhiteSpace(SelectedLog.Severity) 
                                    ? DetermineSeverity(SelectedLog.Action, SelectedLog.Module, SelectedLog.Status) 
                                    : SelectedLog.Severity;
                            }
                            <div class="mt-1 inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-sm font-semibold @GetSeverityClass(detailSeverity) shadow-sm">
                                @if (detailSeverity.Equals("High", StringComparison.OrdinalIgnoreCase) || detailSeverity.Equals("Critical", StringComparison.OrdinalIgnoreCase))
                                {
                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                }
                                else if (detailSeverity.Equals("Moderate", StringComparison.OrdinalIgnoreCase) || detailSeverity.Equals("Medium", StringComparison.OrdinalIgnoreCase))
                                {
                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                }
                                else
                                {
                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                }
                                <span>@detailSeverity</span>
                            </div>
                            <p class="mt-1 text-xs text-gray-500">@GetSeverityDescription(detailSeverity)</p>
                        </div>
                    </div>

                    <!-- Customer Information (if available) -->
                    @if (!string.IsNullOrWhiteSpace(SelectedLog.CustomerCode) || !string.IsNullOrWhiteSpace(SelectedLog.CustomerName))
                    {
                        <div class="border-t border-gray-200 pt-4">
                            <h3 class="mb-3 text-sm font-semibold uppercase tracking-wide text-gray-700">Customer Information</h3>
                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                @if (!string.IsNullOrWhiteSpace(SelectedLog.CustomerCode))
                                {
                                    <div>
                                        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">Customer Code</label>
                                        <p class="text-sm font-medium text-gray-900">@SelectedLog.CustomerCode</p>
                                    </div>
                                }
                                @if (!string.IsNullOrWhiteSpace(SelectedLog.CustomerName))
                                {
                                    <div>
                                        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">Customer Name</label>
                                        <p class="text-sm font-medium text-gray-900">@SelectedLog.CustomerName</p>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Entity Information (if available) -->
                    @if (!string.IsNullOrWhiteSpace(SelectedLog.EntityType) || !string.IsNullOrWhiteSpace(SelectedLog.EntityId))
                    {
                        <div class="border-t border-gray-200 pt-4">
                            <h3 class="mb-3 text-sm font-semibold uppercase tracking-wide text-gray-700">Entity Information</h3>
                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                @if (!string.IsNullOrWhiteSpace(SelectedLog.EntityType))
                                {
                                    <div>
                                        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">Entity Type</label>
                                        <p class="text-sm font-medium text-gray-900">@SelectedLog.EntityType</p>
                                    </div>
                                }
                                @if (!string.IsNullOrWhiteSpace(SelectedLog.EntityId))
                                {
                                    <div>
                                        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">Entity ID</label>
                                        <p class="text-sm font-medium text-gray-900">@SelectedLog.EntityId</p>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Value Changes (if available) -->
                    @if (!string.IsNullOrWhiteSpace(SelectedLog.OldValues) || !string.IsNullOrWhiteSpace(SelectedLog.NewValues))
                    {
                        <div class="border-t border-gray-200 pt-4">
                            <h3 class="mb-3 text-sm font-semibold uppercase tracking-wide text-gray-700">Value Changes</h3>
                            <div class="space-y-3">
                                @if (!string.IsNullOrWhiteSpace(SelectedLog.OldValues))
                                {
                                    <div>
                                        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">Previous Values</label>
                                        <div class="rounded-lg border border-gray-200 bg-gray-50 p-3">
                                            <p class="text-sm text-gray-800 whitespace-pre-wrap break-words">@SelectedLog.OldValues</p>
                                        </div>
                                    </div>
                                }
                                @if (!string.IsNullOrWhiteSpace(SelectedLog.NewValues))
                                {
                                    <div>
                                        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-500">New Values</label>
                                        <div class="rounded-lg border border-gray-200 bg-green-50 p-3">
                                            <p class="text-sm text-gray-800 whitespace-pre-wrap break-words">@SelectedLog.NewValues</p>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="border-t border-gray-200 px-6 py-4">
                <div class="flex justify-end">
                    <button @onclick="CloseDetailModal" class="rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-200">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public List<AuditLogEntry>? Logs { get; set; }

    [Parameter]
    public int RowsPerPage { get; set; } = 10;

    // Filter properties
    private string SearchText { get; set; } = "";
    private string ModuleFilter { get; set; } = "";
    private string ActionFilter { get; set; } = "";
    private string StatusFilter { get; set; } = "";
    private string SeverityFilter { get; set; } = "";
    private string RoleFilter { get; set; } = "";
    private DateTime? FromDateFilter { get; set; }
    private DateTime? ToDateFilter { get; set; }

    // Pagination state
    private int CurrentPage { get; set; } = 1;
    private int TotalPages => FilteredLogs.Count > 0 ? (int)Math.Ceiling((double)FilteredLogs.Count / RowsPerPage) : 1;

    // Detail modal state
    private bool ShowDetailModal { get; set; } = false;
    private AuditLogEntry? SelectedLog { get; set; }
    private AuditLogEntry? HoveredLog { get; set; }
    private bool IsExplicitlySelected { get; set; } = false;

    // Computed property for filtered logs
    private List<AuditLogEntry> FilteredLogs
    {
        get
        {
            if (Logs == null || !Logs.Any())
                return new List<AuditLogEntry>();

            var filtered = Logs.AsEnumerable();

            // Search filter
            if (!string.IsNullOrWhiteSpace(SearchText))
            {
                var searchLower = SearchText.ToLower();
                filtered = filtered.Where(l =>
                    l.User.ToLower().Contains(searchLower) ||
                    l.Action.ToLower().Contains(searchLower) ||
                    l.Module.ToLower().Contains(searchLower) ||
                    l.Description.ToLower().Contains(searchLower) ||
                    l.Id.ToLower().Contains(searchLower) ||
                    (!string.IsNullOrWhiteSpace(l.CustomerCode) && l.CustomerCode.ToLower().Contains(searchLower)) ||
                    (!string.IsNullOrWhiteSpace(l.CustomerName) && l.CustomerName.ToLower().Contains(searchLower))
                );
            }

            // Module filter
            if (!string.IsNullOrWhiteSpace(ModuleFilter))
            {
                filtered = filtered.Where(l => l.Module.Equals(ModuleFilter, StringComparison.OrdinalIgnoreCase));
            }

            // Action filter
            if (!string.IsNullOrWhiteSpace(ActionFilter))
            {
                filtered = filtered.Where(l => l.Action.Equals(ActionFilter, StringComparison.OrdinalIgnoreCase));
            }

            // Status filter
            if (!string.IsNullOrWhiteSpace(StatusFilter))
            {
                filtered = filtered.Where(l => l.Status.Equals(StatusFilter, StringComparison.OrdinalIgnoreCase));
            }

            // Severity filter - check both stored severity and determined severity
            if (!string.IsNullOrWhiteSpace(SeverityFilter))
            {
                filtered = filtered.Where(l =>
                {
                    var severity = string.IsNullOrWhiteSpace(l.Severity)
                        ? DetermineSeverity(l.Action, l.Module, l.Status)
                        : l.Severity;
                    // Normalize "Medium" to "Moderate" for comparison
                    var normalizedSeverity = severity.Equals("Medium", StringComparison.OrdinalIgnoreCase) ? "Moderate" : severity;
                    var normalizedFilter = SeverityFilter.Equals("Medium", StringComparison.OrdinalIgnoreCase) ? "Moderate" : SeverityFilter;
                    return normalizedSeverity.Equals(normalizedFilter, StringComparison.OrdinalIgnoreCase);
                });
            }

            // Role filter
            if (!string.IsNullOrWhiteSpace(RoleFilter))
            {
                filtered = filtered.Where(l => 
                    l.Role.Equals(RoleFilter, StringComparison.OrdinalIgnoreCase) ||
                    (RoleFilter.Equals("SuperAdmin", StringComparison.OrdinalIgnoreCase) && l.Role.Equals("Super Admin", StringComparison.OrdinalIgnoreCase)) ||
                    (RoleFilter.Equals("Super Admin", StringComparison.OrdinalIgnoreCase) && l.Role.Equals("SuperAdmin", StringComparison.OrdinalIgnoreCase))
                );
            }

            // Date filter
            if (FromDateFilter.HasValue)
            {
                filtered = filtered.Where(l => l.Timestamp >= FromDateFilter.Value.Date);
            }

            if (ToDateFilter.HasValue)
            {
                filtered = filtered.Where(l => l.Timestamp <= ToDateFilter.Value.Date.AddDays(1).AddTicks(-1));
            }

            return filtered.OrderByDescending(l => l.Timestamp).ToList();
        }
    }

    // Computed property for paginated logs
    private List<AuditLogEntry> PaginatedLogs
    {
        get
        {
            var filtered = FilteredLogs;
            var paginated = filtered
                .Skip((CurrentPage - 1) * RowsPerPage)
                .Take(RowsPerPage)
                .ToList();
            
            // Set default selected log to first item if none selected or selected is not in current page
            if (paginated.Any())
            {
                if (SelectedLog == null || !paginated.Any(l => l.Id == SelectedLog.Id))
                {
                    SelectedLog = paginated.First();
                    IsExplicitlySelected = false; // Default selection, not explicit
                    StateHasChanged();
                }
            }
            
            return paginated;
        }
    }

    // Get status class
    private string GetStatusClass(string status)
    {
        return status switch
        {
            "Success" => "bg-green-100 text-green-700",
            "Failed" => "bg-red-100 text-red-700",
            "Warning" => "bg-yellow-100 text-yellow-700",
            _ => "bg-gray-100 text-gray-700"
        };
    }

    // Get severity class with better UI/UX styling
    private string GetSeverityClass(string severity)
    {
        // Normalize severity values (handle both "Medium" and "Moderate")
        var normalizedSeverity = severity?.Trim() ?? "Low";
        if (normalizedSeverity.Equals("Medium", StringComparison.OrdinalIgnoreCase))
        {
            normalizedSeverity = "Moderate";
        }

        return normalizedSeverity switch
        {
            "Low" => "bg-blue-50 border border-blue-200 text-blue-700 font-semibold",
            "Moderate" => "bg-yellow-50 border border-yellow-200 text-yellow-700 font-semibold",
            "High" => "bg-orange-50 border border-orange-200 text-orange-700 font-semibold",
            "Critical" => "bg-red-50 border border-red-200 text-red-700 font-semibold",
            _ => "bg-gray-50 border border-gray-200 text-gray-700 font-semibold"
        };
    }

    // Determine severity based on action and transaction type
    private string DetermineSeverity(string action, string module, string status)
    {
        // If status is Failed, it's usually High severity
        if (status.Equals("Failed", StringComparison.OrdinalIgnoreCase))
        {
            return "High";
        }

        // High severity actions - critical operations
        var highSeverityActions = new[]
        {
            "Delete Customer", "Delete Record", "Cancel Subscription",
            "System Settings Change", "Failed Login Attempt", "Unauthorized Access",
            "Bulk Delete", "Permanent Delete", "BIR Filing"
        };

        if (highSeverityActions.Any(a => action.Contains(a, StringComparison.OrdinalIgnoreCase)))
        {
            return "High";
        }

        // Moderate severity actions - important but not critical
        var moderateSeverityActions = new[]
        {
            "Create Customer", "Update Customer", "Create Subscription",
            "Update Subscription", "Create Invoice", "Process Payment",
            "Create Support Ticket", "Update Support Ticket"
        };

        if (moderateSeverityActions.Any(a => action.Contains(a, StringComparison.OrdinalIgnoreCase)))
        {
            return "Moderate";
        }

        // Low severity actions - routine operations
        return "Low";
    }

    public void ClearFilters()
    {
        SearchText = "";
        ModuleFilter = "";
        ActionFilter = "";
        StatusFilter = "";
        SeverityFilter = "";
        RoleFilter = "";
        FromDateFilter = null;
        ToDateFilter = null;
        CurrentPage = 1;
        StateHasChanged();
    }

    public void ClearAllFilters()
    {
        ClearFilters();
    }

    public void SetStatusFilter(string status)
    {
        StatusFilter = status;
        CurrentPage = 1;
        StateHasChanged();
    }

    public void SetDateFilter(DateTime fromDate, DateTime toDate)
    {
        FromDateFilter = fromDate;
        ToDateFilter = toDate;
        CurrentPage = 1;
        StateHasChanged();
    }

    private void OnSearchChanged()
    {
        CurrentPage = 1;
        SelectedLog = null; // Reset selection when filters change
        IsExplicitlySelected = false;
        StateHasChanged();
    }

    private void OnFilterChanged()
    {
        CurrentPage = 1;
        SelectedLog = null; // Reset selection when filters change
        IsExplicitlySelected = false;
        StateHasChanged();
    }

    private void HandlePageChanged(int page)
    {
        CurrentPage = page;
        StateHasChanged();
    }

    private void OnRowsPerPageChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int rowsPerPage))
        {
            RowsPerPage = rowsPerPage;
            CurrentPage = 1;
            StateHasChanged();
        }
    }

    private void HoverLog(AuditLogEntry? log)
    {
        HoveredLog = log;
        StateHasChanged();
    }

    private void OpenDetailModal(AuditLogEntry log)
    {
        SelectedLog = log;
        IsExplicitlySelected = true; // Explicit selection via row click
        ShowDetailModal = true;
        StateHasChanged();
    }

    private void HandleBackdropClick()
    {
        // Allow closing audit log detail modal on backdrop click
        CloseDetailModal();
    }

    private void CloseDetailModal()
    {
        ShowDetailModal = false;
        // Reset to default (first item) when modal closes
        if (PaginatedLogs.Any())
        {
            SelectedLog = PaginatedLogs.First();
            IsExplicitlySelected = false;
        }
        StateHasChanged();
    }

    private void ExportPDF()
    {
        // Export PDF logic will be implemented here
    }

    // Get severity description for tooltips
    private string GetSeverityDescription(string severity)
    {
        var normalizedSeverity = severity?.Trim() ?? "Low";
        if (normalizedSeverity.Equals("Medium", StringComparison.OrdinalIgnoreCase))
        {
            normalizedSeverity = "Moderate";
        }

        return normalizedSeverity switch
        {
            "Low" => "Routine operation with minimal impact",
            "Moderate" => "Important operation requiring attention",
            "High" => "Critical operation with significant impact",
            "Critical" => "Urgent operation requiring immediate attention",
            _ => "Standard operation"
        };
    }
}
