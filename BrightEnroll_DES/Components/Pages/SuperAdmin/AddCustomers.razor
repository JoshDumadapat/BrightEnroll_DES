@page "/system-admin/customers/add"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.Authentication
@using BrightEnroll_DES.Services.Business.SuperAdmin
@using BrightEnroll_DES.Data.Models
@using System
@using BrightEnroll_DES.Data
@using Microsoft.EntityFrameworkCore
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject SuperAdminService SuperAdminService
@inject SuperAdminDbContext SuperAdminDbContext
@inject IJSRuntime JSRuntime
@inject BrightEnroll_DES.Services.QuestPDF.CustomerContractPdfGenerator CustomerContractPdfGenerator

<PageTitle>Add New Customer</PageTitle>

<div class="text-gray-800">
    <h1 class="mb-6 text-2xl font-bold text-gray-900">Add New Customer</h1>
    <div class="mx-auto max-w-5xl">
        <!-- Back Button -->
        <div class="mb-4 flex justify-start">
            <button type="button" @onclick="Cancel" 
                    class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm transition-all duration-300 hover:bg-gray-50">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Back
            </button>
        </div>

        <form @onsubmit="HandleFormSubmit" @onsubmit:preventDefault="true">
            <!-- Section 1: School Information -->
            <div class="mb-6 overflow-hidden rounded-lg border border-blue-100 bg-gradient-to-br from-blue-50/30 via-white to-white shadow-sm sm:mb-6">
                <div class="bg-blue-50 px-4 py-2 border-b border-blue-100">
                    <div class="flex items-center gap-2">
                        <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        <h2 class="text-sm font-semibold text-blue-900">School Information</h2>
                    </div>
                </div>
                <div class="px-4 py-4 bg-gradient-to-br from-blue-50/20 to-white">

                    <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-2 sm:gap-4">
                        <!-- School Name -->
                        <div class="md:col-span-2">
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                School Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text" @bind="SchoolName" required
                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 sm:px-4 sm:py-2.5 sm:text-base"
                                   placeholder="Enter school name" />
                        </div>

                        <!-- School ID -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">School ID</label>
                            <input type="text" value="AUTO-GENERATED"
                                   class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 text-sm text-gray-500 outline-none sm:px-4 sm:py-2.5 sm:text-base"
                                   placeholder="Auto-generated" disabled />
                        </div>

                        <!-- School Type -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                School Type <span class="text-red-500">*</span>
                            </label>
                            <select @bind="SchoolType" required
                                    class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-0 sm:px-4 sm:py-2.5 sm:text-base">
                                <option value="">Select type</option>
                                <option value="Private Elementary">Private Elementary</option>
                                <option value="Public Elementary">Public Elementary</option>
                                <option value="Private Elementary (Religious)">Private Elementary (Religious)</option>
                                <option value="International Elementary">International Elementary</option>
                            </select>
                        </div>

                        <!-- Address -->
                        <div class="md:col-span-2">
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Address <span class="text-red-500">*</span>
                            </label>
                            <input type="text" @bind="Address" required
                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 sm:px-4 sm:py-2.5 sm:text-base"
                                   placeholder="Enter complete address" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Contact Person -->
            <div class="mb-6 overflow-hidden rounded-lg border border-green-100 bg-gradient-to-br from-green-50/30 via-white to-white shadow-sm sm:mb-6">
                <div class="bg-green-50 px-4 py-2 border-b border-green-100">
                    <div class="flex items-center gap-2">
                        <svg class="h-4 w-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <h2 class="text-sm font-semibold text-green-900">Contact Person</h2>
                    </div>
                </div>
                <div class="px-4 py-4 bg-gradient-to-br from-green-50/20 to-white">

                    <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-2 sm:gap-4">
                        <!-- Name Fields Row - All in one row -->
                        <div class="sm:col-span-2 grid grid-cols-1 gap-3 sm:grid-cols-4 sm:gap-4">
                            <!-- First Name -->
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    First Name <span class="text-red-500">*</span>
                                </label>
                                <input type="text" @bind="ContactFirstName" required
                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200 sm:px-4 sm:py-2.5 sm:text-base"
                                       placeholder="First name" />
                            </div>

                            <!-- Middle Name -->
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Middle Name</label>
                                <input type="text" @bind="ContactMiddleName"
                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200 sm:px-4 sm:py-2.5 sm:text-base"
                                       placeholder="Middle name (optional)" />
                            </div>

                            <!-- Last Name -->
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                    Last Name <span class="text-red-500">*</span>
                                </label>
                                <input type="text" @bind="ContactLastName" required
                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200 sm:px-4 sm:py-2.5 sm:text-base"
                                       placeholder="Last name" />
                            </div>

                            <!-- Suffix -->
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Suffix</label>
                                <input type="text" @bind="ContactSuffix" maxlength="10"
                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200 sm:px-4 sm:py-2.5 sm:text-base"
                                       placeholder="Jr., Sr., III, etc. (optional)" />
                            </div>
                        </div>

                        <!-- Role -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Role <span class="text-red-500">*</span></label>
                            <select @bind="ContactRole" required disabled
                                    class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 text-sm text-gray-600 focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200 sm:px-4 sm:py-2.5 sm:text-base">
                                <option value="Admin">Admin</option>
                            </select>
                            <p class="mt-1 text-xs text-gray-500">Role is automatically set to Admin</p>
                        </div>

                        <!-- Email -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Email <span class="text-red-500">*</span>
                            </label>
                            <input type="email" @bind="ContactEmail" required
                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200 sm:px-4 sm:py-2.5 sm:text-base"
                                   placeholder="email@school.edu.ph" />
                        </div>

                        <!-- Phone -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Phone Number <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" @bind="ContactPhone" required maxlength="20"
                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200 sm:px-4 sm:py-2.5 sm:text-base"
                                   placeholder="+63 XXX XXX XXXX" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: School BIR Compliance Information -->
            <div class="mb-6 overflow-hidden rounded-lg border border-amber-100 bg-gradient-to-br from-amber-50/30 via-white to-white shadow-sm sm:mb-6">
                <div class="bg-amber-50 px-4 py-2 border-b border-amber-100">
                    <div class="flex items-center gap-2">
                        <svg class="h-4 w-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h2 class="text-sm font-semibold text-amber-900">Customer's BIR Compliance Information (Optional)</h2>
                    </div>
                </div>
                <div class="px-4 py-4 bg-gradient-to-br from-amber-50/20 to-white">
                    <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-2 sm:gap-4">
                        <!-- BIR TIN -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">BIR TIN Number</label>
                            <input type="text" @bind="BirTin" maxlength="50"
                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-200 sm:px-4 sm:py-2.5 sm:text-base"
                                   placeholder="000-000-000-000" />
                        </div>

                        <!-- BIR Business Name -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">BIR Business Name</label>
                            <input type="text" @bind="BirBusinessName" maxlength="200"
                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-200 sm:px-4 sm:py-2.5 sm:text-base"
                                   placeholder="Business name as registered in BIR" />
                        </div>

                        <!-- BIR Address -->
                        <div class="sm:col-span-2">
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">BIR Business Address</label>
                            <textarea @bind="BirAddress" rows="2" maxlength="500"
                                      class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-200 sm:px-4 sm:py-2.5 sm:text-base"
                                      placeholder="Business address as registered in BIR"></textarea>
                        </div>

                        <!-- Registration Type -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Registration Type</label>
                            <select @bind="BirRegistrationType" @bind:after="OnRegistrationTypeChanged"
                                    class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-200 sm:px-4 sm:py-2.5 sm:text-base">
                                <option value="">Select type</option>
                                <option value="VAT">VAT Registered</option>
                                <option value="Non-VAT">Non-VAT</option>
                            </select>
                        </div>

                        <!-- VAT Rate -->
                        @if (IsVatRegistered)
                        {
                            <div>
                                <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">VAT Rate (%)</label>
                                <input type="number" @bind="VatRate" @bind:after="CalculateVAT" step="0.01" min="0" max="100"
                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-200 sm:px-4 sm:py-2.5 sm:text-base"
                                       placeholder="12.00" />
                                <p class="mt-1 text-xs text-gray-500">Default: 12% (Philippine Standard)</p>
                            </div>
                        }
                        else
                        {
                            <div class="flex items-center">
                                <label class="text-xs font-medium text-gray-500 sm:text-sm">Non-VAT Registered</label>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Section 4: Subscription Plan (Promotional - Optional) -->
            <div class="mb-6 overflow-hidden rounded-lg border border-orange-100 bg-gradient-to-br from-orange-50/30 via-white to-white shadow-sm sm:mb-6">
                <div class="bg-orange-50 px-4 py-2 border-b border-orange-100">
                    <div class="flex items-center gap-2">
                        <svg class="h-4 w-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h2 class="text-sm font-semibold text-orange-900">Subscription Plan (Optional)</h2>
                    </div>
                </div>
                <div class="px-4 py-4 bg-gradient-to-br from-orange-50/20 to-white">

                    <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-2 sm:gap-4">
                        <!-- Plan (Optional) -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Promotional Plan (Optional)
                            </label>
                            <select @bind="Plan" @bind:after="OnPlanChanged" disabled="@(SelectedPackages.Any())"
                                    class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-200 sm:px-4 sm:py-2.5 sm:text-base @(SelectedPackages.Any() ? "bg-gray-100 text-gray-500 cursor-not-allowed" : "bg-white")">
                                <option value="">No promotional plan (Custom modules only)</option>
                                <option value="Basic">Basic - ₱35,000/month</option>
                                <option value="Standard">Standard - ₱55,000/month</option>
                                <option value="Premium">Premium - ₱85,000/month</option>
                            </select>
                            @if (SelectedPackages.Any())
                            {
                                <p class="mt-1 text-xs text-red-600">⚠️ Plan selection is disabled when modules are selected. Please clear module selections first.</p>
                            }
                            else
                            {
                                <p class="mt-1 text-xs text-gray-500">@(string.IsNullOrWhiteSpace(Plan) ? "Select modules below" : "Module selection is disabled when a plan is selected")</p>
                            }
                        </div>

                        <!-- Monthly Fee Breakdown -->
                        <div class="sm:col-span-2">
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Monthly Fee Breakdown</label>
                            <div class="rounded-lg border border-gray-200 bg-gray-50 p-3 space-y-1">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Subtotal:</span>
                                    <span class="font-medium text-gray-900">₱@Subtotal.ToString("N2")</span>
                                </div>
                                @if (IsVatRegistered && VatRate.HasValue && VatRate.Value > 0)
                                {
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">VAT (@VatRate%):</span>
                                        <span class="font-medium text-gray-900">₱@VatAmount.ToString("N2")</span>
                                    </div>
                                    <div class="flex justify-between text-xs text-amber-700 pt-1 border-t border-gray-200">
                                        <span>VAT Registered</span>
                                        <span>BIR Compliant</span>
                                    </div>
                                }
                                <div class="flex justify-between text-sm font-semibold border-t border-gray-300 pt-1 mt-1">
                                    <span class="text-gray-900">Total Monthly Fee:</span>
                                    <span class="text-blue-600">₱@TotalWithVat.ToString("N2")</span>
                                </div>
                            </div>
                            <p class="mt-1 text-xs text-gray-500">Fee calculated based on selected modules @(IsVatRegistered ? "with VAT (BIR compliant)" : "without VAT")</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4.5: Payment Information -->
            <div class="mb-6 overflow-hidden rounded-lg border border-teal-100 bg-gradient-to-br from-teal-50/30 via-white to-white shadow-sm sm:mb-6">
                <div class="bg-teal-50 px-4 py-2 border-b border-teal-100">
                    <div class="flex items-center gap-2">
                        <svg class="h-4 w-4 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                        </svg>
                        <h2 class="text-sm font-semibold text-teal-900">Payment Information</h2>
                    </div>
                </div>
                <div class="px-4 py-4 bg-gradient-to-br from-teal-50/20 to-white">
                    <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-2 sm:gap-4">
                        <!-- Payment Method -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Payment Method <span class="text-red-500">*</span>
                            </label>
                            <select @bind="DefaultPaymentMethod" @bind:after="OnPaymentMethodChanged" required
                                    class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200 sm:px-4 sm:py-2.5 sm:text-base">
                                <option value="Cash">Cash</option>
                                <option value="Credit">Credit</option>
                            </select>
                            <p class="mt-1 text-xs text-gray-500">Payment method for this customer</p>
                        </div>

                        @if (DefaultPaymentMethod == "Credit")
                        {
                            <!-- Credit Terms Section -->
                            <div class="sm:col-span-2 rounded-lg border border-amber-200 bg-amber-50 p-4">
                                <h3 class="mb-3 text-sm font-semibold text-amber-900">Credit Terms</h3>
                                <div class="grid grid-cols-1 gap-3 sm:grid-cols-3">
                                    <div>
                                        <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Number of Months <span class="text-red-500">*</span></label>
                                        <input type="number" @bind="CreditMonths" @bind:after="CalculateCustomerCreditInterest" min="1" max="60"
                                               class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-200 sm:px-4 sm:py-2.5 sm:text-base" />
                                    </div>
                                    <div>
                                        <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Interest Rate (%) <span class="text-red-500">*</span></label>
                                        <input type="number" @bind="CreditInterestRate" @bind:after="CalculateCustomerCreditInterest" step="0.01" min="0" max="100"
                                               class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-200 sm:px-4 sm:py-2.5 sm:text-base" />
                                    </div>
                                    <div>
                                        <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Payment Frequency</label>
                                        <select @bind="CreditPaymentFrequency" @bind:after="CalculateCustomerCreditInterest"
                                                class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-200 sm:px-4 sm:py-2.5 sm:text-base">
                                            <option value="Monthly">Monthly</option>
                                            <option value="Quarterly">Quarterly</option>
                                            <option value="Semi-Annual">Semi-Annual</option>
                                            <option value="Annual">Annual</option>
                                        </select>
                                    </div>
                                </div>
                                @if (CreditMonths > 0 && CreditInterestRate > 0 && TotalWithVat > 0)
                                {
                                    <div class="mt-3 rounded-lg border border-amber-300 bg-white p-3">
                                        <h4 class="mb-2 text-xs font-semibold text-amber-900 sm:text-sm">Credit Calculation (ERP Standard - Simple Interest)</h4>
                                        <div class="space-y-1 text-xs sm:text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Principal Amount:</span>
                                                <span class="font-medium text-gray-900">₱@TotalWithVat.ToString("N2")</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Interest Rate:</span>
                                                <span class="font-medium text-gray-900">@CreditInterestRate.ToString("F2")%</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Term:</span>
                                                <span class="font-medium text-gray-900">@CreditMonths months (@CreditPaymentFrequency)</span>
                                            </div>
                                            <div class="flex justify-between border-t border-gray-200 pt-1">
                                                <span class="text-gray-600">Total Interest:</span>
                                                <span class="font-semibold text-amber-700">₱@CustomerCreditTotalInterest.ToString("N2")</span>
                                            </div>
                                            <div class="flex justify-between border-t-2 border-amber-300 pt-1">
                                                <span class="font-semibold text-gray-900">Total Amount Due:</span>
                                                <span class="font-bold text-amber-900">₱@CustomerCreditTotalAmount.ToString("N2")</span>
                                            </div>
                                            <div class="flex justify-between pt-1">
                                                <span class="text-gray-600">Monthly Payment:</span>
                                                <span class="font-medium text-gray-900">₱@CustomerCreditMonthlyPayment.ToString("N2")</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        <!-- Payment Reference (Optional) -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Payment Reference</label>
                            <input type="text" @bind="PaymentReference" maxlength="100"
                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200 sm:px-4 sm:py-2.5 sm:text-base"
                                   placeholder="OR Number, Transaction ID, etc." />
                        </div>

                        <!-- Payment Notes -->
                        <div class="sm:col-span-2">
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Payment Notes</label>
                            <textarea @bind="PaymentNotes" rows="2" maxlength="500"
                                      class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200 sm:px-4 sm:py-2.5 sm:text-base"
                                      placeholder="Additional payment information or instructions (optional)"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: Module Selection -->
            <div class="mb-6 overflow-hidden rounded-lg border border-purple-100 bg-gradient-to-br from-purple-50/30 via-white to-white shadow-sm sm:mb-6">
                <div class="bg-purple-50 px-4 py-2 border-b border-purple-100">
                    <div class="flex items-center gap-2">
                        <svg class="h-4 w-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                        </svg>
                        <h2 class="text-sm font-semibold text-purple-900">Module Selection</h2>
                    </div>
                </div>
                <div class="px-4 py-4 bg-gradient-to-br from-purple-50/20 to-white">

                    <div class="space-y-4">
                        @foreach (var package in AvailablePackages.Where(p => !p.IsRequired))
                        {
                            var isInventoryPackage = package.PackageId == "inventory";
                            var isDisabled = !string.IsNullOrWhiteSpace(Plan) || isInventoryPackage;
                            var isChecked = SelectedPackages.Contains(package.PackageId) && !isInventoryPackage;
                            
                            <div class="rounded-lg border-2 @(isChecked ? "border-blue-500 bg-blue-50" : "border-gray-200 bg-white") @(isDisabled ? "opacity-60" : "") p-4 transition-all">
                                <div class="flex items-start gap-3">
                                    <input type="checkbox" 
                                           checked="@isChecked"
                                           disabled="@isDisabled"
                                           @onchange="@((ChangeEventArgs e) => TogglePackage(package.PackageId, e.Value?.ToString() == "True"))"
                                           class="mt-1 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" />
                                    <div class="flex-1">
                                        <div class="flex items-start justify-between gap-4">
                                            <div class="flex-1">
                                                <h3 class="text-lg font-bold text-gray-900 mb-2">
                                                    @package.PackageName
                                                    @if (isInventoryPackage)
                                                    {
                                                        <span class="text-xs font-normal text-red-600 ml-2">(Disabled)</span>
                                                    }
                                                    @if (isDisabled && !isInventoryPackage)
                                                    {
                                                        <span class="text-xs font-normal text-orange-600 ml-2">(Disabled - Plan Selected)</span>
                                                    }
                                                </h3>
                                                <p class="text-base text-gray-700 mb-3 leading-relaxed">@package.Description</p>
                                                <div class="mt-3 flex flex-wrap gap-2">
                                                    @foreach (var perm in package.Permissions.Take(6))
                                                    {
                                                        <span class="inline-flex rounded-full bg-blue-100 px-3 py-1 text-xs font-medium text-blue-800">
                                                            @perm.Replace("_", " ").Replace("view ", "").Replace("create ", "").Replace("edit ", "").Replace("delete ", "")
                                                        </span>
                                                    }
                                                    @if (package.Permissions.Count > 6)
                                                    {
                                                        <span class="inline-flex rounded-full bg-gray-100 px-3 py-1 text-xs font-medium text-gray-700">
                                                            +@(package.Permissions.Count - 6) more features
                                                        </span>
                                                    }
                                                </div>
                                            </div>
                                            <div class="text-right flex-shrink-0">
                                                <div class="text-2xl font-bold text-blue-600">₱@GetPackagePrice(package.PackageId).ToString("N2")</div>
                                                <div class="text-xs text-gray-500 mt-1">per month</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        
                        <!-- Core Package (Always included) -->
                        <div class="rounded-lg border-2 border-green-500 bg-green-50 p-4">
                            <div class="flex items-start gap-3">
                                <input type="checkbox" checked="true" disabled
                                       class="mt-1 h-5 w-5 rounded border-gray-300 text-green-600" />
                                <div class="flex-1">
                                    <h3 class="text-base font-bold text-gray-900">@CorePackage.PackageName <span class="text-xs font-normal text-green-700">(Always Included)</span></h3>
                                    <p class="mt-1 text-sm text-gray-600">@CorePackage.Description</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (SelectedPackages.Any())
                    {
                        <div class="mt-6 rounded-lg bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 p-6">
                            <div class="mb-4">
                                <h3 class="text-lg font-bold text-blue-900 mb-3">Selected Modules Summary</h3>
                                <div class="space-y-2">
                                    @foreach (var packageId in SelectedPackages)
                                    {
                                        var package = AvailablePackages.FirstOrDefault(p => p.PackageId == packageId);
                                        if (package != null)
                                        {
                                            <div class="flex items-center justify-between bg-white rounded-lg px-4 py-2 border border-blue-200">
                                                <div class="flex items-center gap-3">
                                                    <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                                    </svg>
                                                    <span class="text-sm font-semibold text-gray-900">@package.PackageName</span>
                                                </div>
                                                <span class="text-sm font-medium text-blue-700">₱@GetPackagePrice(package.PackageId).ToString("N2")</span>
                                            </div>
                                        }
                                    }
                                    <!-- Core Package (Always Included) -->
                                    <div class="flex items-center justify-between bg-green-50 rounded-lg px-4 py-2 border border-green-300">
                                        <div class="flex items-center gap-3">
                                            <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                            </svg>
                                            <span class="text-sm font-semibold text-gray-900">@CorePackage.PackageName <span class="text-xs text-green-700">(Always Included)</span></span>
                                        </div>
                                        <span class="text-sm font-medium text-green-700">₱@GetPackagePrice(CorePackage.PackageId).ToString("N2")</span>
                                    </div>
                                </div>
                            </div>
                            <div class="border-t-2 border-blue-300 pt-4 space-y-2">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="font-medium text-gray-700">Subtotal:</span>
                                    <span class="font-semibold text-gray-900">₱@Subtotal.ToString("N2")</span>
                                </div>
                                @if (IsVatRegistered && VatRate.HasValue && VatRate.Value > 0)
                                {
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="font-medium text-gray-700">VAT (@VatRate%):</span>
                                        <span class="font-semibold text-gray-900">₱@VatAmount.ToString("N2")</span>
                                    </div>
                                }
                                <div class="flex items-center justify-between text-lg font-bold border-t-2 border-blue-400 pt-2">
                                    <span class="text-blue-900">Total Monthly Fee:</span>
                                    <span class="text-blue-700">₱@TotalWithVat.ToString("N2")</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Section 6: Contract Details -->
            <div class="mb-6 overflow-hidden rounded-lg border border-indigo-100 bg-gradient-to-br from-indigo-50/30 via-white to-white shadow-sm sm:mb-6">
                <div class="bg-indigo-50 px-4 py-2 border-b border-indigo-100">
                    <div class="flex items-center gap-2">
                        <svg class="h-4 w-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h2 class="text-sm font-semibold text-indigo-900">Contract Details</h2>
                    </div>
                </div>
                <div class="px-4 py-4 bg-gradient-to-br from-indigo-50/20 to-white">

                    <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-2 sm:gap-4">
                        <!-- Contract Start Date -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Contract Start Date <span class="text-red-500">*</span>
                            </label>
                            <input type="date" @bind="ContractStartDate" required
                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200 sm:px-4 sm:py-2.5 sm:text-base" />
                        </div>

                        <!-- Contract Duration -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Contract Duration <span class="text-red-500">*</span>
                            </label>
                            <select @bind="ContractDuration" required
                                    class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200 sm:px-4 sm:py-2.5 sm:text-base">
                                <option value="">Select duration</option>
                                <option value="6">6 Months</option>
                                <option value="12">12 Months</option>
                                <option value="24">24 Months</option>
                                <option value="36">36 Months</option>
                            </select>
                        </div>

                        <!-- Status -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Status</label>
                            <select @bind="Status"
                                    class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200 sm:px-4 sm:py-2.5 sm:text-base">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 7: Contract Terms & Services -->
            <div class="mb-6 overflow-hidden rounded-lg border border-teal-100 bg-gradient-to-br from-teal-50/30 via-white to-white shadow-sm sm:mb-6">
                <div class="bg-teal-50 px-4 py-2 border-b border-teal-100">
                    <div class="flex items-center gap-2">
                        <svg class="h-4 w-4 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h2 class="text-sm font-semibold text-teal-900">Contract Terms & Services</h2>
                    </div>
                </div>
                <div class="px-4 py-4 bg-gradient-to-br from-teal-50/20 to-white">
                    <div class="mb-3 grid grid-cols-1 gap-3 sm:mb-4 sm:grid-cols-2 sm:gap-4">
                        <!-- Contract Terms Template -->
                        <div class="sm:col-span-2">
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                                Contract Terms Template <span class="text-red-500">*</span>
                            </label>
                            <select @bind="SelectedContractTemplate" @bind:after="OnContractTemplateChanged" required
                                    class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200 sm:px-4 sm:py-2.5 sm:text-base">
                                <option value="Standard">Standard Contract Terms</option>
                                <option value="Premium">Premium Contract Terms</option>
                                <option value="Custom">Custom Contract Terms</option>
                            </select>
                            <p class="mt-1 text-xs text-gray-500">Select a contract template to update terms and conditions (fields below are auto-filled)</p>
                        </div>

                        <!-- Warranty Period -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Warranty Period</label>
                            <input type="text" @bind="WarrantyPeriod" maxlength="100"
                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200 sm:px-4 sm:py-2.5 sm:text-base"
                                   placeholder="e.g., 12 months" />
                        </div>

                        <!-- Maintenance Schedule -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Maintenance Schedule</label>
                            <input type="text" @bind="MaintenanceSchedule" maxlength="200"
                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200 sm:px-4 sm:py-2.5 sm:text-base"
                                   placeholder="e.g., Monthly, Quarterly" />
                        </div>

                        <!-- Free Services -->
                        <div class="sm:col-span-2">
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Free Services</label>
                            <textarea @bind="FreeServices" rows="2" maxlength="500"
                                      class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200 sm:px-4 sm:py-2.5 sm:text-base"
                                      placeholder="e.g., Training, Setup, Data Migration"></textarea>
                        </div>

                        <!-- Payment Terms -->
                        <div>
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Payment Terms</label>
                            <input type="text" @bind="PaymentTerms" maxlength="200"
                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200 sm:px-4 sm:py-2.5 sm:text-base"
                                   placeholder="e.g., Monthly, Net 30" />
                        </div>

                        <!-- Auto Renewal -->
                        <div class="flex items-center">
                            <input type="checkbox" @bind="AutoRenewal" 
                                   class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500" />
                            <label class="ml-2 text-xs font-medium text-gray-700 sm:text-sm">Auto Renewal</label>
                        </div>

                        <!-- Termination Clause (Auto-filled, read-only) -->
                        <div class="sm:col-span-2">
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Termination Clause</label>
                            <textarea @bind="TerminationClause" rows="2" maxlength="500" readonly
                                      class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 text-sm text-gray-600 sm:px-4 sm:py-2.5 sm:text-base"
                                      placeholder="Termination conditions and notice period"></textarea>
                            <p class="mt-1 text-xs text-gray-500">Auto-filled based on selected contract template</p>
                        </div>

                        <!-- SLA Details (Auto-filled, read-only) -->
                        <div class="sm:col-span-2">
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">SLA Details</label>
                            <textarea @bind="SlaDetails" rows="2" maxlength="500" readonly
                                      class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 text-sm text-gray-600 sm:px-4 sm:py-2.5 sm:text-base"
                                      placeholder="Service Level Agreement details"></textarea>
                            <p class="mt-1 text-xs text-gray-500">Auto-filled based on selected contract template</p>
                        </div>

                        <!-- Full Contract Terms (Auto-filled, read-only) -->
                        <div class="sm:col-span-2">
                            <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">Full Contract Terms</label>
                            <textarea @bind="ContractTermsText" rows="4" readonly
                                      class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 text-sm text-gray-600 sm:px-4 sm:py-2.5 sm:text-base"
                                      placeholder="Complete contract terms and conditions..."></textarea>
                            <p class="mt-1 text-xs text-gray-500">Auto-filled based on selected contract template</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 8: Cloud Database Connection String -->
            <div class="mb-6 overflow-hidden rounded-lg border border-cyan-100 bg-gradient-to-br from-cyan-50/30 via-white to-white shadow-sm sm:mb-6">
                <div class="bg-cyan-50 px-4 py-2 border-b border-cyan-100">
                    <div class="flex items-center gap-2">
                        <svg class="h-4 w-4 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                        </svg>
                        <h2 class="text-sm font-semibold text-cyan-900">Cloud Database Connection</h2>
                    </div>
                </div>
                <div class="px-4 py-4 bg-gradient-to-br from-cyan-50/20 to-white">
                    <div class="mb-3">
                        <label class="mb-1 block text-xs font-medium text-gray-700 sm:mb-2 sm:text-sm">
                            Cloud Database Connection String <span class="text-red-500">*</span>
                        </label>
                        <textarea @bind="CloudConnectionString" rows="3" required
                                  class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm font-mono focus:border-cyan-500 focus:outline-none focus:ring-2 focus:ring-cyan-200 sm:px-4 sm:py-2.5 sm:text-base"
                                  placeholder="Server=db35323.public.databaseasp.net; Database=DB_SchoolName_Cloud; User Id=db35323; Password=...; Encrypt=True; TrustServerCertificate=True;"></textarea>
                        <p class="mt-1 text-xs text-gray-500">Connection string for the cloud database where tables are already created. This is the source of truth for data syncing.</p>
                        <div class="mt-2 rounded-lg border border-blue-200 bg-blue-50 p-2">
                            <p class="text-xs text-blue-800">
                                <strong>💡 Note:</strong> Local database will be automatically created on first login. Each customer will have their own isolated local database per device.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error/Success Messages -->
            @if (!string.IsNullOrWhiteSpace(ErrorMessage))
            {
                <div class="mb-4 rounded-lg border border-red-200 bg-red-50 p-4">
                    <div class="flex items-center gap-2">
                        <svg class="h-5 w-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm font-medium text-red-800">@ErrorMessage</p>
                    </div>
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(SuccessMessage))
            {
                <div class="mb-4 rounded-lg border border-green-200 bg-green-50 p-4">
                    <div class="flex items-start gap-2">
                        <svg class="h-5 w-5 text-green-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <div class="flex-1">
                            <pre class="text-sm font-medium text-green-800 whitespace-pre-wrap font-sans">@SuccessMessage</pre>
                        </div>
                    </div>
                </div>
            }

            <!-- Action Buttons -->
            <div class="mt-6 flex justify-end gap-4">
                <button type="button"
                        @onclick="Cancel"
                        disabled="@IsSubmitting"
                        class="rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-semibold text-gray-700 shadow-md transition-all duration-300 hover:bg-gray-50 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    Cancel
                </button>
                <button type="button"
                        @onclick="HandleSubmit"
                        disabled="@IsSubmitting"
                        class="rounded-lg bg-blue-600 px-6 py-2.5 text-sm font-semibold text-white shadow-md transition-all duration-300 hover:bg-blue-700 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    @if (IsSubmitting)
                    {
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Add Customer</span>
                    }
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Review Modal -->
@if (showReviewModal)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 overflow-y-auto" @onclick="CloseReviewModal">
        <div class="relative max-h-[90vh] w-full max-w-4xl mx-4 my-4 overflow-y-auto rounded-xl bg-white shadow-2xl" @onclick:stopPropagation="true">
            <div class="sticky top-0 bg-white border-b border-gray-200 p-6 z-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-900">Review Customer Information</h2>
                    <button @onclick="CloseReviewModal" class="rounded-lg p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <p class="mt-2 text-sm text-gray-600">Please review all information before confirming</p>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Customer Information -->
                <div class="rounded-lg border border-blue-200 bg-blue-50 p-4">
                    <h3 class="text-lg font-bold text-blue-900 mb-3">Customer Information</h3>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div><span class="font-semibold">School Name:</span> @SchoolName</div>
                        <div><span class="font-semibold">School Type:</span> @SchoolType</div>
                        <div class="col-span-2"><span class="font-semibold">Address:</span> @Address</div>
                        <div><span class="font-semibold">Contact Person:</span> @($"{ContactFirstName} {(!string.IsNullOrWhiteSpace(ContactMiddleName) ? ContactMiddleName + " " : "")}{ContactLastName}{(!string.IsNullOrWhiteSpace(ContactSuffix) ? " " + ContactSuffix : "")}")</div>
                        <div><span class="font-semibold">Role:</span> @ContactRole</div>
                        <div><span class="font-semibold">Email:</span> @ContactEmail</div>
                        <div><span class="font-semibold">Phone:</span> @ContactPhone</div>
                    </div>
                </div>

                <!-- Billing Information -->
                <div class="rounded-lg border border-green-200 bg-green-50 p-4">
                    <h3 class="text-lg font-bold text-green-900 mb-3">Billing Information</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="font-semibold">Subscription Plan:</span>
                            <span>@(string.IsNullOrWhiteSpace(Plan) ? "Custom" : Plan)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">Monthly Fee (Subtotal):</span>
                            <span>₱@Subtotal.ToString("N2")</span>
                        </div>
                        @if (IsVatRegistered && VatAmount > 0)
                        {
                            <div class="flex justify-between">
                                <span class="font-semibold">VAT (@VatRate%):</span>
                                <span>₱@VatAmount.ToString("N2")</span>
                            </div>
                        }
                        <div class="flex justify-between border-t-2 border-green-300 pt-2 font-bold text-lg">
                            <span>Total Monthly Fee:</span>
                            <span class="text-green-700">₱@TotalWithVat.ToString("N2")</span>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(ContractDuration) && int.TryParse(ContractDuration, out int duration))
                        {
                            <div class="flex justify-between pt-2">
                                <span class="font-semibold">Total Contract Value (@ContractDuration months):</span>
                                <span class="font-semibold">₱@((TotalWithVat * duration).ToString("N2"))</span>
                            </div>
                        }
                    </div>
                </div>

                <!-- Contract Details -->
                <div class="rounded-lg border border-purple-200 bg-purple-50 p-4">
                    <h3 class="text-lg font-bold text-purple-900 mb-3">Contract Details</h3>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div><span class="font-semibold">Start Date:</span> @ContractStartDate.ToString("MMMM dd, yyyy")</div>
                        <div><span class="font-semibold">Duration:</span> @ContractDuration months</div>
                        @if (!string.IsNullOrWhiteSpace(ContractDuration) && int.TryParse(ContractDuration, out int dur))
                        {
                            <div><span class="font-semibold">End Date:</span> @ContractStartDate.AddMonths(dur).ToString("MMMM dd, yyyy")</div>
                        }
                        <div><span class="font-semibold">Status:</span> @Status</div>
                        @if (!string.IsNullOrWhiteSpace(PaymentTerms))
                        {
                            <div class="col-span-2"><span class="font-semibold">Payment Terms:</span> @PaymentTerms</div>
                        }
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="rounded-lg border border-teal-200 bg-teal-50 p-4">
                    <h3 class="text-lg font-bold text-teal-900 mb-3">Payment Information</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="font-semibold">Payment Method:</span>
                            <span>@DefaultPaymentMethod</span>
                        </div>
                        @if (DefaultPaymentMethod == "Credit" && CreditMonths > 0 && CreditInterestRate > 0)
                        {
                            <div class="pt-2 mt-2 border-t border-teal-300">
                                <div class="font-semibold mb-2">Credit Terms:</div>
                                <div class="space-y-1 pl-2 text-xs">
                                    <div class="flex justify-between">
                                        <span>Number of Months:</span>
                                        <span class="font-medium">@CreditMonths months</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Interest Rate:</span>
                                        <span class="font-medium">@CreditInterestRate.ToString("F2")%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Payment Frequency:</span>
                                        <span class="font-medium">@CreditPaymentFrequency</span>
                                    </div>
                                    @if (CustomerCreditTotalAmount > 0)
                                    {
                                        <div class="pt-1 mt-1 border-t border-teal-200">
                                            <div class="flex justify-between">
                                                <span>Total Interest:</span>
                                                <span class="font-semibold text-amber-700">₱@CustomerCreditTotalInterest.ToString("N2")</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Total Amount Due:</span>
                                                <span class="font-bold text-amber-900">₱@CustomerCreditTotalAmount.ToString("N2")</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Monthly Payment:</span>
                                                <span class="font-medium">₱@CustomerCreditMonthlyPayment.ToString("N2")</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrWhiteSpace(PaymentReference))
                        {
                            <div class="flex justify-between">
                                <span class="font-semibold">Payment Reference:</span>
                                <span>@PaymentReference</span>
                            </div>
                        }
                        @if (!string.IsNullOrWhiteSpace(PaymentNotes))
                        {
                            <div class="col-span-2"><span class="font-semibold">Payment Notes:</span> @PaymentNotes</div>
                        }
                    </div>
                </div>

                <!-- Modules -->
                <div class="rounded-lg border border-indigo-200 bg-indigo-50 p-4">
                    <h3 class="text-lg font-bold text-indigo-900 mb-3">Included Modules</h3>
                    <div class="space-y-2">
                        @if (!string.IsNullOrWhiteSpace(Plan))
                        {
                            <div class="text-sm font-semibold">@Plan Plan (All modules included)</div>
                        }
                        else
                        {
                            @foreach (var packageId in SelectedPackages)
                            {
                                var package = ModulePackages.GetPackageById(packageId);
                                if (package != null)
                                {
                                    <div class="flex items-center justify-between text-sm">
                                        <span>✓ @package.PackageName</span>
                                        <span class="font-semibold text-indigo-700">₱@GetPackagePrice(packageId).ToString("N2")</span>
                                    </div>
                                }
                            }
                        }
                        <div class="flex items-center justify-between text-sm border-t border-indigo-300 pt-2 mt-2">
                            <span>✓ @CorePackage.PackageName (Always Included)</span>
                            <span class="font-semibold text-green-700">₱@GetPackagePrice(CorePackage.PackageId).ToString("N2")</span>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(Plan))
                        {
                            <div class="text-xs text-gray-600 mt-2 pt-2 border-t border-indigo-300">
                                Plan includes all available modules and features
                            </div>
                        }
                    </div>
                </div>

                <!-- Contract Terms & Services -->
                <div class="rounded-lg border border-teal-200 bg-teal-50 p-4">
                    <h3 class="text-lg font-bold text-teal-900 mb-3">Contract Terms & Services</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="font-semibold">Contract Template:</span>
                            <span>@SelectedContractTemplate</span>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(WarrantyPeriod))
                        {
                            <div><span class="font-semibold">Warranty Period:</span> @WarrantyPeriod</div>
                        }
                        @if (!string.IsNullOrWhiteSpace(MaintenanceSchedule))
                        {
                            <div><span class="font-semibold">Maintenance Schedule:</span> @MaintenanceSchedule</div>
                        }
                        @if (!string.IsNullOrWhiteSpace(FreeServices))
                        {
                            <div><span class="font-semibold">Free Services:</span> @FreeServices</div>
                        }
                        @if (!string.IsNullOrWhiteSpace(TerminationClause))
                        {
                            <div class="pt-2 border-t border-teal-300">
                                <div class="font-semibold mb-1">Termination Clause:</div>
                                <div class="text-xs text-gray-700 pl-2">@TerminationClause</div>
                            </div>
                        }
                        @if (!string.IsNullOrWhiteSpace(SlaDetails))
                        {
                            <div class="pt-2 border-t border-teal-300">
                                <div class="font-semibold mb-1">SLA Details:</div>
                                <div class="text-xs text-gray-700 pl-2">@SlaDetails</div>
                            </div>
                        }
                        @if (!string.IsNullOrWhiteSpace(ContractTermsText))
                        {
                            <div class="pt-2 border-t border-teal-300">
                                <div class="font-semibold mb-1">Full Contract Terms:</div>
                                <div class="text-xs text-gray-700 pl-2 max-h-32 overflow-y-auto">@ContractTermsText</div>
                            </div>
                        }
                    </div>
                </div>

                <!-- BIR Information (if applicable) -->
                @if (IsVatRegistered)
                {
                    <div class="rounded-lg border border-amber-200 bg-amber-50 p-4">
                        <h3 class="text-lg font-bold text-amber-900 mb-3">BIR Compliance</h3>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            @if (!string.IsNullOrWhiteSpace(BirTin))
                            {
                                <div><span class="font-semibold">BIR TIN:</span> @BirTin</div>
                            }
                            <div><span class="font-semibold">VAT Registered:</span> Yes</div>
                            @if (VatRate.HasValue)
                            {
                                <div><span class="font-semibold">VAT Rate:</span> @VatRate%</div>
                            }
                        </div>
                    </div>
                }

                <!-- Admin Account Credentials -->
                <div class="rounded-lg border border-red-200 bg-red-50 p-4">
                    <h3 class="text-lg font-bold text-red-900 mb-3">Admin Account Credentials</h3>
                    <div class="space-y-3 text-sm">
                        <div class="bg-white rounded-lg p-3 border border-red-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold text-gray-700">Username/Email:</span>
                                <span class="font-mono text-red-700 font-bold">@previewAdminUsername</span>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-3 border border-red-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold text-gray-700">Default Password:</span>
                                <span class="font-mono text-red-700 font-bold">@previewAdminPassword</span>
                            </div>
                        </div>
                        <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                            <strong>Important:</strong> These credentials will be used to log in to the school's system. Please save this information securely. The password should be changed after first login.
                        </div>
                    </div>
                </div>
            </div>

            <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 p-6 flex justify-end gap-3">
                <button @onclick="CloseReviewModal" 
                        class="rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-semibold text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button @onclick="ConfirmAndSaveCustomer" 
                        disabled="@IsSubmitting"
                        class="rounded-lg bg-blue-600 px-6 py-2.5 text-sm font-semibold text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    @if (IsSubmitting)
                    {
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Confirm & Generate PDF</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@code {
    private string SchoolName { get; set; } = string.Empty;
    private string SchoolType { get; set; } = string.Empty;
    private string Address { get; set; } = string.Empty;
    private string ContactFirstName { get; set; } = string.Empty;
    private string? ContactMiddleName { get; set; }
    private string ContactLastName { get; set; } = string.Empty;
    private string? ContactSuffix { get; set; }
    private string ContactRole { get; set; } = "Admin"; // Default to Admin role
    private string ContactEmail { get; set; } = string.Empty;
    private string ContactPhone { get; set; } = string.Empty;
    
    // Roles dropdown
    private List<string> AvailableRoles { get; set; } = new();
    private string Plan { get; set; } = string.Empty;
    private decimal MonthlyFee { get; set; } = 0;
    private DateTime ContractStartDate { get; set; } = DateTime.Today;
    private string ContractDuration { get; set; } = string.Empty;
    private string Status { get; set; } = "Active";
    private string Notes { get; set; } = string.Empty;
    
    // Contract Template
    private string SelectedContractTemplate { get; set; } = string.Empty;
    
    // BIR Compliance
    private string? BirTin { get; set; }
    private string? BirBusinessName { get; set; }
    private string? BirAddress { get; set; }
    private string? BirRegistrationType { get; set; }
    private bool IsVatRegistered { get; set; }
    private decimal? VatRate { get; set; } = 12.00m;
    
    // Contract Terms & Services
    private string? WarrantyPeriod { get; set; } = "12";
    private string? MaintenanceSchedule { get; set; } = "12";
    private string? FreeServices { get; set; }
    private string? PaymentTerms { get; set; }
    private string DefaultPaymentMethod { get; set; } = "Cash";
    private string? PaymentReference { get; set; }
    private string? PaymentNotes { get; set; }

    // Credit Terms
    private int CreditMonths { get; set; } = 1;
    private decimal CreditInterestRate { get; set; } = 0;
    private string CreditPaymentFrequency { get; set; } = "Monthly";
    private decimal CustomerCreditTotalInterest { get; set; } = 0;
    private decimal CustomerCreditTotalAmount { get; set; } = 0;
    private decimal CustomerCreditMonthlyPayment { get; set; } = 0;
    private string? TerminationClause { get; set; }
    private string? SlaDetails { get; set; }
    private string? ContractTermsText { get; set; }
    private bool AutoRenewal { get; set; }
    
    // Cloud Database Connection String (Local DB is auto-generated)
    private string CloudConnectionString { get; set; } = string.Empty;
    
    // Calculated Values
    private decimal Subtotal { get; set; } = 0;
    private decimal VatAmount { get; set; } = 0;
    private decimal TotalWithVat { get; set; } = 0;
    
    // Module Selection
    private List<ModulePackages.ModulePackage> AvailablePackages { get; set; } = new();
    private ModulePackages.ModulePackage CorePackage { get; set; } = ModulePackages.CorePackage;
    private List<string> SelectedPackages { get; set; } = new();
    
    private string? ErrorMessage { get; set; }
    private string? SuccessMessage { get; set; }
    private bool IsSubmitting { get; set; } = false;
    private bool showReviewModal { get; set; } = false;
    private string previewAdminUsername { get; set; } = string.Empty;
    private string previewAdminPassword { get; set; } = "Admin123456";

    protected override async Task OnInitializedAsync()
    {
        // Check if user is Super Admin (handle both "Super Admin" and "SuperAdmin")
        var currentUser = AuthService?.CurrentUser;
        var userRole = currentUser?.user_role;
        var isSuperAdmin = !string.IsNullOrWhiteSpace(userRole) && 
                          (userRole.Equals("Super Admin", StringComparison.OrdinalIgnoreCase) ||
                           userRole.Replace(" ", "").Equals("SuperAdmin", StringComparison.OrdinalIgnoreCase));
        
        if (!isSuperAdmin)
        {
            Navigation.NavigateTo("/dashboard");
            return;
        }

        // Load available module packages (include all, inventory will be disabled)
        AvailablePackages = ModulePackages.GetAllPackages().ToList();
        
        // Load roles
        await LoadRolesAsync();
        
        // Auto-fill contract terms with default values
        TerminationClause = "Either party may terminate this Agreement by providing thirty (30) days written notice to the other party. Upon termination, the Customer shall pay all outstanding fees and return any proprietary materials. The Service Provider shall provide reasonable assistance for data export during the notice period.";
        SlaDetails = "Service Level Agreement: The Service Provider guarantees 99.5% uptime availability. Support will be provided during business hours (Monday to Friday, 9:00 AM to 5:00 PM). Response time for critical issues: 4 hours. Response time for non-critical issues: 24 hours. Scheduled maintenance will be communicated at least 48 hours in advance.";
        ContractTermsText = "This Agreement governs the provision of the BrightEnroll Enrollment Management System to the Customer. The Service Provider agrees to maintain the system, provide technical support, and ensure data security. The Customer agrees to pay monthly fees on time, use the system in accordance with applicable laws, and maintain confidentiality of login credentials. All intellectual property rights remain with the Service Provider. The Customer may not reverse engineer, copy, or distribute the software without written permission.";
        SelectedContractTemplate = "Standard"; // Default to Standard template
        
        // Check for plan query parameter and auto-fill
        try
        {
            var uri = new Uri(Navigation.Uri);
            if (!string.IsNullOrWhiteSpace(uri.Query))
            {
                var queryString = uri.Query.TrimStart('?');
                var queryParams = queryString.Split('&')
                    .Select(p => p.Split('='))
                    .Where(p => p.Length == 2)
                    .ToDictionary(p => Uri.UnescapeDataString(p[0]), p => Uri.UnescapeDataString(p[1]));
                
                if (queryParams.TryGetValue("plan", out var planValue) && !string.IsNullOrWhiteSpace(planValue))
                {
                    var planParam = planValue.Trim();
                    if (planParam.Equals("Basic", StringComparison.OrdinalIgnoreCase) ||
                        planParam.Equals("Standard", StringComparison.OrdinalIgnoreCase) ||
                        planParam.Equals("Premium", StringComparison.OrdinalIgnoreCase))
                    {
                        Plan = planParam;
                        OnPlanChanged();
                    }
                }
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error parsing query string: {ex.Message}");
        }
    }
    
    private Task LoadRolesAsync()
    {
        try
        {
            // Only Admin role is available for customer contact person
            AvailableRoles = new List<string> { "Admin" };
            
            // Auto-set to Admin
            ContactRole = "Admin";
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading roles: {ex.Message}");
            // Fallback to Admin only
            AvailableRoles = new List<string> { "Admin" };
            ContactRole = "Admin";
        }
        
        return Task.CompletedTask;
    }
    
    private void OnRegistrationTypeChanged()
    {
        // Automate VAT registration based on Registration Type
        IsVatRegistered = BirRegistrationType == "VAT";
        if (IsVatRegistered && !VatRate.HasValue)
        {
            VatRate = 12.00m; // Default VAT rate
        }
        else if (!IsVatRegistered)
        {
            VatRate = null;
        }
        CalculateVAT();
        StateHasChanged();
    }
    
    private void OnPlanChanged()
    {
        // Check if modules are selected - if so, show error and prevent plan selection
        if (SelectedPackages.Any() && !string.IsNullOrWhiteSpace(Plan))
        {
            ErrorMessage = "Cannot select a plan when modules are already selected. Please clear module selections first, or remove the plan selection.";
            Plan = string.Empty; // Clear the plan selection
            StateHasChanged();
            return;
        }
        
        UpdateMonthlyFee();
        
        // When plan is selected, disable module selection by clearing selections
        if (!string.IsNullOrWhiteSpace(Plan))
        {
            SelectedPackages.Clear();
            ErrorMessage = null; // Clear any previous errors
        }
        
        // Recalculate credit if applicable
        if (DefaultPaymentMethod == "Credit")
        {
            CalculateCustomerCreditInterest();
        }
        
        StateHasChanged();
    }

    private void OnPaymentMethodChanged()
    {
        if (DefaultPaymentMethod == "Credit")
        {
            // Set default credit terms
            if (CreditMonths == 0) CreditMonths = 1;
            if (CreditInterestRate == 0) CreditInterestRate = 2.0m; // Default 2% per month
            CalculateCustomerCreditInterest();
        }
        else
        {
            // Reset credit calculations for Cash
            CustomerCreditTotalInterest = 0;
            CustomerCreditTotalAmount = 0;
            CustomerCreditMonthlyPayment = 0;
        }
        StateHasChanged();
    }

    private void OnContractTemplateChanged()
    {
        if (string.IsNullOrWhiteSpace(SelectedContractTemplate))
        {
            TerminationClause = null;
            SlaDetails = null;
            ContractTermsText = null;
            StateHasChanged();
            return;
        }

        switch (SelectedContractTemplate)
        {
            case "Standard":
                TerminationClause = "Either party may terminate this Agreement by providing thirty (30) days written notice to the other party. Upon termination, the Customer shall pay all outstanding fees and return any proprietary materials. The Service Provider shall provide reasonable assistance for data export during the notice period.";
                SlaDetails = "Service Level Agreement: The Service Provider guarantees 99.5% uptime availability. Support will be provided during business hours (Monday to Friday, 9:00 AM to 5:00 PM). Response time for critical issues: 4 hours. Response time for non-critical issues: 24 hours. Scheduled maintenance will be communicated at least 48 hours in advance.";
                ContractTermsText = "This Agreement governs the provision of the BrightEnroll Enrollment Management System to the Customer. The Service Provider agrees to maintain the system, provide technical support, and ensure data security. The Customer agrees to pay monthly fees on time, use the system in accordance with applicable laws, and maintain confidentiality of login credentials. All intellectual property rights remain with the Service Provider. The Customer may not reverse engineer, copy, or distribute the software without written permission.";
                break;
            case "Premium":
                TerminationClause = "Either party may terminate this Agreement by providing sixty (60) days written notice to the other party. Upon termination, the Customer shall pay all outstanding fees and return any proprietary materials. The Service Provider shall provide comprehensive data export and migration assistance during the notice period. Early termination fees may apply if termination occurs within the first 12 months of the contract.";
                SlaDetails = "Service Level Agreement: The Service Provider guarantees 99.9% uptime availability. Support will be provided 24/7 with priority response. Response time for critical issues: 2 hours. Response time for non-critical issues: 8 hours. Dedicated account manager assigned. Scheduled maintenance will be communicated at least 72 hours in advance. Monthly performance reports will be provided.";
                ContractTermsText = "This Premium Agreement governs the provision of the BrightEnroll Enrollment Management System with enhanced support and features to the Customer. The Service Provider agrees to maintain the system with premium uptime guarantees, provide 24/7 technical support, ensure enterprise-grade data security, and assign a dedicated account manager. The Customer agrees to pay monthly fees on time, use the system in accordance with applicable laws, and maintain confidentiality of login credentials. All intellectual property rights remain with the Service Provider. The Customer may not reverse engineer, copy, or distribute the software without written permission. Premium customers receive priority feature requests and custom module development options.";
                break;
            case "Custom":
                TerminationClause = "Termination conditions and notice period shall be negotiated and specified in a separate addendum to this Agreement. Standard termination requires thirty (30) days written notice unless otherwise specified in the custom terms.";
                SlaDetails = "Service Level Agreement details shall be customized based on specific requirements and documented in a separate Service Level Agreement addendum. Standard SLA includes 99.5% uptime guarantee and business hours support unless otherwise specified.";
                ContractTermsText = "This Custom Agreement governs the provision of the BrightEnroll Enrollment Management System with customized terms and conditions. Specific terms, conditions, and service levels will be detailed in separate addendums attached to this Agreement. All standard terms apply unless explicitly modified in writing.";
                break;
            default:
                TerminationClause = null;
                SlaDetails = null;
                ContractTermsText = null;
                break;
        }
        
        StateHasChanged();
    }

    private void CalculateCustomerCreditInterest()
    {
        if (DefaultPaymentMethod != "Credit" || TotalWithVat <= 0 || CreditMonths <= 0 || CreditInterestRate < 0)
        {
            CustomerCreditTotalInterest = 0;
            CustomerCreditTotalAmount = 0;
            CustomerCreditMonthlyPayment = 0;
            return;
        }

        // ERP Standard: Simple Interest Calculation
        // Interest = Principal × Rate × Time
        decimal periodRate = CreditInterestRate / 100m;
        
        // Calculate number of payment periods
        int paymentPeriods = CreditPaymentFrequency switch
        {
            "Monthly" => CreditMonths,
            "Quarterly" => (int)Math.Ceiling(CreditMonths / 3.0m),
            "Semi-Annual" => (int)Math.Ceiling(CreditMonths / 6.0m),
            "Annual" => (int)Math.Ceiling(CreditMonths / 12.0m),
            _ => CreditMonths
        };

        // Simple Interest: I = P × R × T
        CustomerCreditTotalInterest = TotalWithVat * periodRate * paymentPeriods;
        CustomerCreditTotalAmount = TotalWithVat + CustomerCreditTotalInterest;
        
        // Calculate monthly payment (total divided by months)
        CustomerCreditMonthlyPayment = CustomerCreditTotalAmount / CreditMonths;
    }

    private void TogglePackage(string packageId, bool isSelected)
    {
        // Don't allow selection if plan is selected or if it's inventory package
        if (!string.IsNullOrWhiteSpace(Plan))
        {
            ErrorMessage = "Cannot select modules when a plan is already selected. Please remove the plan selection first, or clear all module selections.";
            StateHasChanged();
            return;
        }
        
        if (packageId == "inventory")
        {
            return;
        }
        
        if (isSelected && !SelectedPackages.Contains(packageId))
        {
            SelectedPackages.Add(packageId);
            ErrorMessage = null; // Clear error when successfully adding module
        }
        else if (!isSelected)
        {
            SelectedPackages.Remove(packageId);
        }
        
        // Recalculate fee if no plan is selected
        if (string.IsNullOrWhiteSpace(Plan))
        {
            Subtotal = CalculateCustomFee();
            CalculateVAT();
        }
        
        StateHasChanged();
    }

    private void UpdateMonthlyFee()
    {
        if (!string.IsNullOrWhiteSpace(Plan))
        {
            Subtotal = Plan switch
            {
                "Basic" => 35000,
                "Standard" => 55000,
                "Premium" => 85000,
                _ => 0
            };
        }
        else
        {
            // Calculate fee based on selected modules
            Subtotal = CalculateCustomFee();
        }
        
        // Calculate VAT if applicable
        CalculateVAT();
        StateHasChanged();
    }
    
    private void CalculateVAT()
    {
        if (IsVatRegistered && VatRate.HasValue && VatRate.Value > 0)
        {
            // VAT is calculated on top of subtotal
            VatAmount = Math.Round(Subtotal * (VatRate.Value / 100m), 2);
            TotalWithVat = Subtotal + VatAmount;
            MonthlyFee = TotalWithVat;
        }
        else
        {
            VatAmount = 0;
            TotalWithVat = Subtotal;
            MonthlyFee = Subtotal;
            VatRate = null; // Clear VAT rate if not registered
        }
        
        // Recalculate credit if applicable
        if (DefaultPaymentMethod == "Credit")
        {
            CalculateCustomerCreditInterest();
        }
    }

    private decimal GetPackagePrice(string packageId)
    {
        return packageId switch
        {
            "core" => 10000,
            "enrollment" => 25000, // Enrollment includes curriculum, payment, teacher portal
            "hr_payroll" => 15000, // HR & Payroll (includes attendance)
            "finance" => 12000,   // Full Finance Management
            "inventory" => 5000,   // Inventory
            _ => 0
        };
    }

    private decimal CalculateCustomFee()
    {
        // Base fee for core package (always included)
        decimal baseFee = 10000;
        
        // Add fees for each selected package
        decimal packageFees = 0;
        foreach (var packageId in SelectedPackages)
        {
            packageFees += GetPackagePrice(packageId);
        }
        
        return baseFee + packageFees;
    }

    private async Task HandleFormSubmit()
    {
        // Prevent form submission - we handle it via button click
        await HandleSubmit();
    }

    private Task HandleSubmit()
    {
        // Clear previous messages
        ErrorMessage = null;
        SuccessMessage = null;
        
        // Prevent double submission
        if (IsSubmitting)
        {
            return Task.CompletedTask;
        }
        
        // Ensure we're not already showing the modal
        if (showReviewModal)
        {
            return Task.CompletedTask;
        }

        // Validate required fields
        if (string.IsNullOrWhiteSpace(SchoolName))
        {
            ErrorMessage = "School Name is required.";
            StateHasChanged();
            return Task.CompletedTask;
        }

        if (string.IsNullOrWhiteSpace(SchoolType))
        {
            ErrorMessage = "School Type is required.";
            StateHasChanged();
            return Task.CompletedTask;
        }

        if (string.IsNullOrWhiteSpace(Address))
        {
            ErrorMessage = "Address is required.";
            StateHasChanged();
            return Task.CompletedTask;
        }

        if (string.IsNullOrWhiteSpace(ContactFirstName))
        {
            ErrorMessage = "Contact First Name is required.";
            StateHasChanged();
            return Task.CompletedTask;
        }

        if (string.IsNullOrWhiteSpace(ContactLastName))
        {
            ErrorMessage = "Contact Last Name is required.";
            StateHasChanged();
            return Task.CompletedTask;
        }

        if (string.IsNullOrWhiteSpace(ContactRole))
        {
            ErrorMessage = "Contact Role is required.";
            StateHasChanged();
            return Task.CompletedTask;
        }

        if (string.IsNullOrWhiteSpace(ContactEmail))
        {
            ErrorMessage = "Contact Email is required.";
            StateHasChanged();
            return Task.CompletedTask;
        }

        if (string.IsNullOrWhiteSpace(ContactPhone))
        {
            ErrorMessage = "Contact Phone Number is required.";
            StateHasChanged();
            return Task.CompletedTask;
        }

        // Validate that either a plan is selected OR at least one module package is selected (besides core)
        if (string.IsNullOrWhiteSpace(Plan) && !SelectedPackages.Any())
        {
            ErrorMessage = "Please select either a promotional plan or at least one module package.";
            StateHasChanged();
            return Task.CompletedTask;
        }

        // Validate that plan and modules are not both selected (mutual exclusivity)
        if (!string.IsNullOrWhiteSpace(Plan) && SelectedPackages.Any())
        {
            ErrorMessage = "Cannot have both a plan and custom modules selected. Please select either a plan OR custom modules, not both.";
            StateHasChanged();
            return Task.CompletedTask;
        }

        if (string.IsNullOrWhiteSpace(ContractDuration))
        {
            ErrorMessage = "Contract Duration is required.";
            StateHasChanged();
            return Task.CompletedTask;
        }

        if (string.IsNullOrWhiteSpace(CloudConnectionString))
        {
            ErrorMessage = "Cloud Database Connection String is required. Please provide the cloud database connection string where tables are already created.";
            StateHasChanged();
            return Task.CompletedTask;
        }

        // Validate cloud connection string format
        if (!CloudConnectionString.Contains("Server=") || !CloudConnectionString.Contains("Database="))
        {
            ErrorMessage = "Invalid Cloud Database Connection String format. Please provide a valid SQL Server connection string.";
            StateHasChanged();
            return Task.CompletedTask;
        }

        // Calculate final fee with VAT
        CalculateVAT();

        // Generate preview admin username and password before showing review modal
        GeneratePreviewAdminCredentials();

        // Show review modal instead of saving directly
        // Make sure we're not already submitting
        if (!IsSubmitting)
        {
            showReviewModal = true;
            StateHasChanged();
            
            System.Diagnostics.Debug.WriteLine($"[AddCustomer] Showing review modal. showReviewModal = {showReviewModal}");
        }
        else
        {
            System.Diagnostics.Debug.WriteLine($"[AddCustomer] Already submitting, skipping modal");
        }
        
        return Task.CompletedTask;
    }

    private void CloseReviewModal()
    {
        showReviewModal = false;
        StateHasChanged();
    }

    private async Task ConfirmAndSaveCustomer()
    {
        // Prevent double submission
        if (IsSubmitting)
        {
            System.Diagnostics.Debug.WriteLine($"[AddCustomer] Already submitting, ignoring ConfirmAndSaveCustomer call");
            return;
        }
        
        System.Diagnostics.Debug.WriteLine($"[AddCustomer] ConfirmAndSaveCustomer called. Closing modal and starting save process.");
        
        // Close modal first
        showReviewModal = false;
        StateHasChanged();
        
        // Proceed with save
        IsSubmitting = true;
        StateHasChanged();
        
        try
        {
            System.Diagnostics.Debug.WriteLine($"[AddCustomer] Starting customer creation. SchoolName: {SchoolName}, Plan: {Plan}");
            System.Diagnostics.Debug.WriteLine($"[AddCustomer] CurrentUser: {AuthService.CurrentUser != null}, UserID: {AuthService.CurrentUser?.user_ID}");

            // Build notes with module information
            var moduleNotes = new System.Text.StringBuilder();
            
            moduleNotes.AppendLine("\n=== SELECTED MODULES ===");
            if (!string.IsNullOrWhiteSpace(Plan))
            {
                moduleNotes.AppendLine($"Promotional Plan: {Plan}");
                moduleNotes.AppendLine("Note: Module customization is not available when a promotional plan is selected.");
            }
            else
            {
                moduleNotes.AppendLine($"Selected Packages: {string.Join(", ", SelectedPackages.Select(id => ModulePackages.GetPackageById(id)?.PackageName).Where(n => !string.IsNullOrEmpty(n)))}");
                moduleNotes.AppendLine("\n=== PACKAGE DETAILS ===");
                foreach (var packageId in SelectedPackages)
                {
                    var package = ModulePackages.GetPackageById(packageId);
                    if (package != null)
                    {
                        moduleNotes.AppendLine($"\n{package.PackageName}:");
                        moduleNotes.AppendLine($"  {package.Description}");
                    }
                }
            }
            moduleNotes.AppendLine("\nNote: Inventory & Asset Management module is disabled and not included.");

            // Extract database name from cloud connection string
            var cloudDbName = ExtractDatabaseName(CloudConnectionString);

            var customer = new Customer
            {
                SchoolName = SchoolName,
                SchoolType = SchoolType,
                Address = Address,
                ContactPerson = $"{ContactFirstName} {(!string.IsNullOrWhiteSpace(ContactMiddleName) ? ContactMiddleName + " " : "")}{ContactLastName}{(!string.IsNullOrWhiteSpace(ContactSuffix) ? " " + ContactSuffix : "")}".Trim(),
                ContactPosition = ContactRole, // Store role in ContactPosition field (database field name)
                ContactEmail = ContactEmail,
                ContactPhone = ContactPhone,
                SubscriptionPlan = string.IsNullOrWhiteSpace(Plan) ? "Custom" : Plan,
                MonthlyFee = TotalWithVat > 0 ? TotalWithVat : Subtotal,
                ContractStartDate = ContractStartDate,
                ContractDurationMonths = int.Parse(ContractDuration),
                ContractEndDate = ContractStartDate.AddMonths(int.Parse(ContractDuration)),
                Status = Status,
                Notes = moduleNotes.ToString(),
                // Cloud Database Connection (Local DB will be auto-generated on first login)
                CloudConnectionString = CloudConnectionString,
                DatabaseName = cloudDbName, // Store cloud database name
                // DatabaseConnectionString will be auto-generated on first login
                // BIR Compliance (for the school)
                BirTin = !string.IsNullOrWhiteSpace(BirTin) ? BirTin : null,
                BirBusinessName = !string.IsNullOrWhiteSpace(BirBusinessName) ? BirBusinessName : null,
                BirAddress = !string.IsNullOrWhiteSpace(BirAddress) ? BirAddress : null,
                BirRegistrationType = !string.IsNullOrWhiteSpace(BirRegistrationType) ? BirRegistrationType : null,
                IsVatRegistered = IsVatRegistered,
                VatRate = (IsVatRegistered && VatRate.HasValue && VatRate.Value > 0) ? VatRate.Value : null,
                // Contract Terms & Services
                WarrantyPeriod = !string.IsNullOrWhiteSpace(WarrantyPeriod) ? WarrantyPeriod : null,
                MaintenanceSchedule = !string.IsNullOrWhiteSpace(MaintenanceSchedule) ? MaintenanceSchedule : null,
                FreeServices = !string.IsNullOrWhiteSpace(FreeServices) ? FreeServices : null,
                PaymentTerms = BuildPaymentTerms(),
                TerminationClause = !string.IsNullOrWhiteSpace(TerminationClause) ? TerminationClause : null,
                SlaDetails = !string.IsNullOrWhiteSpace(SlaDetails) ? SlaDetails : null,
                ContractTermsText = !string.IsNullOrWhiteSpace(ContractTermsText) ? ContractTermsText : null,
                AutoRenewal = AutoRenewal,
                CreatedBy = AuthService.CurrentUser?.user_ID
            };

            System.Diagnostics.Debug.WriteLine($"[AddCustomer] Customer object created. CustomerCode will be auto-generated.");

            var createdCustomer = await SuperAdminService.CreateCustomerAsync(customer, AuthService.CurrentUser?.user_ID);
            
            System.Diagnostics.Debug.WriteLine($"[AddCustomer] Customer created successfully. CustomerId: {createdCustomer.CustomerId}, CustomerCode: {createdCustomer.CustomerCode}");
            
            // Verify the customer was actually saved by checking if it has an ID
            if (createdCustomer.CustomerId > 0)
            {
                // Generate PDF
                var generatedBy = $"{AuthService.CurrentUser?.first_name} {AuthService.CurrentUser?.last_name}".Trim();
                if (string.IsNullOrWhiteSpace(generatedBy))
                {
                    generatedBy = AuthService.CurrentUser?.email ?? AuthService.CurrentUser?.system_ID ?? "Super Admin";
                }

                // Get selected modules list for PDF
                var selectedModules = new List<string>();
                if (!string.IsNullOrWhiteSpace(Plan))
                {
                    selectedModules.Add($"All modules included in {Plan} plan");
                }
                else
                {
                    foreach (var packageId in SelectedPackages)
                    {
                        var package = ModulePackages.GetPackageById(packageId);
                        if (package != null)
                        {
                            selectedModules.Add(package.PackageName);
                        }
                    }
                }
                selectedModules.Add(CorePackage.PackageName + " (Always Included)");

                var pdfBytes = CustomerContractPdfGenerator.GenerateCustomerContract(createdCustomer, generatedBy, selectedModules);
                var fileName = $"CustomerContract_{createdCustomer.CustomerCode}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
                var base64Content = Convert.ToBase64String(pdfBytes);
                
                // Download PDF
                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "application/pdf", base64Content);
                
                var successDetails = new System.Text.StringBuilder();
                successDetails.AppendLine($"Customer '{createdCustomer.SchoolName}' (Code: {createdCustomer.CustomerCode}) has been saved successfully!");
                successDetails.AppendLine($"\n📄 Contract PDF has been generated and downloaded.");
                
                // Add database information if available
                if (!string.IsNullOrEmpty(createdCustomer.DatabaseName))
                {
                    successDetails.AppendLine($"\n📊 Database: {createdCustomer.DatabaseName}");
                    successDetails.AppendLine($"   ✅ Database tables initialized");
                    successDetails.AppendLine($"   ✅ School information seeded");
                }
                
                // Add admin account information if available
                if (!string.IsNullOrEmpty(createdCustomer.AdminUsername))
                {
                    successDetails.AppendLine($"\n👤 Admin Account Created:");
                    successDetails.AppendLine($"   Email: {createdCustomer.AdminUsername}");
                    successDetails.AppendLine($"   Password: {createdCustomer.AdminPassword ?? "Admin123456"}");
                    successDetails.AppendLine($"   System ID: {createdCustomer.AdminUsername?.Split('@')[0] ?? "N/A"}");
                    successDetails.AppendLine($"\n⚠️ Please save these credentials securely!");
                }
                else
                {
                    successDetails.AppendLine($"\n⚠️ Admin account creation may have failed. Please check logs.");
                }
                
                SuccessMessage = successDetails.ToString();
                System.Diagnostics.Debug.WriteLine($"[AddCustomer] ✅ VERIFIED: Customer saved with ID: {createdCustomer.CustomerId}");
                System.Diagnostics.Debug.WriteLine($"[AddCustomer] Database: {createdCustomer.DatabaseName}");
                System.Diagnostics.Debug.WriteLine($"[AddCustomer] Admin: {createdCustomer.AdminUsername}");
                System.Diagnostics.Debug.WriteLine($"[AddCustomer] PDF generated and downloaded: {fileName}");
                
                // Wait to show success message, then navigate
                await Task.Delay(3000);
                Navigation.NavigateTo("/system-admin/customers?toast=customer_added");
            }
            else
            {
                throw new Exception("Customer was created but no ID was returned. Save may have failed.");
            }
        }
        catch (Microsoft.EntityFrameworkCore.DbUpdateException dbEx)
        {
            var errorMsg = "Database error occurred while saving the customer.";
            if (dbEx.InnerException != null)
            {
                errorMsg += $" {dbEx.InnerException.Message}";
            }
            ErrorMessage = errorMsg;
            
            System.Diagnostics.Debug.WriteLine($"[AddCustomer] Database error: {dbEx.Message}");
            System.Diagnostics.Debug.WriteLine($"[AddCustomer] Inner exception: {dbEx.InnerException?.Message}");
            System.Diagnostics.Debug.WriteLine($"[AddCustomer] Stack trace: {dbEx.StackTrace}");
            
            IsSubmitting = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error saving customer: {ex.Message}";
            
            System.Diagnostics.Debug.WriteLine($"[AddCustomer] Error: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"[AddCustomer] Inner exception: {ex.InnerException?.Message}");
            System.Diagnostics.Debug.WriteLine($"[AddCustomer] Stack trace: {ex.StackTrace}");
            
            IsSubmitting = false;
            StateHasChanged();
        }
    }

    private string ExtractDatabaseName(string connectionString)
    {
        try
        {
            var parts = connectionString.Split(';');
            foreach (var part in parts)
            {
                var trimmed = part.Trim();
                if (trimmed.StartsWith("Database=", StringComparison.OrdinalIgnoreCase) ||
                    trimmed.StartsWith("Initial Catalog=", StringComparison.OrdinalIgnoreCase))
                {
                    var dbPart = trimmed.Split('=');
                    if (dbPart.Length > 1)
                    {
                        return dbPart[1].Trim();
                    }
                }
            }
        }
        catch
        {
            // Ignore errors
        }
        return string.Empty;
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/system-admin/customers");
    }

    private string? BuildPaymentTerms()
    {
        var terms = new System.Text.StringBuilder();
        
        if (!string.IsNullOrWhiteSpace(PaymentTerms))
        {
            terms.Append(PaymentTerms);
        }
        
        // Add payment method information
        if (!string.IsNullOrWhiteSpace(DefaultPaymentMethod))
        {
            if (terms.Length > 0) terms.Append(" | ");
            terms.Append($"Payment Method: {DefaultPaymentMethod}");
            
            // Add credit terms if Credit is selected
            if (DefaultPaymentMethod == "Credit" && CreditMonths > 0 && CreditInterestRate > 0)
            {
                terms.Append($" | Credit Terms: {CreditMonths} months @ {CreditInterestRate}% ({CreditPaymentFrequency})");
                terms.Append($" | Total Interest: ₱{CustomerCreditTotalInterest:N2}");
                terms.Append($" | Total Amount: ₱{CustomerCreditTotalAmount:N2}");
                terms.Append($" | Monthly Payment: ₱{CustomerCreditMonthlyPayment:N2}");
            }
        }
        
        if (!string.IsNullOrWhiteSpace(PaymentReference))
        {
            if (terms.Length > 0) terms.Append(" | ");
            terms.Append($"Reference: {PaymentReference}");
        }
        
        if (!string.IsNullOrWhiteSpace(PaymentNotes))
        {
            if (terms.Length > 0) terms.Append(" | ");
            terms.Append($"Notes: {PaymentNotes}");
        }
        
        return terms.Length > 0 ? terms.ToString() : null;
    }

    private void GeneratePreviewAdminCredentials()
    {
        // Default password is always "Admin123456"
        previewAdminPassword = "Admin123456";

        // Generate username/email based on the same logic as SchoolAdminSeeder
        // Parse contact person name
        string firstName = ContactFirstName;
        string lastName = ContactLastName;

        if (string.IsNullOrWhiteSpace(firstName))
        {
            firstName = "Admin";
        }
        if (string.IsNullOrWhiteSpace(lastName))
        {
            lastName = "User";
        }

        // Generate email if not provided (same logic as SchoolAdminSeeder.GenerateEmail)
        if (!string.IsNullOrWhiteSpace(ContactEmail))
        {
            previewAdminUsername = ContactEmail;
        }
        else
        {
            var cleanSchoolName = System.Text.RegularExpressions.Regex.Replace(SchoolName, @"[^a-zA-Z0-9]", "").ToLower();
            var cleanFirstName = System.Text.RegularExpressions.Regex.Replace(firstName, @"[^a-zA-Z0-9]", "").ToLower();
            var cleanLastName = System.Text.RegularExpressions.Regex.Replace(lastName, @"[^a-zA-Z0-9]", "").ToLower();
            
            previewAdminUsername = $"{cleanFirstName}.{cleanLastName}@{cleanSchoolName}.edu.ph";
        }
    }

}
