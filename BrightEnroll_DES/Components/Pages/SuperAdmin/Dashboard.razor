@page "/system-admin/dashboard"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.Authentication
@using BrightEnroll_DES.Services.Business.SuperAdmin
@using BrightEnroll_DES.Data.Models
@using System
@using System.Threading
@using Microsoft.JSInterop
@implements IAsyncDisposable
@inject IAuthService AuthService
@inject ILoadingService LoadingService
@inject NavigationManager Navigation
@inject IServiceProvider ServiceProvider
@inject BrightEnroll_DES.Services.Business.SuperAdmin.SuperAdminService SuperAdminService
@inject IJSRuntime JSRuntime

<PageTitle>Super Admin Dashboard</PageTitle>

<div class="text-gray-800">
    <div class="mb-8">
        <h1 class="text-xl font-bold text-gray-900">Dashboard</h1>
    </div>

    <!-- Filters Section -->
    <div class="mb-6 rounded-xl border border-gray-200 bg-white p-3 shadow-sm">
        <div class="flex flex-wrap items-end gap-3">
            <!-- Date From -->
            <div class="flex-1 min-w-[140px]">
                <label class="mb-1 block text-xs font-semibold text-gray-700">From Date</label>
                <input type="date" value="@(filterFromDate?.ToString("yyyy-MM-dd") ?? "")" 
                       @onchange="@((ChangeEventArgs e) => { if (DateTime.TryParse(e.Value?.ToString(), out var date)) filterFromDate = date; else filterFromDate = null; })"
                       class="w-full rounded-lg border border-gray-300 px-3 py-1.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-100" />
            </div>
            <!-- Date Until -->
            <div class="flex-1 min-w-[140px]">
                <label class="mb-1 block text-xs font-semibold text-gray-700">Until Date</label>
                <input type="date" value="@(filterUntilDate?.ToString("yyyy-MM-dd") ?? "")" 
                       @onchange="@((ChangeEventArgs e) => { if (DateTime.TryParse(e.Value?.ToString(), out var date)) filterUntilDate = date; else filterUntilDate = null; })"
                       class="w-full rounded-lg border border-gray-300 px-3 py-1.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-100" />
            </div>
            <!-- Status -->
            <div class="flex-1 min-w-[140px]">
                <label class="mb-1 block text-xs font-semibold text-gray-700">Status</label>
                <select @bind="filterStatus" 
                        class="w-full rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-100">
                    <option value="">All</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                    <option value="Pending">Pending</option>
                </select>
            </div>
            <!-- Category -->
            <div class="flex-1 min-w-[140px]">
                <label class="mb-1 block text-xs font-semibold text-gray-700">Category</label>
                <select @bind="filterCategory" 
                        class="w-full rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-100">
                    <option value="">All Categories</option>
                    <option value="Customers">Customers</option>
                    <option value="Subscriptions">Subscriptions</option>
                    <option value="Sales">Sales</option>
                </select>
            </div>
            <!-- Action Buttons -->
            <div class="flex gap-2">
                <button @onclick="ClearFilters" 
                        class="flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-semibold text-gray-700 hover:bg-gray-50 hover:border-gray-400 transition-colors">
                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Clear
                </button>
                <button @onclick="ApplyFilters" 
                        class="flex items-center gap-1.5 rounded-lg bg-blue-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-blue-700 transition-colors shadow-sm">
                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    Apply Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Key Metrics - Standard KPI Cards -->
    <div class="mb-6 grid grid-cols-1 gap-3 sm:grid-cols-2 md:mb-6 md:gap-3 lg:grid-cols-3">
        <!-- Total Customers -->
        <button @onclick="NavigateToCustomers" title="Total number of customers" class="relative cursor-pointer rounded-xl border border-gray-100 bg-white p-4 shadow-sm transition-all duration-200 hover:scale-[1.02] hover:border-blue-300 hover:shadow-md md:p-5 lg:p-6">
            <div class="mb-3 flex items-start gap-3 md:mb-4">
                <div class="rounded-lg bg-blue-100 p-2 transition-colors duration-200 hover:bg-blue-200 md:p-2.5">
                    <svg class="h-4 w-4 text-blue-600 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                </div>
                <div class="flex flex-1 flex-col">
                    <p class="mb-1 text-left text-xs font-semibold text-gray-600 md:text-sm">Total Customers</p>
                    <p class="mb-2 text-left text-[10px] text-gray-500 md:text-xs">@GetYearLabel()</p>
                    <h3 class="mt-1 text-right text-xl font-bold text-gray-800 md:text-2xl">@TotalCustomers.ToString("N0")</h3>
                </div>
            </div>
            <!-- Mini Chart -->
            <svg class="mt-2 h-8 w-full md:h-10" viewBox="0 0 200 50" preserveAspectRatio="none">
                <polyline points="0,40 40,35 80,30 120,25 160,30 200,35" fill="none" stroke="#3b82f6" stroke-width="2" />
            </svg>
        </button>

        <!-- Active Subscriptions -->
        <button @onclick="NavigateToSubscriptions" title="Total number of active subscriptions" class="relative cursor-pointer rounded-xl border border-gray-100 bg-white p-4 shadow-sm transition-all duration-200 hover:scale-[1.02] hover:border-green-300 hover:shadow-md md:p-5 lg:p-6">
            <div class="mb-3 flex items-start gap-3 md:mb-4">
                <div class="rounded-lg bg-green-100 p-2 transition-colors duration-200 hover:bg-green-200 md:p-2.5">
                    <svg class="h-4 w-4 text-green-600 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="flex flex-1 flex-col">
                    <p class="mb-1 text-left text-xs font-semibold text-gray-600 md:text-sm">Active Subscriptions</p>
                    <p class="mb-2 text-left text-[10px] text-gray-500 md:text-xs">@GetYearLabel()</p>
                    <h3 class="mt-1 text-right text-xl font-bold text-gray-800 md:text-2xl">@ActiveSubscriptions.ToString("N0")</h3>
                </div>
            </div>
            <!-- Mini Chart -->
            <svg class="mt-2 h-8 w-full md:h-10" viewBox="0 0 200 50" preserveAspectRatio="none">
                <polyline points="0,45 40,40 80,35 120,30 160,32 200,28" fill="none" stroke="#16a34a" stroke-width="2" />
            </svg>
        </button>

        <!-- Monthly Revenue -->
        <button @onclick="NavigateToSales" title="Monthly revenue collected" class="relative cursor-pointer rounded-xl border border-gray-100 bg-white p-4 shadow-sm transition-all duration-200 hover:scale-[1.02] hover:border-purple-300 hover:shadow-md md:p-5 lg:p-6">
            <div class="mb-3 flex items-start gap-3 md:mb-4">
                <div class="rounded-lg bg-purple-100 p-2 transition-colors duration-200 hover:bg-purple-200 md:p-2.5">
                    <svg class="h-4 w-4 text-purple-600 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="flex flex-1 flex-col">
                    <p class="mb-1 text-left text-xs font-semibold text-gray-600 md:text-sm">Monthly Revenue</p>
                    <p class="mb-2 text-left text-[10px] text-gray-500 md:text-xs">@GetYearLabel()</p>
                    <h3 class="mt-1 text-right text-xl font-bold text-gray-800 md:text-2xl">₱@MonthlyRevenue.ToString("N0")</h3>
                </div>
            </div>
            <!-- Mini Chart -->
            <svg class="mt-2 h-8 w-full md:h-10" viewBox="0 0 200 50" preserveAspectRatio="none">
                <polyline points="0,35 40,30 80,28 120,32 160,29 200,33" fill="none" stroke="#9333ea" stroke-width="2" />
            </svg>
        </button>
    </div>

    <!-- Charts Row -->
    <div class="mb-8 grid grid-cols-1 gap-6 lg:grid-cols-2">
        <!-- Revenue Trend Chart -->
        <div class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
            <div class="mb-5 flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-900">Revenue Trend (Last 6 Months)</h2>
                <button @onclick="NavigateToSales" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors">View Details</button>
            </div>
            <div class="h-72">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Sales by Plan Chart -->
        <div class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
            <div class="mb-5 flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-900">Sales by Subscription Plan</h2>
                <button @onclick="NavigateToSubscriptions" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors">View Details</button>
            </div>
            <div class="h-72">
                <canvas id="salesPlanChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Activities -->
<div class="grid grid-cols-1 gap-6 lg:grid-cols-2 mb-8">
    <!-- Recent Sales -->
        <div class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
            <div class="mb-5 flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-900">Recent Sales</h2>
                <button @onclick="NavigateToSales" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors">View All</button>
        </div>
        <div class="space-y-3">
                @if (RecentSales.Any())
                {
            @foreach (var sale in RecentSales)
            {
                        <div class="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 p-4 transition-all hover:bg-gray-100 hover:border-gray-300 hover:shadow-sm">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <svg class="h-5 w-5 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm font-semibold text-gray-900">@sale.SchoolName</h3>
                                    <p class="text-xs text-gray-600 mt-0.5">@sale.Plan - @sale.Date.ToString("MMM dd, yyyy")</p>
                                </div>
                            </div>
                            <div class="text-right ml-4 flex-shrink-0">
                                <p class="text-base font-bold text-green-600 tracking-tight">₱@sale.Amount.ToString("N0")</p>
                                <span class="inline-flex rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800 mt-1">Converted</span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="py-12 text-center text-gray-400">
                        <svg class="mx-auto mb-3 h-16 w-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                        <p class="text-base font-medium text-gray-600">No recent sales</p>
                </div>
            }
        </div>
    </div>

    <!-- Expiring Subscriptions -->
        <div class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
            <div class="mb-5 flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-900">Expiring Soon</h2>
                <button @onclick="NavigateToSubscriptions" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors">View All</button>
        </div>
        <div class="space-y-3">
                @if (ExpiringSoon.Any())
                {
            @foreach (var subscription in ExpiringSoon)
            {
                        <div class="flex items-center justify-between rounded-lg border border-orange-200 bg-orange-50 p-4 transition-all hover:bg-orange-100 hover:border-orange-300">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <svg class="h-5 w-5 text-orange-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm font-semibold text-gray-900">@subscription.SchoolName</h3>
                                    <p class="text-xs text-gray-700 mt-0.5">Expires: @subscription.ExpiryDate.ToString("MMM dd, yyyy")</p>
                                </div>
                            </div>
                            <button class="ml-4 rounded-lg bg-orange-600 px-4 py-2 text-sm font-semibold text-white hover:bg-orange-700 transition-colors flex-shrink-0 shadow-sm">
                                Renew
                            </button>
                        </div>
            }
                }
                else
                {
                    <div class="py-12 text-center text-gray-400">
                        <svg class="mx-auto mb-3 h-16 w-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-base font-medium text-gray-600">No expiring subscriptions</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Markup/Footer -->
    <div class="mt-8 flex items-center justify-start">
        <p class="text-sm font-medium text-gray-500">
            © @DateTime.Now.Year BrightEnroll. All rights reserved.
        </p>
    </div>
</div>

@code {
    private int TotalCustomers { get; set; }
    private int ActiveSubscriptions { get; set; }
    private decimal MonthlyRevenue { get; set; }
    private int OpenTickets { get; set; }
    private int CustomerGrowth { get; set; }
    private int RetentionRate { get; set; }
    private int RevenueGrowth { get; set; }
    private int HighPriorityTickets { get; set; }
    private decimal TotalSales { get; set; }
    private int TotalConversions { get; set; }
    private decimal ConversionRate { get; set; }
    private decimal AverageDealSize { get; set; }
    private int ActiveLeads { get; set; }
    private int SalesGrowth { get; set; }

    private List<RecentSale> RecentSales { get; set; } = new();
    private List<ExpiringSubscription> ExpiringSoon { get; set; } = new();

    // Filter properties
    private DateTime? filterFromDate { get; set; }
    private DateTime? filterUntilDate { get; set; }
    private string filterStatus { get; set; } = string.Empty;
    private string filterCategory { get; set; } = string.Empty;

    protected override void OnInitialized()
    {
        // Initialize with zero values - real data will be loaded in OnAfterRenderAsync
        TotalCustomers = 0;
        ActiveSubscriptions = 0;
        MonthlyRevenue = 0;
    }

    private bool _dataLoaded = false;
    private bool _isLoading = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _dataLoaded || _isLoading) return;
        _isLoading = true;

        try
        {
            // Wait a bit for auth state and services to be ready
            await Task.Delay(500);
            
            // Check if user is Super Admin (handle both "Super Admin" and "SuperAdmin")
            var currentUser = AuthService?.CurrentUser;
            var userRole = currentUser?.user_role;
            var isSuperAdmin = !string.IsNullOrWhiteSpace(userRole) && 
                              (userRole.Equals("Super Admin", StringComparison.OrdinalIgnoreCase) ||
                               userRole.Replace(" ", "").Equals("SuperAdmin", StringComparison.OrdinalIgnoreCase));
            
            if (!isSuperAdmin)
            {
                Navigation.NavigateTo("/dashboard", forceLoad: true);
                _isLoading = false;
                return;
            }

            // Check if service is available
            if (SuperAdminService != null)
            {
                try
                {
                    await LoadDashboardData(SuperAdminService);
                }
                catch
                {
                    // If loading fails, keep mock data
                }
            }

            // Render charts after data is loaded
            await Task.Delay(300);
            await RenderCharts();
            
                _dataLoaded = true;
                StateHasChanged();
            }
            catch (Exception ex)
            {
            System.Diagnostics.Debug.WriteLine($"[SuperAdmin Dashboard] Error: {ex.Message}");
            }
            finally
            {
                _isLoading = false;
            }
        }


    private async Task LoadDashboardData(SuperAdminService service)
    {
        if (service == null) return;

        try
        {
            // Apply date filters if set
            DateTime? fromDate = filterFromDate;
            DateTime? untilDate = filterUntilDate;

            // Load dashboard statistics
            var stats = await service.GetDashboardStatsAsync();
            
            // Update metrics with real data
            TotalCustomers = stats.TotalCustomers;
            ActiveSubscriptions = stats.ActiveSubscriptions;
            MonthlyRevenue = stats.MonthlyRevenue;
            OpenTickets = stats.OpenTickets;

            // Load recent payments (actual sales)
            var recentPayments = await service.GetRecentPaymentsAsync(5);
            if (recentPayments.Any())
            {
                RecentSales = recentPayments.Select(p => new RecentSale
                {
                    SchoolName = p.Customer?.SchoolName ?? "Unknown",
                    Plan = p.Customer?.SubscriptionPlan ?? "Custom",
                    Amount = p.Amount,
                    Date = p.PaymentDate
                }).ToList();
            }
            else
            {
                // Fallback to recent customers if no payments
                var recentCustomers = await service.GetAllCustomersAsync();
                var recentConvertedCustomers = recentCustomers
                    .Where(c => c.Status == "Active" && c.ContractStartDate.HasValue)
                    .OrderByDescending(c => c.ContractStartDate)
                    .Take(5)
                    .ToList();

                if (recentConvertedCustomers.Any())
                {
                    RecentSales = recentConvertedCustomers.Select(c => new RecentSale
                    {
                        SchoolName = c.SchoolName,
                        Plan = c.SubscriptionPlan ?? "Custom",
                        Amount = c.MonthlyFee,
                        Date = c.ContractStartDate ?? c.DateRegistered
                    }).ToList();
                }
            }

            // Load expiring subscriptions
            var expiringCustomers = await service.GetExpiringSubscriptionsAsync(30);
            if (expiringCustomers.Any())
            {
                ExpiringSoon = expiringCustomers
                    .Where(c => c.ContractEndDate.HasValue)
                    .Select(c => new ExpiringSubscription
                    {
                        SchoolName = c.SchoolName,
                        ExpiryDate = c.ContractEndDate ?? DateTime.Now
                    })
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[SuperAdmin Dashboard] Error loading data: {ex.Message}");
            // Keep mock data on error
        }
    }

    private async Task RenderCharts()
    {
        try
        {
            if (SuperAdminService == null) return;

            // Revenue Trend Chart (Line Chart) - Last 6 months
            var revenueTrend = await SuperAdminService.GetRevenueTrendAsync(6);
            var revenueLabels = revenueTrend.Keys.ToArray();
            var revenueData = revenueTrend.Values.Select(v => (double)v).ToArray();
            
            // If no data, use default labels for current month and previous 5
            if (revenueLabels.Length == 0)
            {
                revenueLabels = new string[6];
                revenueData = new double[6];
                for (int i = 5; i >= 0; i--)
                {
                    var monthDate = DateTime.Now.AddMonths(-i);
                    revenueLabels[5 - i] = monthDate.ToString("MMM");
                    revenueData[5 - i] = 0;
                }
            }
            
            var revenueDatasets = new[]
            {
                new
                {
                    label = "Monthly Revenue",
                    data = revenueData,
                    borderColor = "#8b5cf6",
                    backgroundColor = "rgba(139, 92, 246, 0.1)",
                    tension = 0.4
                }
            };

            await JSRuntime.InvokeVoidAsync("dashboardCharts.renderLineChart", 
                "revenueChart", 
                revenueLabels, 
                revenueDatasets, 
                new { isCurrency = true, showLegend = false });

            // Sales by Plan Chart (Doughnut Chart)
            var salesByPlan = await SuperAdminService.GetSalesByPlanAsync();
            var planLabels = salesByPlan.Keys.ToArray();
            var planData = salesByPlan.Values.Select(v => (double)v).ToArray();
            
            // Default colors for common plans
            var colorMap = new Dictionary<string, string>
            {
                { "Premium", "#8b5cf6" },
                { "Standard", "#3b82f6" },
                { "Basic", "#10b981" },
                { "Custom", "#f59e0b" }
            };
            
            var planColors = planLabels.Select(label => 
                colorMap.ContainsKey(label) ? colorMap[label] : "#6b7280"
            ).ToArray();

            // If no data, use defaults
            if (planLabels.Length == 0)
            {
                planLabels = new[] { "No Data" };
                planData = new[] { 0.0 };
                planColors = new[] { "#6b7280" };
            }

            await JSRuntime.InvokeVoidAsync("dashboardCharts.renderPieChart",
                "salesPlanChart",
                planLabels,
                planData,
                planColors,
                true); // isDoughnut
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[SuperAdmin Dashboard] Error rendering charts: {ex.Message}");
        }
    }

    private string GetAdminNameSafe()
    {
        try
        {
            if (AuthService == null) return "System Admin";
            
            var user = AuthService.CurrentUser;
            if (user == null) return "System Admin";
            
            var firstName = user.first_name ?? string.Empty;
            var lastName = user.last_name ?? string.Empty;
            
            if (string.IsNullOrWhiteSpace(firstName) && string.IsNullOrWhiteSpace(lastName))
            {
                return "System Admin";
            }
            
            return $"{firstName} {lastName}".Trim();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[SuperAdmin Dashboard] Error in GetAdminNameSafe: {ex.Message}");
            return "System Admin";
        }
    }

    private async Task ApplyFilters()
    {
        try
        {
            // Validate date range
            if (filterFromDate.HasValue && filterUntilDate.HasValue)
            {
                if (filterFromDate.Value > filterUntilDate.Value)
                {
                    await JSRuntime.InvokeVoidAsync("alert", "From date cannot be after Until date");
                    return;
                }
            }

            // Reload dashboard data with filters applied
            if (SuperAdminService != null)
            {
                await LoadDashboardData(SuperAdminService);
                await RenderCharts();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[SuperAdmin Dashboard] Error applying filters: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error applying filters: {ex.Message}");
        }
    }

    private async Task ClearFilters()
    {
        filterFromDate = null;
        filterUntilDate = null;
        filterStatus = string.Empty;
        filterCategory = string.Empty;
        
        // Reload dashboard data without filters
        if (SuperAdminService != null)
        {
            await LoadDashboardData(SuperAdminService);
            await RenderCharts();
            StateHasChanged();
        }
    }

    private void NavigateToCustomers() => Navigation.NavigateTo("/system-admin/customers");
    private void NavigateToSales() => Navigation.NavigateTo("/system-admin/sales");
    private void NavigateToSubscriptions() => Navigation.NavigateTo("/system-admin/subscriptions");
    private void NavigateToUpdates() => Navigation.NavigateTo("/system-admin/updates");

    private string GetYearLabel()
    {
        var now = DateTime.Now;
        var currentYear = now.Year;
        
        // If no filters are set, show current year with "All year"
        if (!filterFromDate.HasValue && !filterUntilDate.HasValue)
        {
            return $"Year: All year";
        }
        
        // If only from date is set
        if (filterFromDate.HasValue && !filterUntilDate.HasValue)
        {
            var fromYear = filterFromDate.Value.Year;
            return $"Year: {fromYear}";
        }
        
        // If only until date is set
        if (!filterFromDate.HasValue && filterUntilDate.HasValue)
        {
            var untilYear = filterUntilDate.Value.Year;
            return $"Year: {untilYear}";
        }
        
        // Both dates are set
        if (filterFromDate.HasValue && filterUntilDate.HasValue)
        {
            var fromYearValue = filterFromDate.Value.Year;
            var untilYearValue = filterUntilDate.Value.Year;
            
            // Same year
            if (fromYearValue == untilYearValue)
            {
                // Check if it's the full year (Jan 1 to Dec 31)
                if (filterFromDate.Value.Month == 1 && filterFromDate.Value.Day == 1 &&
                    filterUntilDate.Value.Month == 12 && filterUntilDate.Value.Day == 31)
                {
                    return $"Year: All year";
                }
                
                return $"Year: {fromYearValue}";
            }
            
            // Different years - show range
            return $"Year: {fromYearValue} - {untilYearValue}";
        }
        
        return "Year: All year";
    }

    public class RecentSale
    {
        public string SchoolName { get; set; } = string.Empty;
        public string Plan { get; set; } = string.Empty;
        public decimal Amount { get; set; }
        public DateTime Date { get; set; }
    }

    public class ExpiringSubscription
    {
        public string SchoolName { get; set; } = string.Empty;
        public DateTime ExpiryDate { get; set; }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("dashboardCharts.destroyChart", "revenueChart");
            await JSRuntime.InvokeVoidAsync("dashboardCharts.destroyChart", "salesPlanChart");
        }
        catch
        {
            // Ignore errors during disposal
        }
    }
}
