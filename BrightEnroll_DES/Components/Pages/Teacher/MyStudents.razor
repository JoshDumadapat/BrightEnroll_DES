@page "/teacher/my-students"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.AuthFunction
@inject IAuthService AuthService
@inject ILoadingService LoadingService
@inject NavigationManager Navigation
@inject ClassAssignmentService ClassAssignmentService

<PageTitle>My Students</PageTitle>

<div class="text-gray-800">
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">My Students</h1>
            <p class="mt-1 text-sm text-gray-600">View and manage students in your classes</p>
        </div>
        <button @onclick="GoBack" class="flex items-center gap-2 rounded-full bg-gray-600 px-4 py-2 text-sm font-medium text-white shadow-md transition-all duration-300 hover:bg-gray-700 hover:shadow-lg">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back
        </button>
    </div>
</div>

<!-- Filter Section -->
<div class="mb-6 rounded-xl border border-gray-100 bg-white p-4 shadow-sm">
    <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Class</label>
            <select @bind="SelectedClass" @bind:after="OnClassChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400">
                <option value="">All Classes</option>
                @foreach (var cls in Classes)
                {
                    <option value="@cls">@cls</option>
                }
            </select>
        </div>
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Subject</label>
            <select @bind="SelectedSubject" @bind:after="OnSubjectChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400">
                <option value="">All Subjects</option>
                @foreach (var subject in Subjects)
                {
                    <option value="@subject">@subject</option>
                }
            </select>
        </div>
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Search Student</label>
            <input type="text" @bind="SearchTerm" @bind:event="oninput" @bind:after="OnSearchChanged" placeholder="Search by name or ID..." class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400" />
        </div>
    </div>
</div>

<!-- Students Table -->
<div class="rounded-xl border border-gray-100 bg-white shadow-sm">
    <div class="border-b border-gray-200 p-6">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold text-gray-800">Student List</h2>
            <span class="text-sm text-gray-600">Total: @FilteredStudents.Count students</span>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">Student ID</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">Full Name</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">Grade & Section</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">Contact</th>
                    <th class="px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-600">Average</th>
                    <th class="px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-600">Status</th>
                    <th class="px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-600">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white">
                @foreach (var student in FilteredStudents)
                {
                    <tr class="hover:bg-gray-50">
                        <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-gray-800">@student.StudentId</td>
                        <td class="whitespace-nowrap px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="flex h-10 w-10 items-center justify-center rounded-full bg-blue-100 text-sm font-semibold text-blue-600">
                                    @GetInitials(student.Name)
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-800">@student.Name</p>
                                    <p class="text-xs text-gray-500">@student.Email</p>
                                </div>
                            </div>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-600">@student.GradeLevel - @student.Section</td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-600">@student.ContactNumber</td>
                        <td class="whitespace-nowrap px-6 py-4 text-center">
                            <span class="inline-flex rounded-full px-3 py-1 text-sm font-semibold @GetAverageClass(student.Average)">
                                @student.Average.ToString("F2")
                            </span>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-center">
                            <span class="inline-flex rounded-full px-3 py-1 text-xs font-medium @GetStatusClass(student.Status)">
                                @student.Status
                            </span>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-center">
                            <button @onclick="() => ViewStudentDetails(student.StudentId)" class="text-blue-600 hover:text-blue-800">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (!FilteredStudents.Any())
    {
        <div class="py-12 text-center text-gray-500">
            <svg class="mx-auto mb-4 h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <p>No students found</p>
        </div>
    }
</div>

@code {
    private string SelectedClass { get; set; } = string.Empty;
    private string SelectedSubject { get; set; } = string.Empty;
    private string SearchTerm { get; set; } = string.Empty;

    private List<string> Classes { get; set; } = new();
    private List<string> Subjects { get; set; } = new();
    private List<StudentInfo> Students { get; set; } = new();
    private List<StudentInfo> FilteredStudents { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // Check if user is a teacher
        if (AuthService.CurrentUser?.user_role != "Teacher")
        {
            Navigation.NavigateTo("/dashboard");
            return;
        }

        LoadingService.ShowLoading("Loading students...");
        
        try
        {
            await LoadStudents();
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private async Task LoadStudents()
    {
        try
        {
            var teacherId = AuthService.CurrentUser?.user_ID;
            if (!teacherId.HasValue)
            {
                Students = new List<StudentInfo>();
                FilteredStudents = Students;
                return;
            }

            // Load classes and subjects from database
            Classes = await ClassAssignmentService.GetTeacherClassesAsync(teacherId.Value);
            Subjects = await ClassAssignmentService.GetTeacherSubjectsAsync(teacherId.Value);

            // Parse selected class to get grade level and section
            string? gradeLevel = null;
            string? section = null;
            if (!string.IsNullOrEmpty(SelectedClass))
            {
                var parts = SelectedClass.Split(new[] { " - " }, StringSplitOptions.RemoveEmptyEntries);
                if (parts.Length >= 1)
                    gradeLevel = parts[0].Trim();
                if (parts.Length >= 2)
                {
                    var sectionPart = parts[1].Trim();
                    if (sectionPart != "N/A")
                        section = sectionPart;
                }
            }

            // Load students from database
            var students = await ClassAssignmentService.GetTeacherStudentsAsync(
                teacherId.Value,
                gradeLevel: gradeLevel,
                section: section,
                subject: string.IsNullOrEmpty(SelectedSubject) ? null : SelectedSubject);

            // Convert to StudentInfo
            Students = students.Select(s => new StudentInfo
            {
                StudentId = s.StudentId,
                Name = s.Name,
                Email = s.Email,
                GradeLevel = s.GradeLevel,
                Section = s.Section,
                ContactNumber = s.ContactNumber,
                Average = s.Average,
                Status = s.Status
            }).ToList();

            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading students: {ex.Message}");
            Students = new List<StudentInfo>();
            FilteredStudents = Students;
        }
    }

    private async Task OnClassChanged()
    {
        LoadingService.ShowLoading("Loading students...");
        try
        {
            await LoadStudents();
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private async Task OnSubjectChanged()
    {
        LoadingService.ShowLoading("Loading students...");
        try
        {
            await LoadStudents();
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private void OnSearchChanged()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        FilteredStudents = Students.Where(s =>
        {
            bool matchesClass = string.IsNullOrEmpty(SelectedClass) || 
                $"{s.GradeLevel} - {s.Section}" == SelectedClass;
            
            bool matchesSubject = string.IsNullOrEmpty(SelectedSubject);
            // Subject filtering is done at database level in LoadStudents
            
            bool matchesSearch = string.IsNullOrEmpty(SearchTerm) ||
                s.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                s.StudentId.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase);

            return matchesClass && matchesSubject && matchesSearch;
        }).ToList();
    }

    private string GetInitials(string name)
    {
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
        }
        return parts.Length > 0 ? parts[0][0].ToString().ToUpper() : "?";
    }

    private string GetAverageClass(double average)
    {
        if (average >= 90) return "bg-green-100 text-green-800";
        if (average >= 85) return "bg-blue-100 text-blue-800";
        if (average >= 75) return "bg-yellow-100 text-yellow-800";
        return "bg-red-100 text-red-800";
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "active" => "bg-green-100 text-green-800",
            "inactive" => "bg-gray-100 text-gray-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private void ViewStudentDetails(string studentId)
    {
        // TODO: Navigate to student details page
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/teacher/dashboard");
    }

    public class StudentInfo
    {
        public string StudentId { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string GradeLevel { get; set; } = string.Empty;
        public string Section { get; set; } = string.Empty;
        public string ContactNumber { get; set; } = string.Empty;
        public double Average { get; set; }
        public string Status { get; set; } = string.Empty;
    }
}
