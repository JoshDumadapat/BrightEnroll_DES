@page "/teacher/grade-entry"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.AuthFunction
@using BrightEnroll_DES.Data.Models
@inject IAuthService AuthService
@inject ILoadingService LoadingService
@inject NavigationManager Navigation
@inject ClassService ClassService
@inject GradeService GradeService

<PageTitle>Grade Entry</PageTitle>

<div class="text-gray-800">
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Grade Entry</h1>
            <p class="mt-1 text-sm text-gray-600">Input and manage final grades for your students</p>
        </div>
        <button @onclick="GoBack" class="flex items-center gap-2 rounded-full bg-gray-600 px-4 py-2 text-sm font-medium text-white shadow-md transition-all duration-300 hover:bg-gray-700 hover:shadow-lg">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back
        </button>
    </div>
</div>

<!-- Filter Section -->
<div class="mb-6 rounded-xl border border-gray-100 bg-white p-6 shadow-sm">
    <h2 class="mb-4 text-lg font-bold text-gray-800">Select Class</h2>
    <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">School Year</label>
            <select @bind="SelectedSchoolYear" @bind:after="LoadClassData" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400">
                <option value="">Select School Year</option>
                @foreach (var year in AvailableSchoolYears)
                {
                    <option value="@year">@year</option>
                }
            </select>
        </div>
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Grade Level & Section</label>
            <select @bind="SelectedClass" @bind:after="LoadStudents" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400">
                <option value="">Select Class</option>
                @foreach (var cls in Classes)
                {
                    <option value="@cls.Id">@cls.Name</option>
                }
            </select>
        </div>
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Subject</label>
            <select @bind="SelectedSubject" @bind:after="LoadStudents" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400">
                <option value="">Select Subject</option>
                @foreach (var subject in Subjects)
                {
                    <option value="@subject">@subject</option>
                }
            </select>
        </div>
    </div>
</div>

<!-- Grade Entry Table -->
@if (!string.IsNullOrEmpty(SelectedClass) && !string.IsNullOrEmpty(SelectedSubject))
{
    <div class="rounded-xl border border-gray-100 bg-white shadow-sm">
        <div class="border-b border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Student Grades - @GetSelectedClassName()</h2>
                    <p class="mt-1 text-sm text-gray-600">Subject: @SelectedSubject</p>
                </div>
                <button @onclick="SaveAllGrades" class="flex items-center gap-2 rounded-full bg-blue-600 px-6 py-2.5 text-sm font-semibold text-white shadow-md transition-all duration-300 hover:bg-blue-700 hover:shadow-lg">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                    Save All Grades
                </button>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">Student ID</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">Student Name</th>
                        <th class="px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-600">1st Quarter</th>
                        <th class="px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-600">2nd Quarter</th>
                        <th class="px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-600">3rd Quarter</th>
                        <th class="px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-600">4th Quarter</th>
                        <th class="px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-600">Final Grade</th>
                        <th class="px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-600">Remarks</th>
                        <th class="px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-600">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                    @foreach (var student in Students)
                    {
                        <tr class="hover:bg-gray-50">
                            <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-gray-800">@student.StudentId</td>
                            <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-800">@student.Name</td>
                            <td class="px-6 py-4">
                                <input type="number" @bind="student.FirstQuarter" @bind:event="onchange" min="0" max="100" step="0.01" class="w-20 rounded border border-gray-300 px-2 py-1 text-center text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400" />
                            </td>
                            <td class="px-6 py-4">
                                <input type="number" @bind="student.SecondQuarter" @bind:event="onchange" min="0" max="100" step="0.01" class="w-20 rounded border border-gray-300 px-2 py-1 text-center text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400" />
                            </td>
                            <td class="px-6 py-4">
                                <input type="number" @bind="student.ThirdQuarter" @bind:event="onchange" min="0" max="100" step="0.01" class="w-20 rounded border border-gray-300 px-2 py-1 text-center text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400" />
                            </td>
                            <td class="px-6 py-4">
                                <input type="number" @bind="student.FourthQuarter" @bind:event="onchange" min="0" max="100" step="0.01" class="w-20 rounded border border-gray-300 px-2 py-1 text-center text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400" />
                            </td>
                            <td class="whitespace-nowrap px-6 py-4 text-center text-sm font-semibold text-gray-800">
                                @CalculateFinalGrade(student)
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="inline-flex rounded-full px-3 py-1 text-xs font-medium @GetRemarksClass(student)">
                                    @GetRemarks(student)
                                </span>
                            </td>
                            <td class="whitespace-nowrap px-6 py-4 text-center">
                                <button @onclick="() => SaveStudentGrade(student)" class="rounded-full bg-green-600 px-3 py-1 text-xs font-medium text-white transition-colors hover:bg-green-700">
                                    Save
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (!Students.Any())
        {
            <div class="py-12 text-center text-gray-500">
                <svg class="mx-auto mb-4 h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
                <p>No students found for this class</p>
            </div>
        }
    </div>
}
else
{
    <div class="rounded-xl border border-gray-100 bg-white p-12 text-center shadow-sm">
        <svg class="mx-auto mb-4 h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
        </svg>
        <p class="text-gray-500">Please select school year, class, and subject to begin entering grades</p>
    </div>
}

@code {
    private string SelectedSchoolYear { get; set; } = string.Empty;
    private string SelectedClass { get; set; } = string.Empty;
    private string SelectedSubject { get; set; } = string.Empty;

    private List<string> AvailableSchoolYears { get; set; } = new();
    private List<ClassItem> Classes { get; set; } = new();
    private List<string> Subjects { get; set; } = new();
    private List<StudentGradeDto> Students { get; set; } = new();
    private string? SelectedGradeLevel { get; set; }
    private string? SelectedSection { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Check if user is a teacher
        if (AuthService.CurrentUser?.user_role != "Teacher")
        {
            Navigation.NavigateTo("/dashboard");
            return;
        }

        // Load initial data
        await LoadClassData();
    }

    private async Task LoadClassData()
    {
        var currentUser = AuthService.CurrentUser;
        if (currentUser == null)
        {
            return;
        }

        try
        {
            // Load classes for the teacher filtered by school year
            var teacherClasses = await ClassService.GetClassesByTeacherIdFilteredAsync(
                currentUser.user_ID,
                SelectedSchoolYear,
                null
            );

            // Populate Classes dropdown
            Classes = teacherClasses
                .Select(c => new ClassItem
                {
                    Id = c.ClassId.ToString(),
                    Name = $"{c.GradeLevel} - {c.Section}"
                })
                .OrderBy(c => c.Name)
                .ToList();

            // Populate Subjects dropdown from teacher's classes
            Subjects = teacherClasses
                .Select(c => c.Subject)
                .Distinct()
                .OrderBy(s => s)
                .ToList();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading class data: {ex.Message}");
            Classes = new List<ClassItem>();
            Subjects = new List<string>();
        }
    }

    private async Task LoadClassData()
    {
        if (string.IsNullOrEmpty(SelectedSchoolYear))
        {
            Classes.Clear();
            return;
        }

        LoadingService.ShowLoading("Loading classes...");
        try
        {
            // Get available grade levels for the selected school year
            var gradeLevels = await GradeService.GetAvailableGradeLevelsAsync(SelectedSchoolYear);
            
            // Build class list from grade levels
            // Note: Sections would need to come from a separate table or be parsed from student data
            Classes = gradeLevels.Select(gl => new ClassItem 
            { 
                Id = gl, 
                Name = $"Grade {gl}" 
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading classes: {ex.Message}");
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private async Task LoadStudents()
    {
        if (string.IsNullOrEmpty(SelectedClass) || string.IsNullOrEmpty(SelectedSubject) || string.IsNullOrEmpty(SelectedSchoolYear))
        {
            Students.Clear();
            return;
        }

        LoadingService.ShowLoading("Loading students...");
        
        try
        {
            var classId = int.Parse(SelectedClass);
            
            // Get existing grades for students in this class
            var existingGrades = await GradeService.GetGradesByClassAndSchoolYearAsync(classId, SelectedSchoolYear);
            
            // Get students without grades
            var studentsWithoutGrades = await GradeService.GetStudentsWithoutGradesAsync(classId, SelectedSchoolYear);

            // Combine existing grades and students without grades
            Students = existingGrades.Select(g => new StudentGrade
            {
                GradeId = g.GradeId,
                StudentId = g.StudentId,
                Name = g.StudentName,
                FirstQuarter = g.FirstQuarter,
                SecondQuarter = g.SecondQuarter,
                ThirdQuarter = g.ThirdQuarter,
                FourthQuarter = g.FourthQuarter,
                FinalGrade = g.FinalGrade,
                Remarks = g.Remarks
            }).ToList();

            // Add students without grades
            Students.AddRange(studentsWithoutGrades.Select(s => new StudentGrade
            {
                GradeId = 0,
                StudentId = s.StudentId,
                Name = s.StudentName,
                FirstQuarter = null,
                SecondQuarter = null,
                ThirdQuarter = null,
                FourthQuarter = null
            }));

            // Sort by student name
            Students = Students.OrderBy(s => s.Name).ToList();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading students: {ex.Message}");
            Students = new List<StudentGrade>();
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private string GetSelectedClassName()
    {
        if (string.IsNullOrEmpty(SelectedClass))
            return "";
        
        var className = Classes.FirstOrDefault(c => c.Id == SelectedClass)?.Name;
        if (!string.IsNullOrEmpty(className))
            return className;
        
        // Fallback: return the grade level directly
        return $"Grade {SelectedClass}";
    }

    private string CalculateFinalGrade(StudentGrade student)
    {
        // Use saved final grade if available, otherwise calculate from quarters
        if (student.FinalGrade.HasValue)
        {
            return student.FinalGrade.Value.ToString("F2");
        }

        var grades = new[] { student.FirstQuarter, student.SecondQuarter, student.ThirdQuarter, student.FourthQuarter }
            .Where(g => g.HasValue)
            .Select(g => (double)g!.Value)
            .ToList();

        if (!grades.Any()) return "-";

        var average = grades.Average();
        return average.ToString("F2");
    }

    private string GetRemarks(StudentGrade student)
    {
        // Use saved remarks if available
        if (!string.IsNullOrEmpty(student.Remarks))
        {
            return student.Remarks;
        }

        var finalGrade = CalculateFinalGrade(student);
        if (finalGrade == "-") return "INCOMPLETE";

        var grade = double.Parse(finalGrade);
        return grade >= 75 ? "PASSED" : "FAILED";
    }

    private string GetRemarksClass(StudentGradeDto student)
    {
        var remarks = GetRemarks(student);
        return remarks switch
        {
            "PASSED" => "bg-green-100 text-green-800",
            "FAILED" => "bg-red-100 text-red-800",
            _ => "bg-yellow-100 text-yellow-800"
        };
    }

    private async Task SaveStudentGrade(StudentGrade student)
    {
        if (string.IsNullOrEmpty(SelectedClass) || string.IsNullOrEmpty(SelectedSchoolYear))
        {
            return;
        }

        LoadingService.ShowLoading("Saving grade...");
        
        try
        {
            var currentUser = AuthService.CurrentUser;
            var classId = int.Parse(SelectedClass);
            
            var grade = new Grade
            {
                GradeId = student.GradeId,
                ClassId = classId,
                StudentId = student.StudentId,
                SchoolYear = SelectedSchoolYear,
                FirstQuarter = student.FirstQuarter.HasValue ? (decimal?)student.FirstQuarter.Value : null,
                SecondQuarter = student.SecondQuarter.HasValue ? (decimal?)student.SecondQuarter.Value : null,
                ThirdQuarter = student.ThirdQuarter.HasValue ? (decimal?)student.ThirdQuarter.Value : null,
                FourthQuarter = student.FourthQuarter.HasValue ? (decimal?)student.FourthQuarter.Value : null
            };

            await GradeService.SaveGradeAsync(grade, currentUser?.system_ID, currentUser?.system_ID);
            
            // Update the student's GradeId if it was a new grade
            if (student.GradeId == 0)
            {
                var savedGrade = await GradeService.GetGradeByClassStudentAndYearAsync(classId, student.StudentId, SelectedSchoolYear);
                if (savedGrade != null)
                {
                    student.GradeId = savedGrade.GradeId;
                }
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error saving grade: {ex.Message}");
            // In production, show error message to user
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving grade: {ex.Message}");
            // Show error message to user
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private async Task SaveAllGrades()
    {
        if (string.IsNullOrEmpty(SelectedClass) || string.IsNullOrEmpty(SelectedSchoolYear))
        {
            return;
        }

        LoadingService.ShowLoading("Saving all grades...");
        
        try
        {
            var currentUser = AuthService.CurrentUser;
            var classId = int.Parse(SelectedClass);
            
            var grades = Students.Select(s => new Grade
            {
                GradeId = s.GradeId,
                ClassId = classId,
                StudentId = s.StudentId,
                SchoolYear = SelectedSchoolYear,
                FirstQuarter = s.FirstQuarter.HasValue ? (decimal?)s.FirstQuarter.Value : null,
                SecondQuarter = s.SecondQuarter.HasValue ? (decimal?)s.SecondQuarter.Value : null,
                ThirdQuarter = s.ThirdQuarter.HasValue ? (decimal?)s.ThirdQuarter.Value : null,
                FourthQuarter = s.FourthQuarter.HasValue ? (decimal?)s.FourthQuarter.Value : null
            }).ToList();

            var savedGrades = await GradeService.SaveGradesAsync(grades, currentUser?.system_ID, currentUser?.system_ID);
            
            // Update GradeIds for new grades
            foreach (var student in Students)
            {
                if (student.GradeId == 0)
                {
                    var savedGrade = savedGrades.FirstOrDefault(g => 
                        g.StudentId == student.StudentId && 
                        g.ClassId == classId && 
                        g.SchoolYear == SelectedSchoolYear);
                    if (savedGrade != null)
                    {
                        student.GradeId = savedGrade.GradeId;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error saving all grades: {ex.Message}");
            // In production, show error message to user
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving grades: {ex.Message}");
            // Show error message to user
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/teacher/dashboard");
    }

    public class ClassItem
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
    }

    public class StudentGrade
    {
        public int GradeId { get; set; }
        public string StudentId { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public double? FirstQuarter { get; set; }
        public double? SecondQuarter { get; set; }
        public double? ThirdQuarter { get; set; }
        public double? FourthQuarter { get; set; }
        public double? FinalGrade { get; set; }
        public string Remarks { get; set; } = string.Empty;
    }
}
