@page "/teacher/my-schedule"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.AuthFunction
@inject IAuthService AuthService
@inject ILoadingService LoadingService
@inject NavigationManager Navigation

<PageTitle>My Schedule</PageTitle>

<div class="text-gray-800">
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">My Schedule</h1>
            <p class="mt-1 text-sm text-gray-600">View your weekly teaching schedule</p>
        </div>
        <button @onclick="GoBack" class="flex items-center gap-2 rounded-full bg-gray-600 px-4 py-2 text-sm font-medium text-white shadow-md transition-all duration-300 hover:bg-gray-700 hover:shadow-lg">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back
        </button>
    </div>
</div>

<!-- Week Selector -->
<div class="mb-6 flex items-center justify-between rounded-xl border border-gray-100 bg-white p-4 shadow-sm">
    <button @onclick="PreviousWeek" class="flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Previous
    </button>
    <div class="text-center">
        <p class="text-sm text-gray-600">Current Week</p>
        <p class="text-lg font-semibold text-gray-800">@GetWeekRange()</p>
    </div>
    <button @onclick="NextWeek" class="flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100">
        Next
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
    </button>
</div>

<!-- Schedule Grid -->
<div class="rounded-xl border border-gray-100 bg-white shadow-sm">
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="sticky left-0 z-10 bg-gray-50 px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">Time</th>
                    @foreach (var day in Days)
                    {
                        <th class="px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-600">
                            <div>@day</div>
                            <div class="mt-1 text-xs font-normal text-gray-500">@GetDateForDay(day)</div>
                        </th>
                    }
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white">
                @foreach (var timeSlot in TimeSlots)
                {
                    <tr>
                        <td class="sticky left-0 z-10 bg-white whitespace-nowrap px-6 py-4 text-sm font-medium text-gray-700 border-r border-gray-200">
                            @timeSlot
                        </td>
                        @foreach (var day in Days)
                        {
                            <td class="px-2 py-2">
                                @{
                                    var schedule = GetScheduleForDayAndTime(day, timeSlot);
                                    if (schedule != null)
                                    {
                                        <div class="rounded-lg bg-blue-50 border border-blue-200 p-3 hover:shadow-md transition-shadow cursor-pointer">
                                            <p class="text-sm font-semibold text-blue-900">@schedule.Subject</p>
                                            <p class="text-xs text-blue-700 mt-1">@schedule.Class</p>
                                            <p class="text-xs text-blue-600 mt-1">@schedule.Room</p>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="h-20 rounded-lg bg-gray-50"></div>
                                    }
                                }
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Legend -->
<div class="mt-6 rounded-xl border border-gray-100 bg-white p-4 shadow-sm">
    <h3 class="mb-3 text-sm font-semibold text-gray-800">Schedule Summary</h3>
    <div class="grid grid-cols-1 gap-3 md:grid-cols-3">
        <div class="flex items-center gap-2">
            <div class="h-3 w-3 rounded-full bg-blue-500"></div>
            <span class="text-sm text-gray-600">Regular Classes: @Schedule.Count</span>
        </div>
        <div class="flex items-center gap-2">
            <div class="h-3 w-3 rounded-full bg-gray-300"></div>
            <span class="text-sm text-gray-600">Free Periods: @CountFreePeriods()</span>
        </div>
        <div class="flex items-center gap-2">
            <svg class="h-4 w-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-sm text-gray-600">Total Hours/Week: @CalculateTotalHours()</span>
        </div>
    </div>
</div>

@code {
    private DateTime CurrentWeekStart { get; set; } = DateTime.Now.Date;
    private List<string> Days { get; set; } = new() { "Monday", "Tuesday", "Wednesday", "Thursday", "Friday" };
    private List<string> TimeSlots { get; set; } = new()
    {
        "7:00 AM",
        "8:00 AM",
        "9:00 AM",
        "10:00 AM",
        "11:00 AM",
        "1:00 PM",
        "2:00 PM",
        "3:00 PM",
        "4:00 PM"
    };

    private List<ScheduleItem> Schedule { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // Check if user is a teacher
        if (AuthService.CurrentUser?.user_role != "Teacher")
        {
            Navigation.NavigateTo("/dashboard");
            return;
        }

        // Set to start of current week (Monday)
        var daysFromMonday = ((int)CurrentWeekStart.DayOfWeek - (int)DayOfWeek.Monday + 7) % 7;
        CurrentWeekStart = CurrentWeekStart.AddDays(-daysFromMonday);

        LoadingService.ShowLoading("Loading schedule...");
        
        try
        {
            await LoadSchedule();
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private async Task LoadSchedule()
    {
        // TODO: Load from database
        await Task.Delay(500);

        Schedule = new List<ScheduleItem>
        {
            new ScheduleItem { Day = "Monday", StartTime = "8:00 AM", EndTime = "9:00 AM", Subject = "Mathematics", Class = "Grade 7-A", Room = "Room 101" },
            new ScheduleItem { Day = "Monday", StartTime = "10:00 AM", EndTime = "11:00 AM", Subject = "Mathematics", Class = "Grade 7-B", Room = "Room 101" },
            new ScheduleItem { Day = "Tuesday", StartTime = "10:00 AM", EndTime = "11:30 AM", Subject = "Science", Class = "Grade 8-A", Room = "Room 205" },
            new ScheduleItem { Day = "Wednesday", StartTime = "8:00 AM", EndTime = "9:00 AM", Subject = "Mathematics", Class = "Grade 7-A", Room = "Room 101" },
            new ScheduleItem { Day = "Wednesday", StartTime = "1:00 PM", EndTime = "2:00 PM", Subject = "English", Class = "Grade 7-C", Room = "Room 102" },
            new ScheduleItem { Day = "Thursday", StartTime = "10:00 AM", EndTime = "11:30 AM", Subject = "Science", Class = "Grade 8-B", Room = "Room 205" },
            new ScheduleItem { Day = "Friday", StartTime = "8:00 AM", EndTime = "9:00 AM", Subject = "Mathematics", Class = "Grade 7-A", Room = "Room 101" },
            new ScheduleItem { Day = "Friday", StartTime = "10:00 AM", EndTime = "11:00 AM", Subject = "Mathematics", Class = "Grade 7-B", Room = "Room 101" }
        };
    }

    private string GetWeekRange()
    {
        var endDate = CurrentWeekStart.AddDays(4);
        return $"{CurrentWeekStart:MMM dd} - {endDate:MMM dd, yyyy}";
    }

    private string GetDateForDay(string day)
    {
        var dayIndex = Days.IndexOf(day);
        var date = CurrentWeekStart.AddDays(dayIndex);
        return date.ToString("MMM dd");
    }

    private void PreviousWeek()
    {
        CurrentWeekStart = CurrentWeekStart.AddDays(-7);
        StateHasChanged();
    }

    private void NextWeek()
    {
        CurrentWeekStart = CurrentWeekStart.AddDays(7);
        StateHasChanged();
    }

    private ScheduleItem? GetScheduleForDayAndTime(string day, string timeSlot)
    {
        return Schedule.FirstOrDefault(s => 
            s.Day == day && s.StartTime == timeSlot);
    }

    private int CountFreePeriods()
    {
        var totalSlots = Days.Count * TimeSlots.Count;
        return totalSlots - Schedule.Count;
    }

    private string CalculateTotalHours()
    {
        // Each regular class is typically 1 hour
        // Science classes are 1.5 hours
        var regularHours = Schedule.Count(s => !s.Subject.Contains("Science"));
        var scienceHours = Schedule.Count(s => s.Subject.Contains("Science")) * 1.5;
        var total = regularHours + scienceHours;
        return $"{total:F1}";
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/teacher/dashboard");
    }

    public class ScheduleItem
    {
        public string Day { get; set; } = string.Empty;
        public string StartTime { get; set; } = string.Empty;
        public string EndTime { get; set; } = string.Empty;
        public string Subject { get; set; } = string.Empty;
        public string Class { get; set; } = string.Empty;
        public string Room { get; set; } = string.Empty;
    }
}
