@page "/cashier/payment-history"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.AuthFunction
@inject IAuthService AuthService
@inject ILoadingService LoadingService
@inject NavigationManager Navigation

<PageTitle>Payment History</PageTitle>

<div class="text-gray-800">
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Payment History</h1>
            <p class="mt-1 text-sm text-gray-600">View all payment transactions</p>
        </div>
        <button @onclick="GoBack" class="flex items-center gap-2 rounded-full bg-gray-600 px-4 py-2 text-sm font-medium text-white shadow-md transition-all duration-300 hover:bg-gray-700 hover:shadow-lg">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back
        </button>
    </div>
</div>

<!-- Filter Section -->
<div class="mb-6 rounded-xl border border-gray-100 bg-white p-4 shadow-sm">
    <div class="grid grid-cols-1 gap-4 md:grid-cols-4">
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Date From</label>
            <input type="date" @bind="DateFrom" @bind:after="FilterTransactions" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400" />
        </div>
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Date To</label>
            <input type="date" @bind="DateTo" @bind:after="FilterTransactions" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400" />
        </div>
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Payment Type</label>
            <select @bind="SelectedPaymentType" @bind:after="FilterTransactions" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400">
                <option value="">All Types</option>
                <option value="Tuition Fee">Tuition Fee</option>
                <option value="Miscellaneous Fee">Miscellaneous Fee</option>
                <option value="Other Fee">Other Fee</option>
                <option value="Books">Books</option>
                <option value="Uniform">Uniform</option>
            </select>
        </div>
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Search</label>
            <input type="text" @bind="SearchTerm" @bind:event="oninput" @bind:after="FilterTransactions" placeholder="Student name or OR#" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400" />
        </div>
    </div>
</div>

<!-- Transactions Table -->
<div class="rounded-xl border border-gray-100 bg-white shadow-sm">
    <div class="border-b border-gray-200 p-6">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold text-gray-800">Transaction Records</h2>
            <div class="flex items-center gap-3">
                <span class="text-sm text-gray-600">Total Amount: <span class="font-bold text-green-600">?@GetTotalAmount().ToString("N2")</span></span>
                <button @onclick="ExportToExcel" class="flex items-center gap-2 rounded-full bg-green-600 px-4 py-2 text-sm font-medium text-white transition-all hover:bg-green-700">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Export
                </button>
            </div>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">OR Number</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">Date & Time</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">Student</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">Payment Type</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">Method</th>
                    <th class="px-6 py-3 text-right text-xs font-semibold uppercase tracking-wider text-gray-600">Amount</th>
                    <th class="px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-600">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white">
                @foreach (var transaction in FilteredTransactions)
                {
                    <tr class="hover:bg-gray-50">
                        <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-blue-600">@transaction.ORNumber</td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-600">@transaction.TransactionDate.ToString("MMM dd, yyyy hh:mm tt")</td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-800">
                            <div>
                                <p class="font-medium">@transaction.StudentName</p>
                                <p class="text-xs text-gray-500">@transaction.StudentId</p>
                            </div>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-600">@transaction.PaymentType</td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm">
                            <span class="inline-flex rounded-full px-2 py-1 text-xs font-medium @GetPaymentMethodClass(transaction.PaymentMethod)">
                                @transaction.PaymentMethod
                            </span>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-semibold text-gray-800">?@transaction.Amount.ToString("N2")</td>
                        <td class="whitespace-nowrap px-6 py-4 text-center">
                            <button @onclick="() => ViewReceipt(transaction.ORNumber)" class="text-blue-600 hover:text-blue-800">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (!FilteredTransactions.Any())
    {
        <div class="py-12 text-center text-gray-500">
            <svg class="mx-auto mb-4 h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p>No transactions found</p>
        </div>
    }
</div>

@code {
    private DateTime? DateFrom { get; set; }
    private DateTime? DateTo { get; set; }
    private string SelectedPaymentType { get; set; } = string.Empty;
    private string SearchTerm { get; set; } = string.Empty;

    private List<PaymentTransaction> Transactions { get; set; } = new();
    private List<PaymentTransaction> FilteredTransactions { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // Check if user is a cashier
        if (AuthService.CurrentUser?.user_role != "Cashier")
        {
            Navigation.NavigateTo("/dashboard");
            return;
        }

        LoadingService.ShowLoading("Loading transactions...");
        
        try
        {
            await LoadTransactions();
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private async Task LoadTransactions()
    {
        // TODO: Load from database
        await Task.Delay(500);

        Transactions = new List<PaymentTransaction>
        {
            new PaymentTransaction { ORNumber = "2024-001234", TransactionDate = DateTime.Now.AddHours(-2), StudentId = "2024-001", StudentName = "Juan Dela Cruz", PaymentType = "Tuition Fee", PaymentMethod = "Cash", Amount = 5000.00m },
            new PaymentTransaction { ORNumber = "2024-001235", TransactionDate = DateTime.Now.AddHours(-3), StudentId = "2024-002", StudentName = "Maria Santos", PaymentType = "Miscellaneous Fee", PaymentMethod = "GCash", Amount = 2500.00m },
            new PaymentTransaction { ORNumber = "2024-001236", TransactionDate = DateTime.Now.AddHours(-4), StudentId = "2024-003", StudentName = "Pedro Reyes", PaymentType = "Books", PaymentMethod = "Cash", Amount = 1800.00m },
            new PaymentTransaction { ORNumber = "2024-001237", TransactionDate = DateTime.Now.AddDays(-1), StudentId = "2024-004", StudentName = "Ana Garcia", PaymentType = "Tuition Fee", PaymentMethod = "Bank Transfer", Amount = 5000.00m },
            new PaymentTransaction { ORNumber = "2024-001238", TransactionDate = DateTime.Now.AddDays(-1), StudentId = "2024-005", StudentName = "Carlos Mendoza", PaymentType = "Uniform", PaymentMethod = "Cash", Amount = 1200.00m }
        };

        FilteredTransactions = Transactions;
    }

    private void FilterTransactions()
    {
        FilteredTransactions = Transactions.Where(t =>
        {
            bool matchesDate = (!DateFrom.HasValue || t.TransactionDate.Date >= DateFrom.Value.Date) &&
                               (!DateTo.HasValue || t.TransactionDate.Date <= DateTo.Value.Date);
            
            bool matchesType = string.IsNullOrEmpty(SelectedPaymentType) || t.PaymentType == SelectedPaymentType;
            
            bool matchesSearch = string.IsNullOrEmpty(SearchTerm) ||
                t.StudentName.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                t.ORNumber.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                t.StudentId.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase);

            return matchesDate && matchesType && matchesSearch;
        }).ToList();
    }

    private decimal GetTotalAmount()
    {
        return FilteredTransactions.Sum(t => t.Amount);
    }

    private string GetPaymentMethodClass(string method)
    {
        return method.ToLower() switch
        {
            "cash" => "bg-green-100 text-green-800",
            "gcash" => "bg-blue-100 text-blue-800",
            "paymaya" => "bg-purple-100 text-purple-800",
            "bank transfer" => "bg-indigo-100 text-indigo-800",
            "check" => "bg-yellow-100 text-yellow-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private void ViewReceipt(string orNumber)
    {
        Navigation.NavigateTo($"/cashier/receipt/{orNumber}");
    }

    private async Task ExportToExcel()
    {
        LoadingService.ShowLoading("Generating report...");
        
        try
        {
            // TODO: Implement Excel export
            await Task.Delay(1000);
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/cashier/dashboard");
    }

    public class PaymentTransaction
    {
        public string ORNumber { get; set; } = string.Empty;
        public DateTime TransactionDate { get; set; }
        public string StudentId { get; set; } = string.Empty;
        public string StudentName { get; set; } = string.Empty;
        public string PaymentType { get; set; } = string.Empty;
        public string PaymentMethod { get; set; } = string.Empty;
        public decimal Amount { get; set; }
    }
}
