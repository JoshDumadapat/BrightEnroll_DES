@page "/cashier/payment-history"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.AuthFunction
@using BrightEnroll_DES.Services.Cashier
@inject IAuthService AuthService
@inject ILoadingService LoadingService
@inject NavigationManager Navigation
@inject CashierService CashierService

<PageTitle>Payment History</PageTitle>

<div class="text-gray-800">
    <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="min-w-0 flex-1">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Payment History</h1>
            <p class="mt-1 text-sm text-gray-600">View all payment transactions</p>
        </div>
        <button @onclick="GoBack" class="flex items-center justify-center gap-2 rounded-full bg-gray-600 px-4 py-2 text-sm font-medium text-white shadow-md transition-all duration-300 hover:bg-gray-700 hover:shadow-lg flex-shrink-0">
            <svg class="h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span class="hidden sm:inline">Back</span>
        </button>
    </div>
</div>

<!-- Filter Section -->
<div class="mb-6 rounded-xl border border-gray-100 bg-white p-4 shadow-sm">
    <div class="grid grid-cols-1 gap-4 md:grid-cols-4">
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Date From</label>
            <input type="date" @bind="DateFrom" @bind:after="FilterTransactions" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400" />
        </div>
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Date To</label>
            <input type="date" @bind="DateTo" @bind:after="FilterTransactions" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400" />
        </div>
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Payment Type</label>
            <select @bind="SelectedPaymentType" @bind:after="FilterTransactions" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400">
                <option value="">All Types</option>
                <option value="Tuition Fee">Tuition Fee</option>
                <option value="Miscellaneous Fee">Miscellaneous Fee</option>
                <option value="Other Fee">Other Fee</option>
                <option value="Books">Books</option>
                <option value="Uniform">Uniform</option>
            </select>
        </div>
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Search</label>
            <input type="text" @bind="SearchTerm" @bind:event="oninput" @bind:after="FilterTransactions" placeholder="Student name or OR#" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400" />
        </div>
    </div>
</div>

<!-- Transactions Table -->
<div class="rounded-xl border border-gray-100 bg-white shadow-sm">
    <div class="border-b border-gray-200 p-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <h2 class="text-lg font-bold text-gray-800">Transaction Records</h2>
            <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                <span class="text-sm text-gray-600">Total Amount: <span class="font-bold text-green-600">₱@GetTotalAmount().ToString("N2")</span></span>
                <button @onclick="ExportToExcel" class="flex items-center justify-center gap-2 rounded-full bg-green-600 px-4 py-2 text-sm font-medium text-white transition-all hover:bg-green-700 flex-shrink-0">
                    <svg class="h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Export</span>
                </button>
            </div>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">OR Number</th>
                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 hidden sm:table-cell">Date & Time</th>
                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">Student</th>
                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 hidden md:table-cell">Payment Type</th>
                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 hidden lg:table-cell">Method</th>
                    <th class="px-3 sm:px-6 py-3 text-right text-xs font-semibold uppercase tracking-wider text-gray-600">Amount</th>
                    <th class="px-3 sm:px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-600">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white">
                @foreach (var transaction in FilteredTransactions)
                {
                    <tr class="hover:bg-gray-50">
                        <td class="whitespace-nowrap px-3 sm:px-6 py-4 text-sm font-medium text-blue-600">@transaction.ORNumber</td>
                        <td class="whitespace-nowrap px-3 sm:px-6 py-4 text-sm text-gray-600 hidden sm:table-cell">@transaction.TransactionDate.ToString("MMM dd, yyyy hh:mm tt")</td>
                        <td class="px-3 sm:px-6 py-4 text-sm text-gray-800">
                            <div>
                                <p class="font-medium">@transaction.StudentName</p>
                                <p class="text-xs text-gray-500">@transaction.StudentId</p>
                                <p class="text-xs text-gray-500 sm:hidden">@transaction.TransactionDate.ToString("MMM dd, yyyy")</p>
                            </div>
                        </td>
                        <td class="whitespace-nowrap px-3 sm:px-6 py-4 text-sm text-gray-600 hidden md:table-cell">@transaction.PaymentType</td>
                        <td class="whitespace-nowrap px-3 sm:px-6 py-4 text-sm hidden lg:table-cell">
                            <span class="inline-flex rounded-full px-2 py-1 text-xs font-medium @GetPaymentMethodClass(transaction.PaymentMethod)">
                                @transaction.PaymentMethod
                            </span>
                        </td>
                        <td class="whitespace-nowrap px-3 sm:px-6 py-4 text-right text-sm font-semibold text-gray-800">₱@transaction.Amount.ToString("N2")</td>
                        <td class="whitespace-nowrap px-3 sm:px-6 py-4 text-center">
                            <button @onclick="() => ViewReceipt(transaction.ORNumber)" class="text-blue-600 hover:text-blue-800">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (!FilteredTransactions.Any())
    {
        <div class="py-12 text-center text-gray-500">
            <svg class="mx-auto mb-4 h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p>No transactions found</p>
        </div>
    }
</div>

@code {
    private DateTime? DateFrom { get; set; }
    private DateTime? DateTo { get; set; }
    private string SelectedPaymentType { get; set; } = string.Empty;
    private string SearchTerm { get; set; } = string.Empty;

    private List<PaymentTransaction> Transactions { get; set; } = new();
    private List<PaymentTransaction> FilteredTransactions { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // Check if user is a cashier
        if (AuthService.CurrentUser?.user_role != "Cashier")
        {
            Navigation.NavigateTo("/dashboard");
            return;
        }

        LoadingService.ShowLoading("Loading transactions...");
        
        try
        {
            await LoadTransactions();
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private async Task LoadTransactions()
    {
        try
        {
            // Load all transactions from database
            Transactions = await CashierService.GetPaymentTransactionsAsync();
            FilteredTransactions = Transactions;
        }
        catch (Exception ex)
        {
            // Log error and use empty list
            System.Diagnostics.Debug.WriteLine($"Error loading transactions: {ex.Message}");
            Transactions = new List<PaymentTransaction>();
            FilteredTransactions = new List<PaymentTransaction>();
        }
    }

    private async Task FilterTransactions()
    {
        try
        {
            LoadingService.ShowLoading("Filtering transactions...");
            
            // Reload from database with filters applied
            Transactions = await CashierService.GetPaymentTransactionsAsync(
                dateFrom: DateFrom,
                dateTo: DateTo,
                paymentType: string.IsNullOrWhiteSpace(SelectedPaymentType) ? null : SelectedPaymentType,
                searchTerm: string.IsNullOrWhiteSpace(SearchTerm) ? null : SearchTerm
            );

            FilteredTransactions = Transactions;
        }
        catch (Exception ex)
        {
            // Log error
            System.Diagnostics.Debug.WriteLine($"Error filtering transactions: {ex.Message}");
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private decimal GetTotalAmount()
    {
        return FilteredTransactions.Sum(t => t.Amount);
    }

    private string GetPaymentMethodClass(string method)
    {
        return method.ToLower() switch
        {
            "cash" => "bg-green-100 text-green-800",
            "gcash" => "bg-blue-100 text-blue-800",
            "paymaya" => "bg-purple-100 text-purple-800",
            "bank transfer" => "bg-indigo-100 text-indigo-800",
            "check" => "bg-yellow-100 text-yellow-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private void ViewReceipt(string orNumber)
    {
        Navigation.NavigateTo($"/cashier/receipt/{orNumber}");
    }

    private async Task ExportToExcel()
    {
        LoadingService.ShowLoading("Generating report...");
        
        try
        {
            // TODO: Implement Excel export
            await Task.Delay(1000);
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/cashier/dashboard");
    }
}
