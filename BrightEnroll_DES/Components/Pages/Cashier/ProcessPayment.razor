@page "/cashier/process-payment"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.AuthFunction
@using BrightEnroll_DES.Services.Cashier
@inject IAuthService AuthService
@inject ILoadingService LoadingService
@inject NavigationManager Navigation
@inject CashierService CashierService

<PageTitle>Process Payment</PageTitle>

<div class="text-gray-800">
    <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="min-w-0 flex-1">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Process Payment</h1>
            <p class="mt-1 text-sm text-gray-600">Accept and record student payments</p>
        </div>
        <button @onclick="GoBack" class="flex items-center justify-center gap-2 rounded-full bg-gray-600 px-4 py-2 text-sm font-medium text-white shadow-md transition-all duration-300 hover:bg-gray-700 hover:shadow-lg flex-shrink-0">
            <svg class="h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span class="hidden sm:inline">Back</span>
        </button>
    </div>
</div>

<!-- Student Search -->
<div class="mb-6 rounded-xl border border-gray-100 bg-white p-6 shadow-sm">
    <h2 class="mb-4 text-lg font-bold text-gray-800">Search Student</h2>
    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Student ID or Name</label>
            <input type="text" @bind="SearchTerm" @bind:event="oninput" @bind:after="SearchStudent" placeholder="Enter student ID or name..." class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400" />
        </div>
        <div class="flex items-end">
            <button @onclick="SearchStudent" class="flex items-center justify-center gap-2 rounded-full bg-blue-600 px-4 sm:px-6 py-2 text-sm font-medium text-white shadow-md transition-all duration-300 hover:bg-blue-700 hover:shadow-lg w-full sm:w-auto">
                <svg class="h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <span>Search</span>
            </button>
        </div>
    </div>
</div>

@if (SelectedStudent != null)
{
    <!-- Student Information -->
    <div class="mb-6 rounded-xl border border-gray-100 bg-white p-6 shadow-sm">
        <h2 class="mb-4 text-lg font-bold text-gray-800">Student Information</h2>
        <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
            <div>
                <p class="text-sm text-gray-500">Student ID</p>
                <p class="font-semibold text-gray-800">@SelectedStudent.StudentId</p>
            </div>
            <div>
                <p class="text-sm text-gray-500">Full Name</p>
                <p class="font-semibold text-gray-800">@SelectedStudent.FullName</p>
            </div>
            <div>
                <p class="text-sm text-gray-500">Grade Level</p>
                <p class="font-semibold text-gray-800">@SelectedStudent.GradeLevel</p>
            </div>
        </div>
    </div>

    <!-- Account Summary -->
    <div class="mb-6 rounded-xl border border-gray-100 bg-white p-6 shadow-sm">
        <h2 class="mb-4 text-lg font-bold text-gray-800">Account Summary</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="rounded-lg border border-blue-200 bg-blue-50 p-3 sm:p-4">
                <p class="text-xs sm:text-sm text-blue-600">Total Assessment</p>
                <p class="text-xl sm:text-2xl font-bold text-blue-800">₱@SelectedStudent.TotalAssessment.ToString("N2")</p>
            </div>
            <div class="rounded-lg border border-green-200 bg-green-50 p-3 sm:p-4">
                <p class="text-xs sm:text-sm text-green-600">Total Paid</p>
                <p class="text-xl sm:text-2xl font-bold text-green-800">₱@SelectedStudent.TotalPaid.ToString("N2")</p>
            </div>
            <div class="rounded-lg border border-red-200 bg-red-50 p-3 sm:p-4">
                <p class="text-xs sm:text-sm text-red-600">Balance</p>
                <p class="text-xl sm:text-2xl font-bold text-red-800">₱@SelectedStudent.Balance.ToString("N2")</p>
            </div>
            <div class="rounded-lg border border-purple-200 bg-purple-50 p-3 sm:p-4">
                <p class="text-xs sm:text-sm text-purple-600">Payment Status</p>
                <p class="text-lg sm:text-xl font-bold text-purple-800">@GetPaymentStatus()</p>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="mb-6 rounded-xl border border-red-200 bg-red-50 p-4">
            <p class="text-sm font-medium text-red-800">@ErrorMessage</p>
        </div>
    }

    <!-- Payment Form -->
    <div class="mb-6 rounded-xl border border-gray-100 bg-white p-6 shadow-sm">
        <h2 class="mb-4 text-lg font-bold text-gray-800">Payment Details</h2>
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-700">Payment Type</label>
                <select @bind="PaymentType" @bind:after="OnPaymentTypeChanged" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400">
                    <option value="">Select Payment Type</option>
                    <option value="Tuition Fee">Tuition Fee</option>
                    <option value="Miscellaneous Fee">Miscellaneous Fee</option>
                    <option value="Other Fee">Other Fee</option>
                    <option value="Books">Books</option>
                    <option value="Uniform">Uniform</option>
                    <option value="Full Payment">Full Payment</option>
                </select>
            </div>
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-700">Amount</label>
                <input type="number" @bind="PaymentAmount" step="0.01" min="0" max="@(SelectedStudent?.Balance ?? 0)" placeholder="@(PaymentType == "Full Payment" ? "Will pay full balance" : "Enter amount")" disabled="@(PaymentType == "Full Payment")" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400 disabled:bg-gray-100 disabled:cursor-not-allowed" />
                @if (PaymentType == "Full Payment" && SelectedStudent != null)
                {
                    <p class="mt-1 text-xs text-gray-500">Will pay full balance: ₱@SelectedStudent.Balance.ToString("N2")</p>
                }
            </div>
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-700">Payment Method</label>
                <select @bind="PaymentMethod" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400">
                    <option value="">Select Payment Method</option>
                    <option value="Cash">Cash</option>
                    <option value="Check">Check</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="GCash">GCash</option>
                    <option value="PayMaya">PayMaya</option>
                </select>
            </div>
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-700">Reference Number (Optional)</label>
                <input type="text" @bind="ReferenceNumber" placeholder="Check/Transaction number" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400" />
            </div>
            <div class="md:col-span-2">
                <label class="mb-2 block text-sm font-medium text-gray-700">Remarks (Optional)</label>
                <textarea @bind="Remarks" rows="3" placeholder="Additional notes..." class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400"></textarea>
            </div>
        </div>

        <div class="mt-6 flex justify-end gap-3">
            <button @onclick="ClearPaymentForm" class="rounded-full border border-gray-300 bg-white px-6 py-2 text-sm font-medium text-gray-700 transition-all hover:bg-gray-50">
                Clear
            </button>
            <button @onclick="SubmitPayment" class="flex items-center gap-2 rounded-full bg-green-600 px-6 py-2 text-sm font-medium text-white shadow-md transition-all duration-300 hover:bg-green-700 hover:shadow-lg">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Process Payment
            </button>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(SearchTerm))
{
    <div class="rounded-xl border border-gray-100 bg-white p-12 text-center shadow-sm">
        <svg class="mx-auto mb-4 h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <p class="text-gray-500">No student found with that ID or name</p>
    </div>
}
else
{
    <div class="rounded-xl border border-gray-100 bg-white p-12 text-center shadow-sm">
        <svg class="mx-auto mb-4 h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <p class="text-gray-500">Search for a student to process payment</p>
    </div>
}

@code {
    private string SearchTerm { get; set; } = string.Empty;
    private StudentAccountInfo? SelectedStudent { get; set; }

    private string PaymentType { get; set; } = string.Empty;
    private decimal PaymentAmount { get; set; } = 0;
    private string PaymentMethod { get; set; } = string.Empty;
    private string ReferenceNumber { get; set; } = string.Empty;
    private string Remarks { get; set; } = string.Empty;
    private string? ErrorMessage { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Check if user is a cashier
        if (AuthService.CurrentUser?.user_role != "Cashier")
        {
            Navigation.NavigateTo("/dashboard");
            return;
        }

        // Check if studentId is provided in query string (from StudentAccounts page)
        var uri = new Uri(Navigation.Uri);
        var query = ParseQueryString(uri.Query);
        if (query.TryGetValue("studentId", out var studentId))
        {
            if (!string.IsNullOrWhiteSpace(studentId))
            {
                SearchTerm = studentId;
                await SearchStudent();
            }
        }
    }

    private async Task SearchStudent()
    {
        if (string.IsNullOrWhiteSpace(SearchTerm))
        {
            SelectedStudent = null;
            ErrorMessage = null;
            return;
        }

        LoadingService.ShowLoading("Searching student...");
        ErrorMessage = null;
        
        try
        {
            SelectedStudent = await CashierService.SearchStudentAsync(SearchTerm);
            
            if (SelectedStudent == null)
            {
                ErrorMessage = "No student found with that ID or name.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error searching student: {ex.Message}";
            System.Diagnostics.Debug.WriteLine($"Error searching student: {ex.Message}");
            SelectedStudent = null;
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private string GetPaymentStatus()
    {
        if (SelectedStudent == null) return "N/A";
        
        if (SelectedStudent.Balance <= 0) return "Fully Paid";
        if (SelectedStudent.TotalPaid > 0) return "Partial";
        return "Unpaid";
    }

    private async Task SubmitPayment()
    {
        ErrorMessage = null;

        // Validate payment details
        if (SelectedStudent == null)
        {
            ErrorMessage = "Please select a student first.";
            return;
        }

        if (string.IsNullOrWhiteSpace(PaymentType))
        {
            ErrorMessage = "Please select a payment type.";
            return;
        }

        if (PaymentType != "Full Payment" && PaymentAmount <= 0)
        {
            ErrorMessage = "Please enter a valid payment amount.";
            return;
        }

        if (string.IsNullOrWhiteSpace(PaymentMethod))
        {
            ErrorMessage = "Please select a payment method.";
            return;
        }

        // Validate payment amount doesn't exceed balance (unless full payment)
        if (PaymentType != "Full Payment" && PaymentAmount > SelectedStudent.Balance)
        {
            ErrorMessage = $"Payment amount cannot exceed the outstanding balance of ₱{SelectedStudent.Balance:N2}.";
            return;
        }

        LoadingService.ShowLoading("Processing payment...");
        
        try
        {
            // Get current user ID
            var currentUserId = AuthService.CurrentUser?.user_ID;

            // Create payment request
            var paymentRequest = new ProcessPaymentRequest
            {
                AccountId = SelectedStudent.AccountId,
                PaymentType = PaymentType,
                Amount = PaymentAmount,
                PaymentMethod = PaymentMethod,
                ReferenceNumber = string.IsNullOrWhiteSpace(ReferenceNumber) ? null : ReferenceNumber,
                Remarks = string.IsNullOrWhiteSpace(Remarks) ? null : Remarks,
                ProcessedByUserId = currentUserId
            };

            // Process payment
            var orNumber = await CashierService.ProcessPaymentAsync(paymentRequest);

            // Clear form
            ClearPaymentForm();

            // Navigate to receipt page (or back to dashboard if receipt page doesn't exist)
            Navigation.NavigateTo($"/cashier/payment-history");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error processing payment: {ex.Message}";
            System.Diagnostics.Debug.WriteLine($"Error processing payment: {ex.Message}");
        }
        finally
        {
            LoadingService.HideLoading();
        }
    }

    private void OnPaymentTypeChanged()
    {
        // If Full Payment is selected, set amount to balance
        if (PaymentType == "Full Payment" && SelectedStudent != null)
        {
            PaymentAmount = SelectedStudent.Balance;
        }
        else if (PaymentType != "Full Payment")
        {
            // Reset amount if switching away from Full Payment
            if (PaymentAmount == SelectedStudent?.Balance)
            {
                PaymentAmount = 0;
            }
        }
    }

    private void ClearPaymentForm()
    {
        PaymentType = string.Empty;
        PaymentAmount = 0;
        PaymentMethod = string.Empty;
        ReferenceNumber = string.Empty;
        Remarks = string.Empty;
        ErrorMessage = null;
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/cashier/dashboard");
    }

    private Dictionary<string, string> ParseQueryString(string queryString)
    {
        var query = new Dictionary<string, string>();
        
        if (string.IsNullOrWhiteSpace(queryString))
            return query;
        
        // Remove the leading '?'
        if (queryString.StartsWith("?"))
            queryString = queryString.Substring(1);
        
        var pairs = queryString.Split('&');
        foreach (var pair in pairs)
        {
            var parts = pair.Split('=');
            if (parts.Length == 2)
            {
                var key = Uri.UnescapeDataString(parts[0]);
                var value = Uri.UnescapeDataString(parts[1]);
                query[key] = value;
            }
        }
        
        return query;
    }
}
