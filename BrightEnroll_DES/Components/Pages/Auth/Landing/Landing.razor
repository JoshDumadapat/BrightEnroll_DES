@page "/"
@layout Components.Layout.AuthLayout
@using BrightEnroll_DES.Components
@using BrightEnroll_DES.Services.Authentication
@using BrightEnroll_DES.Services.RoleBase
@inject NavigationManager Navigation
@inject IAuthService AuthService
@inject IAuthorizationService AuthorizationService

<!-- Toast Notification -->
<ToastNotification Show="@showToast" Message="@toastMessage" Type="@toastType" OnClose="CloseToast" Duration="3000" />

<div class="flex min-h-screen w-full items-center justify-center bg-white px-4 py-8">
    <div class="flex w-full max-w-md flex-col items-center">
        <!-- Logo Section - Bigger with Fade Up Animation -->
        <div class="animate-fade-up mb-12 flex flex-col items-center">
            <img src="images/lightlogo.png" alt="BrightenRoll Logo" class="mb-4 w-64 object-contain sm:w-72 md:w-80 lg:w-96" />
        </div>

        <!-- Log In Button - Smaller, Capsule Shape with Fade In Animation -->
        <button 
            @onclick="NavigateToLogin"
            class="animate-fade-in-delayed mb-4 w-1/2 max-w-xs rounded-full bg-blue-600 px-6 py-2.5 text-sm font-semibold text-white shadow-md transition-all duration-200 hover:bg-blue-700 hover:shadow-lg active:bg-blue-800 sm:px-8 sm:py-3 sm:text-base"
        >
            LOG IN
        </button>
    </div>
</div>

@code {
    private bool showToast = false;
    private string toastMessage = "";
    private ToastType toastType = ToastType.Success;

    protected override void OnInitialized()
    {
        // If already logged in, redirect based on role
        if (AuthService.IsAuthenticated)
        {
            var userRole = AuthorizationService.GetUserRole();
            var redirectPath = GetRedirectPathForRole(userRole);
            
            // Teachers always go to teacher-dashboard
            if (!string.IsNullOrWhiteSpace(userRole) && 
                string.Equals(userRole, "Teacher", StringComparison.OrdinalIgnoreCase))
            {
                redirectPath = "/teacher-dashboard";
            }
            
            Navigation.NavigateTo(redirectPath, forceLoad: true);
            return;
        }
        
        // Check for toast parameter in query string (only for success/error, not for cancel)
        var uri = new Uri(Navigation.Uri);
        var query = ParseQueryString(uri.Query);
        
        if (query.TryGetValue("toast", out var toastValue))
        {
            // Explicitly ignore cancel transactions - no toast should be shown
            if (toastValue == "registration_cancelled")
            {
                // Clean up URL immediately and do nothing - cancel transactions don't show toasts
                Navigation.NavigateTo("/", forceLoad: false);
                return;
            }
            
            // Handle other toast types (success/error) if needed in the future
        }
    }
    
    private string GetRedirectPathForRole(string? role)
    {
        if (string.IsNullOrWhiteSpace(role))
        {
            return "/dashboard";
        }

        // Normalize role: remove spaces and convert to lowercase for comparison
        var roleLower = role.Replace(" ", "").ToLower().Trim();
        return roleLower switch
        {
            "cashier" => "/finance",
            "registrar" => "/enrollment",
            "hr" => "/human-resource",
            "teacher" => "/teacher-dashboard",
            "admin" => "/dashboard",
            "superadmin" => "/system-admin/dashboard", // SuperAdmin goes to SuperAdmin dashboard (handles both "Super Admin" and "SuperAdmin")
            _ => "/dashboard"
        };
    }

    private Dictionary<string, string> ParseQueryString(string queryString)
    {
        var query = new Dictionary<string, string>();
        
        if (string.IsNullOrWhiteSpace(queryString))
            return query;
        
        // Remove the leading '?'
        if (queryString.StartsWith("?"))
            queryString = queryString.Substring(1);
        
        var pairs = queryString.Split('&');
        foreach (var pair in pairs)
        {
            var parts = pair.Split('=');
            if (parts.Length == 2)
            {
                var key = Uri.UnescapeDataString(parts[0]);
                var value = Uri.UnescapeDataString(parts[1]);
                query[key] = value;
            }
        }
        
        return query;
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            // Clean up query parameter from URL after showing toast
            var uri = new Uri(Navigation.Uri);
            if (uri.Query.Contains("toast="))
            {
                Navigation.NavigateTo("/", forceLoad: false);
            }
        }
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    private void CloseToast()
    {
        showToast = false;
        toastMessage = "";
        StateHasChanged();
    }
}
