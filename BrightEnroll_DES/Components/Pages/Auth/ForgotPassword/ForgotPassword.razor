@page "/forgot-password"
@layout Components.Layout.AuthLayout
@using BrightEnroll_DES.Services.Infrastructure
@using BrightEnroll_DES.Services.DataAccess.Repositories
@using BrightEnroll_DES.Services.Authentication
@using System.ComponentModel.DataAnnotations
@inject NavigationManager Navigation
@inject IEmailService EmailService
@inject IUserRepository UserRepository
@inject ILoginService LoginService
@inject IJSRuntime JSRuntime

<PageTitle>Forgot Password - BrightEnroll</PageTitle>

<div class="relative flex h-screen w-full flex-col md:flex-row">
    <div class="relative h-[50vh] w-full md:h-screen md:w-[40%]">
        <img src="images/kid.png" alt="Child learning" class="h-full w-full object-cover" />
    </div>

    <div class="absolute bottom-0 left-0 right-0 flex min-h-[50vh] w-full items-center justify-center overflow-y-auto p-1.5 sm:p-2 md:relative md:min-h-screen md:w-[60%] md:p-3 md:p-8">
        <div class="relative my-auto max-h-[95vh] w-full max-w-[96%] overflow-y-auto rounded-2xl bg-white p-3 pb-8 shadow-xl sm:max-h-[98vh] sm:max-w-[420px] sm:p-4 sm:pb-4 md:max-h-none md:max-w-[480px] md:p-6 md:pb-6 lg:max-w-[520px] lg:p-8 lg:pb-8 xl:p-10 xl:pb-10">
            
            <div class="flex flex-col">
                <!-- Logo - Responsive Size, Smaller on Small Screens -->
                <div class="flex justify-center">
                    <img src="images/lightlogo.png" alt="BrightenRoll Logo" class="m-0 w-24 max-w-full object-contain sm:w-32 md:w-40 lg:w-48 xl:w-60 2xl:w-72" />
                </div>

                <!-- Title and Description - Compact on Small Screens -->
                <div class="mb-3 mt-0 w-full text-left sm:mb-4 md:mb-6 lg:mb-8">
                    <h1 class="mb-1 text-left font-semibold text-[17px] text-gray-900 sm:text-lg md:text-xl lg:text-[22px]">
                        Forgot Password?
                    </h1>
                    <p class="mb-3 text-left text-[13px] text-gray-600 sm:text-sm md:text-[15px]">
                        Enter your email to receive a verification code
                    </p>
                </div>

            <!-- Step 1: Enter Email -->
            @if (currentStep == ForgotPasswordStep.EnterEmail)
            {
                <form class="w-full space-y-2 sm:space-y-2.5 md:space-y-3 lg:space-y-4" @onsubmit:preventDefault="true" @onsubmit="HandleSendCode">
                    <div class="mb-3 sm:mb-4 md:mb-5 lg:mb-6">
                        <label for="email" class="mb-0.5 block text-sm font-medium text-gray-700 sm:mb-1 sm:text-sm md:text-sm">Email Address</label>
                        <input type="email" id="email" @bind="emailModel.Email" @bind:event="oninput"
                               class="@GetEmailInputClass()" 
                               placeholder="Enter your email address" />
                        @if (emailError && !string.IsNullOrEmpty(emailErrorMessage))
                        {
                            <p class="mt-0.5 text-sm text-red-600 sm:mt-1 sm:text-sm">@emailErrorMessage</p>
                        }
                    </div>

                    <button type="submit" 
                            disabled="@isLoading"
                            class="w-full rounded-lg bg-blue-600 px-4 py-3 text-sm font-semibold text-white transition-colors hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:bg-gray-400">
                        @if (isLoading)
                        {
                            <span class="flex items-center justify-center gap-2">
                                <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Sending Code...
                            </span>
                        }
                        else
                        {
                            <span>Send Verification Code</span>
                        }
                    </button>
                </form>
            }

            <!-- Step 2: Enter Verification Code -->
            @if (currentStep == ForgotPasswordStep.EnterCode)
            {
                <div class="mb-3 sm:mb-4 md:mb-5 lg:mb-6">
                    <div class="mb-3 sm:mb-4 rounded-lg bg-blue-50 border border-blue-200 p-3 sm:p-4">
                        <p class="text-sm text-blue-800">
                            <strong>Verification code sent!</strong> Please check your email <strong>@emailModel.Email</strong> for the verification code.
                        </p>
                    </div>
                </div>

                <form class="w-full space-y-2 sm:space-y-2.5 md:space-y-3 lg:space-y-4" @onsubmit:preventDefault="true" @onsubmit="HandleVerifyCode">
                    <div class="mb-3 sm:mb-4 md:mb-5 lg:mb-6">
                        <label for="code" class="mb-0.5 block text-sm font-medium text-gray-700 sm:mb-1 sm:text-sm md:text-sm">Verification Code</label>
                        <input type="text" id="code" @bind="codeModel.Code" @bind:event="oninput"
                               class="@GetCodeInputClass()" 
                               placeholder="000000" 
                               maxlength="6" />
                        @if (codeError && !string.IsNullOrEmpty(codeErrorMessage))
                        {
                            <p class="mt-0.5 text-sm text-red-600 sm:mt-1 sm:text-sm">@codeErrorMessage</p>
                        }
                    </div>

                    <button type="submit" 
                            disabled="@isLoading"
                            class="w-full rounded-lg bg-blue-600 px-4 py-3 text-sm font-semibold text-white transition-colors hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:bg-gray-400">
                        @if (isLoading)
                        {
                            <span class="flex items-center justify-center gap-2">
                                <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Verifying...
                            </span>
                        }
                        else
                        {
                            <span>Verify Code</span>
                        }
                    </button>

                    <div class="mt-3 text-center sm:mt-4">
                        <button type="button" 
                                @onclick="ResendCode"
                                disabled="@isResending"
                                class="cursor-pointer border-none bg-transparent p-0 text-sm font-medium text-blue-600 no-underline transition-all duration-200 hover:text-blue-700 hover:underline disabled:text-gray-400 sm:text-sm">
                            @if (isResending)
                            {
                                <span>Resending...</span>
                            }
                            else
                            {
                                <span>Resend Code</span>
                            }
                        </button>
                    </div>
                </form>
            }

            <!-- Step 3: Reset Password -->
            @if (currentStep == ForgotPasswordStep.ResetPassword)
            {
                <form class="w-full space-y-2 sm:space-y-2.5 md:space-y-3 lg:space-y-4" @onsubmit:preventDefault="true" @onsubmit="HandleResetPassword">
                    <div class="mb-3 sm:mb-4 md:mb-5 lg:mb-6">
                        <label for="newPassword" class="mb-0.5 block text-sm font-medium text-gray-700 sm:mb-1 sm:text-sm md:text-sm">New Password</label>
                        <input type="password" id="newPassword" @bind="passwordModel.NewPassword" @bind:event="oninput"
                               class="@GetPasswordInputClass()" 
                               placeholder="Enter new password" />
                        @if (passwordError && !string.IsNullOrEmpty(passwordErrorMessage))
                        {
                            <p class="mt-0.5 text-sm text-red-600 sm:mt-1 sm:text-sm">@passwordErrorMessage</p>
                        }
                    </div>

                    <div class="mb-3 sm:mb-4 md:mb-5 lg:mb-6">
                        <label for="confirmPassword" class="mb-0.5 block text-sm font-medium text-gray-700 sm:mb-1 sm:text-sm md:text-sm">Confirm Password</label>
                        <input type="password" id="confirmPassword" @bind="passwordModel.ConfirmPassword" @bind:event="oninput"
                               class="@GetPasswordInputClass()" 
                               placeholder="Confirm new password" />
                    </div>

                    <button type="submit" 
                            disabled="@isLoading"
                            class="w-full rounded-lg bg-blue-600 px-4 py-3 text-sm font-semibold text-white transition-colors hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:bg-gray-400">
                        @if (isLoading)
                        {
                            <span class="flex items-center justify-center gap-2">
                                <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Resetting Password...
                            </span>
                        }
                        else
                        {
                            <span>Reset Password</span>
                        }
                    </button>
                </form>
            }

            <!-- Success Message -->
            @if (currentStep == ForgotPasswordStep.Success)
            {
                <div class="text-center">
                    <div class="mb-3 sm:mb-4 mx-auto flex h-12 w-12 sm:h-16 sm:w-16 items-center justify-center rounded-full bg-green-100">
                        <svg class="h-6 w-6 sm:h-8 sm:w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h2 class="mb-1 text-left font-semibold text-[17px] text-gray-900 sm:text-lg md:text-xl lg:text-[22px]">Password Reset Successful!</h2>
                    <p class="mb-3 text-left text-[13px] text-gray-600 sm:text-sm md:text-[15px] sm:mb-4 md:mb-5 lg:mb-6">Your password has been successfully reset. You can now log in with your new password.</p>
                    <button @onclick="NavigateToLogin" 
                            class="w-full rounded-lg bg-blue-600 px-4 py-3 text-sm font-semibold text-white transition-colors hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Go to Login
                    </button>
                </div>
            }

            <!-- Back to Login -->
            <div class="mt-4 text-center sm:mt-4 md:mt-5 lg:mt-6">
                <button @onclick="NavigateToLogin" 
                        class="cursor-pointer border-none bg-transparent p-0 text-sm font-medium text-blue-600 no-underline transition-all duration-200 hover:text-blue-700 hover:underline sm:text-sm">
                    ‚Üê Back to Login
                </button>
            </div>
            </div>
        </div>
    </div>
</div>

@code {
    private enum ForgotPasswordStep
    {
        EnterEmail,
        EnterCode,
        ResetPassword,
        Success
    }

    private ForgotPasswordStep currentStep = ForgotPasswordStep.EnterEmail;
    private bool isLoading = false;
    private bool isResending = false;
    private bool emailError = false;
    private bool codeError = false;
    private bool passwordError = false;
    private string emailErrorMessage = string.Empty;
    private string codeErrorMessage = string.Empty;
    private string passwordErrorMessage = string.Empty;
    private string? verificationCode = null;
    private DateTime? codeExpiryTime = null;
    private string? userEmail = null;
    private int? userId = null;

    private EmailModel emailModel = new();
    private CodeModel codeModel = new();
    private PasswordModel passwordModel = new();

    private async Task HandleSendCode()
    {
        emailError = false;
        emailErrorMessage = string.Empty;
        isLoading = true;

        try
        {
            // Check if user exists
            var user = await UserRepository.GetByEmailAsync(emailModel.Email);
            if (user == null)
            {
                emailError = true;
                emailErrorMessage = "No account found with this email address.";
                isLoading = false;
                StateHasChanged();
                return;
            }

            userEmail = emailModel.Email;
            userId = user.user_ID;

            // Generate 6-digit verification code
            var random = new Random();
            verificationCode = random.Next(100000, 999999).ToString();
            codeExpiryTime = DateTime.Now.AddMinutes(10);

            // Send verification code via email
            var recipientName = $"{user.first_name} {user.last_name}".Trim();
            var emailSent = await EmailService.SendVerificationCodeAsync(emailModel.Email, verificationCode, recipientName);

            if (!emailSent)
            {
                emailError = true;
                emailErrorMessage = "Failed to send verification code. Please try again later.";
                isLoading = false;
                StateHasChanged();
                return;
            }

            // Move to next step
            currentStep = ForgotPasswordStep.EnterCode;
            isLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            emailError = true;
            emailErrorMessage = "An error occurred. Please try again.";
            isLoading = false;
            System.Diagnostics.Debug.WriteLine($"Error in HandleSendCode: {ex.Message}");
            StateHasChanged();
        }
    }

    private Task HandleVerifyCode()
    {
        codeError = false;
        codeErrorMessage = string.Empty;
        isLoading = true;

        try
        {
            // Check if code matches
            if (string.IsNullOrEmpty(verificationCode) || codeModel.Code != verificationCode)
            {
                codeError = true;
                codeErrorMessage = "Invalid verification code. Please try again.";
                isLoading = false;
                StateHasChanged();
                return Task.CompletedTask;
            }

            // Check if code has expired
            if (codeExpiryTime.HasValue && DateTime.Now > codeExpiryTime.Value)
            {
                codeError = true;
                codeErrorMessage = "Verification code has expired. Please request a new code.";
                isLoading = false;
                StateHasChanged();
                return Task.CompletedTask;
            }

            // Move to password reset step
            currentStep = ForgotPasswordStep.ResetPassword;
            isLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            codeError = true;
            codeErrorMessage = "An error occurred. Please try again.";
            isLoading = false;
            System.Diagnostics.Debug.WriteLine($"Error in HandleVerifyCode: {ex.Message}");
            StateHasChanged();
        }

        return Task.CompletedTask;
    }

    private async Task HandleResetPassword()
    {
        passwordError = false;
        passwordErrorMessage = string.Empty;
        isLoading = true;

        try
        {
            // Validate passwords match
            if (passwordModel.NewPassword != passwordModel.ConfirmPassword)
            {
                passwordError = true;
                passwordErrorMessage = "Passwords do not match.";
                isLoading = false;
                StateHasChanged();
                return;
            }

            if (string.IsNullOrEmpty(userEmail) || !userId.HasValue)
            {
                passwordError = true;
                passwordErrorMessage = "Session expired. Please start over.";
                isLoading = false;
                StateHasChanged();
                return;
            }

            // Reset password
            var success = await LoginService.ResetPasswordAsync(userEmail, passwordModel.NewPassword);
            
            if (!success)
            {
                passwordError = true;
                passwordErrorMessage = "Failed to reset password. Please try again.";
                isLoading = false;
                StateHasChanged();
                return;
            }

            // Send confirmation email
            var user = await UserRepository.GetByIdAsync(userId.Value);
            if (user != null)
            {
                var recipientName = $"{user.first_name} {user.last_name}".Trim();
                await EmailService.SendPasswordResetConfirmationAsync(userEmail, recipientName);
            }

            // Move to success step
            currentStep = ForgotPasswordStep.Success;
            isLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            passwordError = true;
            passwordErrorMessage = "An error occurred. Please try again.";
            isLoading = false;
            System.Diagnostics.Debug.WriteLine($"Error in HandleResetPassword: {ex.Message}");
            StateHasChanged();
        }
    }

    private async Task ResendCode()
    {
        if (string.IsNullOrEmpty(userEmail))
        {
            currentStep = ForgotPasswordStep.EnterEmail;
            StateHasChanged();
            return;
        }

        isResending = true;
        StateHasChanged();

        try
        {
            var user = await UserRepository.GetByEmailAsync(userEmail);
            if (user == null)
            {
                currentStep = ForgotPasswordStep.EnterEmail;
                isResending = false;
                StateHasChanged();
                return;
            }

            // Generate new code
            var random = new Random();
            verificationCode = random.Next(100000, 999999).ToString();
            codeExpiryTime = DateTime.Now.AddMinutes(10);

            // Send new code
            var recipientName = $"{user.first_name} {user.last_name}".Trim();
            await EmailService.SendVerificationCodeAsync(userEmail, verificationCode, recipientName);

            codeError = false;
            codeErrorMessage = string.Empty;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error resending code: {ex.Message}");
        }
        finally
        {
            isResending = false;
            StateHasChanged();
        }
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    private string GetEmailInputClass()
    {
        var baseClass = "w-full rounded-lg border py-2 pl-3 pr-3 text-sm outline-none transition sm:py-2.5 sm:pl-3 sm:pr-4 sm:text-sm";
        return emailError 
            ? $"{baseClass} border-red-500 focus:border-red-500 focus:ring-2 focus:ring-red-500" 
            : $"{baseClass} border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-500";
    }

    private string GetCodeInputClass()
    {
        var baseClass = "w-full rounded-lg border py-2 px-3 text-center text-2xl font-mono tracking-widest outline-none transition sm:py-2.5 sm:px-4 sm:text-2xl";
        return codeError 
            ? $"{baseClass} border-red-500 focus:border-red-500 focus:ring-2 focus:ring-red-500" 
            : $"{baseClass} border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-500";
    }

    private string GetPasswordInputClass()
    {
        var baseClass = "w-full rounded-lg border py-2 pl-3 pr-3 text-sm outline-none transition sm:py-2.5 sm:pl-3 sm:pr-4 sm:text-sm";
        return passwordError 
            ? $"{baseClass} border-red-500 focus:border-red-500 focus:ring-2 focus:ring-red-500" 
            : $"{baseClass} border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-500";
    }

    // Models
    public class EmailModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string Email { get; set; } = string.Empty;
    }

    public class CodeModel
    {
        [Required(ErrorMessage = "Verification code is required")]
        [StringLength(6, MinimumLength = 6, ErrorMessage = "Code must be 6 digits")]
        public string Code { get; set; } = string.Empty;
    }

    public class PasswordModel
    {
        [Required(ErrorMessage = "Password is required")]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Please confirm your password")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
