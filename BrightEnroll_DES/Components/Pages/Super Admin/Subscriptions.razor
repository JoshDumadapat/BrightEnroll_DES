@page "/system-admin/subscriptions"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Services.AuthFunction
@using BrightEnroll_DES.Services.SuperAdmin
@using BrightEnroll_DES.Models
@inject IAuthService AuthService
@inject ISuperAdminService SuperAdminService
@inject NavigationManager Navigation

<PageTitle>Subscription Management</PageTitle>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Subscription Management</h1>
    <p class="text-sm text-gray-600">Manage billing, plans, and renewals</p>
</div>

<!-- Stats -->
    <div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-3">
    <div class="rounded-xl border border-blue-200 bg-blue-50 p-4">
        <p class="text-sm text-blue-600">Active Subscriptions</p>
        <p class="text-2xl font-bold text-blue-800">@ActiveSubscriptions</p>
    </div>
    <div class="rounded-xl border border-orange-200 bg-orange-50 p-4">
        <p class="text-sm text-orange-600">Expiring This Month</p>
        <p class="text-2xl font-bold text-orange-800">@ExpiringThisMonth</p>
    </div>
    <div class="rounded-xl border border-green-200 bg-green-50 p-4">
        <p class="text-sm text-green-600">MRR (Monthly Recurring Revenue)</p>
        <p class="text-2xl font-bold text-green-800">?@MonthlyRecurringRevenue.ToString("N0")</p>
    </div>
</div>

<!-- Pricing Plans Overview -->
<div class="mb-6 grid grid-cols-1 gap-4 md:grid-cols-3">
    <div class="rounded-xl border-2 border-gray-200 bg-white p-6">
        <h3 class="mb-2 text-xl font-bold text-gray-800">Basic Plan</h3>
        <p class="mb-4 text-3xl font-bold text-gray-800">?35,000<span class="text-sm text-gray-500">/month</span></p>
        <ul class="space-y-2 text-sm text-gray-600">
            <li>? Up to 100 students</li>
            <li>? 5 admin users</li>
            <li>? Basic modules</li>
            <li>? Email support</li>
        </ul>
        <p class="mt-4 text-sm font-medium text-blue-600">15 schools subscribed</p>
    </div>

    <div class="rounded-xl border-2 border-blue-500 bg-white p-6 shadow-lg">
        <div class="mb-2 inline-block rounded-full bg-blue-100 px-3 py-1 text-xs font-medium text-blue-800">Most Popular</div>
        <h3 class="mb-2 text-xl font-bold text-gray-800">Standard Plan</h3>
        <p class="mb-4 text-3xl font-bold text-gray-800">?55,000<span class="text-sm text-gray-500">/month</span></p>
        <ul class="space-y-2 text-sm text-gray-600">
            <li>? Up to 500 students</li>
            <li>? 15 admin users</li>
            <li>? All standard modules</li>
            <li>? Priority support</li>
        </ul>
        <p class="mt-4 text-sm font-medium text-blue-600">22 schools subscribed</p>
    </div>

    <div class="rounded-xl border-2 border-purple-500 bg-white p-6">
        <h3 class="mb-2 text-xl font-bold text-gray-800">Premium Plan</h3>
        <p class="mb-4 text-3xl font-bold text-gray-800">?85,000<span class="text-sm text-gray-500">/month</span></p>
        <ul class="space-y-2 text-sm text-gray-600">
            <li>? Unlimited students</li>
            <li>? Unlimited users</li>
            <li>? All modules + custom</li>
            <li>? 24/7 dedicated support</li>
        </ul>
        <p class="mt-4 text-sm font-medium text-purple-600">8 schools subscribed</p>
    </div>
</div>

<!-- Expiring Soon -->
    <div class="rounded-xl border border-gray-100 bg-white p-6 shadow-sm">
    <h2 class="mb-4 text-lg font-bold text-gray-800">Expiring Soon</h2>
    <div class="space-y-3">
        @foreach (var sub in ExpiringSoon)
        {
            <div class="flex items-center justify-between rounded-lg border border-orange-200 bg-orange-50 p-4">
                <div>
                    <p class="font-semibold text-gray-800">@sub.SchoolName</p>
                    <p class="text-sm text-gray-600">Expires: @sub.ExpiryDate.ToString("MMM dd, yyyy")</p>
                </div>
                <button class="rounded-full bg-orange-600 px-4 py-2 text-sm font-medium text-white hover:bg-orange-700">Send Reminder</button>
            </div>
        }
    </div>
</div>

@code {
    private int ActiveSubscriptions { get; set; }
    private int ExpiringThisMonth { get; set; }
    private decimal MonthlyRecurringRevenue { get; set; }
    private List<DashboardExpiringSubscription> ExpiringSoon { get; set; } = new();

    protected override async void OnInitialized()
    {
        if (AuthService.CurrentUser?.user_role != "Super Admin")
        {
            Navigation.NavigateTo("/dashboard");
            return;
        }

        var summary = await SuperAdminService.GetSubscriptionSummaryAsync();
        ActiveSubscriptions = summary.ActiveSubscriptions;
        ExpiringThisMonth = summary.ExpiringThisMonth;
        MonthlyRecurringRevenue = summary.MonthlyRecurringRevenue;
        ExpiringSoon = summary.ExpiringSoon;
    }
}
