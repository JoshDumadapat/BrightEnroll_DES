@page "/system-admin/subscriptions"
@layout Components.Layout.MainLayout
@using BrightEnroll_DES.Services
@using BrightEnroll_DES.Models
@using BrightEnroll_DES.Services.AuthFunction
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISubscriptionService SubscriptionService

<PageTitle>Subscription Management</PageTitle>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Subscription Management</h1>
    <p class="text-sm text-gray-600">Manage billing, plans, and renewals</p>
</div>

<!-- Stats -->
<div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-3">
    <div class="rounded-xl border border-blue-200 bg-blue-50 p-4">
        <p class="text-sm text-blue-600">Active Subscriptions</p>
        <p class="text-2xl font-bold text-blue-800">@ActiveSubscriptions</p>
    </div>
    <div class="rounded-xl border border-orange-200 bg-orange-50 p-4">
        <p class="text-sm text-orange-600">Expiring This Month</p>
        <p class="text-2xl font-bold text-orange-800">@ExpiringThisMonth</p>
    </div>
    <div class="rounded-xl border border-green-200 bg-green-50 p-4">
        <p class="text-sm text-green-600">MRR (Monthly Recurring Revenue)</p>
        <p class="text-2xl font-bold text-green-800">?@MonthlyRecurringRevenue.ToString("N0")</p>
    </div>
</div>

<!-- Pricing Plans Overview -->
<div class="mb-6 grid grid-cols-1 gap-4 md:grid-cols-3">
    <div class="rounded-xl border-2 border-gray-200 bg-white p-6">
        <h3 class="mb-2 text-xl font-bold text-gray-800">Basic Plan</h3>
        <p class="mb-4 text-3xl font-bold text-gray-800">?35,000<span class="text-sm text-gray-500">/month</span></p>
        <ul class="space-y-2 text-sm text-gray-600">
            <li>? Up to 100 students</li>
            <li>? 5 admin users</li>
            <li>? Basic modules</li>
            <li>? Email support</li>
        </ul>
        <p class="mt-4 text-sm font-medium text-blue-600">@BasicSubscribers schools subscribed</p>
    </div>

    <div class="rounded-xl border-2 border-blue-500 bg-white p-6 shadow-lg">
        <div class="mb-2 inline-block rounded-full bg-blue-100 px-3 py-1 text-xs font-medium text-blue-800">Most Popular</div>
        <h3 class="mb-2 text-xl font-bold text-gray-800">Standard Plan</h3>
        <p class="mb-4 text-3xl font-bold text-gray-800">?55,000<span class="text-sm text-gray-500">/month</span></p>
        <ul class="space-y-2 text-sm text-gray-600">
            <li>? Up to 500 students</li>
            <li>? 15 admin users</li>
            <li>? All standard modules</li>
            <li>? Priority support</li>
        </ul>
        <p class="mt-4 text-sm font-medium text-blue-600">@StandardSubscribers schools subscribed</p>
    </div>

    <div class="rounded-xl border-2 border-purple-500 bg-white p-6">
        <h3 class="mb-2 text-xl font-bold text-gray-800">Premium Plan</h3>
        <p class="mb-4 text-3xl font-bold text-gray-800">?85,000<span class="text-sm text-gray-500">/month</span></p>
        <ul class="space-y-2 text-sm text-gray-600">
            <li>? Unlimited students</li>
            <li>? Unlimited users</li>
            <li>? All modules + custom</li>
            <li>? 24/7 dedicated support</li>
        </ul>
        <p class="mt-4 text-sm font-medium text-purple-600">@PremiumSubscribers schools subscribed</p>
    </div>
</div>

<!-- Expiring Soon -->
<div class="rounded-xl border border-gray-100 bg-white p-6 shadow-sm">
    <h2 class="mb-4 text-lg font-bold text-gray-800">Expiring Soon</h2>
    <div class="space-y-3">
        @foreach (var sub in ExpiringSubscriptions)
        {
            var daysLeft = (sub.end_date - DateTime.Today).TotalDays;
            <div class="flex items-center justify-between rounded-lg border border-orange-200 bg-orange-50 p-4">
                <div>
                    <p class="font-semibold text-gray-800">Customer #@sub.customer_id</p>
                    <p class="text-sm text-gray-600">Expires in @daysLeft.ToString("0") days (@sub.end_date.ToString("MMM dd, yyyy"))</p>
                </div>
                <button class="rounded-full bg-orange-600 px-4 py-2 text-sm font-medium text-white hover:bg-orange-700">Send Reminder</button>
            </div>
        }
    </div>
</div>

@code {
    private List<Subscription> SubscriptionItems { get; set; } = new();

    private int ActiveSubscriptions =>
        SubscriptionItems.Count(s => s.status.Equals("Active", StringComparison.OrdinalIgnoreCase) && s.end_date >= DateTime.Today);

    private int ExpiringThisMonth =>
        ExpiringSubscriptions.Count;

    private decimal MonthlyRecurringRevenue =>
        SubscriptionItems
            .Where(s => s.status.Equals("Active", StringComparison.OrdinalIgnoreCase) && s.end_date >= DateTime.Today)
            .Sum(s => s.monthly_fee);

    private int BasicSubscribers =>
        SubscriptionItems.Count(s => s.plan == "Basic" && s.status.Equals("Active", StringComparison.OrdinalIgnoreCase) && s.end_date >= DateTime.Today);

    private int StandardSubscribers =>
        SubscriptionItems.Count(s => s.plan == "Standard" && s.status.Equals("Active", StringComparison.OrdinalIgnoreCase) && s.end_date >= DateTime.Today);

    private int PremiumSubscribers =>
        SubscriptionItems.Count(s => s.plan == "Premium" && s.status.Equals("Active", StringComparison.OrdinalIgnoreCase) && s.end_date >= DateTime.Today);

    private List<Subscription> ExpiringSubscriptions =>
        SubscriptionItems
            .Where(s =>
                s.status.Equals("Active", StringComparison.OrdinalIgnoreCase) &&
                s.end_date >= DateTime.Today &&
                s.end_date <= DateTime.Today.AddDays(30))
            .OrderBy(s => s.end_date)
            .Take(5)
            .ToList();

    protected override async Task OnInitializedAsync()
    {
        if (AuthService.CurrentUser?.user_role != "Super Admin")
        {
            Navigation.NavigateTo("/dashboard");
            return;
        }

        var data = await SubscriptionService.GetAllAsync();
        SubscriptionItems = data.ToList();
    }
}
