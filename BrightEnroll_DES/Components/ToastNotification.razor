@if (Show)
{
    <div class="fixed top-6 right-6 z-[100] toast-slide-in @(isClosing ? "toast-slide-out" : "")">
        @if (Type == ToastType.Error)
        {
            <!-- Error Toast -->
            <div class="bg-red-50 border-2 border-red-300 rounded-2xl shadow-2xl px-6 py-5 min-w-[380px] max-w-lg flex items-center gap-4 transform hover:scale-105 transition-transform duration-200">
                <!-- Error Icon -->
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center shadow-lg ring-4 ring-red-100">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="flex-1">
                    <h4 class="text-base font-bold text-red-900 mb-1">Error</h4>
                    <p class="text-sm font-medium text-gray-800 leading-relaxed">@Message</p>
                </div>
                
                <!-- Close Button -->
                <button @onclick="Close" class="flex-shrink-0 text-gray-700 hover:text-gray-900 transition-colors p-2 hover:bg-red-100 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        }
        else if (Type == ToastType.Edit)
        {
            <!-- Edit Toast -->
            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-2xl shadow-2xl px-6 py-5 min-w-[380px] max-w-lg flex items-center gap-4 transform hover:scale-105 transition-transform duration-200">
                <!-- Edit Icon -->
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-500 to-yellow-600 flex items-center justify-center shadow-lg ring-4 ring-yellow-100">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                        </svg>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="flex-1">
                    <h4 class="text-base font-bold text-yellow-900 mb-1">Updated</h4>
                    <p class="text-sm font-medium text-gray-800 leading-relaxed">@Message</p>
                </div>
                
                <!-- Close Button -->
                <button @onclick="Close" class="flex-shrink-0 text-gray-700 hover:text-gray-900 transition-colors p-2 hover:bg-yellow-100 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        }
        else if (Type == ToastType.Remove)
        {
            <!-- Remove Toast -->
            <div class="bg-red-50 border-2 border-red-300 rounded-2xl shadow-2xl px-6 py-5 min-w-[380px] max-w-lg flex items-center gap-4 transform hover:scale-105 transition-transform duration-200">
                <!-- Remove Icon -->
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center shadow-lg ring-4 ring-red-100">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="flex-1">
                    <h4 class="text-base font-bold text-red-900 mb-1">Removed</h4>
                    <p class="text-sm font-medium text-gray-800 leading-relaxed">@Message</p>
                </div>
                
                <!-- Close Button -->
                <button @onclick="Close" class="flex-shrink-0 text-gray-700 hover:text-gray-900 transition-colors p-2 hover:bg-red-100 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        }
        else if (Type == ToastType.Loading)
        {
            <!-- Loading Toast with Progress Bar -->
            <div class="bg-blue-50 border-2 border-blue-300 rounded-2xl shadow-2xl px-6 py-5 min-w-[380px] max-w-lg">
                <!-- Content -->
                <div class="mb-3">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg">
                            <svg class="w-6 h-6 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                        <p class="text-base font-bold text-gray-800">@Message</p>
                    </div>
                </div>
                
                <!-- Progress Bar with Percentage -->
                <div class="flex items-center gap-3">
                    <div class="flex-1 bg-blue-200 rounded-full h-3 overflow-hidden shadow-inner">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-300 shadow-sm" style="width: @(Math.Min(100, Math.Max(0, Progress)))%;"></div>
                    </div>
                    <span class="text-base font-bold text-blue-700 min-w-[4rem] text-right">@(Math.Min(100, Math.Max(0, Progress)))%</span>
                </div>
            </div>
        }
        else
        {
            <!-- Success Toast -->
            <div class="bg-green-50 border-2 border-green-300 rounded-2xl shadow-2xl px-6 py-5 min-w-[380px] max-w-lg flex items-center gap-4 transform hover:scale-105 transition-transform duration-200">
                <!-- Success Icon -->
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center shadow-lg ring-4 ring-green-100">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="flex-1">
                    <h4 class="text-base font-bold text-green-900 mb-1">Success</h4>
                    <p class="text-sm font-medium text-gray-800 leading-relaxed">@Message</p>
                </div>
                
                <!-- Close Button -->
                <button @onclick="Close" class="flex-shrink-0 text-gray-700 hover:text-gray-900 transition-colors p-2 hover:bg-green-100 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        }
    </div>
}

@implements IDisposable

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public string Message { get; set; } = "";
    [Parameter] public ToastType Type { get; set; } = ToastType.Success;
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public int Duration { get; set; } = 3000; // Auto-close after 3 seconds
    [Parameter] public int Progress { get; set; } = 0; // Progress percentage (0-100)

    private System.Threading.Timer? _timer;
    private bool isClosing = false;
    private bool _previousShowState = false;

    protected override void OnParametersSet()
    {
        // Only start timer when Show changes from false to true
        if (Show && !_previousShowState && !isClosing)
        {
            _previousShowState = true;
            StartTimer();
        }
        else if (!Show)
        {
            _previousShowState = false;
            isClosing = false;
            StopTimer();
        }
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        // Start timer after first render if Show is true
        if (firstRender && Show && !isClosing)
        {
            StartTimer();
        }
        return Task.CompletedTask;
    }

    private void StartTimer()
    {
        // Loading toasts should not auto-close (Duration <= 0 means no auto-close)
        if (Duration > 0 && Type != ToastType.Loading)
        {
            StopTimer();
            _timer = new System.Threading.Timer(async _ =>
            {
                await InvokeAsync(async () =>
                {
                    if (Show && !isClosing)
                    {
                        await Close();
                    }
                });
            }, null, Duration, Timeout.Infinite);
        }
    }

    private void StopTimer()
    {
        _timer?.Dispose();
        _timer = null;
    }

    private async Task Close()
    {
        if (isClosing) return; // Prevent multiple close calls
        
        isClosing = true;
        StopTimer();
        StateHasChanged();
        
        // Wait for slide-out animation
        await Task.Delay(300);
        
        isClosing = false;
        _previousShowState = false;
        
        // Call OnClose callback to update parent state - this is critical!
        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }
    }

    public void Dispose()
    {
        StopTimer();
    }
}

